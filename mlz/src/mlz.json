{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "2863410495302379953"
    }
  },
  "parameters": {
    "addsDomainName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The root domain name for the new forest in Active Directory Domain Services. Required when deployActiveDirectoryDomainServices is true."
      }
    },
    "addsSafeModeAdminPassword": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "The password for the safe mode administrator account. Required when deployActiveDirectoryDomainServices is true."
      }
    },
    "addsVmAdminPassword": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "The password for the local administrator accounts on the Active Directory Domain Services (ADDS) domain controllers. Required when deployActiveDirectoryDomainServices is true."
      }
    },
    "addsVmAdminUsername": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The username for the local administrator accounts on the Active Directory Domain Services (ADDS) domain controllers. Required when deployActiveDirectoryDomainServices is true."
      }
    },
    "addsVmImageSku": {
      "type": "string",
      "defaultValue": "2019-datacenter-gensecond",
      "allowedValues": [
        "2019-datacenter-core-g2",
        "2019-datacenter-gensecond",
        "2022-datacenter-core-g2",
        "2022-datacenter-g2"
      ],
      "metadata": {
        "description": "The Windows image SKU in the Azure marketplace for the Active Directory Domain Services (ADDS) domain controllers."
      }
    },
    "addsVmSize": {
      "type": "string",
      "defaultValue": "Standard_D2s_v3",
      "metadata": {
        "description": "The virtual machine size for the Active Directory Domain Services (ADDS) domain controllers."
      }
    },
    "azureGatewaySubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.129.192/26",
      "metadata": {
        "description": "The CIDR Subnet Address Prefix for the Azure Gateway Subnet. It must be in the Hub Virtual Network space. It must be /26."
      }
    },
    "bastionDiagnosticsLogs": {
      "type": "array",
      "defaultValue": [
        {
          "category": "BastionAuditLogs",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Bastion Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/bastion/monitor-bastion#collect-data-with-azure-monitor."
      }
    },
    "bastionDiagnosticsMetrics": {
      "type": "array",
      "defaultValue": [
        {
          "category": "AllMetrics",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Bastion Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/bastion/monitor-bastion#collect-data-with-azure-monitor."
      }
    },
    "bastionHostPublicIPAddressAvailabilityZones": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "The Azure Bastion Public IP Address Availability Zones. Default value = \"No-Zone\" because Availability Zones are not available in every cloud. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-network/ip-services/public-ip-addresses#sku."
      }
    },
    "bastionHostSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.128.192/26",
      "metadata": {
        "description": "The CIDR Subnet Address Prefix for the Azure Bastion Subnet. It must be in the Hub Virtual Network space \"hubVirtualNetworkAddressPrefix\" parameter value. It must be /27 or larger."
      }
    },
    "customFirewallRuleCollectionGroups": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "The firewall rules that will be applied to the Azure Firewall."
      }
    },
    "additionalFwPipCount": {
      "type": "int",
      "defaultValue": 0,
      "minValue": 0,
      "maxValue": 10,
      "metadata": {
        "description": "Number of additional static public IP addresses to create for the Azure Firewall. Default value = \"0\". These will be static/reserved IP addresses that can be used for NAT rules."
      }
    },
    "defenderSkuTier": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Standard",
        "Free"
      ],
      "metadata": {
        "description": "[Standard/Free] The SKU for Defender for Cloud. Default value = \"Free\"."
      }
    },
    "deployActiveDirectoryDomainServices": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When set to \"true\", deploys Active Directory Domain Services (ADDS) domain controllers in the identity tier. Requires deployIdentity to be true. Default value = \"false\"."
      }
    },
    "deployAzureGatewaySubnet": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When set to \"true\", provisions Azure Gateway Subnet only. Default value = \"false\"."
      }
    },
    "deployBastion": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When set to \"true\", provisions Azure Bastion Host using the Standard SKU. Default value = \"false\"."
      }
    },
    "deployDefender": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "When set to \"true\", enables Microsoft Defender for Cloud for the subscriptions used in the deployment. Default value = \"false\"."
      }
    },
    "deployDefenderPlans": {
      "type": "array",
      "defaultValue": [
        "VirtualMachines"
      ],
      "metadata": {
        "description": "The Paid Workload Protection plans for Defender for Cloud. Default value = \"VirtualMachines\". See the following URL for valid settings: https://learn.microsoft.com/rest/api/defenderforcloud-composite/pricings/update?view=rest-defenderforcloud-composite-latest&tabs=HTTP."
      }
    },
    "deployIdentity": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Choose to deploy the identity resources. The identity resoures are not required if you plan to use cloud identities."
      }
    },
    "deployLinuxVirtualMachine": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When set to \"true\", provisions Linux Virtual Machine Host only. Default value = \"false\"."
      }
    },
    "deploymentNameSuffix": {
      "type": "string",
      "defaultValue": "[utcNow()]",
      "metadata": {
        "description": "A suffix to use for naming deployments uniquely. Default value = \"utcNow()\"."
      }
    },
    "deployNetworkWatcherTrafficAnalytics": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When set to true, deploys Network Watcher Traffic Analytics. Default value = \"false\"."
      }
    },
    "deployPolicy": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When set to \"true\", deploys the Azure Policy set defined at by the parameter \"policy\" to the resource groups generated in the deployment. Default value = \"false\"."
      }
    },
    "deploySentinel": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When set to \"true\", enables Microsoft Sentinel within the Log Analytics Workspace created in this deployment. Default value = \"false\"."
      }
    },
    "delimiter": {
      "type": "string",
      "defaultValue": "-",
      "metadata": {
        "description": "Delimiter used in naming conventions. Default value = \"-\"."
      }
    },
    "resourceAbbreviations": {
      "type": "object",
      "defaultValue": "[variables('resourceAbbreviations')]",
      "metadata": {
        "description": "Map of resource type abbreviations used by naming conventions. Default value uses the template's built-in abbreviation map."
      }
    },
    "tier": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional tier object override (e.g., operations tier). When omitted, the template derives the operations tier from the networking deployment outputs."
      }
    },
    "enableEntityBehavior": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Toggle to configure the Microsoft Sentinel Entity Behavior Analytics setting for Microsoft Entra ID signals. This may require Microsoft Entra directory roles (e.g., Security Administrator / Global Administrator)."
      }
    },
    "deployEntityBehaviorSetting": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "When true, provisions the Entity Behavior Analytics setting (directly or via deployment script based on useEntityBehaviorScript)."
      }
    },
    "useEntityBehaviorScript": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Use the deployment script to upsert Entity Behavior settings. Disable for brand new workspaces to provision the resource directly."
      }
    },
    "enableUeba": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Toggle to configure UEBA data sources so fusion models have full context. Requires EntityAnalytics to be enabled on the workspace."
      }
    },
    "deployUebaSetting": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Skip provisioning the UEBA setting when it already exists to avoid concurrency conflicts."
      }
    },
    "uebaDataSources": {
      "type": "array",
      "defaultValue": [
        "SigninLogs",
        "AuditLogs",
        "AzureActivity"
      ],
      "metadata": {
        "description": "Data sources that enrich UEBA insights."
      }
    },
    "enableAnomalies": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Toggle to ensure Microsoft Sentinel anomaly detection remains enabled."
      }
    },
    "deploySentinelAutomationScript": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Toggle to run the built-in script that discovers and assigns the Sentinel automation service principal. This can require Microsoft Entra directory read permissions; leave disabled if your deployment identity is not permitted to query service principals."
      }
    },
    "sentinelAutomationPrincipalId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Object ID of the Azure Security Insights service principal so Sentinel automation can run playbooks in the operations resource group."
      }
    },
    "enableAzureActivityDataConnector": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Toggle to configure the Azure Activity data connector for Microsoft Sentinel."
      }
    },
    "azureActivityDiagnosticSettingName": {
      "type": "string",
      "defaultValue": "diag-azureactivity-mlz",
      "metadata": {
        "description": "Name assigned to the subscription-level diagnostic setting that streams Azure Activity logs into Microsoft Sentinel."
      }
    },
    "azureActivityLogCategories": {
      "type": "array",
      "defaultValue": [
        "Administrative",
        "Security",
        "ServiceHealth",
        "Alert",
        "Recommendation",
        "Policy",
        "Autoscale",
        "ResourceHealth"
      ],
      "metadata": {
        "description": "Azure Activity log categories forwarded to Microsoft Sentinel via the diagnostic setting."
      }
    },
    "azureActivityDiagnosticRetentionPolicy": {
      "type": "object",
      "defaultValue": {
        "enabled": false,
        "days": 0
      },
      "metadata": {
        "description": "Retention policy applied to each Azure Activity log category streamed to Microsoft Sentinel."
      }
    },
    "enableEntraIdDataConnector": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Toggle to configure the Microsoft Entra ID data connector for Microsoft Sentinel and ensure required log types remain enabled. If this workspace is set as the Primary workspace in Microsoft 365 Defender, connector changes may be blocked in Sentinel; manage the connector in Defender instead."
      }
    },
    "entraDataConnectorLogStates": {
      "type": "object",
      "defaultValue": {
        "SignInLogs": "Enabled",
        "AuditLogs": "Enabled",
        "NonInteractiveUserSignInLogs": "Enabled",
        "ServicePrincipalSignInLogs": "Enabled",
        "ManagedIdentitySignInLogs": "Enabled",
        "ProvisioningLogs": "Enabled",
        "ADFSSignInLogs": "Enabled",
        "UserRiskEvents": "Enabled",
        "RiskyUsers": "Enabled",
        "RiskyServicePrincipals": "Enabled",
        "alerts": "Enabled"
      },
      "metadata": {
        "description": "Desired state for each Microsoft Entra ID log type exposed by the Microsoft Sentinel data connector."
      }
    },
    "azureActivityWorkbookName": {
      "type": "string",
      "defaultValue": "Azure Activity",
      "metadata": {
        "description": "Display name assigned to the Azure Activity workbook that deploys with the Microsoft Sentinel content package."
      }
    },
    "azureServiceHealthWorkbookName": {
      "type": "string",
      "defaultValue": "Azure Service Health Workbook",
      "metadata": {
        "description": "Display name assigned to the Azure Service Health workbook that deploys with the Microsoft Sentinel content package."
      }
    },
    "entraAuditWorkbookName": {
      "type": "string",
      "defaultValue": "Microsoft Entra ID Audit logs",
      "metadata": {
        "description": "Display name assigned to the Microsoft Entra ID audit workbook that deploys with the Microsoft Sentinel content package."
      }
    },
    "entraSigninWorkbookName": {
      "type": "string",
      "defaultValue": "Microsoft Entra ID Sign-in logs",
      "metadata": {
        "description": "Display name assigned to the Microsoft Entra ID sign-in workbook that deploys with the Microsoft Sentinel content package."
      }
    },
    "deployWindowsVirtualMachine": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When set to \"true\", provisions Windows Virtual Machine Host only. Default value = \"false\"."
      }
    },
    "dnsServers": {
      "type": "array",
      "defaultValue": [
        "168.63.129.16"
      ],
      "metadata": {
        "description": "The Azure Firewall DNS Proxy will forward all DNS traffic. When this value is set to true, you must provide a value for \"servers\". This should be a comma separated list of IP addresses to forward DNS traffic."
      }
    },
    "emailSecurityContact": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The email address for Defender for Cloud alert notifications, in the form of john@contoso.com."
      }
    },
    "enableProxy": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "The Azure Firewall DNS Proxy will forward all DNS traffic. Default value = \"true\"."
      }
    },
    "environmentAbbreviation": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "prod",
        "test"
      ],
      "metadata": {
        "description": "[dev/prod/test] The abbreviation for the target environment."
      }
    },
    "locationAbbreviation": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "A short region abbreviation used in naming (e.g., 'eus', 'eus2', 'wus2'). If left blank, names may be longer/less standardized."
      }
    },
    "firewallClientPublicIPAddressAvailabilityZones": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "An array of Azure Firewall Public IP Address Availability Zones. Default value = \"[]\" because Availability Zones are not available in every cloud. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-network/ip-services/public-ip-addresses#sku."
      }
    },
    "firewallClientSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.128.0/26",
      "metadata": {
        "description": "The CIDR Subnet Address Prefix for the Azure Firewall Subnet. It must be in the Hub Virtual Network space. It must be /26."
      }
    },
    "firewallDiagnosticsLogs": {
      "type": "array",
      "defaultValue": [
        {
          "category": "AzureFirewallApplicationRule",
          "enabled": true
        },
        {
          "category": "AzureFirewallNetworkRule",
          "enabled": true
        },
        {
          "category": "AzureFirewallDnsProxy",
          "enabled": "[parameters('enableProxy')]"
        },
        {
          "category": "AZFWNetworkRule",
          "enabled": true
        },
        {
          "category": "AZFWApplicationRule",
          "enabled": true
        },
        {
          "category": "AZFWNatRule",
          "enabled": true
        },
        {
          "category": "AZFWThreatIntel",
          "enabled": true
        },
        {
          "category": "AZFWIdpsSignature",
          "enabled": true
        },
        {
          "category": "AZFWDnsQuery",
          "enabled": true
        },
        {
          "category": "AZFWFqdnResolveFailure",
          "enabled": true
        },
        {
          "category": "AZFWFatFlow",
          "enabled": true
        },
        {
          "category": "AZFWFlowTrace",
          "enabled": true
        },
        {
          "category": "AZFWApplicationRuleAggregation",
          "enabled": true
        },
        {
          "category": "AZFWNetworkRuleAggregation",
          "enabled": true
        },
        {
          "category": "AZFWNatRuleAggregation",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Firewall Diagnostic Logs categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/firewall/monitor-firewall#enable-diagnostic-logging-through-the-azure-portal."
      }
    },
    "firewallDiagnosticsMetrics": {
      "type": "array",
      "defaultValue": [
        {
          "category": "AllMetrics",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Firewall Diagnostic Metrics categories to collect. See the following URL for valid values: https://learn.microsoft.com/azure/firewall/monitor-firewall#enable-diagnostic-logging-through-the-azure-portal."
      }
    },
    "firewallIntrusionDetectionMode": {
      "type": "string",
      "defaultValue": "Alert",
      "allowedValues": [
        "Alert",
        "Deny",
        "Off"
      ],
      "metadata": {
        "description": "[Alert/Deny/Off] The Azure Firewall Intrusion Detection mode. Valid values are \"Alert\", \"Deny\", or \"Off\". The default value is \"Alert\"."
      }
    },
    "firewallManagementPublicIPAddressAvailabilityZones": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "An array of Azure Firewall Public IP Address Availability Zones. Default value = \"[]\" because Availability Zones are not available in every cloud. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-network/ip-services/public-ip-addresses#sku."
      }
    },
    "firewallManagementSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.128.64/26",
      "metadata": {
        "description": "The CIDR Subnet Address Prefix for the Azure Firewall Management Subnet. It must be in the Hub Virtual Network space. It must be /26."
      }
    },
    "firewallSkuTier": {
      "type": "string",
      "defaultValue": "Premium",
      "allowedValues": [
        "Premium",
        "Standard"
      ],
      "metadata": {
        "description": "[Premium/Standard] The SKU for Azure Firewall. Default value = \"Premium\". Selecting a value other than Premium is not recommended for environments that are required to be SCCA compliant."
      }
    },
    "firewallSupernetIPAddress": {
      "type": "string",
      "defaultValue": "10.0.128.0/18",
      "metadata": {
        "description": "Supernet CIDR address for the entire network of vnets, this address allows for communication between spokes. Recommended to use a Supernet calculator if modifying vnet addresses."
      }
    },
    "firewallThreatIntelMode": {
      "type": "string",
      "defaultValue": "Alert",
      "allowedValues": [
        "Alert",
        "Deny",
        "Off"
      ],
      "metadata": {
        "description": "[Alert/Deny/Off] The Azure Firewall Threat Intelligence Rule triggered logging behavior. Valid values are \"Alert\", \"Deny\", or \"Off\". The default value is \"Alert\"."
      }
    },
    "hubNetworkSecurityGroupDiagnosticsLogs": {
      "type": "array",
      "defaultValue": [
        {
          "category": "NetworkSecurityGroupEvent",
          "enabled": true
        },
        {
          "category": "NetworkSecurityGroupRuleCounter",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Network Security Group diagnostic logs to apply to the Hub Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-network/virtual-network-nsg-manage-log#log-categories."
      }
    },
    "hubNetworkSecurityGroupRules": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "An array of Network Security Group Rules to apply to the Hub Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/templates/microsoft.network/networksecuritygroups/securityrules?tabs=bicep&pivots=deployment-language-bicep#securityrulepropertiesformat."
      }
    },
    "hubSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.128.128/26",
      "metadata": {
        "description": "The CIDR Subnet Address Prefix for the default Hub subnet. It must be in the Hub Virtual Network space."
      }
    },
    "hubSubscriptionId": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]",
      "metadata": {
        "description": "The subscription ID for the Hub Network and resources. Default value = \"subscription().subscriptionId\"."
      }
    },
    "hubVirtualNetworkAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.128.0/23",
      "metadata": {
        "description": "The CIDR Virtual Network Address Prefix for the Hub Virtual Network."
      }
    },
    "hubVirtualNetworkDiagnosticsLogs": {
      "type": "array",
      "defaultValue": [
        {
          "category": "VMProtectionAlerts",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Network Diagnostic Logs to enable for the Hub Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD#logs."
      }
    },
    "hubVirtualNetworkDiagnosticsMetrics": {
      "type": "array",
      "defaultValue": [
        {
          "category": "AllMetrics",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Network Diagnostic Metrics to enable for the Hub Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD#metrics."
      }
    },
    "hybridUseBenefit": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "The hybrid use benefit provides a discount on virtual machines when a customer has an on-premises Windows Server license with Software Assurance. Default value = \"false\"."
      }
    },
    "identifier": {
      "type": "string",
      "minLength": 1,
      "maxLength": 5,
      "metadata": {
        "description": "1-5 alphanumeric characters without whitespace, used to name resources and generate uniqueness for resources within your subscription. Ideally, the value should represent an organization, department, or business unit."
      }
    },
    "identityNetworkSecurityGroupDiagnosticsLogs": {
      "type": "array",
      "defaultValue": [
        {
          "category": "NetworkSecurityGroupEvent",
          "enabled": true
        },
        {
          "category": "NetworkSecurityGroupRuleCounter",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Network Security Group diagnostic logs to apply to the Identity Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-network/virtual-network-nsg-manage-log#log-categories."
      }
    },
    "identityNetworkSecurityGroupRules": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "An array of Network Security Group Rules to apply to the Identity Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/templates/microsoft.network/networksecuritygroups/securityrules?tabs=bicep#securityrulepropertiesformat."
      }
    },
    "identitySubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.130.0/24",
      "metadata": {
        "description": "The CIDR Subnet Address Prefix for the default Identity subnet. It must be in the Identity Virtual Network space."
      }
    },
    "identitySubscriptionId": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]",
      "metadata": {
        "description": "The subscription ID for the Identity Network and resources. Default value = \"subscription().subscriptionId\"."
      }
    },
    "identityVirtualNetworkAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.130.0/24",
      "metadata": {
        "description": "The CIDR Virtual Network Address Prefix for the Identity Virtual Network."
      }
    },
    "identityVirtualNetworkDiagnosticsLogs": {
      "type": "array",
      "defaultValue": [
        {
          "category": "VMProtectionAlerts",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Network Diagnostic Logs to enable for the Identity Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD#logs."
      }
    },
    "identityVirtualNetworkDiagnosticsMetrics": {
      "type": "array",
      "defaultValue": [
        {
          "category": "AllMetrics",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Network Diagnostic Metrics to enable for the Identity Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD#metrics."
      }
    },
    "keyVaultDiagnosticsLogs": {
      "type": "array",
      "defaultValue": [
        {
          "category": "AuditEvent",
          "enabled": true
        },
        {
          "category": "AzurePolicyEvaluationDetails",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Key Vault Diagnostic Logs categories to collect. See the following URL for valid settings: \"https://learn.microsoft.com/azure/key-vault/general/logging?tabs=Vault\"."
      }
    },
    "keyVaultDiagnosticsMetrics": {
      "type": "array",
      "defaultValue": [
        {
          "category": "AllMetrics",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "The Key Vault Diagnostic Metrics to collect. See the following URL for valid settings: \"https://learn.microsoft.com/azure/key-vault/general/logging?tabs=Vault\"."
      }
    },
    "linuxVmAdminPasswordOrKey": {
      "type": "securestring",
      "defaultValue": "[if(parameters('deployLinuxVirtualMachine'), '', newGuid())]",
      "minLength": 12,
      "metadata": {
        "description": "The administrator password or public SSH key for the Linux Virtual Machine for remote access. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-machines/linux/faq#what-are-the-password-requirements-when-creating-a-vm-."
      }
    },
    "linuxVmAdminUsername": {
      "type": "string",
      "defaultValue": "xadmin",
      "metadata": {
        "description": "The administrator username for the Linux Virtual Machine for remote access. Default value = \"xadmin\"."
      }
    },
    "linuxVmAuthenticationType": {
      "type": "string",
      "defaultValue": "password",
      "allowedValues": [
        "sshPublicKey",
        "password"
      ],
      "metadata": {
        "description": "[sshPublicKey/password] The authentication type for the Linux Virtual Machine for remote access. Default value = \"password\"."
      }
    },
    "linuxVmImageOffer": {
      "type": "string",
      "defaultValue": "0001-com-ubuntu-server-focal",
      "allowedValues": [
        "ubuntuserver",
        "0001-com-ubuntu-server-focal",
        "0001-com-ubuntu-server-jammy",
        "RHEL",
        "Debian-12"
      ],
      "metadata": {
        "description": "[ubuntuserver/0001-com-ubuntu-server-focal/0001-com-ubuntu-server-jammy/RHEL/Debian-12] The Linux image offer in the Azure marketplace. Default value = \"0001-com-ubuntu-server-focal\"."
      }
    },
    "linuxVmImagePublisher": {
      "type": "string",
      "defaultValue": "Canonical",
      "allowedValues": [
        "Canonical",
        "RedHat",
        "Debian"
      ],
      "metadata": {
        "description": "[Canonical/RedHat/Debian] The Linux image publisher in the Azure marketplace. Default value = \"Canonical\"."
      }
    },
    "linuxVmImageSku": {
      "type": "string",
      "defaultValue": "20_04-lts-gen2",
      "metadata": {
        "description": "The Linux image SKU in the Azure marketplace. Default value = \"20_04-lts-gen2\"."
      }
    },
    "linuxVmImageVersion": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "The Linux image version in the Azure marketplace. Default value = \"latest\"."
      }
    },
    "linuxVmOsDiskType": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "metadata": {
        "description": "The disk type of the Linux Virtual Machine for remote access. Default value = \"Standard_LRS\"."
      }
    },
    "linuxVmSize": {
      "type": "string",
      "defaultValue": "Standard_D2s_v3",
      "metadata": {
        "description": "The size of the Linux virtual machine. Default value = \"Standard_D2s_v3\"."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[deployment().location]",
      "metadata": {
        "description": "The region to deploy resources into. Default value = \"deployment().location\"."
      }
    },
    "logAnalyticsWorkspaceCappingDailyQuotaGb": {
      "type": "int",
      "defaultValue": -1,
      "metadata": {
        "description": "The daily quota for Log Analytics Workspace logs in Gigabytes. Default value = \"-1\", meaning no quota."
      }
    },
    "logAnalyticsWorkspaceRetentionInDays": {
      "type": "int",
      "defaultValue": 30,
      "metadata": {
        "description": "The number of days to retain Log Analytics Workspace logs without Sentinel. Default value = \"30\"."
      }
    },
    "logAnalyticsWorkspaceSkuName": {
      "type": "string",
      "defaultValue": "PerGB2018",
      "allowedValues": [
        "Free",
        "Standard",
        "Premium",
        "PerNode",
        "PerGB2018",
        "Standalone"
      ],
      "metadata": {
        "description": "[Free/Standard/Premium/PerNode/PerGB2018/Standalone] The SKU for the Log Analytics Workspace. Default value = \"PerGB2018\". See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/logs/resource-manager-workspace."
      }
    },
    "logStorageSkuName": {
      "type": "string",
      "defaultValue": "Standard_GRS",
      "metadata": {
        "description": "The Storage Account SKU to use for log storage. Default value = \"Standard_GRS\". See the following URL for valid settings: https://learn.microsoft.com/rest/api/storagerp/srp_sku_types."
      }
    },
    "networkInterfaceDiagnosticsMetrics": {
      "type": "array",
      "defaultValue": [
        {
          "category": "AllMetrics",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of metrics to enable on the diagnostic setting for network interfaces."
      }
    },
    "networkWatcherFlowLogsRetentionDays": {
      "type": "int",
      "defaultValue": 30,
      "metadata": {
        "description": "The number of days to retain Network Watcher Flow Logs. Default value = \"30\"."
      }
    },
    "networkWatcherFlowLogsType": {
      "type": "string",
      "defaultValue": "VirtualNetwork",
      "allowedValues": [
        "NetworkSecurityGroup",
        "VirtualNetwork"
      ],
      "metadata": {
        "description": "[NetworkSecurityGroup/VirtualNetwork] The type of network watcher flow logs to enable. Default value = \"VirtualNetwork\" since they provide more data and NSG flow logs will be deprecated in June 2025."
      }
    },
    "operationsNetworkSecurityGroupDiagnosticsLogs": {
      "type": "array",
      "defaultValue": [
        {
          "category": "NetworkSecurityGroupEvent",
          "enabled": true
        },
        {
          "category": "NetworkSecurityGroupRuleCounter",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Network Security Group diagnostic logs to apply to the Operations Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-network/virtual-network-nsg-manage-log#log-categories."
      }
    },
    "operationsNetworkSecurityGroupRules": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "An array of Network Security Group rules to apply to the Operations Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/templates/microsoft.network/networksecuritygroups/securityrules?tabs=bicep#securityrulepropertiesformat."
      }
    },
    "operationsSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.131.0/24",
      "metadata": {
        "description": "The CIDR Subnet Address Prefix for the default Operations subnet. It must be in the Operations Virtual Network space."
      }
    },
    "operationsSubscriptionId": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]",
      "metadata": {
        "description": "The subscription ID for the Operations Network and resources. Default value = \"subscription().subscriptionId\"."
      }
    },
    "operationsVirtualNetworkAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.131.0/24",
      "metadata": {
        "description": "The CIDR Virtual Network Address Prefix for the Operations Virtual Network."
      }
    },
    "operationsVirtualNetworkDiagnosticsLogs": {
      "type": "array",
      "defaultValue": [
        {
          "category": "VMProtectionAlerts",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Network Diagnostic Logs to enable for the Operations Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD#logs."
      }
    },
    "operationsVirtualNetworkDiagnosticsMetrics": {
      "type": "array",
      "defaultValue": [
        {
          "category": "AllMetrics",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Network Diagnostic Metrics to enable for the Operations Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD#metrics."
      }
    },
    "policy": {
      "type": "string",
      "defaultValue": "NISTRev4",
      "allowedValues": [
        "NISTRev4",
        "NISTRev5",
        "IL5",
        "CMMC"
      ],
      "metadata": {
        "description": "[NISTRev4/NISTRev5/IL5/CMMC] Built-in policy assignments to assign, Default value = \"NISTRev4\". IL5 is only available for AzureUsGovernment and will switch to NISTRev4 if tried in AzureCloud."
      }
    },
    "publicIPAddressDiagnosticsLogs": {
      "type": "array",
      "defaultValue": [
        {
          "category": "DDoSProtectionNotifications",
          "enabled": true
        },
        {
          "category": "DDoSMitigationFlowLogs",
          "enabled": true
        },
        {
          "category": "DDoSMitigationReports",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Public IP Address Diagnostic Logs for the Azure Firewall. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/tutorial-resource-logs?tabs=DDoSProtectionNotifications#configure-ddos-diagnostic-logs."
      }
    },
    "publicIPAddressDiagnosticsMetrics": {
      "type": "array",
      "defaultValue": [
        {
          "category": "AllMetrics",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Public IP Address Diagnostic Metrics for the Azure Firewall. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/tutorial-resource-logs?tabs=DDoSProtectionNotifications."
      }
    },
    "sharedServicesNetworkSecurityGroupDiagnosticsLogs": {
      "type": "array",
      "defaultValue": [
        {
          "category": "NetworkSecurityGroupEvent",
          "enabled": true
        },
        {
          "category": "NetworkSecurityGroupRuleCounter",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Network Security Group diagnostic logs to apply to the SharedServices Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-network/virtual-network-nsg-manage-log#log-categories."
      }
    },
    "sharedServicesNetworkSecurityGroupRules": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "An array of Network Security Group rules to apply to the SharedServices Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/templates/microsoft.network/networksecuritygroups/securityrules?tabs=bicep#securityrulepropertiesformat."
      }
    },
    "sharedServicesSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.132.0/24",
      "metadata": {
        "description": "The CIDR Subnet Address Prefix for the default Shared Services subnet. It must be in the Shared Services Virtual Network space. Default value = \"10.0.132.0/24\"."
      }
    },
    "sharedServicesSubscriptionId": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]",
      "metadata": {
        "description": "The subscription ID for the Shared Services Network and resources. Default value = \"subscription().subscriptionId\"."
      }
    },
    "sharedServicesVirtualNetworkAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.132.0/24",
      "metadata": {
        "description": "The CIDR Virtual Network Address Prefix for the Shared Services Virtual Network. Default value = \"10.0.132.0/24\"."
      }
    },
    "sharedServicesVirtualNetworkDiagnosticsLogs": {
      "type": "array",
      "defaultValue": [
        {
          "category": "VMProtectionAlerts",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Network Diagnostic Logs to enable for the SharedServices Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD#logs."
      }
    },
    "sharedServicesVirtualNetworkDiagnosticsMetrics": {
      "type": "array",
      "defaultValue": [
        {
          "category": "AllMetrics",
          "enabled": true
        }
      ],
      "metadata": {
        "description": "An array of Network Diagnostic Metrics to enable for the SharedServices Virtual Network. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD#metrics."
      }
    },
    "supportedClouds": {
      "type": "array",
      "defaultValue": [
        "AzureCloud",
        "AzureUSGovernment"
      ],
      "metadata": {
        "description": "The Azure clouds that support specific service features. Default value = \"['AzureCloud','AzureUSGovernment']\"."
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "A string dictionary of tags to add to deployed resources. See the following URL for valid settings: https://learn.microsoft.com/azure/azure-resource-manager/management/tag-resources?tabs=json#arm-templates."
      }
    },
    "windowsVmAdminPassword": {
      "type": "securestring",
      "defaultValue": "[if(parameters('deployWindowsVirtualMachine'), '', newGuid())]",
      "minLength": 12,
      "metadata": {
        "description": "The administrator password the Windows Virtual Machine for remote access. It must be > 12 characters in length. See the following URL for valid settings: https://learn.microsoft.com/azure/virtual-machines/windows/faq#what-are-the-password-requirements-when-creating-a-vm-."
      }
    },
    "windowsVmAdminUsername": {
      "type": "string",
      "defaultValue": "xadmin",
      "metadata": {
        "description": "The administrator username for the Windows Virtual Machine for remote access. Default value = \"xadmin\"."
      }
    },
    "windowsVmImageOffer": {
      "type": "string",
      "defaultValue": "WindowsServer",
      "metadata": {
        "description": "The Windows image offer in the Azure marketplace. Default value = \"WindowsServer\"."
      }
    },
    "windowsVmImagePublisher": {
      "type": "string",
      "defaultValue": "MicrosoftWindowsServer",
      "metadata": {
        "description": "The Windows image publisher in the Azure marketplace. Default value = \"MicrosoftWindowsServer\"."
      }
    },
    "windowsVmImageSku": {
      "type": "string",
      "defaultValue": "2019-datacenter-gensecond",
      "allowedValues": [
        "2019-datacenter-gensecond",
        "2022-datacenter-g2"
      ],
      "metadata": {
        "description": "[2019-datacenter-gensecond/2022-datacenter-g2] The Windows image SKU in the Azure marketplace. Default value = \"2019-datacenter-gensecond\"."
      }
    },
    "windowsVmImageVersion": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "The Windows image version in the Azure marketplace. Default value = \"latest\"."
      }
    },
    "windowsVmSize": {
      "type": "string",
      "defaultValue": "Standard_DS1_v2",
      "metadata": {
        "description": "The size of the Windows Virtual Machine for remote access. Default value = \"Standard_DS1_v2\"."
      }
    },
    "windowsVmStorageAccountType": {
      "type": "string",
      "defaultValue": "StandardSSD_LRS",
      "metadata": {
        "description": "The storage account type of the Windows Virtual Machine for remote access. Default value = \"StandardSSD_LRS\"."
      }
    }
  },
  "variables": {
    "copy": [
      {
        "name": "firewallClientUsableIpAddresses",
        "count": "[length(range(0, 4))]",
        "input": "[cidrHost(parameters('firewallClientSubnetAddressPrefix'), range(0, 4)[copyIndex('firewallClientUsableIpAddresses')])]"
      }
    ],
    "deploymentTenantId": "[tenant().tenantId]",
    "templateBaseUri": "[if(empty(deployment().properties.templateLink.uri), 'https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main', replace(split(deployment().properties.templateLink.uri, '?')[0], '/mlz/src/mlz.json', ''))]",
    "firewallClientPrivateIpAddress": "[variables('firewallClientUsableIpAddresses')[3]]",
    "resourceAbbreviations": {
      "actionGroups": "ag",
      "applicationGroups": "vdag",
      "applicationInsights": "appi",
      "appServicePlans": "asp",
      "automationAccounts": "aa",
      "availabilitySets": "avail",
      "azureFirewalls": "afw",
      "bastionHosts": "bas",
      "computeGallieries": "cg",
      "dataCollectionEndpoints": "dce",
      "dataCollectionRuleAssociations": "dcra",
      "dataCollectionRules": "dcr",
      "diagnosticSettings": "diag",
      "diskAccesses": "da",
      "diskEncryptionSets": "des",
      "disks": "disk",
      "firewallPolicies": "afwp",
      "applicationGateways": "agw",
      "applicationGatewayWafPolicies": "agwwafp",
      "functionApps": "func",
      "hostPools": "vdpool",
      "ipConfigurations": "ipconf",
      "keyVaults": "kv",
      "localNetworkGateways": "lgw",
      "logAnalyticsWorkspaces": "log",
      "natGateways": "ng",
      "netAppAccounts": "naa",
      "netAppAccountsCapacityPools": "cp",
      "networkInterfaces": "nic",
      "networkSecurityGroups": "nsg",
      "networkWatchers": "nw",
      "networkWatchersFlowLogs": "fl",
      "privateEndpoints": "pe",
      "privateLinkScopes": "pls",
      "publicIPAddresses": "pip",
      "publicIPPrefixes": "ippre",
      "recoveryServicesVaults": "rsv",
      "remoteApplicationGroups": "vdag",
      "resourceGroups": "rg",
      "routeTables": "rt",
      "scalingPlans": "vdscaling",
      "storageAccounts": "st",
      "subnets": "snet",
      "userAssignedIdentities": "id",
      "virtualMachines": "vm",
      "virtualNetworkGateways": "vgw",
      "virtualNetworks": "vnet",
      "workspaces": "vdws"
    },
    "resourceToken": "resource_token",
    "normalizedLocation": "[toLower(replace(parameters('location'), ' ', ''))]",
    "effectiveLocationAbbreviation": "[if(not(empty(parameters('locationAbbreviation'))), parameters('locationAbbreviation'), take(variables('normalizedLocation'), 4))]",
    "securityNamingConvention": "[format('{0}{1}{2}{1}{3}{1}security{1}{4}', toLower(parameters('identifier')), parameters('delimiter'), parameters('environmentAbbreviation'), variables('effectiveLocationAbbreviation'), variables('resourceToken'))]",
    "securityResourceGroupName": "[replace(variables('securityNamingConvention'), variables('resourceToken'), parameters('resourceAbbreviations').resourceGroups)]",
    "securityLogAnalyticsWorkspaceName": "[replace(variables('securityNamingConvention'), variables('resourceToken'), parameters('resourceAbbreviations').logAnalyticsWorkspaces)]",
    "monitoringResourceGroupName": "[if(parameters('deploySentinel'), split(variables('logAnalyticsWorkspaceResourceId'), '/')[4], parameters('tier').resourceGroupName)]",
    "logAnalyticsWorkspaceName": "[if(parameters('deploySentinel'), variables('securityLogAnalyticsWorkspaceName'), parameters('tier').namingConvention.logAnalyticsWorkspace)]",
    "logAnalyticsWorkspaceResourceId": "[if(parameters('deploySentinel'), resourceId(parameters('operationsSubscriptionId'), variables('securityResourceGroupName'), 'Microsoft.OperationalInsights/workspaces', variables('securityLogAnalyticsWorkspaceName')), resourceId(parameters('tier').subscriptionId, variables('monitoringResourceGroupName'), 'Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-networking-{0}', parameters('deploymentNameSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "bastionHostSubnetAddressPrefix": {
            "value": "[parameters('bastionHostSubnetAddressPrefix')]"
          },
          "azureGatewaySubnetAddressPrefix": {
            "value": "[parameters('azureGatewaySubnetAddressPrefix')]"
          },
          "deployIdentity": {
            "value": "[parameters('deployIdentity')]"
          },
          "deploymentNameSuffix": {
            "value": "[parameters('deploymentNameSuffix')]"
          },
          "deployBastion": {
            "value": "[parameters('deployBastion')]"
          },
          "deployAzureGatewaySubnet": {
            "value": "[parameters('deployAzureGatewaySubnet')]"
          },
          "dnsServers": "[if(and(parameters('deployIdentity'), parameters('deployActiveDirectoryDomainServices')), createObject('value', createArray(cidrHost(parameters('identitySubnetAddressPrefix'), if(equals(parameters('hubSubscriptionId'), parameters('identitySubscriptionId')), 3, 4)), cidrHost(parameters('identitySubnetAddressPrefix'), if(equals(parameters('hubSubscriptionId'), parameters('identitySubscriptionId')), 4, 5)))), createObject('value', parameters('dnsServers')))]",
          "enableProxy": {
            "value": "[parameters('enableProxy')]"
          },
          "environmentAbbreviation": {
            "value": "[parameters('environmentAbbreviation')]"
          },
          "resourceAbbreviations": {
            "value": "[parameters('resourceAbbreviations')]"
          },
          "firewallSettings": {
            "value": {
              "clientPrivateIpAddress": "[variables('firewallClientPrivateIpAddress')]",
              "clientPublicIPAddressAvailabilityZones": "[parameters('firewallClientPublicIPAddressAvailabilityZones')]",
              "clientSubnetAddressPrefix": "[parameters('firewallClientSubnetAddressPrefix')]",
              "customPipCount": "[parameters('additionalFwPipCount')]",
              "intrusionDetectionMode": "[parameters('firewallIntrusionDetectionMode')]",
              "managementPublicIPAddressAvailabilityZones": "[parameters('firewallManagementPublicIPAddressAvailabilityZones')]",
              "managementSubnetAddressPrefix": "[parameters('firewallManagementSubnetAddressPrefix')]",
              "skuTier": "[parameters('firewallSkuTier')]",
              "supernetIPAddress": "[parameters('firewallSupernetIPAddress')]",
              "threatIntelMode": "[parameters('firewallThreatIntelMode')]"
            }
          },
          "firewallRuleCollectionGroups": "[if(empty(parameters('customFirewallRuleCollectionGroups')), createObject('value', createArray(createObject('name', 'MLZ-DefaultCollectionGroup', 'properties', createObject('priority', 100, 'ruleCollections', createArray(createObject('name', 'NetworkRules', 'priority', 100, 'ruleCollectionType', 'FirewallPolicyFilterRuleCollection', 'action', createObject('type', 'Allow'), 'rules', union(createArray(createObject('name', 'Allow-LAW-TCP', 'ruleType', 'NetworkRule', 'ipProtocols', createArray('Tcp'), 'sourceAddresses', createArray(parameters('firewallSupernetIPAddress')), 'destinationAddresses', createArray(cidrHost(parameters('operationsVirtualNetworkAddressPrefix'), 3)), 'destinationPorts', createArray('443'))), if(parameters('deployActiveDirectoryDomainServices'), createArray(createObject('name', 'Allow-ADDS-TCP', 'ruleType', 'NetworkRule', 'ipProtocols', createArray('TCP'), 'sourceAddresses', createArray(parameters('firewallSupernetIPAddress')), 'destinationAddresses', createArray(cidrHost(parameters('identityVirtualNetworkAddressPrefix'), 3), cidrHost(parameters('identityVirtualNetworkAddressPrefix'), 4)), 'destinationPorts', createArray('53', '88', '135', '389', '445', '464', '636', '3268', '3269')), createObject('name', 'Allow-ADDS-UDP', 'ruleType', 'NetworkRule', 'ipProtocols', createArray('UDP'), 'sourceAddresses', createArray(parameters('firewallSupernetIPAddress')), 'destinationAddresses', createArray(cidrHost(parameters('identitySubnetAddressPrefix'), 3), cidrHost(parameters('identitySubnetAddressPrefix'), 4)), 'destinationPorts', createArray('53', '88', '123', '389', '464'))), createArray()), if(or(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine')), createArray(createObject('name', 'Allow-KMS-TCP', 'ruleType', 'NetworkRule', 'ipProtocols', createArray('Tcp'), 'sourceAddresses', union(if(and(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine')), createArray(cidrHost(parameters('hubSubnetAddressPrefix'), 4), cidrHost(parameters('hubSubnetAddressPrefix'), 5)), createArray(cidrHost(parameters('hubSubnetAddressPrefix'), 4))), if(parameters('deployActiveDirectoryDomainServices'), createArray(cidrHost(parameters('identitySubnetAddressPrefix'), 3), cidrHost(parameters('identitySubnetAddressPrefix'), 4)), createArray())), 'destinationAddresses', createArray(), 'destinationFqdns', createArray(format('azkms.{0}', environment().suffixes.storage), format('kms.{0}', environment().suffixes.storage)), 'destinationPorts', createArray('1688'), 'sourceIpGroups', createArray(), 'destinationIpGroups', createArray())), createArray()))), createObject('name', 'ApplicationRules', 'priority', 200, 'ruleCollectionType', 'FirewallPolicyFilterRuleCollection', 'action', createObject('type', 'Allow'), 'rules', if(or(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine')), createArray(createObject('name', 'Allow-WindowsUpdate', 'ruleType', 'ApplicationRule', 'protocols', createArray(createObject('protocolType', 'Https', 'port', 443)), 'fqdnTags', createArray('WindowsUpdate'), 'webCategories', createArray(), 'targetFqdns', createArray(), 'targetUrls', createArray(), 'terminateTLS', false(), 'sourceAddresses', union(if(and(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine')), createArray(cidrHost(parameters('hubSubnetAddressPrefix'), 4), cidrHost(parameters('hubSubnetAddressPrefix'), 5)), createArray(cidrHost(parameters('hubSubnetAddressPrefix'), 4))), if(parameters('deployActiveDirectoryDomainServices'), createArray(cidrHost(parameters('identitySubnetAddressPrefix'), 3), cidrHost(parameters('identitySubnetAddressPrefix'), 4)), createArray())), 'destinationAddresses', createArray(), 'sourceIpGroups', createArray())), createArray()))))))), createObject('value', parameters('customFirewallRuleCollectionGroups')))]",
          "identifier": {
            "value": "[parameters('identifier')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "networks": {
            "value": "[union(createArray(createObject('name', 'hub', 'shortName', 'hub', 'subscriptionId', parameters('hubSubscriptionId'), 'nsgDiagLogs', parameters('hubNetworkSecurityGroupDiagnosticsLogs'), 'nsgRules', parameters('hubNetworkSecurityGroupRules'), 'vnetAddressPrefix', parameters('hubVirtualNetworkAddressPrefix'), 'vnetDiagLogs', parameters('hubVirtualNetworkDiagnosticsLogs'), 'vnetDiagMetrics', parameters('hubVirtualNetworkDiagnosticsMetrics'), 'subnetAddressPrefix', parameters('hubSubnetAddressPrefix')), createObject('name', 'operations', 'shortName', 'ops', 'subscriptionId', parameters('operationsSubscriptionId'), 'nsgDiagLogs', parameters('operationsNetworkSecurityGroupDiagnosticsLogs'), 'nsgRules', parameters('operationsNetworkSecurityGroupRules'), 'vnetAddressPrefix', parameters('operationsVirtualNetworkAddressPrefix'), 'vnetDiagLogs', parameters('operationsVirtualNetworkDiagnosticsLogs'), 'vnetDiagMetrics', parameters('operationsVirtualNetworkDiagnosticsMetrics'), 'subnetAddressPrefix', parameters('operationsSubnetAddressPrefix')), createObject('name', 'sharedServices', 'shortName', 'svcs', 'subscriptionId', parameters('sharedServicesSubscriptionId'), 'nsgDiagLogs', parameters('sharedServicesNetworkSecurityGroupDiagnosticsLogs'), 'nsgRules', parameters('sharedServicesNetworkSecurityGroupRules'), 'vnetAddressPrefix', parameters('sharedServicesVirtualNetworkAddressPrefix'), 'vnetDiagLogs', parameters('sharedServicesVirtualNetworkDiagnosticsLogs'), 'vnetDiagMetrics', parameters('sharedServicesVirtualNetworkDiagnosticsMetrics'), 'subnetAddressPrefix', parameters('sharedServicesSubnetAddressPrefix'))), if(parameters('deployIdentity'), createArray(createObject('name', 'identity', 'shortName', 'id', 'subscriptionId', parameters('identitySubscriptionId'), 'nsgDiagLogs', parameters('identityNetworkSecurityGroupDiagnosticsLogs'), 'nsgRules', parameters('identityNetworkSecurityGroupRules'), 'vnetAddressPrefix', parameters('identityVirtualNetworkAddressPrefix'), 'vnetDiagLogs', parameters('identityVirtualNetworkDiagnosticsLogs'), 'vnetDiagMetrics', parameters('identityVirtualNetworkDiagnosticsMetrics'), 'subnetAddressPrefix', parameters('identitySubnetAddressPrefix'))), createArray()))]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "709767662766469926"
            }
          },
          "parameters": {
            "azureGatewaySubnetAddressPrefix": {
              "type": "string"
            },
            "bastionHostSubnetAddressPrefix": {
              "type": "string"
            },
            "deployAzureGatewaySubnet": {
              "type": "bool"
            },
            "deployBastion": {
              "type": "bool"
            },
            "deployIdentity": {
              "type": "bool"
            },
            "deploymentNameSuffix": {
              "type": "string"
            },
            "dnsServers": {
              "type": "array"
            },
            "enableProxy": {
              "type": "bool"
            },
            "environmentAbbreviation": {
              "type": "string"
            },
            "resourceAbbreviations": {
              "type": "object"
            },
            "firewallRuleCollectionGroups": {
              "type": "array"
            },
            "firewallSettings": {
              "type": "object"
            },
            "identifier": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "networks": {
              "type": "array"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "hubSubscriptionId": "[filter(parameters('networks'), lambda('network', equals(lambdaVariables('network').name, 'hub')))[0].subscriptionId]",
            "spokes": "[filter(parameters('networks'), lambda('network', not(equals(lambdaVariables('network').name, 'hub'))))]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('get-logic-{0}', parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "delimiter": {
                    "value": "-"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "environmentAbbreviation": {
                    "value": "[parameters('environmentAbbreviation')]"
                  },
                  "identifier": {
                    "value": "[parameters('identifier')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "networks": {
                    "value": "[parameters('networks')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "33840072713842827"
                    }
                  },
                  "parameters": {
                    "delimiter": {
                      "type": "string"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "environmentAbbreviation": {
                      "type": "string"
                    },
                    "identifier": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "networks": {
                      "type": "array"
                    },
                    "stampIndex": {
                      "type": "string",
                      "defaultValue": ""
                    }
                  },
                  "variables": {
                    "$fxv#0": {
                      "AzureChina": {
                        "chinaeast": {
                          "abbreviation": "cne",
                          "recoveryServicesGeo": "sha",
                          "timeDifference": "+8:00",
                          "timeZone": "China Standard Time"
                        },
                        "chinaeast2": {
                          "abbreviation": "cne2",
                          "recoveryServicesGeo": "sha2",
                          "timeDifference": "+8:00",
                          "timeZone": "China Standard Time"
                        },
                        "chinanorth": {
                          "abbreviation": "cnn",
                          "recoveryServicesGeo": "bjb",
                          "timeDifference": "+8:00",
                          "timeZone": "China Standard Time"
                        },
                        "chinanorth2": {
                          "abbreviation": "cnn2",
                          "recoveryServicesGeo": "bjb2",
                          "timeDifference": "+8:00",
                          "timeZone": "China Standard Time"
                        }
                      },
                      "AzureCloud": {
                        "australiacentral": {
                          "abbreviation": "auc",
                          "recoveryServicesGeo": "acl",
                          "timeDifference": "+10:00",
                          "timeZone": "AUS Eastern Standard Time"
                        },
                        "australiacentral2": {
                          "abbreviation": "auc2",
                          "recoveryServicesGeo": "acl2",
                          "timeDifference": "+10:00",
                          "timeZone": "AUS Eastern Standard Time"
                        },
                        "australiaeast": {
                          "abbreviation": "aue",
                          "recoveryServicesGeo": "ae",
                          "timeDifference": "+10:00",
                          "timeZone": "AUS Eastern Standard Time"
                        },
                        "australiasoutheast": {
                          "abbreviation": "ause",
                          "recoveryServicesGeo": "ase",
                          "timeDifference": "+10:00",
                          "timeZone": "AUS Eastern Standard Time"
                        },
                        "brazilsouth": {
                          "abbreviation": "brs",
                          "recoveryServicesGeo": "brs",
                          "timeDifference": "-3:00",
                          "timeZone": "E. South America Standard Time"
                        },
                        "brazilsoutheast": {
                          "abbreviation": "brse",
                          "recoveryServicesGeo": "bse",
                          "timeDifference": "-3:00",
                          "timeZone": "E. South America Standard Time"
                        },
                        "canadacentral": {
                          "abbreviation": "cac",
                          "recoveryServicesGeo": "cnc",
                          "timeDifference": "-5:00",
                          "timeZone": "Eastern Standard Time"
                        },
                        "canadaeast": {
                          "abbreviation": "cae",
                          "recoveryServicesGeo": "cne",
                          "timeDifference": "-5:00",
                          "timeZone": "Eastern Standard Time"
                        },
                        "centralindia": {
                          "abbreviation": "inc",
                          "recoveryServicesGeo": "inc",
                          "timeDifference": "+5:30",
                          "timeZone": "India Standard Time"
                        },
                        "centralus": {
                          "abbreviation": "usc",
                          "recoveryServicesGeo": "cus",
                          "timeDifference": "-6:00",
                          "timeZone": "Central Standard Time"
                        },
                        "eastasia": {
                          "abbreviation": "ase",
                          "recoveryServicesGeo": "ea",
                          "timeDifference": "+8:00",
                          "timeZone": "China Standard Time"
                        },
                        "eastus": {
                          "abbreviation": "use",
                          "recoveryServicesGeo": "eus",
                          "timeDifference": "-5:00",
                          "timeZone": "Eastern Standard Time"
                        },
                        "eastus2": {
                          "abbreviation": "use2",
                          "recoveryServicesGeo": "eus2",
                          "timeDifference": "-5:00",
                          "timeZone": "Eastern Standard Time"
                        },
                        "francecentral": {
                          "abbreviation": "frc",
                          "recoveryServicesGeo": "frc",
                          "timeDifference": "+1:00",
                          "timeZone": "Central Europe Standard Time"
                        },
                        "francesouth": {
                          "abbreviation": "frs",
                          "recoveryServicesGeo": "frs",
                          "timeDifference": "+1:00",
                          "timeZone": "Central Europe Standard Time"
                        },
                        "germanynorth": {
                          "abbreviation": "den",
                          "recoveryServicesGeo": "gn",
                          "timeDifference": "+1:00",
                          "timeZone": "Central Europe Standard Time"
                        },
                        "germanywestcentral": {
                          "abbreviation": "dewc",
                          "recoveryServicesGeo": "gwc",
                          "timeDifference": "+1:00",
                          "timeZone": "Central Europe Standard Time"
                        },
                        "israelcentral": {
                          "abbreviation": "ilc",
                          "recoveryServicesGeo": "ilc",
                          "timeDifference": "+2:00",
                          "timeZone": "Israel Standard Time"
                        },
                        "italynorth": {
                          "abbreviation": "itn",
                          "recoveryServicesGeo": "itn",
                          "timeDifference": "+1:00",
                          "timeZone": "Central Europe Standard Time"
                        },
                        "japaneast": {
                          "abbreviation": "jpe",
                          "recoveryServicesGeo": "jpe",
                          "timeDifference": "+9:00",
                          "timeZone": "Tokyo Standard Time"
                        },
                        "japanwest": {
                          "abbreviation": "jpw",
                          "recoveryServicesGeo": "jpw",
                          "timeDifference": "+9:00",
                          "timeZone": "Tokyo Standard Time"
                        },
                        "jioindiacentral": {
                          "abbreviation": "injc",
                          "recoveryServicesGeo": "jic",
                          "timeDifference": "+5:30",
                          "timeZone": "India Standard Time"
                        },
                        "jioindiawest": {
                          "abbreviation": "injw",
                          "recoveryServicesGeo": "jiw",
                          "timeDifference": "+5:30",
                          "timeZone": "India Standard Time"
                        },
                        "koreacentral": {
                          "abbreviation": "krc",
                          "recoveryServicesGeo": "krc",
                          "timeDifference": "+9:00",
                          "timeZone": "Korea Standard Time"
                        },
                        "koreasouth": {
                          "abbreviation": "krs",
                          "recoveryServicesGeo": "krs",
                          "timeDifference": "+9:00",
                          "timeZone": "Korea Standard Time"
                        },
                        "northcentralus": {
                          "abbreviation": "usnc",
                          "recoveryServicesGeo": "ncus",
                          "timeDifference": "-6:00",
                          "timeZone": "Central Standard Time"
                        },
                        "northeurope": {
                          "abbreviation": "eun",
                          "recoveryServicesGeo": "ne",
                          "timeDifference": "0:00",
                          "timeZone": "GMT Standard Time"
                        },
                        "norwayeast": {
                          "abbreviation": "noe",
                          "recoveryServicesGeo": "nwe",
                          "timeDifference": "+1:00",
                          "timeZone": "Central Europe Standard Time"
                        },
                        "norwaywest": {
                          "abbreviation": "now",
                          "recoveryServicesGeo": "nww",
                          "timeDifference": "+1:00",
                          "timeZone": "Central Europe Standard Time"
                        },
                        "polandcentral": {
                          "abbreviation": "plc",
                          "recoveryServicesGeo": "plc",
                          "timeDifference": "+1:00",
                          "timeZone": "Central Europe Standard Time"
                        },
                        "qatarcentral": {
                          "abbreviation": "qac",
                          "recoveryServicesGeo": "qac",
                          "timeDifference": "+3:00",
                          "timeZone": "Arabian Standard Time"
                        },
                        "southafricanorth": {
                          "abbreviation": "zan",
                          "recoveryServicesGeo": "san",
                          "timeDifference": "+2:00",
                          "timeZone": "South Africa Standard Time"
                        },
                        "southafricawest": {
                          "abbreviation": "zaw",
                          "recoveryServicesGeo": "saw",
                          "timeDifference": "+2:00",
                          "timeZone": "South Africa Standard Time"
                        },
                        "southcentralus": {
                          "abbreviation": "ussc",
                          "recoveryServicesGeo": "scus",
                          "timeDifference": "-6:00",
                          "timeZone": "Central Standard Time"
                        },
                        "southeastasia": {
                          "abbreviation": "asse",
                          "recoveryServicesGeo": "sea",
                          "timeDifference": "+8:00",
                          "timeZone": "Singapore Standard Time"
                        },
                        "southindia": {
                          "abbreviation": "ins",
                          "recoveryServicesGeo": "ins",
                          "timeDifference": "+5:30",
                          "timeZone": "India Standard Time"
                        },
                        "swedencentral": {
                          "abbreviation": "sec",
                          "recoveryServicesGeo": "sdc",
                          "timeDifference": "+1:00",
                          "timeZone": "Central Europe Standard Time"
                        },
                        "switzerlandnorth": {
                          "abbreviation": "chn",
                          "recoveryServicesGeo": "szn",
                          "timeDifference": "+1:00",
                          "timeZone": "Central Europe Standard Time"
                        },
                        "switzerlandwest": {
                          "abbreviation": "chw",
                          "recoveryServicesGeo": "szw",
                          "timeDifference": "+1:00",
                          "timeZone": "Central Europe Standard Time"
                        },
                        "uaecentral": {
                          "abbreviation": "aec",
                          "recoveryServicesGeo": "uac",
                          "timeDifference": "+3:00",
                          "timeZone": "Arabian Standard Time"
                        },
                        "uaenorth": {
                          "abbreviation": "aen",
                          "recoveryServicesGeo": "uan",
                          "timeDifference": "+3:00",
                          "timeZone": "Arabian Standard Time"
                        },
                        "uksouth": {
                          "abbreviation": "uks",
                          "recoveryServicesGeo": "uks",
                          "timeDifference": "0:00",
                          "timeZone": "GMT Standard Time"
                        },
                        "ukwest": {
                          "abbreviation": "ukw",
                          "recoveryServicesGeo": "ukw",
                          "timeDifference": "0:00",
                          "timeZone": "GMT Standard Time"
                        },
                        "westcentralus": {
                          "abbreviation": "uswc",
                          "recoveryServicesGeo": "wcus",
                          "timeDifference": "-7:00",
                          "timeZone": "Mountain Standard Time"
                        },
                        "westeurope": {
                          "abbreviation": "euw",
                          "recoveryServicesGeo": "we",
                          "timeDifference": "+1:00",
                          "timeZone": "Central Europe Standard Time"
                        },
                        "westindia": {
                          "abbreviation": "inw",
                          "recoveryServicesGeo": "inw",
                          "timeDifference": "+5:30",
                          "timeZone": "India Standard Time"
                        },
                        "westus": {
                          "abbreviation": "usw",
                          "recoveryServicesGeo": "wus",
                          "timeDifference": "-8:00",
                          "timeZone": "Pacific Standard Time"
                        },
                        "westus2": {
                          "abbreviation": "usw2",
                          "recoveryServicesGeo": "wus2",
                          "timeDifference": "-8:00",
                          "timeZone": "Pacific Standard Time"
                        },
                        "westus3": {
                          "abbreviation": "usw3",
                          "recoveryServicesGeo": "wus3",
                          "timeDifference": "-7:00",
                          "timeZone": "Mountain Standard Time"
                        }
                      },
                      "AzureUSGovernment": {
                        "usdodcentral": {
                          "abbreviation": "dodc",
                          "recoveryServicesGeo": "udc",
                          "timeDifference": "-6:00",
                          "timeZone": "Central Standard Time"
                        },
                        "usdodeast": {
                          "abbreviation": "dode",
                          "recoveryServicesGeo": "ude",
                          "timeDifference": "-5:00",
                          "timeZone": "Eastern Standard Time"
                        },
                        "usgovarizona": {
                          "abbreviation": "az",
                          "recoveryServicesGeo": "uga",
                          "timeDifference": "-7:00",
                          "timeZone": "Mountain Standard Time"
                        },
                        "usgovtexas": {
                          "abbreviation": "tx",
                          "recoveryServicesGeo": "ugt",
                          "timeDifference": "-6:00",
                          "timeZone": "Central Standard Time"
                        },
                        "usgovvirginia": {
                          "abbreviation": "va",
                          "recoveryServicesGeo": "ugv",
                          "timeDifference": "-5:00",
                          "timeZone": "Eastern Standard Time"
                        }
                      }
                    },
                    "$fxv#1": "1.0.0",
                    "$fxv#2": {
                      "actionGroups": "ag",
                      "applicationGroups": "vdag",
                      "applicationInsights": "appi",
                      "appServicePlans": "asp",
                      "automationAccounts": "aa",
                      "availabilitySets": "avail",
                      "azureFirewalls": "afw",
                      "bastionHosts": "bas",
                      "computeGallieries": "cg",
                      "dataCollectionEndpoints": "dce",
                      "dataCollectionRuleAssociations": "dcra",
                      "dataCollectionRules": "dcr",
                      "diagnosticSettings": "diag",
                      "diskAccesses": "da",
                      "diskEncryptionSets": "des",
                      "disks": "disk",
                      "firewallPolicies": "afwp",
                      "applicationGateways": "agw",
                      "applicationGatewayWafPolicies": "agwwafp",
                      "functionApps": "func",
                      "hostPools": "vdpool",
                      "ipConfigurations": "ipconf",
                      "keyVaults": "kv",
                      "localNetworkGateways": "lgw",
                      "logAnalyticsWorkspaces": "log",
                      "natGateways": "ng",
                      "netAppAccounts": "naa",
                      "netAppAccountsCapacityPools": "cp",
                      "networkInterfaces": "nic",
                      "networkSecurityGroups": "nsg",
                      "networkWatchers": "nw",
                      "networkWatchersFlowLogs": "fl",
                      "privateEndpoints": "pe",
                      "privateLinkScopes": "pls",
                      "publicIPAddresses": "pip",
                      "publicIPPrefixes": "ippre",
                      "recoveryServicesVaults": "rsv",
                      "remoteApplicationGroups": "vdag",
                      "resourceGroups": "rg",
                      "routeTables": "rt",
                      "scalingPlans": "vdscaling",
                      "storageAccounts": "st",
                      "subnets": "snet",
                      "userAssignedIdentities": "id",
                      "virtualMachines": "vm",
                      "virtualNetworkGateways": "vgw",
                      "virtualNetworks": "vnet",
                      "workspaces": "vdws"
                    },
                    "directionShortNames": {
                      "east": "e",
                      "eastcentral": "ec",
                      "north": "n",
                      "northcentral": "nc",
                      "south": "s",
                      "southcentral": "sc",
                      "west": "w",
                      "westcentral": "wc"
                    },
                    "locationAbbreviations": {
                      "eastus": "eus",
                      "eastus2": "use2",
                      "westus": "wus",
                      "westus2": "wus2"
                    },
                    "environmentName": {
                      "dev": "Development",
                      "prod": "Production",
                      "test": "Test"
                    },
                    "normalizedLocation": "[toLower(replace(parameters('location'), ' ', ''))]",
                    "locations": "[coalesce(tryGet(variables('$fxv#0'), environment().name), createObject(format('{0}', variables('normalizedLocation')), createObject('abbreviation', coalesce(tryGet(variables('locationAbbreviations'), variables('normalizedLocation')), tryGet(variables('directionShortNames'), skip(variables('normalizedLocation'), sub(length(variables('normalizedLocation')), 4))), take(variables('normalizedLocation'), 4)), 'timeDifference', if(contains(variables('normalizedLocation'), 'east'), '-5:00', if(contains(variables('normalizedLocation'), 'west'), '-8:00', '0:00')), 'timeZone', if(contains(variables('normalizedLocation'), 'east'), 'Eastern Standard Time', if(contains(variables('normalizedLocation'), 'west'), 'Pacific Standard Time', 'GMT Standard Time')))))]",
                    "resolvedLocation": "[coalesce(tryGet(variables('locations'), variables('normalizedLocation')), createObject('abbreviation', coalesce(tryGet(variables('locationAbbreviations'), variables('normalizedLocation')), tryGet(variables('directionShortNames'), skip(variables('normalizedLocation'), sub(length(variables('normalizedLocation')), 4))), take(variables('normalizedLocation'), 4)), 'timeDifference', if(contains(variables('normalizedLocation'), 'east'), '-5:00', if(contains(variables('normalizedLocation'), 'west'), '-8:00', '0:00')), 'timeZone', if(contains(variables('normalizedLocation'), 'east'), 'Eastern Standard Time', if(contains(variables('normalizedLocation'), 'west'), 'Pacific Standard Time', 'GMT Standard Time'))))]",
                    "mlzTags": {
                      "environment": "[variables('environmentName')[parameters('environmentAbbreviation')]]",
                      "identifier": "[parameters('identifier')]",
                      "landingZoneName": "MissionLandingZone",
                      "landingZoneVersion": "[variables('$fxv#1')]"
                    },
                    "resourceAbbreviations": "[variables('$fxv#2')]"
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "namingConventions",
                        "count": "[length(parameters('networks'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('naming-convention-{0}-{1}', parameters('networks')[copyIndex()].shortName, parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "delimiter": {
                            "value": "[parameters('delimiter')]"
                          },
                          "environmentAbbreviation": {
                            "value": "[parameters('environmentAbbreviation')]"
                          },
                          "identifier": {
                            "value": "[parameters('identifier')]"
                          },
                          "locationAbbreviation": {
                            "value": "[variables('resolvedLocation').abbreviation]"
                          },
                          "networkName": {
                            "value": "[parameters('networks')[copyIndex()].name]"
                          },
                          "resourceAbbreviations": {
                            "value": "[variables('resourceAbbreviations')]"
                          },
                          "stampIndex": {
                            "value": "[parameters('stampIndex')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "11684708945930884183"
                            }
                          },
                          "parameters": {
                            "delimiter": {
                              "type": "string",
                              "allowedValues": [
                                "",
                                "-"
                              ]
                            },
                            "environmentAbbreviation": {
                              "type": "string"
                            },
                            "identifier": {
                              "type": "string"
                            },
                            "locationAbbreviation": {
                              "type": "string"
                            },
                            "networkName": {
                              "type": "string"
                            },
                            "resourceAbbreviations": {
                              "type": "object"
                            },
                            "stampIndex": {
                              "type": "string",
                              "defaultValue": ""
                            }
                          },
                          "variables": {
                            "tokens": {
                              "resource": "resource_token",
                              "service": "service_token"
                            },
                            "namingConvention": "[format('{0}{1}{2}{3}{4}{5}{6}{7}{8}{9}', toLower(parameters('identifier')), parameters('delimiter'), parameters('environmentAbbreviation'), parameters('delimiter'), parameters('locationAbbreviation'), parameters('delimiter'), parameters('networkName'), parameters('delimiter'), variables('tokens').resource, if(empty(parameters('stampIndex')), '', format('{0}{1}', parameters('delimiter'), parameters('stampIndex'))))]",
                            "namingConvention_Service": "[format('{0}{1}{2}{3}{4}{5}{6}{7}{8}{9}{10}{11}', toLower(parameters('identifier')), parameters('delimiter'), parameters('environmentAbbreviation'), parameters('delimiter'), parameters('locationAbbreviation'), parameters('delimiter'), parameters('networkName'), parameters('delimiter'), variables('tokens').service, parameters('delimiter'), variables('tokens').resource, if(empty(parameters('stampIndex')), '', format('{0}{1}', parameters('delimiter'), parameters('stampIndex'))))]",
                            "names": {
                              "actionGroup": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').actionGroups)]",
                              "applicationGroup": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').applicationGroups)]",
                              "applicationInsights": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').applicationInsights)]",
                              "appServicePlan": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').appServicePlans)]",
                              "automationAccount": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').automationAccounts)]",
                              "automationAccountDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').automationAccounts)]",
                              "automationAccountNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').automationAccounts)]",
                              "automationAccountPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').automationAccounts)]",
                              "availabilitySet": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').availabilitySets)]",
                              "azureFirewall": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').azureFirewalls)]",
                              "azureFirewallPublicIPAddress": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPAddresses), variables('tokens').service, parameters('resourceAbbreviations').azureFirewalls)]",
                              "azureFirewallPublicIPAddressDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}{2}', parameters('resourceAbbreviations').publicIPAddresses, parameters('delimiter'), parameters('resourceAbbreviations').azureFirewalls))]",
                              "azureFirewallDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').azureFirewalls)]",
                              "azureFirewallPolicy": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').firewallPolicies)]",
                              "applicationGateway": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').applicationGateways)]",
                              "applicationGatewayPublicIPAddress": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPAddresses), variables('tokens').service, parameters('resourceAbbreviations').applicationGateways)]",
                              "applicationGatewayDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').applicationGateways)]",
                              "applicationGatewayWafPolicy": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').applicationGatewayWafPolicies)]",
                              "applicationGatewayWafPolicyDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').applicationGatewayWafPolicies)]",
                              "applicationGatewayRouteTable": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').routeTables), variables('tokens').service, parameters('resourceAbbreviations').applicationGateways)]",
                              "applicationGatewayNetworkSecurityGroup": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkSecurityGroups), variables('tokens').service, parameters('resourceAbbreviations').applicationGateways)]",
                              "bastionHost": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').bastionHosts)]",
                              "bastionHostDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').bastionHosts)]",
                              "bastionHostNetworkSecurityGroup": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkSecurityGroups), variables('tokens').service, parameters('resourceAbbreviations').bastionHosts)]",
                              "bastionHostNetworkSecurityGroupDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}{2}', parameters('resourceAbbreviations').networkSecurityGroups, parameters('delimiter'), parameters('resourceAbbreviations').bastionHosts))]",
                              "bastionHostPublicIPAddress": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPAddresses), variables('tokens').service, parameters('resourceAbbreviations').bastionHosts)]",
                              "bastionHostPublicIPAddressDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}{2}', parameters('resourceAbbreviations').publicIPAddresses, parameters('delimiter'), parameters('resourceAbbreviations').bastionHosts))]",
                              "computeGallery": "[replace(replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').computeGallieries), parameters('delimiter'), if(empty(parameters('delimiter')), '', '_'))]",
                              "dataCollectionEndpoint": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').dataCollectionEndpoints)]",
                              "dataCollectionRuleAssociation": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').dataCollectionRuleAssociations)]",
                              "dataCollectionRule": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').dataCollectionRules)]",
                              "diskAccess": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').diskAccesses)]",
                              "diskAccessNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').diskAccesses)]",
                              "diskAccessPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').diskAccesses)]",
                              "diskEncryptionSet": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').diskEncryptionSets)]",
                              "functionApp": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').functionApps)]",
                              "functionAppNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').functionApps)]",
                              "functionAppPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').functionApps)]",
                              "hostPool": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').hostPools)]",
                              "hostPoolDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').hostPools)]",
                              "hostPoolNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').hostPools)]",
                              "hostPoolPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').hostPools)]",
                              "keyVault": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').keyVaults)]",
                              "keyVaultDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').keyVaults)]",
                              "keyVaultNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').keyVaults)]",
                              "keyVaultPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').keyVaults)]",
                              "localNetworkGateway": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').localNetworkGateways)]",
                              "logAnalyticsWorkspace": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').logAnalyticsWorkspaces)]",
                              "logAnalyticsWorkspaceDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').logAnalyticsWorkspaces)]",
                              "natGateway": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').natGateways)]",
                              "natGatewayPublicIPPrefix": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPPrefixes), variables('tokens').service, parameters('resourceAbbreviations').natGateways)]",
                              "netAppAccount": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').netAppAccounts)]",
                              "netAppAccountCapacityPool": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').netAppAccountsCapacityPools), variables('tokens').service, parameters('resourceAbbreviations').netAppAccounts)]",
                              "netAppAccountSmbServer": "[replace(replace(replace(replace(variables('namingConvention'), variables('tokens').resource, ''), parameters('environmentAbbreviation'), first(parameters('environmentAbbreviation'))), parameters('networkName'), ''), parameters('delimiter'), '')]",
                              "networkSecurityGroup": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').networkSecurityGroups)]",
                              "networkSecurityGroupDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').networkSecurityGroups)]",
                              "networkWatcherFlowLogsNetworkSecurityGroup": "[replace(variables('namingConvention'), variables('tokens').resource, format('{0}{1}{2}{3}{4}', parameters('resourceAbbreviations').networkWatchers, parameters('delimiter'), parameters('resourceAbbreviations').networkWatchersFlowLogs, parameters('delimiter'), parameters('resourceAbbreviations').networkSecurityGroups))]",
                              "networkWatcherFlowLogsVirtualNetwork": "[replace(variables('namingConvention'), variables('tokens').resource, format('{0}{1}{2}{3}{4}', parameters('resourceAbbreviations').networkWatchers, parameters('delimiter'), parameters('resourceAbbreviations').networkWatchersFlowLogs, parameters('delimiter'), parameters('resourceAbbreviations').virtualNetworks))]",
                              "privateLinkScope": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').privateLinkScopes)]",
                              "privateLinkScopeNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').privateLinkScopes)]",
                              "privateLinkScopePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').privateLinkScopes)]",
                              "recoveryServicesVault": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').recoveryServicesVaults)]",
                              "recoveryServicesVaultNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').recoveryServicesVaults)]",
                              "recoveryServicesVaultPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').recoveryServicesVaults)]",
                              "resourceGroup": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').resourceGroups)]",
                              "routeTable": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').routeTables)]",
                              "scalingPlan": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').scalingPlans)]",
                              "scalingPlanDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').scalingPlans)]",
                              "storageAccount": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').storageAccounts)]",
                              "storageAccountBlobDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}blob', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                              "storageAccountBlobNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, format('{0}{1}blob', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                              "storageAccountBlobPrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, format('{0}{1}blob', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                              "storageAccountFileDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}file', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                              "storageAccountFileNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, format('{0}{1}file', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                              "storageAccountFilePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, format('{0}{1}file', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                              "storageAccountQueueDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}queue', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                              "storageAccountQueueNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, format('{0}{1}queue', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                              "storageAccountQueuePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, format('{0}{1}queue', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                              "storageAccountTableDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}table', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                              "storageAccountTableNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, format('{0}{1}table', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                              "storageAccountTablePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, format('{0}{1}table', parameters('resourceAbbreviations').storageAccounts, parameters('delimiter')))]",
                              "subnet": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').subnets)]",
                              "userAssignedIdentity": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').userAssignedIdentities)]",
                              "virtualMachine": "[replace(replace(replace(replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').virtualMachines), parameters('environmentAbbreviation'), first(parameters('environmentAbbreviation'))), parameters('networkName'), ''), parameters('delimiter'), '')]",
                              "virtualMachineDisk": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').disks), variables('tokens').service, format('{0}', parameters('resourceAbbreviations').virtualMachines))]",
                              "virtualMachineNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').virtualMachines)]",
                              "virtualMachineNetworkInterfaceDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, format('{0}{1}{2}', parameters('resourceAbbreviations').networkInterfaces, parameters('delimiter'), parameters('resourceAbbreviations').virtualMachines))]",
                              "virtualNetwork": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').virtualNetworks)]",
                              "virtualNetworkDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').virtualNetworks)]",
                              "virtualNetworkGateway": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').virtualNetworkGateways)]",
                              "virtualNetworkGatewayPublicIpAddress": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').publicIPAddresses), variables('tokens').service, parameters('resourceAbbreviations').virtualNetworkGateways)]",
                              "workspace": "[replace(variables('namingConvention'), variables('tokens').resource, parameters('resourceAbbreviations').workspaces)]",
                              "workspaceDiagnosticSetting": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').diagnosticSettings), variables('tokens').service, parameters('resourceAbbreviations').workspaces)]",
                              "workspaceNetworkInterface": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').networkInterfaces), variables('tokens').service, parameters('resourceAbbreviations').workspaces)]",
                              "workspacePrivateEndpoint": "[replace(replace(variables('namingConvention_Service'), variables('tokens').resource, parameters('resourceAbbreviations').privateEndpoints), variables('tokens').service, parameters('resourceAbbreviations').workspaces)]"
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "names": {
                              "type": "object",
                              "value": "[variables('names')]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('private-dns-zones-{0}', parameters('deploymentNameSuffix'))]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {},
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "67734725024985285"
                            }
                          },
                          "variables": {
                            "cloudSuffix": "[replace(replace(environment().resourceManager, 'https://management.azure.', ''), '/', '')]",
                            "privateDnsZoneNames": "[union(createArray(format('privatelink.agentsvc.azure-automation.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureAutomation, environment().name), format('opinsights.azure.{0}', variables('cloudSuffix')))), format('privatelink.azure-automation.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureAutomation, environment().name), variables('cloudSuffix'))), format('privatelink.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureWebSites, environment().name), format('appservice.{0}', variables('cloudSuffix')))), format('scm.privatelink.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureWebSites, environment().name), format('appservice.{0}', variables('cloudSuffix')))), format('privatelink.wvd.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureVirtualDesktop, environment().name), variables('cloudSuffix'))), format('privatelink-global.wvd.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureVirtualDesktop, environment().name), variables('cloudSuffix'))), format('privatelink.file.{0}', environment().suffixes.storage), format('privatelink.queue.{0}', environment().suffixes.storage), format('privatelink.table.{0}', environment().suffixes.storage), format('privatelink.blob.{0}', environment().suffixes.storage), format('privatelink{0}', replace(environment().suffixes.keyvaultDns, 'vault', 'vaultcore')), format('privatelink.monitor.azure.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureMonitor, environment().name), variables('cloudSuffix'))), format('privatelink.ods.opinsights.azure.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureMonitor, environment().name), variables('cloudSuffix'))), format('privatelink.oms.opinsights.azure.{0}', coalesce(tryGet(variables('privateDnsZoneSuffixes').azureMonitor, environment().name), variables('cloudSuffix'))), format('privatelink{0}', environment().suffixes.sqlServerHostname)), createArray())]",
                            "privateDnsZoneSuffixes": {
                              "azureAutomation": {
                                "AzureCloud": "net",
                                "AzureUSGovernment": "us"
                              },
                              "azureBackup": {
                                "AzureCloud": "com",
                                "AzureUSGovernment": "us"
                              },
                              "azureMonitor": {
                                "AzureCloud": "com",
                                "AzureUSGovernment": "us"
                              },
                              "azureVirtualDesktop": {
                                "AzureCloud": "microsoft.com",
                                "AzureUSGovernment": "azure.us"
                              },
                              "azureWebSites": {
                                "AzureCloud": "azurewebsites.net",
                                "AzureUSGovernment": "azurewebsites.us"
                              }
                            }
                          },
                          "resources": [],
                          "outputs": {
                            "names": {
                              "type": "array",
                              "value": "[variables('privateDnsZoneNames')]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "delimiter": {
                      "type": "string",
                      "value": "[parameters('delimiter')]"
                    },
                    "locationProperties": {
                      "type": "object",
                      "value": "[variables('resolvedLocation')]"
                    },
                    "mlzTags": {
                      "type": "object",
                      "value": "[variables('mlzTags')]"
                    },
                    "privateDnsZones": {
                      "type": "array",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value]"
                    },
                    "resourceAbbreviations": {
                      "type": "object",
                      "value": "[variables('resourceAbbreviations')]"
                    },
                    "tiers": {
                      "type": "array",
                      "copy": {
                        "count": "[length(parameters('networks'))]",
                        "input": {
                          "name": "[parameters('networks')[copyIndex()].name]",
                          "namingConvention": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('naming-convention-{0}-{1}', parameters('networks')[copyIndex()].shortName, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value]",
                          "nsgDiagLogs": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'nsgDiagLogs'), createArray())]",
                          "nsgRules": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'nsgRules'), createArray())]",
                          "shortName": "[parameters('networks')[copyIndex()].shortName]",
                          "subnetAddressPrefix": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'subnetAddressPrefix'), '')]",
                          "subscriptionId": "[parameters('networks')[copyIndex()].subscriptionId]",
                          "vnetAddressPrefix": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'vnetAddressPrefix'), '')]",
                          "vnetDiagLogs": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'vnetDiagLogs'), createArray())]",
                          "vnetDiagMetrics": "[coalesce(tryGet(parameters('networks')[copyIndex()], 'vnetDiagMetrics'), createArray())]"
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "delimiter": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                  },
                  "tiers": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "12796333039108046880"
                    }
                  },
                  "parameters": {
                    "delimiter": {
                      "type": "string"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "tiers": {
                      "type": "array"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "resourceGroups",
                        "count": "[length(parameters('tiers'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-rg-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tiers')[copyIndex()].subscriptionId]",
                      "location": "[deployment().location]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "name": {
                            "value": "[format('{0}{1}network', parameters('tiers')[copyIndex()].namingConvention.resourceGroup, parameters('delimiter'))]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "6902469917586543260"
                            }
                          },
                          "parameters": {
                            "mlzTags": {
                              "type": "object"
                            },
                            "name": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Resources/resourceGroups",
                              "apiVersion": "2019-05-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Resources/resourceGroups'), createObject()), parameters('mlzTags'))]"
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
                            },
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            },
                            "location": {
                              "type": "string",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').location]"
                            },
                            "tags": {
                              "type": "object",
                              "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').tags]"
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "names": {
                      "type": "array",
                      "copy": {
                        "count": "[length(parameters('tiers'))]",
                        "input": "[reference(subscriptionResourceId(parameters('tiers')[copyIndex()].subscriptionId, 'Microsoft.Resources/deployments', format('deploy-rg-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]"
                      }
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "azureGatewaySubnetAddressPrefix": {
                    "value": "[parameters('azureGatewaySubnetAddressPrefix')]"
                  },
                  "bastionHostSubnetAddressPrefix": {
                    "value": "[parameters('bastionHostSubnetAddressPrefix')]"
                  },
                  "delimiter": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
                  },
                  "deployAzureGatewaySubnet": {
                    "value": "[parameters('deployAzureGatewaySubnet')]"
                  },
                  "deployBastion": {
                    "value": "[parameters('deployBastion')]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "dnsServers": {
                    "value": "[parameters('dnsServers')]"
                  },
                  "enableProxy": {
                    "value": "[parameters('enableProxy')]"
                  },
                  "firewallClientPrivateIpAddress": {
                    "value": "[parameters('firewallSettings').clientPrivateIpAddress]"
                  },
                  "firewallClientPublicIPAddressAvailabilityZones": {
                    "value": "[parameters('firewallSettings').clientPublicIPAddressAvailabilityZones]"
                  },
                  "firewallClientSubnetAddressPrefix": {
                    "value": "[parameters('firewallSettings').clientSubnetAddressPrefix]"
                  },
                  "firewallCustomPipCount": {
                    "value": "[parameters('firewallSettings').customPipCount]"
                  },
                  "firewallIntrusionDetectionMode": {
                    "value": "[parameters('firewallSettings').intrusionDetectionMode]"
                  },
                  "firewallManagementPublicIPAddressAvailabilityZones": {
                    "value": "[parameters('firewallSettings').managementPublicIPAddressAvailabilityZones]"
                  },
                  "firewallManagementSubnetAddressPrefix": {
                    "value": "[parameters('firewallSettings').managementSubnetAddressPrefix]"
                  },
                  "firewallSkuTier": {
                    "value": "[parameters('firewallSettings').skuTier]"
                  },
                  "firewallThreatIntelMode": {
                    "value": "[parameters('firewallSettings').threatIntelMode]"
                  },
                  "firewallRuleCollectionGroups": {
                    "value": "[parameters('firewallRuleCollectionGroups')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                  },
                  "resourceGroupName": {
                    "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value, lambda('name', contains(lambdaVariables('name'), 'hub')))[0]]"
                  },
                  "subscriptionId": {
                    "value": "[variables('hubSubscriptionId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "tier": {
                    "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value, lambda('tier', equals(lambdaVariables('tier').name, 'hub')))[0]]"
                  },
                  "vNetDnsServers": {
                    "value": [
                      "[parameters('firewallSettings').clientPrivateIpAddress]"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "764057282376762700"
                    }
                  },
                  "parameters": {
                    "azureGatewaySubnetAddressPrefix": {
                      "type": "string"
                    },
                    "bastionHostSubnetAddressPrefix": {
                      "type": "string"
                    },
                    "delimiter": {
                      "type": "string"
                    },
                    "deployAzureGatewaySubnet": {
                      "type": "bool"
                    },
                    "deployBastion": {
                      "type": "bool"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "dnsServers": {
                      "type": "array"
                    },
                    "enableProxy": {
                      "type": "bool"
                    },
                    "firewallClientPrivateIpAddress": {
                      "type": "string"
                    },
                    "firewallClientPublicIPAddressAvailabilityZones": {
                      "type": "array"
                    },
                    "firewallClientSubnetAddressPrefix": {
                      "type": "string"
                    },
                    "firewallCustomPipCount": {
                      "type": "int"
                    },
                    "firewallIntrusionDetectionMode": {
                      "type": "string",
                      "allowedValues": [
                        "Alert",
                        "Deny",
                        "Off"
                      ]
                    },
                    "firewallManagementPublicIPAddressAvailabilityZones": {
                      "type": "array"
                    },
                    "firewallManagementSubnetAddressPrefix": {
                      "type": "string"
                    },
                    "firewallSkuTier": {
                      "type": "string"
                    },
                    "firewallThreatIntelMode": {
                      "type": "string",
                      "allowedValues": [
                        "Alert",
                        "Deny",
                        "Off"
                      ]
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "resourceGroupName": {
                      "type": "string"
                    },
                    "subscriptionId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "tier": {
                      "type": "object"
                    },
                    "vNetDnsServers": {
                      "type": "array"
                    },
                    "firewallRuleCollectionGroups": {
                      "type": "array"
                    }
                  },
                  "variables": {
                    "bastionNetworkSecurityGroupRules": [
                      {
                        "name": "AllowHttpsInBound",
                        "properties": {
                          "protocol": "Tcp",
                          "sourcePortRange": "*",
                          "sourceAddressPrefix": "Internet",
                          "destinationPortRange": "443",
                          "destinationAddressPrefix": "*",
                          "access": "Allow",
                          "priority": 120,
                          "direction": "Inbound"
                        }
                      },
                      {
                        "name": "AllowGatewayManagerInBound",
                        "properties": {
                          "protocol": "Tcp",
                          "sourcePortRange": "*",
                          "sourceAddressPrefix": "GatewayManager",
                          "destinationPortRange": "443",
                          "destinationAddressPrefix": "*",
                          "access": "Allow",
                          "priority": 130,
                          "direction": "Inbound"
                        }
                      },
                      {
                        "name": "AllowLoadBalancerInBound",
                        "properties": {
                          "protocol": "Tcp",
                          "sourcePortRange": "*",
                          "sourceAddressPrefix": "AzureLoadBalancer",
                          "destinationPortRange": "443",
                          "destinationAddressPrefix": "*",
                          "access": "Allow",
                          "priority": 140,
                          "direction": "Inbound"
                        }
                      },
                      {
                        "name": "AllowBastionHostCommunicationInBound",
                        "properties": {
                          "protocol": "*",
                          "sourcePortRange": "*",
                          "sourceAddressPrefix": "VirtualNetwork",
                          "destinationPortRanges": [
                            "8080",
                            "5701"
                          ],
                          "destinationAddressPrefix": "VirtualNetwork",
                          "access": "Allow",
                          "priority": 150,
                          "direction": "Inbound"
                        }
                      },
                      {
                        "name": "AllowSshRdpOutBound",
                        "properties": {
                          "protocol": "Tcp",
                          "sourcePortRange": "*",
                          "sourceAddressPrefix": "*",
                          "destinationPortRanges": [
                            "22",
                            "3389"
                          ],
                          "destinationAddressPrefix": "VirtualNetwork",
                          "access": "Allow",
                          "priority": 120,
                          "direction": "Outbound"
                        }
                      },
                      {
                        "name": "AllowAzureCloudCommunicationOutBound",
                        "properties": {
                          "protocol": "Tcp",
                          "sourcePortRange": "*",
                          "sourceAddressPrefix": "*",
                          "destinationPortRange": "443",
                          "destinationAddressPrefix": "AzureCloud",
                          "access": "Allow",
                          "priority": 130,
                          "direction": "Outbound"
                        }
                      },
                      {
                        "name": "AllowBastionHostCommunicationOutBound",
                        "properties": {
                          "protocol": "*",
                          "sourcePortRange": "*",
                          "sourceAddressPrefix": "VirtualNetwork",
                          "destinationPortRanges": [
                            "8080",
                            "5701"
                          ],
                          "destinationAddressPrefix": "VirtualNetwork",
                          "access": "Allow",
                          "priority": 140,
                          "direction": "Outbound"
                        }
                      },
                      {
                        "name": "AllowGetSessionInformationOutBound",
                        "properties": {
                          "protocol": "*",
                          "sourcePortRange": "*",
                          "sourceAddressPrefix": "*",
                          "destinationAddressPrefix": "Internet",
                          "destinationPortRanges": [
                            "80",
                            "443"
                          ],
                          "access": "Allow",
                          "priority": 150,
                          "direction": "Outbound"
                        }
                      }
                    ]
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-hub-nsg-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "name": {
                            "value": "[parameters('tier').namingConvention.networkSecurityGroup]"
                          },
                          "securityRules": {
                            "value": "[parameters('tier').nsgRules]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "16438028713840255561"
                            }
                          },
                          "parameters": {
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "name": {
                              "type": "string"
                            },
                            "securityRules": {
                              "type": "array"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/networkSecurityGroups",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkSecurityGroups'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "securityRules": "[parameters('securityRules')]"
                              }
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                            },
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "condition": "[parameters('deployBastion')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-hub-bastion-nsg-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "name": {
                            "value": "[parameters('tier').namingConvention.bastionHostNetworkSecurityGroup]"
                          },
                          "securityRules": {
                            "value": "[variables('bastionNetworkSecurityGroupRules')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "16438028713840255561"
                            }
                          },
                          "parameters": {
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "name": {
                              "type": "string"
                            },
                            "securityRules": {
                              "type": "array"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/networkSecurityGroups",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkSecurityGroups'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "securityRules": "[parameters('securityRules')]"
                              }
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                            },
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-hub-rt-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "disableBgpRoutePropagation": {
                            "value": false
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "name": {
                            "value": "[parameters('tier').namingConvention.routeTable]"
                          },
                          "routeNextHopIpAddress": {
                            "value": "[parameters('firewallClientPrivateIpAddress')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "14716415322656266319"
                            }
                          },
                          "parameters": {
                            "disableBgpRoutePropagation": {
                              "type": "bool"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "name": {
                              "type": "string"
                            },
                            "routeAddressPrefix": {
                              "type": "string",
                              "defaultValue": "0.0.0.0/0"
                            },
                            "routeName": {
                              "type": "string",
                              "defaultValue": "default_route"
                            },
                            "routeNextHopIpAddress": {
                              "type": "string"
                            },
                            "routeNextHopType": {
                              "type": "string",
                              "defaultValue": "VirtualAppliance"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/routeTables",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/routeTables'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "disableBgpRoutePropagation": "[parameters('disableBgpRoutePropagation')]",
                                "routes": [
                                  {
                                    "name": "[parameters('routeName')]",
                                    "properties": {
                                      "addressPrefix": "[parameters('routeAddressPrefix')]",
                                      "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]",
                                      "nextHopType": "[parameters('routeNextHopType')]"
                                    }
                                  }
                                ]
                              }
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/routeTables', parameters('name'))]"
                            },
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "addressPrefix": {
                            "value": "[parameters('tier').vnetAddressPrefix]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "name": {
                            "value": "[parameters('tier').namingConvention.virtualNetwork]"
                          },
                          "subnets": {
                            "value": "[union(createArray(createObject('name', 'AzureFirewallSubnet', 'properties', createObject('addressPrefix', parameters('firewallClientSubnetAddressPrefix'), 'defaultOutboundAccess', false())), createObject('name', 'AzureFirewallManagementSubnet', 'properties', createObject('addressPrefix', parameters('firewallManagementSubnetAddressPrefix'), 'defaultOutboundAccess', false())), createObject('name', parameters('tier').namingConvention.subnet, 'properties', createObject('addressPrefix', parameters('tier').subnetAddressPrefix, 'defaultOutboundAccess', false(), 'networkSecurityGroup', createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-nsg-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value), 'privateEndpointNetworkPolicies', 'Disabled', 'privateLinkServiceNetworkPolicies', 'Disabled', 'routeTable', createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-rt-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value)))), if(parameters('deployBastion'), createArray(createObject('name', 'AzureBastionSubnet', 'properties', createObject('addressPrefix', parameters('bastionHostSubnetAddressPrefix'), 'defaultOutboundAccess', false(), 'networkSecurityGroup', createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-bastion-nsg-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value)))), createArray()), if(parameters('deployAzureGatewaySubnet'), createArray(createObject('name', 'GatewaySubnet', 'properties', createObject('addressPrefix', parameters('azureGatewaySubnetAddressPrefix'), 'defaultOutboundAccess', false()))), createArray()))]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "vNetDnsServers": {
                            "value": "[parameters('vNetDnsServers')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "7779446728495115235"
                            }
                          },
                          "parameters": {
                            "addressPrefix": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "name": {
                              "type": "string"
                            },
                            "subnets": {
                              "type": "array"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "vNetDnsServers": {
                              "type": "array"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/virtualNetworks",
                              "apiVersion": "2023-11-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/virtualNetworks'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "addressSpace": {
                                  "addressPrefixes": [
                                    "[parameters('addressPrefix')]"
                                  ]
                                },
                                "subnets": "[parameters('subnets')]",
                                "dhcpOptions": "[if(empty(parameters('vNetDnsServers')), null(), createObject('dnsServers', parameters('vNetDnsServers')))]"
                              }
                            }
                          ],
                          "outputs": {
                            "addressPrefix": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name')), '2023-11-01').addressSpace.addressPrefixes[0]]"
                            },
                            "dnsServers": {
                              "type": "array",
                              "value": "[parameters('vNetDnsServers')]"
                            },
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                            },
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            },
                            "subnets": {
                              "type": "array",
                              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name')), '2023-11-01').subnets]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-bastion-nsg-{0}', parameters('deploymentNameSuffix')))]",
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-nsg-{0}', parameters('deploymentNameSuffix')))]",
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-rt-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-hub-fw-client-pip-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "availabilityZones": {
                            "value": "[parameters('firewallClientPublicIPAddressAvailabilityZones')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "name": {
                            "value": "[format('{0}{1}client', parameters('tier').namingConvention.azureFirewallPublicIPAddress, parameters('delimiter'))]"
                          },
                          "publicIpAllocationMethod": {
                            "value": "Static"
                          },
                          "skuName": {
                            "value": "Standard"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "13530632301310136054"
                            }
                          },
                          "parameters": {
                            "availabilityZones": {
                              "type": "array"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "name": {
                              "type": "string"
                            },
                            "publicIpAllocationMethod": {
                              "type": "string"
                            },
                            "skuName": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/publicIPAddresses",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/publicIPAddresses'), createObject()), parameters('mlzTags'))]",
                              "sku": {
                                "name": "[parameters('skuName')]"
                              },
                              "properties": {
                                "publicIPAllocationMethod": "[parameters('publicIpAllocationMethod')]"
                              },
                              "zones": "[parameters('availabilityZones')]"
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('name'))]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-hub-fw-mgmt-pip-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "availabilityZones": {
                            "value": "[parameters('firewallManagementPublicIPAddressAvailabilityZones')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "name": {
                            "value": "[format('{0}{1}management', parameters('tier').namingConvention.azureFirewallPublicIPAddress, parameters('delimiter'))]"
                          },
                          "publicIpAllocationMethod": {
                            "value": "Static"
                          },
                          "skuName": {
                            "value": "Standard"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "13530632301310136054"
                            }
                          },
                          "parameters": {
                            "availabilityZones": {
                              "type": "array"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "name": {
                              "type": "string"
                            },
                            "publicIpAllocationMethod": {
                              "type": "string"
                            },
                            "skuName": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/publicIPAddresses",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/publicIPAddresses'), createObject()), parameters('mlzTags'))]",
                              "sku": {
                                "name": "[parameters('skuName')]"
                              },
                              "properties": {
                                "publicIPAllocationMethod": "[parameters('publicIpAllocationMethod')]"
                              },
                              "zones": "[parameters('availabilityZones')]"
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('name'))]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "copy": {
                        "name": "firewallCustomPublicIPAddresses",
                        "count": "[length(range(1, parameters('firewallCustomPipCount')))]"
                      },
                      "condition": "[greater(parameters('firewallCustomPipCount'), 0)]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-hub-fw-custom-pip-{0}-{1}', range(1, parameters('firewallCustomPipCount'))[copyIndex()], parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "availabilityZones": {
                            "value": "[parameters('firewallClientPublicIPAddressAvailabilityZones')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "name": {
                            "value": "[format('{0}{1}client{2}{3}', parameters('tier').namingConvention.azureFirewallPublicIPAddress, parameters('delimiter'), parameters('delimiter'), range(1, parameters('firewallCustomPipCount'))[copyIndex()])]"
                          },
                          "publicIpAllocationMethod": {
                            "value": "Static"
                          },
                          "skuName": {
                            "value": "Standard"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "13530632301310136054"
                            }
                          },
                          "parameters": {
                            "availabilityZones": {
                              "type": "array"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "name": {
                              "type": "string"
                            },
                            "publicIpAllocationMethod": {
                              "type": "string"
                            },
                            "skuName": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/publicIPAddresses",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/publicIPAddresses'), createObject()), parameters('mlzTags'))]",
                              "sku": {
                                "name": "[parameters('skuName')]"
                              },
                              "properties": {
                                "publicIPAllocationMethod": "[parameters('publicIpAllocationMethod')]"
                              },
                              "zones": "[parameters('availabilityZones')]"
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('name'))]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-hub-fw-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "clientIpConfigurationPublicIPAddressResourceId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-fw-client-pip-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value]"
                          },
                          "clientIpConfigurationSubnetResourceId": {
                            "value": "[format('{0}/subnets/AzureFirewallSubnet', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value)]"
                          },
                          "customPipCount": {
                            "value": "[parameters('firewallCustomPipCount')]"
                          },
                          "customPublicIPAddressNamePrefix": {
                            "value": "[format('{0}{1}client{2}', parameters('tier').namingConvention.azureFirewallPublicIPAddress, parameters('delimiter'), parameters('delimiter'))]"
                          },
                          "dnsServers": {
                            "value": "[parameters('dnsServers')]"
                          },
                          "enableProxy": {
                            "value": "[parameters('enableProxy')]"
                          },
                          "firewallPolicyName": {
                            "value": "[parameters('tier').namingConvention.azureFirewallPolicy]"
                          },
                          "intrusionDetectionMode": {
                            "value": "[parameters('firewallIntrusionDetectionMode')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "managementIpConfigurationPublicIPAddressResourceId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-fw-mgmt-pip-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value]"
                          },
                          "managementIpConfigurationSubnetResourceId": {
                            "value": "[format('{0}/subnets/AzureFirewallManagementSubnet', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value)]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "name": {
                            "value": "[parameters('tier').namingConvention.azureFirewall]"
                          },
                          "resourceGroupName": {
                            "value": "[parameters('resourceGroupName')]"
                          },
                          "skuTier": {
                            "value": "[parameters('firewallSkuTier')]"
                          },
                          "subscriptionId": {
                            "value": "[parameters('subscriptionId')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "threatIntelMode": {
                            "value": "[parameters('firewallThreatIntelMode')]"
                          },
                          "firewallRuleCollectionGroups": {
                            "value": "[parameters('firewallRuleCollectionGroups')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "17055382781645496305"
                            }
                          },
                          "parameters": {
                            "clientIpConfigurationSubnetResourceId": {
                              "type": "string"
                            },
                            "clientIpConfigurationPublicIPAddressResourceId": {
                              "type": "string"
                            },
                            "customPipCount": {
                              "type": "int",
                              "defaultValue": 0
                            },
                            "customPublicIPAddressNamePrefix": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "dnsServers": {
                              "type": "array"
                            },
                            "enableProxy": {
                              "type": "bool"
                            },
                            "firewallPolicyName": {
                              "type": "string"
                            },
                            "intrusionDetectionMode": {
                              "type": "string",
                              "allowedValues": [
                                "Alert",
                                "Deny",
                                "Off"
                              ]
                            },
                            "location": {
                              "type": "string"
                            },
                            "managementIpConfigurationSubnetResourceId": {
                              "type": "string"
                            },
                            "managementIpConfigurationPublicIPAddressResourceId": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "name": {
                              "type": "string"
                            },
                            "resourceGroupName": {
                              "type": "string"
                            },
                            "skuTier": {
                              "type": "string",
                              "allowedValues": [
                                "Premium",
                                "Standard"
                              ]
                            },
                            "subscriptionId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            },
                            "threatIntelMode": {
                              "type": "string",
                              "allowedValues": [
                                "Alert",
                                "Deny",
                                "Off"
                              ]
                            },
                            "firewallRuleCollectionGroups": {
                              "type": "array"
                            }
                          },
                          "variables": {
                            "copy": [
                              {
                                "name": "customIpConfigurations",
                                "count": "[length(range(1, parameters('customPipCount')))]",
                                "input": {
                                  "name": "[format('ipconfig-client-{0}', range(1, parameters('customPipCount'))[copyIndex('customIpConfigurations')])]",
                                  "properties": {
                                    "publicIPAddress": {
                                      "id": "[resourceId(parameters('subscriptionId'), parameters('resourceGroupName'), 'Microsoft.Network/publicIPAddresses', format('{0}{1}', parameters('customPublicIPAddressNamePrefix'), range(1, parameters('customPipCount'))[copyIndex('customIpConfigurations')]))]"
                                    }
                                  }
                                }
                              }
                            ],
                            "intrusionDetectionObject": {
                              "mode": "[parameters('intrusionDetectionMode')]"
                            },
                            "dnsSettings": {
                              "enableProxy": "[parameters('enableProxy')]",
                              "servers": "[parameters('dnsServers')]"
                            },
                            "primaryIpConfiguration": {
                              "name": "ipconfig-client",
                              "properties": {
                                "subnet": {
                                  "id": "[parameters('clientIpConfigurationSubnetResourceId')]"
                                },
                                "publicIPAddress": {
                                  "id": "[parameters('clientIpConfigurationPublicIPAddressResourceId')]"
                                }
                              }
                            },
                            "allIpConfigurations": "[if(greater(parameters('customPipCount'), 0), union(createArray(variables('primaryIpConfiguration')), variables('customIpConfigurations')), createArray(variables('primaryIpConfiguration')))]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/firewallPolicies",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('firewallPolicyName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/firewallPolicies'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "threatIntelMode": "[parameters('threatIntelMode')]",
                                "intrusionDetection": "[if(equals(parameters('skuTier'), 'Premium'), variables('intrusionDetectionObject'), null())]",
                                "sku": {
                                  "tier": "[parameters('skuTier')]"
                                },
                                "dnsSettings": "[variables('dnsSettings')]"
                              },
                              "metadata": {
                                "description": "Azure Firewall Policy"
                              }
                            },
                            {
                              "type": "Microsoft.Network/azureFirewalls",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/azureFirewalls'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "ipConfigurations": "[variables('allIpConfigurations')]",
                                "managementIpConfiguration": {
                                  "name": "ipconfig-management",
                                  "properties": {
                                    "subnet": {
                                      "id": "[parameters('managementIpConfigurationSubnetResourceId')]"
                                    },
                                    "publicIPAddress": {
                                      "id": "[parameters('managementIpConfigurationPublicIPAddressResourceId')]"
                                    }
                                  }
                                },
                                "firewallPolicy": {
                                  "id": "[resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicyName'))]"
                                },
                                "sku": {
                                  "tier": "[parameters('skuTier')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicyName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "defaultRuleCollectionsConfig",
                              "subscriptionId": "[split(resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicyName')), '/')[2]]",
                              "resourceGroup": "[split(resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicyName')), '/')[4]]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "firewallPolicyName": {
                                    "value": "[parameters('firewallPolicyName')]"
                                  },
                                  "firewallRuleCollectionGroups": {
                                    "value": "[parameters('firewallRuleCollectionGroups')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.39.26.7824",
                                      "templateHash": "14485657875320012072"
                                    }
                                  },
                                  "parameters": {
                                    "firewallPolicyName": {
                                      "type": "string"
                                    },
                                    "firewallRuleCollectionGroups": {
                                      "type": "array"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "copy": {
                                        "name": "ruleCreate",
                                        "count": "[length(parameters('firewallRuleCollectionGroups'))]",
                                        "mode": "serial",
                                        "batchSize": 1
                                      },
                                      "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
                                      "apiVersion": "2024-03-01",
                                      "name": "[format('{0}/{1}', parameters('firewallPolicyName'), parameters('firewallRuleCollectionGroups')[copyIndex()].name)]",
                                      "properties": "[parameters('firewallRuleCollectionGroups')[copyIndex()].properties]"
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/azureFirewalls', parameters('name'))]",
                                "[resourceId('Microsoft.Network/firewallPolicies', parameters('firewallPolicyName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            },
                            "privateIPAddress": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Network/azureFirewalls', parameters('name')), '2021-02-01').ipConfigurations[0].properties.privateIPAddress]"
                            },
                            "resourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/azureFirewalls', parameters('name'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-fw-client-pip-{0}', parameters('deploymentNameSuffix')))]",
                        "firewallCustomPublicIPAddresses",
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-fw-mgmt-pip-{0}', parameters('deploymentNameSuffix')))]",
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "bastionHostSubnetResourceId": {
                      "type": "string",
                      "value": "[if(parameters('deployBastion'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value[3].id, '')]"
                    },
                    "dnsServers": {
                      "type": "array",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.dnsServers.value]"
                    },
                    "firewallName": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-fw-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]"
                    },
                    "firewallPrivateIPAddress": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-fw-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateIPAddress.value]"
                    },
                    "firewallResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-fw-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                    },
                    "networkSecurityGroupName": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-nsg-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]"
                    },
                    "networkSecurityGroupResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-nsg-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value]"
                    },
                    "subnetAddressPrefix": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value[2].properties.addressPrefix]"
                    },
                    "subnetName": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value[2].name]"
                    },
                    "subnetResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value[2].id]"
                    },
                    "virtualNetworkName": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.name.value]"
                    },
                    "virtualNetworkResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-vnet-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "copy": {
                "name": "spokeNetworks",
                "count": "[length(variables('spokes'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-vnet-{0}-{1}', variables('spokes')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                  },
                  "resourceGroupName": {
                    "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value, lambda('name', contains(lambdaVariables('name'), variables('spokes')[copyIndex()].name)))[0]]"
                  },
                  "routeTableRouteNextHopIpAddress": {
                    "value": "[parameters('firewallSettings').clientPrivateIpAddress]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "tier": {
                    "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value, lambda('tier', equals(lambdaVariables('tier').name, variables('spokes')[copyIndex()].name)))[0]]"
                  },
                  "vNetDnsServers": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.dnsServers.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "9796412293041317065"
                    }
                  },
                  "parameters": {
                    "additionalSubnets": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "customSubnetName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "resourceGroupName": {
                      "type": "string"
                    },
                    "routeTableRouteNextHopIpAddress": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "tier": {
                      "type": "object"
                    },
                    "vNetDnsServers": {
                      "type": "array"
                    }
                  },
                  "variables": {
                    "delegations": {
                      "azure-netapp-files": [
                        {
                          "name": "Microsoft.Netapp.volumes",
                          "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/delegations', variables('virtualNetworkName'), 'azure-netapp-files', 'delegation')]",
                          "properties": {
                            "serviceName": "Microsoft.Netapp/volumes"
                          },
                          "type": "Microsoft.Network/virtualNetworks/subnets/delegations"
                        }
                      ],
                      "function-app-outbound": [
                        {
                          "name": "Microsoft.Web/sites",
                          "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/delegations', variables('virtualNetworkName'), 'function-app-outbound', 'delegation')]",
                          "properties": {
                            "serviceName": "Microsoft.Web/serverfarms"
                          },
                          "type": "Microsoft.Network/virtualNetworks/subnets/delegations"
                        }
                      ]
                    },
                    "subnets": "[union(createArray(createObject('name', if(empty(parameters('customSubnetName')), parameters('tier').namingConvention.subnet, parameters('customSubnetName')), 'properties', createObject('addressPrefix', parameters('tier').subnetAddressPrefix))), parameters('additionalSubnets'))]",
                    "subscriptionId": "[parameters('tier').subscriptionId]",
                    "virtualNetworkName": "[parameters('tier').namingConvention.virtualNetwork]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "networkSecurityGroup",
                      "subscriptionId": "[variables('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "name": {
                            "value": "[parameters('tier').namingConvention.networkSecurityGroup]"
                          },
                          "securityRules": {
                            "value": "[parameters('tier').nsgRules]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "16438028713840255561"
                            }
                          },
                          "parameters": {
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "name": {
                              "type": "string"
                            },
                            "securityRules": {
                              "type": "array"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/networkSecurityGroups",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkSecurityGroups'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "securityRules": "[parameters('securityRules')]"
                              }
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                            },
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "routeTable",
                      "subscriptionId": "[variables('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "disableBgpRoutePropagation": {
                            "value": true
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "name": {
                            "value": "[parameters('tier').namingConvention.routeTable]"
                          },
                          "routeNextHopIpAddress": {
                            "value": "[parameters('routeTableRouteNextHopIpAddress')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "14716415322656266319"
                            }
                          },
                          "parameters": {
                            "disableBgpRoutePropagation": {
                              "type": "bool"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "name": {
                              "type": "string"
                            },
                            "routeAddressPrefix": {
                              "type": "string",
                              "defaultValue": "0.0.0.0/0"
                            },
                            "routeName": {
                              "type": "string",
                              "defaultValue": "default_route"
                            },
                            "routeNextHopIpAddress": {
                              "type": "string"
                            },
                            "routeNextHopType": {
                              "type": "string",
                              "defaultValue": "VirtualAppliance"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/routeTables",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/routeTables'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "disableBgpRoutePropagation": "[parameters('disableBgpRoutePropagation')]",
                                "routes": [
                                  {
                                    "name": "[parameters('routeName')]",
                                    "properties": {
                                      "addressPrefix": "[parameters('routeAddressPrefix')]",
                                      "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]",
                                      "nextHopType": "[parameters('routeNextHopType')]"
                                    }
                                  }
                                ]
                              }
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/routeTables', parameters('name'))]"
                            },
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "virtualNetwork",
                      "subscriptionId": "[variables('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "addressPrefix": {
                            "value": "[parameters('tier').vnetAddressPrefix]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "name": {
                            "value": "[variables('virtualNetworkName')]"
                          },
                          "subnets": {
                            "copy": [
                              {
                                "name": "value",
                                "count": "[length(variables('subnets'))]",
                                "input": "[createObject('name', variables('subnets')[copyIndex('value')].name, 'properties', createObject('addressPrefix', variables('subnets')[copyIndex('value')].properties.addressPrefix, 'defaultOutboundAccess', false(), 'delegations', coalesce(tryGet(variables('delegations'), variables('subnets')[copyIndex('value')].name), createArray()), 'networkSecurityGroup', createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'networkSecurityGroup'), '2025-04-01').outputs.id.value), 'routeTable', createObject('id', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'routeTable'), '2025-04-01').outputs.id.value), 'privateEndpointNetworkPolicies', 'Disabled', 'privateLinkServiceNetworkPolicies', 'Disabled'))]"
                              }
                            ]
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "vNetDnsServers": {
                            "value": "[parameters('vNetDnsServers')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "7779446728495115235"
                            }
                          },
                          "parameters": {
                            "addressPrefix": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "name": {
                              "type": "string"
                            },
                            "subnets": {
                              "type": "array"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "vNetDnsServers": {
                              "type": "array"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/virtualNetworks",
                              "apiVersion": "2023-11-01",
                              "name": "[parameters('name')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/virtualNetworks'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "addressSpace": {
                                  "addressPrefixes": [
                                    "[parameters('addressPrefix')]"
                                  ]
                                },
                                "subnets": "[parameters('subnets')]",
                                "dhcpOptions": "[if(empty(parameters('vNetDnsServers')), null(), createObject('dnsServers', parameters('vNetDnsServers')))]"
                              }
                            }
                          ],
                          "outputs": {
                            "addressPrefix": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name')), '2023-11-01').addressSpace.addressPrefixes[0]]"
                            },
                            "dnsServers": {
                              "type": "array",
                              "value": "[parameters('vNetDnsServers')]"
                            },
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                            },
                            "name": {
                              "type": "string",
                              "value": "[parameters('name')]"
                            },
                            "subnets": {
                              "type": "array",
                              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name')), '2023-11-01').subnets]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'networkSecurityGroup')]",
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'routeTable')]"
                      ]
                    }
                  ],
                  "outputs": {
                    "networkSecurityGroupName": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'networkSecurityGroup'), '2025-04-01').outputs.name.value]"
                    },
                    "networkSecurityGroupResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'networkSecurityGroup'), '2025-04-01').outputs.id.value]"
                    },
                    "subnets": {
                      "type": "array",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.subnets.value]"
                    },
                    "virtualNetworkAddressPrefix": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.addressPrefix.value]"
                    },
                    "virtualNetworkName": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.name.value]"
                    },
                    "virtualNetworkResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'virtualNetwork'), '2025-04-01').outputs.id.value]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "copy": {
                "name": "hubVirtualNetworkPeerings",
                "count": "[length(variables('spokes'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-vnet-peerings-hub-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "hubVirtualNetworkName": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkName.value]"
                  },
                  "resourceGroupName": {
                    "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value, lambda('name', contains(lambdaVariables('name'), 'hub')))[0]]"
                  },
                  "spokeShortName": {
                    "value": "[variables('spokes')[copyIndex()].shortName]"
                  },
                  "spokeVirtualNetworkResourceId": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[copyIndex()].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkResourceId.value]"
                  },
                  "subscriptionId": {
                    "value": "[variables('hubSubscriptionId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "9428153684607913388"
                    }
                  },
                  "parameters": {
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "hubVirtualNetworkName": {
                      "type": "string"
                    },
                    "resourceGroupName": {
                      "type": "string"
                    },
                    "spokeShortName": {
                      "type": "string"
                    },
                    "spokeVirtualNetworkResourceId": {
                      "type": "string"
                    },
                    "subscriptionId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('peer-hub-to-{0}-{1}', parameters('spokeShortName'), parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "remoteVirtualNetworkResourceId": {
                            "value": "[parameters('spokeVirtualNetworkResourceId')]"
                          },
                          "virtualNetworkName": {
                            "value": "[parameters('hubVirtualNetworkName')]"
                          },
                          "virtualNetworkPeerName": {
                            "value": "[format('to-{0}', split(parameters('spokeVirtualNetworkResourceId'), '/')[8])]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "7340460699741442449"
                            }
                          },
                          "parameters": {
                            "remoteVirtualNetworkResourceId": {
                              "type": "string"
                            },
                            "virtualNetworkName": {
                              "type": "string"
                            },
                            "virtualNetworkPeerName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                              "apiVersion": "2021-02-01",
                              "name": "[format('{0}/{1}', parameters('virtualNetworkName'), parameters('virtualNetworkPeerName'))]",
                              "properties": {
                                "allowForwardedTraffic": true,
                                "remoteVirtualNetwork": {
                                  "id": "[parameters('remoteVirtualNetworkResourceId')]"
                                }
                              }
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[copyIndex()].name, parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "copy": {
                "name": "spokeVirtualNetworkPeerings",
                "count": "[length(variables('spokes'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-vnet-peerings-{0}-{1}', variables('spokes')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "hubVirtualNetworkResourceId": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkResourceId.value]"
                  },
                  "resourceGroupName": {
                    "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value, lambda('name', contains(lambdaVariables('name'), variables('spokes')[copyIndex()].name)))[0]]"
                  },
                  "spokeShortName": {
                    "value": "[variables('spokes')[copyIndex()].shortName]"
                  },
                  "spokeVirtualNetworkName": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[copyIndex()].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkName.value]"
                  },
                  "subscriptionId": {
                    "value": "[variables('spokes')[copyIndex()].subscriptionId]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "8666736007470883905"
                    }
                  },
                  "parameters": {
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "hubVirtualNetworkResourceId": {
                      "type": "string"
                    },
                    "resourceGroupName": {
                      "type": "string"
                    },
                    "spokeShortName": {
                      "type": "string"
                    },
                    "spokeVirtualNetworkName": {
                      "type": "string"
                    },
                    "subscriptionId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('peer-{0}-to-hub-{1}', parameters('spokeShortName'), parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "remoteVirtualNetworkResourceId": {
                            "value": "[parameters('hubVirtualNetworkResourceId')]"
                          },
                          "virtualNetworkName": {
                            "value": "[parameters('spokeVirtualNetworkName')]"
                          },
                          "virtualNetworkPeerName": {
                            "value": "[format('to-{0}', split(parameters('hubVirtualNetworkResourceId'), '/')[8])]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "7340460699741442449"
                            }
                          },
                          "parameters": {
                            "remoteVirtualNetworkResourceId": {
                              "type": "string"
                            },
                            "virtualNetworkName": {
                              "type": "string"
                            },
                            "virtualNetworkPeerName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                              "apiVersion": "2021-02-01",
                              "name": "[format('{0}/{1}', parameters('virtualNetworkName'), parameters('virtualNetworkPeerName'))]",
                              "properties": {
                                "allowForwardedTraffic": true,
                                "remoteVirtualNetwork": {
                                  "id": "[parameters('remoteVirtualNetworkResourceId')]"
                                }
                              }
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[copyIndex()].name, parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "deployIdentity": {
                    "value": "[parameters('deployIdentity')]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "hubVirtualNetworkResourceId": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkResourceId.value]"
                  },
                  "identityVirtualNetworkResourceId": "[if(parameters('deployIdentity'), createObject('value', reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[2].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkResourceId.value), createObject('value', ''))]",
                  "mlzTags": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
                  },
                  "privateDnsZoneNames": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZones.value]"
                  },
                  "resourceGroupName": {
                    "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value, lambda('name', contains(lambdaVariables('name'), 'hub')))[0]]"
                  },
                  "subscriptionId": {
                    "value": "[variables('hubSubscriptionId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "14271839911480751148"
                    }
                  },
                  "parameters": {
                    "deployIdentity": {
                      "type": "bool"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "hubVirtualNetworkResourceId": {
                      "type": "string"
                    },
                    "identityVirtualNetworkResourceId": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "privateDnsZoneNames": {
                      "type": "array"
                    },
                    "resourceGroupName": {
                      "type": "string"
                    },
                    "subscriptionId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "variables": {
                    "virtualNetworks": "[union(createArray(createObject('name', split(parameters('hubVirtualNetworkResourceId'), '/')[8], 'resourceGroupName', split(parameters('hubVirtualNetworkResourceId'), '/')[4], 'subscriptionId', split(parameters('hubVirtualNetworkResourceId'), '/')[2])), if(parameters('deployIdentity'), createArray(createObject('name', split(parameters('identityVirtualNetworkResourceId'), '/')[8], 'resourceGroupName', split(parameters('identityVirtualNetworkResourceId'), '/')[4], 'subscriptionId', split(parameters('identityVirtualNetworkResourceId'), '/')[2])), createArray()))]"
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "privateDnsZones",
                        "count": "[length(parameters('privateDnsZoneNames'))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-pvt-dns-zone-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "name": {
                            "value": "[parameters('privateDnsZoneNames')[copyIndex()]]"
                          },
                          "tags": {
                            "value": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateDnsZones'), createObject()), parameters('mlzTags'))]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "911822815390272948"
                            }
                          },
                          "parameters": {
                            "name": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateDnsZones",
                              "apiVersion": "2018-09-01",
                              "name": "[parameters('name')]",
                              "location": "global",
                              "tags": "[parameters('tags')]"
                            }
                          ],
                          "outputs": {
                            "resourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('name'))]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "copy": {
                        "name": "virtualNetworkLinks",
                        "count": "[length(variables('virtualNetworks'))]",
                        "mode": "serial",
                        "batchSize": 1
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-vnet-links-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('subscriptionId')]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "privateDnsZoneNames": {
                            "value": "[parameters('privateDnsZoneNames')]"
                          },
                          "virtualNetworkName": {
                            "value": "[variables('virtualNetworks')[copyIndex()].name]"
                          },
                          "virtualNetworkResourceGroupName": {
                            "value": "[variables('virtualNetworks')[copyIndex()].resourceGroupName]"
                          },
                          "virtualNetworkSubscriptionId": {
                            "value": "[variables('virtualNetworks')[copyIndex()].subscriptionId]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "12447109862893665382"
                            }
                          },
                          "parameters": {
                            "privateDnsZoneNames": {
                              "type": "array"
                            },
                            "virtualNetworkName": {
                              "type": "string"
                            },
                            "virtualNetworkResourceGroupName": {
                              "type": "string"
                            },
                            "virtualNetworkSubscriptionId": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "copy": {
                                "name": "virtualNetworkLinks",
                                "count": "[length(parameters('privateDnsZoneNames'))]"
                              },
                              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                              "apiVersion": "2018-09-01",
                              "name": "[format('{0}/{1}', parameters('privateDnsZoneNames')[copyIndex()], parameters('virtualNetworkName'))]",
                              "location": "global",
                              "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                  "id": "[resourceId(parameters('virtualNetworkSubscriptionId'), parameters('virtualNetworkResourceGroupName'), 'Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]"
                                }
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "privateDnsZones"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateDnsZoneResourceIds": {
                      "type": "array",
                      "copy": {
                        "count": "[length(parameters('privateDnsZoneNames'))]",
                        "input": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('subscriptionId'), parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-pvt-dns-zone-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                      }
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix')))]",
                "spokeNetworks"
              ]
            }
          ],
          "outputs": {
            "azureFirewallResourceId": {
              "type": "string",
              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.firewallResourceId.value]"
            },
            "bastionHostSubnetResourceId": {
              "type": "string",
              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.bastionHostSubnetResourceId.value]"
            },
            "delimiter": {
              "type": "string",
              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
            },
            "hubVirtualNetworkResourceId": {
              "type": "string",
              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualNetworkResourceId.value]"
            },
            "locationProperties": {
              "type": "object",
              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.locationProperties.value]"
            },
            "mlzTags": {
              "type": "object",
              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
            },
            "privateDnsZoneResourceIds": {
              "type": "object",
              "value": {
                "agentSvc": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'privatelink.agentsvc')))[0]]",
                "blob": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'blob')))[0]]",
                "file": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'file')))[0]]",
                "keyVault": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'vaultcore')))[0]]",
                "monitor": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'monitor')))[0]]",
                "ods": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'ods.opinsights')))[0]]",
                "oms": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'oms.opinsights')))[0]]",
                "queue": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'queue')))[0]]",
                "table": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-private-dns-zones-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value, lambda('id', contains(lambdaVariables('id'), 'table')))[0]]"
              }
            },
            "resourceAbbreviations": {
              "type": "object",
              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceAbbreviations.value]"
            },
            "sharedServicesSubnetResourceId": {
              "type": "string",
              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[1].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkSecurityGroupResourceId.value]"
            },
            "tiers": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('networks'))]",
                "input": {
                  "name": "[parameters('networks')[copyIndex()].name]",
                  "namingConvention": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('get-logic-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value[copyIndex()].namingConvention]",
                  "networkSecurityGroupResourceId": "[union(createArray(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkSecurityGroupResourceId.value, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[0].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkSecurityGroupResourceId.value, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[1].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkSecurityGroupResourceId.value), if(parameters('deployIdentity'), createArray(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[2].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkSecurityGroupResourceId.value), createArray()))[copyIndex()]]",
                  "nsgDiagLogs": "[parameters('networks')[copyIndex()].nsgDiagLogs]",
                  "resourceGroupName": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-resource-groups-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.names.value, lambda('name', contains(lambdaVariables('name'), parameters('networks')[copyIndex()].name)))[0]]",
                  "shortName": "[parameters('networks')[copyIndex()].shortName]",
                  "subnetResourceId": "[union(createArray(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-hub-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnetResourceId.value, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[0].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value[0].id, reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[1].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value[0].id), if(parameters('deployIdentity'), createArray(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-vnet-{0}-{1}', variables('spokes')[2].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.subnets.value[0].id), createArray()))[copyIndex()]]",
                  "subscriptionId": "[parameters('networks')[copyIndex()].subscriptionId]",
                  "vnetDiagLogs": "[parameters('networks')[copyIndex()].vnetDiagLogs]",
                  "vnetDiagMetrics": "[parameters('networks')[copyIndex()].vnetDiagMetrics]"
                }
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deploymentNameSuffix": {
            "value": "[parameters('deploymentNameSuffix')]"
          },
          "deploySentinel": {
            "value": "[parameters('deploySentinel')]"
          },
          "enableAzureActivityConnector": {
            "value": "[parameters('enableAzureActivityDataConnector')]"
          },
          "azureActivityDiagnosticSettingName": {
            "value": "[parameters('azureActivityDiagnosticSettingName')]"
          },
          "azureActivityLogCategories": {
            "value": "[parameters('azureActivityLogCategories')]"
          },
          "azureActivityRetentionPolicy": {
            "value": "[parameters('azureActivityDiagnosticRetentionPolicy')]"
          },
          "enableEntraConnector": {
            "value": "[parameters('enableEntraIdDataConnector')]"
          },
          "enableEntityBehavior": {
            "value": "[parameters('enableEntityBehavior')]"
          },
          "deployEntityBehaviorSetting": {
            "value": "[parameters('deployEntityBehaviorSetting')]"
          },
          "useEntityBehaviorScript": {
            "value": "[parameters('useEntityBehaviorScript')]"
          },
          "enableUeba": {
            "value": "[parameters('enableUeba')]"
          },
          "deployUebaSetting": {
            "value": "[parameters('deployUebaSetting')]"
          },
          "uebaDataSources": {
            "value": "[parameters('uebaDataSources')]"
          },
          "enableAnomalies": {
            "value": "[parameters('enableAnomalies')]"
          },
          "deploySentinelAutomationScript": {
            "value": "[parameters('deploySentinelAutomationScript')]"
          },
          "entraConnectorDataTypeStates": {
            "value": "[parameters('entraDataConnectorLogStates')]"
          },
          "sentinelAutomationPrincipalId": {
            "value": "[parameters('sentinelAutomationPrincipalId')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceCappingDailyQuotaGb": {
            "value": "[parameters('logAnalyticsWorkspaceCappingDailyQuotaGb')]"
          },
          "logAnalyticsWorkspaceRetentionInDays": {
            "value": "[parameters('logAnalyticsWorkspaceRetentionInDays')]"
          },
          "logAnalyticsWorkspaceSkuName": {
            "value": "[parameters('logAnalyticsWorkspaceSkuName')]"
          },
          "privateDnsZoneResourceIds": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value]"
          },
          "mlzTags": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
          },
          "identifier": {
            "value": "[parameters('identifier')]"
          },
          "environmentAbbreviation": {
            "value": "[parameters('environmentAbbreviation')]"
          },
          "locationAbbreviation": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.locationProperties.value.abbreviation]"
          },
          "delimiter": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
          },
          "resourceAbbreviations": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceAbbreviations.value]"
          },
          "tenantId": {
            "value": "[variables('deploymentTenantId')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "tier": {
            "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value, lambda('tier', equals(lambdaVariables('tier').name, 'operations')))[0]]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "2201615181212128210"
            }
          },
          "parameters": {
            "deploymentNameSuffix": {
              "type": "string"
            },
            "deploySentinel": {
              "type": "bool"
            },
            "identifier": {
              "type": "string"
            },
            "environmentAbbreviation": {
              "type": "string"
            },
            "locationAbbreviation": {
              "type": "string"
            },
            "delimiter": {
              "type": "string"
            },
            "resourceAbbreviations": {
              "type": "object"
            },
            "enableAzureActivityConnector": {
              "type": "bool"
            },
            "azureActivityDiagnosticSettingName": {
              "type": "string"
            },
            "azureActivityLogCategories": {
              "type": "array"
            },
            "azureActivityRetentionPolicy": {
              "type": "object"
            },
            "enableEntraConnector": {
              "type": "bool"
            },
            "enableEntityBehavior": {
              "type": "bool"
            },
            "deployEntityBehaviorSetting": {
              "type": "bool"
            },
            "useEntityBehaviorScript": {
              "type": "bool",
              "defaultValue": true
            },
            "enableUeba": {
              "type": "bool"
            },
            "deployUebaSetting": {
              "type": "bool",
              "defaultValue": true
            },
            "uebaDataSources": {
              "type": "array"
            },
            "enableAnomalies": {
              "type": "bool"
            },
            "deploySentinelAutomationScript": {
              "type": "bool",
              "defaultValue": true
            },
            "entraConnectorDataTypeStates": {
              "type": "object"
            },
            "tenantId": {
              "type": "string"
            },
            "sentinelAutomationPrincipalId": {
              "type": "string",
              "defaultValue": ""
            },
            "location": {
              "type": "string"
            },
            "logAnalyticsWorkspaceCappingDailyQuotaGb": {
              "type": "int"
            },
            "logAnalyticsWorkspaceRetentionInDays": {
              "type": "int"
            },
            "logAnalyticsWorkspaceSkuName": {
              "type": "string"
            },
            "mlzTags": {
              "type": "object"
            },
            "privateDnsZoneResourceIds": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            },
            "tier": {
              "type": "object"
            }
          },
          "variables": {
            "resourceToken": "resource_token",
            "securityNamingConvention": "[format('{0}{1}{2}{1}{3}{1}security{1}{4}', toLower(parameters('identifier')), parameters('delimiter'), parameters('environmentAbbreviation'), parameters('locationAbbreviation'), variables('resourceToken'))]",
            "securityResourceGroupName": "[replace(variables('securityNamingConvention'), variables('resourceToken'), parameters('resourceAbbreviations').resourceGroups)]",
            "securityLogAnalyticsWorkspaceName": "[replace(variables('securityNamingConvention'), variables('resourceToken'), parameters('resourceAbbreviations').logAnalyticsWorkspaces)]",
            "monitoringResourceGroupName": "[if(parameters('deploySentinel'), variables('securityResourceGroupName'), parameters('tier').resourceGroupName)]",
            "logAnalyticsWorkspaceName": "[if(parameters('deploySentinel'), variables('securityLogAnalyticsWorkspaceName'), parameters('tier').namingConvention.logAnalyticsWorkspace)]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('ensure-monitoring-rg-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tier').subscriptionId]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "mlzTags": {
                    "value": "[parameters('mlzTags')]"
                  },
                  "name": {
                    "value": "[variables('monitoringResourceGroupName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "11280921715033613511"
                    }
                  },
                  "parameters": {
                    "mlzTags": {
                      "type": "object"
                    },
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/resourceGroups",
                      "apiVersion": "2019-05-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Resources/resourceGroups'), createObject()), parameters('mlzTags'))]"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-law-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tier').subscriptionId]",
              "resourceGroup": "[variables('monitoringResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "deploySentinel": {
                    "value": "[parameters('deploySentinel')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[parameters('mlzTags')]"
                  },
                  "name": {
                    "value": "[variables('logAnalyticsWorkspaceName')]"
                  },
                  "retentionInDays": {
                    "value": "[parameters('logAnalyticsWorkspaceRetentionInDays')]"
                  },
                  "skuName": {
                    "value": "[parameters('logAnalyticsWorkspaceSkuName')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "workspaceCappingDailyQuotaGb": {
                    "value": "[parameters('logAnalyticsWorkspaceCappingDailyQuotaGb')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "17606964580718569021"
                    }
                  },
                  "parameters": {
                    "deploySentinel": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "name": {
                      "type": "string"
                    },
                    "retentionInDays": {
                      "type": "int",
                      "defaultValue": 30
                    },
                    "skuName": {
                      "type": "string",
                      "defaultValue": "PerGB2018"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "workspaceCappingDailyQuotaGb": {
                      "type": "int",
                      "defaultValue": -1
                    }
                  },
                  "variables": {
                    "solutions": [
                      {
                        "deploy": true,
                        "name": "AzureActivity",
                        "product": "OMSGallery/AzureActivity",
                        "publisher": "Microsoft",
                        "promotionCode": ""
                      },
                      {
                        "deploy": "[parameters('deploySentinel')]",
                        "name": "SecurityInsights",
                        "product": "OMSGallery/SecurityInsights",
                        "publisher": "Microsoft",
                        "promotionCode": ""
                      },
                      {
                        "deploy": true,
                        "name": "VMInsights",
                        "product": "OMSGallery/VMInsights",
                        "publisher": "Microsoft",
                        "promotionCode": ""
                      },
                      {
                        "deploy": true,
                        "name": "Security",
                        "product": "OMSGallery/Security",
                        "publisher": "Microsoft",
                        "promotionCode": ""
                      },
                      {
                        "deploy": true,
                        "name": "ServiceMap",
                        "publisher": "Microsoft",
                        "product": "OMSGallery/ServiceMap",
                        "promotionCode": ""
                      },
                      {
                        "deploy": true,
                        "name": "ContainerInsights",
                        "publisher": "Microsoft",
                        "product": "OMSGallery/ContainerInsights",
                        "promotionCode": ""
                      },
                      {
                        "deploy": true,
                        "name": "KeyVaultAnalytics",
                        "publisher": "Microsoft",
                        "product": "OMSGallery/KeyVaultAnalytics",
                        "promotionCode": ""
                      }
                    ]
                  },
                  "resources": [
                    {
                      "type": "Microsoft.OperationalInsights/workspaces",
                      "apiVersion": "2021-06-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.OperationalInsights/workspaces'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "retentionInDays": "[if(and(parameters('deploySentinel'), less(parameters('retentionInDays'), 90)), 90, parameters('retentionInDays'))]",
                        "sku": {
                          "name": "[parameters('skuName')]"
                        },
                        "workspaceCapping": {
                          "dailyQuotaGb": "[parameters('workspaceCappingDailyQuotaGb')]"
                        },
                        "publicNetworkAccessForIngestion": "Enabled",
                        "publicNetworkAccessForQuery": "Enabled"
                      }
                    },
                    {
                      "copy": {
                        "name": "logAnalyticsSolutions",
                        "count": "[length(variables('solutions'))]"
                      },
                      "condition": "[variables('solutions')[copyIndex()].deploy]",
                      "type": "Microsoft.OperationsManagement/solutions",
                      "apiVersion": "2015-11-01-preview",
                      "name": "[format('{0}({1})', variables('solutions')[copyIndex()].name, parameters('name'))]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.OperationsManagement/solutions'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
                      },
                      "plan": {
                        "name": "[format('{0}({1})', variables('solutions')[copyIndex()].name, parameters('name'))]",
                        "product": "[variables('solutions')[copyIndex()].product]",
                        "publisher": "[variables('solutions')[copyIndex()].publisher]",
                        "promotionCode": "[variables('solutions')[copyIndex()].promotionCode]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
                      ]
                    },
                    {
                      "condition": "[parameters('deploySentinel')]",
                      "type": "Microsoft.SecurityInsights/onboardingStates",
                      "apiVersion": "2024-03-01",
                      "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', parameters('name'))]",
                      "name": "default",
                      "properties": {},
                      "dependsOn": [
                        "logAnalyticsSolutions",
                        "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "resourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
                    }
                  }
                }
              }
              ,
              "dependsOn": [
                "[subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('ensure-monitoring-rg-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-private-link-scope-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tier').subscriptionId]",
              "resourceGroup": "[variables('monitoringResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('monitoringResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-law-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                  },
                  "name": {
                    "value": "[parameters('tier').namingConvention.privateLinkScope]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "4775757579534857555"
                    }
                  },
                  "parameters": {
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Insights/privateLinkScopes",
                      "apiVersion": "2021-09-01",
                      "name": "[parameters('name')]",
                      "location": "global",
                      "properties": {
                        "accessModeSettings": {
                          "ingestionAccessMode": "PrivateOnly",
                          "queryAccessMode": "PrivateOnly"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Insights/privateLinkScopes/scopedResources",
                      "apiVersion": "2021-09-01",
                      "name": "[format('{0}/{1}', parameters('name'), split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])]",
                      "properties": {
                        "linkedResourceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Insights/privateLinkScopes', parameters('name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "resourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Insights/privateLinkScopes', parameters('name'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('monitoringResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-law-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-private-endpoint-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tier').subscriptionId]",
              "resourceGroup": "[variables('monitoringResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "groupIds": {
                    "value": [
                      "azuremonitor"
                    ]
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[parameters('mlzTags')]"
                  },
                  "name": {
                    "value": "[parameters('tier').namingConvention.privateLinkScopePrivateEndpoint]"
                  },
                  "networkInterfaceName": {
                    "value": "[parameters('tier').namingConvention.privateLinkScopeNetworkInterface]"
                  },
                  "privateDnsZoneConfigs": {
                    "value": [
                      {
                        "name": "monitor",
                        "properties": {
                          "privateDnsZoneId": "[parameters('privateDnsZoneResourceIds').monitor]"
                        }
                      },
                      {
                        "name": "oms",
                        "properties": {
                          "privateDnsZoneId": "[parameters('privateDnsZoneResourceIds').oms]"
                        }
                      },
                      {
                        "name": "ods",
                        "properties": {
                          "privateDnsZoneId": "[parameters('privateDnsZoneResourceIds').ods]"
                        }
                      },
                      {
                        "name": "agentsvc",
                        "properties": {
                          "privateDnsZoneId": "[parameters('privateDnsZoneResourceIds').agentsvc]"
                        }
                      },
                      {
                        "name": "blob",
                        "properties": {
                          "privateDnsZoneId": "[parameters('privateDnsZoneResourceIds').blob]"
                        }
                      }
                    ]
                  },
                  "privateLinkServiceId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('monitoringResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-private-link-scope-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                  },
                  "subnetResourceId": {
                    "value": "[parameters('tier').subnetResourceId]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "16334870466525331331"
                    }
                  },
                  "parameters": {
                    "groupIds": {
                      "type": "array"
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "name": {
                      "type": "string"
                    },
                    "networkInterfaceName": {
                      "type": "string"
                    },
                    "privateDnsZoneConfigs": {
                      "type": "array"
                    },
                    "privateLinkServiceId": {
                      "type": "string"
                    },
                    "subnetResourceId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-04-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "customNetworkInterfaceName": "[parameters('networkInterfaceName')]",
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('name')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('privateLinkServiceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ],
                        "subnet": {
                          "id": "[parameters('subnetResourceId')]"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2023-04-01",
                      "name": "[format('{0}/{1}', parameters('name'), parameters('name'))]",
                      "properties": {
                        "privateDnsZoneConfigs": "[parameters('privateDnsZoneConfigs')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "networkInterfaceResourceId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', parameters('name')), '2023-04-01').networkInterfaces[0].id]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('monitoringResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-private-link-scope-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "condition": "[parameters('deploySentinel')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('configure-sentinel-settings-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tier').subscriptionId]",
              "resourceGroup": "[variables('monitoringResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "workspaceName": {
                    "value": "[variables('logAnalyticsWorkspaceName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "enableEntityBehavior": {
                    "value": "[parameters('enableEntityBehavior')]"
                  },
                  "deployEntityBehaviorSetting": {
                    "value": "[parameters('deployEntityBehaviorSetting')]"
                  },
                  "useEntityBehaviorScript": {
                    "value": "[parameters('useEntityBehaviorScript')]"
                  },
                  "enableUeba": {
                    "value": "[parameters('enableUeba')]"
                  },
                  "deployUebaSetting": {
                    "value": "[parameters('deployUebaSetting')]"
                  },
                  "uebaDataSources": {
                    "value": "[parameters('uebaDataSources')]"
                  },
                  "enableAnomalies": {
                    "value": "[parameters('enableAnomalies')]"
                  },
                  "deploySentinelAutomationScript": {
                    "value": "[parameters('deploySentinelAutomationScript')]"
                  },
                  "sentinelAutomationPrincipalId": {
                    "value": "[parameters('sentinelAutomationPrincipalId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "14101792930626334175"
                    }
                  },
                  "parameters": {
                    "workspaceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Log Analytics workspace where Microsoft Sentinel is enabled."
                      }
                    },
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure region used for ancillary operations such as deployment scripts."
                      }
                    },
                    "enableEntityBehavior": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Toggle to configure the Entity Behavior Analytics setting."
                      }
                    },
                    "deployEntityBehaviorSetting": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Skip provisioning the Entity Behavior Analytics setting when it already exists to avoid concurrency conflicts."
                      }
                    },
                    "useEntityBehaviorScript": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Use the deployment script (recommended when the setting already exists) to upsert Entity Behavior. Disable for brand new workspaces to provision the resource directly."
                      }
                    },
                    "enableUeba": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Toggle to configure UEBA data sources and ensure they participate in the ML fusion models."
                      }
                    },
                    "deployUebaSetting": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Skip provisioning the UEBA setting when it already exists to avoid concurrency conflicts."
                      }
                    },
                    "uebaDataSources": {
                      "type": "array",
                      "defaultValue": [
                        "SigninLogs",
                        "AuditLogs",
                        "AzureActivity"
                      ],
                      "metadata": {
                        "description": "Data sources that enrich UEBA insights."
                      }
                    },
                    "enableAnomalies": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Toggle to ensure Microsoft Sentinel anomaly detection remains enabled."
                      }
                    },
                    "sentinelAutomationPrincipalId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "Optional override for the Azure Security Insights service principal object ID if discovery via Microsoft Graph is restricted."
                      }
                    },
                    "deploySentinelAutomationScript": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Toggle to run the deployment script that discovers and assigns the Sentinel automation service principal. Disable when you plan to handle the automation role manually later."
                      }
                    }
                  },
                  "variables": {
                    "sentinelAutomationContributorRoleDefinitionGuid": "f4c81013-99ee-4d62-a7ee-b3f1f648599a",
                    "workspaceContributorRoleDefinitionGuid": "b24988ac-6180-42a0-ab88-20f7382dd24c",
                    "shouldRunAutomationScript": "[parameters('deploySentinelAutomationScript')]",
                    "shouldConfigureEntitySetting": "[and(parameters('enableEntityBehavior'), parameters('deployEntityBehaviorSetting'))]",
                    "shouldDeployEntitySettingDirect": false,
                    "entityBehaviorSettingResourceId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), 'Microsoft.SecurityInsights/settings', 'EntityAnalytics')]",
                    "entityBehaviorSettingPayload": "[string(createObject('kind', 'EntityAnalytics', 'properties', createObject('entityProviders', createArray('AzureActiveDirectory'))))]",
                    "shouldConfigureUebaSetting": "[and(and(parameters('enableUeba'), parameters('deployUebaSetting')), variables('shouldConfigureEntitySetting'))]",
                    "shouldConfigureAnomaliesSetting": "[parameters('enableAnomalies')]",
                    "uebaSettingResourceId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), 'Microsoft.SecurityInsights/settings', 'Ueba')]",
                    "uebaSettingPayload": "[string(createObject('kind', 'Ueba', 'properties', createObject('dataSources', parameters('uebaDataSources'))))]",
                    "anomaliesSettingResourceId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), 'Microsoft.SecurityInsights/settings', 'Anomalies')]",
                    "anomaliesSettingPayload": "[string(createObject('kind', 'Anomalies', 'properties', createObject()))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                      "apiVersion": "2023-01-31",
                      "name": "[format('sentinel-script-{0}', uniqueString(resourceGroup().id))]",
                      "location": "[parameters('location')]"
                    },
                    {
                      "condition": "[or(variables('shouldRunAutomationScript'), variables('shouldConfigureEntitySetting'))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2020-04-01-preview",
                      "name": "[guid(resourceGroup().id, format('sentinel-script-{0}', uniqueString(resourceGroup().id)), 'automation-script-rbac')]",
                      "properties": {
                        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('sentinel-script-{0}', uniqueString(resourceGroup().id))), '2023-01-31').principalId]",
                        "principalType": "ServicePrincipal",
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f1a07417-d97a-45cb-824c-7a7467783830')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('sentinel-script-{0}', uniqueString(resourceGroup().id)))]"
                      ]
                    },
                    {
                      "condition": "[or(or(variables('shouldConfigureEntitySetting'), variables('shouldConfigureUebaSetting')), variables('shouldConfigureAnomaliesSetting'))]",
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2020-04-01-preview",
                      "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', parameters('workspaceName'))]",
                      "name": "[guid(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), format('sentinel-script-{0}', uniqueString(resourceGroup().id)), 'automation-script-sentinel-rbac')]",
                      "properties": {
                        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('sentinel-script-{0}', uniqueString(resourceGroup().id))), '2023-01-31').principalId]",
                        "principalType": "ServicePrincipal",
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('workspaceContributorRoleDefinitionGuid'))]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('sentinel-script-{0}', uniqueString(resourceGroup().id)))]"
                      ]
                    },
                    {
                      "condition": "[variables('shouldRunAutomationScript')]",
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[format('lookup-asi-sp-{0}', uniqueString(resourceGroup().id))]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('sentinel-script-{0}', uniqueString(resourceGroup().id))))]": {}
                        }
                      },
                      "properties": {
                        "azCliVersion": "2.61.0",
                        "cleanupPreference": "OnExpiration",
                        "retentionInterval": "P1D",
                        "timeout": "PT15M",
                        "forceUpdateTag": "[if(empty(parameters('sentinelAutomationPrincipalId')), 'auto', parameters('sentinelAutomationPrincipalId'))]",
                        "environmentVariables": [
                          {
                            "name": "SENTINEL_SP_OBJECT_ID_OVERRIDE",
                            "value": "[parameters('sentinelAutomationPrincipalId')]"
                          },
                          {
                            "name": "SENTINEL_AUTOMATION_SCOPE",
                            "value": "[resourceGroup().id]"
                          },
                          {
                            "name": "SENTINEL_AUTOMATION_ROLE_ID",
                            "value": "[variables('sentinelAutomationContributorRoleDefinitionGuid')]"
                          }
                        ],
                        "scriptContent": "      principalId=\"$SENTINEL_SP_OBJECT_ID_OVERRIDE\"\r\n      if [ -z \"$principalId\" ]; then\r\n        principalId=$(az ad sp list --display-name \"Azure Security Insights\" --query \"[0].id\" -o tsv)\r\n      fi\r\n\r\n      if [ -z \"$principalId\" ]; then\r\n        echo \"Azure Security Insights service principal not found\" >&2\r\n        exit 1\r\n      fi\r\n\r\n      scope=\"$SENTINEL_AUTOMATION_SCOPE\"\r\n      roleDefinitionId=\"$SENTINEL_AUTOMATION_ROLE_ID\"\r\n\r\n      existingAssignment=$(az role assignment list --scope \"$scope\" --assignee-object-id \"$principalId\" --role \"$roleDefinitionId\" --query \"[0].id\" -o tsv)\r\n\r\n      if [ -z \"$existingAssignment\" ]; then\r\n        az role assignment create --assignee-object-id \"$principalId\" --assignee-principal-type ServicePrincipal --role \"$roleDefinitionId\" --scope \"$scope\" --only-show-errors\r\n      fi\r\n\r\n      echo \"{\\\"sentinelSpObjectId\\\": \\\"$principalId\\\"}\" > $AZ_SCRIPTS_OUTPUT_PATH\r\n    "
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('sentinel-script-{0}', uniqueString(resourceGroup().id)))]"
                      ]
                    },
                    {
                      "type": "Microsoft.SecurityInsights/onboardingStates",
                      "apiVersion": "2024-03-01",
                      "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', parameters('workspaceName'))]",
                      "name": "default",
                      "properties": {
                        "customerManagedKey": false
                      }
                    },
                    {
                      "condition": "[variables('shouldConfigureEntitySetting')]",
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[format('configure-entity-behavior-{0}', uniqueString(resourceGroup().id))]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('sentinel-script-{0}', uniqueString(resourceGroup().id))))]": {}
                        }
                      },
                      "properties": {
                        "azCliVersion": "2.61.0",
                        "cleanupPreference": "OnExpiration",
                        "retentionInterval": "P1D",
                        "timeout": "PT10M",
                        "environmentVariables": [
                          {
                            "name": "ENTITY_SETTING_ID",
                            "value": "[variables('entityBehaviorSettingResourceId')]"
                          },
                          {
                            "name": "ENTITY_SETTING_PAYLOAD",
                            "value": "[variables('entityBehaviorSettingPayload')]"
                          }
                        ],
                        "scriptContent": "      set -uo pipefail\r\n\r\n      resourceId=\"$ENTITY_SETTING_ID\"\r\n      apiVersion=\"2024-01-01-preview\"\r\n      payload=\"$ENTITY_SETTING_PAYLOAD\"\r\n\r\n      etag=$(az rest --method get --url \"$resourceId?api-version=$apiVersion\" --query etag -o tsv --only-show-errors 2>/dev/null || echo \"\")\r\n\r\n      if [ -n \"$etag\" ]; then\r\n        response=$(az rest --method put --headers \"Content-Type=application/json\" \"If-Match=$etag\" --url \"$resourceId?api-version=$apiVersion\" --body \"$payload\" --only-show-errors 2>&1) || rc=$?\r\n      else\r\n        response=$(az rest --method put --headers \"Content-Type=application/json\" \"If-None-Match=*\" --url \"$resourceId?api-version=$apiVersion\" --body \"$payload\" --only-show-errors 2>&1) || rc=$?\r\n      fi\r\n\r\n      if [ -n \"${rc:-}\" ] && [ \"${rc:-0}\" -ne 0 ]; then\r\n        if echo \"$response\" | grep -q \"Only 'Security Administrator' and 'Global Administrator'\"; then\r\n          echo \"$response\" >&2\r\n          exit 0\r\n        fi\r\n\r\n        echo \"$response\" >&2\r\n        exit ${rc:-1}\r\n      fi\r\n    "
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('sentinel-script-{0}', uniqueString(resourceGroup().id)))]",
                        "[resourceId('Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, format('sentinel-script-{0}', uniqueString(resourceGroup().id)), 'automation-script-rbac'))]",
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), format('sentinel-script-{0}', uniqueString(resourceGroup().id)), 'automation-script-sentinel-rbac'))]",
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), 'Microsoft.SecurityInsights/onboardingStates', 'default')]"
                      ]
                    },
                    {
                      "condition": "[variables('shouldConfigureUebaSetting')]",
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[format('configure-ueba-{0}', uniqueString(resourceGroup().id))]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('sentinel-script-{0}', uniqueString(resourceGroup().id))))]": {}
                        }
                      },
                      "properties": {
                        "azCliVersion": "2.61.0",
                        "cleanupPreference": "OnExpiration",
                        "retentionInterval": "P1D",
                        "timeout": "PT10M",
                        "environmentVariables": [
                          {
                            "name": "UEBA_SETTING_ID",
                            "value": "[variables('uebaSettingResourceId')]"
                          },
                          {
                            "name": "UEBA_SETTING_PAYLOAD",
                            "value": "[variables('uebaSettingPayload')]"
                          }
                        ],
                        "scriptContent": "      set -uo pipefail\r\n\r\n      resourceId=\"$UEBA_SETTING_ID\"\r\n      apiVersion=\"2024-01-01-preview\"\r\n      payload=\"$UEBA_SETTING_PAYLOAD\"\r\n\r\n      etag=$(az rest --method get --url \"$resourceId?api-version=$apiVersion\" --query etag -o tsv --only-show-errors 2>/dev/null || echo \"\")\r\n\r\n      if [ -n \"$etag\" ]; then\r\n        response=$(az rest --method put --headers \"Content-Type=application/json\" \"If-Match=$etag\" --url \"$resourceId?api-version=$apiVersion\" --body \"$payload\" --only-show-errors 2>&1) || rc=$?\r\n      else\r\n        response=$(az rest --method put --headers \"Content-Type=application/json\" \"If-None-Match=*\" --url \"$resourceId?api-version=$apiVersion\" --body \"$payload\" --only-show-errors 2>&1) || rc=$?\r\n      fi\r\n\r\n      if [ -n \"${rc:-}\" ] && [ \"${rc:-0}\" -ne 0 ]; then\r\n        if echo \"$response\" | grep -q \"requires 'EntityAnalytics' to be enabled\"; then\r\n          echo \"$response\" >&2\r\n          exit 0\r\n        fi\r\n\r\n        if echo \"$response\" | grep -q \"Only 'Security Administrator' and 'Global Administrator'\"; then\r\n          echo \"$response\" >&2\r\n          exit 0\r\n        fi\r\n\r\n        echo \"$response\" >&2\r\n        exit ${rc:-1}\r\n      fi\r\n    "
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('sentinel-script-{0}', uniqueString(resourceGroup().id)))]",
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), format('sentinel-script-{0}', uniqueString(resourceGroup().id)), 'automation-script-sentinel-rbac'))]",
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), 'Microsoft.SecurityInsights/onboardingStates', 'default')]"
                      ]
                    },
                    {
                      "condition": "[variables('shouldConfigureAnomaliesSetting')]",
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[format('configure-anomalies-{0}', uniqueString(resourceGroup().id))]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('sentinel-script-{0}', uniqueString(resourceGroup().id))))]": {}
                        }
                      },
                      "properties": {
                        "azCliVersion": "2.61.0",
                        "cleanupPreference": "OnExpiration",
                        "retentionInterval": "P1D",
                        "timeout": "PT10M",
                        "environmentVariables": [
                          {
                            "name": "ANOMALIES_SETTING_ID",
                            "value": "[variables('anomaliesSettingResourceId')]"
                          },
                          {
                            "name": "ANOMALIES_SETTING_PAYLOAD",
                            "value": "[variables('anomaliesSettingPayload')]"
                          }
                        ],
                        "scriptContent": "      set -uo pipefail\r\n\r\n      resourceId=\"$ANOMALIES_SETTING_ID\"\r\n      apiVersion=\"2024-01-01-preview\"\r\n      payload=\"$ANOMALIES_SETTING_PAYLOAD\"\r\n\r\n      etag=$(az rest --method get --url \"$resourceId?api-version=$apiVersion\" --query etag -o tsv --only-show-errors 2>/dev/null || echo \"\")\r\n\r\n      if [ -n \"$etag\" ]; then\r\n        response=$(az rest --method put --headers \"Content-Type=application/json\" \"If-Match=$etag\" --url \"$resourceId?api-version=$apiVersion\" --body \"$payload\" --only-show-errors 2>&1) || rc=$?\r\n      else\r\n        response=$(az rest --method put --headers \"Content-Type=application/json\" \"If-None-Match=*\" --url \"$resourceId?api-version=$apiVersion\" --body \"$payload\" --only-show-errors 2>&1) || rc=$?\r\n      fi\r\n\r\n      if [ -n \"${rc:-}\" ] && [ \"${rc:-0}\" -ne 0 ]; then\r\n        if echo \"$response\" | grep -q \"Only 'Security Administrator' and 'Global Administrator'\"; then\r\n          echo \"$response\" >&2\r\n          exit 0\r\n        fi\r\n\r\n        echo \"$response\" >&2\r\n        exit ${rc:-1}\r\n      fi\r\n    "
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('sentinel-script-{0}', uniqueString(resourceGroup().id)))]",
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), format('sentinel-script-{0}', uniqueString(resourceGroup().id)), 'automation-script-sentinel-rbac'))]",
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), 'Microsoft.SecurityInsights/onboardingStates', 'default')]"
                      ]
                    }
                  ],
                  "outputs": {
                    "sentinelResourceId": {
                      "type": "string",
                      "value": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), 'Microsoft.SecurityInsights/onboardingStates', 'default')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('monitoringResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-law-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "condition": "[and(parameters('deploySentinel'), parameters('enableAzureActivityConnector'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('configure-azure-activity-diagnostics-{0}', parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "diagnosticSettingName": {
                    "value": "[parameters('azureActivityDiagnosticSettingName')]"
                  },
                  "workspaceResourceId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('monitoringResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-law-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                  },
                  "logCategories": {
                    "value": "[parameters('azureActivityLogCategories')]"
                  },
                  "retentionPolicy": {
                    "value": "[parameters('azureActivityRetentionPolicy')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "1449698270905582576"
                    }
                  },
                  "parameters": {
                    "diagnosticSettingName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the diagnostic setting."
                      }
                    },
                    "workspaceResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource ID of the Log Analytics workspace that will receive logs."
                      }
                    },
                    "logCategories": {
                      "type": "array",
                      "defaultValue": [
                        "Administrative",
                        "Security",
                        "ServiceHealth",
                        "Alert",
                        "Recommendation",
                        "Policy",
                        "Autoscale",
                        "ResourceHealth"
                      ],
                      "metadata": {
                        "description": "Log categories to enable on the diagnostic setting."
                      }
                    },
                    "retentionPolicy": {
                      "type": "object",
                      "defaultValue": {
                        "enabled": false,
                        "days": 0
                      },
                      "metadata": {
                        "description": "Optional retention policy applied per category (disabled by default)."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Insights/diagnosticSettings",
                      "apiVersion": "2021-05-01-preview",
                      "name": "[parameters('diagnosticSettingName')]",
                      "properties": {
                        "copy": [
                          {
                            "name": "logs",
                            "count": "[length(parameters('logCategories'))]",
                            "input": {
                              "category": "[parameters('logCategories')[copyIndex('logs')]]",
                              "enabled": true,
                              "retentionPolicy": "[parameters('retentionPolicy')]"
                            }
                          }
                        ],
                        "workspaceId": "[parameters('workspaceResourceId')]"
                      }
                    }
                  ],
                  "outputs": {
                    "diagnosticSettingId": {
                      "type": "string",
                      "value": "[subscriptionResourceId('Microsoft.Insights/diagnosticSettings', parameters('diagnosticSettingName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('monitoringResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-law-{0}', parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "condition": "[and(parameters('deploySentinel'), parameters('enableEntraConnector'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('configure-sentinel-connectors-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tier').subscriptionId]",
              "resourceGroup": "[variables('monitoringResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "workspaceName": {
                    "value": "[variables('logAnalyticsWorkspaceName')]"
                  },
                  "tenantId": {
                    "value": "[parameters('tenantId')]"
                  },
                  "enableEntraConnector": {
                    "value": "[parameters('enableEntraConnector')]"
                  },
                  "entraDataTypeStates": {
                    "value": "[parameters('entraConnectorDataTypeStates')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "14957794883613767246"
                    }
                  },
                  "parameters": {
                    "workspaceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Log Analytics workspace that hosts Microsoft Sentinel."
                      }
                    },
                    "tenantId": {
                      "type": "string",
                      "metadata": {
                        "description": "Tenant ID associated with the Microsoft Sentinel workspace."
                      }
                    },
                    "enableEntraConnector": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Toggle to configure the Microsoft Entra ID data connector within Microsoft Sentinel."
                      }
                    },
                    "entraDataTypeStates": {
                      "type": "object",
                      "defaultValue": {
                        "SignInLogs": "Enabled",
                        "AuditLogs": "Enabled",
                        "NonInteractiveUserSignInLogs": "Enabled",
                        "ServicePrincipalSignInLogs": "Enabled",
                        "ManagedIdentitySignInLogs": "Enabled",
                        "ProvisioningLogs": "Enabled",
                        "ADFSSignInLogs": "Enabled",
                        "UserRiskEvents": "Enabled",
                        "RiskyUsers": "Enabled",
                        "RiskyServicePrincipals": "Enabled",
                        "alerts": "Enabled"
                      },
                      "metadata": {
                        "description": "Desired state (Enabled/Disabled) for each Microsoft Entra ID log type exposed by the data connector."
                      }
                    },
                    "connectorApiVersion": {
                      "type": "string",
                      "defaultValue": "2022-11-01-preview",
                      "metadata": {
                        "description": "API version to use when configuring the Microsoft Sentinel data connector."
                      }
                    }
                  },
                  "variables": {
                    "normalizedEntraDataTypes": {
                      "SignInLogs": {
                        "state": "[parameters('entraDataTypeStates').SignInLogs]"
                      },
                      "AuditLogs": {
                        "state": "[parameters('entraDataTypeStates').AuditLogs]"
                      },
                      "NonInteractiveUserSignInLogs": {
                        "state": "[parameters('entraDataTypeStates').NonInteractiveUserSignInLogs]"
                      },
                      "ServicePrincipalSignInLogs": {
                        "state": "[parameters('entraDataTypeStates').ServicePrincipalSignInLogs]"
                      },
                      "ManagedIdentitySignInLogs": {
                        "state": "[parameters('entraDataTypeStates').ManagedIdentitySignInLogs]"
                      },
                      "ProvisioningLogs": {
                        "state": "[parameters('entraDataTypeStates').ProvisioningLogs]"
                      },
                      "ADFSSignInLogs": {
                        "state": "[parameters('entraDataTypeStates').ADFSSignInLogs]"
                      },
                      "UserRiskEvents": {
                        "state": "[parameters('entraDataTypeStates').UserRiskEvents]"
                      },
                      "RiskyUsers": {
                        "state": "[parameters('entraDataTypeStates').RiskyUsers]"
                      },
                      "RiskyServicePrincipals": {
                        "state": "[parameters('entraDataTypeStates').RiskyServicePrincipals]"
                      },
                      "alerts": {
                        "state": "[parameters('entraDataTypeStates').alerts]"
                      }
                    },
                    "entraConnectorResourceId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), 'Microsoft.SecurityInsights/dataConnectors', 'AzureActiveDirectory')]",
                    "entraConnectorPayload": "[string(createObject('kind', 'AzureActiveDirectory', 'properties', createObject('tenantId', parameters('tenantId'), 'dataTypes', variables('normalizedEntraDataTypes'))))]",
                    "sentinelScriptIdentityResourceId": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('sentinel-script-{0}', uniqueString(resourceGroup().id)))]"
                  },
                  "resources": [
                    {
                      "condition": "[parameters('enableEntraConnector')]",
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[format('configure-entra-connector-{0}', uniqueString(resourceGroup().id))]",
                      "properties": {
                        "azCliVersion": "2.61.0",
                        "cleanupPreference": "OnExpiration",
                        "retentionInterval": "P1D",
                        "timeout": "PT10M",
                        "forceUpdateTag": "[format('{0}-{1}', parameters('tenantId'), base64(variables('entraConnectorPayload')))]",
                        "environmentVariables": [
                          {
                            "name": "ENTRA_CONNECTOR_ID",
                            "value": "[variables('entraConnectorResourceId')]"
                          },
                          {
                            "name": "ENTRA_CONNECTOR_PAYLOAD",
                            "value": "[variables('entraConnectorPayload')]"
                          },
                          {
                            "name": "ENTRA_CONNECTOR_API_VERSION",
                            "value": "[parameters('connectorApiVersion')]"
                          }
                        ],
                        "scriptContent": "set -uo pipefail\n\nresourceId=\"$ENTRA_CONNECTOR_ID\"\napiVersion=\"$ENTRA_CONNECTOR_API_VERSION\"\npayload=\"$ENTRA_CONNECTOR_PAYLOAD\"\n\netag=$(az rest --method get --url \"$resourceId?api-version=$apiVersion\" --query etag -o tsv --only-show-errors 2>/dev/null || echo \"\")\n\nif [ -n \"$etag\" ]; then\n  response=$(az rest --method put --headers \"Content-Type=application/json\" \"If-Match=$etag\" --url \"$resourceId?api-version=$apiVersion\" --body \"$payload\" --only-show-errors 2>&1) || rc=$?\nelse\n  response=$(az rest --method put --headers \"Content-Type=application/json\" \"If-None-Match=*\" --url \"$resourceId?api-version=$apiVersion\" --body \"$payload\" --only-show-errors 2>&1) || rc=$?\nfi\n\nif [ -n \"${rc:-}\" ] && [ \"${rc:-0}\" -ne 0 ]; then\n  if echo \"$response\" | grep -qi \"already exists\"; then\n    echo \"$response\" >&2\n    exit 0\n  fi\n\n  # If the workspace is the Primary workspace in Microsoft 365 Defender, connector changes may be blocked in Sentinel.\n  if echo \"$response\" | grep -qi \"blocked\"; then\n    echo \"$response\" >&2\n    exit 0\n  fi\n\n  echo \"$response\" >&2\n  exit ${rc:-1}\nfi\n"
                      },
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', variables('sentinelScriptIdentityResourceId'))]": {}
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('monitoringResourceGroupName')), 'Microsoft.Resources/deployments', format('configure-sentinel-settings-{0}', parameters('deploymentNameSuffix')))]"
              ]
            }
          ],
          "outputs": {
            "logAnalyticsWorkspaceResourceId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('monitoringResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-law-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
            },
            "networkInterfaceResourceIds": {
              "type": "array",
              "value": [
                "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('monitoringResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-private-endpoint-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceId.value]"
              ]
            },
            "privateLinkScopeResourceId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('monitoringResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-private-link-scope-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
            },
            "monitoringResourceGroupName": {
              "type": "string",
              "value": "[variables('monitoringResourceGroupName')]"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "value": "[variables('logAnalyticsWorkspaceName')]"
            },
            "monitoringSubscriptionId": {
              "type": "string",
              "value": "[parameters('tier').subscriptionId]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-security-rg-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-security-rg-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[parameters('operationsSubscriptionId')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deploySentinel": {
            "value": "[parameters('deploySentinel')]"
          },
          "mlzTags": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
          },
          "name": {
            "value": "[variables('securityResourceGroupName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "deploySentinel": {
              "type": "bool"
            },
            "mlzTags": {
              "type": "object"
            },
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "condition": "[parameters('deploySentinel')]",
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2019-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Resources/resourceGroups'), createObject()), parameters('mlzTags'))]"
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deploymentNameSuffix": {
            "value": "[parameters('deploymentNameSuffix')]"
          },
          "workspaceName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.logAnalyticsWorkspaceName.value]"
          },
          "workspaceLocation": {
            "value": "[parameters('location')]"
          },
          "workspaceResourceGroupName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.monitoringResourceGroupName.value]"
          },
          "workspaceSubscriptionId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.monitoringSubscriptionId.value]"
          },
          "templateBaseUri": {
            "value": "[variables('templateBaseUri')]"
          },
          "azureActivityWorkbookName": {
            "value": "[parameters('azureActivityWorkbookName')]"
          },
          "azureServiceHealthWorkbookName": {
            "value": "[parameters('azureServiceHealthWorkbookName')]"
          },
          "entraAuditWorkbookName": {
            "value": "[parameters('entraAuditWorkbookName')]"
          },
          "entraSigninWorkbookName": {
            "value": "[parameters('entraSigninWorkbookName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "5034930740871537025"
            }
          },
          "parameters": {
            "deploymentNameSuffix": {
              "type": "string",
              "metadata": {
                "description": "Suffix appended to the deployment name so module executions remain unique per run."
              }
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Log Analytics workspace where Microsoft Sentinel is enabled."
              }
            },
            "workspaceLocation": {
              "type": "string",
              "metadata": {
                "description": "Azure region that hosts the Log Analytics workspace."
              }
            },
            "workspaceResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Resource group that contains the Microsoft Sentinel workspace."
              }
            },
            "workspaceSubscriptionId": {
              "type": "string",
              "metadata": {
                "description": "Subscription identifier that contains the Microsoft Sentinel workspace."
              }
            },
            "templateBaseUri": {
              "type": "string",
              "defaultValue": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main",
              "metadata": {
                "description": "Base URI for raw access to this repository. Used to link nested workbook templates without embedding them."
              }
            },
            "azureActivityWorkbookName": {
              "type": "string",
              "defaultValue": "Azure Activity",
              "metadata": {
                "description": "Display name assigned to the Azure Activity workbook that ships with the solution package."
              }
            },
            "azureServiceHealthWorkbookName": {
              "type": "string",
              "defaultValue": "Azure Service Health Workbook",
              "metadata": {
                "description": "Display name assigned to the Azure Service Health workbook included in the Azure Activity solution package."
              }
            },
            "entraAuditWorkbookName": {
              "type": "string",
              "defaultValue": "Microsoft Entra ID Audit logs",
              "metadata": {
                "description": "Display name assigned to the Microsoft Entra ID audit workbook that ships with the solution package."
              }
            },
            "entraSigninWorkbookName": {
              "type": "string",
              "defaultValue": "Microsoft Entra ID Sign-in logs",
              "metadata": {
                "description": "Display name assigned to the Microsoft Entra ID sign-in workbook that ships with the solution package."
              }
            },
            "deployAzureActivitySolution": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Toggle to install the Azure Activity Microsoft Sentinel solution when Microsoft Sentinel is enabled."
              }
            },
            "deployMicrosoftEntraSolution": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Toggle to install the Microsoft Entra ID Microsoft Sentinel solution when Microsoft Sentinel is enabled."
              }
            }
          },
          "resources": [
            {
              "condition": "[parameters('deployAzureActivitySolution')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-azure-activity-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('workspaceSubscriptionId')]",
              "resourceGroup": "[parameters('workspaceResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('workspaceLocation')]"
                  },
                  "workspace-location": {
                    "value": "[parameters('workspaceLocation')]"
                  },
                  "workspace": {
                    "value": "[parameters('workspaceName')]"
                  },
                  "workbook1-name": {
                    "value": "[parameters('azureActivityWorkbookName')]"
                  },
                  "workbook2-name": {
                    "value": "[parameters('azureServiceHealthWorkbookName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "author": "Microsoft - support@microsoft.com",
                    "comments": "Solution template for Azure Activity"
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "minLength": 1,
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
                      }
                    },
                    "workspace-location": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
                      }
                    },
                    "workspace": {
                      "defaultValue": "",
                      "type": "string",
                      "metadata": {
                        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
                      }
                    },
                    "workbook1-name": {
                      "type": "string",
                      "defaultValue": "Azure Activity",
                      "minLength": 1,
                      "metadata": {
                        "description": "Name for the workbook"
                      }
                    },
                    "workbook2-name": {
                      "type": "string",
                      "defaultValue": "Azure Service Health Workbook",
                      "minLength": 1,
                      "metadata": {
                        "description": "Name for the workbook"
                      }
                    }
                  },
                  "variables": {
                    "email": "support@microsoft.com",
                    "_email": "[variables('email')]",
                    "_solutionName": "Azure Activity",
                    "_solutionVersion": "3.0.3",
                    "solutionId": "azuresentinel.azure-sentinel-solution-azureactivity",
                    "_solutionId": "[variables('solutionId')]",
                    "uiConfigId1": "AzureActivity",
                    "_uiConfigId1": "[variables('uiConfigId1')]",
                    "dataConnectorContentId1": "AzureActivity",
                    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
                    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                    "_dataConnectorId1": "[variables('dataConnectorId1')]",
                    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1'))))]",
                    "dataConnectorVersion1": "2.0.0",
                    "_dataConnectorcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentId1'),'-', variables('dataConnectorVersion1'))))]",
                    "huntingQueryObject1": {
                      "huntingQueryVersion1": "2.0.2",
                      "_huntingQuerycontentId1": "ef7ef44e-6129-4d8e-94fe-b5530415d8e5",
                      "huntingQueryTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('ef7ef44e-6129-4d8e-94fe-b5530415d8e5')))]"
                    },
                    "huntingQueryObject2": {
                      "huntingQueryVersion2": "2.0.0",
                      "_huntingQuerycontentId2": "43cb0347-bdcc-4e83-af5a-cebbd03971d8",
                      "huntingQueryTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('43cb0347-bdcc-4e83-af5a-cebbd03971d8')))]"
                    },
                    "huntingQueryObject3": {
                      "huntingQueryVersion3": "2.0.1",
                      "_huntingQuerycontentId3": "5d2399f9-ea5c-4e67-9435-1fba745f3a39",
                      "huntingQueryTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('5d2399f9-ea5c-4e67-9435-1fba745f3a39')))]"
                    },
                    "huntingQueryObject4": {
                      "huntingQueryVersion4": "2.0.1",
                      "_huntingQuerycontentId4": "1b8779c9-abf2-444f-a21f-437b8f90ac4a",
                      "huntingQueryTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('1b8779c9-abf2-444f-a21f-437b8f90ac4a')))]"
                    },
                    "huntingQueryObject5": {
                      "huntingQueryVersion5": "2.0.1",
                      "_huntingQuerycontentId5": "e94d6756-981c-4f02-9a81-d006d80c8b41",
                      "huntingQueryTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('e94d6756-981c-4f02-9a81-d006d80c8b41')))]"
                    },
                    "huntingQueryObject6": {
                      "huntingQueryVersion6": "2.1.1",
                      "_huntingQuerycontentId6": "efe843ca-3ce7-4896-9f8b-f2c374ae6527",
                      "huntingQueryTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('efe843ca-3ce7-4896-9f8b-f2c374ae6527')))]"
                    },
                    "huntingQueryObject7": {
                      "huntingQueryVersion7": "2.0.1",
                      "_huntingQuerycontentId7": "17201aa8-0916-4078-a020-7ea3a9262889",
                      "huntingQueryTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('17201aa8-0916-4078-a020-7ea3a9262889')))]"
                    },
                    "huntingQueryObject8": {
                      "huntingQueryVersion8": "2.0.1",
                      "_huntingQuerycontentId8": "5a1f9655-c893-4091-8dc0-7f11d7676506",
                      "huntingQueryTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('5a1f9655-c893-4091-8dc0-7f11d7676506')))]"
                    },
                    "huntingQueryObject9": {
                      "huntingQueryVersion9": "2.0.1",
                      "_huntingQuerycontentId9": "57784ba5-7791-422e-916f-65ef94fe1dbb",
                      "huntingQueryTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('57784ba5-7791-422e-916f-65ef94fe1dbb')))]"
                    },
                    "huntingQueryObject10": {
                      "huntingQueryVersion10": "2.0.1",
                      "_huntingQuerycontentId10": "0278e3b8-9899-45c5-8928-700cd80d2d80",
                      "huntingQueryTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0278e3b8-9899-45c5-8928-700cd80d2d80')))]"
                    },
                    "huntingQueryObject11": {
                      "huntingQueryVersion11": "2.0.1",
                      "_huntingQuerycontentId11": "a09e6368-065b-4f1e-a4ce-b1b3a64b493b",
                      "huntingQueryTemplateSpecName11": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('a09e6368-065b-4f1e-a4ce-b1b3a64b493b')))]"
                    },
                    "huntingQueryObject12": {
                      "huntingQueryVersion12": "2.0.1",
                      "_huntingQuerycontentId12": "860cda84-765b-4273-af44-958b7cca85f7",
                      "huntingQueryTemplateSpecName12": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('860cda84-765b-4273-af44-958b7cca85f7')))]"
                    },
                    "huntingQueryObject13": {
                      "huntingQueryVersion13": "2.0.1",
                      "_huntingQuerycontentId13": "9e146876-e303-49af-b847-b029d1a66852",
                      "huntingQueryTemplateSpecName13": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('9e146876-e303-49af-b847-b029d1a66852')))]"
                    },
                    "huntingQueryObject14": {
                      "huntingQueryVersion14": "2.0.1",
                      "_huntingQuerycontentId14": "81fd68a2-9ad6-4a1c-7bd7-18efe5c99081",
                      "huntingQueryTemplateSpecName14": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('81fd68a2-9ad6-4a1c-7bd7-18efe5c99081')))]"
                    },
                    "huntingQueryObject15": {
                      "huntingQueryVersion15": "1",
                      "_huntingQuerycontentId15": "26d116bd-324b-4bb8-b102-d4a282607ad7",
                      "huntingQueryTemplateSpecName15": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('26d116bd-324b-4bb8-b102-d4a282607ad7')))]"
                    },
                    "analyticRuleObject1": {
                      "analyticRuleVersion1": "2.0.3",
                      "_analyticRulecontentId1": "88f453ff-7b9e-45bb-8c12-4058ca5e44ee",
                      "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '88f453ff-7b9e-45bb-8c12-4058ca5e44ee')]",
                      "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('88f453ff-7b9e-45bb-8c12-4058ca5e44ee')))]",
                      "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','88f453ff-7b9e-45bb-8c12-4058ca5e44ee','-', '2.0.3')))]"
                    },
                    "analyticRuleObject2": {
                      "analyticRuleVersion2": "2.0.3",
                      "_analyticRulecontentId2": "86a036b2-3686-42eb-b417-909fc0867771",
                      "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '86a036b2-3686-42eb-b417-909fc0867771')]",
                      "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('86a036b2-3686-42eb-b417-909fc0867771')))]",
                      "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','86a036b2-3686-42eb-b417-909fc0867771','-', '2.0.3')))]"
                    },
                    "analyticRuleObject3": {
                      "analyticRuleVersion3": "2.0.3",
                      "_analyticRulecontentId3": "d9938c3b-16f9-444d-bc22-ea9a9110e0fd",
                      "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'd9938c3b-16f9-444d-bc22-ea9a9110e0fd')]",
                      "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('d9938c3b-16f9-444d-bc22-ea9a9110e0fd')))]",
                      "_analyticRulecontentProductId3": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','d9938c3b-16f9-444d-bc22-ea9a9110e0fd','-', '2.0.3')))]"
                    },
                    "analyticRuleObject4": {
                      "analyticRuleVersion4": "2.0.4",
                      "_analyticRulecontentId4": "361dd1e3-1c11-491e-82a3-bb2e44ac36ba",
                      "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '361dd1e3-1c11-491e-82a3-bb2e44ac36ba')]",
                      "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('361dd1e3-1c11-491e-82a3-bb2e44ac36ba')))]",
                      "_analyticRulecontentProductId4": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','361dd1e3-1c11-491e-82a3-bb2e44ac36ba','-', '2.0.4')))]"
                    },
                    "analyticRuleObject5": {
                      "analyticRuleVersion5": "2.0.3",
                      "_analyticRulecontentId5": "9736e5f1-7b6e-4bfb-a708-e53ff1d182c3",
                      "analyticRuleId5": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '9736e5f1-7b6e-4bfb-a708-e53ff1d182c3')]",
                      "analyticRuleTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('9736e5f1-7b6e-4bfb-a708-e53ff1d182c3')))]",
                      "_analyticRulecontentProductId5": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','9736e5f1-7b6e-4bfb-a708-e53ff1d182c3','-', '2.0.3')))]"
                    },
                    "analyticRuleObject6": {
                      "analyticRuleVersion6": "2.0.2",
                      "_analyticRulecontentId6": "b2c15736-b9eb-4dae-8b02-3016b6a45a32",
                      "analyticRuleId6": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'b2c15736-b9eb-4dae-8b02-3016b6a45a32')]",
                      "analyticRuleTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('b2c15736-b9eb-4dae-8b02-3016b6a45a32')))]",
                      "_analyticRulecontentProductId6": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','b2c15736-b9eb-4dae-8b02-3016b6a45a32','-', '2.0.2')))]"
                    },
                    "analyticRuleObject7": {
                      "analyticRuleVersion7": "2.0.3",
                      "_analyticRulecontentId7": "ec491363-5fe7-4eff-b68e-f42dcb76fcf6",
                      "analyticRuleId7": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'ec491363-5fe7-4eff-b68e-f42dcb76fcf6')]",
                      "analyticRuleTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('ec491363-5fe7-4eff-b68e-f42dcb76fcf6')))]",
                      "_analyticRulecontentProductId7": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','ec491363-5fe7-4eff-b68e-f42dcb76fcf6','-', '2.0.3')))]"
                    },
                    "analyticRuleObject8": {
                      "analyticRuleVersion8": "2.0.3",
                      "_analyticRulecontentId8": "56fe0db0-6779-46fa-b3c5-006082a53064",
                      "analyticRuleId8": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '56fe0db0-6779-46fa-b3c5-006082a53064')]",
                      "analyticRuleTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('56fe0db0-6779-46fa-b3c5-006082a53064')))]",
                      "_analyticRulecontentProductId8": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','56fe0db0-6779-46fa-b3c5-006082a53064','-', '2.0.3')))]"
                    },
                    "analyticRuleObject9": {
                      "analyticRuleVersion9": "2.0.3",
                      "_analyticRulecontentId9": "6d7214d9-4a28-44df-aafb-0910b9e6ae3e",
                      "analyticRuleId9": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '6d7214d9-4a28-44df-aafb-0910b9e6ae3e')]",
                      "analyticRuleTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('6d7214d9-4a28-44df-aafb-0910b9e6ae3e')))]",
                      "_analyticRulecontentProductId9": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','6d7214d9-4a28-44df-aafb-0910b9e6ae3e','-', '2.0.3')))]"
                    },
                    "analyticRuleObject10": {
                      "analyticRuleVersion10": "2.0.4",
                      "_analyticRulecontentId10": "9fb57e58-3ed8-4b89-afcf-c8e786508b1c",
                      "analyticRuleId10": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '9fb57e58-3ed8-4b89-afcf-c8e786508b1c')]",
                      "analyticRuleTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('9fb57e58-3ed8-4b89-afcf-c8e786508b1c')))]",
                      "_analyticRulecontentProductId10": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','9fb57e58-3ed8-4b89-afcf-c8e786508b1c','-', '2.0.4')))]"
                    },
                    "analyticRuleObject11": {
                      "analyticRuleVersion11": "2.0.3",
                      "_analyticRulecontentId11": "23de46ea-c425-4a77-b456-511ae4855d69",
                      "analyticRuleId11": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '23de46ea-c425-4a77-b456-511ae4855d69')]",
                      "analyticRuleTemplateSpecName11": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('23de46ea-c425-4a77-b456-511ae4855d69')))]",
                      "_analyticRulecontentProductId11": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','23de46ea-c425-4a77-b456-511ae4855d69','-', '2.0.3')))]"
                    },
                    "analyticRuleObject12": {
                      "analyticRuleVersion12": "2.0.4",
                      "_analyticRulecontentId12": "ed43bdb7-eaab-4ea4-be52-6951fcfa7e3b",
                      "analyticRuleId12": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'ed43bdb7-eaab-4ea4-be52-6951fcfa7e3b')]",
                      "analyticRuleTemplateSpecName12": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('ed43bdb7-eaab-4ea4-be52-6951fcfa7e3b')))]",
                      "_analyticRulecontentProductId12": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','ed43bdb7-eaab-4ea4-be52-6951fcfa7e3b','-', '2.0.4')))]"
                    },
                    "analyticRuleObject13": {
                      "analyticRuleVersion13": "1.0.1",
                      "_analyticRulecontentId13": "48c026d8-7f36-4a95-9568-6f1420d66e37",
                      "analyticRuleId13": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '48c026d8-7f36-4a95-9568-6f1420d66e37')]",
                      "analyticRuleTemplateSpecName13": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('48c026d8-7f36-4a95-9568-6f1420d66e37')))]",
                      "_analyticRulecontentProductId13": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','48c026d8-7f36-4a95-9568-6f1420d66e37','-', '1.0.1')))]"
                    },
                    "analyticRuleObject14": {
                      "analyticRuleVersion14": "1.0.0",
                      "_analyticRulecontentId14": "68c89998-8052-4c80-a1f6-9d81060b6d57",
                      "analyticRuleId14": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '68c89998-8052-4c80-a1f6-9d81060b6d57')]",
                      "analyticRuleTemplateSpecName14": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('68c89998-8052-4c80-a1f6-9d81060b6d57')))]",
                      "_analyticRulecontentProductId14": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','68c89998-8052-4c80-a1f6-9d81060b6d57','-', '1.0.0')))]"
                    },
                    "workbookVersion1": "2.0.0",
                    "workbookContentId1": "AzureActivityWorkbook",
                    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
                    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
                    "_workbookContentId1": "[variables('workbookContentId1')]",
                    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
                    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
                    "workbookVersion2": "1.0.0",
                    "workbookContentId2": "AzureServiceHealthWorkbook",
                    "workbookId2": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId2'))]",
                    "workbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId2'))))]",
                    "_workbookContentId2": "[variables('workbookContentId2')]",
                    "_workbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId2'),'-', variables('workbookVersion2'))))]",
                    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('dataConnectorTemplateSpecName1')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Azure Activity data connector with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('dataConnectorVersion1')]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
                              "apiVersion": "2021-03-01-preview",
                              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
                              "location": "[parameters('workspace-location')]",
                              "kind": "StaticUI",
                              "properties": {
                                "connectorUiConfig": {
                                  "id": "[variables('_uiConfigId1')]",
                                  "title": "Azure Activity",
                                  "publisher": "Microsoft",
                                  "descriptionMarkdown": "Azure Activity Log is a subscription log that provides insight into subscription-level events that occur in Azure, including events from Azure Resource Manager operational data, service health events, write operations taken on the resources in your subscription, and the status of activities performed in Azure. For more information, see the [Microsoft Sentinel documentation ](https://go.microsoft.com/fwlink/p/?linkid=2219695&wt.mc_id=sentinel_dataconnectordocs_content_cnl_csasci).",
                                  "graphQueries": [
                                    {
                                      "metricName": "Total data received",
                                      "legend": "AzureActivity",
                                      "baseQuery": "AzureActivity"
                                    }
                                  ],
                                  "connectivityCriterias": [
                                    {
                                      "type": "IsConnectedQuery",
                                      "value": [
                                        "AzureActivity\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                                      ]
                                    }
                                  ],
                                  "dataTypes": [
                                    {
                                      "name": "AzureActivity",
                                      "lastDataReceivedQuery": "AzureActivity\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                                    }
                                  ]
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2023-04-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
                              "properties": {
                                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                                "contentId": "[variables('_dataConnectorContentId1')]",
                                "kind": "DataConnector",
                                "version": "[variables('dataConnectorVersion1')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_dataConnectorContentId1')]",
                        "contentKind": "DataConnector",
                        "displayName": "Azure Activity",
                        "contentProductId": "[variables('_dataConnectorcontentProductId1')]",
                        "id": "[variables('_dataConnectorcontentProductId1')]",
                        "version": "[variables('dataConnectorVersion1')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
                      "dependsOn": [
                        "[variables('_dataConnectorId1')]"
                      ],
                      "location": "[parameters('workspace-location')]",
                      "properties": {
                        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                        "contentId": "[variables('_dataConnectorContentId1')]",
                        "kind": "DataConnector",
                        "version": "[variables('dataConnectorVersion1')]",
                        "source": {
                          "kind": "Solution",
                          "name": "Azure Activity",
                          "sourceId": "[variables('_solutionId')]"
                        },
                        "author": {
                          "name": "Microsoft",
                          "email": "[variables('_email')]"
                        },
                        "support": {
                          "tier": "Microsoft",
                          "name": "Microsoft Corporation",
                          "email": "support@microsoft.com",
                          "link": "https://support.microsoft.com/"
                        }
                      }
                    },
                    {
                      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
                      "apiVersion": "2021-03-01-preview",
                      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
                      "location": "[parameters('workspace-location')]",
                      "kind": "StaticUI",
                      "properties": {
                        "connectorUiConfig": {
                          "title": "Azure Activity",
                          "publisher": "Microsoft",
                          "descriptionMarkdown": "Azure Activity Log is a subscription log that provides insight into subscription-level events that occur in Azure, including events from Azure Resource Manager operational data, service health events, write operations taken on the resources in your subscription, and the status of activities performed in Azure. For more information, see the [Microsoft Sentinel documentation ](https://go.microsoft.com/fwlink/p/?linkid=2219695&wt.mc_id=sentinel_dataconnectordocs_content_cnl_csasci).",
                          "graphQueries": [
                            {
                              "metricName": "Total data received",
                              "legend": "AzureActivity",
                              "baseQuery": "AzureActivity"
                            }
                          ],
                          "dataTypes": [
                            {
                              "name": "AzureActivity",
                              "lastDataReceivedQuery": "AzureActivity\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                            }
                          ],
                          "connectivityCriterias": [
                            {
                              "type": "IsConnectedQuery",
                              "value": [
                                "AzureActivity\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                              ]
                            }
                          ],
                          "id": "[variables('_uiConfigId1')]"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('huntingQueryObject1').huntingQueryTemplateSpecName1]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AnalyticsRulesAdministrativeOperations_HuntingQueries Hunting Query with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('huntingQueryObject1').huntingQueryVersion1]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/savedSearches",
                              "apiVersion": "2022-10-01",
                              "name": "Azure_Activity_Hunting_Query_1",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "eTag": "*",
                                "displayName": "Microsoft Sentinel Analytics Rules Administrative Operations",
                                "category": "Hunting Queries",
                                "query": "let opValues = dynamic([\"Microsoft.SecurityInsights/alertRules/write\", \"Microsoft.SecurityInsights/alertRules/delete\"]);\n// Microsoft Sentinel Analytics - Rule Create / Update / Delete\nAzureActivity\n| where CategoryValue =~ \"Administrative\"\n| where OperationNameValue in~ (opValues)\n| where ActivitySubstatusValue in~ (\"Created\", \"OK\")\n| sort by TimeGenerated desc\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_UPNSuffix = UPNSuffix\n| extend IP_0_Address = CallerIpAddress\n",
                                "version": 2,
                                "tags": [
                                  {
                                    "name": "description",
                                    "value": "Identifies Microsoft Sentinel Analytics Rules administrative operations"
                                  },
                                  {
                                    "name": "tactics",
                                    "value": "Impact"
                                  },
                                  {
                                    "name": "techniques",
                                    "value": "T1496"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject1')._huntingQuerycontentId1),'/'))))]",
                              "properties": {
                                "description": "Azure Activity Hunting Query 1",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject1')._huntingQuerycontentId1)]",
                                "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject1').huntingQueryVersion1]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
                        "contentKind": "HuntingQuery",
                        "displayName": "Microsoft Sentinel Analytics Rules Administrative Operations",
                        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject1')._huntingQuerycontentId1,'-', '2.0.2')))]",
                        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject1')._huntingQuerycontentId1,'-', '2.0.2')))]",
                        "version": "2.0.2"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('huntingQueryObject2').huntingQueryTemplateSpecName2]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AnomalousAzureOperationModel_HuntingQueries Hunting Query with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('huntingQueryObject2').huntingQueryVersion2]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/savedSearches",
                              "apiVersion": "2022-10-01",
                              "name": "Azure_Activity_Hunting_Query_2",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "eTag": "*",
                                "displayName": "Anomalous Azure Operation Hunting Model",
                                "category": "Hunting Queries",
                                "query": "// When the detection window will end (3 days prior to now)\nlet startDetectDate = 3d;\n// When the detection window will start (now)\nlet endDetectDate = 0d;\n// When to start collecting data for detection\nlet startDate = startDetectDate + 30d;\n// Operation to monitor, in this case Run Command\nlet monitoredOps = dynamic(['microsoft.compute/virtualmachines/runcommand/action']);\n// The resource type to monitor, in this case virtual machines\nlet monitoredResource = pack_array('microsoft.compute/virtualmachines');\nlet pair_probabilities_fl = (tbl:(*), A_col:string, B_col:string, scope_col:string)\n{\nlet T = (tbl | extend _A = column_ifexists(A_col, ''), _B = column_ifexists(B_col, ''), _scope = column_ifexists(scope_col, ''));\nlet countOnScope = T | summarize countAllOnScope = count() by _scope;\nlet probAB = T | summarize countAB = count() by _A, _B, _scope | join kind = leftouter (countOnScope) on _scope | extend P_AB = todouble(countAB)/countAllOnScope;\nlet probA  = probAB | summarize countA = sum(countAB), countAllOnScope = max(countAllOnScope) by _A, _scope | extend P_A = todouble(countA)/countAllOnScope;\nlet probB  = probAB | summarize countB = sum(countAB), countAllOnScope = max(countAllOnScope) by _B, _scope | extend P_B = todouble(countB)/countAllOnScope;\n    probAB\n    | join kind = leftouter (probA) on _A, _scope\n    | join kind = leftouter (probB) on _B, _scope\n    | extend P_AUB = P_A + P_B - P_AB\n           , P_AIB = P_AB/P_B\n           , P_BIA = P_AB/P_A\n    | extend Lift_AB = P_AB/(P_A * P_B)\n           , Jaccard_AB = P_AB/P_AUB\n    | project _A, _B, _scope, floor(P_A, 0.00001), floor(P_B, 0.00001), floor(P_AB, 0.00001), floor(P_AUB, 0.00001), floor(P_AIB, 0.00001)\n    , floor(P_BIA, 0.00001), floor(Lift_AB, 0.00001), floor(Jaccard_AB, 0.00001)\n    | sort by _scope, _A, _B\n};\nlet eventsTable = materialize (\nAzureActivity\n| where TimeGenerated between (ago(startDate) .. ago(endDetectDate))\n| where isnotempty(CallerIpAddress)\n| where ActivityStatusValue has_any ('Success', 'Succeeded')\n| extend ResourceId = iff(isempty(_ResourceId), ResourceId, _ResourceId)\n| extend splitOp = split(OperationNameValue, '/')\n| extend splitRes = split(ResourceId, '/')\n| project TimeGenerated , subscriptionId=SubscriptionId\n            , ResourceProvider\n            , ResourceName = tolower(tostring(splitRes[-1]))\n            , OperationNameValue = tolower(OperationNameValue)\n            , timeSlice = floor(TimeGenerated, 1d)\n            , clientIp = tostring(CallerIpAddress)\n            , Caller\n            , isMonitoredOp = iff(OperationNameValue has_any (monitoredOps), 1, 0)\n            , isMonitoredResource = iff(OperationNameValue has_any (monitoredResource), 1, 0)\n            , CorrelationId\n| extend clientIpMask = format_ipv4_mask(clientIp, 16)\n);\nlet modelData =  (\neventsTable\n| where TimeGenerated < ago(startDetectDate) and isnotempty(Caller) and isnotempty(subscriptionId)\n| summarize countEvents = count(), countMonRes = countif(isMonitoredResource == 1), counMonOp = countif(isMonitoredOp == 1)\n    , firstSeen = min(timeSlice), firstSeenOnMonRes = minif(timeSlice, isMonitoredResource == 1), firstSeenOnMonOp = minif(timeSlice, isMonitoredOp == 1)\n    by subscriptionId, Caller, clientIpMask\n);\nlet monOpProbs = materialize (\neventsTable\n| where TimeGenerated < ago(startDetectDate) and isnotempty(Caller) and isnotempty(subscriptionId)\n| invoke pair_probabilities_fl('Caller', 'isMonitoredResource','subscriptionId')\n| where _B == 1\n| sort by P_AIB desc\n| extend rankOnMonRes = row_rank(P_AIB), sumBiggerCondProbs = row_cumsum(P_AIB) - P_AIB\n| extend avgBiggerCondProbs = floor(iff(rankOnMonRes > 1, sumBiggerCondProbs/(rankOnMonRes-1), max_of(0.0, prev(sumBiggerCondProbs))), 0.00001)\n| project-away sumBiggerCondProbs\n);\neventsTable\n| where TimeGenerated between (ago(startDetectDate) .. ago(endDetectDate))\n| join kind = leftouter (modelData | summarize countEventsPrincOnSub = sum(countEvents), countEventsMonResPrincOnSub = sum(countMonRes),  countEventsMonOpPrincOnSub = sum(counMonOp)\n    , firstSeenPrincOnSubs = min(firstSeen), firstSeenMonResPrincOnSubs = min(firstSeenOnMonRes), firstSeenMonOpPrincOnSubs = min(firstSeenOnMonOp) by subscriptionId, Caller) \n        on subscriptionId, Caller\n| join kind = leftouter (modelData | summarize countEventsIpMaskOnSub = sum(countEvents), countEventsMonResIpMaskOnSub = sum(countMonRes),  countEventsMonOpIpMaskOnSub = sum(counMonOp)\n    , firstSeenIpMaskOnSubs = min(firstSeen), firstSeenMonResIpMaskOnSubs = min(firstSeenOnMonRes), firstSeenMonOpIpMaskOnSubs = min(firstSeenOnMonOp) by subscriptionId, clientIpMask) \n        on subscriptionId, clientIpMask\n| join kind = leftouter (modelData | summarize countEventsOnSub = sum(countEvents), countEventsMonResOnSub = sum(countMonRes),  countEventsMonOpOnSub = sum(counMonOp)\n    , firstSeenOnSubs = min(firstSeen), firstSeenMonResOnSubs = min(firstSeenOnMonRes), firstSeenMonOpOnSubs = min(firstSeenOnMonOp)\n    , countCallersOnSubs = dcount(Caller), countIpMasksOnSubs = dcount(clientIpMask) by subscriptionId)\n        on subscriptionId        \n| project-away subscriptionId1, Caller1, subscriptionId2\n| extend daysOnSubs = datetime_diff('day', timeSlice, firstSeenOnSubs)\n| extend avgMonOpOnSubs = floor(1.0*countEventsMonOpOnSub/daysOnSubs, 0.01), avgMonResOnSubs = floor(1.0*countEventsMonResOnSub/daysOnSubs, 0.01)\n| join kind = leftouter(monOpProbs) on $left.subscriptionId == $right._scope, $left.Caller == $right._A\n| project-away _A, _B, _scope\n| sort by subscriptionId asc, TimeGenerated asc\n| extend rnOnSubs = row_number(1, subscriptionId != prev(subscriptionId))\n| sort by subscriptionId asc, Caller asc, TimeGenerated asc\n| extend rnOnCallerSubs = row_number(1, (subscriptionId != prev(subscriptionId) and (Caller != prev(Caller))))\n| extend newCaller = iff(isempty(firstSeenPrincOnSubs), 1, 0)\n    , newCallerOnMonRes = iff(isempty(firstSeenMonResPrincOnSubs), 1, 0)\n    , newIpMask = iff(isempty(firstSeenIpMaskOnSubs), 1, 0)\n    , newIpMaskOnMonRes = iff(isempty(firstSeenMonResIpMaskOnSubs), 1, 0)\n    , newMonOpOnSubs = iff(isempty(firstSeenMonResOnSubs), 1, 0)\n    , anomCallerMonRes = iff(((Jaccard_AB <= 0.1) or (P_AIB <= 0.1)), 1, 0)\n| project TimeGenerated, subscriptionId,  ResourceProvider, ResourceName, OperationNameValue, Caller, CorrelationId, ClientIP=clientIp, ActiveDaysOnSub=daysOnSubs, avgMonOpOnSubs, newCaller, newCallerOnMonRes, newIpMask, newIpMaskOnMonRes, newMonOpOnSubs, anomCallerMonRes, isMonitoredOp, isMonitoredResource\n| order by TimeGenerated\n| where isMonitoredOp == 1\n// Optional - focus only on monitored operations or monitored resource in detection window\n| where isMonitoredOp == 1\n//| where isMonitoredResource == 1\n",
                                "version": 2,
                                "tags": [
                                  {
                                    "name": "description",
                                    "value": "This query identifies Azure Operation anomalies during threat hunts. It detects new callers, IPs, IP ranges, and anomalous operations. Initially set for Run Command operations, it can be configured for other operations and resource types."
                                  },
                                  {
                                    "name": "tactics",
                                    "value": "LateralMovement,CredentialAccess"
                                  },
                                  {
                                    "name": "techniques",
                                    "value": "T1570,T1078.004"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject2')._huntingQuerycontentId2),'/'))))]",
                              "properties": {
                                "description": "Azure Activity Hunting Query 2",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject2')._huntingQuerycontentId2)]",
                                "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject2').huntingQueryVersion2]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
                        "contentKind": "HuntingQuery",
                        "displayName": "Anomalous Azure Operation Hunting Model",
                        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject2')._huntingQuerycontentId2,'-', '2.0.0')))]",
                        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject2')._huntingQuerycontentId2,'-', '2.0.0')))]",
                        "version": "2.0.0"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('huntingQueryObject3').huntingQueryTemplateSpecName3]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Anomalous_Listing_Of_Storage_Keys_HuntingQueries Hunting Query with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('huntingQueryObject3').huntingQueryVersion3]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/savedSearches",
                              "apiVersion": "2022-10-01",
                              "name": "Azure_Activity_Hunting_Query_3",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "eTag": "*",
                                "displayName": "Azure storage key enumeration",
                                "category": "Hunting Queries",
                                "query": "AzureActivity\n| where OperationNameValue =~ \"microsoft.storage/storageaccounts/listkeys/action\"\n| where ActivityStatusValue =~ \"Succeeded\" \n| join kind= inner (\n    AzureActivity\n    | where OperationNameValue =~ \"microsoft.storage/storageaccounts/listkeys/action\"\n    | where ActivityStatusValue =~ \"Succeeded\" \n    | project ExpectedIpAddress=CallerIpAddress, Caller \n    | evaluate autocluster()\n) on Caller\n| where CallerIpAddress != ExpectedIpAddress\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), ResourceIds = make_set(ResourceId,100), ResourceIdCount = dcount(ResourceId) by OperationNameValue, Caller, CallerIpAddress\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_UPNSuffix = UPNSuffix\n| extend IP_0_Address = CallerIpAddress\n",
                                "version": 2,
                                "tags": [
                                  {
                                    "name": "description",
                                    "value": "Azure's storage key listing can expose secrets, PII, and grant VM access. Monitoring for anomalous accounts or IPs is crucial. The query generates IP clusters, correlates activities, and flags unexpected ones. Single-operation users are excluded."
                                  },
                                  {
                                    "name": "tactics",
                                    "value": "Discovery"
                                  },
                                  {
                                    "name": "techniques",
                                    "value": "T1087"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject3')._huntingQuerycontentId3),'/'))))]",
                              "properties": {
                                "description": "Azure Activity Hunting Query 3",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject3')._huntingQuerycontentId3)]",
                                "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject3').huntingQueryVersion3]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
                        "contentKind": "HuntingQuery",
                        "displayName": "Azure storage key enumeration",
                        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject3')._huntingQuerycontentId3,'-', '2.0.1')))]",
                        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject3')._huntingQuerycontentId3,'-', '2.0.1')))]",
                        "version": "2.0.1"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('huntingQueryObject4').huntingQueryTemplateSpecName4]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AzureAdministrationFromVPS_HuntingQueries Hunting Query with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('huntingQueryObject4').huntingQueryVersion4]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/savedSearches",
                              "apiVersion": "2022-10-01",
                              "name": "Azure_Activity_Hunting_Query_4",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "eTag": "*",
                                "displayName": "AzureActivity Administration From VPS Providers",
                                "category": "Hunting Queries",
                                "query": "let IP_Data = (externaldata(network:string)\n[@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/VPS_Networks.csv\"] with (format=\"csv\"));\nAzureActivity\n| where CategoryValue =~ \"Administrative\"\n| evaluate ipv4_lookup(IP_Data, CallerIpAddress, network, return_unmatched = false)\n| summarize Operations = make_set(OperationNameValue), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by CallerIpAddress, Caller\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_UPNSuffix = UPNSuffix\n| extend IP_0_Address = CallerIpAddress\n",
                                "version": 2,
                                "tags": [
                                  {
                                    "name": "description",
                                    "value": "Looks for administrative actions in AzureActivity from known VPS provider network ranges.\nThis is not an exhaustive list of VPS provider ranges but covers some of the most prevalent providers observed."
                                  },
                                  {
                                    "name": "tactics",
                                    "value": "InitialAccess"
                                  },
                                  {
                                    "name": "techniques",
                                    "value": "T1078"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject4')._huntingQuerycontentId4),'/'))))]",
                              "properties": {
                                "description": "Azure Activity Hunting Query 4",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject4')._huntingQuerycontentId4)]",
                                "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject4').huntingQueryVersion4]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
                        "contentKind": "HuntingQuery",
                        "displayName": "AzureActivity Administration From VPS Providers",
                        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject4')._huntingQuerycontentId4,'-', '2.0.1')))]",
                        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject4')._huntingQuerycontentId4,'-', '2.0.1')))]",
                        "version": "2.0.1"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('huntingQueryObject5').huntingQueryTemplateSpecName5]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AzureNSG_AdministrativeOperations_HuntingQueries Hunting Query with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('huntingQueryObject5').huntingQueryVersion5]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/savedSearches",
                              "apiVersion": "2022-10-01",
                              "name": "Azure_Activity_Hunting_Query_5",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "eTag": "*",
                                "displayName": "Azure Network Security Group NSG Administrative Operations",
                                "category": "Hunting Queries",
                                "query": "let opValues = dynamic([\"Microsoft.Network/networkSecurityGroups/write\", \"Microsoft.Network/networkSecurityGroups/delete\"]);\n// Azure NSG Create / Update / Delete\nAzureActivity\n| where Category =~ \"Administrative\"\n| where OperationNameValue in~ (opValues)\n| where ActivitySubstatusValue in~ (\"Created\", \"OK\",\"Accepted\")\n| sort by TimeGenerated desc\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_UPNSuffix = UPNSuffix\n| extend IP_0_Address = CallerIpAddress\n",
                                "version": 2,
                                "tags": [
                                  {
                                    "name": "description",
                                    "value": "Identifies a set of Azure NSG administrative and operational detection queries for hunting activities."
                                  },
                                  {
                                    "name": "tactics",
                                    "value": "Impact"
                                  },
                                  {
                                    "name": "techniques",
                                    "value": "T1496"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject5')._huntingQuerycontentId5),'/'))))]",
                              "properties": {
                                "description": "Azure Activity Hunting Query 5",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject5')._huntingQuerycontentId5)]",
                                "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject5').huntingQueryVersion5]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
                        "contentKind": "HuntingQuery",
                        "displayName": "Azure Network Security Group NSG Administrative Operations",
                        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject5')._huntingQuerycontentId5,'-', '2.0.1')))]",
                        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject5')._huntingQuerycontentId5,'-', '2.0.1')))]",
                        "version": "2.0.1"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('huntingQueryObject6').huntingQueryTemplateSpecName6]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AzureRunCommandFromAzureIP_HuntingQueries Hunting Query with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('huntingQueryObject6').huntingQueryVersion6]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/savedSearches",
                              "apiVersion": "2022-10-01",
                              "name": "Azure_Activity_Hunting_Query_6",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "eTag": "*",
                                "displayName": "Azure VM Run Command executed from Azure IP address",
                                "category": "Hunting Queries",
                                "query": "let azure_ranges = externaldata(changeNumber: string, cloud: string, values: dynamic)\n[\"https://raw.githubusercontent.com/microsoft/mstic/master/PublicFeeds/MSFTIPRanges/ServiceTags_Public.json\"] with(format='multijson')\n| mv-expand values\n| extend Name = values.name, AddressPrefixes = values.properties.addressPrefixes\n| where Name startswith \"WindowsVirtualDesktop\"\n| mv-expand AddressPrefixes\n| summarize by tostring(AddressPrefixes);\nAzureActivity\n| where TimeGenerated > ago(30d)\n// Isolate run command actions\n| where OperationNameValue == \"Microsoft.Compute/virtualMachines/runCommand/action\"\n// Confirm that the operation impacted a virtual machine\n| where Authorization has \"virtualMachines\"\n// Each runcommand operation consists of three events when successful, Started, Accepted (or Rejected), Successful (or Failed).\n| summarize StartTime=min(TimeGenerated), EndTime=max(TimeGenerated), max(CallerIpAddress), make_list(ActivityStatusValue) by CorrelationId, Authorization, Caller\n// Limit to Run Command executions that Succeeded\n| where list_ActivityStatusValue has \"Succeeded\"\n// Extract data from the Authorization field, allowing us to later extract the Caller (UPN) and CallerIpAddress\n| extend Authorization_d = parse_json(Authorization)\n| extend Scope = Authorization_d.scope\n| extend Scope_s = split(Scope, \"/\")\n| extend Subscription = tostring(Scope_s[2])\n| extend VirtualMachineName = tostring(Scope_s[-1])\n| project StartTime, EndTime, Subscription, VirtualMachineName, CorrelationId, Caller, CallerIpAddress=max_CallerIpAddress\n| evaluate ipv4_lookup(azure_ranges, CallerIpAddress, AddressPrefixes)\n| extend IP_0_Address = CallerIpAddress\n",
                                "version": 2,
                                "tags": [
                                  {
                                    "name": "description",
                                    "value": "Identifies any Azure VM Run Command operation executed from an Azure IP address.\nRun Command allows an attacker or legitimate user to execute arbitrary PowerShell\non a target VM. This technique has been seen in use by NOBELIUM."
                                  },
                                  {
                                    "name": "tactics",
                                    "value": "LateralMovement,CredentialAccess"
                                  },
                                  {
                                    "name": "techniques",
                                    "value": "T1570,T1078.004"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject6')._huntingQuerycontentId6),'/'))))]",
                              "properties": {
                                "description": "Azure Activity Hunting Query 6",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject6')._huntingQuerycontentId6)]",
                                "contentId": "[variables('huntingQueryObject6')._huntingQuerycontentId6]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject6').huntingQueryVersion6]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('huntingQueryObject6')._huntingQuerycontentId6]",
                        "contentKind": "HuntingQuery",
                        "displayName": "Azure VM Run Command executed from Azure IP address",
                        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject6')._huntingQuerycontentId6,'-', '2.1.1')))]",
                        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject6')._huntingQuerycontentId6,'-', '2.1.1')))]",
                        "version": "2.1.1"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('huntingQueryObject7').huntingQueryTemplateSpecName7]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AzureSentinelConnectors_AdministrativeOperations_HuntingQueries Hunting Query with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('huntingQueryObject7').huntingQueryVersion7]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/savedSearches",
                              "apiVersion": "2022-10-01",
                              "name": "Azure_Activity_Hunting_Query_7",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "eTag": "*",
                                "displayName": "Microsoft Sentinel Connectors Administrative Operations",
                                "category": "Hunting Queries",
                                "query": "let opValues = dynamic([\"Microsoft.SecurityInsights/dataConnectors/write\", \"Microsoft.SecurityInsights/dataConnectors/delete\"]);\n// Microsoft Sentinel Data Connectors Update / Delete\nAzureActivity\n| where OperationNameValue in~ (opValues)\n| where ActivitySubstatusValue in~ (\"Created\", \"OK\")\n| sort by TimeGenerated desc\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_UPNSuffix = UPNSuffix\n| extend IP_0_Address = CallerIpAddress\n",
                                "version": 2,
                                "tags": [
                                  {
                                    "name": "description",
                                    "value": "Identifies a set of Microsoft Sentinel Data Connectors for administrative and operational detection queries for hunting activities."
                                  },
                                  {
                                    "name": "tactics",
                                    "value": "Impact"
                                  },
                                  {
                                    "name": "techniques",
                                    "value": "T1496"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject7')._huntingQuerycontentId7),'/'))))]",
                              "properties": {
                                "description": "Azure Activity Hunting Query 7",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject7')._huntingQuerycontentId7)]",
                                "contentId": "[variables('huntingQueryObject7')._huntingQuerycontentId7]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject7').huntingQueryVersion7]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('huntingQueryObject7')._huntingQuerycontentId7]",
                        "contentKind": "HuntingQuery",
                        "displayName": "Microsoft Sentinel Connectors Administrative Operations",
                        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject7')._huntingQuerycontentId7,'-', '2.0.1')))]",
                        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject7')._huntingQuerycontentId7,'-', '2.0.1')))]",
                        "version": "2.0.1"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('huntingQueryObject8').huntingQueryTemplateSpecName8]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AzureSentinelWorkbooks_AdministrativeOperation_HuntingQueries Hunting Query with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('huntingQueryObject8').huntingQueryVersion8]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/savedSearches",
                              "apiVersion": "2022-10-01",
                              "name": "Azure_Activity_Hunting_Query_8",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "eTag": "*",
                                "displayName": "Microsoft Sentinel Workbooks Administrative Operations",
                                "category": "Hunting Queries",
                                "query": "let opValues = dynamic([\"microsoft.insights/workbooks/write\", \"microsoft.insights/workbooks/delete\"]);\n// Microsoft Sentinel Workbook Create / Update / Delete\nAzureActivity\n| where Category =~ \"Administrative\"\n| where OperationNameValue in~ (opValues)\n| where ActivitySubstatusValue in~ (\"Created\", \"OK\")\n| sort by TimeGenerated desc\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_UPNSuffix = UPNSuffix\n| extend IP_0_Address = CallerIpAddress\n",
                                "version": 2,
                                "tags": [
                                  {
                                    "name": "description",
                                    "value": "Identifies set of Microsoft Sentinel Workbooks administrative operational detection queries for hunting activites"
                                  },
                                  {
                                    "name": "tactics",
                                    "value": "Impact"
                                  },
                                  {
                                    "name": "techniques",
                                    "value": "T1496"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject8')._huntingQuerycontentId8),'/'))))]",
                              "properties": {
                                "description": "Azure Activity Hunting Query 8",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject8')._huntingQuerycontentId8)]",
                                "contentId": "[variables('huntingQueryObject8')._huntingQuerycontentId8]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject8').huntingQueryVersion8]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('huntingQueryObject8')._huntingQuerycontentId8]",
                        "contentKind": "HuntingQuery",
                        "displayName": "Microsoft Sentinel Workbooks Administrative Operations",
                        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject8')._huntingQuerycontentId8,'-', '2.0.1')))]",
                        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject8')._huntingQuerycontentId8,'-', '2.0.1')))]",
                        "version": "2.0.1"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('huntingQueryObject9').huntingQueryTemplateSpecName9]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AzureVirtualNetworkSubnets_AdministrativeOperationset_HuntingQueries Hunting Query with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('huntingQueryObject9').huntingQueryVersion9]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/savedSearches",
                              "apiVersion": "2022-10-01",
                              "name": "Azure_Activity_Hunting_Query_9",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "eTag": "*",
                                "displayName": "Azure Virtual Network Subnets Administrative Operations",
                                "category": "Hunting Queries",
                                "query": "let opValues = dynamic([\"Microsoft.Network/virtualNetworks/subnets/write\",\"Microsoft.Network/virtualNetworks/subnets/delete\"]);\n// Creating, Updating or Deleting Virtual Network Subnets\nAzureActivity\n| where CategoryValue =~ \"Administrative\"\n| where OperationNameValue in~ (opValues)\n| where ActivitySubstatusValue in~ (\"Created\",\"Accepted\")\n| sort by TimeGenerated desc\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_UPNSuffix = UPNSuffix\n| extend IP_0_Address = CallerIpAddress\n",
                                "version": 2,
                                "tags": [
                                  {
                                    "name": "description",
                                    "value": "Identifies a set of Azure Virtual Network Subnets for administrative and operational detection queries for hunting activities."
                                  },
                                  {
                                    "name": "tactics",
                                    "value": "Impact"
                                  },
                                  {
                                    "name": "techniques",
                                    "value": "T1496"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject9')._huntingQuerycontentId9),'/'))))]",
                              "properties": {
                                "description": "Azure Activity Hunting Query 9",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject9')._huntingQuerycontentId9)]",
                                "contentId": "[variables('huntingQueryObject9')._huntingQuerycontentId9]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject9').huntingQueryVersion9]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('huntingQueryObject9')._huntingQuerycontentId9]",
                        "contentKind": "HuntingQuery",
                        "displayName": "Azure Virtual Network Subnets Administrative Operations",
                        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject9')._huntingQuerycontentId9,'-', '2.0.1')))]",
                        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject9')._huntingQuerycontentId9,'-', '2.0.1')))]",
                        "version": "2.0.1"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('huntingQueryObject10').huntingQueryTemplateSpecName10]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Common_Deployed_Resources_HuntingQueries Hunting Query with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('huntingQueryObject10').huntingQueryVersion10]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/savedSearches",
                              "apiVersion": "2022-10-01",
                              "name": "Azure_Activity_Hunting_Query_10",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "eTag": "*",
                                "displayName": "Common deployed resources",
                                "category": "Hunting Queries",
                                "query": "AzureActivity\n| where OperationNameValue has_any (@\"deployments/write\", @\"virtualMachines/write\")  \n| where ActivityStatusValue =~ \"Succeeded\"\n| summarize by bin(TimeGenerated,1d), Resource, ResourceGroup, ResourceId, OperationNameValue, Caller\n| evaluate basket()\n| where isnotempty(Caller) and isnotempty(Resource) and isnotempty(TimeGenerated)\n| order by Percent desc, TimeGenerated desc\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_UPNSuffix = UPNSuffix\n| extend AzureResource_0_ResourceId = ResourceId\n// remove comments below on filters if the goal is to see more common or more rare Resource, Resource Group and Caller combinations\n//| where Percent <= 40 // <-- more rare\n//| where Percent >= 60 // <-- more common\n",
                                "version": 2,
                                "tags": [
                                  {
                                    "name": "description",
                                    "value": "This query identifies common deployed resources in Azure, like resource names and groups. It can be used with other suspicious deployment signals to evaluate if a resource is commonly deployed or unique."
                                  },
                                  {
                                    "name": "tactics",
                                    "value": "Impact"
                                  },
                                  {
                                    "name": "techniques",
                                    "value": "T1496"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject10')._huntingQuerycontentId10),'/'))))]",
                              "properties": {
                                "description": "Azure Activity Hunting Query 10",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject10')._huntingQuerycontentId10)]",
                                "contentId": "[variables('huntingQueryObject10')._huntingQuerycontentId10]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject10').huntingQueryVersion10]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('huntingQueryObject10')._huntingQuerycontentId10]",
                        "contentKind": "HuntingQuery",
                        "displayName": "Common deployed resources",
                        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject10')._huntingQuerycontentId10,'-', '2.0.1')))]",
                        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject10')._huntingQuerycontentId10,'-', '2.0.1')))]",
                        "version": "2.0.1"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('huntingQueryObject11').huntingQueryTemplateSpecName11]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Creating_Anomalous_Number_Of_Resources_HuntingQueries Hunting Query with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('huntingQueryObject11').huntingQueryVersion11]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/savedSearches",
                              "apiVersion": "2022-10-01",
                              "name": "Azure_Activity_Hunting_Query_11",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "eTag": "*",
                                "displayName": "Creation of an anomalous number of resources",
                                "category": "Hunting Queries",
                                "query": "AzureActivity\n| where OperationNameValue in~ (\"microsoft.compute/virtualMachines/write\", \"microsoft.resources/deployments/write\")\n| where ActivityStatusValue == \"Succeeded\" \n| make-series dcount(ResourceId)  default=0 on EventSubmissionTimestamp in range(ago(7d), now(), 1d) by Caller\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_UPNSuffix = UPNSuffix\n",
                                "version": 2,
                                "tags": [
                                  {
                                    "name": "description",
                                    "value": "Looks for anomalous number of resources creation or deployment activities in azure activity log.\nIt is best to run this query on a look back period which is at least 7 days."
                                  },
                                  {
                                    "name": "tactics",
                                    "value": "Impact"
                                  },
                                  {
                                    "name": "techniques",
                                    "value": "T1496"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject11')._huntingQuerycontentId11),'/'))))]",
                              "properties": {
                                "description": "Azure Activity Hunting Query 11",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject11')._huntingQuerycontentId11)]",
                                "contentId": "[variables('huntingQueryObject11')._huntingQuerycontentId11]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject11').huntingQueryVersion11]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('huntingQueryObject11')._huntingQuerycontentId11]",
                        "contentKind": "HuntingQuery",
                        "displayName": "Creation of an anomalous number of resources",
                        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject11')._huntingQuerycontentId11,'-', '2.0.1')))]",
                        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject11')._huntingQuerycontentId11,'-', '2.0.1')))]",
                        "version": "2.0.1"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('huntingQueryObject12').huntingQueryTemplateSpecName12]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Granting_Permissions_to_Account_HuntingQueries Hunting Query with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('huntingQueryObject12').huntingQueryVersion12]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/savedSearches",
                              "apiVersion": "2022-10-01",
                              "name": "Azure_Activity_Hunting_Query_12",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "eTag": "*",
                                "displayName": "Granting permissions to account",
                                "category": "Hunting Queries",
                                "query": "AzureActivity\n| where OperationName =~ \"Create role assignment\"\n| where ActivityStatus =~ \"Succeeded\" \n| project Caller, CallerIpAddress\n| evaluate basket()\n// Returns all the records from the left side and only matching records from the right side.\n| join kind=leftouter (AzureActivity\n| where OperationName =~ \"Create role assignment\"\n| where ActivityStatus =~ \"Succeeded\"\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by Caller, CallerIpAddress)\non Caller, CallerIpAddress\n| project-away Caller1, CallerIpAddress1\n| where isnotempty(StartTime)\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_UPNSuffix = UPNSuffix\n| extend IP_0_Address = CallerIpAddress\n",
                                "version": 2,
                                "tags": [
                                  {
                                    "name": "description",
                                    "value": "Shows the most prevalent users who grant access to others on Azure resources. List the common source IP address for each of those accounts. If an operation is not from those IP addresses, it may be worthy of investigation."
                                  },
                                  {
                                    "name": "tactics",
                                    "value": "Persistence,PrivilegeEscalation"
                                  },
                                  {
                                    "name": "techniques",
                                    "value": "T1098"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject12')._huntingQuerycontentId12),'/'))))]",
                              "properties": {
                                "description": "Azure Activity Hunting Query 12",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject12')._huntingQuerycontentId12)]",
                                "contentId": "[variables('huntingQueryObject12')._huntingQuerycontentId12]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject12').huntingQueryVersion12]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('huntingQueryObject12')._huntingQuerycontentId12]",
                        "contentKind": "HuntingQuery",
                        "displayName": "Granting permissions to account",
                        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject12')._huntingQuerycontentId12,'-', '2.0.1')))]",
                        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject12')._huntingQuerycontentId12,'-', '2.0.1')))]",
                        "version": "2.0.1"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('huntingQueryObject13').huntingQueryTemplateSpecName13]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "PortOpenedForAzureResource_HuntingQueries Hunting Query with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('huntingQueryObject13').huntingQueryVersion13]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/savedSearches",
                              "apiVersion": "2022-10-01",
                              "name": "Azure_Activity_Hunting_Query_13",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "eTag": "*",
                                "displayName": "Port opened for an Azure Resource",
                                "category": "Hunting Queries",
                                "query": "let lookback = 7d;\nAzureActivity\n| where TimeGenerated >= ago(lookback)\n| where OperationNameValue has_any (\"ipfilterrules\", \"securityRules\", \"publicIPAddresses\", \"firewallrules\") and OperationNameValue endswith \"write\"\n// Choosing Accepted here because it has the Rule Attributes included\n| where ActivityStatusValue == \"Accepted\" \n// If there is publicIP info, include it\n| extend parsed_properties = parse_json(tostring(parse_json(Properties).responseBody)).properties\n| extend publicIPAddressVersion = case(Properties has_cs 'publicIPAddressVersion',tostring(parsed_properties.publicIPAddressVersion),\"\")\n| extend publicIPAllocationMethod = case(Properties has_cs 'publicIPAllocationMethod',tostring(parsed_properties.publicIPAllocationMethod),\"\")\n// Include rule attributes for context\n| extend access = case(Properties has_cs 'access',tostring(parsed_properties.access),\"\")\n| extend description = case(Properties has_cs 'description',tostring(parsed_properties.description),\"\")\n| extend destinationPortRange = case(Properties has_cs 'destinationPortRange',tostring(parsed_properties.destinationPortRange),\"\")\n| extend direction = case(Properties has_cs 'direction',tostring(parsed_properties.direction),\"\")\n| extend protocol = case(Properties has_cs 'protocol',tostring(parsed_properties.protocol),\"\")\n| extend sourcePortRange = case(Properties has_cs 'sourcePortRange',tostring(parsed_properties.sourcePortRange),\"\")\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), ResourceIds = make_set(_ResourceId,100) by Caller, CallerIpAddress, Resource, ResourceGroup, \nActivityStatusValue, ActivitySubstatus, SubscriptionId, access, description, destinationPortRange, direction, protocol, sourcePortRange, publicIPAddressVersion, publicIPAllocationMethod\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_UPNSuffix = UPNSuffix\n| extend IP_0_Address = CallerIpAddress\n",
                                "version": 2,
                                "tags": [
                                  {
                                    "name": "description",
                                    "value": "Identifies what ports may have been opened for a given Azure Resource over the last 7 days"
                                  },
                                  {
                                    "name": "tactics",
                                    "value": "CommandAndControl,Impact"
                                  },
                                  {
                                    "name": "techniques",
                                    "value": "T1071,T1571,T1496"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject13')._huntingQuerycontentId13),'/'))))]",
                              "properties": {
                                "description": "Azure Activity Hunting Query 13",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject13')._huntingQuerycontentId13)]",
                                "contentId": "[variables('huntingQueryObject13')._huntingQuerycontentId13]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject13').huntingQueryVersion13]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('huntingQueryObject13')._huntingQuerycontentId13]",
                        "contentKind": "HuntingQuery",
                        "displayName": "Port opened for an Azure Resource",
                        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject13')._huntingQuerycontentId13,'-', '2.0.1')))]",
                        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject13')._huntingQuerycontentId13,'-', '2.0.1')))]",
                        "version": "2.0.1"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('huntingQueryObject14').huntingQueryTemplateSpecName14]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Rare_Custom_Script_Extension_HuntingQueries Hunting Query with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('huntingQueryObject14').huntingQueryVersion14]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/savedSearches",
                              "apiVersion": "2022-10-01",
                              "name": "Azure_Activity_Hunting_Query_14",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "eTag": "*",
                                "displayName": "Rare Custom Script Extension",
                                "category": "Hunting Queries",
                                "query": "let starttime = todatetime('{{StartTimeISO}}');\nlet endtime = todatetime('{{EndTimeISO}}');\nlet Lookback = starttime - 14d;\nlet CustomScriptExecution = AzureActivity\n| where TimeGenerated >= Lookback\n| where OperationName =~ \"Create or Update Virtual Machine Extension\"\n| extend parsed_properties = parse_json(Properties)\n| extend Settings = tostring((parse_json(tostring(parsed_properties.responseBody)).properties).settings)\n| parse Settings with * 'fileUris\":[' FileURI \"]\" *\n| parse Settings with * 'commandToExecute\":' commandToExecute '}' *\n| extend message_ = tostring((parse_json(tostring(parsed_properties.statusMessage)).error).message);\nlet LookbackCustomScriptExecution = CustomScriptExecution\n| where TimeGenerated >= Lookback and TimeGenerated < starttime\n| where isnotempty(FileURI) and isnotempty(commandToExecute)\n| summarize max(TimeGenerated), OperationCount = count() by Caller, Resource, CallerIpAddress, FileURI, commandToExecute;\nlet CurrentCustomScriptExecution = CustomScriptExecution\n| where TimeGenerated between (starttime..endtime)\n| where isnotempty(FileURI) and isnotempty(commandToExecute)\n| project TimeGenerated, ActivityStatus, OperationId, CorrelationId, ResourceId, CallerIpAddress, Caller, OperationName, Resource, ResourceGroup, FileURI, commandToExecute, FailureMessage = message_, HTTPRequest, Settings;\nlet RareCustomScriptExecution =  CurrentCustomScriptExecution\n| join kind= leftanti (LookbackCustomScriptExecution) on Caller, CallerIpAddress, FileURI, commandToExecute;\nlet IPCheck = RareCustomScriptExecution\n| summarize arg_max(TimeGenerated, OperationName), OperationIds = make_set(OperationId,100), CallerIpAddresses = make_set(CallerIpAddress,100) by ActivityStatus, CorrelationId, ResourceId, Caller, Resource, ResourceGroup, FileURI, commandToExecute, FailureMessage\n| extend IPArray = array_length(CallerIpAddresses);\n//Get IPs for later summarization so all associated CorrelationIds and Caller actions have an IP.  Success and Fails do not always have IP\nlet multiIP = IPCheck | where IPArray > 1\n| mv-expand CallerIpAddresses | extend CallerIpAddress = tostring(CallerIpAddresses)\n| where isnotempty(CallerIpAddresses);\nlet singleIP = IPCheck | where IPArray <= 1\n| mv-expand CallerIpAddresses | extend CallerIpAddress = tostring(CallerIpAddresses);\nlet FullDetails = singleIP | union multiIP;\n//Get IP address associated with successes and fails with no IP listed\nlet IPList = FullDetails | where isnotempty(CallerIpAddress) | summarize by CorrelationId, Caller, CallerIpAddress;\nlet EmptyIP = FullDetails | where isempty(CallerIpAddress) | project-away CallerIpAddress;\nlet IpJoin = EmptyIP | join kind= leftouter (IPList) on CorrelationId, Caller | project-away CorrelationId1, Caller1;\nlet nonEmptyIP = FullDetails | where isnotempty(CallerIpAddress);\nnonEmptyIP | union IpJoin\n// summarize all activities with a given CorrelationId and Caller together so we can provide a singular result\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), ActivityStatusSet = make_set(ActivityStatus,100), OperationIds = make_set(OperationIds,100), FailureMessages = make_set(FailureMessage,100) by CorrelationId, ResourceId, CallerIpAddress, Caller, Resource, ResourceGroup, FileURI, commandToExecute\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| extend Account_0_Name = Name\n| extend Account_0_UPNSuffix = UPNSuffix\n| extend IP_0_Address = CallerIpAddress\n",
                                "version": 2,
                                "tags": [
                                  {
                                    "name": "description",
                                    "value": "The Custom Script Extension in Azure executes scripts on VMs, useful for post-deployment tasks. Scripts can be from various sources and could be used maliciously. The query identifies rare custom script extensions executed in your environment."
                                  },
                                  {
                                    "name": "tactics",
                                    "value": "Execution"
                                  },
                                  {
                                    "name": "techniques",
                                    "value": "T1059"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject14')._huntingQuerycontentId14),'/'))))]",
                              "properties": {
                                "description": "Azure Activity Hunting Query 14",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject14')._huntingQuerycontentId14)]",
                                "contentId": "[variables('huntingQueryObject14')._huntingQuerycontentId14]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject14').huntingQueryVersion14]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('huntingQueryObject14')._huntingQuerycontentId14]",
                        "contentKind": "HuntingQuery",
                        "displayName": "Rare Custom Script Extension",
                        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject14')._huntingQuerycontentId14,'-', '2.0.1')))]",
                        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject14')._huntingQuerycontentId14,'-', '2.0.1')))]",
                        "version": "2.0.1"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('huntingQueryObject15').huntingQueryTemplateSpecName15]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Machine_Learning_Creation_HuntingQueries Hunting Query with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('huntingQueryObject15').huntingQueryVersion15]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.OperationalInsights/savedSearches",
                              "apiVersion": "2022-10-01",
                              "name": "Azure_Activity_Hunting_Query_15",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "eTag": "*",
                                "displayName": "Azure Machine Learning Write Operations",
                                "category": "Hunting Queries",
                                "query": "AzureActivity\n| where ResourceProviderValue == \"MICROSOFT.MACHINELEARNINGSERVICES\"  // Filter activities related to Microsoft Machine Learning Services\n| extend SCOPE = tostring(parse_json(Authorization).scope)  // Parse Authorization scope as string\n| extend subname = split(Hierarchy, \"/\")  // Split Hierarchy to extract Subscription Name and ID\n| extend ['Subscription Name'] = subname[-2], ['Subscription ID'] = subname[-1]  // Extract Subscription Name and ID\n| extend Properties = parse_json(Properties)  // Parse Properties as JSON\n| extend Properties_entity = tostring(Properties.entity)  // Cast Properties.entity to string\n| where isnotempty(Properties_entity)  // Filter activities where Properties.entity is not empty\n// | where Properties_entity contains \"deepseek\"  // Filter activities where Properties.entity contains \"deepseek\"\n| where OperationNameValue contains \"write\"  // Filter activities where OperationNameValue contains \"write\"\n| where OperationNameValue !contains \"MICROSOFT.AUTHORIZATION/ROLEASSIGNMENTS/WRITE\"  // Exclude role assignments\n| extend LLM = tostring(split(Properties_entity, \"/\")[-1])  // Extract the last segment of Properties_entity and cast it to string\n| distinct TimeGenerated, tostring(['Subscription Name']), ResourceGroup, tostring(['Subscription ID']), Caller, CallerIpAddress, OperationNameValue, LLM, _ResourceId  // Select distinct relevant fields for output\n",
                                "version": 2,
                                "tags": [
                                  {
                                    "name": "description",
                                    "value": "Shows the most prevalent users who perform write operations on Azure Machine Learning resources. List the common source IP address for each of those accounts. If an operation is not from those IP addresses, it may be worthy of investigation."
                                  },
                                  {
                                    "name": "tactics",
                                    "value": "InitialAccess,Execution,Impact"
                                  },
                                  {
                                    "name": "techniques",
                                    "value": "T1078,T1059,T1496"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject15')._huntingQuerycontentId15),'/'))))]",
                              "properties": {
                                "description": "Azure Activity Hunting Query 15",
                                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject15')._huntingQuerycontentId15)]",
                                "contentId": "[variables('huntingQueryObject15')._huntingQuerycontentId15]",
                                "kind": "HuntingQuery",
                                "version": "[variables('huntingQueryObject15').huntingQueryVersion15]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('huntingQueryObject15')._huntingQuerycontentId15]",
                        "contentKind": "HuntingQuery",
                        "displayName": "Azure Machine Learning Write Operations",
                        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject15')._huntingQuerycontentId15,'-', '1')))]",
                        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject15')._huntingQuerycontentId15,'-', '1')))]",
                        "version": "1"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AADHybridHealthADFSNewServer_AnalyticalRules Analytics Rule with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This detection uses AzureActivity logs (Administrative category) to identify the creation or update of a server instance in an Microsoft Entra ID Hybrid Health AD FS service.\nA threat actor can create a new AD Health ADFS service and create a fake server instance to spoof AD FS signing logs. There is no need to compromise an on-premises AD FS server.\nThis can be done programmatically via HTTP requests to Azure. More information in this blog: https://o365blog.com/post/hybridhealthagent/",
                                "displayName": "Microsoft Entra ID Hybrid Health AD FS New Server",
                                "enabled": false,
                                "query": "AzureActivity\n| where CategoryValue =~ 'Administrative'\n| where ResourceProviderValue =~ 'Microsoft.ADHybridHealthService'\n| where _ResourceId has 'AdFederationService'\n| where OperationNameValue =~ 'Microsoft.ADHybridHealthService/services/servicemembers/action'\n| extend claimsJson = parse_json(Claims)\n| extend AppId = tostring(claimsJson.appid), AccountName = tostring(claimsJson.name), Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| project-away claimsJson\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActivity",
                                    "dataTypes": [
                                      "AzureActivity"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "DefenseEvasion"
                                ],
                                "techniques": [
                                  "T1578"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Caller",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "CallerIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
                              "properties": {
                                "description": "Azure Activity Analytics Rule 1",
                                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Microsoft Entra ID Hybrid Health AD FS New Server",
                        "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
                        "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
                        "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject2').analyticRuleTemplateSpecName2]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AADHybridHealthADFSServiceDelete_AnalyticalRules Analytics Rule with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This detection uses AzureActivity logs (Administrative category) to identify the deletion of an Microsoft Entra ID Hybrid Health AD FS service instance in a tenant.\nA threat actor can create a new AD Health ADFS service and create a fake server to spoof AD FS signing logs.\nThe health AD FS service can then be deleted after it is no longer needed via HTTP requests to Azure.\nMore information is available in this blog https://o365blog.com/post/hybridhealthagent/",
                                "displayName": "Microsoft Entra ID Hybrid Health AD FS Service Delete",
                                "enabled": false,
                                "query": "AzureActivity\n| where CategoryValue =~ 'Administrative'\n| where ResourceProviderValue =~ 'Microsoft.ADHybridHealthService'\n| where _ResourceId has 'AdFederationService'\n| where OperationNameValue =~ 'Microsoft.ADHybridHealthService/services/delete'\n| extend claimsJson = parse_json(Claims)\n| extend AppId = tostring(claimsJson.appid), AccountName = tostring(claimsJson.name), Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| project-away claimsJson\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActivity",
                                    "dataTypes": [
                                      "AzureActivity"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "DefenseEvasion"
                                ],
                                "subTechniques": [
                                  "T1578.003"
                                ],
                                "techniques": [
                                  "T1578"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Caller",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "CallerIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject2').analyticRuleId2,'/'))))]",
                              "properties": {
                                "description": "Azure Activity Analytics Rule 2",
                                "parentId": "[variables('analyticRuleObject2').analyticRuleId2]",
                                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Microsoft Entra ID Hybrid Health AD FS Service Delete",
                        "contentProductId": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
                        "id": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
                        "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject3').analyticRuleTemplateSpecName3]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AADHybridHealthADFSSuspApp_AnalyticalRules Analytics Rule with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This detection uses AzureActivity logs (Administrative category) to identify a suspicious application adding a server instance to an Microsoft Entra ID Hybrid Health AD FS service or deleting the AD FS service instance.\nUsually the Microsoft Entra ID Connect Health Agent application with ID cf6d7e68-f018-4e0a-a7b3-126e053fb88d and ID cb1056e2-e479-49de-ae31-7812af012ed8 is used to perform those operations.",
                                "displayName": "Microsoft Entra ID Hybrid Health AD FS Suspicious Application",
                                "enabled": false,
                                "query": "// Microsoft Entra ID Connect Health Agent - cf6d7e68-f018-4e0a-a7b3-126e053fb88d\n// Microsoft Entra ID Connect - cb1056e2-e479-49de-ae31-7812af012ed8\nlet appList = dynamic(['cf6d7e68-f018-4e0a-a7b3-126e053fb88d','cb1056e2-e479-49de-ae31-7812af012ed8']);\nlet operationNamesList = dynamic(['Microsoft.ADHybridHealthService/services/servicemembers/action','Microsoft.ADHybridHealthService/services/delete']);\nAzureActivity\n| where CategoryValue =~ 'Administrative'\n| where ResourceProviderValue =~ 'Microsoft.ADHybridHealthService'\n| where _ResourceId has 'AdFederationService'\n| where OperationNameValue in~ (operationNamesList)\n| extend claimsJson = parse_json(Claims)\n| extend AppId = tostring(claimsJson.appid), AccountName = tostring(claimsJson.name), Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| where AppId !in (appList)\n| project-away claimsJson\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActivity",
                                    "dataTypes": [
                                      "AzureActivity"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess",
                                  "DefenseEvasion"
                                ],
                                "techniques": [
                                  "T1528",
                                  "T1550"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Caller",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "CallerIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject3').analyticRuleId3,'/'))))]",
                              "properties": {
                                "description": "Azure Activity Analytics Rule 3",
                                "parentId": "[variables('analyticRuleObject3').analyticRuleId3]",
                                "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Microsoft Entra ID Hybrid Health AD FS Suspicious Application",
                        "contentProductId": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
                        "id": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
                        "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject4').analyticRuleTemplateSpecName4]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Creating_Anomalous_Number_Of_Resources_detection_AnalyticalRules Analytics Rule with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Indicates when an anomalous number of VM creations or deployment activities occur in Azure via the AzureActivity log. This query generates the baseline pattern of cloud resource creation by an individual and generates an anomaly when any unusual spike is detected. These anomalies from unusual or privileged users could be an indication of a cloud infrastructure takedown by an adversary.",
                                "displayName": "Suspicious number of resource creation or deployment activities",
                                "enabled": false,
                                "query": "let szOperationNames = dynamic([\"microsoft.compute/virtualMachines/write\", \"microsoft.resources/deployments/write\"]);\nlet starttime = 7d;\nlet endtime = 1d;\nlet timeframe = 1d;\nlet TimeSeriesData =\nAzureActivity\n| where TimeGenerated between (startofday(ago(starttime)) .. startofday(now()))\n| where OperationNameValue in~ (szOperationNames)\n| project TimeGenerated, Caller \n| make-series Total = count() on TimeGenerated from startofday(ago(starttime)) to startofday(now()) step timeframe by Caller; \nTimeSeriesData\n| extend (anomalies, score, baseline) = series_decompose_anomalies(Total, 3, -1, 'linefit')\n| mv-expand Total to typeof(double), TimeGenerated to typeof(datetime), anomalies to typeof(double), score to typeof(double), baseline to typeof(long) \n| where TimeGenerated >= startofday(ago(endtime))\n| where anomalies > 0 and baseline > 0\n| project Caller, TimeGenerated, Total, baseline, anomalies, score\n| join (AzureActivity\n| where TimeGenerated > startofday(ago(endtime)) \n| where OperationNameValue in~ (szOperationNames)\n| summarize make_set(OperationNameValue,100), make_set(_ResourceId,100), make_set(CallerIpAddress,100) by bin(TimeGenerated, timeframe), Caller\n) on TimeGenerated, Caller\n| mv-expand CallerIpAddress=set_CallerIpAddress\n| project-away Caller1\n| extend Name = iif(Caller has '@',tostring(split(Caller,'@',0)[0]),\"\")\n| extend UPNSuffix = iif(Caller has '@',tostring(split(Caller,'@',1)[0]),\"\")\n| extend AadUserId = iif(Caller !has '@',Caller,\"\")\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P7D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActivity",
                                    "dataTypes": [
                                      "AzureActivity"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Impact"
                                ],
                                "techniques": [
                                  "T1496"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Caller",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "AadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "CallerIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject4').analyticRuleId4,'/'))))]",
                              "properties": {
                                "description": "Azure Activity Analytics Rule 4",
                                "parentId": "[variables('analyticRuleObject4').analyticRuleId4]",
                                "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Suspicious number of resource creation or deployment activities",
                        "contentProductId": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
                        "id": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
                        "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject5').analyticRuleTemplateSpecName5]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Creation_of_Expensive_Computes_in_Azure_AnalyticalRules Analytics Rule with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject5').analyticRuleVersion5]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies the creation of large size or expensive VMs (with GPUs or with a large number of virtual CPUs) in Azure.\nAn adversary may create new or update existing virtual machines to evade defenses or use them for cryptomining purposes.\nFor Windows/Linux Vm Sizes, see https://docs.microsoft.com/azure/virtual-machines/windows/sizes \nAzure VM Naming Conventions, see https://docs.microsoft.com/azure/virtual-machines/vm-naming-conventions",
                                "displayName": "Creation of expensive computes in Azure",
                                "enabled": false,
                                "query": "let tokens = dynamic([\"416\",\"208\",\"192\",\"128\",\"120\",\"96\",\"80\",\"72\",\"64\",\"48\",\"44\",\"40\",\"nc12\",\"nc24\",\"nv24\"]);\nlet operationList = dynamic([\"microsoft.compute/virtualmachines/write\", \"microsoft.resources/deployments/write\"]);\nAzureActivity\n| where OperationNameValue in~ (operationList)\n| where ActivityStatusValue startswith \"Accept\"\n| where Properties has 'vmSize'\n| extend parsed_property= parse_json(tostring((parse_json(Properties).responseBody))).properties\n| extend vmSize = tostring((parsed_property.hardwareProfile).vmSize)\n| mv-apply token=tokens to typeof(string) on (where vmSize contains token)\n| extend ComputerName = tostring((parsed_property.osProfile).computerName)\n| project TimeGenerated, OperationNameValue, ActivityStatusValue, Caller, CallerIpAddress, ComputerName, vmSize\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 1,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActivity",
                                    "dataTypes": [
                                      "AzureActivity"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "DefenseEvasion"
                                ],
                                "techniques": [
                                  "T1578"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Caller",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "ComputerName",
                                        "identifier": "HostName"
                                      }
                                    ],
                                    "entityType": "Host"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "CallerIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject5').analyticRuleId5,'/'))))]",
                              "properties": {
                                "description": "Azure Activity Analytics Rule 5",
                                "parentId": "[variables('analyticRuleObject5').analyticRuleId5]",
                                "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject5').analyticRuleVersion5]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Creation of expensive computes in Azure",
                        "contentProductId": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
                        "id": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
                        "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject6').analyticRuleTemplateSpecName6]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Granting_Permissions_To_Account_detection_AnalyticalRules Analytics Rule with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject6').analyticRuleVersion6]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies IPs from which users grant access to other users on Azure resources and alerts when a previously unseen source IP address is used.",
                                "displayName": "Suspicious granting of permissions to an account",
                                "enabled": false,
                                "query": "let starttime = 14d;\nlet endtime = 1d;\n// The number of operations above which an IP address is considered an unusual source of role assignment operations\nlet alertOperationThreshold = 5;\nlet AzureBuiltInRole = externaldata(Role:string,RoleDescription:string,ID:string) [@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/AzureBuiltInRole.csv\"] with (format=\"csv\", ignoreFirstRecord=True);\nlet createRoleAssignmentActivity = AzureActivity\n| where OperationNameValue =~ \"microsoft.authorization/roleassignments/write\";\nlet RoleAssignedActivity = createRoleAssignmentActivity \n| where TimeGenerated between (ago(starttime) .. ago(endtime))\n| summarize count() by CallerIpAddress, Caller, bin(TimeGenerated, 1d)\n| where count_ >= alertOperationThreshold\n// Returns all the records from the right side that don't have matches from the left.\n| join kind = rightanti ( \ncreateRoleAssignmentActivity\n| where TimeGenerated > ago(endtime)\n| extend parsed_property = tostring(parse_json(Properties).requestbody)\n| extend PrincipalId = case(parsed_property has_cs 'PrincipalId',parse_json(parsed_property).Properties.PrincipalId, parsed_property has_cs 'principalId',parse_json(parsed_property).properties.principalId,\"\")\n| extend PrincipalType = case(parsed_property has_cs 'PrincipalType',parse_json(parsed_property).Properties.PrincipalType, parsed_property has_cs 'principalType',parse_json(parsed_property).properties.principalType, \"\")\n| extend Scope = case(parsed_property has_cs 'Scope',parse_json(parsed_property).Properties.Scope, parsed_property has_cs 'scope',parse_json(parsed_property).properties.scope,\"\")\n| extend RoleAddedDetails = case(parsed_property has_cs 'RoleDefinitionId',parse_json(parsed_property).Properties.RoleDefinitionId,parsed_property has_cs 'roleDefinitionId',parse_json(parsed_property).properties.roleDefinitionId,\"\")\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ActivityTimeStamp = make_set(TimeGenerated), ActivityStatusValue = make_set(ActivityStatusValue), CorrelationId = make_set(CorrelationId), ActivityCountByCallerIPAddress = count()  \nby ResourceId, CallerIpAddress, Caller, OperationNameValue, Resource, ResourceGroup, PrincipalId, PrincipalType, Scope, RoleAddedDetails\n) on CallerIpAddress, Caller\n| extend timestamp = StartTimeUtc, AccountCustomEntity = Caller, IPCustomEntity = CallerIpAddress;\nlet RoleAssignedActivitywithRoleDetails = RoleAssignedActivity\n| extend RoleAssignedID = tostring(split(RoleAddedDetails, \"/\")[-1])\n// Returns all matching records from left and right sides.\n| join kind = inner (AzureBuiltInRole \n) on $left.RoleAssignedID == $right.ID;\nlet CallerIPCountSummary = RoleAssignedActivitywithRoleDetails | summarize AssignmentCountbyCaller = count() by Caller, CallerIpAddress;\nlet RoleAssignedActivityWithCount = RoleAssignedActivitywithRoleDetails | join kind = inner (CallerIPCountSummary | project Caller, AssignmentCountbyCaller, CallerIpAddress) on Caller, CallerIpAddress;\nRoleAssignedActivityWithCount\n| summarize arg_max(StartTimeUtc, *) by PrincipalId, RoleAssignedID\n// \tReturns all the records from the left side and only matching records from the right side.\n| join kind = leftouter( IdentityInfo\n| summarize arg_max(TimeGenerated, *) by AccountObjectId\n) on $left.PrincipalId == $right.AccountObjectId\n// Check if assignment count is greater than the threshold.\n| where AssignmentCountbyCaller >= alertOperationThreshold\n| project ActivityTimeStamp, OperationNameValue, Caller, CallerIpAddress, PrincipalId, RoleAssignedID, RoleAddedDetails, Role, RoleDescription, AccountUPN, AccountCreationTime, GroupMembership, UserType, ActivityStatusValue, ResourceGroup, PrincipalType, Scope, CorrelationId, timestamp, AccountCustomEntity, IPCustomEntity, AssignmentCountbyCaller\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P14D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActivity",
                                    "dataTypes": [
                                      "AzureActivity"
                                    ]
                                  },
                                  {
                                    "connectorId": "BehaviorAnalytics",
                                    "dataTypes": [
                                      "IdentityInfo"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Persistence",
                                  "PrivilegeEscalation"
                                ],
                                "techniques": [
                                  "T1098",
                                  "T1548"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Caller",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "CallerIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject6').analyticRuleId6,'/'))))]",
                              "properties": {
                                "description": "Azure Activity Analytics Rule 6",
                                "parentId": "[variables('analyticRuleObject6').analyticRuleId6]",
                                "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject6').analyticRuleVersion6]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Suspicious granting of permissions to an account",
                        "contentProductId": "[variables('analyticRuleObject6')._analyticRulecontentProductId6]",
                        "id": "[variables('analyticRuleObject6')._analyticRulecontentProductId6]",
                        "version": "[variables('analyticRuleObject6').analyticRuleVersion6]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject7').analyticRuleTemplateSpecName7]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "NRT-AADHybridHealthADFSNewServer_AnalyticalRules Analytics Rule with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject7').analyticRuleVersion7]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "NRT",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This detection uses AzureActivity logs (Administrative category) to identify the creation or update of a server instance in an Microsoft Entra ID Hybrid Health AD FS service.\nA threat actor can create a new AD Health ADFS service and create a fake server instance to spoof AD FS signing logs. There is no need to compromise an on-premises AD FS server.\nThis can be done programmatically via HTTP requests to Azure. More information in this blog: https://o365blog.com/post/hybridhealthagent/",
                                "displayName": "NRT Microsoft Entra ID Hybrid Health AD FS New Server",
                                "enabled": false,
                                "query": "AzureActivity\n| where CategoryValue =~ 'Administrative'\n| where ResourceProviderValue =~ 'Microsoft.ADHybridHealthService'\n| where _ResourceId has 'AdFederationService'\n| where OperationNameValue =~ 'Microsoft.ADHybridHealthService/services/servicemembers/action'\n| extend claimsJson = parse_json(Claims)\n| extend AppId = tostring(claimsJson.appid), AccountName = tostring(claimsJson.name), Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| project-away claimsJson\n",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActivity",
                                    "dataTypes": [
                                      "AzureActivity"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "DefenseEvasion"
                                ],
                                "techniques": [
                                  "T1578"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Caller",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "CallerIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject7').analyticRuleId7,'/'))))]",
                              "properties": {
                                "description": "Azure Activity Analytics Rule 7",
                                "parentId": "[variables('analyticRuleObject7').analyticRuleId7]",
                                "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject7').analyticRuleVersion7]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "NRT Microsoft Entra ID Hybrid Health AD FS New Server",
                        "contentProductId": "[variables('analyticRuleObject7')._analyticRulecontentProductId7]",
                        "id": "[variables('analyticRuleObject7')._analyticRulecontentProductId7]",
                        "version": "[variables('analyticRuleObject7').analyticRuleVersion7]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject8').analyticRuleTemplateSpecName8]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "NRT_Creation_of_Expensive_Computes_in_Azure_AnalyticalRules Analytics Rule with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject8').analyticRuleVersion8]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "NRT",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies the creation of large size or expensive VMs (with GPUs or with a large number of virtual CPUs) in Azure.\nAn adversary may create new or update existing virtual machines to evade defenses or use them for cryptomining purposes.\nFor Windows/Linux Vm Sizes, see https://docs.microsoft.com/azure/virtual-machines/windows/sizes \nAzure VM Naming Conventions, see https://docs.microsoft.com/azure/virtual-machines/vm-naming-conventions",
                                "displayName": "NRT Creation of expensive computes in Azure",
                                "enabled": false,
                                "query": "let tokens = dynamic([\"416\",\"208\",\"192\",\"128\",\"120\",\"96\",\"80\",\"72\",\"64\",\"48\",\"44\",\"40\",\"nc12\",\"nc24\",\"nv24\"]);\nlet operationList = dynamic([\"microsoft.compute/virtualmachines/write\", \"microsoft.resources/deployments/write\"]);\nAzureActivity\n| where OperationNameValue in~ (operationList)\n| where ActivityStatusValue startswith \"Accept\"\n| where Properties has 'vmSize'\n| extend parsed_property= parse_json(tostring((parse_json(Properties).responseBody))).properties\n| extend vmSize = tostring((parsed_property.hardwareProfile).vmSize)\n| mv-apply token=tokens to typeof(string) on (where vmSize contains token)\n| extend ComputerName = tostring((parsed_property.osProfile).computerName)\n| project TimeGenerated, OperationNameValue, ActivityStatusValue, Caller, CallerIpAddress, ComputerName, vmSize\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActivity",
                                    "dataTypes": [
                                      "AzureActivity"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "DefenseEvasion"
                                ],
                                "techniques": [
                                  "T1578"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Caller",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "ComputerName",
                                        "identifier": "HostName"
                                      }
                                    ],
                                    "entityType": "Host"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "CallerIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject8').analyticRuleId8,'/'))))]",
                              "properties": {
                                "description": "Azure Activity Analytics Rule 8",
                                "parentId": "[variables('analyticRuleObject8').analyticRuleId8]",
                                "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject8').analyticRuleVersion8]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "NRT Creation of expensive computes in Azure",
                        "contentProductId": "[variables('analyticRuleObject8')._analyticRulecontentProductId8]",
                        "id": "[variables('analyticRuleObject8')._analyticRulecontentProductId8]",
                        "version": "[variables('analyticRuleObject8').analyticRuleVersion8]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject9').analyticRuleTemplateSpecName9]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "New-CloudShell-User_AnalyticalRules Analytics Rule with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject9').analyticRuleVersion9]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies when a user creates an Azure CloudShell for the first time.\nMonitor this activity to ensure only the expected users are using CloudShell.",
                                "displayName": "New CloudShell User",
                                "enabled": false,
                                "query": "let match_window = 3m;\nAzureActivity\n| where ResourceGroup has \"cloud-shell\"\n| where (OperationNameValue =~ \"Microsoft.Storage/storageAccounts/listKeys/action\")\n| where ActivityStatusValue =~ \"Success\"\n| extend TimeKey = bin(TimeGenerated, match_window), AzureIP = CallerIpAddress\n| join kind = inner\n(AzureActivity\n| where ResourceGroup has \"cloud-shell\"\n| where (OperationNameValue =~ \"Microsoft.Storage/storageAccounts/write\")\n| extend TimeKey = bin(TimeGenerated, match_window), UserIP = CallerIpAddress\n) on Caller, TimeKey\n| summarize count() by TimeKey, Caller, ResourceGroup, SubscriptionId, TenantId, AzureIP, UserIP, HTTPRequest, Type, Properties, CategoryValue, OperationList = strcat(OperationNameValue, ' , ', OperationNameValue1)\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActivity",
                                    "dataTypes": [
                                      "AzureActivity"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Execution"
                                ],
                                "techniques": [
                                  "T1059"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Caller",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserIP",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject9').analyticRuleId9,'/'))))]",
                              "properties": {
                                "description": "Azure Activity Analytics Rule 9",
                                "parentId": "[variables('analyticRuleObject9').analyticRuleId9]",
                                "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject9').analyticRuleVersion9]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "New CloudShell User",
                        "contentProductId": "[variables('analyticRuleObject9')._analyticRulecontentProductId9]",
                        "id": "[variables('analyticRuleObject9')._analyticRulecontentProductId9]",
                        "version": "[variables('analyticRuleObject9').analyticRuleVersion9]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject10').analyticRuleTemplateSpecName10]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "NewResourceGroupsDeployedTo_AnalyticalRules Analytics Rule with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject10').analyticRuleVersion10]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies when a rare Resource and ResourceGroup deployment occurs by a previously unseen caller.",
                                "displayName": "Suspicious Resource deployment",
                                "enabled": false,
                                "query": "// Add or remove operation names below as per your requirements. For operations lists, please refer to https://learn.microsoft.com/en-us/Azure/role-based-access-control/resource-provider-operations#all\nlet szOperationNames = dynamic([\"Microsoft.Compute/virtualMachines/write\", \"Microsoft.Resources/deployments/write\", \"Microsoft.Resources/subscriptions/resourceGroups/write\"]);\nlet starttime = 14d;\nlet endtime = 1d;\nlet RareCaller = AzureActivity\n| where TimeGenerated between (ago(starttime) .. ago(endtime))\n| where OperationNameValue in~ (szOperationNames)\n| summarize count() by CallerIpAddress, Caller, OperationNameValue, bin(TimeGenerated,1d)\n// Returns all the records from the right side that don't have matches from the left.\n| join kind=rightantisemi (\nAzureActivity\n| where TimeGenerated > ago(endtime)\n| where OperationNameValue in~ (szOperationNames)\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ActivityTimeStamp = make_set(TimeGenerated,100), ActivityStatusValue = make_set(ActivityStatusValue,100), CorrelationIds = make_set(CorrelationId,100), ResourceGroups = make_set(ResourceGroup,100), ResourceIds = make_set(_ResourceId,100), ActivityCountByCallerIPAddress = count()\nby CallerIpAddress, Caller, OperationNameValue) on CallerIpAddress, Caller, OperationNameValue;\nRareCaller\n| extend Name = iif(Caller has '@',tostring(split(Caller,'@',0)[0]),\"\")\n| extend UPNSuffix = iif(Caller has '@',tostring(split(Caller,'@',1)[0]),\"\")\n| extend AadUserId = iif(Caller !has '@',Caller,\"\")\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P14D",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActivity",
                                    "dataTypes": [
                                      "AzureActivity"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Impact"
                                ],
                                "techniques": [
                                  "T1496"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Caller",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "AadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "CallerIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject10').analyticRuleId10,'/'))))]",
                              "properties": {
                                "description": "Azure Activity Analytics Rule 10",
                                "parentId": "[variables('analyticRuleObject10').analyticRuleId10]",
                                "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject10').analyticRuleVersion10]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Suspicious Resource deployment",
                        "contentProductId": "[variables('analyticRuleObject10')._analyticRulecontentProductId10]",
                        "id": "[variables('analyticRuleObject10')._analyticRulecontentProductId10]",
                        "version": "[variables('analyticRuleObject10').analyticRuleVersion10]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject11').analyticRuleTemplateSpecName11]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "RareOperations_AnalyticalRules Analytics Rule with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject11').analyticRuleVersion11]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This query looks for a few sensitive subscription-level events based on Azure Activity Logs. For example, this monitors for the operation name 'Create or Update Snapshot', which is used for creating backups but could be misused by attackers to dump hashes or extract sensitive information from the disk.",
                                "displayName": "Rare subscription-level operations in Azure",
                                "enabled": false,
                                "query": "let starttime = 14d;\nlet endtime = 1d;\n// The number of operations above which an IP address is considered an unusual source of role assignment operations\nlet alertOperationThreshold = 5;\n// Add or remove operation names below as per your requirements. For operations lists, please refer to https://learn.microsoft.com/en-us/Azure/role-based-access-control/resource-provider-operations#all\nlet SensitiveOperationList =  dynamic([\"microsoft.compute/snapshots/write\", \"microsoft.network/networksecuritygroups/write\", \"microsoft.storage/storageaccounts/listkeys/action\"]);\nlet SensitiveActivity = AzureActivity\n| where OperationNameValue in~ (SensitiveOperationList) or OperationNameValue hassuffix \"listkeys/action\"\n| where ActivityStatusValue =~ \"Success\";\nSensitiveActivity\n| where TimeGenerated between (ago(starttime) .. ago(endtime))\n| summarize count() by CallerIpAddress, Caller, OperationNameValue, bin(TimeGenerated,1d)\n| where count_ >= alertOperationThreshold\n// Returns all the records from the right side that don't have matches from the left\n| join kind = rightanti (\nSensitiveActivity\n| where TimeGenerated >= ago(endtime)\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ActivityTimeStamp = make_list(TimeGenerated), ActivityStatusValue = make_list(ActivityStatusValue), CorrelationIds = make_list(CorrelationId), ResourceGroups = make_list(ResourceGroup), ResourceIds = make_list(_ResourceId), ActivityCountByCallerIPAddress = count()\nby CallerIpAddress, Caller, OperationNameValue\n| where ActivityCountByCallerIPAddress >= alertOperationThreshold\n) on CallerIpAddress, Caller, OperationNameValue\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P14D",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActivity",
                                    "dataTypes": [
                                      "AzureActivity"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess",
                                  "Persistence"
                                ],
                                "techniques": [
                                  "T1003",
                                  "T1098"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Caller",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "CallerIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject11').analyticRuleId11,'/'))))]",
                              "properties": {
                                "description": "Azure Activity Analytics Rule 11",
                                "parentId": "[variables('analyticRuleObject11').analyticRuleId11]",
                                "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject11').analyticRuleVersion11]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Rare subscription-level operations in Azure",
                        "contentProductId": "[variables('analyticRuleObject11')._analyticRulecontentProductId11]",
                        "id": "[variables('analyticRuleObject11')._analyticRulecontentProductId11]",
                        "version": "[variables('analyticRuleObject11').analyticRuleVersion11]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject12').analyticRuleTemplateSpecName12]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "TimeSeriesAnomaly_Mass_Cloud_Resource_Deletions_AnalyticalRules Analytics Rule with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject12').analyticRuleVersion12]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This query generates the baseline pattern of cloud resource deletions by an individual and generates an anomaly when any unusual spike is detected. These anomalies from unusual or privileged users could be an indication of a cloud infrastructure takedown by an adversary.",
                                "displayName": "Mass Cloud resource deletions Time Series Anomaly",
                                "enabled": false,
                                "query": "let starttime = 14d;\nlet endtime = 1d;\nlet timeframe = 1d;\nlet TotalEventsThreshold = 25;\nlet TimeSeriesData = AzureActivity \n| where TimeGenerated between (startofday(ago(starttime))..startofday(now())) \n| where OperationNameValue endswith \"delete\" \n| project TimeGenerated, Caller \n| make-series Total = count() on TimeGenerated from startofday(ago(starttime)) to startofday(now()) step timeframe by Caller;\nTimeSeriesData \n| extend (anomalies, score, baseline) = series_decompose_anomalies(Total, 3, -1, 'linefit') \n| mv-expand Total to typeof(double), TimeGenerated to typeof(datetime), anomalies to typeof(double), score to typeof(double), baseline to typeof(long) \n| where TimeGenerated >= startofday(ago(endtime)) \n| where anomalies > 0 \n| project Caller, TimeGenerated, Total, baseline, anomalies, score \n| where Total > TotalEventsThreshold and baseline > 0 \n| join (AzureActivity \n| where TimeGenerated > startofday(ago(endtime)) \n| where OperationNameValue endswith \"delete\" \n| summarize count(), make_set(OperationNameValue,100), make_set(_ResourceId,100) by bin(TimeGenerated, timeframe), Caller ) on TimeGenerated, Caller \n| extend Name = iif(Caller has '@',tostring(split(Caller,'@',0)[0]),\"\")\n| extend UPNSuffix = iif(Caller has '@',tostring(split(Caller,'@',1)[0]),\"\")\n| extend AadUserId = iif(Caller !has '@',Caller,\"\")\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P14D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActivity",
                                    "dataTypes": [
                                      "AzureActivity"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Impact"
                                ],
                                "techniques": [
                                  "T1485"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Caller",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "AadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject12').analyticRuleId12,'/'))))]",
                              "properties": {
                                "description": "Azure Activity Analytics Rule 12",
                                "parentId": "[variables('analyticRuleObject12').analyticRuleId12]",
                                "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject12').analyticRuleVersion12]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Mass Cloud resource deletions Time Series Anomaly",
                        "contentProductId": "[variables('analyticRuleObject12')._analyticRulecontentProductId12]",
                        "id": "[variables('analyticRuleObject12')._analyticRulecontentProductId12]",
                        "version": "[variables('analyticRuleObject12').analyticRuleVersion12]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject13').analyticRuleTemplateSpecName13]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "SubscriptionMigration_AnalyticalRules Analytics Rule with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject13').analyticRuleVersion13]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This detection uses AzureActivity logs (Security category) to identify when a subscription is moved to another tenant.\nA threat actor may move a subscription into their own tenant to circumvent local resource deployment and logging policies.\nOnce moved, threat actors may deploy resources and perform malicious activities such as crypto mining.\nThis is a technique known as \"subscription hijacking\". More information can be found here: https://techcommunity.microsoft.com/t5/microsoft-365-defender-blog/hunt-for-compromised-azure-subscriptions-using-microsoft/ba-p/3607121",
                                "displayName": "Subscription moved to another tenant",
                                "enabled": false,
                                "query": "let queryFrequency = 5m;\nlet eventCapture = \"moved from tenant ([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}) to tenant ([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})\";\nAzureActivity\n| where ingestion_time() > ago(queryFrequency)\n| where CategoryValue =~ \"Security\"\n| where OperationNameValue =~ \"Microsoft.Subscription/updateTenant/action\"\n| extend Properties_d = coalesce(parse_json(Properties), Properties_d)\n| where isnotempty(Properties_d)\n| extend Summary = tostring(Properties_d.message)\n| extend EventCapture = extract_all(eventCapture, Summary)\n| extend SourceTenantId = iff(isnotempty(EventCapture), EventCapture[0][0], \"\")\n| extend DestinationTenantId = iff(isnotempty(EventCapture), EventCapture[0][1], \"\")\n| extend \n    Name = split(Caller, \"@\", 0)[0],\n    UPNSuffix = split(Caller, \"@\", 1)[0]\n",
                                "queryFrequency": "PT5M",
                                "queryPeriod": "PT20M",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActivity",
                                    "dataTypes": [
                                      "AzureActivity"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Impact"
                                ],
                                "techniques": [
                                  "T1496"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "_ResourceId",
                                        "identifier": "ResourceId"
                                      }
                                    ],
                                    "entityType": "AzureResource"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Caller",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  }
                                ],
                                "eventGroupingSettings": {
                                  "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                  "DestinationTenantId": "DestinationTenantId",
                                  "SourceTenantId": "SourceTenantId"
                                },
                                "alertDetailsOverride": {
                                  "alertDescriptionFormat": "The user {{Caller}} moved a subscription:\n\n{{Summary}}\n\nIf this was not expected, it may indicate a subscription hijacking event.\n",
                                  "alertDisplayNameFormat": "Subscription {{SubscriptionId}} changed tenants\n"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject13').analyticRuleId13,'/'))))]",
                              "properties": {
                                "description": "Azure Activity Analytics Rule 13",
                                "parentId": "[variables('analyticRuleObject13').analyticRuleId13]",
                                "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject13').analyticRuleVersion13]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Subscription moved to another tenant",
                        "contentProductId": "[variables('analyticRuleObject13')._analyticRulecontentProductId13]",
                        "id": "[variables('analyticRuleObject13')._analyticRulecontentProductId13]",
                        "version": "[variables('analyticRuleObject13').analyticRuleVersion13]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject14').analyticRuleTemplateSpecName14]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Machine_Learning_Creation_AnalyticalRules Analytics Rule with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject14').analyticRuleVersion14]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Shows the most prevalent users who perform write operations on Azure Machine Learning resources. List the common source IP address for each of those accounts. If an operation is not from those IP addresses, it may be worthy of investigation.",
                                "displayName": "Azure Machine Learning Write Operations",
                                "enabled": false,
                                "query": "AzureActivity\n| where ResourceProviderValue == \"MICROSOFT.MACHINELEARNINGSERVICES\"  // Filter activities related to Microsoft Machine Learning Services\n| extend SCOPE = tostring(parse_json(Authorization).scope)  // Parse Authorization scope as string\n| extend subname = split(Hierarchy, \"/\")  // Split Hierarchy to extract Subscription Name and ID\n| extend ['Subscription Name'] = subname[-2], ['Subscription ID'] = subname[-1]  // Extract Subscription Name and ID\n| extend Properties = parse_json(Properties)  // Parse Properties as JSON\n| extend Properties_entity = tostring(Properties.entity)  // Cast Properties.entity to string\n| where isnotempty(Properties_entity)  // Filter activities where Properties.entity is not empty\n// | where Properties_entity contains \"deepseek\"  // Filter activities where Properties.entity contains \"deepseek\"\n| where OperationNameValue contains \"write\"  // Filter activities where OperationNameValue contains \"write\"\n| where OperationNameValue !contains \"MICROSOFT.AUTHORIZATION/ROLEASSIGNMENTS/WRITE\"  // Exclude role assignments\n| extend LLM = tostring(split(Properties_entity, \"/\")[-1])  // Extract the last segment of Properties_entity and cast it to string\n| distinct TimeGenerated, tostring(['Subscription Name']), ResourceGroup, tostring(['Subscription ID']), Caller, CallerIpAddress, OperationNameValue, LLM, _ResourceId  // Select distinct relevant fields for output\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActivity",
                                    "dataTypes": [
                                      "AzureActivity"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess",
                                  "Execution",
                                  "Impact"
                                ],
                                "techniques": [
                                  "T1078",
                                  "T1059",
                                  "T1496"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Caller",
                                        "identifier": "Name"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "CallerIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "_ResourceId",
                                        "identifier": "ResourceId"
                                      }
                                    ],
                                    "entityType": "AzureResource"
                                  }
                                ],
                                "eventGroupingSettings": {
                                  "aggregationKind": "SingleAlert"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject14').analyticRuleId14,'/'))))]",
                              "properties": {
                                "description": "Azure Activity Analytics Rule 14",
                                "parentId": "[variables('analyticRuleObject14').analyticRuleId14]",
                                "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject14').analyticRuleVersion14]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Azure Machine Learning Write Operations",
                        "contentProductId": "[variables('analyticRuleObject14')._analyticRulecontentProductId14]",
                        "id": "[variables('analyticRuleObject14')._analyticRulecontentProductId14]",
                        "version": "[variables('analyticRuleObject14').analyticRuleVersion14]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('workbookTemplateSpecName1')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AzureActivity Workbook with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('workbookVersion1')]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.Insights/workbooks",
                              "name": "[variables('workbookContentId1')]",
                              "location": "[parameters('workspace-location')]",
                              "kind": "shared",
                              "apiVersion": "2021-08-01",
                              "metadata": {
                                "description": "Gain extensive insight into your organization's Azure Activity by analyzing, and correlating all user operations and events.\nYou can learn about all user operations, trends, and anomalous changes over time.\nThis workbook gives you the ability to drill down into caller activities and summarize detected failure and warning events."
                              },
                              "properties": {
                                "displayName": "[parameters('workbook1-name')]",
                                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"query\":\"\",\"parameters\":[{\"id\":\"52bfbd84-1639-480c-bda5-bfc87fd81832\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":604800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]}},{\"id\":\"eeb5dcf9-e898-46af-9c12-d91d97e13cd3\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Caller\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"AzureActivity\\r\\n| summarize by Caller\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"46375a76-7ae1-4d7e-9082-4191531198a9\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ResourceGroup\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"AzureActivity\\r\\n| summarize by ResourceGroup\",\"value\":[\"value::all\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.resources/resourcegroups\":true},\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = AzureActivity\\r\\n| where \\\"{Caller:lable}\\\" == \\\"All\\\" or \\\"{Caller:lable}\\\" == \\\"All\\\" or Caller in ({Caller})\\r\\n| where \\\"{ResourceGroup:lable}\\\" == \\\"All\\\" or \\\"{ResourceGroup:lable}\\\" == \\\"All\\\" or ResourceGroup in ({ResourceGroup});\\r\\ndata\\r\\n| summarize Count = count() by ResourceGroup\\r\\n| join kind = fullouter (datatable(ResourceGroup:string)['Medium', 'high', 'low']) on ResourceGroup\\r\\n| project ResourceGroup = iff(ResourceGroup == '', ResourceGroup1, ResourceGroup), Count = iff(ResourceGroup == '', 0, Count)\\r\\n| join kind = inner (data\\r\\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by ResourceGroup)\\r\\n on ResourceGroup\\r\\n| project-away ResourceGroup1, TimeGenerated\\r\\n| extend ResourceGroups = ResourceGroup\\r\\n| union (\\r\\n data \\r\\n | summarize Count = count() \\r\\n | extend jkey = 1\\r\\n | join kind=inner (data\\r\\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\\r\\n | extend jkey = 1) on jkey\\r\\n | extend ResourceGroup = 'All', ResourceGroups = '*' \\r\\n)\\r\\n| order by Count desc\\r\\n| take 10\",\"size\":4,\"exportToExcelOptions\":\"visible\",\"title\":\"Top 10 active resource groups\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ResourceGroup\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"blueOrange\",\"showIcon\":true}},\"showBorder\":false}},\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureActivity\\r\\n| where \\\"{Caller:lable}\\\" == \\\"All\\\" or Caller in ({Caller})\\r\\n| where \\\"{ResourceGroup:lable}\\\" == \\\"All\\\" or ResourceGroup in ({ResourceGroup})\\r\\n| summarize deletions = countif(OperationNameValue hassuffix \\\"delete\\\"), creations = countif(OperationNameValue hassuffix \\\"write\\\"), updates = countif(OperationNameValue hassuffix \\\"write\\\"), Activities = count(OperationNameValue) by bin_at(TimeGenerated, 1h, now())\\r\\n\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Activities over time\",\"color\":\"gray\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"linechart\",\"graphSettings\":{\"type\":0}},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureActivity\\r\\n| where \\\"{Caller:lable}\\\" == \\\"All\\\" or Caller in ({Caller})\\r\\n| where \\\"{ResourceGroup:lable}\\\" == \\\"All\\\" or ResourceGroup in ({ResourceGroup})\\r\\n| summarize deletions = countif(OperationNameValue hassuffix \\\"Delete\\\"), creations = countif(OperationNameValue hassuffix \\\"write\\\"), updates = countif(OperationNameValue hassuffix \\\"write\\\"), Activities = count() by Caller\\r\\n\",\"size\":1,\"exportToExcelOptions\":\"visible\",\"title\":\"Caller activities\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Caller\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"deletions\",\"formatter\":4,\"formatOptions\":{\"showIcon\":true,\"aggregation\":\"Count\"}},{\"columnMatch\":\"creations\",\"formatter\":4,\"formatOptions\":{\"palette\":\"purple\",\"showIcon\":true,\"aggregation\":\"Count\"}},{\"columnMatch\":\"updates\",\"formatter\":4,\"formatOptions\":{\"palette\":\"gray\",\"showIcon\":true,\"aggregation\":\"Count\"}},{\"columnMatch\":\"Activities\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenDark\",\"linkTarget\":\"GenericDetails\",\"linkIsContextBlade\":true,\"showIcon\":true,\"aggregation\":\"Count\",\"workbookContext\":{\"componentIdSource\":\"workbook\",\"resourceIdsSource\":\"workbook\",\"templateIdSource\":\"static\",\"templateId\":\"https://go.microsoft.com/fwlink/?linkid=874159&resourceId=%2Fsubscriptions%2F44e4eff8-1fcb-4a22-a7d6-992ac7286382%2FresourceGroups%2FSOC&featureName=Workbooks&itemId=%2Fsubscriptions%2F44e4eff8-1fcb-4a22-a7d6-992ac7286382%2Fresourcegroups%2Fsoc%2Fproviders%2Fmicrosoft.insights%2Fworkbooks%2F4c195aec-747f-40bb-addb-934acb3ec646&name=CiscoASA&func=NavigateToPortalFeature&type=workbook\",\"typeSource\":\"workbook\",\"gallerySource\":\"workbook\"}}}],\"sortBy\":[{\"itemKey\":\"$gen_bar_updates_3\",\"sortOrder\":2}]}},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureActivity \\r\\n| where \\\"{Caller:lable}\\\" == \\\"All\\\" or Caller in ({Caller})\\r\\n| where \\\"{ResourceGroup:lable}\\\" == \\\"All\\\" or ResourceGroup in ({ResourceGroup})\\r\\n| summarize Informational = countif(Level == \\\"Informational\\\"), Warning = countif(Level == \\\"Warning\\\"), Error = countif(Level == \\\"Error\\\") by bin_at(TimeGenerated, 1h, now())\\r\\n\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Activities by log level over time\",\"color\":\"redBright\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"scatterchart\",\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":2,\"topContent\":{\"columnMatch\":\"Error\",\"formatter\":12,\"formatOptions\":{\"showIcon\":true}},\"hivesContent\":{\"columnMatch\":\"TimeGenerated\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"nodeIdField\":\"Error\",\"sourceIdField\":\"Error\",\"targetIdField\":\"Error\",\"staticNodeSize\":100,\"groupByField\":\"TimeGenerated\",\"hivesMargin\":5}},\"name\":\"query - 4\"}],\"fromTemplateId\":\"sentinel-AzureActivity\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                                "version": "1.0",
                                "sourceId": "[variables('workspaceResourceId')]",
                                "category": "sentinel"
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
                              "properties": {
                                "description": "@{workbookKey=AzureActivityWorkbook; logoFileName=azureactivity_logo.svg; description=Gain extensive insight into your organization's Azure Activity by analyzing, and correlating all user operations and events.\nYou can learn about all user operations, trends, and anomalous changes over time.\nThis workbook gives you the ability to drill down into caller activities and summarize detected failure and warning events.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=2.0.0; title=Azure Activity; templateRelativePath=AzureActivity.json; subtitle=; provider=Microsoft}.description",
                                "parentId": "[variables('workbookId1')]",
                                "contentId": "[variables('_workbookContentId1')]",
                                "kind": "Workbook",
                                "version": "[variables('workbookVersion1')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                },
                                "dependencies": {
                                  "operator": "AND",
                                  "criteria": [
                                    {
                                      "contentId": "AzureActivity",
                                      "kind": "DataType"
                                    },
                                    {
                                      "contentId": "AzureActivity",
                                      "kind": "DataConnector"
                                    }
                                  ]
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_workbookContentId1')]",
                        "contentKind": "Workbook",
                        "displayName": "[parameters('workbook1-name')]",
                        "contentProductId": "[variables('_workbookcontentProductId1')]",
                        "id": "[variables('_workbookcontentProductId1')]",
                        "version": "[variables('workbookVersion1')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('workbookTemplateSpecName2')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AzureServiceHealthWorkbook Workbook with template version 3.0.3",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('workbookVersion2')]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.Insights/workbooks",
                              "name": "[variables('workbookContentId2')]",
                              "location": "[parameters('workspace-location')]",
                              "kind": "shared",
                              "apiVersion": "2021-08-01",
                              "metadata": {
                                "description": "A collection of queries to provide visibility into Azure Service Health across the subscriptions."
                              },
                              "properties": {
                                "displayName": "[parameters('workbook2-name')]",
                                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Azure Activity Logs for Azure Service Health Analysis Workbook\"},\"name\":\"text - 1\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"76e0f423-6828-47f3-aa86-522604bbbc6f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"description\":\"Azure Subscription where is the Log Analytics with Activity Logs informaiton\",\"isRequired\":true,\"query\":\"summarize by subscriptionId\\r\\n| project value = strcat(\\\"/subscriptions/\\\",subscriptionId), label = subscriptionId\\r\\n| order by value \",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":\"/subscriptions/fcb7d51b-418f-45a9-8418-5c0f17e343c8\"},{\"id\":\"ea100a5b-3c79-4761-8235-6a7989c83da5\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"LAworkspace\",\"label\":\"Log Analytics workspace\",\"type\":5,\"description\":\"Log Analytics workspace where the Activity Logs information is sent\",\"isRequired\":true,\"query\":\"where type == 'microsoft.operationalinsights/workspaces'\\r\\n| project id\\r\\n| order by id asc\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":\"\"},{\"id\":\"6b112ffe-a3a2-4b9e-a17a-c4ea5af739d7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":3600000},{\"durationMs\":86400000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":2592000000}}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{LAworkspace}\"],\"parameters\":[{\"id\":\"2fb175cb-a2b6-4dd3-9473-886a8db4cd9c\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TrackingID_P\",\"label\":\"Tracking ID\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"AzureActivity\\r\\n| where CategoryValue == \\\"ServiceHealth\\\"\\r\\n| extend TrackingId = tostring(Properties_d.trackingId)\\r\\n| distinct TrackingId\\r\\n| order by TrackingId asc\",\"crossComponentResources\":[\"{LAworkspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":[\"value::all\"]}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 3\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureActivity\\r\\n| where CategoryValue == \\\"ServiceHealth\\\" \\r\\n| summarize TimeGenerated=arg_max(TimeGenerated,*) by SubscriptionId\\r\\n| extend SubscriptionId == strcat('/subscriptions/', SubscriptionId)\",\"size\":1,\"showAnalytics\":true,\"title\":\"Subscriptions Impacted\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LAworkspace}\"],\"visualization\":\"tiles\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"22ch\"}},{\"columnMatch\":\"TrackingId\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"GenericDetails\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"14ch\"}},{\"columnMatch\":\"Status\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Active\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Resolved\",\"representation\":\"Resolved\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"more\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"12ch\"}},{\"columnMatch\":\"Impact Start Time\",\"formatter\":5},{\"columnMatch\":\"Level\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Information\",\"representation\":\"info\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Warning\",\"representation\":\"warning\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Error\",\"representation\":\"error\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"Unknown\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"IncidentType\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Incident\",\"representation\":\"error\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Maintenance\",\"representation\":\"Tools\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"ActionRequired\",\"representation\":\"Clock\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Informational\",\"representation\":\"1\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"more\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"ImpactedSubscriptions\",\"formatter\":5},{\"columnMatch\":\"# Subs.\",\"formatter\":8,\"formatOptions\":{\"min\":-1,\"palette\":\"red\"}},{\"columnMatch\":\"ImpactedRegions\",\"formatter\":5},{\"columnMatch\":\"# Regions\",\"formatter\":8,\"formatOptions\":{\"min\":-1,\"palette\":\"magenta\"}},{\"columnMatch\":\"ImpactMitigationTime\",\"formatter\":5},{\"columnMatch\":\"ResolutionTime (hours)\",\"formatter\":4,\"formatOptions\":{\"min\":-1,\"palette\":\"orange\",\"customColumnWidthSetting\":\"26ch\"}}]},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"SubscriptionId\",\"formatter\":13,\"formatOptions\":{\"showIcon\":true}},\"showBorder\":false}},\"customWidth\":\"30\",\"name\":\"query - 0 - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureActivity\\r\\n| where CategoryValue == \\\"ServiceHealth\\\"\\r\\n| extend TrackingId = tostring(Properties_d.trackingId)\\r\\n| summarize arg_max(TimeGenerated,*) by TrackingId\\r\\n| where TrackingId in ({TrackingID_P:value}) or '{TrackingID_P:label}'=='All'\\r\\n| extend ImpactedRegions = tostring(Properties_d.region)\\r\\n| summarize count() by ImpactedRegions\",\"size\":1,\"title\":\"Impacted Regions\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ImpactedRegions\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false}},\"customWidth\":\"35\",\"name\":\"query - 4\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureActivity\\r\\n| where CategoryValue == \\\"ServiceHealth\\\"\\r\\n| extend TrackingId = tostring(Properties_d.trackingId)\\r\\n| summarize arg_max(TimeGenerated,*) by TrackingId\\r\\n| where TrackingId in ({TrackingID_P:value}) or '{TrackingID_P:label}'=='All'\\r\\n| extend IncidentType= tostring(Properties_d.incidentType)\\r\\n| summarize count() by IncidentType\",\"size\":1,\"title\":\"Type of Incidents\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"IncidentType\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Maintenance\",\"color\":\"gray\"},{\"seriesName\":\"Incident\",\"color\":\"yellowDark\"},{\"seriesName\":\"ActionRequired\",\"color\":\"redBright\"}]}},\"customWidth\":\"35\",\"name\":\"query - 4 - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureActivity\\r\\n| where CategoryValue == \\\"ServiceHealth\\\"\\r\\n| extend TrackingId = tostring(Properties_d.trackingId)\\r\\n| summarize arg_max(TimeGenerated,*) by TrackingId\\r\\n| where TrackingId in ({TrackingID_P:value}) or '{TrackingID_P:label}'=='All'\\r\\n| extend Status = tostring(Properties_d.activityStatusValue)\\r\\n| summarize count() by Status\",\"size\":0,\"title\":\"Service Health on Status\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"IncidentType\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Active\",\"color\":\"red\"},{\"seriesName\":\"Resolved\",\"color\":\"green\"}]}},\"customWidth\":\"45\",\"name\":\"query - 4 - Copy - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureActivity\\r\\n| where CategoryValue == \\\"ServiceHealth\\\"\\r\\n| extend TrackingId = tostring(Properties_d.trackingId)\\r\\n| summarize arg_max(TimeGenerated,*) by TrackingId\\r\\n| where TrackingId in ({TrackingID_P:value}) or '{TrackingID_P:label}'=='All'\\r\\n| extend Service = tostring(Properties_d.service)\\r\\n| summarize count() by Service\",\"size\":0,\"title\":\"Service Health Across Services\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"categoricalbar\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"IncidentType\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Active\",\"color\":\"red\"},{\"seriesName\":\"Resolved\",\"color\":\"green\"}]}},\"customWidth\":\"55\",\"name\":\"query - 4 - Copy - Copy - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureActivity\\r\\n| where CategoryValue == \\\"ServiceHealth\\\"\\r\\n| extend TrackingId = tostring(Properties_d.trackingId)\\r\\n| summarize arg_max(TimeGenerated,*) by TrackingId\\r\\n| where TrackingId in ({TrackingID_P:value}) or '{TrackingID_P:label}'=='All'\\r\\n| extend Service = tostring(Properties_d.service)\\r\\n| extend ImpactMitigationTime = tostring(Properties_d.impactMitigationTime)\\r\\n| extend ImpactStartTime = tostring(Properties_d.impactStartTime)\\r\\n| extend [\\\"ResolutionTime\\\"]=datetime_diff('hour',todatetime(ImpactMitigationTime),todatetime(ImpactStartTime))\\r\\n| extend ImpactedRegions = todynamic(parse_json(tostring(parse_json(tostring(parse_json(Properties).impactedServices))[0].ImpactedRegions)))\\r\\n| mv-expand ImpactedRegions\\r\\n| project  Service,ImpactedRegions.RegionName, [\\\"ResolutionTime\\\"], _ResourceId\",\"size\":0,\"title\":\"Resolution Time\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":13,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"ResolutionTime\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redDark\"},\"numberFormat\":{\"unit\":25,\"options\":{\"style\":\"decimal\",\"useGrouping\":false}}},{\"columnMatch\":\"_ResourceId\",\"formatter\":5}],\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"_ResourceId\"],\"expandTopLevel\":true}},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"IncidentType\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Active\",\"color\":\"red\"},{\"seriesName\":\"Resolved\",\"color\":\"green\"}]}},\"customWidth\":\"70\",\"name\":\"query - 4 - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureActivity\\r\\n| where CategoryValue == \\\"ServiceHealth\\\"\\r\\n| extend TrackingId = tostring(Properties_d.trackingId)\\r\\n| summarize arg_max(TimeGenerated,*) by TrackingId\\r\\n| where TrackingId in ({TrackingID_P:value}) or '{TrackingID_P:label}'=='All'\\r\\n| extend Stage = tostring(parse_json(Properties).stage)\\r\\n| summarize count() by Stage\",\"size\":0,\"title\":\"Current Stage\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Stage\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Active\",\"color\":\"red\"},{\"seriesName\":\"Resolved\",\"color\":\"green\"}]}},\"customWidth\":\"30\",\"name\":\"query - 4 - Copy - Copy - Copy - Copy - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureActivity\\r\\n| where CategoryValue == \\\"ServiceHealth\\\"\\r\\n| extend TrackingId = tostring(Properties_d.trackingId)\\r\\n| summarize arg_max(TimeGenerated,) by TrackingId\\r\\n| where TrackingId in ({TrackingID_P:value}) or '{TrackingID_P:label}'=='All'\\r\\n//| where Level in ('Warning','Error','Information')\\r\\n| extend IncidentType= tostring(Properties_d.incidentType)\\r\\n//| where IncidentType in ('Incident','Maintenance','ActionRequired')\\r\\n| extend ImpactMitigationTime = tostring(Properties_d.impactMitigationTime)\\r\\n| extend ImpactStartTime = tostring(Properties_d.impactStartTime)\\r\\n| extend Status = tostring(Properties_d.activityStatusValue)\\r\\n| extend Service = tostring(Properties_d.service)\\r\\n| extend Title = tostring(Properties_d.defaultLanguageTitle)\\r\\n| extend ImpactedRegions = tostring(parse_json(tostring(parse_json(tostring(parse_json(Properties).impactedServices))[0].ImpactedRegions)))\\r\\n| summarize ImpactedSubscriptions=make_set(SubscriptionId), TimeGenerated=arg_max(TimeGenerated,) by Level, ImpactedRegions, Service, TrackingId, Status\\r\\n| project TimeGenerated\\r\\n        , TrackingId\\r\\n        , Title\\r\\n        , Status\\r\\n        , [\\\"Impact Start Time\\\"]=todatetime(ImpactStartTime)\\r\\n        , Level\\r\\n        , IncidentType\\r\\n        , ImpactedSubscriptions\\r\\n        , Service\\r\\n        , [\\\"# Subs.\\\"]=array_length(ImpactedSubscriptions)\\r\\n        , ImpactedRegions\\r\\n        , [\\\"# Regions\\\"]=array_length(parse_json(ImpactedRegions))\\r\\n        , todatetime(ImpactMitigationTime)\\r\\n        , [\\\"ResolutionTime (hours)\\\"]=datetime_diff('hour',todatetime(ImpactMitigationTime),todatetime(ImpactStartTime))\\r\\n| order by TimeGenerated \",\"size\":0,\"showAnalytics\":true,\"title\":\"Analysis of incident\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LAworkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"22ch\"}},{\"columnMatch\":\"TrackingId\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"GenericDetails\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"14ch\"}},{\"columnMatch\":\"Status\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Active\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Resolved\",\"representation\":\"Resolved\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"more\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"12ch\"}},{\"columnMatch\":\"Impact Start Time\",\"formatter\":5},{\"columnMatch\":\"Level\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Information\",\"representation\":\"info\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Warning\",\"representation\":\"warning\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Error\",\"representation\":\"error\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"Unknown\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"IncidentType\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Incident\",\"representation\":\"error\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Maintenance\",\"representation\":\"Tools\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"ActionRequired\",\"representation\":\"Clock\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Informational\",\"representation\":\"1\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"more\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"ImpactedSubscriptions\",\"formatter\":5},{\"columnMatch\":\"# Subs.\",\"formatter\":8,\"formatOptions\":{\"min\":-1,\"palette\":\"red\"}},{\"columnMatch\":\"ImpactedRegions\",\"formatter\":5},{\"columnMatch\":\"# Regions\",\"formatter\":8,\"formatOptions\":{\"min\":-1,\"palette\":\"magenta\"}},{\"columnMatch\":\"ImpactMitigationTime\",\"formatter\":5},{\"columnMatch\":\"ResolutionTime (hours)\",\"formatter\":4,\"formatOptions\":{\"min\":-1,\"palette\":\"orange\",\"customColumnWidthSetting\":\"26ch\"}}],\"filter\":true,\"sortBy\":[{\"itemKey\":\"$gen_link_TrackingId_1\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"$gen_link_TrackingId_1\",\"sortOrder\":1}]},\"name\":\"query - 0\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureActivity\\r\\n| where CategoryValue == \\\"ServiceHealth\\\"\\r\\n| extend TrackingId = tostring(Properties_d.trackingId)\\r\\n| where TrackingId in ({TrackingID_P:value}) or '{TrackingID_P:label}'=='All'\\r\\n| summarize ImpactedSubscriptions=make_set(SubscriptionId) by TrackingId\\r\\n| project ImpactedSubscriptions, TrackingId\\r\\n| mv-expand ImpactedSubscriptions\\r\\n| project Subscription=strcat('/subscriptions/',ImpactedSubscriptions), TrackingId\\r\\n| extend Info=strcat('https://app.azure.com/h/',TrackingId)\\r\\n| order by TrackingId asc\",\"size\":0,\"showAnalytics\":true,\"title\":\"Affected subscriptions\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LAworkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TrackingId\",\"formatter\":1,\"formatOptions\":{\"linkColumn\":\"Info\",\"linkTarget\":\"Url\"}},{\"columnMatch\":\"Info\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"Shareable link\"}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 2\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureActivity\\r\\n| where CategoryValue == \\\"ServiceHealth\\\"\\r\\n| extend TrackingId = tostring(Properties_d.trackingId)\\r\\n| where TrackingId in ({TrackingID_P:value}) or '{TrackingID_P:label}'=='All'\\r\\n| extend ImpactedRegions = tostring(parse_json(tostring(parse_json(tostring(parse_json(Properties).impactedServices))[0].ImpactedRegions)))\\r\\n| project todynamic(ImpactedRegions), TrackingId\\r\\n| mv-expand ImpactedRegions\\r\\n| project Region=strcat(tostring(ImpactedRegions.RegionName),' (',tostring(ImpactedRegions.RegionId),')'),TrackingId\\r\\n| distinct Region, TrackingId\\r\\n| extend Info=strcat('https://app.azure.com/h/', TrackingId)\\r\\n| order by TrackingId asc\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Affected regions\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LAworkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TrackingId\",\"formatter\":1,\"formatOptions\":{\"linkColumn\":\"Info\",\"linkTarget\":\"Url\"}},{\"columnMatch\":\"Info\",\"formatter\":5}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 1\",\"styleSettings\":{\"showBorder\":true}}]},\"name\":\"GroupActivityLogs01\",\"styleSettings\":{\"showBorder\":true}}],\"fromTemplateId\":\"sentinel-AzureServiceHealthWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                                "version": "1.0",
                                "sourceId": "[variables('workspaceResourceId')]",
                                "category": "sentinel"
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId2'),'/'))))]",
                              "properties": {
                                "description": "@{workbookKey=AzureServiceHealthWorkbook; logoFileName=; description=A collection of queries to provide visibility into Azure Service Health across the subscriptions.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=Azure Service Health Workbook; templateRelativePath=AzureServiceHealthWorkbook.json; subtitle=; provider=Microsoft Sentinel Community}.description",
                                "parentId": "[variables('workbookId2')]",
                                "contentId": "[variables('_workbookContentId2')]",
                                "kind": "Workbook",
                                "version": "[variables('workbookVersion2')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Azure Activity",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                },
                                "dependencies": {
                                  "operator": "AND",
                                  "criteria": [
                                    {
                                      "contentId": "AzureActivity",
                                      "kind": "DataType"
                                    },
                                    {
                                      "contentId": "AzureActivity",
                                      "kind": "DataConnector"
                                    }
                                  ]
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_workbookContentId2')]",
                        "contentKind": "Workbook",
                        "displayName": "[parameters('workbook2-name')]",
                        "contentProductId": "[variables('_workbookcontentProductId2')]",
                        "id": "[variables('_workbookcontentProductId2')]",
                        "version": "[variables('workbookVersion2')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
                      "apiVersion": "2023-04-01-preview",
                      "location": "[parameters('workspace-location')]",
                      "properties": {
                        "version": "3.0.3",
                        "kind": "Solution",
                        "contentSchemaVersion": "3.0.0",
                        "displayName": "Azure Activity",
                        "publisherDisplayName": "Microsoft Sentinel, Microsoft Corporation",
                        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p> Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Azure%20Activity/ReleaseNotes.md\">Release Notes</a></p>\n<p> There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The <a href=\"https://docs.microsoft.com/azure/azure-monitor/essentials/activity-log\">Azure Activity</a> solution for Microsoft Sentinel enables you to ingest Azure Activity Administrative, Security, Service Health, Alert, Recommendation, Policy, Autoscale and Resource Health <a href=\"https://docs.microsoft.com/azure/azure-monitor/reference/tables/azureactivity\">logs</a> using Diagnostic Settings into Microsoft Sentinel.</p>\n<p><strong>Data Connectors:</strong> 1, <strong>Workbooks:</strong> 2, <strong>Analytic Rules:</strong> 14, <strong>Hunting Queries:</strong> 15</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
                        "contentKind": "Solution",
                        "contentProductId": "[variables('_solutioncontentProductId')]",
                        "id": "[variables('_solutioncontentProductId')]",
                        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Workbooks/Images/Logos/azureactivity_logo.svg\" width=\"75px\" height=\"75px\">",
                        "contentId": "[variables('_solutionId')]",
                        "parentId": "[variables('_solutionId')]",
                        "source": {
                          "kind": "Solution",
                          "name": "Azure Activity",
                          "sourceId": "[variables('_solutionId')]"
                        },
                        "author": {
                          "name": "Microsoft",
                          "email": "[variables('_email')]"
                        },
                        "support": {
                          "name": "Microsoft Corporation",
                          "email": "support@microsoft.com",
                          "tier": "Microsoft",
                          "link": "https://support.microsoft.com/"
                        },
                        "dependencies": {
                          "operator": "AND",
                          "criteria": [
                            {
                              "kind": "DataConnector",
                              "contentId": "[variables('_dataConnectorContentId1')]",
                              "version": "[variables('dataConnectorVersion1')]"
                            },
                            {
                              "kind": "HuntingQuery",
                              "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
                              "version": "[variables('huntingQueryObject1').huntingQueryVersion1]"
                            },
                            {
                              "kind": "HuntingQuery",
                              "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
                              "version": "[variables('huntingQueryObject2').huntingQueryVersion2]"
                            },
                            {
                              "kind": "HuntingQuery",
                              "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
                              "version": "[variables('huntingQueryObject3').huntingQueryVersion3]"
                            },
                            {
                              "kind": "HuntingQuery",
                              "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
                              "version": "[variables('huntingQueryObject4').huntingQueryVersion4]"
                            },
                            {
                              "kind": "HuntingQuery",
                              "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
                              "version": "[variables('huntingQueryObject5').huntingQueryVersion5]"
                            },
                            {
                              "kind": "HuntingQuery",
                              "contentId": "[variables('huntingQueryObject6')._huntingQuerycontentId6]",
                              "version": "[variables('huntingQueryObject6').huntingQueryVersion6]"
                            },
                            {
                              "kind": "HuntingQuery",
                              "contentId": "[variables('huntingQueryObject7')._huntingQuerycontentId7]",
                              "version": "[variables('huntingQueryObject7').huntingQueryVersion7]"
                            },
                            {
                              "kind": "HuntingQuery",
                              "contentId": "[variables('huntingQueryObject8')._huntingQuerycontentId8]",
                              "version": "[variables('huntingQueryObject8').huntingQueryVersion8]"
                            },
                            {
                              "kind": "HuntingQuery",
                              "contentId": "[variables('huntingQueryObject9')._huntingQuerycontentId9]",
                              "version": "[variables('huntingQueryObject9').huntingQueryVersion9]"
                            },
                            {
                              "kind": "HuntingQuery",
                              "contentId": "[variables('huntingQueryObject10')._huntingQuerycontentId10]",
                              "version": "[variables('huntingQueryObject10').huntingQueryVersion10]"
                            },
                            {
                              "kind": "HuntingQuery",
                              "contentId": "[variables('huntingQueryObject11')._huntingQuerycontentId11]",
                              "version": "[variables('huntingQueryObject11').huntingQueryVersion11]"
                            },
                            {
                              "kind": "HuntingQuery",
                              "contentId": "[variables('huntingQueryObject12')._huntingQuerycontentId12]",
                              "version": "[variables('huntingQueryObject12').huntingQueryVersion12]"
                            },
                            {
                              "kind": "HuntingQuery",
                              "contentId": "[variables('huntingQueryObject13')._huntingQuerycontentId13]",
                              "version": "[variables('huntingQueryObject13').huntingQueryVersion13]"
                            },
                            {
                              "kind": "HuntingQuery",
                              "contentId": "[variables('huntingQueryObject14')._huntingQuerycontentId14]",
                              "version": "[variables('huntingQueryObject14').huntingQueryVersion14]"
                            },
                            {
                              "kind": "HuntingQuery",
                              "contentId": "[variables('huntingQueryObject15')._huntingQuerycontentId15]",
                              "version": "[variables('huntingQueryObject15').huntingQueryVersion15]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                              "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                              "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                              "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                              "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                              "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                              "version": "[variables('analyticRuleObject6').analyticRuleVersion6]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
                              "version": "[variables('analyticRuleObject7').analyticRuleVersion7]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
                              "version": "[variables('analyticRuleObject8').analyticRuleVersion8]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
                              "version": "[variables('analyticRuleObject9').analyticRuleVersion9]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
                              "version": "[variables('analyticRuleObject10').analyticRuleVersion10]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
                              "version": "[variables('analyticRuleObject11').analyticRuleVersion11]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
                              "version": "[variables('analyticRuleObject12').analyticRuleVersion12]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
                              "version": "[variables('analyticRuleObject13').analyticRuleVersion13]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
                              "version": "[variables('analyticRuleObject14').analyticRuleVersion14]"
                            },
                            {
                              "kind": "Workbook",
                              "contentId": "[variables('_workbookContentId1')]",
                              "version": "[variables('workbookVersion1')]"
                            },
                            {
                              "kind": "Workbook",
                              "contentId": "[variables('_workbookContentId2')]",
                              "version": "[variables('workbookVersion2')]"
                            }
                          ]
                        },
                        "firstPublishDate": "2022-04-18",
                        "providers": [
                          "Microsoft"
                        ],
                        "categories": {
                          "domains": [
                            "IT Operations"
                          ]
                        }
                      },
                      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
                    }
                  ],
                  "outputs": {}
                }
              }
            },
            {
              "condition": "[parameters('deployAzureActivitySolution')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-workbook-azure-activity-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('workspaceSubscriptionId')]",
              "resourceGroup": "[parameters('workspaceResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "workspaceResourceId": {
                    "value": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.OperationalInsights/workspaces/{2}', parameters('workspaceSubscriptionId'), parameters('workspaceResourceGroupName'), parameters('workspaceName'))]"
                  },
                  "location": {
                    "value": "[parameters('workspaceLocation')]"
                  },
                  "displayName": {
                    "value": "[parameters('azureActivityWorkbookName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "workspaceResourceId": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "displayName": {
                      "type": "string",
                      "defaultValue": "Azure Activity"
                    }
                  },
                  "variables": {
                    "workbookId": "[guid(parameters('workspaceResourceId'), 'AzureActivity')]",
                    "serializedData": {
                      "version": "Notebook/1.0",
                      "items": [
                        {
                          "type": 9,
                          "content": {
                            "version": "KqlParameterItem/1.0",
                            "query": "",
                            "crossComponentResources": [],
                            "parameters": [
                              {
                                "id": "52bfbd84-1639-480c-bda5-bfc87fd81832",
                                "version": "KqlParameterItem/1.0",
                                "name": "TimeRange",
                                "type": 4,
                                "isRequired": true,
                                "value": {
                                  "durationMs": 604800000
                                },
                                "typeSettings": {
                                  "selectableValues": [
                                    {
                                      "durationMs": 300000
                                    },
                                    {
                                      "durationMs": 900000
                                    },
                                    {
                                      "durationMs": 1800000
                                    },
                                    {
                                      "durationMs": 3600000
                                    },
                                    {
                                      "durationMs": 14400000
                                    },
                                    {
                                      "durationMs": 43200000
                                    },
                                    {
                                      "durationMs": 86400000
                                    },
                                    {
                                      "durationMs": 172800000
                                    },
                                    {
                                      "durationMs": 259200000
                                    },
                                    {
                                      "durationMs": 604800000
                                    },
                                    {
                                      "durationMs": 1209600000
                                    },
                                    {
                                      "durationMs": 2419200000
                                    },
                                    {
                                      "durationMs": 2592000000
                                    },
                                    {
                                      "durationMs": 5184000000
                                    },
                                    {
                                      "durationMs": 7776000000
                                    }
                                  ]
                                }
                              },
                              {
                                "id": "eeb5dcf9-e898-46af-9c12-d91d97e13cd3",
                                "version": "KqlParameterItem/1.0",
                                "name": "Caller",
                                "type": 2,
                                "isRequired": true,
                                "multiSelect": true,
                                "quote": "'",
                                "delimiter": ",",
                                "query": "AzureActivity\r\n| summarize by Caller",
                                "value": [
                                  "value::all"
                                ],
                                "typeSettings": {
                                  "additionalResourceOptions": [
                                    "value::all"
                                  ],
                                  "selectAllValue": "All"
                                },
                                "timeContext": {
                                  "durationMs": 0
                                },
                                "timeContextFromParameter": "TimeRange",
                                "queryType": 0,
                                "resourceType": "microsoft.operationalinsights/workspaces"
                              },
                              {
                                "id": "46375a76-7ae1-4d7e-9082-4191531198a9",
                                "version": "KqlParameterItem/1.0",
                                "name": "ResourceGroup",
                                "type": 2,
                                "isRequired": true,
                                "multiSelect": true,
                                "quote": "'",
                                "delimiter": ",",
                                "query": "AzureActivity\r\n| summarize by ResourceGroup",
                                "value": [
                                  "value::all"
                                ],
                                "typeSettings": {
                                  "resourceTypeFilter": {
                                    "microsoft.resources/resourcegroups": true
                                  },
                                  "additionalResourceOptions": [
                                    "value::all"
                                  ],
                                  "selectAllValue": "All"
                                },
                                "timeContext": {
                                  "durationMs": 0
                                },
                                "timeContextFromParameter": "TimeRange",
                                "queryType": 0,
                                "resourceType": "microsoft.operationalinsights/workspaces"
                              }
                            ],
                            "style": "pills",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces"
                          },
                          "name": "parameters - 2"
                        },
                        {
                          "type": 3,
                          "content": {
                            "version": "KqlItem/1.0",
                            "query": "let data = AzureActivity\r\n| where \"{Caller:lable}\" == \"All\" or \"{Caller:lable}\" == \"All\" or Caller in ({Caller})\r\n| where \"{ResourceGroup:lable}\" == \"All\" or \"{ResourceGroup:lable}\" == \"All\" or ResourceGroup in ({ResourceGroup});\r\ndata\r\n| summarize Count = count() by ResourceGroup\r\n| join kind = fullouter (datatable(ResourceGroup:string)['Medium', 'high', 'low']) on ResourceGroup\r\n| project ResourceGroup = iff(ResourceGroup == '', ResourceGroup1, ResourceGroup), Count = iff(ResourceGroup == '', 0, Count)\r\n| join kind = inner (data\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by ResourceGroup)\r\n on ResourceGroup\r\n| project-away ResourceGroup1, TimeGenerated\r\n| extend ResourceGroups = ResourceGroup\r\n| union (\r\n data \r\n | summarize Count = count() \r\n | extend jkey = 1\r\n | join kind=inner (data\r\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n | extend jkey = 1) on jkey\r\n | extend ResourceGroup = 'All', ResourceGroups = '*' \r\n)\r\n| order by Count desc\r\n| take 10",
                            "size": 4,
                            "exportToExcelOptions": "visible",
                            "title": "Top 10 active resource groups",
                            "timeContext": {
                              "durationMs": 0
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "tiles",
                            "tileSettings": {
                              "titleContent": {
                                "columnMatch": "ResourceGroup",
                                "formatter": 1,
                                "formatOptions": {
                                  "showIcon": true
                                }
                              },
                              "leftContent": {
                                "columnMatch": "Count",
                                "formatter": 12,
                                "formatOptions": {
                                  "palette": "auto",
                                  "showIcon": true
                                },
                                "numberFormat": {
                                  "unit": 17,
                                  "options": {
                                    "maximumSignificantDigits": 3,
                                    "maximumFractionDigits": 2
                                  }
                                }
                              },
                              "secondaryContent": {
                                "columnMatch": "Trend",
                                "formatter": 9,
                                "formatOptions": {
                                  "palette": "blueOrange",
                                  "showIcon": true
                                }
                              },
                              "showBorder": false
                            }
                          },
                          "name": "query - 3"
                        },
                        {
                          "type": 3,
                          "content": {
                            "version": "KqlItem/1.0",
                            "query": "AzureActivity\r\n| where \"{Caller:lable}\" == \"All\" or Caller in ({Caller})\r\n| where \"{ResourceGroup:lable}\" == \"All\" or ResourceGroup in ({ResourceGroup})\r\n| summarize deletions = countif(OperationNameValue hassuffix \"delete\"), creations = countif(OperationNameValue hassuffix \"write\"), updates = countif(OperationNameValue hassuffix \"write\"), Activities = count(OperationNameValue) by bin_at(TimeGenerated, 1h, now())\r\n",
                            "size": 0,
                            "exportToExcelOptions": "visible",
                            "title": "Activities over time",
                            "color": "gray",
                            "timeContext": {
                              "durationMs": 0
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "linechart",
                            "graphSettings": {
                              "type": 0
                            }
                          },
                          "name": "query - 1"
                        },
                        {
                          "type": 3,
                          "content": {
                            "version": "KqlItem/1.0",
                            "query": "AzureActivity\r\n| where \"{Caller:lable}\" == \"All\" or Caller in ({Caller})\r\n| where \"{ResourceGroup:lable}\" == \"All\" or ResourceGroup in ({ResourceGroup})\r\n| summarize deletions = countif(OperationNameValue hassuffix \"Delete\"), creations = countif(OperationNameValue hassuffix \"write\"), updates = countif(OperationNameValue hassuffix \"write\"), Activities = count() by Caller\r\n",
                            "size": 1,
                            "exportToExcelOptions": "visible",
                            "title": "Caller activities",
                            "timeContext": {
                              "durationMs": 0
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "gridSettings": {
                              "formatters": [
                                {
                                  "columnMatch": "Caller",
                                  "formatter": 0,
                                  "formatOptions": {
                                    "showIcon": true
                                  }
                                },
                                {
                                  "columnMatch": "deletions",
                                  "formatter": 4,
                                  "formatOptions": {
                                    "showIcon": true,
                                    "aggregation": "Count"
                                  }
                                },
                                {
                                  "columnMatch": "creations",
                                  "formatter": 4,
                                  "formatOptions": {
                                    "palette": "purple",
                                    "showIcon": true,
                                    "aggregation": "Count"
                                  }
                                },
                                {
                                  "columnMatch": "updates",
                                  "formatter": 4,
                                  "formatOptions": {
                                    "palette": "gray",
                                    "showIcon": true,
                                    "aggregation": "Count"
                                  }
                                },
                                {
                                  "columnMatch": "Activities",
                                  "formatter": 4,
                                  "formatOptions": {
                                    "palette": "greenDark",
                                    "linkTarget": "GenericDetails",
                                    "linkIsContextBlade": true,
                                    "showIcon": true,
                                    "aggregation": "Count",
                                    "workbookContext": {
                                      "componentIdSource": "workbook",
                                      "resourceIdsSource": "workbook",
                                      "templateIdSource": "static",
                                      "templateId": "https://go.microsoft.com/fwlink/?linkid=874159&resourceId=%2Fsubscriptions%2F44e4eff8-1fcb-4a22-a7d6-992ac7286382%2FresourceGroups%2FSOC&featureName=Workbooks&itemId=%2Fsubscriptions%2F44e4eff8-1fcb-4a22-a7d6-992ac7286382%2Fresourcegroups%2Fsoc%2Fproviders%2Fmicrosoft.insights%2Fworkbooks%2F4c195aec-747f-40bb-addb-934acb3ec646&name=CiscoASA&func=NavigateToPortalFeature&type=workbook",
                                      "typeSource": "workbook",
                                      "gallerySource": "workbook"
                                    }
                                  }
                                }
                              ],
                              "sortBy": [
                                {
                                  "itemKey": "$gen_bar_updates_3",
                                  "sortOrder": 2
                                }
                              ],
                              "labelSettings": []
                            }
                          },
                          "name": "query - 1"
                        },
                        {
                          "type": 3,
                          "content": {
                            "version": "KqlItem/1.0",
                            "query": "AzureActivity \r\n| where \"{Caller:lable}\" == \"All\" or Caller in ({Caller})\r\n| where \"{ResourceGroup:lable}\" == \"All\" or ResourceGroup in ({ResourceGroup})\r\n| summarize Informational = countif(Level == \"Informational\"), Warning = countif(Level == \"Warning\"), Error = countif(Level == \"Error\") by bin_at(TimeGenerated, 1h, now())\r\n",
                            "size": 0,
                            "exportToExcelOptions": "visible",
                            "title": "Activities by log level over time",
                            "color": "redBright",
                            "timeContext": {
                              "durationMs": 0
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "visualization": "scatterchart",
                            "tileSettings": {
                              "showBorder": false
                            },
                            "graphSettings": {
                              "type": 2,
                              "topContent": {
                                "columnMatch": "Error",
                                "formatter": 12,
                                "formatOptions": {
                                  "showIcon": true
                                }
                              },
                              "hivesContent": {
                                "columnMatch": "TimeGenerated",
                                "formatter": 1,
                                "formatOptions": {
                                  "showIcon": true
                                }
                              },
                              "nodeIdField": "Error",
                              "sourceIdField": "Error",
                              "targetIdField": "Error",
                              "nodeSize": null,
                              "staticNodeSize": 100,
                              "colorSettings": null,
                              "groupByField": "TimeGenerated",
                              "hivesMargin": 5
                            }
                          },
                          "name": "query - 4"
                        }
                      ],
                      "styleSettings": {},
                      "fromTemplateId": "sentinel-AzureActivity",
                      "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Insights/workbooks",
                      "apiVersion": "2023-06-01",
                      "name": "[variables('workbookId')]",
                      "location": "[parameters('location')]",
                      "kind": "shared",
                      "properties": {
                        "displayName": "[parameters('displayName')]",
                        "serializedData": "[string(variables('serializedData'))]",
                        "version": "Notebook/1.0",
                        "sourceId": "[parameters('workspaceResourceId')]",
                        "category": "sentinel"
                      }
                    }
                  ]
                }
              }
            },
            {
              "condition": "[parameters('deployAzureActivitySolution')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-workbook-azure-service-health-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('workspaceSubscriptionId')]",
              "resourceGroup": "[parameters('workspaceResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "workspaceResourceId": {
                    "value": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.OperationalInsights/workspaces/{2}', parameters('workspaceSubscriptionId'), parameters('workspaceResourceGroupName'), parameters('workspaceName'))]"
                  },
                  "location": {
                    "value": "[parameters('workspaceLocation')]"
                  },
                  "displayName": {
                    "value": "[parameters('azureServiceHealthWorkbookName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "workspaceResourceId": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "displayName": {
                      "type": "string",
                      "defaultValue": "Azure Service Health (Activity Logs)"
                    }
                  },
                  "variables": {
                    "workbookId": "[guid(parameters('workspaceResourceId'), 'AzureServiceHealthWorkbook')]",
                    "serializedData": {
                      "version": "Notebook/1.0",
                      "items": [
                        {
                          "type": 1,
                          "content": {
                            "json": "## Azure Activity Logs for Azure Service Health Analysis Workbook"
                          },
                          "name": "text - 1"
                        },
                        {
                          "type": 9,
                          "content": {
                            "version": "KqlParameterItem/1.0",
                            "crossComponentResources": [
                              "{Subscription}"
                            ],
                            "parameters": [
                              {
                                "id": "76e0f423-6828-47f3-aa86-522604bbbc6f",
                                "version": "KqlParameterItem/1.0",
                                "name": "Subscription",
                                "type": 6,
                                "description": "Azure Subscription where is the Log Analytics with Activity Logs informaiton",
                                "isRequired": true,
                                "query": "summarize by subscriptionId\r\n| project value = strcat(\"/subscriptions/\",subscriptionId), label = subscriptionId\r\n| order by value ",
                                "crossComponentResources": [
                                  "value::all"
                                ],
                                "typeSettings": {
                                  "additionalResourceOptions": [],
                                  "showDefault": false
                                },
                                "timeContext": {
                                  "durationMs": 86400000
                                },
                                "queryType": 1,
                                "resourceType": "microsoft.resourcegraph/resources",
                                "value": "/subscriptions/fcb7d51b-418f-45a9-8418-5c0f17e343c8"
                              },
                              {
                                "id": "ea100a5b-3c79-4761-8235-6a7989c83da5",
                                "version": "KqlParameterItem/1.0",
                                "name": "LAworkspace",
                                "label": "Log Analytics workspace",
                                "type": 5,
                                "description": "Log Analytics workspace where the Activity Logs information is sent",
                                "isRequired": true,
                                "query": "where type == 'microsoft.operationalinsights/workspaces'\r\n| project id\r\n| order by id asc",
                                "crossComponentResources": [
                                  "{Subscription}"
                                ],
                                "typeSettings": {
                                  "additionalResourceOptions": [],
                                  "showDefault": false
                                },
                                "timeContext": {
                                  "durationMs": 86400000
                                },
                                "queryType": 1,
                                "resourceType": "microsoft.resourcegraph/resources",
                                "value": ""
                              },
                              {
                                "id": "6b112ffe-a3a2-4b9e-a17a-c4ea5af739d7",
                                "version": "KqlParameterItem/1.0",
                                "name": "TimeRange",
                                "type": 4,
                                "typeSettings": {
                                  "selectableValues": [
                                    {
                                      "durationMs": 3600000
                                    },
                                    {
                                      "durationMs": 86400000
                                    },
                                    {
                                      "durationMs": 259200000
                                    },
                                    {
                                      "durationMs": 604800000
                                    },
                                    {
                                      "durationMs": 1209600000
                                    },
                                    {
                                      "durationMs": 2592000000
                                    }
                                  ],
                                  "allowCustom": true
                                },
                                "timeContext": {
                                  "durationMs": 86400000
                                },
                                "value": {
                                  "durationMs": 2592000000
                                }
                              }
                            ],
                            "style": "pills",
                            "queryType": 1,
                            "resourceType": "microsoft.resourcegraph/resources"
                          },
                          "name": "parameters - 0"
                        },
                        {
                          "type": 9,
                          "content": {
                            "version": "KqlParameterItem/1.0",
                            "crossComponentResources": [
                              "{LAworkspace}"
                            ],
                            "parameters": [
                              {
                                "id": "2fb175cb-a2b6-4dd3-9473-886a8db4cd9c",
                                "version": "KqlParameterItem/1.0",
                                "name": "TrackingID_P",
                                "label": "Tracking ID",
                                "type": 2,
                                "isRequired": true,
                                "multiSelect": true,
                                "quote": "'",
                                "delimiter": ",",
                                "query": "AzureActivity\r\n| where CategoryValue == \"ServiceHealth\"\r\n| extend TrackingId = tostring(Properties_d.trackingId)\r\n| distinct TrackingId\r\n| order by TrackingId asc",
                                "crossComponentResources": [
                                  "{LAworkspace}"
                                ],
                                "typeSettings": {
                                  "additionalResourceOptions": [
                                    "value::all"
                                  ],
                                  "selectAllValue": "All",
                                  "showDefault": false
                                },
                                "timeContext": {
                                  "durationMs": 0
                                },
                                "timeContextFromParameter": "TimeRange",
                                "queryType": 0,
                                "resourceType": "microsoft.operationalinsights/workspaces",
                                "value": [
                                  "value::all"
                                ]
                              }
                            ],
                            "style": "pills",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces"
                          },
                          "name": "parameters - 3"
                        },
                        {
                          "type": 12,
                          "content": {
                            "version": "NotebookGroup/1.0",
                            "groupType": "editable",
                            "items": [
                              {
                                "type": 3,
                                "content": {
                                  "version": "KqlItem/1.0",
                                  "query": "AzureActivity\r\n| where CategoryValue == \"ServiceHealth\" \r\n| summarize TimeGenerated=arg_max(TimeGenerated,*) by SubscriptionId\r\n| extend SubscriptionId == strcat('/subscriptions/', SubscriptionId)",
                                  "size": 1,
                                  "showAnalytics": true,
                                  "title": "Subscriptions Impacted",
                                  "timeContextFromParameter": "TimeRange",
                                  "queryType": 0,
                                  "resourceType": "microsoft.operationalinsights/workspaces",
                                  "crossComponentResources": [
                                    "{LAworkspace}"
                                  ],
                                  "visualization": "tiles",
                                  "gridSettings": {
                                    "formatters": [
                                      {
                                        "columnMatch": "TimeGenerated",
                                        "formatter": 0,
                                        "formatOptions": {
                                          "customColumnWidthSetting": "22ch"
                                        }
                                      }
                                    ]
                                  },
                                  "sortBy": [],
                                  "tileSettings": {
                                    "titleContent": {
                                      "columnMatch": "SubscriptionId",
                                      "formatter": 13,
                                      "formatOptions": {
                                        "linkTarget": null,
                                        "showIcon": true
                                      }
                                    },
                                    "showBorder": false
                                  }
                                },
                                "customWidth": "30",
                                "name": "query - 0 - Copy",
                                "styleSettings": {
                                  "showBorder": true
                                }
                              }
                            ]
                          },
                          "name": "GroupActivityLogs01",
                          "styleSettings": {
                            "showBorder": true
                          }
                        }
                      ],
                      "fallbackResourceIds": [],
                      "fromTemplateId": "sentinel-AzureServiceHealthWorkbook",
                      "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Insights/workbooks",
                      "apiVersion": "2023-06-01",
                      "name": "[variables('workbookId')]",
                      "location": "[parameters('location')]",
                      "kind": "shared",
                      "properties": {
                        "displayName": "[parameters('displayName')]",
                        "serializedData": "[string(variables('serializedData'))]",
                        "version": "Notebook/1.0",
                        "sourceId": "[parameters('workspaceResourceId')]",
                        "category": "sentinel"
                      }
                    }
                  ]
                }
              }
            },
            {
              "condition": "[parameters('deployAzureActivitySolution')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-workbook-azure-service-health-linked-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('workspaceSubscriptionId')]",
              "resourceGroup": "[parameters('workspaceResourceGroupName')]",
              "dependsOn": [
                "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Resources/deployments/{2}', parameters('workspaceSubscriptionId'), parameters('workspaceResourceGroupName'), format('deploy-workbook-azure-service-health-{0}', parameters('deploymentNameSuffix')))]"
              ],
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "workspaceResourceId": {
                    "value": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.OperationalInsights/workspaces/{2}', parameters('workspaceSubscriptionId'), parameters('workspaceResourceGroupName'), parameters('workspaceName'))]"
                  },
                  "location": {
                    "value": "[parameters('workspaceLocation')]"
                  },
                  "displayName": {
                    "value": "[parameters('azureServiceHealthWorkbookName')]"
                  }
                },
                "templateLink": {
                  "uri": "[format('{0}/custom-workbooks/deploy/AzureServiceHealthWorkbook.workbook.template.json', parameters('templateBaseUri'))]",
                  "contentVersion": "1.0.0.0"
                }
              }
            },
            {
              "condition": "[parameters('deployMicrosoftEntraSolution')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-workbook-entra-audit-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('workspaceSubscriptionId')]",
              "resourceGroup": "[parameters('workspaceResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "workspaceResourceId": {
                    "value": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.OperationalInsights/workspaces/{2}', parameters('workspaceSubscriptionId'), parameters('workspaceResourceGroupName'), parameters('workspaceName'))]"
                  },
                  "location": {
                    "value": "[parameters('workspaceLocation')]"
                  },
                  "displayName": {
                    "value": "[parameters('entraAuditWorkbookName')]"
                  }
                },
                "templateLink": {
                  "uri": "[format('{0}/custom-workbooks/deploy/AzureActiveDirectoryAuditLogs.workbook.template.json', parameters('templateBaseUri'))]",
                  "contentVersion": "1.0.0.0"
                }
              }
            },
            {
              "condition": "[parameters('deployMicrosoftEntraSolution')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-workbook-entra-signin-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('workspaceSubscriptionId')]",
              "resourceGroup": "[parameters('workspaceResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "workspaceResourceId": {
                    "value": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.OperationalInsights/workspaces/{2}', parameters('workspaceSubscriptionId'), parameters('workspaceResourceGroupName'), parameters('workspaceName'))]"
                  },
                  "location": {
                    "value": "[parameters('workspaceLocation')]"
                  },
                  "displayName": {
                    "value": "[parameters('entraSigninWorkbookName')]"
                  }
                },
                "templateLink": {
                  "uri": "[format('{0}/custom-workbooks/deploy/AzureActiveDirectorySignins.workbook.template.json', parameters('templateBaseUri'))]",
                  "contentVersion": "1.0.0.0"
                }
              }
            },
            {
              "condition": "[parameters('deployMicrosoftEntraSolution')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-entra-solution-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('workspaceSubscriptionId')]",
              "resourceGroup": "[parameters('workspaceResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('workspaceLocation')]"
                  },
                  "workspace-location": {
                    "value": "[parameters('workspaceLocation')]"
                  },
                  "workspace": {
                    "value": "[parameters('workspaceName')]"
                  },
                  "workbook1-name": {
                    "value": "[parameters('entraAuditWorkbookName')]"
                  },
                  "workbook2-name": {
                    "value": "[parameters('entraSigninWorkbookName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "author": "Microsoft - support@microsoft.com",
                    "comments": "Solution template for Microsoft Entra ID"
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "minLength": 1,
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
                      }
                    },
                    "workspace-location": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
                      }
                    },
                    "workspace": {
                      "defaultValue": "",
                      "type": "string",
                      "metadata": {
                        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
                      }
                    },
                    "workbook1-name": {
                      "type": "string",
                      "defaultValue": "Microsoft Entra ID Audit logs",
                      "minLength": 1,
                      "metadata": {
                        "description": "Name for the workbook"
                      }
                    },
                    "workbook2-name": {
                      "type": "string",
                      "defaultValue": "Microsoft Entra ID Sign-in logs",
                      "minLength": 1,
                      "metadata": {
                        "description": "Name for the workbook"
                      }
                    }
                  },
                  "variables": {
                    "email": "support@microsoft.com",
                    "_email": "[variables('email')]",
                    "_solutionName": "Microsoft Entra ID",
                    "_solutionVersion": "3.3.6",
                    "solutionId": "azuresentinel.azure-sentinel-solution-azureactivedirectory",
                    "_solutionId": "[variables('solutionId')]",
                    "uiConfigId1": "AzureActiveDirectory",
                    "_uiConfigId1": "[variables('uiConfigId1')]",
                    "dataConnectorContentId1": "AzureActiveDirectory",
                    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
                    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                    "_dataConnectorId1": "[variables('dataConnectorId1')]",
                    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1'))))]",
                    "dataConnectorVersion1": "1.0.0",
                    "_dataConnectorcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentId1'),'-', variables('dataConnectorVersion1'))))]",
                    "workbookVersion1": "1.2.0",
                    "workbookContentId1": "AzureActiveDirectoryAuditLogsWorkbook",
                    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
                    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
                    "_workbookContentId1": "[variables('workbookContentId1')]",
                    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
                    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
                    "workbookVersion2": "2.4.0",
                    "workbookContentId2": "AzureActiveDirectorySigninLogsWorkbook",
                    "workbookId2": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId2'))]",
                    "workbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId2'))))]",
                    "_workbookContentId2": "[variables('workbookContentId2')]",
                    "_workbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId2'),'-', variables('workbookVersion2'))))]",
                    "analyticRuleObject1": {
                      "analyticRuleVersion1": "1.1.0",
                      "_analyticRulecontentId1": "bb616d82-108f-47d3-9dec-9652ea0d3bf6",
                      "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'bb616d82-108f-47d3-9dec-9652ea0d3bf6')]",
                      "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('bb616d82-108f-47d3-9dec-9652ea0d3bf6')))]",
                      "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','bb616d82-108f-47d3-9dec-9652ea0d3bf6','-', '1.1.0')))]"
                    },
                    "analyticRuleObject2": {
                      "analyticRuleVersion2": "1.1.1",
                      "_analyticRulecontentId2": "6d63efa6-7c25-4bd4-a486-aa6bf50fde8a",
                      "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '6d63efa6-7c25-4bd4-a486-aa6bf50fde8a')]",
                      "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('6d63efa6-7c25-4bd4-a486-aa6bf50fde8a')))]",
                      "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','6d63efa6-7c25-4bd4-a486-aa6bf50fde8a','-', '1.1.1')))]"
                    },
                    "analyticRuleObject3": {
                      "analyticRuleVersion3": "1.1.2",
                      "_analyticRulecontentId3": "95dc4ae3-e0f2-48bd-b996-cdd22b90f9af",
                      "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '95dc4ae3-e0f2-48bd-b996-cdd22b90f9af')]",
                      "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('95dc4ae3-e0f2-48bd-b996-cdd22b90f9af')))]",
                      "_analyticRulecontentProductId3": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','95dc4ae3-e0f2-48bd-b996-cdd22b90f9af','-', '1.1.2')))]"
                    },
                    "analyticRuleObject4": {
                      "analyticRuleVersion4": "1.0.1",
                      "_analyticRulecontentId4": "5533fe80-905e-49d5-889a-df27d2c3976d",
                      "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '5533fe80-905e-49d5-889a-df27d2c3976d')]",
                      "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('5533fe80-905e-49d5-889a-df27d2c3976d')))]",
                      "_analyticRulecontentProductId4": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','5533fe80-905e-49d5-889a-df27d2c3976d','-', '1.0.1')))]"
                    },
                    "analyticRuleObject5": {
                      "analyticRuleVersion5": "1.1.0",
                      "_analyticRulecontentId5": "f80d951a-eddc-4171-b9d0-d616bb83efdc",
                      "analyticRuleId5": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'f80d951a-eddc-4171-b9d0-d616bb83efdc')]",
                      "analyticRuleTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('f80d951a-eddc-4171-b9d0-d616bb83efdc')))]",
                      "_analyticRulecontentProductId5": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','f80d951a-eddc-4171-b9d0-d616bb83efdc','-', '1.1.0')))]"
                    },
                    "analyticRuleObject6": {
                      "analyticRuleVersion6": "2.0.5",
                      "_analyticRulecontentId6": "7cb8f77d-c52f-4e46-b82f-3cf2e106224a",
                      "analyticRuleId6": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '7cb8f77d-c52f-4e46-b82f-3cf2e106224a')]",
                      "analyticRuleTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('7cb8f77d-c52f-4e46-b82f-3cf2e106224a')))]",
                      "_analyticRulecontentProductId6": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','7cb8f77d-c52f-4e46-b82f-3cf2e106224a','-', '2.0.5')))]"
                    },
                    "analyticRuleObject7": {
                      "analyticRuleVersion7": "1.1.1",
                      "_analyticRulecontentId7": "694c91ee-d606-4ba9-928e-405a2dd0ff0f",
                      "analyticRuleId7": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '694c91ee-d606-4ba9-928e-405a2dd0ff0f')]",
                      "analyticRuleTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('694c91ee-d606-4ba9-928e-405a2dd0ff0f')))]",
                      "_analyticRulecontentProductId7": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','694c91ee-d606-4ba9-928e-405a2dd0ff0f','-', '1.1.1')))]"
                    },
                    "analyticRuleObject8": {
                      "analyticRuleVersion8": "1.0.4",
                      "_analyticRulecontentId8": "50574fac-f8d1-4395-81c7-78a463ff0c52",
                      "analyticRuleId8": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '50574fac-f8d1-4395-81c7-78a463ff0c52')]",
                      "analyticRuleTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('50574fac-f8d1-4395-81c7-78a463ff0c52')))]",
                      "_analyticRulecontentProductId8": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','50574fac-f8d1-4395-81c7-78a463ff0c52','-', '1.0.4')))]"
                    },
                    "analyticRuleObject9": {
                      "analyticRuleVersion9": "1.1.1",
                      "_analyticRulecontentId9": "1ff56009-db01-4615-8211-d4fda21da02d",
                      "analyticRuleId9": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '1ff56009-db01-4615-8211-d4fda21da02d')]",
                      "analyticRuleTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('1ff56009-db01-4615-8211-d4fda21da02d')))]",
                      "_analyticRulecontentProductId9": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','1ff56009-db01-4615-8211-d4fda21da02d','-', '1.1.1')))]"
                    },
                    "analyticRuleObject10": {
                      "analyticRuleVersion10": "2.0.3",
                      "_analyticRulecontentId10": "87210ca1-49a4-4a7d-bb4a-4988752f978c",
                      "analyticRuleId10": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '87210ca1-49a4-4a7d-bb4a-4988752f978c')]",
                      "analyticRuleTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('87210ca1-49a4-4a7d-bb4a-4988752f978c')))]",
                      "_analyticRulecontentProductId10": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','87210ca1-49a4-4a7d-bb4a-4988752f978c','-', '2.0.3')))]"
                    },
                    "analyticRuleObject11": {
                      "analyticRuleVersion11": "2.0.2",
                      "_analyticRulecontentId11": "97ad74c4-fdd9-4a3f-b6bf-5e28f4f71e06",
                      "analyticRuleId11": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '97ad74c4-fdd9-4a3f-b6bf-5e28f4f71e06')]",
                      "analyticRuleTemplateSpecName11": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('97ad74c4-fdd9-4a3f-b6bf-5e28f4f71e06')))]",
                      "_analyticRulecontentProductId11": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','97ad74c4-fdd9-4a3f-b6bf-5e28f4f71e06','-', '2.0.2')))]"
                    },
                    "analyticRuleObject12": {
                      "analyticRuleVersion12": "2.0.1",
                      "_analyticRulecontentId12": "3fbc20a4-04c4-464e-8fcb-6667f53e4987",
                      "analyticRuleId12": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '3fbc20a4-04c4-464e-8fcb-6667f53e4987')]",
                      "analyticRuleTemplateSpecName12": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('3fbc20a4-04c4-464e-8fcb-6667f53e4987')))]",
                      "_analyticRulecontentProductId12": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','3fbc20a4-04c4-464e-8fcb-6667f53e4987','-', '2.0.1')))]"
                    },
                    "analyticRuleObject13": {
                      "analyticRuleVersion13": "1.0.7",
                      "_analyticRulecontentId13": "218f60de-c269-457a-b882-9966632b9dc6",
                      "analyticRuleId13": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '218f60de-c269-457a-b882-9966632b9dc6')]",
                      "analyticRuleTemplateSpecName13": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('218f60de-c269-457a-b882-9966632b9dc6')))]",
                      "_analyticRulecontentProductId13": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','218f60de-c269-457a-b882-9966632b9dc6','-', '1.0.7')))]"
                    },
                    "analyticRuleObject14": {
                      "analyticRuleVersion14": "1.0.7",
                      "_analyticRulecontentId14": "3af9285d-bb98-4a35-ad29-5ea39ba0c628",
                      "analyticRuleId14": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '3af9285d-bb98-4a35-ad29-5ea39ba0c628')]",
                      "analyticRuleTemplateSpecName14": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('3af9285d-bb98-4a35-ad29-5ea39ba0c628')))]",
                      "_analyticRulecontentProductId14": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','3af9285d-bb98-4a35-ad29-5ea39ba0c628','-', '1.0.7')))]"
                    },
                    "analyticRuleObject15": {
                      "analyticRuleVersion15": "1.1.1",
                      "_analyticRulecontentId15": "707494a5-8e44-486b-90f8-155d1797a8eb",
                      "analyticRuleId15": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '707494a5-8e44-486b-90f8-155d1797a8eb')]",
                      "analyticRuleTemplateSpecName15": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('707494a5-8e44-486b-90f8-155d1797a8eb')))]",
                      "_analyticRulecontentProductId15": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','707494a5-8e44-486b-90f8-155d1797a8eb','-', '1.1.1')))]"
                    },
                    "analyticRuleObject16": {
                      "analyticRuleVersion16": "1.1.1",
                      "_analyticRulecontentId16": "757e6a79-6d23-4ae6-9845-4dac170656b5",
                      "analyticRuleId16": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '757e6a79-6d23-4ae6-9845-4dac170656b5')]",
                      "analyticRuleTemplateSpecName16": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('757e6a79-6d23-4ae6-9845-4dac170656b5')))]",
                      "_analyticRulecontentProductId16": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','757e6a79-6d23-4ae6-9845-4dac170656b5','-', '1.1.1')))]"
                    },
                    "analyticRuleObject17": {
                      "analyticRuleVersion17": "1.1.1",
                      "_analyticRulecontentId17": "eb8a9c1c-f532-4630-817c-1ecd8a60ed80",
                      "analyticRuleId17": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'eb8a9c1c-f532-4630-817c-1ecd8a60ed80')]",
                      "analyticRuleTemplateSpecName17": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('eb8a9c1c-f532-4630-817c-1ecd8a60ed80')))]",
                      "_analyticRulecontentProductId17": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','eb8a9c1c-f532-4630-817c-1ecd8a60ed80','-', '1.1.1')))]"
                    },
                    "analyticRuleObject18": {
                      "analyticRuleVersion18": "1.1.1",
                      "_analyticRulecontentId18": "c895c5b9-0fc6-40ce-9830-e8818862f2d5",
                      "analyticRuleId18": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'c895c5b9-0fc6-40ce-9830-e8818862f2d5')]",
                      "analyticRuleTemplateSpecName18": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('c895c5b9-0fc6-40ce-9830-e8818862f2d5')))]",
                      "_analyticRulecontentProductId18": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','c895c5b9-0fc6-40ce-9830-e8818862f2d5','-', '1.1.1')))]"
                    },
                    "analyticRuleObject19": {
                      "analyticRuleVersion19": "1.1.1",
                      "_analyticRulecontentId19": "276d5190-38de-4eb2-9933-b3b72f4a5737",
                      "analyticRuleId19": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '276d5190-38de-4eb2-9933-b3b72f4a5737')]",
                      "analyticRuleTemplateSpecName19": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('276d5190-38de-4eb2-9933-b3b72f4a5737')))]",
                      "_analyticRulecontentProductId19": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','276d5190-38de-4eb2-9933-b3b72f4a5737','-', '1.1.1')))]"
                    },
                    "analyticRuleObject20": {
                      "analyticRuleVersion20": "1.1.1",
                      "_analyticRulecontentId20": "229f71ba-d83b-42a5-b83b-11a641049ed1",
                      "analyticRuleId20": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '229f71ba-d83b-42a5-b83b-11a641049ed1')]",
                      "analyticRuleTemplateSpecName20": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('229f71ba-d83b-42a5-b83b-11a641049ed1')))]",
                      "_analyticRulecontentProductId20": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','229f71ba-d83b-42a5-b83b-11a641049ed1','-', '1.1.1')))]"
                    },
                    "analyticRuleObject21": {
                      "analyticRuleVersion21": "1.1.1",
                      "_analyticRulecontentId21": "0101e08d-99cd-4a97-a9e0-27649c4369ad",
                      "analyticRuleId21": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '0101e08d-99cd-4a97-a9e0-27649c4369ad')]",
                      "analyticRuleTemplateSpecName21": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('0101e08d-99cd-4a97-a9e0-27649c4369ad')))]",
                      "_analyticRulecontentProductId21": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','0101e08d-99cd-4a97-a9e0-27649c4369ad','-', '1.1.1')))]"
                    },
                    "analyticRuleObject22": {
                      "analyticRuleVersion22": "1.0.3",
                      "_analyticRulecontentId22": "75ea5c39-93e5-489b-b1e1-68fa6c9d2d04",
                      "analyticRuleId22": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '75ea5c39-93e5-489b-b1e1-68fa6c9d2d04')]",
                      "analyticRuleTemplateSpecName22": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('75ea5c39-93e5-489b-b1e1-68fa6c9d2d04')))]",
                      "_analyticRulecontentProductId22": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','75ea5c39-93e5-489b-b1e1-68fa6c9d2d04','-', '1.0.3')))]"
                    },
                    "analyticRuleObject23": {
                      "analyticRuleVersion23": "1.0.5",
                      "_analyticRulecontentId23": "bfb1c90f-8006-4325-98be-c7fffbc254d6",
                      "analyticRuleId23": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'bfb1c90f-8006-4325-98be-c7fffbc254d6')]",
                      "analyticRuleTemplateSpecName23": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('bfb1c90f-8006-4325-98be-c7fffbc254d6')))]",
                      "_analyticRulecontentProductId23": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','bfb1c90f-8006-4325-98be-c7fffbc254d6','-', '1.0.5')))]"
                    },
                    "analyticRuleObject24": {
                      "analyticRuleVersion24": "1.0.7",
                      "_analyticRulecontentId24": "a22740ec-fc1e-4c91-8de6-c29c6450ad00",
                      "analyticRuleId24": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'a22740ec-fc1e-4c91-8de6-c29c6450ad00')]",
                      "analyticRuleTemplateSpecName24": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('a22740ec-fc1e-4c91-8de6-c29c6450ad00')))]",
                      "_analyticRulecontentProductId24": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','a22740ec-fc1e-4c91-8de6-c29c6450ad00','-', '1.0.7')))]"
                    },
                    "analyticRuleObject25": {
                      "analyticRuleVersion25": "1.0.2",
                      "_analyticRulecontentId25": "54e22fed-0ec6-4fb2-8312-2a3809a93f63",
                      "analyticRuleId25": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '54e22fed-0ec6-4fb2-8312-2a3809a93f63')]",
                      "analyticRuleTemplateSpecName25": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('54e22fed-0ec6-4fb2-8312-2a3809a93f63')))]",
                      "_analyticRulecontentProductId25": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','54e22fed-0ec6-4fb2-8312-2a3809a93f63','-', '1.0.2')))]"
                    },
                    "analyticRuleObject26": {
                      "analyticRuleVersion26": "1.0.7",
                      "_analyticRulecontentId26": "223db5c1-1bf8-47d8-8806-bed401b356a4",
                      "analyticRuleId26": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '223db5c1-1bf8-47d8-8806-bed401b356a4')]",
                      "analyticRuleTemplateSpecName26": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('223db5c1-1bf8-47d8-8806-bed401b356a4')))]",
                      "_analyticRulecontentProductId26": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','223db5c1-1bf8-47d8-8806-bed401b356a4','-', '1.0.7')))]"
                    },
                    "analyticRuleObject27": {
                      "analyticRuleVersion27": "1.1.5",
                      "_analyticRulecontentId27": "2cfc3c6e-f424-4b88-9cc9-c89f482d016a",
                      "analyticRuleId27": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '2cfc3c6e-f424-4b88-9cc9-c89f482d016a')]",
                      "analyticRuleTemplateSpecName27": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('2cfc3c6e-f424-4b88-9cc9-c89f482d016a')))]",
                      "_analyticRulecontentProductId27": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','2cfc3c6e-f424-4b88-9cc9-c89f482d016a','-', '1.1.5')))]"
                    },
                    "analyticRuleObject28": {
                      "analyticRuleVersion28": "1.0.6",
                      "_analyticRulecontentId28": "6ab1f7b2-61b8-442f-bc81-96afe7ad8c53",
                      "analyticRuleId28": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '6ab1f7b2-61b8-442f-bc81-96afe7ad8c53')]",
                      "analyticRuleTemplateSpecName28": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('6ab1f7b2-61b8-442f-bc81-96afe7ad8c53')))]",
                      "_analyticRulecontentProductId28": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','6ab1f7b2-61b8-442f-bc81-96afe7ad8c53','-', '1.0.6')))]"
                    },
                    "analyticRuleObject29": {
                      "analyticRuleVersion29": "1.0.4",
                      "_analyticRulecontentId29": "2560515c-07d1-434e-87fb-ebe3af267760",
                      "analyticRuleId29": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '2560515c-07d1-434e-87fb-ebe3af267760')]",
                      "analyticRuleTemplateSpecName29": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('2560515c-07d1-434e-87fb-ebe3af267760')))]",
                      "_analyticRulecontentProductId29": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','2560515c-07d1-434e-87fb-ebe3af267760','-', '1.0.4')))]"
                    },
                    "analyticRuleObject30": {
                      "analyticRuleVersion30": "1.1.2",
                      "_analyticRulecontentId30": "f948a32f-226c-4116-bddd-d95e91d97eb9",
                      "analyticRuleId30": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'f948a32f-226c-4116-bddd-d95e91d97eb9')]",
                      "analyticRuleTemplateSpecName30": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('f948a32f-226c-4116-bddd-d95e91d97eb9')))]",
                      "_analyticRulecontentProductId30": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','f948a32f-226c-4116-bddd-d95e91d97eb9','-', '1.1.2')))]"
                    },
                    "analyticRuleObject31": {
                      "analyticRuleVersion31": "1.0.2",
                      "_analyticRulecontentId31": "39198934-62a0-4781-8416-a81265c03fd6",
                      "analyticRuleId31": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '39198934-62a0-4781-8416-a81265c03fd6')]",
                      "analyticRuleTemplateSpecName31": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('39198934-62a0-4781-8416-a81265c03fd6')))]",
                      "_analyticRulecontentProductId31": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','39198934-62a0-4781-8416-a81265c03fd6','-', '1.0.2')))]"
                    },
                    "analyticRuleObject32": {
                      "analyticRuleVersion32": "2.0.4",
                      "_analyticRulecontentId32": "d99cf5c3-d660-436c-895b-8a8f8448da23",
                      "analyticRuleId32": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'd99cf5c3-d660-436c-895b-8a8f8448da23')]",
                      "analyticRuleTemplateSpecName32": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('d99cf5c3-d660-436c-895b-8a8f8448da23')))]",
                      "_analyticRulecontentProductId32": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','d99cf5c3-d660-436c-895b-8a8f8448da23','-', '2.0.4')))]"
                    },
                    "analyticRuleObject33": {
                      "analyticRuleVersion33": "1.0.4",
                      "_analyticRulecontentId33": "a8cc6d5c-4e7e-4b48-b4ac-d8a116c62a8b",
                      "analyticRuleId33": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'a8cc6d5c-4e7e-4b48-b4ac-d8a116c62a8b')]",
                      "analyticRuleTemplateSpecName33": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('a8cc6d5c-4e7e-4b48-b4ac-d8a116c62a8b')))]",
                      "_analyticRulecontentProductId33": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','a8cc6d5c-4e7e-4b48-b4ac-d8a116c62a8b','-', '1.0.4')))]"
                    },
                    "analyticRuleObject34": {
                      "analyticRuleVersion34": "1.0.3",
                      "_analyticRulecontentId34": "cda5928c-2c1e-4575-9dfa-07568bc27a4f",
                      "analyticRuleId34": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'cda5928c-2c1e-4575-9dfa-07568bc27a4f')]",
                      "analyticRuleTemplateSpecName34": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('cda5928c-2c1e-4575-9dfa-07568bc27a4f')))]",
                      "_analyticRulecontentProductId34": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','cda5928c-2c1e-4575-9dfa-07568bc27a4f','-', '1.0.3')))]"
                    },
                    "analyticRuleObject35": {
                      "analyticRuleVersion35": "1.0.1",
                      "_analyticRulecontentId35": "4f42b94f-b210-42d1-a023-7fa1c51d969f",
                      "analyticRuleId35": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '4f42b94f-b210-42d1-a023-7fa1c51d969f')]",
                      "analyticRuleTemplateSpecName35": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('4f42b94f-b210-42d1-a023-7fa1c51d969f')))]",
                      "_analyticRulecontentProductId35": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','4f42b94f-b210-42d1-a023-7fa1c51d969f','-', '1.0.1')))]"
                    },
                    "analyticRuleObject36": {
                      "analyticRuleVersion36": "1.1.2",
                      "_analyticRulecontentId36": "79566f41-df67-4e10-a703-c38a6213afd8",
                      "analyticRuleId36": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '79566f41-df67-4e10-a703-c38a6213afd8')]",
                      "analyticRuleTemplateSpecName36": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('79566f41-df67-4e10-a703-c38a6213afd8')))]",
                      "_analyticRulecontentProductId36": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','79566f41-df67-4e10-a703-c38a6213afd8','-', '1.1.2')))]"
                    },
                    "analyticRuleObject37": {
                      "analyticRuleVersion37": "1.0.3",
                      "_analyticRulecontentId37": "8540c842-5bbc-4a24-9fb2-a836c0e55a51",
                      "analyticRuleId37": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '8540c842-5bbc-4a24-9fb2-a836c0e55a51')]",
                      "analyticRuleTemplateSpecName37": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('8540c842-5bbc-4a24-9fb2-a836c0e55a51')))]",
                      "_analyticRulecontentProductId37": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','8540c842-5bbc-4a24-9fb2-a836c0e55a51','-', '1.0.3')))]"
                    },
                    "analyticRuleObject38": {
                      "analyticRuleVersion38": "1.0.5",
                      "_analyticRulecontentId38": "29e99017-e28d-47be-8b9a-c8c711f8a903",
                      "analyticRuleId38": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '29e99017-e28d-47be-8b9a-c8c711f8a903')]",
                      "analyticRuleTemplateSpecName38": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('29e99017-e28d-47be-8b9a-c8c711f8a903')))]",
                      "_analyticRulecontentProductId38": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','29e99017-e28d-47be-8b9a-c8c711f8a903','-', '1.0.5')))]"
                    },
                    "analyticRuleObject39": {
                      "analyticRuleVersion39": "1.0.6",
                      "_analyticRulecontentId39": "b6988c32-4f3b-4a45-8313-b46b33061a74",
                      "analyticRuleId39": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'b6988c32-4f3b-4a45-8313-b46b33061a74')]",
                      "analyticRuleTemplateSpecName39": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('b6988c32-4f3b-4a45-8313-b46b33061a74')))]",
                      "_analyticRulecontentProductId39": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','b6988c32-4f3b-4a45-8313-b46b33061a74','-', '1.0.6')))]"
                    },
                    "analyticRuleObject40": {
                      "analyticRuleVersion40": "1.0.5",
                      "_analyticRulecontentId40": "e42e889a-caaf-4dbb-aec6-371b37d64298",
                      "analyticRuleId40": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'e42e889a-caaf-4dbb-aec6-371b37d64298')]",
                      "analyticRuleTemplateSpecName40": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('e42e889a-caaf-4dbb-aec6-371b37d64298')))]",
                      "_analyticRulecontentProductId40": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','e42e889a-caaf-4dbb-aec6-371b37d64298','-', '1.0.5')))]"
                    },
                    "analyticRuleObject41": {
                      "analyticRuleVersion41": "1.0.4",
                      "_analyticRulecontentId41": "5db427b2-f406-4274-b413-e9fcb29412f8",
                      "analyticRuleId41": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '5db427b2-f406-4274-b413-e9fcb29412f8')]",
                      "analyticRuleTemplateSpecName41": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('5db427b2-f406-4274-b413-e9fcb29412f8')))]",
                      "_analyticRulecontentProductId41": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','5db427b2-f406-4274-b413-e9fcb29412f8','-', '1.0.4')))]"
                    },
                    "analyticRuleObject42": {
                      "analyticRuleVersion42": "1.0.3",
                      "_analyticRulecontentId42": "14f6da04-2f96-44ee-9210-9ccc1be6401e",
                      "analyticRuleId42": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '14f6da04-2f96-44ee-9210-9ccc1be6401e')]",
                      "analyticRuleTemplateSpecName42": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('14f6da04-2f96-44ee-9210-9ccc1be6401e')))]",
                      "_analyticRulecontentProductId42": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','14f6da04-2f96-44ee-9210-9ccc1be6401e','-', '1.0.3')))]"
                    },
                    "analyticRuleObject43": {
                      "analyticRuleVersion43": "1.0.7",
                      "_analyticRulecontentId43": "70fc7201-f28e-4ba7-b9ea-c04b96701f13",
                      "analyticRuleId43": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '70fc7201-f28e-4ba7-b9ea-c04b96701f13')]",
                      "analyticRuleTemplateSpecName43": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('70fc7201-f28e-4ba7-b9ea-c04b96701f13')))]",
                      "_analyticRulecontentProductId43": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','70fc7201-f28e-4ba7-b9ea-c04b96701f13','-', '1.0.7')))]"
                    },
                    "analyticRuleObject44": {
                      "analyticRuleVersion44": "1.0.8",
                      "_analyticRulecontentId44": "7d7e20f8-3384-4b71-811c-f5e950e8306c",
                      "analyticRuleId44": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '7d7e20f8-3384-4b71-811c-f5e950e8306c')]",
                      "analyticRuleTemplateSpecName44": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('7d7e20f8-3384-4b71-811c-f5e950e8306c')))]",
                      "_analyticRulecontentProductId44": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','7d7e20f8-3384-4b71-811c-f5e950e8306c','-', '1.0.8')))]"
                    },
                    "analyticRuleObject45": {
                      "analyticRuleVersion45": "1.0.0",
                      "_analyticRulecontentId45": "fa00014c-c5f4-4715-8f5b-ba567e19e41e",
                      "analyticRuleId45": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'fa00014c-c5f4-4715-8f5b-ba567e19e41e')]",
                      "analyticRuleTemplateSpecName45": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('fa00014c-c5f4-4715-8f5b-ba567e19e41e')))]",
                      "_analyticRulecontentProductId45": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','fa00014c-c5f4-4715-8f5b-ba567e19e41e','-', '1.0.0')))]"
                    },
                    "analyticRuleObject46": {
                      "analyticRuleVersion46": "1.1.1",
                      "_analyticRulecontentId46": "34c5aff9-a8c2-4601-9654-c7e46342d03b",
                      "analyticRuleId46": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '34c5aff9-a8c2-4601-9654-c7e46342d03b')]",
                      "analyticRuleTemplateSpecName46": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('34c5aff9-a8c2-4601-9654-c7e46342d03b')))]",
                      "_analyticRulecontentProductId46": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','34c5aff9-a8c2-4601-9654-c7e46342d03b','-', '1.1.1')))]"
                    },
                    "analyticRuleObject47": {
                      "analyticRuleVersion47": "1.0.6",
                      "_analyticRulecontentId47": "269435e3-1db8-4423-9dfc-9bf59997da1c",
                      "analyticRuleId47": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '269435e3-1db8-4423-9dfc-9bf59997da1c')]",
                      "analyticRuleTemplateSpecName47": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('269435e3-1db8-4423-9dfc-9bf59997da1c')))]",
                      "_analyticRulecontentProductId47": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','269435e3-1db8-4423-9dfc-9bf59997da1c','-', '1.0.6')))]"
                    },
                    "analyticRuleObject48": {
                      "analyticRuleVersion48": "1.1.5",
                      "_analyticRulecontentId48": "83ba3057-9ea3-4759-bf6a-933f2e5bc7ee",
                      "analyticRuleId48": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '83ba3057-9ea3-4759-bf6a-933f2e5bc7ee')]",
                      "analyticRuleTemplateSpecName48": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('83ba3057-9ea3-4759-bf6a-933f2e5bc7ee')))]",
                      "_analyticRulecontentProductId48": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','83ba3057-9ea3-4759-bf6a-933f2e5bc7ee','-', '1.1.5')))]"
                    },
                    "analyticRuleObject49": {
                      "analyticRuleVersion49": "1.0.4",
                      "_analyticRulecontentId49": "fb7ca1c9-e14c-40a3-856e-28f3c14ea1ba",
                      "analyticRuleId49": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'fb7ca1c9-e14c-40a3-856e-28f3c14ea1ba')]",
                      "analyticRuleTemplateSpecName49": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('fb7ca1c9-e14c-40a3-856e-28f3c14ea1ba')))]",
                      "_analyticRulecontentProductId49": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','fb7ca1c9-e14c-40a3-856e-28f3c14ea1ba','-', '1.0.4')))]"
                    },
                    "analyticRuleObject50": {
                      "analyticRuleVersion50": "1.0.3",
                      "_analyticRulecontentId50": "d3980830-dd9d-40a5-911f-76b44dfdce16",
                      "analyticRuleId50": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'd3980830-dd9d-40a5-911f-76b44dfdce16')]",
                      "analyticRuleTemplateSpecName50": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('d3980830-dd9d-40a5-911f-76b44dfdce16')))]",
                      "_analyticRulecontentProductId50": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','d3980830-dd9d-40a5-911f-76b44dfdce16','-', '1.0.3')))]"
                    },
                    "analyticRuleObject51": {
                      "analyticRuleVersion51": "2.1.3",
                      "_analyticRulecontentId51": "500c103a-0319-4d56-8e99-3cec8d860757",
                      "analyticRuleId51": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '500c103a-0319-4d56-8e99-3cec8d860757')]",
                      "analyticRuleTemplateSpecName51": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('500c103a-0319-4d56-8e99-3cec8d860757')))]",
                      "_analyticRulecontentProductId51": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','500c103a-0319-4d56-8e99-3cec8d860757','-', '2.1.3')))]"
                    },
                    "analyticRuleObject52": {
                      "analyticRuleVersion52": "2.1.4",
                      "_analyticRulecontentId52": "28b42356-45af-40a6-a0b4-a554cdfd5d8a",
                      "analyticRuleId52": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '28b42356-45af-40a6-a0b4-a554cdfd5d8a')]",
                      "analyticRuleTemplateSpecName52": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('28b42356-45af-40a6-a0b4-a554cdfd5d8a')))]",
                      "_analyticRulecontentProductId52": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','28b42356-45af-40a6-a0b4-a554cdfd5d8a','-', '2.1.4')))]"
                    },
                    "analyticRuleObject53": {
                      "analyticRuleVersion53": "1.0.7",
                      "_analyticRulecontentId53": "48607a29-a26a-4abf-8078-a06dbdd174a4",
                      "analyticRuleId53": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '48607a29-a26a-4abf-8078-a06dbdd174a4')]",
                      "analyticRuleTemplateSpecName53": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('48607a29-a26a-4abf-8078-a06dbdd174a4')))]",
                      "_analyticRulecontentProductId53": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','48607a29-a26a-4abf-8078-a06dbdd174a4','-', '1.0.7')))]"
                    },
                    "analyticRuleObject54": {
                      "analyticRuleVersion54": "2.1.11",
                      "_analyticRulecontentId54": "02ef8d7e-fc3a-4d86-a457-650fa571d8d2",
                      "analyticRuleId54": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '02ef8d7e-fc3a-4d86-a457-650fa571d8d2')]",
                      "analyticRuleTemplateSpecName54": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('02ef8d7e-fc3a-4d86-a457-650fa571d8d2')))]",
                      "_analyticRulecontentProductId54": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','02ef8d7e-fc3a-4d86-a457-650fa571d8d2','-', '2.1.11')))]"
                    },
                    "analyticRuleObject55": {
                      "analyticRuleVersion55": "1.0.4",
                      "_analyticRulecontentId55": "3a3c6835-0086-40ca-b033-a93bf26d878f",
                      "analyticRuleId55": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '3a3c6835-0086-40ca-b033-a93bf26d878f')]",
                      "analyticRuleTemplateSpecName55": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('3a3c6835-0086-40ca-b033-a93bf26d878f')))]",
                      "_analyticRulecontentProductId55": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','3a3c6835-0086-40ca-b033-a93bf26d878f','-', '1.0.4')))]"
                    },
                    "analyticRuleObject56": {
                      "analyticRuleVersion56": "1.0.2",
                      "_analyticRulecontentId56": "3533f74c-9207-4047-96e2-0eb9383be587",
                      "analyticRuleId56": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '3533f74c-9207-4047-96e2-0eb9383be587')]",
                      "analyticRuleTemplateSpecName56": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('3533f74c-9207-4047-96e2-0eb9383be587')))]",
                      "_analyticRulecontentProductId56": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','3533f74c-9207-4047-96e2-0eb9383be587','-', '1.0.2')))]"
                    },
                    "analyticRuleObject57": {
                      "analyticRuleVersion57": "1.0.4",
                      "_analyticRulecontentId57": "6852d9da-8015-4b95-8ecf-d9572ee0395d",
                      "analyticRuleId57": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '6852d9da-8015-4b95-8ecf-d9572ee0395d')]",
                      "analyticRuleTemplateSpecName57": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('6852d9da-8015-4b95-8ecf-d9572ee0395d')))]",
                      "_analyticRulecontentProductId57": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','6852d9da-8015-4b95-8ecf-d9572ee0395d','-', '1.0.4')))]"
                    },
                    "analyticRuleObject58": {
                      "analyticRuleVersion58": "1.0.1",
                      "_analyticRulecontentId58": "aec77100-25c5-4254-a20a-8027ed92c46c",
                      "analyticRuleId58": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'aec77100-25c5-4254-a20a-8027ed92c46c')]",
                      "analyticRuleTemplateSpecName58": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('aec77100-25c5-4254-a20a-8027ed92c46c')))]",
                      "_analyticRulecontentProductId58": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','aec77100-25c5-4254-a20a-8027ed92c46c','-', '1.0.1')))]"
                    },
                    "analyticRuleObject59": {
                      "analyticRuleVersion59": "1.0.3",
                      "_analyticRulecontentId59": "acc4c247-aaf7-494b-b5da-17f18863878a",
                      "analyticRuleId59": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'acc4c247-aaf7-494b-b5da-17f18863878a')]",
                      "analyticRuleTemplateSpecName59": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('acc4c247-aaf7-494b-b5da-17f18863878a')))]",
                      "_analyticRulecontentProductId59": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','acc4c247-aaf7-494b-b5da-17f18863878a','-', '1.0.3')))]"
                    },
                    "analyticRuleObject60": {
                      "analyticRuleVersion60": "2.0.5",
                      "_analyticRulecontentId60": "3a9d5ede-2b9d-43a2-acc4-d272321ff77c",
                      "analyticRuleId60": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '3a9d5ede-2b9d-43a2-acc4-d272321ff77c')]",
                      "analyticRuleTemplateSpecName60": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('3a9d5ede-2b9d-43a2-acc4-d272321ff77c')))]",
                      "_analyticRulecontentProductId60": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','3a9d5ede-2b9d-43a2-acc4-d272321ff77c','-', '2.0.5')))]"
                    },
                    "analyticRuleObject61": {
                      "analyticRuleVersion61": "1.0.7",
                      "_analyticRulecontentId61": "4d94d4a9-dc96-410a-8dea-4d4d4584188b",
                      "analyticRuleId61": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '4d94d4a9-dc96-410a-8dea-4d4d4584188b')]",
                      "analyticRuleTemplateSpecName61": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('4d94d4a9-dc96-410a-8dea-4d4d4584188b')))]",
                      "_analyticRulecontentProductId61": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','4d94d4a9-dc96-410a-8dea-4d4d4584188b','-', '1.0.7')))]"
                    },
                    "analyticRuleObject62": {
                      "analyticRuleVersion62": "1.0.2",
                      "_analyticRulecontentId62": "746ddb63-f51b-4563-b449-a8b13cf302ec",
                      "analyticRuleId62": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '746ddb63-f51b-4563-b449-a8b13cf302ec')]",
                      "analyticRuleTemplateSpecName62": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('746ddb63-f51b-4563-b449-a8b13cf302ec')))]",
                      "_analyticRulecontentProductId62": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','746ddb63-f51b-4563-b449-a8b13cf302ec','-', '1.0.2')))]"
                    },
                    "analyticRuleObject63": {
                      "analyticRuleVersion63": "1.1.1",
                      "_analyticRulecontentId63": "050b9b3d-53d0-4364-a3da-1b678b8211ec",
                      "analyticRuleId63": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '050b9b3d-53d0-4364-a3da-1b678b8211ec')]",
                      "analyticRuleTemplateSpecName63": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('050b9b3d-53d0-4364-a3da-1b678b8211ec')))]",
                      "_analyticRulecontentProductId63": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','050b9b3d-53d0-4364-a3da-1b678b8211ec','-', '1.1.1')))]"
                    },
                    "analyticRuleObject64": {
                      "analyticRuleVersion64": "1.0.0",
                      "_analyticRulecontentId64": "132fdff4-c044-4855-a390-c1b71e0f833b",
                      "analyticRuleId64": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '132fdff4-c044-4855-a390-c1b71e0f833b')]",
                      "analyticRuleTemplateSpecName64": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('132fdff4-c044-4855-a390-c1b71e0f833b')))]",
                      "_analyticRulecontentProductId64": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','132fdff4-c044-4855-a390-c1b71e0f833b','-', '1.0.0')))]"
                    },
                    "analyticRuleObject65": {
                      "analyticRuleVersion65": "1.0.1",
                      "_analyticRulecontentId65": "e3368079-a2c0-4f1c-9fb7-287e907393ef",
                      "analyticRuleId65": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'e3368079-a2c0-4f1c-9fb7-287e907393ef')]",
                      "analyticRuleTemplateSpecName65": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('e3368079-a2c0-4f1c-9fb7-287e907393ef')))]",
                      "_analyticRulecontentProductId65": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','e3368079-a2c0-4f1c-9fb7-287e907393ef','-', '1.0.1')))]"
                    },
                    "analyticRuleObject66": {
                      "analyticRuleVersion66": "1.0.1",
                      "_analyticRulecontentId66": "0990a481-3bc8-4682-838c-313918dd858c",
                      "analyticRuleId66": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '0990a481-3bc8-4682-838c-313918dd858c')]",
                      "analyticRuleTemplateSpecName66": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('0990a481-3bc8-4682-838c-313918dd858c')))]",
                      "_analyticRulecontentProductId66": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','0990a481-3bc8-4682-838c-313918dd858c','-', '1.0.1')))]"
                    },
                    "analyticRuleObject67": {
                      "analyticRuleVersion67": "1.0.1",
                      "_analyticRulecontentId67": "2e96fa64-ac4d-4c92-b79e-e9c54b5d8230",
                      "analyticRuleId67": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '2e96fa64-ac4d-4c92-b79e-e9c54b5d8230')]",
                      "analyticRuleTemplateSpecName67": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('2e96fa64-ac4d-4c92-b79e-e9c54b5d8230')))]",
                      "_analyticRulecontentProductId67": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','2e96fa64-ac4d-4c92-b79e-e9c54b5d8230','-', '1.0.1')))]"
                    },
                    "analyticRuleObject68": {
                      "analyticRuleVersion68": "1.0.1",
                      "_analyticRulecontentId68": "40702da1-ae8a-4e46-ac1f-9327ca6ef588",
                      "analyticRuleId68": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '40702da1-ae8a-4e46-ac1f-9327ca6ef588')]",
                      "analyticRuleTemplateSpecName68": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('40702da1-ae8a-4e46-ac1f-9327ca6ef588')))]",
                      "_analyticRulecontentProductId68": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','40702da1-ae8a-4e46-ac1f-9327ca6ef588','-', '1.0.1')))]"
                    },
                    "analyticRuleObject69": {
                      "analyticRuleVersion69": "1.0.1",
                      "_analyticRulecontentId69": "5588de32-73b1-40b9-bddc-4d9e74051859",
                      "analyticRuleId69": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '5588de32-73b1-40b9-bddc-4d9e74051859')]",
                      "analyticRuleTemplateSpecName69": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('5588de32-73b1-40b9-bddc-4d9e74051859')))]",
                      "_analyticRulecontentProductId69": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','5588de32-73b1-40b9-bddc-4d9e74051859','-', '1.0.1')))]"
                    },
                    "analyticRuleObject70": {
                      "analyticRuleVersion70": "1.0.1",
                      "_analyticRulecontentId70": "ccca6b88-a7b6-41c9-9be2-fc3daeb65b26",
                      "analyticRuleId70": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'ccca6b88-a7b6-41c9-9be2-fc3daeb65b26')]",
                      "analyticRuleTemplateSpecName70": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('ccca6b88-a7b6-41c9-9be2-fc3daeb65b26')))]",
                      "_analyticRulecontentProductId70": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','ccca6b88-a7b6-41c9-9be2-fc3daeb65b26','-', '1.0.1')))]"
                    },
                    "analyticRuleObject71": {
                      "analyticRuleVersion71": "1.0.1",
                      "_analyticRulecontentId71": "2ce7f00d-3b3c-41b9-ae9a-b79c19d2394e",
                      "analyticRuleId71": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '2ce7f00d-3b3c-41b9-ae9a-b79c19d2394e')]",
                      "analyticRuleTemplateSpecName71": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('2ce7f00d-3b3c-41b9-ae9a-b79c19d2394e')))]",
                      "_analyticRulecontentProductId71": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','2ce7f00d-3b3c-41b9-ae9a-b79c19d2394e','-', '1.0.1')))]"
                    },
                    "analyticRuleObject72": {
                      "analyticRuleVersion72": "1.0.1",
                      "_analyticRulecontentId72": "0459a1b5-909d-4783-9e27-24536b05a47f",
                      "analyticRuleId72": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '0459a1b5-909d-4783-9e27-24536b05a47f')]",
                      "analyticRuleTemplateSpecName72": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('0459a1b5-909d-4783-9e27-24536b05a47f')))]",
                      "_analyticRulecontentProductId72": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','0459a1b5-909d-4783-9e27-24536b05a47f','-', '1.0.1')))]"
                    },
                    "analyticRuleObject73": {
                      "analyticRuleVersion73": "1.0.1",
                      "_analyticRulecontentId73": "c385944b-17b9-4b2b-921e-0e8d0341a675",
                      "analyticRuleId73": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'c385944b-17b9-4b2b-921e-0e8d0341a675')]",
                      "analyticRuleTemplateSpecName73": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('c385944b-17b9-4b2b-921e-0e8d0341a675')))]",
                      "_analyticRulecontentProductId73": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','c385944b-17b9-4b2b-921e-0e8d0341a675','-', '1.0.1')))]"
                    },
                    "Block-AADUser-alert-trigger": "Block-AADUser-alert-trigger",
                    "_Block-AADUser-alert-trigger": "[variables('Block-AADUser-alert-trigger')]",
                    "playbookVersion1": "1.1",
                    "playbookContentId1": "Block-AADUser-alert-trigger",
                    "_playbookContentId1": "[variables('playbookContentId1')]",
                    "playbookId1": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId1'))]",
                    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId1'))))]",
                    "_playbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId1'),'-', variables('playbookVersion1'))))]",
                    "Block-AADUser-incident-trigger": "Block-AADUser-incident-trigger",
                    "_Block-AADUser-incident-trigger": "[variables('Block-AADUser-incident-trigger')]",
                    "playbookVersion2": "1.1",
                    "playbookContentId2": "Block-AADUser-incident-trigger",
                    "_playbookContentId2": "[variables('playbookContentId2')]",
                    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
                    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2'))))]",
                    "_playbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId2'),'-', variables('playbookVersion2'))))]",
                    "Prompt-User-alert-trigger": "Prompt-User-alert-trigger",
                    "_Prompt-User-alert-trigger": "[variables('Prompt-User-alert-trigger')]",
                    "playbookVersion3": "1.1",
                    "playbookContentId3": "Prompt-User-alert-trigger",
                    "_playbookContentId3": "[variables('playbookContentId3')]",
                    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
                    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3'))))]",
                    "_playbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId3'),'-', variables('playbookVersion3'))))]",
                    "Prompt-User-incident-trigger": "Prompt-User-incident-trigger",
                    "_Prompt-User-incident-trigger": "[variables('Prompt-User-incident-trigger')]",
                    "playbookVersion4": "1.1",
                    "playbookContentId4": "Prompt-User-incident-trigger",
                    "_playbookContentId4": "[variables('playbookContentId4')]",
                    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
                    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4'))))]",
                    "_playbookcontentProductId4": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId4'),'-', variables('playbookVersion4'))))]",
                    "Reset-AADUserPassword-alert-trigger": "Reset-AADUserPassword-alert-trigger",
                    "_Reset-AADUserPassword-alert-trigger": "[variables('Reset-AADUserPassword-alert-trigger')]",
                    "playbookVersion5": "1.1",
                    "playbookContentId5": "Reset-AADUserPassword-alert-trigger",
                    "_playbookContentId5": "[variables('playbookContentId5')]",
                    "playbookId5": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId5'))]",
                    "playbookTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId5'))))]",
                    "_playbookcontentProductId5": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId5'),'-', variables('playbookVersion5'))))]",
                    "Reset-AADUserPassword-incident-trigger": "Reset-AADUserPassword-incident-trigger",
                    "_Reset-AADUserPassword-incident-trigger": "[variables('Reset-AADUserPassword-incident-trigger')]",
                    "playbookVersion6": "1.1",
                    "playbookContentId6": "Reset-AADUserPassword-incident-trigger",
                    "_playbookContentId6": "[variables('playbookContentId6')]",
                    "playbookId6": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId6'))]",
                    "playbookTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId6'))))]",
                    "_playbookcontentProductId6": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId6'),'-', variables('playbookVersion6'))))]",
                    "Block-AADUser-entity-trigger": "Block-AADUser-entity-trigger",
                    "_Block-AADUser-entity-trigger": "[variables('Block-AADUser-entity-trigger')]",
                    "playbookVersion7": "1.1",
                    "playbookContentId7": "Block-AADUser-entity-trigger",
                    "_playbookContentId7": "[variables('playbookContentId7')]",
                    "playbookId7": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId7'))]",
                    "playbookTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId7'))))]",
                    "_playbookcontentProductId7": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId7'),'-', variables('playbookVersion7'))))]",
                    "Reset-AADUserPassword-entity-trigger": "Reset-AADUserPassword-entity-trigger",
                    "_Reset-AADUserPassword-entity-trigger": "[variables('Reset-AADUserPassword-entity-trigger')]",
                    "playbookVersion8": "1.1",
                    "playbookContentId8": "Reset-AADUserPassword-entity-trigger",
                    "_playbookContentId8": "[variables('playbookContentId8')]",
                    "playbookId8": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId8'))]",
                    "playbookTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId8'))))]",
                    "_playbookcontentProductId8": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId8'),'-', variables('playbookVersion8'))))]",
                    "blanks": "[replace('b', 'b', '')]",
                    "Revoke-AADSignInSessions-alert-trigger": "Revoke-AADSignInSessions-alert-trigger",
                    "_Revoke-AADSignInSessions-alert-trigger": "[variables('Revoke-AADSignInSessions-alert-trigger')]",
                    "playbookVersion9": "1.0",
                    "playbookContentId9": "Revoke-AADSignInSessions-alert-trigger",
                    "_playbookContentId9": "[variables('playbookContentId9')]",
                    "playbookId9": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId9'))]",
                    "playbookTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId9'))))]",
                    "_playbookcontentProductId9": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId9'),'-', variables('playbookVersion9'))))]",
                    "Revoke-AADSignInSessions-incident-trigger": "Revoke-AADSignInSessions-incident-trigger",
                    "_Revoke-AADSignInSessions-incident-trigger": "[variables('Revoke-AADSignInSessions-incident-trigger')]",
                    "playbookVersion10": "1.0",
                    "playbookContentId10": "Revoke-AADSignInSessions-incident-trigger",
                    "_playbookContentId10": "[variables('playbookContentId10')]",
                    "playbookId10": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId10'))]",
                    "playbookTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId10'))))]",
                    "_playbookcontentProductId10": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId10'),'-', variables('playbookVersion10'))))]",
                    "Revoke-AADSignInSessions-entity-trigger": "Revoke-AADSignInSessions-entity-trigger",
                    "_Revoke-AADSignInSessions-entity-trigger": "[variables('Revoke-AADSignInSessions-entity-trigger')]",
                    "playbookVersion11": "1.0",
                    "playbookContentId11": "Revoke-AADSignInSessions-entity-trigger",
                    "_playbookContentId11": "[variables('playbookContentId11')]",
                    "playbookId11": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId11'))]",
                    "playbookTemplateSpecName11": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId11'))))]",
                    "_playbookcontentProductId11": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId11'),'-', variables('playbookVersion11'))))]",
                    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('dataConnectorTemplateSpecName1')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Microsoft Entra ID data connector with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('dataConnectorVersion1')]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
                              "apiVersion": "2021-03-01-preview",
                              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
                              "location": "[parameters('workspace-location')]",
                              "kind": "StaticUI",
                              "properties": {
                                "connectorUiConfig": {
                                  "id": "[variables('_uiConfigId1')]",
                                  "title": "Microsoft Entra ID",
                                  "publisher": "Microsoft",
                                  "descriptionMarkdown": "Gain insights into Microsoft Entra ID by connecting Audit and Sign-in logs to Microsoft Sentinel to gather insights around Microsoft Entra ID scenarios. You can learn about app usage, conditional access policies, legacy auth relate details using our Sign-in logs. You can get information on your Self Service Password Reset (SSPR) usage, Microsoft Entra ID Management activities like user, group, role, app management using our Audit logs table. For more information, see the [Microsoft Sentinel documentation](https://go.microsoft.com/fwlink/?linkid=2219715&wt.mc_id=sentinel_dataconnectordocs_content_cnl_csasci).",
                                  "graphQueries": [
                                    {
                                      "metricName": "Total data received",
                                      "legend": "SigninLogs",
                                      "baseQuery": "SigninLogs"
                                    },
                                    {
                                      "metricName": "Total data received",
                                      "legend": "AuditLogs",
                                      "baseQuery": "AuditLogs"
                                    },
                                    {
                                      "metricName": "Total data received",
                                      "legend": "AADNonInteractiveUserSignInLogs",
                                      "baseQuery": "AADNonInteractiveUserSignInLogs"
                                    },
                                    {
                                      "metricName": "Total data received",
                                      "legend": "AADServicePrincipalSignInLogs",
                                      "baseQuery": "AADServicePrincipalSignInLogs"
                                    },
                                    {
                                      "metricName": "Total data received",
                                      "legend": "AADManagedIdentitySignInLogs",
                                      "baseQuery": "AADManagedIdentitySignInLogs"
                                    },
                                    {
                                      "metricName": "Total data received",
                                      "legend": "AADProvisioningLogs",
                                      "baseQuery": "AADProvisioningLogs"
                                    },
                                    {
                                      "metricName": "Total data received",
                                      "legend": "ADFSSignInLogs",
                                      "baseQuery": "ADFSSignInLogs"
                                    },
                                    {
                                      "metricName": "Total data received",
                                      "legend": "AADUserRiskEvents",
                                      "baseQuery": "AADUserRiskEvents"
                                    },
                                    {
                                      "metricName": "Total data received",
                                      "legend": "AADRiskyUsers",
                                      "baseQuery": "AADRiskyUsers"
                                    },
                                    {
                                      "metricName": "Total data received",
                                      "legend": "NetworkAccessTraffic",
                                      "baseQuery": "NetworkAccessTraffic"
                                    },
                                    {
                                      "metricName": "Total data received",
                                      "legend": "AADRiskyServicePrincipals",
                                      "baseQuery": "AADRiskyServicePrincipals"
                                    },
                                    {
                                      "metricName": "Total data received",
                                      "legend": "AADServicePrincipalRiskEvents",
                                      "baseQuery": "AADServicePrincipalRiskEvents"
                                    }
                                  ],
                                  "connectivityCriterias": [
                                    {
                                      "type": "IsConnectedQuery",
                                      "value": [
                                        "SigninLogs\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                        "AuditLogs\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                        "AADNonInteractiveUserSignInLogs\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                        "AADServicePrincipalSignInLogs\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                        "AADManagedIdentitySignInLogs\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                        "AADProvisioningLogs\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                        "ADFSSignInLogs\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                        "AADUserRiskEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                        "AADRiskyUsers\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                        "NetworkAccessTraffic\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                        "AADRiskyServicePrincipals\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                        "AADServicePrincipalRiskEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                                      ]
                                    }
                                  ],
                                  "dataTypes": [
                                    {
                                      "name": "SigninLogs",
                                      "lastDataReceivedQuery": "SigninLogs\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                                    },
                                    {
                                      "name": "AuditLogs",
                                      "lastDataReceivedQuery": "AuditLogs\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                                    },
                                    {
                                      "name": "AADNonInteractiveUserSignInLogs",
                                      "lastDataReceivedQuery": "AADNonInteractiveUserSignInLogs\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                                    },
                                    {
                                      "name": "AADServicePrincipalSignInLogs",
                                      "lastDataReceivedQuery": "AADServicePrincipalSignInLogs\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                                    },
                                    {
                                      "name": "AADManagedIdentitySignInLogs",
                                      "lastDataReceivedQuery": "AADManagedIdentitySignInLogs\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                                    },
                                    {
                                      "name": "AADProvisioningLogs",
                                      "lastDataReceivedQuery": "AADProvisioningLogs\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                                    },
                                    {
                                      "name": "ADFSSignInLogs",
                                      "lastDataReceivedQuery": "ADFSSignInLogs\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                                    },
                                    {
                                      "name": "AADUserRiskEvents",
                                      "lastDataReceivedQuery": "AADUserRiskEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                                    },
                                    {
                                      "name": "AADRiskyUsers",
                                      "lastDataReceivedQuery": "AADRiskyUsers\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                                    },
                                    {
                                      "name": "NetworkAccessTraffic",
                                      "lastDataReceivedQuery": "NetworkAccessTraffic\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                                    },
                                    {
                                      "name": "AADRiskyServicePrincipals",
                                      "lastDataReceivedQuery": "AADRiskyServicePrincipals\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                                    },
                                    {
                                      "name": "AADServicePrincipalRiskEvents",
                                      "lastDataReceivedQuery": "AADServicePrincipalRiskEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                                    }
                                  ]
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2023-04-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
                              "properties": {
                                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                                "contentId": "[variables('_dataConnectorContentId1')]",
                                "kind": "DataConnector",
                                "version": "[variables('dataConnectorVersion1')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_dataConnectorContentId1')]",
                        "contentKind": "DataConnector",
                        "displayName": "Microsoft Entra ID",
                        "contentProductId": "[variables('_dataConnectorcontentProductId1')]",
                        "id": "[variables('_dataConnectorcontentProductId1')]",
                        "version": "[variables('dataConnectorVersion1')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
                      "dependsOn": [
                        "[variables('_dataConnectorId1')]"
                      ],
                      "location": "[parameters('workspace-location')]",
                      "properties": {
                        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                        "contentId": "[variables('_dataConnectorContentId1')]",
                        "kind": "DataConnector",
                        "version": "[variables('dataConnectorVersion1')]",
                        "source": {
                          "kind": "Solution",
                          "name": "Microsoft Entra ID",
                          "sourceId": "[variables('_solutionId')]"
                        },
                        "author": {
                          "name": "Microsoft",
                          "email": "[variables('_email')]"
                        },
                        "support": {
                          "tier": "Microsoft",
                          "name": "Microsoft Corporation",
                          "email": "support@microsoft.com",
                          "link": "https://support.microsoft.com/"
                        }
                      }
                    },
                    {
                      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
                      "apiVersion": "2021-03-01-preview",
                      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
                      "location": "[parameters('workspace-location')]",
                      "kind": "StaticUI",
                      "properties": {
                        "connectorUiConfig": {
                          "title": "Microsoft Entra ID",
                          "publisher": "Microsoft",
                          "descriptionMarkdown": "Gain insights into Microsoft Entra ID by connecting Audit and Sign-in logs to Microsoft Sentinel to gather insights around Microsoft Entra ID scenarios. You can learn about app usage, conditional access policies, legacy auth relate details using our Sign-in logs. You can get information on your Self Service Password Reset (SSPR) usage, Microsoft Entra ID Management activities like user, group, role, app management using our Audit logs table. For more information, see the [Microsoft Sentinel documentation](https://go.microsoft.com/fwlink/?linkid=2219715&wt.mc_id=sentinel_dataconnectordocs_content_cnl_csasci).",
                          "graphQueries": [
                            {
                              "metricName": "Total data received",
                              "legend": "SigninLogs",
                              "baseQuery": "SigninLogs"
                            },
                            {
                              "metricName": "Total data received",
                              "legend": "AuditLogs",
                              "baseQuery": "AuditLogs"
                            },
                            {
                              "metricName": "Total data received",
                              "legend": "AADNonInteractiveUserSignInLogs",
                              "baseQuery": "AADNonInteractiveUserSignInLogs"
                            },
                            {
                              "metricName": "Total data received",
                              "legend": "AADServicePrincipalSignInLogs",
                              "baseQuery": "AADServicePrincipalSignInLogs"
                            },
                            {
                              "metricName": "Total data received",
                              "legend": "AADManagedIdentitySignInLogs",
                              "baseQuery": "AADManagedIdentitySignInLogs"
                            },
                            {
                              "metricName": "Total data received",
                              "legend": "AADProvisioningLogs",
                              "baseQuery": "AADProvisioningLogs"
                            },
                            {
                              "metricName": "Total data received",
                              "legend": "ADFSSignInLogs",
                              "baseQuery": "ADFSSignInLogs"
                            },
                            {
                              "metricName": "Total data received",
                              "legend": "AADUserRiskEvents",
                              "baseQuery": "AADUserRiskEvents"
                            },
                            {
                              "metricName": "Total data received",
                              "legend": "AADRiskyUsers",
                              "baseQuery": "AADRiskyUsers"
                            },
                            {
                              "metricName": "Total data received",
                              "legend": "NetworkAccessTraffic",
                              "baseQuery": "NetworkAccessTraffic"
                            },
                            {
                              "metricName": "Total data received",
                              "legend": "AADRiskyServicePrincipals",
                              "baseQuery": "AADRiskyServicePrincipals"
                            },
                            {
                              "metricName": "Total data received",
                              "legend": "AADServicePrincipalRiskEvents",
                              "baseQuery": "AADServicePrincipalRiskEvents"
                            }
                          ],
                          "dataTypes": [
                            {
                              "name": "SigninLogs",
                              "lastDataReceivedQuery": "SigninLogs\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                            },
                            {
                              "name": "AuditLogs",
                              "lastDataReceivedQuery": "AuditLogs\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                            },
                            {
                              "name": "AADNonInteractiveUserSignInLogs",
                              "lastDataReceivedQuery": "AADNonInteractiveUserSignInLogs\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                            },
                            {
                              "name": "AADServicePrincipalSignInLogs",
                              "lastDataReceivedQuery": "AADServicePrincipalSignInLogs\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                            },
                            {
                              "name": "AADManagedIdentitySignInLogs",
                              "lastDataReceivedQuery": "AADManagedIdentitySignInLogs\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                            },
                            {
                              "name": "AADProvisioningLogs",
                              "lastDataReceivedQuery": "AADProvisioningLogs\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                            },
                            {
                              "name": "ADFSSignInLogs",
                              "lastDataReceivedQuery": "ADFSSignInLogs\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                            },
                            {
                              "name": "AADUserRiskEvents",
                              "lastDataReceivedQuery": "AADUserRiskEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                            },
                            {
                              "name": "AADRiskyUsers",
                              "lastDataReceivedQuery": "AADRiskyUsers\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                            },
                            {
                              "name": "NetworkAccessTraffic",
                              "lastDataReceivedQuery": "NetworkAccessTraffic\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                            },
                            {
                              "name": "AADRiskyServicePrincipals",
                              "lastDataReceivedQuery": "AADRiskyServicePrincipals\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                            },
                            {
                              "name": "AADServicePrincipalRiskEvents",
                              "lastDataReceivedQuery": "AADServicePrincipalRiskEvents\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                            }
                          ],
                          "connectivityCriterias": [
                            {
                              "type": "IsConnectedQuery",
                              "value": [
                                "SigninLogs\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                "AuditLogs\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                "AADNonInteractiveUserSignInLogs\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                "AADServicePrincipalSignInLogs\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                "AADManagedIdentitySignInLogs\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                "AADProvisioningLogs\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                "ADFSSignInLogs\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                "AADUserRiskEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                "AADRiskyUsers\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                "NetworkAccessTraffic\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                "AADRiskyServicePrincipals\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)",
                                "AADServicePrincipalRiskEvents\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                              ]
                            }
                          ],
                          "id": "[variables('_uiConfigId1')]"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('workbookTemplateSpecName1')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AzureActiveDirectoryAuditLogs Workbook with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('workbookVersion1')]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.Insights/workbooks",
                              "name": "[variables('workbookContentId1')]",
                              "location": "[parameters('workspace-location')]",
                              "kind": "shared",
                              "apiVersion": "2021-08-01",
                              "metadata": {
                                "description": "Gain insights into Microsoft Entra ID by connecting Microsoft Sentinel and using the audit logs to gather insights around Microsoft Entra ID scenarios. \nYou can learn about user operations, including password and group management, device activities, and top active users and apps."
                              },
                              "properties": {
                                "displayName": "[parameters('workbook1-name')]",
                                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Microsoft Entra ID audit logs\"},\"name\":\"text - 1\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"bc372bf5-2dcd-4efa-aa85-94b6e6fafe14\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":7776000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}},{\"id\":\"e032b9f7-5449-4180-9c20-75760afa96f6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"User\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"AuditLogs\\r\\n| where SourceSystem == \\\"Azure AD\\\"\\r\\n| extend initiator = iif (tostring(InitiatedBy.user.userPrincipalName) != \\\"\\\", tostring(InitiatedBy.user.userPrincipalName), \\\"unknown\\\")\\r\\n//| where initiator!= \\\"\\\"\\r\\n| summarize Count = count() by initiator\\r\\n| order by Count desc, initiator asc\\r\\n| project Value = initiator, Label = strcat(initiator, ' - ', Count), Selected = false\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"0a59a0b3-6d93-4fee-bdbe-147383c510c6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Category\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"AuditLogs\\r\\n| extend initiator = iif (tostring(InitiatedBy.user.userPrincipalName) != \\\"\\\", tostring(InitiatedBy.user.userPrincipalName), \\\"unknown\\\")\\r\\n| where \\\"{User:lable}\\\" == \\\"All\\\" or initiator in ({User})\\r\\n| summarize Count = count() by Category\\r\\n| order by Count desc, Category asc\\r\\n| project Value = Category, Label = strcat(Category, ' - ', Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"4d2b245b-5e59-4eb6-9f51-ba926581ab47\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Result\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"AuditLogs\\r\\n| extend initiator = iif (tostring(InitiatedBy.user.userPrincipalName) != \\\"\\\", tostring(InitiatedBy.user.userPrincipalName), \\\"unknown\\\")\\r\\n| where \\\"{User:lable}\\\" == \\\"All\\\" or initiator in ({User})\\r\\n| summarize Count = count() by Result\\r\\n| order by Count desc, Result asc\\r\\n| project Value = Result, Label = strcat(Result, ' - ', Count, ' sign-ins')\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = AuditLogs\\r\\n| where \\\"{Category:lable}\\\" == \\\"All\\\" or Category in ({Category})\\r\\n| where \\\"{Result:lable}\\\" == \\\"All\\\" or Result in ({Result})\\r\\n| extend initiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\\r\\n| where initiatingUserPrincipalName != \\\"\\\" \\r\\n| where \\\"{User:lable}\\\" == \\\"All\\\" or initiatingUserPrincipalName in ({User});\\r\\ndata\\r\\n| summarize Count = count() by Category\\r\\n| join kind = fullouter (datatable(Category:string)['Medium', 'high', 'low']) on Category\\r\\n| project Category = iff(Category == '', Category1, Category), Count = iff(Category == '', 0, Count)\\r\\n| join kind = inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by Category)\\r\\n    on Category\\r\\n| project-away Category1, TimeGenerated\\r\\n| extend Category = Category\\r\\n| union (\\r\\n    data \\r\\n    | summarize Count = count() \\r\\n    | extend jkey = 1\\r\\n    | join kind=inner (data\\r\\n        | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\\r\\n        | extend jkey = 1) on jkey\\r\\n    | extend Category = 'All', Categorys = '*'    \\r\\n)\\r\\n| order by Count desc\\r\\n| take 10\",\"size\":4,\"title\":\"Categories volume\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Category\",\"exportParameterName\":\"CategoryFIlter\",\"exportDefaultValue\":\"All\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Category\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":21,\"formatOptions\":{\"palette\":\"purple\",\"showIcon\":true}},\"showBorder\":false}},\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = AuditLogs\\r\\n| where \\\"{Result:lable}\\\" == \\\"All\\\" or Result in ({Result})\\r\\n| extend initiator = iif (tostring(InitiatedBy.user.userPrincipalName) != \\\"\\\", tostring(InitiatedBy.user.userPrincipalName), \\\"unknown\\\")\\r\\n| where \\\"{User:lable}\\\" == \\\"All\\\" or initiator in ({User})\\r\\n| where \\\"{Category:lable}\\\" == \\\"All\\\" or Category in ({Category})\\r\\n| where Category == '{CategoryFIlter}' or '{CategoryFIlter}' == \\\"All\\\";\\r\\nlet appData = data\\r\\n| summarize TotalCount = count() by OperationName, Category\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by OperationName\\r\\n    | project-away TimeGenerated) on OperationName\\r\\n| order by TotalCount desc, OperationName asc\\r\\n| project OperationName, TotalCount, Trend, Category\\r\\n| serialize Id = row_number();\\r\\ndata\\r\\n| summarize TotalCount = count() by initiator = iif (tostring(InitiatedBy.user.userPrincipalName) != \\\"\\\", tostring(InitiatedBy.user.userPrincipalName), \\\"unknown\\\"), Category, OperationName\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by OperationName, initiator = iif (tostring(InitiatedBy.user.userPrincipalName) != \\\"\\\", tostring(InitiatedBy.user.userPrincipalName), \\\"unknown\\\")\\r\\n    | project-away TimeGenerated) on OperationName, initiator\\r\\n| order by TotalCount desc, OperationName asc\\r\\n| project OperationName, initiator, TotalCount, Category, Trend\\r\\n| serialize Id = row_number(1000000)\\r\\n| join kind=inner (appData) on OperationName\\r\\n| project Id, Name = initiator, Type = 'initiator', ['Operations Count'] = TotalCount, Trend, Category, ParentId = Id1\\r\\n| union (appData \\r\\n    | project Id, Name = OperationName, Type = 'Operation', ['Operations Count'] = TotalCount, Category, Trend)\\r\\n| order by ['Operations Count'] desc, Name asc\",\"size\":0,\"showAnalytics\":true,\"title\":\"User activities\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportParameterName\":\"UserInfo\",\"exportDefaultValue\":\"{ \\\"Name\\\":\\\"\\\", \\\"Type\\\":\\\"*\\\"}\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Type\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Operations Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"turquoise\",\"showIcon\":true},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"ParentId\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"rowLimit\":1000,\"filter\":true,\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"ParentId\",\"treeType\":0,\"expanderColumn\":\"Name\"}}},\"customWidth\":\"70\",\"showPin\":true,\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let details = dynamic({UserInfo});\\r\\nAuditLogs\\r\\n| where \\\"{Category:lable}\\\" == \\\"All\\\" or Category in ({Category})\\r\\n| where \\\"{Result:lable}\\\" == \\\"All\\\" or Result in ({Result})\\r\\n| extend initiatingUserPrincipalName = iif (tostring(InitiatedBy.user.userPrincipalName) != \\\"\\\", tostring(InitiatedBy.user.userPrincipalName), \\\"unknown\\\")\\r\\n//| where initiatingUserPrincipalName != \\\"\\\" \\r\\n| where \\\"{User:lable}\\\" == \\\"All\\\" or initiatingUserPrincipalName in ({User})\\r\\n| where details.Type == '*' or (details.Type == 'initiator' and initiatingUserPrincipalName == details.Name) or (details.Type == 'Operation' and OperationName == details.Name)\\r\\n| summarize Activities = count() by initiatingUserPrincipalName\\r\\n| sort by Activities desc nulls last \",\"size\":0,\"title\":\"Top active users\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"30\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let details = dynamic({UserInfo});\\r\\nlet data = AuditLogs\\r\\n| extend initiator = iif (tostring(InitiatedBy.user.userPrincipalName) != \\\"\\\", tostring(InitiatedBy.user.userPrincipalName), \\\"unknown\\\")\\r\\n| where details.Type == '*' or (details.Type == 'initiator' and initiator == details.Name) or (details.Type == 'Operation' and OperationName == details.Name)\\r\\n| where \\\"{Category:lable}\\\" == \\\"All\\\" or Category in ({Category})\\r\\n| where \\\"{Result:lable}\\\" == \\\"All\\\" or Result in ({Result})\\r\\n| where \\\"{User:lable}\\\" == \\\"All\\\" or initiator in ({User});\\r\\nlet appData = data\\r\\n| summarize TotalCount = count() by Result\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Result\\r\\n    | project-away TimeGenerated) on Result\\r\\n| order by TotalCount desc, Result asc\\r\\n| project Result, TotalCount, Trend\\r\\n| serialize Id = row_number();\\r\\ndata\\r\\n| summarize TotalCount = count() by OperationName, Result\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Result, OperationName\\r\\n    | project-away TimeGenerated) on Result, OperationName\\r\\n| order by TotalCount desc, Result asc\\r\\n| project Result, OperationName, TotalCount, Trend\\r\\n| serialize Id = row_number(1000000)\\r\\n| join kind=inner (appData) on Result\\r\\n| project Id, Name = OperationName, Type = 'Operation', ['Results Count'] = TotalCount, Trend, ParentId = Id1\\r\\n| union (appData \\r\\n    | project Id, Name = Result, Type = 'Result', ['Results Count'] = TotalCount, Trend)\\r\\n| order by ['Results Count'] desc, Name asc\",\"size\":0,\"title\":\"Result status\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"exportParameterName\":\"ResultInfo\",\"exportDefaultValue\":\"{ \\\"Name\\\":\\\"\\\", \\\"Type\\\":\\\"*\\\"}\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5},{\"columnMatch\":\"Type\",\"formatter\":5},{\"columnMatch\":\"Results Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"grayBlue\"}},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"greenDark\"}},{\"columnMatch\":\"ParentId\",\"formatter\":5}],\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"ParentId\",\"treeType\":0,\"expanderColumn\":\"Name\"}}},\"customWidth\":\"70\",\"name\":\"query - 5\"}],\"fallbackResourceIds\":[\"\"],\"fromTemplateId\":\"sentinel-AzureActiveDirectoryAuditLogs\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                                "version": "1.0",
                                "sourceId": "[variables('workspaceResourceId')]",
                                "category": "sentinel"
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
                              "properties": {
                                "description": "@{workbookKey=AzureActiveDirectoryAuditLogsWorkbook; logoFileName=azureactivedirectory_logo.svg; description=Gain insights into Microsoft Entra ID by connecting Microsoft Sentinel and using the audit logs to gather insights around Microsoft Entra ID scenarios. \nYou can learn about user operations, including password and group management, device activities, and top active users and apps.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.2.0; title=Microsoft Entra ID Audit logs; templateRelativePath=AzureActiveDirectoryAuditLogs.json; subtitle=; provider=Microsoft}.description",
                                "parentId": "[variables('workbookId1')]",
                                "contentId": "[variables('_workbookContentId1')]",
                                "kind": "Workbook",
                                "version": "[variables('workbookVersion1')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                },
                                "dependencies": {
                                  "operator": "AND",
                                  "criteria": [
                                    {
                                      "contentId": "AuditLogs",
                                      "kind": "DataType"
                                    },
                                    {
                                      "contentId": "AzureActiveDirectory",
                                      "kind": "DataConnector"
                                    }
                                  ]
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_workbookContentId1')]",
                        "contentKind": "Workbook",
                        "displayName": "[parameters('workbook1-name')]",
                        "contentProductId": "[variables('_workbookcontentProductId1')]",
                        "id": "[variables('_workbookcontentProductId1')]",
                        "version": "[variables('workbookVersion1')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('workbookTemplateSpecName2')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AzureActiveDirectorySignins Workbook with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('workbookVersion2')]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.Insights/workbooks",
                              "name": "[variables('workbookContentId2')]",
                              "location": "[parameters('workspace-location')]",
                              "kind": "shared",
                              "apiVersion": "2021-08-01",
                              "metadata": {
                                "description": "Gain insights into Microsoft Entra ID by connecting Microsoft Sentinel and using the sign-in logs to gather insights around Microsoft Entra ID scenarios. \nYou can learn about sign-in operations, such as user sign-ins and locations, email addresses, and  IP addresses of your users, as well as failed activities and the errors that triggered the failures."
                              },
                              "properties": {
                                "displayName": "[parameters('workbook2-name')]",
                                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Sign-in Analysis\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"13f56671-7604-4427-a4d8-663f3da0cbc5\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":1209600000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000,\"createdTime\":\"2018-11-13T19:33:10.162Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":900000,\"createdTime\":\"2018-11-13T19:33:10.164Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":1800000,\"createdTime\":\"2018-11-13T19:33:10.164Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":3600000,\"createdTime\":\"2018-11-13T19:33:10.164Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":14400000,\"createdTime\":\"2018-11-13T19:33:10.164Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":43200000,\"createdTime\":\"2018-11-13T19:33:10.164Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":86400000,\"createdTime\":\"2018-11-13T19:33:10.165Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":172800000,\"createdTime\":\"2018-11-13T19:33:10.166Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":259200000,\"createdTime\":\"2018-11-13T19:33:10.166Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":604800000,\"createdTime\":\"2018-11-13T19:33:10.166Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":1209600000,\"createdTime\":\"2018-11-13T19:33:10.166Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false},{\"durationMs\":2592000000,\"createdTime\":\"2018-11-13T19:33:10.167Z\",\"isInitialTime\":false,\"grain\":1,\"useDashboardTimeRange\":false}],\"allowCustom\":true}},{\"id\":\"3b5cc420-8ad8-4523-ba28-a54910756794\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Apps\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SigninLogs\\r\\n| summarize Count = count() by AppDisplayName\\r\\n| order by Count desc, AppDisplayName asc\\r\\n| project Value = AppDisplayName, Label = strcat(AppDisplayName, ' - ', Count, ' sign-ins'), Selected = false\\r\\n\",\"value\":[\"value::all\"],\"typeSettings\":{\"limitSelectTo\":10,\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"0611ecce-d6a0-4a6f-a1bc-6be314ae36a7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"UserNamePrefix\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SigninLogs\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n| summarize Count = count() by UserDisplayName\\r\\n| order by Count desc, UserDisplayName asc\\r\\n| project Value = UserDisplayName, Label = strcat(UserDisplayName, ' - ', Count, ' sign-ins'), Selected = false\\r\\n| extend prefix = substring(Value, 0, 1)\\r\\n| distinct prefix\\r\\n| sort by prefix asc\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\",\"showDefault\":false},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"f7f7970b-58c1-474f-9043-62243d2d4edd\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Users\",\"label\":\"UserName\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SigninLogs\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n| summarize Count = count() by UserDisplayName\\r\\n| order by Count desc, UserDisplayName asc\\r\\n| project Value = UserDisplayName, Label = strcat(UserDisplayName, ' - ', Count, ' sign-ins'), Selected = false\\r\\n| where (substring(Value, 0, 1) in ({UserNamePrefix})) or ('*' in ({UserNamePrefix}))\\r\\n| sort by Value asc\\r\\n\",\"value\":[\"value::all\"],\"typeSettings\":{\"limitSelectTo\":10000000,\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"\",\"showDefault\":false},\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"85568f4e-9ad4-46c5-91d4-0ee1b2c8f3aa\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Category\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"\"},\"jsonData\":\"[\\\"SignInLogs\\\", \\\"NonInteractiveUserSignInLogs\\\"]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = \\r\\nunion SigninLogs,AADNonInteractiveUserSignInLogs\\r\\n| where Category in ({Category})\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users});\\r\\ndata\\r\\n| summarize count() by UserPrincipalName, bin (TimeGenerated,5m)\\r\\n\",\"size\":0,\"title\":\"Sign-in Trend over Time\",\"timeContext\":{\"durationMs\":86400000},\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"TimeBrush\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"name\":\"query - 19\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let nonInteractive = AADNonInteractiveUserSignInLogs\\r\\n| extend LocationDetails = parse_json(LocationDetails)\\r\\n| extend Status = parse_json(Status);\\r\\nlet data = \\r\\nunion SigninLogs,nonInteractive\\r\\n| where Category in ({Category})\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) \\r\\n|extend errorCode = Status.errorCode\\r\\n|extend SigninStatus = case(errorCode == 0, \\\"Success\\\", errorCode == 50058, \\\"Pending user action\\\",errorCode == 50140, \\\"Pending user action\\\", errorCode == 51006, \\\"Pending user action\\\", errorCode == 50059, \\\"Pending user action\\\",errorCode == 65001, \\\"Pending user action\\\", errorCode == 52004, \\\"Pending user action\\\", errorCode == 50055, \\\"Pending user action\\\", errorCode == 50144, \\\"Pending user action\\\", errorCode == 50072, \\\"Pending user action\\\", errorCode == 50074, \\\"Pending user action\\\", errorCode == 16000, \\\"Pending user action\\\", errorCode == 16001, \\\"Pending user action\\\", errorCode == 16003, \\\"Pending user action\\\", errorCode == 50127, \\\"Pending user action\\\", errorCode == 50125, \\\"Pending user action\\\", errorCode == 50129, \\\"Pending user action\\\", errorCode == 50143, \\\"Pending user action\\\", errorCode == 81010, \\\"Pending user action\\\", errorCode == 81014, \\\"Pending user action\\\", errorCode == 81012 ,\\\"Pending user action\\\", \\\"Failure\\\");\\r\\ndata\\r\\n| summarize Count = count() by SigninStatus\\r\\n| join kind = fullouter (datatable(SigninStatus:string)['Success', 'Pending action (Interrupts)', 'Failure']) on SigninStatus\\r\\n| project SigninStatus = iff(SigninStatus == '', SigninStatus1, SigninStatus), Count = iff(SigninStatus == '', 0, Count)\\r\\n| join kind = inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SigninStatus)\\r\\n    on SigninStatus\\r\\n| project-away SigninStatus1, TimeGenerated\\r\\n| extend Status = SigninStatus\\r\\n| union (\\r\\n    data \\r\\n    | summarize Count = count()\\r\\n    | extend jkey = 1\\r\\n    | join kind=inner (data\\r\\n        | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\\r\\n        | extend jkey = 1) on jkey\\r\\n    | extend SigninStatus = 'All Sign-ins', Status = '*'    \\r\\n)\\r\\n| order by Count desc\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":3,\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeBrush\",\"exportFieldName\":\"Status\",\"exportParameterName\":\"SigninStatus\",\"exportDefaultValue\":\"*\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"SigninStatus\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}},\"showBorder\":false}},\"name\":\"query - 5\"},{\"type\":1,\"content\":{\"json\":\"<br />\\r\\n _Click on a tile or a row in the grid to drill-in further_\"},\"name\":\"text - 6 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let nonInteractive = AADNonInteractiveUserSignInLogs\\r\\n| extend LocationDetails = parse_json(LocationDetails)\\r\\n| extend Status = parse_json(Status);\\r\\nlet data = \\r\\nunion SigninLogs,nonInteractive\\r\\n| extend AppDisplayName = iff(AppDisplayName == '', 'Unknown', AppDisplayName)\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) \\r\\n| extend Country = iff(LocationDetails.countryOrRegion == '', 'Unknown country', tostring(LocationDetails.countryOrRegion))\\r\\n| extend City = iff(LocationDetails.city == '', 'Unknown city', tostring(LocationDetails.city))\\r\\n| extend errorCode = Status.errorCode\\r\\n| extend SigninStatus = case(errorCode == 0, \\\"Success\\\", errorCode == 50058, \\\"Pending user action\\\",errorCode == 50140, \\\"Pending user action\\\", errorCode == 51006, \\\"Pending user action\\\", errorCode == 50059, \\\"Pending user action\\\",errorCode == 65001, \\\"Pending user action\\\", errorCode == 52004, \\\"Pending user action\\\", errorCode == 50055, \\\"Pending user action\\\", errorCode == 50144, \\\"Pending user action\\\", errorCode == 50072, \\\"Pending user action\\\", errorCode == 50074, \\\"Pending user action\\\", errorCode == 16000, \\\"Pending user action\\\", errorCode == 16001, \\\"Pending user action\\\", errorCode == 16003, \\\"Pending user action\\\", errorCode == 50127, \\\"Pending user action\\\", errorCode == 50125, \\\"Pending user action\\\", errorCode == 50129, \\\"Pending user action\\\", errorCode == 50143, \\\"Pending user action\\\", errorCode == 81010, \\\"Pending user action\\\", errorCode == 81014, \\\"Pending user action\\\", errorCode == 81012 ,\\\"Pending user action\\\", \\\"Failure\\\")\\r\\n| where SigninStatus == '{SigninStatus}' or '{SigninStatus}' == '*' or '{SigninStatus}' == 'All Sign-ins';\\r\\nlet countryData = data\\r\\n| summarize TotalCount = count(), SuccessCount = countif(SigninStatus == \\\"Success\\\"), FailureCount = countif(SigninStatus == \\\"Failure\\\"), InterruptCount = countif(SigninStatus == \\\"Pending user action\\\") by Country,Category\\r\\n| join kind=inner\\r\\n(\\r\\n    data\\r\\n| make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by  Country\\r\\n| project-away TimeGenerated\\r\\n)\\r\\non Country\\r\\n| project Country, TotalCount, SuccessCount,FailureCount,InterruptCount,Trend,Category\\r\\n| order by TotalCount desc, Country asc;\\r\\ndata\\r\\n| summarize TotalCount = count(), SuccessCount = countif(SigninStatus == \\\"Success\\\"), FailureCount = countif(SigninStatus == \\\"Failure\\\"), InterruptCount = countif(SigninStatus == \\\"Pending user action\\\") by Country, City,Category\\r\\n| join kind=inner\\r\\n(\\r\\n    data    \\r\\n| make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Country, City\\r\\n| project-away TimeGenerated\\r\\n)\\r\\non Country, City\\r\\n| order by TotalCount desc, Country asc\\r\\n| project Country, City,TotalCount, SuccessCount,FailureCount,InterruptCount, Trend,Category\\r\\n| join kind=inner\\r\\n(\\r\\n    countryData\\r\\n)\\r\\non Country\\r\\n| summarize arg_max(TotalCount, SuccessCount, FailureCount, InterruptCount) by Country, City, Category, tostring(Trend)\\r\\n| project Id = strcat(City, '-', Category), Name = City, Type = 'City', ['Sign-in Count'] = TotalCount, Trend, ['Failure Count'] = FailureCount, ['Interrupt Count'] = InterruptCount, ['Success Rate'] = 1.0 * SuccessCount / TotalCount, ParentId = strcat(Country, '-', Category),Category\\r\\n| union (countryData\\r\\n| summarize arg_max(TotalCount, SuccessCount, FailureCount, InterruptCount) by Country, Category, tostring(Trend)\\r\\n| project Id = strcat(Country, '-', Category), Name = Country, Type = 'Country', ['Sign-in Count'] = TotalCount, Trend, ['Failure Count'] = FailureCount, ['Interrupt Count'] = InterruptCount, ['Success Rate'] = 1.0 * SuccessCount / TotalCount, ParentId = 'root',Category)\\r\\n| where Category in ({Category})\\r\\n| order by ['Sign-in Count'] desc, Name asc\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Sign-ins by Location\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeBrush\",\"showRefreshButton\":true,\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"Name\",\"parameterName\":\"LocationDetail\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Type\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Sign-in Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}},{\"columnMatch\":\"Failure Count|Interrupt Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"orange\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Success Rate\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"percent\"}}},{\"columnMatch\":\"ParentId\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true,\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"ParentId\",\"treeType\":0,\"expanderColumn\":\"Name\",\"expandTopLevel\":false}}},\"customWidth\":\"67\",\"showPin\":true,\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let selectedCountry = dynamic([{LocationDetail}]);\\r\\nlet nonInteractive = AADNonInteractiveUserSignInLogs\\r\\n| extend LocationDetails = parse_json(LocationDetails),Status = parse_json(Status),ConditionalAccessPolicies = parse_json(ConditionalAccessPolicies),DeviceDetail =parse_json(DeviceDetail);\\r\\nlet details = dynamic({ \\\"Name\\\":\\\"\\\", \\\"Type\\\":\\\"*\\\"});\\r\\nlet data = union SigninLogs,nonInteractive\\r\\n| extend AppDisplayName = iff(AppDisplayName == '', 'Unknown', AppDisplayName)\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) \\r\\n| extend Country = tostring(LocationDetails.countryOrRegion)\\r\\n| extend City = tostring(LocationDetails.city) \\r\\n| where array_length(selectedCountry) == 0 or \\\"*\\\" in (selectedCountry) or Country in (selectedCountry) or City in (selectedCountry) \\r\\n| extend errorCode = Status.errorCode\\r\\n| extend SigninStatus = case(errorCode == 0, \\\"Success\\\", errorCode == 50058, \\\"Pending user action\\\",errorCode == 50140, \\\"Pending user action\\\", errorCode == 51006, \\\"Pending user action\\\", errorCode == 50059, \\\"Pending user action\\\",errorCode == 65001, \\\"Pending user action\\\", errorCode == 52004, \\\"Pending user action\\\", errorCode == 50055, \\\"Pending user action\\\", errorCode == 50144, \\\"Pending user action\\\", errorCode == 50072, \\\"Pending user action\\\", errorCode == 50074, \\\"Pending user action\\\", errorCode == 16000, \\\"Pending user action\\\", errorCode == 16001, \\\"Pending user action\\\", errorCode == 16003, \\\"Pending user action\\\", errorCode == 50127, \\\"Pending user action\\\", errorCode == 50125, \\\"Pending user action\\\", errorCode == 50129, \\\"Pending user action\\\", errorCode == 50143, \\\"Pending user action\\\", errorCode == 81010, \\\"Pending user action\\\", errorCode == 81014, \\\"Pending user action\\\", errorCode == 81012 ,\\\"Pending user action\\\", \\\"Failure\\\")\\r\\n| where SigninStatus == '{SigninStatus}' or '{SigninStatus}' == '*' or '{SigninStatus}' == 'All Sign-ins'\\r\\n| where details.Type == '*' or (details.Type == 'Country' and Country == details.Name) or (details.Type == 'City' and City == details.Name);\\r\\ndata\\r\\n| top 200 by TimeGenerated desc\\r\\n| extend TimeFromNow = now() - TimeGenerated\\r\\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\\r\\n| project User = UserDisplayName, ['Sign-in Status'] = strcat(iff(SigninStatus == 'Success', '', ''), ' ', SigninStatus), ['Sign-in Time'] = TimeAgo, App = AppDisplayName, ['Error code'] = errorCode, ['Result type'] = ResultType, ['Result signature'] = ResultSignature, ['Result description'] = ResultDescription, ['Conditional access policies'] = ConditionalAccessPolicies, ['Conditional access status'] = ConditionalAccessStatus, ['Operating system'] = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser, ['Country or region'] = LocationDetails.countryOrRegion, ['State'] = LocationDetails.state, ['City'] = LocationDetails.city, ['Time generated'] = TimeGenerated, Status, ['User principal name'] = UserPrincipalName, Category\\r\\n| where Category in ({Category})\\r\\n\\r\\n\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Location Sign-in details\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeBrush\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Sign-in Status\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"showIcon\":true}},{\"columnMatch\":\"App\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Error code\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result type\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result signature\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result description\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Conditional access policies\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Conditional access status\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Operating system\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Browser\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Time generated\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Status\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"User principal name\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true}},\"customWidth\":\"33\",\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let nonInteractive = AADNonInteractiveUserSignInLogs | extend LocationDetails = parse_json(LocationDetails), Status = parse_json(Status), DeviceDetail = parse_json(DeviceDetail);\\r\\nlet data = \\r\\nunion SigninLogs,nonInteractive\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) \\r\\n    | extend errorCode = Status.errorCode\\r\\n    | extend SigninStatus = case(errorCode == 0, \\\"Success\\\", errorCode == 50058, \\\"Pending user action\\\", errorCode == 50140, \\\"Pending user action\\\", errorCode == 51006, \\\"Pending user action\\\", errorCode == 50059, \\\"Pending user action\\\", errorCode == 65001, \\\"Pending user action\\\", errorCode == 52004, \\\"Pending user action\\\", errorCode == 50055, \\\"Pending user action\\\", errorCode == 50144, \\\"Pending user action\\\", errorCode == 50072, \\\"Pending user action\\\", errorCode == 50074, \\\"Pending user action\\\", errorCode == 16000, \\\"Pending user action\\\", errorCode == 16001, \\\"Pending user action\\\", errorCode == 16003, \\\"Pending user action\\\", errorCode == 50127, \\\"Pending user action\\\", errorCode == 50125, \\\"Pending user action\\\", errorCode == 50129, \\\"Pending user action\\\", errorCode == 50143, \\\"Pending user action\\\", errorCode == 81010, \\\"Pending user action\\\", errorCode == 81014, \\\"Pending user action\\\", errorCode == 81012, \\\"Pending user action\\\", \\\"Failure\\\")\\r\\n| where SigninStatus == '{SigninStatus}' or '{SigninStatus}' == '*' or '{SigninStatus}' == 'All Sign-ins';\\r\\nlet appData = data\\r\\n    | summarize TotalCount = count(), SuccessCount = countif(SigninStatus == \\\"Success\\\"), FailureCount = countif(SigninStatus == \\\"Failure\\\"), InterruptCount = countif(SigninStatus == \\\"Pending user action\\\") by Os = tostring(DeviceDetail.operatingSystem) ,Category\\r\\n    | where Os != ''\\r\\n    | join kind=inner (data\\r\\n        | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by Os = tostring(DeviceDetail.operatingSystem)\\r\\n        | project-away TimeGenerated)\\r\\n        on Os\\r\\n    | order by TotalCount desc, Os asc\\r\\n    | project Os, TotalCount, SuccessCount, FailureCount, InterruptCount, Trend,Category\\r\\n    | serialize Id = row_number();\\r\\ndata\\r\\n| summarize TotalCount = count(), SuccessCount = countif(SigninStatus == \\\"Success\\\"), FailureCount = countif(SigninStatus == \\\"Failure\\\"), InterruptCount = countif(SigninStatus == \\\"Pending user action\\\") by Os = tostring(DeviceDetail.operatingSystem), Browser = tostring(DeviceDetail.browser),Category\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain})by Os = tostring(DeviceDetail.operatingSystem), Browser = tostring(DeviceDetail.browser)\\r\\n    | project-away TimeGenerated)\\r\\n    on Os, Browser\\r\\n| order by TotalCount desc, Os asc\\r\\n| project Os, Browser, TotalCount, SuccessCount, FailureCount, InterruptCount, Trend,Category\\r\\n| serialize Id = row_number(1000000)\\r\\n| join kind=inner (appData) on Os\\r\\n| project Id, Name = Browser, Type = 'Browser', ['Sign-in Count'] = TotalCount, Trend, ['Failure Count'] = FailureCount, ['Interrupt Count'] = InterruptCount, ['Success Rate'] = 1.0 * SuccessCount / TotalCount, ParentId = Id1,Category\\r\\n| union (appData \\r\\n    | project Id, Name = Os, Type = 'Operating System', ['Sign-in Count'] = TotalCount, Trend, ['Failure Count'] = FailureCount, ['Interrupt Count'] = InterruptCount, ['Success Rate'] = 1.0 * SuccessCount / TotalCount, ParentId = -1,Category)\\r\\n| where Category in ({Category})\\r\\n| order by ['Sign-in Count'] desc, Name asc\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Sign-ins by Device\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeBrush\",\"exportedParameters\":[{\"parameterName\":\"DeviceDetail\",\"defaultValue\":\"{ \\\"Name\\\":\\\"\\\", \\\"Type\\\":\\\"*\\\"}\"},{\"fieldName\":\"Category\",\"parameterName\":\"exportCategory\",\"parameterType\":1,\"defaultValue\":\"*\"},{\"fieldName\":\"Name\",\"parameterName\":\"exportName\",\"parameterType\":1,\"defaultValue\":\"*\"}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Type\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Sign-in Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Failure Count|Interrupt Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"orange\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Success Rate\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"percent\"}}},{\"columnMatch\":\"ParentId\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true,\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"ParentId\",\"treeType\":0,\"expanderColumn\":\"Name\",\"expandTopLevel\":false}}},\"customWidth\":\"67\",\"showPin\":true,\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let nonInteractive = AADNonInteractiveUserSignInLogs\\r\\n| extend LocationDetails = parse_json(LocationDetails),Status = parse_json(Status),ConditionalAccessPolicies = parse_json(ConditionalAccessPolicies),DeviceDetail =parse_json(DeviceDetail);\\r\\nlet details = dynamic({ \\\"Name\\\":\\\"\\\", \\\"Type\\\":\\\"*\\\"});\\r\\nlet data = union SigninLogs,nonInteractive\\r\\n| extend AppDisplayName = iff(AppDisplayName == '', 'Unknown', AppDisplayName)\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) \\r\\n| extend Country = tostring(LocationDetails.countryOrRegion)\\r\\n| extend City = tostring(LocationDetails.city)\\r\\n| extend errorCode = Status.errorCode\\r\\n| extend SigninStatus = case(errorCode == 0, \\\"Success\\\", errorCode == 50058, \\\"Pending user action\\\",errorCode == 50140, \\\"Pending user action\\\", errorCode == 51006, \\\"Pending user action\\\", errorCode == 50059, \\\"Pending user action\\\",errorCode == 65001, \\\"Pending user action\\\", errorCode == 52004, \\\"Pending user action\\\", errorCode == 50055, \\\"Pending user action\\\", errorCode == 50144, \\\"Pending user action\\\", errorCode == 50072, \\\"Pending user action\\\", errorCode == 50074, \\\"Pending user action\\\", errorCode == 16000, \\\"Pending user action\\\", errorCode == 16001, \\\"Pending user action\\\", errorCode == 16003, \\\"Pending user action\\\", errorCode == 50127, \\\"Pending user action\\\", errorCode == 50125, \\\"Pending user action\\\", errorCode == 50129, \\\"Pending user action\\\", errorCode == 50143, \\\"Pending user action\\\", errorCode == 81010, \\\"Pending user action\\\", errorCode == 81014, \\\"Pending user action\\\", errorCode == 81012 ,\\\"Pending user action\\\", \\\"Failure\\\")\\r\\n| where SigninStatus == '{SigninStatus}' or '{SigninStatus}' == '*' or '{SigninStatus}' == 'All Sign-ins'\\r\\n| where details.Type == '*' or (details.Type == 'Country' and Country == details.Name) or (details.Type == 'City' and City == details.Name);\\r\\ndata\\r\\n| top 200 by TimeGenerated desc\\r\\n| extend TimeFromNow = now() - TimeGenerated\\r\\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\\r\\n| project User = UserDisplayName, ['Sign-in Status'] = strcat(iff(SigninStatus == 'Success', '', ''), ' ', SigninStatus), ['Sign-in Time'] = TimeAgo, App = AppDisplayName, ['Error code'] = errorCode, ['Result type'] = ResultType, ['Result signature'] = ResultSignature, ['Result description'] = ResultDescription, ['Conditional access policies'] = ConditionalAccessPolicies, ['Conditional access status'] = ConditionalAccessStatus, ['Operating system'] = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser, ['Country or region'] = LocationDetails.countryOrRegion, ['State'] = LocationDetails.state, ['City'] = LocationDetails.city, ['Time generated'] = TimeGenerated, Status, ['User principal name'] = UserPrincipalName, Category, Name = tostring(DeviceDetail.operatingSystem)\\r\\n| where Category in ('{exportCategory}') or \\\"*\\\" in ('{exportCategory}')\\r\\n| where Name in ('{exportName}') or \\\"*\\\" in ('{exportName}')\",\"size\":1,\"showAnalytics\":true,\"title\":\"Device Sign-in details\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Sign-in Status\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\"}},{\"columnMatch\":\"App\",\"formatter\":5},{\"columnMatch\":\"Error code\",\"formatter\":5},{\"columnMatch\":\"Result type\",\"formatter\":5},{\"columnMatch\":\"Result signature\",\"formatter\":5},{\"columnMatch\":\"Result description\",\"formatter\":5},{\"columnMatch\":\"Conditional access policies\",\"formatter\":5},{\"columnMatch\":\"Conditional access status\",\"formatter\":5},{\"columnMatch\":\"Operating system\",\"formatter\":5},{\"columnMatch\":\"Browser\",\"formatter\":5},{\"columnMatch\":\"Country or region\",\"formatter\":5},{\"columnMatch\":\"State\",\"formatter\":5},{\"columnMatch\":\"City\",\"formatter\":5},{\"columnMatch\":\"Time generated\",\"formatter\":5},{\"columnMatch\":\"Status\",\"formatter\":5},{\"columnMatch\":\"User principal name\",\"formatter\":5},{\"columnMatch\":\"Category\",\"formatter\":5},{\"columnMatch\":\"Name\",\"formatter\":5}],\"filter\":true}},\"customWidth\":\"33\",\"name\":\"query - 8 - Copy\"},{\"type\":1,\"content\":{\"json\":\"## Sign-ins using Conditional Access\"},\"name\":\"text - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let nonInteractive = AADNonInteractiveUserSignInLogs\\r\\n| extend LocationDetails = parse_json(LocationDetails)\\r\\n| extend Status = parse_json(Status)\\r\\n| extend ConditionalAccessPolicies = parse_json(ConditionalAccessPolicies);\\r\\nlet data = \\r\\nunion SigninLogs,nonInteractive\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) \\r\\n|extend CAStatus = case(ConditionalAccessStatus ==\\\"success\\\",\\\"Successful\\\",\\r\\n                    ConditionalAccessStatus == \\\"failure\\\", \\\"Failed\\\",                                     \\r\\n                    ConditionalAccessStatus == \\\"notApplied\\\", \\\"Not applied\\\",                                     \\r\\n                    isempty(ConditionalAccessStatus), \\\"Not applied\\\", \\r\\n                    \\\"Disabled\\\")\\r\\n|mvexpand ConditionalAccessPolicies\\r\\n|extend CAGrantControlName = tostring(ConditionalAccessPolicies.enforcedGrantControls[0])\\r\\n|extend CAGrantControl = case(CAGrantControlName contains \\\"MFA\\\", \\\"Require MFA\\\", \\r\\n                            CAGrantControlName contains \\\"Terms of Use\\\", \\\"Require Terms of Use\\\", \\r\\n                            CAGrantControlName contains \\\"Privacy\\\", \\\"Require Privacy Statement\\\", \\r\\n                            CAGrantControlName contains \\\"Device\\\", \\\"Require Device Compliant\\\", \\r\\n                            CAGrantControlName contains \\\"Azure AD Joined\\\", \\\"Require Hybird Azure AD Joined Device\\\", \\r\\n                            CAGrantControlName contains \\\"Apps\\\", \\\"Require Approved Apps\\\",\\r\\n                            \\\"Other\\\");\\r\\ndata\\r\\n| where Category in ({Category})\\r\\n| summarize Count = dcount(Id) by CAStatus\\r\\n| join kind = inner (data\\r\\n                    | make-series Trend = dcount(Id) default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by CAStatus\\r\\n                    ) on CAStatus\\r\\n| project-away CAStatus1, TimeGenerated\\r\\n| order by Count desc\",\"size\":4,\"title\":\"Conditional access status\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeBrush\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"CAStatus\",\"formatter\":1},\"subtitleContent\":{\"columnMatch\":\"Category\"},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false}},\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let nonInteractive = AADNonInteractiveUserSignInLogs\\r\\n| extend LocationDetails = parse_json(LocationDetails)\\r\\n| extend Status = parse_json(Status)\\r\\n| extend ConditionalAccessPolicies = parse_json(ConditionalAccessPolicies);\\r\\nlet data = \\r\\nunion SigninLogs,nonInteractive|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) \\r\\n|extend errorCode = toint(Status.errorCode)\\r\\n|extend Reason = tostring(Status.failureReason)\\r\\n|extend CAStatus = case(ConditionalAccessStatus ==0,\\\" Success\\\",                                     \\r\\n                        ConditionalAccessStatus == 1, \\\" Failure\\\",                                     \\r\\n                        ConditionalAccessStatus == 2, \\\" Not Applied\\\",                                     \\r\\n                        ConditionalAccessStatus == \\\"\\\", \\\" Not Applied\\\", \\r\\n                        \\\" Disabled\\\")\\r\\n|mvexpand ConditionalAccessPolicies\\r\\n|extend CAGrantControlName = tostring(ConditionalAccessPolicies.enforcedGrantControls[0])\\r\\n|extend CAGrantControl = case(CAGrantControlName contains \\\"MFA\\\", \\\"Require MFA\\\", \\r\\n                            CAGrantControlName contains \\\"Terms of Use\\\", \\\"Require Terms of Use\\\", \\r\\n                            CAGrantControlName contains \\\"Privacy\\\", \\\"Require Privacy Statement\\\", \\r\\n                            CAGrantControlName contains \\\"Device\\\", \\\"Require Device Compliant\\\", \\r\\n                            CAGrantControlName contains \\\"Azure AD Joined\\\", \\\"Require Hybird Azure AD Joined Device\\\", \\r\\n                            CAGrantControlName contains \\\"Apps\\\", \\\"Require Approved Apps\\\",\\\"Other\\\");\\r\\ndata\\r\\n| summarize Count = dcount(Id) by CAStatus, CAGrantControl\\r\\n| project Id = strcat(CAStatus, '/', CAGrantControl), Name = CAGrantControl, Parent = CAStatus, Count, Type = 'CAGrantControl'\\r\\n| join kind = inner (data\\r\\n                    | make-series Trend = dcount(Id) default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by CAStatus, CAGrantControl\\r\\n                    | project Id = strcat(CAStatus, '/', CAGrantControl), Trend\\r\\n                    ) on Id\\r\\n| project-away Id1\\r\\n| union (data\\r\\n    | where Category in ({Category})\\r\\n    | summarize Count = dcount(Id) by CAStatus\\r\\n    | project Id = CAStatus, Name = CAStatus, Parent = '', Count, Type = 'CAStatus'\\r\\n    | join kind = inner (data\\r\\n                        | make-series Trend = dcount(Id) default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by CAStatus\\r\\n                        | project Id = CAStatus, Trend\\r\\n                        ) on Id\\r\\n    | project-away Id1)\\r\\n| order by Count desc\",\"size\":0,\"title\":\"Conditional access status\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeBrush\",\"exportParameterName\":\"Detail\",\"exportDefaultValue\":\"{ \\\"Name\\\":\\\"\\\", \\\"Type\\\":\\\"*\\\", \\\"Parent\\\":\\\"*\\\"}\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Parent\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Type\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"Parent\",\"treeType\":0,\"expanderColumn\":\"Name\",\"expandTopLevel\":true}}},\"customWidth\":\"50\",\"name\":\"query - 10\",\"styleSettings\":{\"margin\":\"50\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let details = dynamic({Detail});\\r\\nlet nonInteractive = AADNonInteractiveUserSignInLogs\\r\\n| extend LocationDetails = parse_json(LocationDetails)\\r\\n| extend Status = parse_json(Status)\\r\\n| extend ConditionalAccessPolicies = parse_json(ConditionalAccessPolicies);\\r\\nlet data = \\r\\nunion SigninLogs,nonInteractive\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) \\r\\n|extend errorCode = toint(Status.errorCode)\\r\\n|extend Reason = tostring(Status.failureReason)\\r\\n|extend CAStatus = case(ConditionalAccessStatus ==\\\"success\\\",\\\" Success\\\",                                     \\r\\n                        ConditionalAccessStatus == \\\"failure\\\", \\\" Failure\\\",                                     \\r\\n                        ConditionalAccessStatus == \\\"notApplied\\\", \\\" Not Applied\\\",                                     \\r\\n                        ConditionalAccessStatus == \\\"\\\", \\\" Not Applied\\\", \\r\\n                        \\\" Disabled\\\")\\r\\n|mvexpand ConditionalAccessPolicies\\r\\n|extend CAGrantControlName = tostring(ConditionalAccessPolicies.enforcedGrantControls[0])\\r\\n|extend CAGrantControl = case(CAGrantControlName contains \\\"MFA\\\", \\\"Require MFA\\\", \\r\\n                            CAGrantControlName contains \\\"Terms of Use\\\", \\\"Require Terms of Use\\\", \\r\\n                            CAGrantControlName contains \\\"Privacy\\\", \\\"Require Privacy Statement\\\", \\r\\n                            CAGrantControlName contains \\\"Device\\\", \\\"Require Device Compliant\\\", \\r\\n                            CAGrantControlName contains \\\"Azure AD Joined\\\", \\\"Require Hybird Azure AD Joined Device\\\", \\r\\n                            CAGrantControlName contains \\\"Apps\\\", \\\"Require Approved Apps\\\",\\r\\n                            \\\"Other\\\")\\r\\n|extend CAGrantControlRank = case(CAGrantControlName contains \\\"MFA\\\", 1, \\r\\n                            CAGrantControlName contains \\\"Terms of Use\\\", 2, \\r\\n                            CAGrantControlName contains \\\"Privacy\\\", 3, \\r\\n                            CAGrantControlName contains \\\"Device\\\", 4, \\r\\n                            CAGrantControlName contains \\\"Azure AD Joined\\\", 5, \\r\\n                            CAGrantControlName contains \\\"Apps\\\", 6,\\r\\n                            7)\\r\\n| where details.Type == '*' or (details.Type == 'CAStatus' and CAStatus == details.Name) or (details.Type == 'CAGrantControl' and CAGrantControl == details.Name and CAStatus == details.Parent);\\r\\ndata\\r\\n| order by CAGrantControlRank desc\\r\\n| summarize CAGrantControls = make_set(CAGrantControl) by AppDisplayName, CAStatus, TimeGenerated, UserDisplayName, Category\\r\\n| extend CAGrantControlText = replace(@\\\",\\\", \\\", \\\", replace(@'\\\"', @'', replace(@\\\"\\\\]\\\", @\\\"\\\", replace(@\\\"\\\\[\\\", @\\\"\\\", tostring(CAGrantControls)))))\\r\\n| extend CAGrantControlSummary = case(array_length(CAGrantControls) > 1, strcat(CAGrantControls[0], ' + ', array_length(CAGrantControls) - 1, ' more'), array_length(CAGrantControls) == 1, tostring(CAGrantControls[0]), 'None')\\r\\n| top 200 by TimeGenerated desc\\r\\n| extend TimeFromNow = now() - TimeGenerated\\r\\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\\r\\n| project Application = AppDisplayName, ['CA Status'] = CAStatus, ['CA Grant Controls'] = CAGrantControlSummary, ['All CA Grant Controls'] = CAGrantControlText, ['Sign-in Time'] = TimeAgo, ['User'] = UserDisplayName, Category\\r\\n| where Category in ({Category})\",\"size\":0,\"showAnalytics\":true,\"title\":\"Recent sign-ins\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"CA Grant Controls\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"All CA Grant Controls\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"User\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}]}},\"customWidth\":\"50\",\"showPin\":true,\"name\":\"query - 7 - Copy\"},{\"type\":1,\"content\":{\"json\":\"## Troubleshooting Sign-ins\"},\"name\":\"text - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let nonInteractive = AADNonInteractiveUserSignInLogs\\r\\n| extend LocationDetails = parse_json(LocationDetails)\\r\\n| extend Status = parse_json(Status);\\r\\nlet data = \\r\\nunion SigninLogs,nonInteractive|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) \\r\\n|extend errorCode = Status.errorCode\\r\\n|extend SigninStatus = case(errorCode == 0, \\\"Success\\\", errorCode == 50058, \\\"Pending action (Interrupts)\\\",errorCode == 50140, \\\"Pending action (Interrupts)\\\", errorCode == 51006, \\\"Pending action (Interrupts)\\\", errorCode == 50059, \\\"Pending action (Interrupts)\\\",errorCode == 65001, \\\"Pending action (Interrupts)\\\", errorCode == 52004, \\\"Pending action (Interrupts)\\\", errorCode == 50055, \\\"Pending action (Interrupts)\\\", errorCode == 50144, \\\"Pending action (Interrupts)\\\", errorCode == 50072, \\\"Pending action (Interrupts)\\\", errorCode == 50074, \\\"Pending action (Interrupts)\\\", errorCode == 16000, \\\"Pending action (Interrupts)\\\", errorCode == 16001, \\\"Pending action (Interrupts)\\\", errorCode == 16003, \\\"Pending action (Interrupts)\\\", errorCode == 50127, \\\"Pending action (Interrupts)\\\", errorCode == 50125, \\\"Pending action (Interrupts)\\\", errorCode == 50129, \\\"Pending action (Interrupts)\\\", errorCode == 50143, \\\"Pending action (Interrupts)\\\", errorCode == 81010, \\\"Pending action (Interrupts)\\\", errorCode == 81014, \\\"Pending action (Interrupts)\\\", errorCode == 81012 ,\\\"Pending action (Interrupts)\\\", \\\"Failure\\\");\\r\\ndata\\r\\n| summarize Count = count() by SigninStatus, Category\\r\\n| join kind = fullouter (datatable(SigninStatus:string)['Success', 'Pending action (Interrupts)', 'Failure']) on SigninStatus\\r\\n| project SigninStatus = iff(SigninStatus == '', SigninStatus1, SigninStatus), Count = iff(SigninStatus == '', 0, Count), Category\\r\\n| join kind = inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SigninStatus)\\r\\n    on SigninStatus\\r\\n| project-away SigninStatus1, TimeGenerated\\r\\n| extend Status = SigninStatus\\r\\n| union (\\r\\n    data \\r\\n    | summarize Count = count() \\r\\n    | extend jkey = 1\\r\\n    | join kind=inner (data\\r\\n        | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\\r\\n        | extend jkey = 1) on jkey\\r\\n    | extend SigninStatus = 'All Sign-ins', Status = '*'    \\r\\n)\\r\\n| where Category in ({Category})\\r\\n| order by Count desc\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":3,\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"SigninStatus\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}},\"showBorder\":false}},\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let nonInteractive = AADNonInteractiveUserSignInLogs\\r\\n| extend LocationDetails = parse_json(LocationDetails)\\r\\n| extend Status = parse_json(Status);\\r\\nlet data = \\r\\nunion SigninLogs,nonInteractive|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) \\r\\n| extend ErrorCode = tostring(Status.errorCode) \\r\\n| extend FailureReason = tostring(Status.failureReason) \\r\\n| where ErrorCode !in (\\\"0\\\",\\\"50058\\\",\\\"50148\\\",\\\"50140\\\", \\\"51006\\\", \\\"50059\\\", \\\"65001\\\", \\\"52004\\\", \\\"50055\\\", \\\"50144\\\",\\\"50072\\\", \\\"50074\\\", \\\"16000\\\",\\\"16001\\\", \\\"16003\\\", \\\"50127\\\", \\\"50125\\\", \\\"50129\\\",\\\"50143\\\", \\\"81010\\\", \\\"81014\\\", \\\"81012\\\") \\r\\n|summarize errCount = count() by ErrorCode, tostring(FailureReason), Category| sort by errCount, Category\\r\\n|project [' Error Code'] = ErrorCode, ['Reason']= FailureReason, ['Error Count'] = toint(errCount), Category\\r\\n|where Category in ({Category});\\r\\ndata\",\"size\":1,\"showAnalytics\":true,\"title\":\"Summary of top errors\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeBrush\",\"exportFieldName\":\" Error Code\",\"exportParameterName\":\"ErrorCode\",\"exportDefaultValue\":\"*\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Error Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"orange\",\"showIcon\":true}}],\"filter\":true}},\"customWidth\":\"67\",\"showPin\":true,\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let nonInteractive = AADNonInteractiveUserSignInLogs\\r\\n| extend LocationDetails = parse_json(LocationDetails)\\r\\n| extend Status = parse_json(Status)\\r\\n| extend DeviceDetail = parse_json(DeviceDetail)\\r\\n| extend ConditionalAccessPolicies = parse_json(ConditionalAccessPolicies);\\r\\nlet data=\\r\\nunion SigninLogs,nonInteractive\\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) \\r\\n| extend ErrorCode = tostring(Status.errorCode) \\r\\n| extend FailureReason = tostring(Status.failureReason) \\r\\n| where ErrorCode !in (\\\"0\\\",\\\"50058\\\",\\\"50148\\\",\\\"50140\\\", \\\"51006\\\", \\\"50059\\\", \\\"65001\\\", \\\"52004\\\", \\\"50055\\\", \\\"50144\\\",\\\"50072\\\", \\\"50074\\\", \\\"16000\\\",\\\"16001\\\", \\\"16003\\\", \\\"50127\\\", \\\"50125\\\", \\\"50129\\\",\\\"50143\\\", \\\"81010\\\", \\\"81014\\\", \\\"81012\\\") \\r\\n| where '{ErrorCode}' == '*' or '{ErrorCode}' == ErrorCode\\r\\n| top 200 by TimeGenerated desc\\r\\n| extend TimeFromNow = now() - TimeGenerated\\r\\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\\r\\n| project User = UserDisplayName, IPAddress, [' Error Code'] = ErrorCode, ['Sign-in Time'] = TimeAgo, App = AppDisplayName, ['Error code'] = ErrorCode, ['Result type'] = ResultType, ['Result signature'] = ResultSignature, ['Result description'] = ResultDescription, ['Conditional access policies'] = ConditionalAccessPolicies, ['Conditional access status'] = ConditionalAccessStatus, ['Operating system'] = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser, ['Country or region'] = LocationDetails.countryOrRegion, ['State'] = LocationDetails.state, ['City'] = LocationDetails.city, ['Time generated'] = TimeGenerated, Status, ['User principal name'] = UserPrincipalName, Category\\r\\n| where Category in ({Category});\\r\\ndata\\r\\n\\r\\n\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Sign-ins with errors\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeBrush\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\" Error Code\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"GenericDetails\",\"showIcon\":true}},{\"columnMatch\":\"App\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Error code\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result type\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result signature\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result description\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Conditional access policies\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Conditional access status\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Operating system\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Browser\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Country or region\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"State\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"City\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Time generated\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Status\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"User principal name\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true}},\"customWidth\":\"33\",\"name\":\"query - 5 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let nonInteractive = AADNonInteractiveUserSignInLogs\\r\\n| extend LocationDetails = parse_json(LocationDetails)\\r\\n| extend Status = parse_json(Status);\\r\\nlet data = \\r\\nunion SigninLogs,nonInteractive|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) \\r\\n| extend ErrorCode = tostring(Status.errorCode) \\r\\n| extend FailureReason = Status.failureReason \\r\\n| where ErrorCode in (\\\"50058\\\",\\\"50140\\\", \\\"51006\\\", \\\"50059\\\", \\\"65001\\\", \\\"52004\\\", \\\"50055\\\", \\\"50144\\\",\\\"50072\\\", \\\"50074\\\", \\\"16000\\\",\\\"16001\\\", \\\"16003\\\", \\\"50127\\\", \\\"50125\\\", \\\"50129\\\",\\\"50143\\\", \\\"81010\\\", \\\"81014\\\", \\\"81012\\\") \\r\\n|summarize errCount = count() by ErrorCode, tostring(FailureReason), Category\\r\\n| sort by errCount\\r\\n|project [' Error Code'] = ErrorCode, ['Reason'] = FailureReason, ['Interrupt Count'] = toint(errCount), Category\\r\\n| where Category in ({Category});\\r\\ndata\",\"size\":1,\"showAnalytics\":true,\"title\":\"Summary of sign-ins waiting on user action\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeBrush\",\"exportFieldName\":\" Error Code\",\"exportParameterName\":\"InterruptErrorCode\",\"exportDefaultValue\":\"*\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Interrupt Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"orange\"}}],\"filter\":true}},\"customWidth\":\"67\",\"showPin\":true,\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let nonInteractive = AADNonInteractiveUserSignInLogs\\r\\n| extend LocationDetails = parse_json(LocationDetails)\\r\\n| extend ConditionalAccessPolicies = parse_json(ConditionalAccessPolicies)\\r\\n| extend DeviceDetail = parse_json(DeviceDetail)\\r\\n| extend Status = parse_json(Status);\\r\\nlet data = \\r\\nunion SigninLogs,nonInteractive \\r\\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\\r\\n|where UserDisplayName in ({Users}) \\r\\n| extend ErrorCode = tostring(Status.errorCode) \\r\\n| extend FailureReason = Status.failureReason \\r\\n| where ErrorCode in (\\\"50058\\\",\\\"50140\\\", \\\"51006\\\", \\\"50059\\\", \\\"65001\\\", \\\"52004\\\", \\\"50055\\\", \\\"50144\\\",\\\"50072\\\", \\\"50074\\\", \\\"16000\\\",\\\"16001\\\", \\\"16003\\\", \\\"50127\\\", \\\"50125\\\", \\\"50129\\\",\\\"50143\\\", \\\"81010\\\", \\\"81014\\\", \\\"81012\\\") \\r\\n| where '{InterruptErrorCode}' == '*' or '{InterruptErrorCode}' == ErrorCode\\r\\n| top 200 by TimeGenerated desc\\r\\n| extend TimeFromNow = now() - TimeGenerated\\r\\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\\r\\n| project User = UserDisplayName, IPAddress, [' Error Code'] = ErrorCode, ['Sign-in Time'] = TimeAgo, App = AppDisplayName, ['Error code'] = ErrorCode, ['Result type'] = ResultType, ['Result signature'] = ResultSignature, ['Result description'] = ResultDescription, ['Conditional access policies'] = ConditionalAccessPolicies, ['Conditional access status'] = ConditionalAccessStatus, ['Operating system'] = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser, ['Country or region'] = LocationDetails.countryOrRegion, ['State'] = LocationDetails.state, ['City'] = LocationDetails.city, ['Time generated'] = TimeGenerated, Status, ['User principal name'] = UserPrincipalName, Category\\r\\n| where Category in ({Category});\\r\\ndata\\r\\n\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Sign-ins waiting on user action\",\"timeContext\":{\"durationMs\":1209600000},\"timeContextFromParameter\":\"TimeBrush\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\" Error Code\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"GenericDetails\",\"showIcon\":true}},{\"columnMatch\":\"App\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Error code\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result type\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result signature\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Result description\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Conditional access policies\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Conditional access status\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Operating system\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Browser\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Country or region\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"State\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"City\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Time generated\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Status\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"User principal name\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true}},\"customWidth\":\"33\",\"showPin\":true,\"name\":\"query - 7 - Copy\"}],\"fromTemplateId\":\"sentinel-AzureActiveDirectorySigninLogs\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                                "version": "1.0",
                                "sourceId": "[variables('workspaceResourceId')]",
                                "category": "sentinel"
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId2'),'/'))))]",
                              "properties": {
                                "description": "@{workbookKey=AzureActiveDirectorySigninLogsWorkbook; logoFileName=azureactivedirectory_logo.svg; description=Gain insights into Microsoft Entra ID by connecting Microsoft Sentinel and using the sign-in logs to gather insights around Microsoft Entra ID scenarios. \nYou can learn about sign-in operations, such as user sign-ins and locations, email addresses, and  IP addresses of your users, as well as failed activities and the errors that triggered the failures.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=2.4.0; title=Microsoft Entra ID Sign-in logs; templateRelativePath=AzureActiveDirectorySignins.json; subtitle=; provider=Microsoft}.description",
                                "parentId": "[variables('workbookId2')]",
                                "contentId": "[variables('_workbookContentId2')]",
                                "kind": "Workbook",
                                "version": "[variables('workbookVersion2')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                },
                                "dependencies": {
                                  "operator": "AND",
                                  "criteria": [
                                    {
                                      "contentId": "SigninLogs",
                                      "kind": "DataType"
                                    },
                                    {
                                      "contentId": "AzureActiveDirectory",
                                      "kind": "DataConnector"
                                    }
                                  ]
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_workbookContentId2')]",
                        "contentKind": "Workbook",
                        "displayName": "[parameters('workbook2-name')]",
                        "contentProductId": "[variables('_workbookcontentProductId2')]",
                        "id": "[variables('_workbookcontentProductId2')]",
                        "version": "[variables('workbookVersion2')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AccountCreatedandDeletedinShortTimeframe_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Search for user principal name (UPN) events. Look for accounts created and then deleted in under 24 hours. Attackers may create an account for their use, and then remove the account when no longer needed.\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-user-accounts#short-lived-account",
                                "displayName": "Account Created and Deleted in Short Timeframe",
                                "enabled": false,
                                "query": "let queryfrequency = 1h;\nlet queryperiod = 1d;\nAuditLogs\n| where TimeGenerated > ago(queryfrequency)\n| where OperationName =~ \"Delete user\"\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type == \"User\"\n      | extend TargetUserPrincipalName = extract(@'([a-f0-9]{32})?(.*)', 2, tostring(TargetResource.userPrincipalName))\n  )\n| extend DeletedByApp = tostring(InitiatedBy.app.displayName),\nDeletedByAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId),\nDeletedByUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName),\nDeletedByAadUserId = tostring(InitiatedBy.user.id),\nDeletedByIPAddress = tostring(InitiatedBy.user.ipAddress)\n| project Deletion_TimeGenerated = TimeGenerated, TargetUserPrincipalName, DeletedByApp, DeletedByAppServicePrincipalId, DeletedByUserPrincipalName, DeletedByAadUserId, DeletedByIPAddress, \nDeletion_AdditionalDetails = AdditionalDetails, Deletion_InitiatedBy = InitiatedBy, Deletion_TargetResources = TargetResources\n| join kind=inner (\n    AuditLogs\n    | where TimeGenerated > ago(queryperiod)\n    | where OperationName =~ \"Add user\"      \n    | mv-apply TargetResource = TargetResources on \n      (\n          where TargetResource.type == \"User\"\n          | extend TargetUserPrincipalName = trim(@'\"',tostring(TargetResource.userPrincipalName))\n      )\n    | project-rename Creation_TimeGenerated = TimeGenerated\n) on TargetUserPrincipalName\n| extend TimeDelta = Deletion_TimeGenerated - Creation_TimeGenerated\n| where  TimeDelta between (time(0s) .. queryperiod)\n| extend CreatedByApp = tostring(InitiatedBy.app.displayName),\nCreatedByAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId),\nCreatedByUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName),\nCreatedByAadUserId = tostring(InitiatedBy.user.id),\nCreatedByIPAddress = tostring(InitiatedBy.user.ipAddress)\n| project Creation_TimeGenerated, Deletion_TimeGenerated, TimeDelta, TargetUserPrincipalName, DeletedByApp, DeletedByAppServicePrincipalId, DeletedByUserPrincipalName, DeletedByAadUserId, DeletedByIPAddress, \nCreatedByApp, CreatedByAppServicePrincipalId, CreatedByUserPrincipalName, CreatedByAadUserId, CreatedByIPAddress, Creation_AdditionalDetails = AdditionalDetails, Creation_InitiatedBy = InitiatedBy, Creation_TargetResources = TargetResources, Deletion_AdditionalDetails, Deletion_InitiatedBy, Deletion_TargetResources\n| extend TargetName = tostring(split(TargetUserPrincipalName,'@',0)[0]), TargetUPNSuffix = tostring(split(TargetUserPrincipalName,'@',1)[0])\n| extend CreatedByName = tostring(split(CreatedByUserPrincipalName,'@',0)[0]), CreatedByUPNSuffix = tostring(split(CreatedByUserPrincipalName,'@',1)[0])\n| extend DeletedByName = tostring(split(DeletedByUserPrincipalName,'@',0)[0]), DeletedByUPNSuffix = tostring(split(DeletedByUserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P1D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess"
                                ],
                                "subTechniques": [
                                  "T1078.004"
                                ],
                                "techniques": [
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "TargetUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "TargetName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "TargetUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "CreatedByUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "CreatedByName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "CreatedByUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "CreatedByAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "DeletedByUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "DeletedByName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "DeletedByUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "DeletedByAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "CreatedByIPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "DeletedByIPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 1",
                                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Account Created and Deleted in Short Timeframe",
                        "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
                        "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
                        "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject2').analyticRuleTemplateSpecName2]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AccountCreatedDeletedByNonApprovedUser_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies accounts that were created or deleted by a defined list of non-approved user principal names. Add to this list before running the query for accurate results.\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-user-accounts",
                                "displayName": "Account created or deleted by non-approved user",
                                "enabled": false,
                                "query": "// Add non-approved user principal names or apps to the list below to search for their account creation/deletion activity\n// ex: dynamic([\"UPN1\", \"upn123\"])\nlet nonapproved_users = dynamic([]);\nlet nonapproved_apps = dynamic([]);\nAuditLogs\n| where OperationName =~ \"Add user\" or OperationName =~ \"Delete user\"\n| where Result =~ \"success\"\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| where InitiatingUserPrincipalName has_any (nonapproved_users) or InitiatingAppName has_any (nonapproved_apps)\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess"
                                ],
                                "subTechniques": [
                                  "T1078.004"
                                ],
                                "techniques": [
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatingAccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAccountUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject2').analyticRuleId2,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 2",
                                "parentId": "[variables('analyticRuleObject2').analyticRuleId2]",
                                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Account created or deleted by non-approved user",
                        "contentProductId": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
                        "id": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
                        "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject3').analyticRuleTemplateSpecName3]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "ADFSDomainTrustMods_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This will alert when a user or application modifies the federation settings on the domain or Update domain authentication from Managed to Federated.\nFor example, this alert will trigger when a new Active Directory Federated Service (ADFS) TrustedRealm object, such as a signing certificate, is added to the domain.\nModification to domain federation settings should be rare. Confirm the added or modified target domain/URL is legitimate administrator behavior.\nTo understand why an authorized user may update settings for a federated domain in Office 365, Azure, or Intune, see: https://docs.microsoft.com/office365/troubleshoot/active-directory/update-federated-domain-office-365.\nFor details on security realms that accept security tokens, see the ADFS Proxy Protocol (MS-ADFSPP) specification: https://docs.microsoft.com/openspecs/windows_protocols/ms-adfspp/e7b9ea73-1980-4318-96a6-da559486664b.\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.",
                                "displayName": "Modified domain federation trust settings",
                                "enabled": false,
                                "query": "(union isfuzzy=true\n(\nAuditLogs\n| where OperationName =~ \"Set federation settings on domain\"\n//| where Result =~ \"success\"   // commenting out, as it may be interesting to capture failed attempts\n| mv-expand TargetResources\n| extend modifiedProperties = parse_json(TargetResources).modifiedProperties\n| mv-expand modifiedProperties\n| extend targetDisplayName = tostring(parse_json(modifiedProperties).displayName)\n),\n(\nAuditLogs\n| where OperationName =~ \"Set domain authentication\"\n//| where Result =~ \"success\"   // commenting out, as it may be interesting to capture failed attempts\n| mv-expand TargetResources\n| extend modifiedProperties = parse_json(TargetResources).modifiedProperties\n| mv-expand modifiedProperties\n| mv-apply Property = modifiedProperties on\n  (\n      where Property.displayName =~ \"LiveType\"\n      | extend targetDisplayName = tostring(Property.displayName),\n               NewDomainValue = tostring(Property.newValue)\n  )\n| where NewDomainValue has \"Federated\"\n)\n)\n| mv-apply AdditionalDetail = AdditionalDetails on\n  (\n      where AdditionalDetail.key =~ \"User-Agent\"\n      | extend UserAgent = tostring(AdditionalDetail.value)\n  )\n| extend InitiatingUserOrApp = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n| project-reorder TimeGenerated, OperationName, InitiatingUserOrApp, AADOperationType, targetDisplayName, Result, InitiatingIpAddress, UserAgent, CorrelationId, TenantId, AADTenantId\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess",
                                  "Persistence",
                                  "PrivilegeEscalation"
                                ],
                                "techniques": [
                                  "T1555",
                                  "T1098"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatingAccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAccountUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject3').analyticRuleId3,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 3",
                                "parentId": "[variables('analyticRuleObject3').analyticRuleId3]",
                                "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Modified domain federation trust settings",
                        "contentProductId": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
                        "id": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
                        "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject4').analyticRuleTemplateSpecName4]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "ADFSSignInLogsPasswordSpray_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies evidence of password spray activity against Connect Health for AD FS sign-in events by looking for failures from multiple accounts from the same IP address within a time window.\nReference: https://adfshelp.microsoft.com/References/ConnectHealthErrorCodeReference",
                                "displayName": "Password spray attack against ADFSSignInLogs",
                                "enabled": false,
                                "query": "let queryfrequency = 30m;\nlet accountthreshold = 10;\nlet successCodes = dynamic([0, 50144]);\nADFSSignInLogs\n| extend IngestionTime = ingestion_time()\n| where IngestionTime > ago(queryfrequency)\n| where not(todynamic(AuthenticationDetails)[0].authenticationMethod == \"Integrated Windows Authentication\")\n| summarize\n    DistinctFailureCount = dcountif(UserPrincipalName, ResultType !in (successCodes)),\n    DistinctSuccessCount = dcountif(UserPrincipalName, ResultType in (successCodes)),\n    SuccessAccounts = make_set_if(UserPrincipalName, ResultType in (successCodes), 250),\n    arg_min(TimeGenerated, *)\n    by IPAddress\n| where DistinctFailureCount > DistinctSuccessCount and DistinctFailureCount >= accountthreshold\n//| extend SuccessAccounts = iff(array_length(SuccessAccounts) != 0, SuccessAccounts, dynamic([\"null\"]))\n//| mv-expand SuccessAccounts\n| project TimeGenerated, Category, OperationName, IPAddress, DistinctFailureCount, DistinctSuccessCount, SuccessAccounts, AuthenticationRequirement, ConditionalAccessStatus, IsInteractive, UserAgent, NetworkLocationDetails, DeviceDetail, TokenIssuerType, TokenIssuerName, ResourceIdentity\n",
                                "queryFrequency": "PT30M",
                                "queryPeriod": "PT1H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "ADFSSignInLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess"
                                ],
                                "techniques": [
                                  "T1110"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject4').analyticRuleId4,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 4",
                                "parentId": "[variables('analyticRuleObject4').analyticRuleId4]",
                                "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Password spray attack against ADFSSignInLogs",
                        "contentProductId": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
                        "id": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
                        "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject5').analyticRuleTemplateSpecName5]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AdminPromoAfterRoleMgmtAppPermissionGrant_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject5').analyticRuleVersion5]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This rule looks for a service principal being granted the Microsoft Graph RoleManagement.ReadWrite.Directory (application) permission before being used to add an Microsoft Entra ID object or user account to an Admin directory role (i.e. Global Administrators).\nThis is a known attack path that is usually abused when a service principal already has the AppRoleAssignment.ReadWrite.All permission granted. This permission allows an app to manage permission grants for application permissions to any API.\nA service principal can promote itself or other service principals to admin roles (i.e. Global Administrators). This would be considered a privilege escalation technique.\nRef : https://docs.microsoft.com/graph/permissions-reference#role-management-permissions, https://docs.microsoft.com/graph/api/directoryrole-post-members?view=graph-rest-1.0&tabs=http",
                                "displayName": "Admin promotion after Role Management Application Permission Grant",
                                "enabled": false,
                                "query": "let query_frequency = 1h;\nlet query_period = 2h;\nAuditLogs\n| where TimeGenerated > ago(query_period)\n| where Category =~ \"ApplicationManagement\" and LoggedByService =~ \"Core Directory\"\n| where OperationName =~ \"Add app role assignment to service principal\"\n| mv-expand TargetResource = TargetResources\n| mv-expand modifiedProperty = TargetResource[\"modifiedProperties\"]\n| where tostring(modifiedProperty[\"displayName\"]) == \"AppRole.Value\"\n| extend PermissionGrant = tostring(modifiedProperty[\"newValue\"])\n| where PermissionGrant has \"RoleManagement.ReadWrite.Directory\"\n| mv-apply modifiedProperty = TargetResource[\"modifiedProperties\"] on (\n    summarize modifiedProperties = make_bag(\n        bag_pack(tostring(modifiedProperty[\"displayName\"]),\n            bag_pack(\"oldValue\", trim(@'[\\\"\\s]+', tostring(modifiedProperty[\"oldValue\"])),\n                \"newValue\", trim(@'[\\\"\\s]+', tostring(modifiedProperty[\"newValue\"])))), 100)\n)\n| project\n    PermissionGrant_TimeGenerated = TimeGenerated,\n    PermissionGrant_OperationName = OperationName,\n    PermissionGrant_Result = Result,\n    PermissionGrant,\n    AppDisplayName = tostring(modifiedProperties[\"ServicePrincipal.DisplayName\"][\"newValue\"]),\n    AppServicePrincipalId = tostring(modifiedProperties[\"ServicePrincipal.ObjectID\"][\"newValue\"]),\n    PermissionGrant_InitiatedBy = InitiatedBy,\n    PermissionGrant_TargetResources = TargetResources,\n    PermissionGrant_AdditionalDetails = AdditionalDetails,\n    PermissionGrant_CorrelationId = CorrelationId\n| join kind=inner (\n    AuditLogs\n    | where TimeGenerated > ago(query_frequency)\n    | where Category =~ \"RoleManagement\" and LoggedByService =~ \"Core Directory\" and AADOperationType =~ \"Assign\"\n    | where isnotempty(InitiatedBy[\"app\"])\n    | mv-expand TargetResource = TargetResources\n    | mv-expand modifiedProperty = TargetResource[\"modifiedProperties\"]\n    | where tostring(modifiedProperty[\"displayName\"]) in (\"Role.DisplayName\", \"RoleDefinition.DisplayName\")\n    | extend RoleAssignment = tostring(modifiedProperty[\"newValue\"])\n    | where RoleAssignment contains \"Admin\"\n    | project\n        RoleAssignment_TimeGenerated = TimeGenerated,\n        RoleAssignment_OperationName = OperationName,\n        RoleAssignment_Result = Result,\n        RoleAssignment,\n        TargetType = tostring(TargetResources[0][\"type\"]),\n        Target = iff(isnotempty(TargetResources[0][\"displayName\"]), tostring(TargetResources[0][\"displayName\"]), tolower(TargetResources[0][\"userPrincipalName\"])),\n        TargetId = tostring(TargetResources[0][\"id\"]),\n        RoleAssignment_InitiatedBy = InitiatedBy,\n        RoleAssignment_TargetResources = TargetResources,\n        RoleAssignment_AdditionalDetails = AdditionalDetails,\n        RoleAssignment_CorrelationId = CorrelationId,\n        AppServicePrincipalId = tostring(InitiatedBy[\"app\"][\"servicePrincipalId\"])\n    ) on AppServicePrincipalId\n| where PermissionGrant_TimeGenerated < RoleAssignment_TimeGenerated\n| extend\n    TargetName = tostring(split(Target, \"@\")[0]),\n    TargetUPNSuffix = tostring(split(Target, \"@\")[1])\n| project PermissionGrant_TimeGenerated, PermissionGrant_OperationName, PermissionGrant_Result, PermissionGrant, AppDisplayName, AppServicePrincipalId, PermissionGrant_InitiatedBy, PermissionGrant_TargetResources, PermissionGrant_AdditionalDetails, PermissionGrant_CorrelationId, \nRoleAssignment_TimeGenerated, RoleAssignment_OperationName, RoleAssignment_Result, RoleAssignment, TargetType, Target, TargetName, TargetUPNSuffix, TargetId, RoleAssignment_InitiatedBy, RoleAssignment_TargetResources, RoleAssignment_AdditionalDetails, RoleAssignment_CorrelationId\n| extend PermissionGrant_InitiatingUserPrincipalName = tostring(PermissionGrant_InitiatedBy.user.userPrincipalName)\n| extend PermissionGrant_InitiatingAadUserId = tostring(PermissionGrant_InitiatedBy.user.id)\n| extend PermissionGrant_InitiatingIpAddress = tostring(iff(isnotempty(PermissionGrant_InitiatedBy.user.ipAddress), PermissionGrant_InitiatedBy.user.ipAddress, PermissionGrant_InitiatedBy.app.ipAddress))\n| extend PermissionGrant_InitiatingAccountName = tostring(split(PermissionGrant_InitiatingUserPrincipalName, \"@\")[0]), PermissionGrant_InitiatingAccountUPNSuffix = tostring(split(PermissionGrant_InitiatingUserPrincipalName, \"@\")[1])\n| extend RoleAssignment_InitiatingUserPrincipalName = tostring(RoleAssignment_InitiatedBy.user.userPrincipalName)\n| extend RoleAssignment_InitiatingAadUserId = tostring(RoleAssignment_InitiatedBy.user.id)\n| extend RoleAssignment_InitiatingIpAddress = tostring(iff(isnotempty(RoleAssignment_InitiatedBy.user.ipAddress), RoleAssignment_InitiatedBy.user.ipAddress, RoleAssignment_InitiatedBy.app.ipAddress))\n| extend RoleAssignment_InitiatingAccountName = tostring(split(RoleAssignment_InitiatingUserPrincipalName, \"@\")[0]),  RoleAssignment_InitiatingAccountUPNSuffix = tostring(split(RoleAssignment_InitiatingUserPrincipalName, \"@\")[1])\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT2H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "PrivilegeEscalation",
                                  "Persistence"
                                ],
                                "subTechniques": [
                                  "T1098.003",
                                  "T1078.004"
                                ],
                                "techniques": [
                                  "T1098",
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "AppDisplayName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "AppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Target",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "TargetName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "TargetUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "PermissionGrant_InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "PermissionGrant_InitiatingAccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "PermissionGrant_InitiatingAccountUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "PermissionGrant_InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "RoleAssignment_InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "RoleAssignment_InitiatingAccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "RoleAssignment_InitiatingAccountUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "RoleAssignment_InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject5').analyticRuleId5,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 5",
                                "parentId": "[variables('analyticRuleObject5').analyticRuleId5]",
                                "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject5').analyticRuleVersion5]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Admin promotion after Role Management Application Permission Grant",
                        "contentProductId": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
                        "id": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
                        "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject6').analyticRuleTemplateSpecName6]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AnomalousUserAppSigninLocationIncrease-detection_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject6').analyticRuleVersion6]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This query over Microsoft Entra ID sign-in considers all user sign-ins for each Microsoft Entra ID application and picks out the most anomalous change in location profile for a user within an individual application",
                                "displayName": "Anomalous sign-in location by user account and authenticating application",
                                "enabled": false,
                                "query": "// Adjust this figure to adjust how sensitive this detection is\nlet sensitivity = 2.5;\n// Adjust this figure to set the value that defines the requested estimation accuracy. The default value is 1. Possible values are 0, 1, 2, 3, 4.\nlet dcountAccuracy = 1;\nlet AuthEvents = materialize(\nunion isfuzzy=True SigninLogs, AADNonInteractiveUserSignInLogs\n| where TimeGenerated between (ago(7d) .. now())\n| where ResultType == 0\n| extend LocationDetails = LocationDetails_dynamic\n| extend Location = strcat(LocationDetails.countryOrRegion, \"-\", LocationDetails.state,\"-\", LocationDetails.city)\n| where Location != \"--\");\nAuthEvents\n| summarize dcount(Location, dcountAccuracy) by AppDisplayName, AppId, UserPrincipalName, UserId, bin(startofday(TimeGenerated), 1d)\n| where dcount_Location > 2\n| make-series CountOfLocations = sum(dcount_Location) on TimeGenerated  step 1d by AppId, UserId\n| extend (Anomalies, Score, Baseline) = series_decompose_anomalies(CountOfLocations, sensitivity, -1, 'linefit')\n| mv-expand CountOfLocations to typeof(double), TimeGenerated to typeof(datetime), Anomalies to typeof(double), Score to typeof(double), Baseline to typeof(long)\n| where Anomalies > 0 and Baseline > 0\n| join kind=inner( AuthEvents | extend TimeStamp = startofday(TimeGenerated)) on UserId, AppId\n| extend SignInDetails = bag_pack(\"TimeGenerated\", TimeGenerated1, \"Location\", Location, \"Source\", IPAddress, \"Device\", DeviceDetail_dynamic)\n| summarize SignInDetailsSet=make_set(SignInDetails, 1000) by UserId, UserPrincipalName, CountOfLocations, TimeGenerated, AppId, AppDisplayName\n| extend Name = split(UserPrincipalName, \"@\")[0], UPNSuffix = split(UserPrincipalName, \"@\")[1]\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P7D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AADNonInteractiveUserSignInLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess"
                                ],
                                "techniques": [
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  }
                                ],
                                "eventGroupingSettings": {
                                  "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                  "Application": "AppDisplayName"
                                },
                                "alertDetailsOverride": {
                                  "alertDisplayNameFormat": "Anomalous sign-in location by {{UserPrincipalName}} to {{AppDisplayName}}",
                                  "alertDescriptionFormat": "This query over Microsoft Entra ID sign-in considers all user sign-ins for each Microsoft Entra ID application and picks out the most anomalous change in location profile for a user within an\nindividual application. This has detected {{UserPrincipalName}} signing into {{AppDisplayName}} from {{CountOfLocations}} \ndifferent locations.\n"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject6').analyticRuleId6,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 6",
                                "parentId": "[variables('analyticRuleObject6').analyticRuleId6]",
                                "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject6').analyticRuleVersion6]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Anomalous sign-in location by user account and authenticating application",
                        "contentProductId": "[variables('analyticRuleObject6')._analyticRulecontentProductId6]",
                        "id": "[variables('analyticRuleObject6')._analyticRulecontentProductId6]",
                        "version": "[variables('analyticRuleObject6').analyticRuleVersion6]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject7').analyticRuleTemplateSpecName7]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AuthenticationMethodsChangedforPrivilegedAccount_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject7').analyticRuleVersion7]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies authentication methods being changed for a privileged account. This could be an indication of an attacker adding an auth method to the account so they can have continued access.\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-accounts#things-to-monitor-1",
                                "displayName": "Authentication Methods Changed for Privileged Account",
                                "enabled": false,
                                "query": "let queryperiod = 14d;\nlet queryfrequency = 2h;\nlet security_info_actions = dynamic([\"User registered security info\", \"User changed default security info\", \"User deleted security info\", \"Admin updated security info\", \"User reviewed security info\", \"Admin deleted security info\", \"Admin registered security info\"]);\nlet VIPUsers = (\n    IdentityInfo\n    | where TimeGenerated > ago(queryperiod)\n    | mv-expand AssignedRoles\n    | where AssignedRoles contains 'Admin'\n    | summarize by AccountUPN);\nAuditLogs\n| where TimeGenerated > ago(queryfrequency)\n| where Category =~ \"UserManagement\"\n| where ActivityDisplayName in (security_info_actions)\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"User\"\n      | extend TargetUserPrincipalName = tostring(TargetResource.userPrincipalName)\n  )\n| where TargetUserPrincipalName in~ (VIPUsers)\n// Uncomment the line below if you are experiencing high volumes of Target entities. If this is uncommented, the Target column will not be mapped to an entity.\n//| summarize Start=min(TimeGenerated), End=max(TimeGenerated), Actions = make_set(ResultReason, MaxSize=8), Targets=make_set(Target, MaxSize=256) by Initiator, IP, Result\n// Comment out this line below, if line above is used.\n| summarize Start=min(TimeGenerated), End=max(TimeGenerated), Actions = make_set(ResultReason, MaxSize=8) by InitiatingAppName, InitiatingAppServicePrincipalId, \nInitiatingUserPrincipalName, InitiatingAadUserId, InitiatingIpAddress, TargetUserPrincipalName, Result\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1]), \nTargetName = iff(tostring(TargetUserPrincipalName) has \"[\", \"\", tostring(split(TargetUserPrincipalName,'@',0)[0])), TargetUPNSuffix = iff(tostring(TargetUserPrincipalName) has \"[\", \"\", tostring(split(TargetUserPrincipalName,'@',1)[0]))\n",
                                "queryFrequency": "PT2H",
                                "queryPeriod": "P14D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "BehaviorAnalytics",
                                    "dataTypes": [
                                      "IdentityInfo"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Persistence"
                                ],
                                "techniques": [
                                  "T1098"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatingAccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAccountUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject7').analyticRuleId7,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 7",
                                "parentId": "[variables('analyticRuleObject7').analyticRuleId7]",
                                "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject7').analyticRuleVersion7]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Authentication Methods Changed for Privileged Account",
                        "contentProductId": "[variables('analyticRuleObject7')._analyticRulecontentProductId7]",
                        "id": "[variables('analyticRuleObject7')._analyticRulecontentProductId7]",
                        "version": "[variables('analyticRuleObject7').analyticRuleVersion7]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject8').analyticRuleTemplateSpecName8]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AzureAADPowerShellAnomaly_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject8').analyticRuleVersion8]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This will alert when a user or application signs in using Microsoft Entra ID PowerShell to access non-Active Directory resources, such as the Azure Key Vault, which may be undesired or unauthorized behavior.\nFor capabilities and expected behavior of the Microsoft Entra ID PowerShell module, see: https://docs.microsoft.com/powershell/module/azuread/?view=azureadps-2.0.\nFor further information on Microsoft Entra ID Signin activity reports, see: https://docs.microsoft.com/azure/active-directory/reports-monitoring/concept-sign-ins.",
                                "displayName": "Microsoft Entra ID PowerShell accessing non-Entra ID resources",
                                "enabled": false,
                                "query": "let aadFunc = (tableName:string){\ntable(tableName)\n| where AppId =~ \"1b730954-1685-4b74-9bfd-dac224a7b894\" // AppDisplayName IS Azure Active Directory PowerShell\n| where TokenIssuerType =~ \"AzureAD\"\n| where ResourceIdentity !in (\"00000002-0000-0000-c000-000000000000\", \"00000003-0000-0000-c000-000000000000\") // ResourceDisplayName IS NOT Windows Azure Active Directory OR Microsoft Graph\n| extend Status = todynamic(Status)\n| where Status.errorCode == 0 // Success\n| project-reorder IPAddress, UserAgent, ResourceDisplayName, UserDisplayName, UserId, UserPrincipalName, Type\n| order by TimeGenerated desc\n| extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\n};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nunion isfuzzy=true aadSignin, aadNonInt\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AADNonInteractiveUserSignInLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess"
                                ],
                                "techniques": [
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject8').analyticRuleId8,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 8",
                                "parentId": "[variables('analyticRuleObject8').analyticRuleId8]",
                                "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject8').analyticRuleVersion8]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Microsoft Entra ID PowerShell accessing non-Entra ID resources",
                        "contentProductId": "[variables('analyticRuleObject8')._analyticRulecontentProductId8]",
                        "id": "[variables('analyticRuleObject8')._analyticRulecontentProductId8]",
                        "version": "[variables('analyticRuleObject8').analyticRuleVersion8]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject9').analyticRuleTemplateSpecName9]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AzureADRoleManagementPermissionGrant_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject9').analyticRuleVersion9]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies when the Microsoft Graph RoleManagement.ReadWrite.Directory (Delegated or Application) permission is granted to a service principal.\nThis permission allows an application to read and manage the role-based access control (RBAC) settings for your company's directory.\nAn adversary could use this permission to add an Microsoft Entra ID object to an Admin directory role and escalate privileges.\nRef : https://docs.microsoft.com/graph/permissions-reference#role-management-permissions\nRef : https://docs.microsoft.com/graph/api/directoryrole-post-members?view=graph-rest-1.0&tabs=http",
                                "displayName": "Microsoft Entra ID Role Management Permission Grant",
                                "enabled": false,
                                "query": "AuditLogs\n| where Category =~ \"ApplicationManagement\" and LoggedByService =~ \"Core Directory\" and OperationName in~ (\"Add delegated permission grant\", \"Add app role assignment to service principal\")\n| mv-apply TargetResource = TargetResources on\n  (\n      where TargetResource.type =~ \"ServicePrincipal\" and array_length(TargetResource.modifiedProperties) > 0 and isnotnull(TargetResource.displayName)\n      | extend props = TargetResource.modifiedProperties\n  )\n| mv-apply Property = props on\n  (\n      where Property.displayName in~ (\"AppRole.Value\",\"DelegatedPermissionGrant.Scope\")\n      | extend DisplayName = tostring(Property.displayName), PermissionGrant = trim('\"',tostring(Property.newValue))\n  )\n| where PermissionGrant has \"RoleManagement.ReadWrite.Directory\"\n| mv-apply Property = props on\n  (\n      where Property.displayName =~ \"ServicePrincipal.DisplayName\"\n      | extend TargetAppDisplayName = trim('\"',tostring(Property.newValue))\n  )\n| mv-apply Property = props on\n  (\n      where Property.displayName =~ \"ServicePrincipal.ObjectID\"\n      | extend TargetAppServicePrincipalId = trim('\"',tostring(Property.newValue))\n  )\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| project TimeGenerated, OperationName, Result, PermissionGrant, TargetAppDisplayName, TargetAppServicePrincipalId, InitiatingAppName, InitiatingAppServicePrincipalId,\nInitiatingUserPrincipalName, InitiatingAadUserId, InitiatingIpAddress, TargetResources, AdditionalDetails, CorrelationId\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n",
                                "queryFrequency": "PT2H",
                                "queryPeriod": "PT2H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Persistence",
                                  "Impact"
                                ],
                                "subTechniques": [
                                  "T1098.003",
                                  "T1078.004"
                                ],
                                "techniques": [
                                  "T1098",
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "TargetAppDisplayName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "TargetAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatingAccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAccountUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject9').analyticRuleId9,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 9",
                                "parentId": "[variables('analyticRuleObject9').analyticRuleId9]",
                                "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject9').analyticRuleVersion9]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Microsoft Entra ID Role Management Permission Grant",
                        "contentProductId": "[variables('analyticRuleObject9')._analyticRulecontentProductId9]",
                        "id": "[variables('analyticRuleObject9')._analyticRulecontentProductId9]",
                        "version": "[variables('analyticRuleObject9').analyticRuleVersion9]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject10').analyticRuleTemplateSpecName10]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AzurePortalSigninfromanotherAzureTenant_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject10').analyticRuleVersion10]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This query looks for successful sign in attempts to the Azure Portal where the user who is signing in from another Azure tenant, and the IP address the login attempt is from is an Azure IP. A threat actor who compromises an Azure tenant may look to pivot to other tenants leveraging cross-tenant delegated access in this manner.",
                                "displayName": "Azure Portal sign in from another Azure Tenant",
                                "enabled": false,
                                "query": "// Get details of current Azure Ranges (note this URL updates regularly so will need to be manually updated over time)\n// You may find the name of the new JSON here: https://www.microsoft.com/download/details.aspx?id=56519\n// On the downloads page, click the 'details' button, and then replace just the filename in the URL below\nlet azure_ranges = externaldata(changeNumber: string, cloud: string, values: dynamic)\n[\"https://raw.githubusercontent.com/microsoft/mstic/master/PublicFeeds/MSFTIPRanges/ServiceTags_Public.json\"] with(format='multijson')\n| mv-expand values\n| mv-expand values.properties.addressPrefixes\n| mv-expand values_properties_addressPrefixes\n| summarize by tostring(values_properties_addressPrefixes)\n| extend isipv4 = parse_ipv4(values_properties_addressPrefixes)\n| extend isipv6 = parse_ipv6(values_properties_addressPrefixes)\n| extend ip_type = case(isnotnull(isipv4), \"v4\", \"v6\")\n| summarize make_list(values_properties_addressPrefixes) by ip_type\n;\nSigninLogs\n// Limiting to Azure Portal really reduces false positives and helps focus on potential admin activity\n| where ResultType == 0\n| where AppDisplayName =~ \"Azure Portal\"\n| extend isipv4 = parse_ipv4(IPAddress)\n| extend ip_type = case(isnotnull(isipv4), \"v4\", \"v6\")\n // Only get logons where the IP address is in an Azure range\n| join kind=fullouter (azure_ranges) on ip_type\n| extend ipv6_match = ipv6_is_in_any_range(IPAddress,  list_values_properties_addressPrefixes)\n| extend ipv4_match = ipv4_is_in_any_range(IPAddress,  list_values_properties_addressPrefixes)\n| where ipv4_match or ipv6_match \n// Limit to where the user is external to the tenant\n| where HomeTenantId != ResourceTenantId\n// Further limit it to just access to the current tenant (you can drop this if you wanted to look elsewhere as well but it helps reduce FPs)\n| where ResourceTenantId == AADTenantId\n| summarize FirstSeen = min(TimeGenerated), LastSeen = max(TimeGenerated), make_set(ResourceDisplayName) by UserPrincipalName, IPAddress, UserAgent, Location, HomeTenantId, ResourceTenantId, UserId\n| extend AccountName = split(UserPrincipalName, \"@\")[0]\n| extend UPNSuffix = split(UserPrincipalName, \"@\")[1]\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess"
                                ],
                                "techniques": [
                                  "T1199"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "AccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ],
                                "alertDetailsOverride": {
                                  "alertDisplayNameFormat": "Azure Portal sign in by {{UserPrincipalName}} from another Azure Tenant with IP Address {{IPAddress}}",
                                  "alertDescriptionFormat": "This query looks for successful sign in attempts to the Azure Portal where the user who is signing in from another Azure tenant,\nand the IP address the login attempt is from is an Azure IP. A threat actor who compromises an Azure tenant may look\nto pivot to other tenants leveraging cross-tenant delegated access in this manner.\nIn this instance {{UserPrincipalName}} logged in at {{FirstSeen}} from IP Address {{IPAddress}}.\n"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject10').analyticRuleId10,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 10",
                                "parentId": "[variables('analyticRuleObject10').analyticRuleId10]",
                                "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject10').analyticRuleVersion10]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Azure Portal sign in from another Azure Tenant",
                        "contentProductId": "[variables('analyticRuleObject10')._analyticRulecontentProductId10]",
                        "id": "[variables('analyticRuleObject10')._analyticRulecontentProductId10]",
                        "version": "[variables('analyticRuleObject10').analyticRuleVersion10]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject11').analyticRuleTemplateSpecName11]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Brute Force Attack against GitHub Account_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject11').analyticRuleVersion11]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Attackers who are trying to guess your users' passwords or use brute-force methods to get in. If your organization is using SSO with Microsoft Entra ID, authentication logs to GitHub.com will be generated. Using the following query can help you identify a sudden increase in failed logon attempt of users.",
                                "displayName": "Brute Force Attack against GitHub Account",
                                "enabled": false,
                                "query": "let LearningPeriod = 7d;\nlet BinTime = 1h;\nlet RunTime = 1h;\nlet StartTime = 1h;  \nlet sensitivity = 2.5;\nlet EndRunTime = StartTime - RunTime;\nlet EndLearningTime = StartTime + LearningPeriod;\nlet aadFunc = (tableName:string){\ntable(tableName)  \n| where TimeGenerated between (ago(EndLearningTime) .. ago(EndRunTime))\n| where AppDisplayName =~ \"GitHub.com\"\n| where ResultType != 0\n| make-series FailedLogins = count() on TimeGenerated from ago(LearningPeriod) to ago(EndRunTime) step BinTime by UserPrincipalName, Type\n| extend (Anomalies, Score, Baseline) = series_decompose_anomalies(FailedLogins, sensitivity, -1, 'linefit')\n| mv-expand FailedLogins to typeof(double), TimeGenerated to typeof(datetime), Anomalies to typeof(double), Score to typeof(double), Baseline to typeof(long)  \n| where TimeGenerated >= ago(RunTime)\n| where Anomalies > 0 and Baseline > 0\n| join kind=inner (\n          table(tableName)  \n          | where TimeGenerated between (ago(StartTime) .. ago(EndRunTime))\n          | where AppDisplayName =~ \"GitHub.com\"\n          | where ResultType != 0\n          | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), IPAddresses = make_set(IPAddress,100), Locations = make_set(LocationDetails,20), Devices = make_set(DeviceDetail,20) by UserPrincipalName, UserId, AppDisplayName\n      ) on UserPrincipalName\n| project-away UserPrincipalName1\n| extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\n| extend IPAddressFirst = tostring(IPAddresses[0])\n};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nunion isfuzzy=true aadSignin, aadNonInt\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P7D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AADNonInteractiveUserSignInLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess"
                                ],
                                "techniques": [
                                  "T1110"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddressFirst",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject11').analyticRuleId11,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 11",
                                "parentId": "[variables('analyticRuleObject11').analyticRuleId11]",
                                "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject11').analyticRuleVersion11]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Brute Force Attack against GitHub Account",
                        "contentProductId": "[variables('analyticRuleObject11')._analyticRulecontentProductId11]",
                        "id": "[variables('analyticRuleObject11')._analyticRulecontentProductId11]",
                        "version": "[variables('analyticRuleObject11').analyticRuleVersion11]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject12').analyticRuleTemplateSpecName12]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "BruteForceCloudPC_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject12').analyticRuleVersion12]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies evidence of brute force activity against a Windows 365 Cloud PC by highlighting multiple authentication failures and by a successful authentication within a given time window.",
                                "displayName": "Brute force attack against a Cloud PC",
                                "enabled": false,
                                "query": "let authenticationWindow = 20m;\nlet sensitivity = 2.5;\nSigninLogs\n| where AppDisplayName =~ \"Windows Sign In\"\n| extend FailureOrSuccess = iff(ResultType in (\"0\", \"50125\", \"50140\", \"70043\", \"70044\"), \"Success\", \"Failure\")\n| summarize FailureCount = countif(FailureOrSuccess==\"Failure\"), SuccessCount = countif(FailureOrSuccess==\"Success\"), IPAddresses = make_set(IPAddress,1000)\n                          by bin(TimeGenerated, authenticationWindow), UserDisplayName, UserPrincipalName\n| extend FailureSuccessDiff = FailureCount - SuccessCount\n| where FailureSuccessDiff > 0\n| summarize Diff = make_list(FailureSuccessDiff, 10000), TimeStamp = make_list(TimeGenerated, 10000) by UserDisplayName, UserPrincipalName//, tostring(IPAddresses)\n| extend (Anomalies, Score, Baseline) = series_decompose_anomalies(Diff, sensitivity, -1, 'linefit')  \n| mv-expand Diff to typeof(double), TimeStamp to typeof(datetime), Anomalies to typeof(double), Score to typeof(double), Baseline to typeof(long)\n| where Anomalies > 0\n| summarize by UserDisplayName, UserPrincipalName, Anomalies, Score, Baseline, FailureToSuccessDiff = Diff\n| join kind=leftouter (\n      SigninLogs\n      | where AppDisplayName =~ \"Windows Sign In\"\n      | extend OS = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser\n      | extend StatusCode = tostring(Status.errorCode), StatusDetails = tostring(Status.additionalDetails)\n      | extend State = tostring(LocationDetails.state), City = tostring(LocationDetails.city)\n      | summarize StartTime = min(TimeGenerated), \n                  EndTime = max(TimeGenerated), \n                  IPAddresses = make_set(IPAddress,100), \n                  OS = make_set(OS,20), \n                  Browser = make_set(Browser,20), \n                  City = make_set(City,100), \n                  ResultType = make_set(ResultType,100)\n              by UserDisplayName, UserPrincipalName, UserId, AppDisplayName\n  ) on UserDisplayName, UserPrincipalName\n| project-away UserDisplayName1, UserPrincipalName1\n| extend IPAddressFirst = tostring(IPAddresses[0])\n| extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess"
                                ],
                                "techniques": [
                                  "T1110"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddressFirst",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject12').analyticRuleId12,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 12",
                                "parentId": "[variables('analyticRuleObject12').analyticRuleId12]",
                                "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject12').analyticRuleVersion12]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Brute force attack against a Cloud PC",
                        "contentProductId": "[variables('analyticRuleObject12')._analyticRulecontentProductId12]",
                        "id": "[variables('analyticRuleObject12')._analyticRulecontentProductId12]",
                        "version": "[variables('analyticRuleObject12').analyticRuleVersion12]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject13').analyticRuleTemplateSpecName13]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "BulkChangestoPrivilegedAccountPermissions_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject13').analyticRuleVersion13]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies when changes to multiple users permissions are changed at once. Investigate immediately if not a planned change. This setting could enable an attacker access to Azure subscriptions in your environment.\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-identity-management",
                                "displayName": "Bulk Changes to Privileged Account Permissions",
                                "enabled": false,
                                "query": "let AdminRecords = AuditLogs\n| where Category =~ \"RoleManagement\"\n| where ActivityDisplayName has_any (\"Add eligible member to role\", \"Add member to role\")\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"User\"\n      | extend TargetUserPrincipalName = tostring(TargetResource.userPrincipalName),\n               props = TargetResource.modifiedProperties\n  )\n| mv-apply Property = props on \n  (\n      where Property.displayName =~ \"Role.DisplayName\"\n      | extend RoleName = trim('\"',tostring(Property.newValue))\n  )\n| where RoleName contains \"Admin\";\nAdminRecords\n| summarize dcount(TargetUserPrincipalName) by bin(TimeGenerated, 1h)\n| where dcount_TargetUserPrincipalName > 9\n| join kind=rightsemi  (\n  AdminRecords\n  | extend TimeWindow = bin(TimeGenerated, 1h)\n) on $left.TimeGenerated == $right.TimeWindow\n| extend InitiatedByUser = iff(isnotempty(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.user.userPrincipalName), \"\")\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend TargetName = tostring(split(TargetUserPrincipalName,'@',0)[0]), TargetUPNSuffix = tostring(split(TargetUserPrincipalName,'@',1)[0])\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n",
                                "queryFrequency": "PT2H",
                                "queryPeriod": "PT2H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "PrivilegeEscalation"
                                ],
                                "subTechniques": [
                                  "T1078.004"
                                ],
                                "techniques": [
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "TargetUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "TargetName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "TargetUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatingAccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAccountUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ],
                                "customDetails": {
                                  "TargetUser": "TargetUserPrincipalName",
                                  "InitiatedByUser": "InitiatedByUser"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject13').analyticRuleId13,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 13",
                                "parentId": "[variables('analyticRuleObject13').analyticRuleId13]",
                                "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject13').analyticRuleVersion13]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Bulk Changes to Privileged Account Permissions",
                        "contentProductId": "[variables('analyticRuleObject13')._analyticRulecontentProductId13]",
                        "id": "[variables('analyticRuleObject13')._analyticRulecontentProductId13]",
                        "version": "[variables('analyticRuleObject13').analyticRuleVersion13]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject14').analyticRuleTemplateSpecName14]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "BypassCondAccessRule_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject14').analyticRuleVersion14]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies an attempt to Bypass conditional access rule(s) in Microsoft Entra ID.\nThe ConditionalAccessStatus column value details if there was an attempt to bypass Conditional Access or if the Conditional access rule was not satisfied (ConditionalAccessStatus == 1).\nReferences:\nhttps://docs.microsoft.com/azure/active-directory/conditional-access/overview\nhttps://docs.microsoft.com/azure/active-directory/reports-monitoring/concept-sign-ins\nhttps://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-sign-ins-error-codes\nConditionalAccessStatus == 0 // Success\nConditionalAccessStatus == 1 // Failure\nConditionalAccessStatus == 2 // Not Applied\nConditionalAccessStatus == 3 // unknown",
                                "displayName": "Attempt to bypass conditional access rule in Microsoft Entra ID",
                                "enabled": false,
                                "query": "let threshold = 1; // Modify this threshold value to reduce false positives based on your environment\nlet aadFunc = (tableName:string){\ntable(tableName)\n| where ConditionalAccessStatus == 1 or ConditionalAccessStatus =~ \"failure\"\n| mv-apply CAP = parse_json(ConditionalAccessPolicies) on (\n  project ConditionalAccessPoliciesName = CAP.displayName, result = CAP.result\n  | where result =~ \"failure\"\n)\n| extend DeviceDetail = todynamic(DeviceDetail), Status = todynamic(Status), LocationDetails = todynamic(LocationDetails)\n| extend OS = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser\n| extend State = tostring(LocationDetails.state), City = tostring(LocationDetails.city), Region = tostring(LocationDetails.countryOrRegion)\n| extend StatusCode = tostring(Status.errorCode), StatusDetails = tostring(Status.additionalDetails)\n| extend Status = strcat(StatusCode, \": \", ResultDescription)\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), Status = make_list(Status,10), StatusDetails = make_list(StatusDetails,50), IPAddresses = make_list(IPAddress,100), IPAddressCount = dcount(IPAddress), CorrelationIds = make_list(CorrelationId,100), ConditionalAccessPoliciesName = make_list(ConditionalAccessPoliciesName,100)\nby UserPrincipalName, UserId, AppDisplayName, tostring(Browser), tostring(OS), City, State, Region, Type\n| where IPAddressCount > threshold and StatusDetails !has \"MFA successfully completed\"\n| mv-expand IPAddresses, Status, StatusDetails, CorrelationIds\n| extend Status = strcat(Status, \" \", StatusDetails)\n| summarize IPAddresses = make_set(IPAddresses,100), Status = make_set(Status,10), CorrelationIds = make_set(CorrelationIds,100), ConditionalAccessPoliciesName = make_set(ConditionalAccessPoliciesName,100)\nby StartTime, EndTime, UserPrincipalName, UserId, AppDisplayName, tostring(Browser), tostring(OS), City, State, Region, IPAddressCount, Type\n| extend IPAddressFirst = tostring(IPAddresses[0]), Name = tostring(split(UserPrincipalName, \"@\")[0]), UPNSuffix = tostring(split(UserPrincipalName, \"@\")[1])\n};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nunion isfuzzy=true aadSignin, aadNonInt\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AADNonInteractiveUserSignInLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess",
                                  "Persistence"
                                ],
                                "techniques": [
                                  "T1078",
                                  "T1098"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddressFirst",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject14').analyticRuleId14,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 14",
                                "parentId": "[variables('analyticRuleObject14').analyticRuleId14]",
                                "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject14').analyticRuleVersion14]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Attempt to bypass conditional access rule in Microsoft Entra ID",
                        "contentProductId": "[variables('analyticRuleObject14')._analyticRulecontentProductId14]",
                        "id": "[variables('analyticRuleObject14')._analyticRulecontentProductId14]",
                        "version": "[variables('analyticRuleObject14').analyticRuleVersion14]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject15').analyticRuleTemplateSpecName15]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "CredentialAddedAfterAdminConsent_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject15').analyticRuleVersion15]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject15')._analyticRulecontentId15]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This query will identify instances where Service Principal credentials were added to an application by one user after the application was granted admin consent rights by another user.\n If a threat actor obtains access to an account with sufficient privileges and adds the alternate authentication material triggering this event, the threat actor can now authenticate as the Application or Service Principal using this credential.\n Additional information on OAuth Credential Grants can be found in RFC 6749 Section 4.4 or https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow.\n For further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities",
                                "displayName": "Credential added after admin consented to Application",
                                "enabled": false,
                                "query": "let auditLookbackStart = 2d;\nlet auditLookbackEnd = 1d;\nAuditLogs\n| where TimeGenerated >= ago(auditLookbackStart)\n| where OperationName =~ \"Consent to application\" \n| where Result =~ \"success\"\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"ServicePrincipal\"\n      | extend targetResourceName = tostring(TargetResource.displayName),\n               targetResourceID = tostring(TargetResource.id),\n               targetResourceType = tostring(TargetResource.type),\n               targetModifiedProp = TargetResource.modifiedProperties\n  )\n| mv-apply Property = targetModifiedProp on \n  (\n      where Property.displayName =~ \"ConsentContext.IsAdminConsent\"\n      | extend isAdminConsent = trim(@'\"',tostring(Property.newValue))\n  )\n| mv-apply Property = targetModifiedProp on \n  (\n      where Property.displayName =~ \"ConsentAction.Permissions\"\n      | extend Consent_TargetPermissions = trim(@'\"',tostring(Property.newValue))\n  )\n| mv-apply Property = targetModifiedProp on \n  (\n      where Property.displayName =~ \"TargetId.ServicePrincipalNames\"\n      | extend Consent_TargetServicePrincipalNames = tostring(extract_all(@\"([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})\",trim(@'\"',tostring(Property.newValue)))[0])\n  )\n| extend Consent_InitiatingUserOrApp = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| extend Consent_InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend Consent_InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend Consent_InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend Consent_InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend Consent_InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| join kind=inner ( \nAuditLogs\n| where TimeGenerated  >= ago(auditLookbackEnd)\n| where OperationName =~ \"Add service principal credentials\"\n| where Result =~ \"success\"\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"ServicePrincipal\"\n      | extend targetResourceName = tostring(TargetResource.displayName),\n               targetResourceID = tostring(TargetResource.id),\n               targetModifiedProp = TargetResource.modifiedProperties\n  )\n| mv-apply Property = targetModifiedProp on \n  (\n      where Property.displayName =~ \"KeyDescription\"\n      | extend Credential_TargetKeyDescription = trim(@'\"',tostring(Property.newValue))\n  )\n| mv-apply Property = targetModifiedProp on \n  (\n      where Property.displayName =~ \"Included Updated Properties\"\n      | extend UpdatedProperties = trim(@'\"',tostring(Property.newValue))\n  )\n| mv-apply Property = targetModifiedProp on \n  (\n      where Property.displayName =~ \"TargetId.ServicePrincipalNames\"\n      | extend Credential_TargetServicePrincipalNames = tostring(extract_all(@\"([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})\",trim(@'\"',tostring(Property.newValue)))[0])\n  )\n| extend Credential_InitiatingUserOrApp = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| extend Credential_InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend Credential_InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend Credential_InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend Credential_InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend Credential_InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n) on targetResourceName, targetResourceID\n| extend TimeConsent = TimeGenerated, TimeCred = TimeGenerated1\n| where TimeConsent < TimeCred \n| project TimeConsent, TimeCred, targetResourceName, targetResourceType, isAdminConsent, \nConsent_InitiatingUserOrApp, Consent_TargetServicePrincipalNames, Consent_TargetPermissions,\nConsent_InitiatingAppName, Consent_InitiatingAppServicePrincipalId, Consent_InitiatingUserPrincipalName, Consent_InitiatingAadUserId, Consent_InitiatingIpAddress,\nCredential_InitiatingUserOrApp, Credential_TargetServicePrincipalNames, Credential_TargetKeyDescription,\nCredential_InitiatingAppName, Credential_InitiatingAppServicePrincipalId, Credential_InitiatingUserPrincipalName, Credential_InitiatingAadUserId, Credential_InitiatingIpAddress\n| extend Consent_AccountName = tostring(split(Consent_InitiatingUserPrincipalName, \"@\")[0]), Consent_UPNSuffix = tostring(split(Consent_InitiatingUserPrincipalName, \"@\")[1])\n| extend Credential_AccountName = tostring(split(Credential_InitiatingUserPrincipalName, \"@\")[0]), Credential_UPNSuffix = tostring(split(Credential_InitiatingUserPrincipalName, \"@\")[1])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P2D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess",
                                  "Persistence",
                                  "PrivilegeEscalation"
                                ],
                                "techniques": [
                                  "T1555",
                                  "T1098"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Consent_InitiatingAppName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "Consent_InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Credential_InitiatingAppName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "Credential_InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Consent_InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Consent_AccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "Consent_UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Consent_InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Credential_InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Credential_AccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "Credential_UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Credential_InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Consent_InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Credential_InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject15').analyticRuleId15,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 15",
                                "parentId": "[variables('analyticRuleObject15').analyticRuleId15]",
                                "contentId": "[variables('analyticRuleObject15')._analyticRulecontentId15]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject15').analyticRuleVersion15]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject15')._analyticRulecontentId15]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Credential added after admin consented to Application",
                        "contentProductId": "[variables('analyticRuleObject15')._analyticRulecontentProductId15]",
                        "id": "[variables('analyticRuleObject15')._analyticRulecontentProductId15]",
                        "version": "[variables('analyticRuleObject15').analyticRuleVersion15]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject16').analyticRuleTemplateSpecName16]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Cross-tenantAccessSettingsOrganizationAdded_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject16').analyticRuleVersion16]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject16')._analyticRulecontentId16]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Organizations are added in the Cross-tenant Access Settings to control communication inbound or outbound for users and applications. This detection notifies when an Organization is added other than the list that is supposed to exist from the Microsoft Entra ID Cross-tenant Access Settings.",
                                "displayName": "Cross-tenant Access Settings Organization Added",
                                "enabled": false,
                                "query": "// Tenants IDs can be found by navigating to Azure Active Directory then from menu on the left, select External Identities, then from menu on the left, select Cross-tenant access settings and from the list shown of Tenants\nlet ExpectedTenantIDs = dynamic([\"List of expected tenant IDs\",\"Tenant ID 2\"]);\nAuditLogs\n| where OperationName has \"Add a partner to cross-tenant access setting\"\n| mv-apply TargetResource = TargetResources on\n  (\n      where TargetResource.type =~ \"Policy\"\n      | extend Properties = TargetResource.modifiedProperties\n  )\n| mv-apply Property = Properties on\n  (\n      where Property.displayName =~ \"tenantId\"\n      | extend ExtTenantIDAdded = trim('\"',tostring(Property.newValue))\n  )\n| where ExtTenantIDAdded !in (ExpectedTenantIDs)\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n",
                                "queryFrequency": "P2D",
                                "queryPeriod": "P2D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess",
                                  "Persistence",
                                  "Discovery"
                                ],
                                "subTechniques": [
                                  "T1078.004",
                                  "T1136.003",
                                  "T1087.004"
                                ],
                                "techniques": [
                                  "T1078",
                                  "T1136",
                                  "T1087"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatingAccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAccountUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject16').analyticRuleId16,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 16",
                                "parentId": "[variables('analyticRuleObject16').analyticRuleId16]",
                                "contentId": "[variables('analyticRuleObject16')._analyticRulecontentId16]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject16').analyticRuleVersion16]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject16')._analyticRulecontentId16]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Cross-tenant Access Settings Organization Added",
                        "contentProductId": "[variables('analyticRuleObject16')._analyticRulecontentProductId16]",
                        "id": "[variables('analyticRuleObject16')._analyticRulecontentProductId16]",
                        "version": "[variables('analyticRuleObject16').analyticRuleVersion16]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject17').analyticRuleTemplateSpecName17]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Cross-tenantAccessSettingsOrganizationDeleted_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject17').analyticRuleVersion17]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject17')._analyticRulecontentId17]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Organizations are added in the Cross-tenant Access Settings to control communication inbound or outbound for users and applications. This detection notifies when an Organization is deleted from the Microsoft Entra ID Cross-tenant Access Settings.",
                                "displayName": "Cross-tenant Access Settings Organization Deleted",
                                "enabled": false,
                                "query": "AuditLogs\n| where OperationName has \"Delete partner specific cross-tenant access setting\"\n| mv-apply TargetResource = TargetResources on\n  (\n      where TargetResource.type =~ \"Policy\"\n      | extend Properties = TargetResource.modifiedProperties\n  )\n| mv-apply Property = Properties on\n  (\n      where Property.displayName =~ \"tenantId\"\n      | extend ExtTenantDeleted = trim('\"',tostring(Property.oldValue))\n  )\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n",
                                "queryFrequency": "P2D",
                                "queryPeriod": "P2D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess",
                                  "Persistence",
                                  "Discovery"
                                ],
                                "subTechniques": [
                                  "T1078.004",
                                  "T1136.003",
                                  "T1087.004"
                                ],
                                "techniques": [
                                  "T1078",
                                  "T1136",
                                  "T1087"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatingAccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAccountUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject17').analyticRuleId17,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 17",
                                "parentId": "[variables('analyticRuleObject17').analyticRuleId17]",
                                "contentId": "[variables('analyticRuleObject17')._analyticRulecontentId17]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject17').analyticRuleVersion17]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject17')._analyticRulecontentId17]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Cross-tenant Access Settings Organization Deleted",
                        "contentProductId": "[variables('analyticRuleObject17')._analyticRulecontentProductId17]",
                        "id": "[variables('analyticRuleObject17')._analyticRulecontentProductId17]",
                        "version": "[variables('analyticRuleObject17').analyticRuleVersion17]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject18').analyticRuleTemplateSpecName18]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Cross-tenantAccessSettingsOrganizationInboundCollaborationSettingsChanged_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject18').analyticRuleVersion18]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject18')._analyticRulecontentId18]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Organizations are added in the Cross-tenant Access Settings to control communication inbound or outbound for users and applications. This detection notifies when Organization Inbound Collaboration Settings are changed for \"Users & Groups\" and for \"Applications\".",
                                "displayName": "Cross-tenant Access Settings Organization Inbound Collaboration Settings Changed",
                                "enabled": false,
                                "query": "// In User & Groups and in Applications, the following \"AccessType\" values in columns PremodifiedInboundSettings and ModifiedInboundSettings are interpreted accordingly\n// When Access Type in premodified inbound settings value was 1 that means that the initial access was allowed. When Access Type in premodified inbound settings value was 2 that means that the initial access was blocked.\n// When Access Type in modified inbound settings value is 1 that means that now access is allowed. When Access Type in modified inbound settings value is 2 that means that now access is blocked.\nAuditLogs\n| where OperationName has \"Update a partner cross-tenant access setting\"\n| mv-apply TargetResource = TargetResources on\n  (\n      where TargetResource.type =~ \"Policy\"\n      | extend Properties = TargetResource.modifiedProperties\n  )\n| mv-apply Property = Properties on\n  (\n      where Property.displayName =~ \"b2bCollaborationInbound\"\n      | extend PremodifiedInboundSettings = trim('\"',tostring(Property.oldValue)),\n               ModifiedInboundSettings = trim(@'\"',tostring(Property.newValue))\n  )\n| where PremodifiedInboundSettings != ModifiedInboundSettings\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n",
                                "queryFrequency": "P2D",
                                "queryPeriod": "P2D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess",
                                  "Persistence",
                                  "Discovery"
                                ],
                                "subTechniques": [
                                  "T1078.004",
                                  "T1136.003",
                                  "T1087.004"
                                ],
                                "techniques": [
                                  "T1078",
                                  "T1136",
                                  "T1087"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatingAccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAccountUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject18').analyticRuleId18,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 18",
                                "parentId": "[variables('analyticRuleObject18').analyticRuleId18]",
                                "contentId": "[variables('analyticRuleObject18')._analyticRulecontentId18]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject18').analyticRuleVersion18]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject18')._analyticRulecontentId18]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Cross-tenant Access Settings Organization Inbound Collaboration Settings Changed",
                        "contentProductId": "[variables('analyticRuleObject18')._analyticRulecontentProductId18]",
                        "id": "[variables('analyticRuleObject18')._analyticRulecontentProductId18]",
                        "version": "[variables('analyticRuleObject18').analyticRuleVersion18]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject19').analyticRuleTemplateSpecName19]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Cross-tenantAccessSettingsOrganizationInboundDirectSettingsChanged_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject19').analyticRuleVersion19]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject19')._analyticRulecontentId19]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Organizations are added in the Cross-tenant Access Settings to control communication inbound or outbound for users and applications. This detection notifies when Organization Inbound Direct Settings are changed for \"Users & Groups\" and for \"Applications\".",
                                "displayName": "Cross-tenant Access Settings Organization Inbound Direct Settings Changed",
                                "enabled": false,
                                "query": "// In User & Groups and in Applications, the following \"AccessType\" values in columns PremodifiedInboundSettings and ModifiedInboundSettings are interpreted accordingly\n// When Access Type in premodified inbound settings value was 1 that means that the initial access was allowed. When Access Type in premodified inbound settings value was 2 that means that the initial access was blocked.\n// When Access Type in modified inbound settings value is 1 that means that now access is allowed. When Access Type in modified inbound settings value is 2 that means that now access is blocked.\nAuditLogs\n| where OperationName has \"Update a partner cross-tenant access setting\"\n| mv-apply TargetResource = TargetResources on\n  (\n      where TargetResource.type =~ \"Policy\"\n      | extend Properties = TargetResource.modifiedProperties\n  )\n| mv-apply Property = Properties on\n  (\n      where Property.displayName =~ \"b2bDirectConnectInbound\"\n      | extend PremodifiedInboundSettings = trim('\"',tostring(Property.oldValue)),\n               ModifiedInboundSettings = trim(@'\"',tostring(Property.newValue))\n  )\n| where PremodifiedInboundSettings != ModifiedInboundSettings\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n",
                                "queryFrequency": "P2D",
                                "queryPeriod": "P2D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess",
                                  "Persistence",
                                  "Discovery"
                                ],
                                "subTechniques": [
                                  "T1078.004",
                                  "T1136.003",
                                  "T1087.004"
                                ],
                                "techniques": [
                                  "T1078",
                                  "T1136",
                                  "T1087"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatingAccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAccountUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject19').analyticRuleId19,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 19",
                                "parentId": "[variables('analyticRuleObject19').analyticRuleId19]",
                                "contentId": "[variables('analyticRuleObject19')._analyticRulecontentId19]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject19').analyticRuleVersion19]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject19')._analyticRulecontentId19]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Cross-tenant Access Settings Organization Inbound Direct Settings Changed",
                        "contentProductId": "[variables('analyticRuleObject19')._analyticRulecontentProductId19]",
                        "id": "[variables('analyticRuleObject19')._analyticRulecontentProductId19]",
                        "version": "[variables('analyticRuleObject19').analyticRuleVersion19]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject20').analyticRuleTemplateSpecName20]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Cross-tenantAccessSettingsOrganizationOutboundCollaborationSettingsChanged_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject20').analyticRuleVersion20]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject20')._analyticRulecontentId20]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Organizations are added in the Cross-tenant Access Settings to control communication inbound or outbound for users and applications. This detection notifies when Organization Outbound Collaboration Settings are changed for \"Users & Groups\" and for \"Applications\".",
                                "displayName": "Cross-tenant Access Settings Organization Outbound Collaboration Settings Changed",
                                "enabled": false,
                                "query": "// In User & Groups and in Applications, the following \"AccessType\" values in columns PremodifiedOutboundSettings and ModifiedOutboundSettings are interpreted accordingly\n// When Access Type in premodified outbound settings value was 1 that means that the initial access was allowed. When Access Type in premodified outbound settings value was 2 that means that the initial access was blocked.\n// When Access Type in modified outbound settings value is 1 that means that now access is allowed. When Access Type in modified outbound settings value is 2 that means that now access is blocked.\nAuditLogs\n| where OperationName has \"Update a partner cross-tenant access setting\"\n| mv-apply TargetResource = TargetResources on\n  (\n      where TargetResource.type =~ \"Policy\"\n      | extend Properties = TargetResource.modifiedProperties\n  )\n| mv-apply Property = Properties on\n  (\n      where Property.displayName =~ \"b2bCollaborationOutbound\"\n      | extend PremodifiedOutboundSettings = trim('\"',tostring(Property.oldValue)),\n               ModifiedOutboundSettings = trim(@'\"',tostring(Property.newValue))\n  )\n| where PremodifiedOutboundSettings != ModifiedOutboundSettings\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n",
                                "queryFrequency": "P2D",
                                "queryPeriod": "P2D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess",
                                  "Persistence",
                                  "Discovery"
                                ],
                                "subTechniques": [
                                  "T1078.004",
                                  "T1136.003",
                                  "T1087.004"
                                ],
                                "techniques": [
                                  "T1078",
                                  "T1136",
                                  "T1087"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatingAccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAccountUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject20').analyticRuleId20,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 20",
                                "parentId": "[variables('analyticRuleObject20').analyticRuleId20]",
                                "contentId": "[variables('analyticRuleObject20')._analyticRulecontentId20]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject20').analyticRuleVersion20]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject20')._analyticRulecontentId20]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Cross-tenant Access Settings Organization Outbound Collaboration Settings Changed",
                        "contentProductId": "[variables('analyticRuleObject20')._analyticRulecontentProductId20]",
                        "id": "[variables('analyticRuleObject20')._analyticRulecontentProductId20]",
                        "version": "[variables('analyticRuleObject20').analyticRuleVersion20]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject21').analyticRuleTemplateSpecName21]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Cross-tenantAccessSettingsOrganizationOutboundDirectSettingsChanged_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject21').analyticRuleVersion21]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject21')._analyticRulecontentId21]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Organizations are added in the Cross-tenant Access Settings to control communication inbound or outbound for users and applications. This detection notifies when Organization Outbound Direct Settings are changed for \"Users & Groups\" and for \"Applications\".",
                                "displayName": "Cross-tenant Access Settings Organization Outbound Direct Settings Changed",
                                "enabled": false,
                                "query": "// In User & Groups and in Applications, the following \"AccessType\" values in columns PremodifiedOutboundSettings and ModifiedOutboundSettings are interpreted accordingly\n// When Access Type in premodified outbound settings value was 1 that means that the initial access was allowed. When Access Type in premodified outbound settings value was 2 that means that the initial access was blocked.\n// When Access Type in modified outbound settings value is 1 that means that now access is allowed. When Access Type in modified outbound settings value is 2 that means that now access is blocked.\nAuditLogs\n| where OperationName has \"Update a partner cross-tenant access setting\"\n| mv-apply TargetResource = TargetResources on\n  (\n      where TargetResource.type =~ \"Policy\"\n      | extend Properties = TargetResource.modifiedProperties\n  )\n| mv-apply Property = Properties on\n  (\n      where Property.displayName =~ \"b2bDirectConnectOutbound\"\n      | extend PremodifiedOutboundSettings = trim('\"',tostring(Property.oldValue)),\n               ModifiedOutboundSettings = trim(@'\"',tostring(Property.newValue))\n  )\n| where PremodifiedOutboundSettings != ModifiedOutboundSettings\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n",
                                "queryFrequency": "P2D",
                                "queryPeriod": "P2D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess",
                                  "Persistence",
                                  "Discovery"
                                ],
                                "subTechniques": [
                                  "T1078.004",
                                  "T1136.003",
                                  "T1087.004"
                                ],
                                "techniques": [
                                  "T1078",
                                  "T1136",
                                  "T1087"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatingAccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAccountUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject21').analyticRuleId21,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 21",
                                "parentId": "[variables('analyticRuleObject21').analyticRuleId21]",
                                "contentId": "[variables('analyticRuleObject21')._analyticRulecontentId21]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject21').analyticRuleVersion21]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject21')._analyticRulecontentId21]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Cross-tenant Access Settings Organization Outbound Direct Settings Changed",
                        "contentProductId": "[variables('analyticRuleObject21')._analyticRulecontentProductId21]",
                        "id": "[variables('analyticRuleObject21')._analyticRulecontentProductId21]",
                        "version": "[variables('analyticRuleObject21').analyticRuleVersion21]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject22').analyticRuleTemplateSpecName22]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "DisabledAccountSigninsAcrossManyApplications_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject22').analyticRuleVersion22]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject22')._analyticRulecontentId22]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies failed attempts to sign in to disabled accounts across multiple Azure Applications.\nDefault threshold for Azure Applications attempted to sign in to is 3.\nReferences: https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-sign-ins-error-codes\n50057 - User account is disabled. The account has been disabled by an administrator.",
                                "displayName": "Attempts to sign in to disabled accounts",
                                "enabled": false,
                                "query": "let threshold = 3;\nlet aadFunc = (tableName:string){\ntable(tableName)\n| where ResultType == \"50057\"\n| where ResultDescription =~ \"User account is disabled. The account has been disabled by an administrator.\"\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), applicationCount = dcount(AppDisplayName),\napplicationSet = make_set(AppDisplayName), count() by UserPrincipalName, IPAddress, Type\n| where applicationCount >= threshold\n| extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\n};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nunion isfuzzy=true aadSignin, aadNonInt\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AADNonInteractiveUserSignInLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess"
                                ],
                                "techniques": [
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject22').analyticRuleId22,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 22",
                                "parentId": "[variables('analyticRuleObject22').analyticRuleId22]",
                                "contentId": "[variables('analyticRuleObject22')._analyticRulecontentId22]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject22').analyticRuleVersion22]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject22')._analyticRulecontentId22]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Attempts to sign in to disabled accounts",
                        "contentProductId": "[variables('analyticRuleObject22')._analyticRulecontentProductId22]",
                        "id": "[variables('analyticRuleObject22')._analyticRulecontentProductId22]",
                        "version": "[variables('analyticRuleObject22').analyticRuleVersion22]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject23').analyticRuleTemplateSpecName23]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "DistribPassCrackAttempt_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject23').analyticRuleVersion23]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject23')._analyticRulecontentId23]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies distributed password cracking attempts from the Microsoft Entra ID SigninLogs.\nThe query looks for unusually high number of failed password attempts coming from multiple locations for a user account.\nReferences: https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-sign-ins-error-codes\n50053   Account is locked because the user tried to sign in too many times with an incorrect user ID or password.\n50055   Invalid password, entered expired password.\n50056   Invalid or null password - Password does not exist in store for this user.\n50126   Invalid username or password, or invalid on-premises username or password.",
                                "displayName": "Distributed Password cracking attempts in Microsoft Entra ID",
                                "enabled": false,
                                "query": "let s_threshold = 30;\nlet l_threshold = 3;\nlet aadFunc = (tableName:string){\ntable(tableName)\n| where OperationName =~ \"Sign-in activity\"\n// Error codes that we want to look at as they are related to the use of incorrect password.\n| where ResultType in (\"50126\", \"50053\" , \"50055\", \"50056\")\n| extend DeviceDetail = todynamic(DeviceDetail), Status = todynamic(DeviceDetail), LocationDetails = todynamic(LocationDetails)\n| extend OS = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser\n| extend StatusCode = tostring(Status.errorCode), StatusDetails = tostring(Status.additionalDetails)\n| extend LocationString = strcat(tostring(LocationDetails.countryOrRegion), \"/\", tostring(LocationDetails.state), \"/\", tostring(LocationDetails.city))\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), LocationCount=dcount(LocationString), Location = make_set(LocationString,100),\nIPAddress = make_set(IPAddress,100), IPAddressCount = dcount(IPAddress), AppDisplayName = make_set(AppDisplayName,100), ResultDescription = make_set(ResultDescription,50),\nBrowser = make_set(Browser,20), OS = make_set(OS,20), SigninCount = count() by UserPrincipalName, Type\n// Setting a generic threshold - Can be different for different environment\n| where SigninCount > s_threshold and LocationCount >= l_threshold\n| extend Location = tostring(Location), IPAddress = tostring(IPAddress), AppDisplayName = tostring(AppDisplayName), ResultDescription = tostring(ResultDescription), Browser = tostring(Browser), OS = tostring(OS)\n| extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nunion isfuzzy=true aadSignin, aadNonInt\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AADNonInteractiveUserSignInLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess"
                                ],
                                "techniques": [
                                  "T1110"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject23').analyticRuleId23,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 23",
                                "parentId": "[variables('analyticRuleObject23').analyticRuleId23]",
                                "contentId": "[variables('analyticRuleObject23')._analyticRulecontentId23]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject23').analyticRuleVersion23]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject23')._analyticRulecontentId23]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Distributed Password cracking attempts in Microsoft Entra ID",
                        "contentProductId": "[variables('analyticRuleObject23')._analyticRulecontentProductId23]",
                        "id": "[variables('analyticRuleObject23')._analyticRulecontentProductId23]",
                        "version": "[variables('analyticRuleObject23').analyticRuleVersion23]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject24').analyticRuleTemplateSpecName24]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "ExplicitMFADeny_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject24').analyticRuleVersion24]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject24')._analyticRulecontentId24]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "User explicitly denies MFA push, indicating that login was not expected and the account's password may be compromised.\nThis rule is deprecated as of July-2024. Alternative rule with similar logic and contex from more data source \nis available at https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Microsoft%20Entra%20ID/Analytic%20Rules/MFARejectedbyUser.yaml",
                                "displayName": "[Deprecated] Explicit MFA Deny",
                                "enabled": false,
                                "query": "let aadFunc = (tableName: string) {\n    table(tableName)\n    | where ResultType == 500121\n    | where Status has \"MFA Denied; user declined the authentication\" or Status has \"MFA denied; Phone App Reported Fraud\"\n    | extend Type = Type, PublicIP = IPAddress\n    | extend\n        Name = tostring(split(UserPrincipalName, '@', 0)[0]),\n        UPNSuffix = tostring(split(UserPrincipalName, '@', 1)[0])\n};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet dvcInfo = DeviceInfo\n    | extend SensorHealthState = column_ifexists(\"SensorHealthState\", \"\")\n    | where OnboardingStatus == \"Onboarded\" and SensorHealthState == \"Active\"\n    | project PublicIP, AadDeviceId;\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nunion isfuzzy=true aadSignin, aadNonInt\n| join kind=leftouter dvcInfo on PublicIP\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AADNonInteractiveUserSignInLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "MicrosoftThreatProtection",
                                    "dataTypes": [
                                      "DeviceInfo"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess"
                                ],
                                "techniques": [
                                  "T1110"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "PublicIP",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "ResourceId",
                                        "identifier": "ResourceId"
                                      }
                                    ],
                                    "entityType": "AzureResource"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "AppDisplayName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "AppId",
                                        "identifier": "AppId"
                                      }
                                    ],
                                    "entityType": "CloudApplication"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject24').analyticRuleId24,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 24",
                                "parentId": "[variables('analyticRuleObject24').analyticRuleId24]",
                                "contentId": "[variables('analyticRuleObject24')._analyticRulecontentId24]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject24').analyticRuleVersion24]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject24')._analyticRulecontentId24]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "[Deprecated] Explicit MFA Deny",
                        "contentProductId": "[variables('analyticRuleObject24')._analyticRulecontentProductId24]",
                        "id": "[variables('analyticRuleObject24')._analyticRulecontentProductId24]",
                        "version": "[variables('analyticRuleObject24').analyticRuleVersion24]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject25').analyticRuleTemplateSpecName25]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "ExchangeFullAccessGrantedToApp_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject25').analyticRuleVersion25]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject25')._analyticRulecontentId25]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This detection looks for the full_access_as_app permission being granted to an OAuth application with Admin Consent.\nThis permission provide access to all Exchange mailboxes via the EWS API can could be exploited to access sensitive data by being added to a compromised application. The application granted this permission should be reviewed to ensure that it is absolutely necessary for the applications function.\nRef: https://learn.microsoft.com/graph/auth-limit-mailbox-access",
                                "displayName": "full_access_as_app Granted To Application",
                                "enabled": false,
                                "query": "AuditLogs\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Consent to application\"\n| where TargetResources has \"full_access_as_app\"\n| mv-expand TargetResources\n| extend OAuthAppName = TargetResources.displayName\n| extend ModifiedProperties = TargetResources.modifiedProperties \n| mv-apply Property = ModifiedProperties on \n  (\n      where Property.displayName =~ \"ConsentContext.isAdminConsent\"\n      | extend AdminConsent = tostring(Property.newValue)\n  )\n| mv-apply Property = ModifiedProperties on \n  (\n      where Property.displayName =~ \"ConsentAction.Permissions\"\n      | extend Permissions = tostring(Property.newValue)\n  )\n| mv-apply Property = ModifiedProperties on \n  (\n      where Property.displayName =~ \"TargetId.ServicePrincipalNames\"\n      | extend AppId = tostring(Property.newValue)\n  )\n| mv-apply Property = AdditionalDetails on \n  (\n      where Property.key =~ \"User-Agent\"\n      | extend InitiatingUserAgent = replace('\"', '', tostring(Property.value))\n  )\n| project-away Property\n| parse Permissions with * \"ConsentType: \" GrantConsentType \", Scope: \" GrantScope1 \",\" *\n| where GrantScope1 =~ \"full_access_as_app\"\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| project-reorder TimeGenerated, OAuthAppName, AppId, AdminConsent, Permissions, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingIpAddress, InitiatingUserAgent, GrantScope1, GrantConsentType\n| extend GrantInitiatedBy = tostring(iff(isnotempty(InitiatingUserPrincipalName), InitiatingUserPrincipalName, InitiatingAppName))\n| extend Name = split(InitiatingUserPrincipalName, \"@\")[0], UPNSuffix = split(InitiatingUserPrincipalName, \"@\")[1]\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "DefenseEvasion"
                                ],
                                "subTechniques": [
                                  "T1550.001"
                                ],
                                "techniques": [
                                  "T1550"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ],
                                "customDetails": {
                                  "UserAgent": "InitiatingUserAgent",
                                  "OAuthAppId": "AppId",
                                  "OAuthApplication": "OAuthAppName"
                                },
                                "alertDetailsOverride": {
                                  "alertDisplayNameFormat": "User or App {{GrantInitiatedBy}} granted full_access_as_app to {{OAuthAppName}}",
                                  "alertDescriptionFormat": "This detection looks for the full_access_as_app permission being granted to an OAuth application with Admin Consent.\nThis permission provide access to all Exchange mailboxes via the EWS API can could be exploited to access sensitive data \nby being added to a compromised application. The application granted this permission should be reviewed to ensure that it \nis absolutely necessary for the applications function.\nIn this case {{GrantInitiatedBy}} granted full_access_as_app to {{OAuthAppName}} from {{InitiatingIpAddress}}\nRef: https://learn.microsoft.com/graph/auth-limit-mailbox-access\n"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject25').analyticRuleId25,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 25",
                                "parentId": "[variables('analyticRuleObject25').analyticRuleId25]",
                                "contentId": "[variables('analyticRuleObject25')._analyticRulecontentId25]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject25').analyticRuleVersion25]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject25')._analyticRulecontentId25]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "full_access_as_app Granted To Application",
                        "contentProductId": "[variables('analyticRuleObject25')._analyticRulecontentProductId25]",
                        "id": "[variables('analyticRuleObject25')._analyticRulecontentProductId25]",
                        "version": "[variables('analyticRuleObject25').analyticRuleVersion25]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject26').analyticRuleTemplateSpecName26]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "FailedLogonToAzurePortal_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject26').analyticRuleVersion26]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject26')._analyticRulecontentId26]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies failed login attempts in the Microsoft Entra ID SigninLogs to the Azure Portal.  Many failed logon attempts or some failed logon attempts from multiple IPs could indicate a potential brute force attack.\nThe following are excluded due to success and non-failure results:\nReferences: https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-sign-ins-error-codes\n0 - successful logon\n50125 - Sign-in was interrupted due to a password reset or password registration entry.\n50140 - This error occurred due to 'Keep me signed in' interrupt when the user was signing-in.",
                                "displayName": "Failed login attempts to Azure Portal",
                                "enabled": false,
                                "query": "let timeRange = 1d;\nlet lookBack = 7d;\nlet threshold_Failed = 5;\nlet threshold_FailedwithSingleIP = 20;\nlet threshold_IPAddressCount = 2;\nlet isGUID = \"[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}\";\nlet aadFunc = (tableName:string){\nlet azPortalSignins = materialize(table(tableName)\n| where TimeGenerated >= ago(lookBack)\n// Azure Portal only\n| where AppDisplayName =~ \"Azure Portal\")\n;\nlet successPortalSignins = azPortalSignins\n| where TimeGenerated >= ago(timeRange)\n// Azure Portal only and exclude non-failure Result Types\n| where ResultType in (\"0\", \"50125\", \"50140\")\n// Tagging identities not resolved to friendly names\n//| extend Unresolved = iff(Identity matches regex isGUID, true, false)\n| distinct TimeGenerated, UserPrincipalName\n;\nlet failPortalSignins = azPortalSignins\n| where TimeGenerated >= ago(timeRange)\n// Azure Portal only and exclude non-failure Result Types\n| where ResultType !in (\"0\", \"50125\", \"50140\", \"70044\", \"70043\")\n// Tagging identities not resolved to friendly names\n| extend Unresolved = iff(Identity matches regex isGUID, true, false)\n;\n// Verify there is no success for the same connection attempt after the fail\nlet failnoSuccess = failPortalSignins | join kind= leftouter (\n   successPortalSignins\n) on UserPrincipalName\n| where TimeGenerated > TimeGenerated1 or isempty(TimeGenerated1)\n| project-away TimeGenerated1, UserPrincipalName1\n;\n// Lookup up resolved identities from last 7 days\nlet identityLookup = azPortalSignins\n| where TimeGenerated >= ago(lookBack)\n| where not(Identity matches regex isGUID)\n| summarize by UserId, lu_UserDisplayName = UserDisplayName, lu_UserPrincipalName = UserPrincipalName;\n// Join resolved names to unresolved list from portal signins\nlet unresolvedNames = failnoSuccess | where Unresolved == true | join kind= inner (\n   identityLookup\n) on UserId\n| extend UserDisplayName = lu_UserDisplayName, UserPrincipalName = lu_UserPrincipalName\n| project-away lu_UserDisplayName, lu_UserPrincipalName;\n// Join Signins that had resolved names with list of unresolved that now have a resolved name\nlet u_azPortalSignins = failnoSuccess | where Unresolved == false | union unresolvedNames;\nu_azPortalSignins\n| extend DeviceDetail = todynamic(DeviceDetail), Status = todynamic(DeviceDetail), LocationDetails = todynamic(LocationDetails)\n| extend Status = strcat(ResultType, \": \", ResultDescription), OS = tostring(DeviceDetail.operatingSystem), Browser = tostring(DeviceDetail.browser)\n| extend State = tostring(LocationDetails.state), City = tostring(LocationDetails.city), Region = tostring(LocationDetails.countryOrRegion)\n| extend FullLocation = strcat(Region,'|', State, '|', City)  \n| summarize TimeGenerated = make_list(TimeGenerated,100), Status = make_list(Status,100), IPAddresses = make_list(IPAddress,100), IPAddressCount = dcount(IPAddress), FailedLogonCount = count()\nby UserPrincipalName, UserId, UserDisplayName, AppDisplayName, Browser, OS, FullLocation, Type\n| mvexpand TimeGenerated, IPAddresses, Status\n| extend TimeGenerated = todatetime(tostring(TimeGenerated)), IPAddress = tostring(IPAddresses), Status = tostring(Status)\n| project-away IPAddresses\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserPrincipalName, UserId, UserDisplayName, Status, FailedLogonCount, IPAddress, IPAddressCount, AppDisplayName, Browser, OS, FullLocation, Type\n| where (IPAddressCount >= threshold_IPAddressCount and FailedLogonCount >= threshold_Failed) or FailedLogonCount >= threshold_FailedwithSingleIP\n| extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\n};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nunion isfuzzy=true aadSignin, aadNonInt\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P7D",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AADNonInteractiveUserSignInLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess"
                                ],
                                "techniques": [
                                  "T1110"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject26').analyticRuleId26,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 26",
                                "parentId": "[variables('analyticRuleObject26').analyticRuleId26]",
                                "contentId": "[variables('analyticRuleObject26')._analyticRulecontentId26]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject26').analyticRuleVersion26]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject26')._analyticRulecontentId26]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Failed login attempts to Azure Portal",
                        "contentProductId": "[variables('analyticRuleObject26')._analyticRulecontentProductId26]",
                        "id": "[variables('analyticRuleObject26')._analyticRulecontentProductId26]",
                        "version": "[variables('analyticRuleObject26').analyticRuleVersion26]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject27').analyticRuleTemplateSpecName27]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "FirstAppOrServicePrincipalCredential_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject27').analyticRuleVersion27]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject27')._analyticRulecontentId27]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This will alert when an admin or app owner account adds a new credential to an Application or Service Principal where there was no previous verify KeyCredential associated.\nIf a threat actor obtains access to an account with sufficient privileges and adds the alternate authentication material triggering this event, the threat actor can now authenticate as the Application or Service Principal using this credential.\nAdditional information on OAuth Credential Grants can be found in RFC 6749 Section 4.4 or https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.",
                                "displayName": "First access credential added to Application or Service Principal where no credential was present",
                                "enabled": false,
                                "query": "AuditLogs\n| where OperationName has (\"Certificates and secrets management\")\n| where Result =~ \"success\"\n| where tostring(InitiatedBy.user.userPrincipalName) has \"@\" or tostring(InitiatedBy.app.displayName) has \"@\"\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"Application\"\n      | extend targetDisplayName = tostring(TargetResource.displayName),\n               targetId = tostring(TargetResource.id),\n               targetType = tostring(TargetResource.type),\n               keyEvents = TargetResource.modifiedProperties\n  )\n| mv-apply Property = keyEvents on \n  (\n      where Property.displayName =~ \"KeyDescription\"\n      | extend new_value_set = parse_json(tostring(Property.newValue)),\n               old_value_set = parse_json(tostring(Property.oldValue))\n  )\n| where old_value_set == \"[]\"\n| mv-expand new_value_set\n| parse new_value_set with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *\n| where keyUsage =~ \"Verify\"\n| mv-apply AdditionalDetail = AdditionalDetails on \n  (\n      where AdditionalDetail.key =~ \"User-Agent\"\n      | extend InitiatingUserAgent = tostring(AdditionalDetail.value)\n  )\n| project-away new_value_set, old_value_set, TargetResource, Property, AdditionalDetail\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| project-reorder TimeGenerated, OperationName, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingIpAddress, InitiatingUserAgent, \ntargetDisplayName, targetId, targetType, keyDisplayName, keyType, keyUsage, keyIdentifier, CorrelationId, TenantId\n| extend Name = split(InitiatingUserPrincipalName, \"@\")[0], UPNSuffix = split(InitiatingUserPrincipalName, \"@\")[1]\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "DefenseEvasion"
                                ],
                                "subTechniques": [
                                  "T1550.001"
                                ],
                                "techniques": [
                                  "T1550"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "targetDisplayName",
                                        "identifier": "Name"
                                      }
                                    ],
                                    "entityType": "CloudApplication"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject27').analyticRuleId27,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 27",
                                "parentId": "[variables('analyticRuleObject27').analyticRuleId27]",
                                "contentId": "[variables('analyticRuleObject27')._analyticRulecontentId27]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject27').analyticRuleVersion27]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject27')._analyticRulecontentId27]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "First access credential added to Application or Service Principal where no credential was present",
                        "contentProductId": "[variables('analyticRuleObject27')._analyticRulecontentProductId27]",
                        "id": "[variables('analyticRuleObject27')._analyticRulecontentProductId27]",
                        "version": "[variables('analyticRuleObject27').analyticRuleVersion27]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject28').analyticRuleTemplateSpecName28]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "GuestAccountsAddedinAADGroupsOtherThanTheOnesSpecified_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject28').analyticRuleVersion28]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject28')._analyticRulecontentId28]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Guest Accounts are added in the Organization Tenants to perform various tasks i.e projects execution, support etc.. This detection notifies when guest users are added to Microsoft Entra ID Groups other than the ones specified and poses a risk to gain access to sensitive apps or data.",
                                "displayName": "Guest accounts added in Entra ID Groups other than the ones specified",
                                "enabled": false,
                                "query": "// OBJECT ID of AAD Groups can be found by navigating to Azure Active Directory then from menu on the left, select Groups and from the list shown of AAD Groups, the Second Column shows the ObjectID of each\nlet GroupIDs = dynamic([\"List with Custom AAD GROUP OBJECT ID 1\",\"Custom AAD GROUP OBJECT ID 2\"]);\nAuditLogs\n| where OperationName in ('Add member to group', 'Add owner to group')\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n// Uncomment the following line to filter events where the inviting user was a guest user\n//| where InitiatedBy has_any (\"CUSTOM DOMAIN NAME#\", \"#EXT#\")\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"User\"\n      | extend InvitedUserPrincipalName = trim(@'\"',tostring(TargetResource.userPrincipalName)),\n               Properties = TargetResource.modifiedProperties\n  )\n| mv-apply Property = Properties on \n  (\n      where Property.displayName =~ \"Group.DisplayName\"\n      | extend AADGroup = trim('\"',tostring(Property.newValue))\n  )\n| where InvitedUserPrincipalName has_any (\"CUSTOM DOMAIN NAME#\", \"#EXT#\")\n| mv-apply Property = Properties on\n   (\n     where Property.displayName =~ \"Group.ObjectID\"\n     | extend AADGroupId = trim('\"',tostring(Property.newValue))\n   )\n| project-away TargetResource, Property\n| where AADGroupId !in (GroupIDs)\n| extend Name = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n| extend InvitedUserName = tostring(split(InvitedUserPrincipalName,'@',0)[0]), InvitedUPNSuffix = tostring(split(InvitedUserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "PT2H",
                                "queryPeriod": "PT2H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess",
                                  "Persistence",
                                  "Discovery"
                                ],
                                "subTechniques": [
                                  "T1078.004",
                                  "T1136.003",
                                  "T1087.004"
                                ],
                                "techniques": [
                                  "T1078",
                                  "T1136",
                                  "T1087"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InvitedUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InvitedUserName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InvitedUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "AADGroup",
                                        "identifier": "DistinguishedName"
                                      },
                                      {
                                        "columnName": "AADGroupId",
                                        "identifier": "ObjectGuid"
                                      }
                                    ],
                                    "entityType": "SecurityGroup"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject28').analyticRuleId28,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 28",
                                "parentId": "[variables('analyticRuleObject28').analyticRuleId28]",
                                "contentId": "[variables('analyticRuleObject28')._analyticRulecontentId28]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject28').analyticRuleVersion28]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject28')._analyticRulecontentId28]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Guest accounts added in Entra ID Groups other than the ones specified",
                        "contentProductId": "[variables('analyticRuleObject28')._analyticRulecontentProductId28]",
                        "id": "[variables('analyticRuleObject28')._analyticRulecontentProductId28]",
                        "version": "[variables('analyticRuleObject28').analyticRuleVersion28]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject29').analyticRuleTemplateSpecName29]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "MailPermissionsAddedToApplication_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject29').analyticRuleVersion29]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject29')._analyticRulecontentId29]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This query look for applications that have been granted (Delegated or App/Role) permissions to Read Mail (Permissions field has Mail.Read) and subsequently has been consented to. This can help identify applications that have been abused to gain access to mailboxes.",
                                "displayName": "Mail.Read Permissions Granted to Application",
                                "enabled": false,
                                "query": "AuditLogs\n| where Category =~ \"ApplicationManagement\"\n| where ActivityDisplayName has_any (\"Add delegated permission grant\",\"Add app role assignment to service principal\")  \n| where Result =~ \"success\"\n| where tostring(InitiatedBy.user.userPrincipalName) has \"@\" or tostring(InitiatedBy.app.displayName) has \"@\"\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"ServicePrincipal\" and array_length(TargetResource.modifiedProperties) > 0 and isnotnull(TargetResource.displayName)\n      | extend props = TargetResource.modifiedProperties,\n               Type = tostring(TargetResource.type),\n               PermissionsAddedTo = tostring(TargetResource.displayName)\n  )\n| mv-apply Property = props on \n  (\n      where Property.displayName =~ \"DelegatedPermissionGrant.Scope\"\n      | extend DisplayName = tostring(Property.displayName), Permissions = trim('\"',tostring(Property.newValue))\n  )\n| where Permissions has_any (\"Mail.Read\", \"Mail.ReadWrite\")\n| mv-apply AdditionalDetail = AdditionalDetails on \n  (\n      where AdditionalDetail.key =~ \"User-Agent\"\n      | extend InitiatingUserAgent = tostring(AdditionalDetail.value)\n  )\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| project-away props, TargetResource, AdditionalDetail, Property\n| join kind=leftouter(\n  AuditLogs\n  | where ActivityDisplayName has \"Consent to application\"\n  | mv-apply TargetResource = TargetResources on \n      (\n          where TargetResource.type =~ \"ServicePrincipal\"\n          | extend AppName = tostring(TargetResource.displayName),\n                   AppId = tostring(TargetResource.id)\n      )\n| project AppName, AppId, CorrelationId) on CorrelationId\n| project-away CorrelationId1\n| project-reorder TimeGenerated, OperationName, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingIpAddress, InitiatingUserAgent, PermissionsAddedTo, Permissions, AppName, AppId, CorrelationId\n| extend Name = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Persistence"
                                ],
                                "techniques": [
                                  "T1098"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject29').analyticRuleId29,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 29",
                                "parentId": "[variables('analyticRuleObject29').analyticRuleId29]",
                                "contentId": "[variables('analyticRuleObject29')._analyticRulecontentId29]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject29').analyticRuleVersion29]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject29')._analyticRulecontentId29]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Mail.Read Permissions Granted to Application",
                        "contentProductId": "[variables('analyticRuleObject29')._analyticRulecontentProductId29]",
                        "id": "[variables('analyticRuleObject29')._analyticRulecontentProductId29]",
                        "version": "[variables('analyticRuleObject29').analyticRuleVersion29]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject30').analyticRuleTemplateSpecName30]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "MaliciousOAuthApp_O365AttackToolkit_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject30').analyticRuleVersion30]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject30')._analyticRulecontentId30]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This will alert when a user consents to provide a previously-unknown Azure application with the same OAuth permissions used by the MDSec O365 Attack Toolkit (https://github.com/mdsecactivebreach/o365-attack-toolkit).\nThe default permissions/scope for the MDSec O365 Attack toolkit change sometimes but often include contacts.read, user.read, mail.read, notes.read.all, mailboxsettings.readwrite, files.readwrite.all, mail.send, files.read, and files.read.all.\nConsent to applications with these permissions should be rare, especially as the knownApplications list is expanded, especially as the knownApplications list is expanded. Public contributions to expand this filter are welcome!\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.",
                                "displayName": "Suspicious application consent similar to O365 Attack Toolkit",
                                "enabled": false,
                                "query": "let detectionTime = 1d;\nlet joinLookback = 14d;\nlet threshold = 5;\nlet o365_attack_regex = \"contacts.read|user.read|mail.read|notes.read.all|mailboxsettings.readwrite|Files.ReadWrite.All|mail.send|files.read|files.read.all\";\nlet o365_attack = dynamic([\"contacts.read\", \"user.read\", \"mail.read\", \"notes.read.all\", \"mailboxsettings.readwrite\", \"Files.ReadWrite.All\", \"mail.send\", \"files.read\", \"files.read.all\"]);\nAuditLogs\n| where TimeGenerated > ago(detectionTime)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Consent to application\"\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"ServicePrincipal\"\n      | extend AppDisplayName = tostring(TargetResource.displayName),\n               AppClientId = tostring(TargetResource.id),\n               props = TargetResource.modifiedProperties\n  )\n| where AppClientId !in ((externaldata(knownAppClientId:string, knownAppDisplayName:string)[@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/Microsoft.OAuth.KnownApplications.csv\"] with (format=\"csv\"))) // NOTE: a MATCH from this list will cause the alert to NOT fire - please modify for your environment!\n| mv-apply ConsentFull = props on \n  (\n      where ConsentFull.displayName =~ \"ConsentAction.Permissions\"\n  )\n| parse ConsentFull with * \"ConsentType: \" GrantConsentType \", Scope: \" GrantScope1 \", CreatedDateTime\" * \"]\" *\n| where GrantConsentType != \"AllPrincipals\" // NOTE: we are ignoring if OAuth application was granted to all users via an admin - but admin due diligence should be audited occasionally\n| where ConsentFull has_any (o365_attack)  \n| extend GrantScopeCount = countof(tolower(GrantScope1), o365_attack_regex, 'regex')\n| where GrantScopeCount > threshold\n| extend GrantInitiatedByAppName = tostring(InitiatedBy.app.displayName)\n| extend GrantInitiatedByAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend GrantInitiatedByUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend GrantInitiatedByAadUserId = tostring(InitiatedBy.user.id)\n| extend GrantIpAddress = iff(isnotempty(InitiatedBy.user.ipAddress), tostring(InitiatedBy.user.ipAddress), tostring(InitiatedBy.app.ipAddress))\n| extend GrantInitiatedBy = iff(isnotempty(GrantInitiatedByUserPrincipalName), GrantInitiatedByUserPrincipalName, GrantInitiatedByAppName)\n| mv-apply AdditionalDetail = AdditionalDetails on \n  (\n      where AdditionalDetail.key =~ \"User-Agent\"\n      | extend GrantUserAgent = AdditionalDetail.value\n  )\n| project TimeGenerated, GrantConsentType, GrantScope1, GrantInitiatedBy, AppDisplayName, GrantInitiatedByUserPrincipalName, GrantInitiatedByAadUserId, GrantInitiatedByAppName, GrantInitiatedByAppServicePrincipalId, GrantIpAddress, GrantUserAgent, AppClientId, OperationName, ConsentFull, CorrelationId\n| join kind = leftouter (AuditLogs\n  | where TimeGenerated > ago(joinLookback)\n  | where LoggedByService =~ \"Core Directory\"\n  | where Category =~ \"ApplicationManagement\"\n  | where OperationName =~ \"Add service principal\"\n  | mv-apply TargetResource = TargetResources on \n      (\n          where TargetResource.type =~ \"ServicePrincipal\"\n          | extend props = TargetResource.modifiedProperties,\n                  AppClientId = tostring(TargetResource.id)\n      )\n  | mv-apply Property = props on \n      (\n          where Property.displayName =~ \"AppAddress\" and Property.newValue has \"AddressType\"\n          | extend AppReplyURLs = trim('\"',tostring(Property.newValue))\n      )\n  | distinct AppClientId, tostring(AppReplyURLs)\n) on AppClientId\n| join kind = innerunique (AuditLogs\n      | where TimeGenerated > ago(joinLookback)\n      | where LoggedByService =~ \"Core Directory\"\n      | where Category =~ \"ApplicationManagement\"\n      | where OperationName =~ \"Add OAuth2PermissionGrant\" or OperationName =~ \"Add delegated permission grant\"\n          | mv-apply TargetResource = TargetResources on \n          (\n              where TargetResource.type =~ \"ServicePrincipal\" and array_length(TargetResource.modifiedProperties) > 0 and isnotnull(TargetResource.displayName)\n              | extend GrantAuthentication = tostring(TargetResource.displayName)\n          )\n      | extend GrantOperation = OperationName\n      | project GrantAuthentication, GrantOperation, CorrelationId\n  ) on CorrelationId\n| project TimeGenerated, GrantConsentType, GrantScope1, GrantInitiatedBy, AppDisplayName, AppReplyURLs, GrantInitiatedByUserPrincipalName, GrantInitiatedByAadUserId, GrantInitiatedByAppName, GrantInitiatedByAppServicePrincipalId, GrantIpAddress, GrantUserAgent, AppClientId, GrantAuthentication, OperationName, GrantOperation, CorrelationId, ConsentFull\n| extend Name = tostring(split(GrantInitiatedByUserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(GrantInitiatedByUserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P14D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess",
                                  "DefenseEvasion"
                                ],
                                "techniques": [
                                  "T1528",
                                  "T1550"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "GrantInitiatedByUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "GrantInitiatedByAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "GrantInitiatedByAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "GrantIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "AppDisplayName",
                                        "identifier": "Name"
                                      }
                                    ],
                                    "entityType": "CloudApplication"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject30').analyticRuleId30,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 30",
                                "parentId": "[variables('analyticRuleObject30').analyticRuleId30]",
                                "contentId": "[variables('analyticRuleObject30')._analyticRulecontentId30]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject30').analyticRuleVersion30]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject30')._analyticRulecontentId30]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Suspicious application consent similar to O365 Attack Toolkit",
                        "contentProductId": "[variables('analyticRuleObject30')._analyticRulecontentProductId30]",
                        "id": "[variables('analyticRuleObject30')._analyticRulecontentProductId30]",
                        "version": "[variables('analyticRuleObject30').analyticRuleVersion30]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject31').analyticRuleTemplateSpecName31]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "MaliciousOAuthApp_PwnAuth_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject31').analyticRuleVersion31]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject31')._analyticRulecontentId31]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This will alert when a user consents to provide a previously-unknown Azure application with the same OAuth permissions used by the FireEye PwnAuth toolkit (https://github.com/fireeye/PwnAuth).\nThe default permissions/scope for the PwnAuth toolkit are user.read, offline_access, mail.readwrite, mail.send, and files.read.all.\nConsent to applications with these permissions should be rare, especially as the knownApplications list is expanded. Public contributions to expand this filter are welcome!\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.",
                                "displayName": "Suspicious application consent similar to PwnAuth",
                                "enabled": false,
                                "query": "let detectionTime = 1d;\nlet joinLookback = 14d;\nAuditLogs\n| where TimeGenerated > ago(detectionTime)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Consent to application\"\n| where TargetResources has \"offline\"\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"ServicePrincipal\"\n      | extend AppDisplayName = tostring(TargetResource.displayName),\n               AppClientId = tostring(TargetResource.id),\n               props = TargetResource.modifiedProperties\n  )\n| where AppClientId !in ((externaldata(knownAppClientId:string, knownAppDisplayName:string)[@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/Microsoft.OAuth.KnownApplications.csv\"] with (format=\"csv\")))\n| mv-apply ConsentFull = props on \n  (\n      where ConsentFull.displayName =~ \"ConsentAction.Permissions\"\n  )\n| parse ConsentFull with * \"ConsentType: \" GrantConsentType \", Scope: \" GrantScope1 \"]\" *\n| where ConsentFull has_all (\"user.read\", \"offline_access\", \"mail.readwrite\", \"mail.send\", \"files.read.all\")\n| where GrantConsentType != \"AllPrincipals\" // NOTE: we are ignoring if OAuth application was granted to all users via an admin - but admin due diligence should be audited occasionally\n| extend GrantInitiatedByAppName = tostring(InitiatedBy.app.displayName)\n| extend GrantInitiatedByAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend GrantInitiatedByUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend GrantInitiatedByAadUserId = tostring(InitiatedBy.user.id)\n| extend GrantIpAddress = iff(isnotempty(InitiatedBy.user.ipAddress), tostring(InitiatedBy.user.ipAddress), tostring(InitiatedBy.app.ipAddress))\n| extend GrantInitiatedBy = iff(isnotempty(GrantInitiatedByUserPrincipalName), GrantInitiatedByUserPrincipalName, GrantInitiatedByAppName)\n| mv-apply AdditionalDetail = AdditionalDetails on \n  (\n      where AdditionalDetail.key =~ \"User-Agent\"\n      | extend GrantUserAgent = AdditionalDetail.value\n  )\n| project TimeGenerated, GrantConsentType, GrantScope1, GrantInitiatedBy, AppDisplayName, GrantInitiatedByUserPrincipalName, GrantInitiatedByAadUserId, GrantInitiatedByAppName, GrantInitiatedByAppServicePrincipalId, GrantIpAddress, GrantUserAgent, AppClientId, OperationName, ConsentFull, CorrelationId\n| join kind = leftouter (AuditLogs\n| where TimeGenerated > ago(joinLookback)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Add service principal\"\n  | mv-apply TargetResource = TargetResources on \n      (\n          where TargetResource.type =~ \"ServicePrincipal\"\n          | extend props = TargetResource.modifiedProperties,\n                  AppClientId = tostring(TargetResource.id)\n      )\n  | mv-apply Property = props on \n      (\n          where Property.displayName =~ \"AppAddress\" and Property.newValue has \"AddressType\"\n          | extend AppReplyURLs = trim('\"',tostring(Property.newValue))\n      )\n| distinct AppClientId, tostring(AppReplyURLs)\n)\non AppClientId\n| join kind = innerunique (AuditLogs\n| where TimeGenerated > ago(joinLookback)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Add OAuth2PermissionGrant\" or OperationName =~ \"Add delegated permission grant\"\n      | mv-apply TargetResource = TargetResources on \n          (\n              where TargetResource.type =~ \"ServicePrincipal\" and array_length(TargetResource.modifiedProperties) > 0 and isnotnull(TargetResource.displayName)\n              | extend GrantAuthentication = tostring(TargetResource.displayName)\n          )\n| extend GrantOperation = OperationName\n| project GrantAuthentication, GrantOperation, CorrelationId\n) on CorrelationId\n| project TimeGenerated, GrantConsentType, GrantScope1, GrantInitiatedBy, AppDisplayName, AppReplyURLs, GrantInitiatedByUserPrincipalName, GrantInitiatedByAadUserId, GrantInitiatedByAppName, GrantInitiatedByAppServicePrincipalId, GrantIpAddress, GrantUserAgent, AppClientId, GrantAuthentication, OperationName, GrantOperation, CorrelationId, ConsentFull\n| extend timestamp = TimeGenerated, Name = tostring(split(GrantInitiatedByUserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(GrantInitiatedByUserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P14D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess",
                                  "DefenseEvasion"
                                ],
                                "techniques": [
                                  "T1528",
                                  "T1550"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "GrantInitiatedByUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "GrantInitiatedByAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "GrantInitiatedByAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "GrantIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject31').analyticRuleId31,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 31",
                                "parentId": "[variables('analyticRuleObject31').analyticRuleId31]",
                                "contentId": "[variables('analyticRuleObject31')._analyticRulecontentId31]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject31').analyticRuleVersion31]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject31')._analyticRulecontentId31]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Suspicious application consent similar to PwnAuth",
                        "contentProductId": "[variables('analyticRuleObject31')._analyticRulecontentProductId31]",
                        "id": "[variables('analyticRuleObject31')._analyticRulecontentProductId31]",
                        "version": "[variables('analyticRuleObject31').analyticRuleVersion31]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject32').analyticRuleTemplateSpecName32]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "MFARejectedbyUser_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject32').analyticRuleVersion32]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject32')._analyticRulecontentId32]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies occurances where a user has rejected an MFA prompt. This could be an indicator that a threat actor has compromised the username and password of this user account and is using it to try and log into the account.\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-user-accounts#monitoring-for-failed-unusual-sign-ins\nThis query has also been updated to include UEBA logs IdentityInfo and BehaviorAnalytics for contextual information around the results. \nPlease note, MFA Failed logons from known IP ranges can be benign depending on the conditional access policies. In case of noisy behavior, consider tuning the source IP ranges or location filter after careful consideration",
                                "displayName": "MFA Rejected by User",
                                "enabled": false,
                                "query": "let riskScoreCutoff = 3; //Adjust this score threshold based on volume of results. Activities identified as the most abnormal receive the highest scores (on a scale of 0-10)\nSigninLogs\n| where ResultType == 500121\n| extend additionalDetails_ = tostring(Status.additionalDetails)\n| extend UserPrincipalName = tolower(UserPrincipalName)\n| where additionalDetails_ =~ \"MFA denied; user declined the authentication\" or additionalDetails_ has \"fraud\"\n| summarize StartTime = min(TimeGenerated), EndTIme = max(TimeGenerated) by UserPrincipalName, UserId, AADTenantId, FailedIPAddress = IPAddress\n| extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\n| join kind=leftouter (\n    IdentityInfo\n    | summarize LatestReportTime = arg_max(TimeGenerated, *) by AccountUPN\n    | project AccountUPN, Tags, JobTitle, GroupMembership, AssignedRoles, UserType, IsAccountEnabled\n    | summarize\n        Tags = make_set(Tags, 1000),\n        GroupMembership = make_set(GroupMembership, 1000),\n        AssignedRoles = make_set(AssignedRoles, 1000),\n        UserType = make_set(UserType, 1000),\n        UserAccountControl = make_set(UserType, 1000)\n    by AccountUPN\n    | extend UserPrincipalName=tolower(AccountUPN)\n) on UserPrincipalName\n//Below it will be joined with BehaviorAnalytics table to the Failed IP Addresses\n| join kind=leftouter (\n    BehaviorAnalytics\n    | where ActivityType in (\"FailedLogOn\", \"LogOn\")\n    | where isnotempty(SourceIPAddress)\n    | project UsersInsights, DevicesInsights, ActivityInsights, InvestigationPriority, SourceIPAddress, UserName\n    | project-rename FailedIPAddress = SourceIPAddress, Name = UserName\n    | summarize\n      MaxInvestigationScore = max(InvestigationPriority)  // Only retrieve maximum Investigation Property score for both FailedIP and User\n    by FailedIPAddress, Name)\non FailedIPAddress, Name  // Joining on both IP and User so as to only return context associated with same user\n| extend UEBARiskScore = MaxInvestigationScore\n| project-away *1 // removing duplicate columns post outer join from output\n| where  UEBARiskScore > riskScoreCutoff\n| sort by UEBARiskScore desc \n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "BehaviorAnalytics",
                                    "dataTypes": [
                                      "BehaviorAnalytics"
                                    ]
                                  },
                                  {
                                    "connectorId": "BehaviorAnalytics",
                                    "dataTypes": [
                                      "IdentityInfo"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess"
                                ],
                                "subTechniques": [
                                  "T1078.004"
                                ],
                                "techniques": [
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "FailedIPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject32').analyticRuleId32,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 32",
                                "parentId": "[variables('analyticRuleObject32').analyticRuleId32]",
                                "contentId": "[variables('analyticRuleObject32')._analyticRulecontentId32]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject32').analyticRuleVersion32]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject32')._analyticRulecontentId32]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "MFA Rejected by User",
                        "contentProductId": "[variables('analyticRuleObject32')._analyticRulecontentProductId32]",
                        "id": "[variables('analyticRuleObject32')._analyticRulecontentProductId32]",
                        "version": "[variables('analyticRuleObject32').analyticRuleVersion32]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject33').analyticRuleTemplateSpecName33]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "MFASpammingfollowedbySuccessfullogin_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject33').analyticRuleVersion33]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject33')._analyticRulecontentId33]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies MFA Spamming followed by Successful logins and by a successful authentication within a given time window.\nDefault Failure count is 10 and 1 successful login with default Time Window is 5 minutes.",
                                "displayName": "MFA Spamming followed by Successful login",
                                "enabled": false,
                                "query": "// Filter for sign-in logs ingested within the last day\nSigninLogs\n| where ingestion_time() > ago(1d)\n// Filter for records with AuthenticationRequirement set to multiFactorAuthentication\n| where AuthenticationRequirement == \"multiFactorAuthentication\"\n// Extract information from dynamic columns DeviceDetail and LocationDetails\n| extend DeviceDetail = todynamic(DeviceDetail), LocationDetails = todynamic(LocationDetails)\n// Extract specific attributes from DeviceDetail and LocationDetails\n| extend\n      OS = tostring(DeviceDetail.operatingSystem),\n      Browser = tostring(DeviceDetail.browser),\n      State = tostring(LocationDetails.state),\n      City = tostring(LocationDetails.city),\n      Region = tostring(LocationDetails.countryOrRegion)\n// Expand multi-value property AuthenticationDetails into separate records\n| mv-expand todynamic(AuthenticationDetails)\n// Parse AuthResult from JSON in AuthenticationDetails and convert to string\n| extend AuthResult = tostring(parse_json(AuthenticationDetails).authenticationStepResultDetail)\n// Summarize data by aggregating statistics for each user, IP, and AuthResult\n| summarize FailedAttempts = countif(AuthResult == \"MFA denied; user declined the authentication\" or AuthResult == \"MFA denied; user did not respond to mobile app notification\"), SuccessfulAttempts = countif(AuthResult == \"MFA successfully completed\"), InvolvedOS = make_set(OS, 5), InvolvedBrowser = make_set(Browser), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserPrincipalName, IPAddress, State, City, Region\n// Calculate AuthenticationWindow by finding time difference between start and end times\n| extend AuthenticationWindow = (EndTime - StartTime)\n// Filter for records with more than 10 failed attempts in 5-minute window and at least 1 successful attempt\n| where FailedAttempts > 10 and AuthenticationWindow <= 5m and SuccessfulAttempts >= 1\n// Extract user's name and UPN suffix using split function\n| extend Name = tostring(split(UserPrincipalName, '@', 0)[0]), UPNSuffix = tostring(split(UserPrincipalName, '@', 1)[0])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess"
                                ],
                                "techniques": [
                                  "T1110"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject33').analyticRuleId33,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 33",
                                "parentId": "[variables('analyticRuleObject33').analyticRuleId33]",
                                "contentId": "[variables('analyticRuleObject33')._analyticRulecontentId33]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject33').analyticRuleVersion33]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject33')._analyticRulecontentId33]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "MFA Spamming followed by Successful login",
                        "contentProductId": "[variables('analyticRuleObject33')._analyticRulecontentProductId33]",
                        "id": "[variables('analyticRuleObject33')._analyticRulecontentProductId33]",
                        "version": "[variables('analyticRuleObject33').analyticRuleVersion33]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject34').analyticRuleTemplateSpecName34]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "MultipleAdmin_membership_removals_from_NewAdmin_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject34').analyticRuleVersion34]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject34')._analyticRulecontentId34]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This query detects when newly created Global admin removes multiple existing global admins which can be an attempt by adversaries to lock down organization and retain sole access. \n Investigate reasoning and intention of multiple membership removal by new Global admins and take necessary actions accordingly.",
                                "displayName": "Multiple admin membership removals from newly created admin.",
                                "enabled": false,
                                "query": "let lookback = 7d; \nlet timeframe = 1h; \nlet GlobalAdminsRemoved = AuditLogs \n| where TimeGenerated > ago(timeframe) \n| where Category =~ \"RoleManagement\" \n| where AADOperationType in (\"Unassign\", \"RemoveEligibleRole\") \n| where ActivityDisplayName has_any (\"Remove member from role\", \"Remove eligible member from role\") \n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"User\"\n      | extend Target = tostring(TargetResource.userPrincipalName),\n               props = TargetResource.modifiedProperties\n  )\n| mv-apply Property = props on \n      (\n          where Property.displayName =~ \"Role.DisplayName\"\n          | extend RoleName = trim('\"',tostring(Property.oldValue))\n      )\n| where RoleName =~ \"Global Administrator\" // Add other Privileged role if applicable\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend Initiator = iif(isnotempty(InitiatingAppName), InitiatingAppName, InitiatingUserPrincipalName) \n| where Initiator != \"MS-PIM\" and Initiator != \"MS-PIM-Fairfax\"  // Filtering PIM events  \n| summarize RemovedGlobalAdminTime = max(TimeGenerated), TargetAdmins = make_set(Target,100) by OperationName, RoleName, Initiator, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingIpAddress, Result; \nlet GlobalAdminsAdded = AuditLogs \n| where TimeGenerated > ago(lookback) \n| where Category =~ \"RoleManagement\" \n| where AADOperationType in (\"Assign\", \"AssignEligibleRole\") \n| where ActivityDisplayName has_any (\"Add eligible member to role\", \"Add member to role\") and Result == \"success\" \n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"User\"\n      | extend Target = tostring(TargetResource.userPrincipalName),\n               props = TargetResource.modifiedProperties\n  )\n| mv-apply Property = props on \n      (\n          where Property.displayName =~ \"Role.DisplayName\"\n          | extend RoleName = trim('\"',tostring(Property.newValue))\n      )\n| where RoleName =~ \"Global Administrator\" // Add other Privileged role if applicable\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend Initiator = iif(isnotempty(InitiatingAppName), InitiatingAppName, tostring(InitiatedBy.user.userPrincipalName)) \n| where Initiator != \"MS-PIM\" and Initiator != \"MS-PIM-Fairfax\"  // Filtering PIM events \n| summarize AddedGlobalAdminTime = max(TimeGenerated) by OperationName, RoleName, Target, Initiator, Result;\nGlobalAdminsAdded \n| join kind= inner GlobalAdminsRemoved on $left.Target == $right.Initiator \n| where AddedGlobalAdminTime < RemovedGlobalAdminTime \n| extend NoofAdminsRemoved = array_length(TargetAdmins) \n| where NoofAdminsRemoved > 1\n| project AddedGlobalAdminTime, Initiator, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingIpAddress, Target, RemovedGlobalAdminTime, TargetAdmins, NoofAdminsRemoved\n| extend TargetName = tostring(split(Target,'@',0)[0]), TargetUPNSuffix = tostring(split(Target,'@',1)[0])\n| extend InitiatedByName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), InitiatedByUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P7D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Impact"
                                ],
                                "techniques": [
                                  "T1531"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Target",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "TargetName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "TargetUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatedByName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatedByUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject34').analyticRuleId34,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 34",
                                "parentId": "[variables('analyticRuleObject34').analyticRuleId34]",
                                "contentId": "[variables('analyticRuleObject34')._analyticRulecontentId34]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject34').analyticRuleVersion34]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject34')._analyticRulecontentId34]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Multiple admin membership removals from newly created admin.",
                        "contentProductId": "[variables('analyticRuleObject34')._analyticRulecontentProductId34]",
                        "id": "[variables('analyticRuleObject34')._analyticRulecontentProductId34]",
                        "version": "[variables('analyticRuleObject34').analyticRuleVersion34]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject35').analyticRuleTemplateSpecName35]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "NewOnmicrosoftDomainAdded_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject35').analyticRuleVersion35]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject35')._analyticRulecontentId35]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This detection looks for new onmicrosoft domains being added to a tenant. \nAn attacker who compromises a tenant may register a new onmicrosoft domain in order to masquerade as a service provider for launching phishing campaigns.\nDomain additions are not a common occurrence and users should validate that the domain was added by a legitimate user, with a legitimate purpose.",
                                "displayName": "New onmicrosoft domain added to tenant",
                                "enabled": false,
                                "query": "AuditLogs\n| where AADOperationType == \"Add\"\n| where Result == \"success\"\n| where OperationName in (\"Add verified domain\", \"Add unverified domain\")\n| extend InitiatedBy = parse_json(InitiatedBy)\n| extend InitiatingUser = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIp = tostring(InitiatedBy.user.ipAddress)\n| extend InitiatingApp = tostring(InitiatedBy.app.displayName)\n| extend InitiatingSPID = tostring(InitiatedBy.app.servicePrincipalId)\n| extend DomainAdded = tostring(TargetResources[0].displayName)\n| where DomainAdded has \"onmicrosoft\"\n| extend ActionInitiatedBy = case(isnotempty(InitiatingUser), InitiatingUser, strcat(InitiatingApp, \" - \", InitiatingSPID))\n| extend UserName = split(InitiatingUser, \"@\")[0]\n| extend UPNSuffix = split(InitiatingUser, \"@\")[1]\n| project-reorder TimeGenerated, OperationName, DomainAdded, ActionInitiatedBy, InitiatingIp\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "ResourceDevelopment"
                                ],
                                "subTechniques": [
                                  "T1585.003"
                                ],
                                "techniques": [
                                  "T1585"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUser",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "UserName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingSPID",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIp",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "DomainAdded",
                                        "identifier": "DomainName"
                                      }
                                    ],
                                    "entityType": "DNS"
                                  }
                                ],
                                "eventGroupingSettings": {
                                  "aggregationKind": "SingleAlert"
                                },
                                "alertDetailsOverride": {
                                  "alertDisplayNameFormat": "{{DomainAdded}} added to tenant by {{ActionInitiatedBy}}",
                                  "alertDescriptionFormat": "This detection looks for new onmicrosoft domains being added to a tenant. An attacker who compromises a tenant may register a new onmicrosoft domain in order to masquerade as a service provider for launching phishing accounts. Domain additions are not a common occurrence and users should validate that {{ActionInitiatedBy}} added {{DomainAdded}} with a legitimate purpose."
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject35').analyticRuleId35,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 35",
                                "parentId": "[variables('analyticRuleObject35').analyticRuleId35]",
                                "contentId": "[variables('analyticRuleObject35')._analyticRulecontentId35]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject35').analyticRuleVersion35]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject35')._analyticRulecontentId35]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "New onmicrosoft domain added to tenant",
                        "contentProductId": "[variables('analyticRuleObject35')._analyticRulecontentProductId35]",
                        "id": "[variables('analyticRuleObject35')._analyticRulecontentProductId35]",
                        "version": "[variables('analyticRuleObject35').analyticRuleVersion35]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject36').analyticRuleTemplateSpecName36]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "NewAppOrServicePrincipalCredential_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject36').analyticRuleVersion36]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject36')._analyticRulecontentId36]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This will alert when an admin or app owner account adds a new credential to an Application or Service Principal where a verify KeyCredential was already present for the app.\nIf a threat actor obtains access to an account with sufficient privileges and adds the alternate authentication material triggering this event, the threat actor can now authenticate as the Application or Service Principal using this credential.\nAdditional information on OAuth Credential Grants can be found in RFC 6749 Section 4.4 or https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.",
                                "displayName": "New access credential added to Application or Service Principal",
                                "enabled": false,
                                "query": "AuditLogs\n| where OperationName has_any (\"Add service principal\", \"Certificates and secrets management\") // captures \"Add service principal\", \"Add service principal credentials\", and \"Update application - Certificates and secrets management\" events\n| where Result =~ \"success\"\n| where tostring(InitiatedBy.user.userPrincipalName) has \"@\" or tostring(InitiatedBy.app.displayName) has \"@\"\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"Application\"\n      | extend targetDisplayName = tostring(TargetResource.displayName),\n               targetId = tostring(TargetResource.id),\n               targetType = tostring(TargetResource.type),\n               keyEvents = TargetResource.modifiedProperties\n  )\n| mv-apply Property = keyEvents on \n  (\n      where Property.displayName =~ \"KeyDescription\"\n      | extend new_value_set = parse_json(tostring(Property.newValue)),\n               old_value_set = parse_json(tostring(Property.oldValue))\n  )\n| where old_value_set != \"[]\"\n| extend diff = set_difference(new_value_set, old_value_set)\n| where isnotempty(diff)\n| parse diff with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *\n| where keyUsage =~ \"Verify\"\n| mv-apply AdditionalDetail = AdditionalDetails on \n  (\n      where AdditionalDetail.key =~ \"User-Agent\"\n      | extend UserAgent = tostring(AdditionalDetail.value)\n  )\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n// The below line is currently commented out but Microsoft Sentinel users can modify this query to show only Application or only Service Principal events in their environment\n//| where targetType =~ \"Application\" // or targetType =~ \"ServicePrincipal\"\n| project-away diff, new_value_set, old_value_set\n| project-reorder TimeGenerated, OperationName, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingIpAddress, UserAgent, targetDisplayName, targetId, targetType, keyDisplayName, keyType, keyUsage, keyIdentifier, CorrelationId, TenantId\n| extend Name = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "DefenseEvasion"
                                ],
                                "subTechniques": [
                                  "T1550.001"
                                ],
                                "techniques": [
                                  "T1550"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject36').analyticRuleId36,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 36",
                                "parentId": "[variables('analyticRuleObject36').analyticRuleId36]",
                                "contentId": "[variables('analyticRuleObject36')._analyticRulecontentId36]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject36').analyticRuleVersion36]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject36')._analyticRulecontentId36]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "New access credential added to Application or Service Principal",
                        "contentProductId": "[variables('analyticRuleObject36')._analyticRulecontentProductId36]",
                        "id": "[variables('analyticRuleObject36')._analyticRulecontentProductId36]",
                        "version": "[variables('analyticRuleObject36').analyticRuleVersion36]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject37').analyticRuleTemplateSpecName37]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "NRT_ADFSDomainTrustMods_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject37').analyticRuleVersion37]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject37')._analyticRulecontentId37]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "NRT",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This will alert when a user or application modifies the federation settings on the domain or Update domain authentication from Managed to Federated.\nFor example, this alert will trigger when a new Active Directory Federated Service (ADFS) TrustedRealm object, such as a signing certificate, is added to the domain.\nModification to domain federation settings should be rare. Confirm the added or modified target domain/URL is legitimate administrator behavior.\nTo understand why an authorized user may update settings for a federated domain in Office 365, Azure, or Intune, see: https://docs.microsoft.com/office365/troubleshoot/active-directory/update-federated-domain-office-365.\nFor details on security realms that accept security tokens, see the ADFS Proxy Protocol (MS-ADFSPP) specification: https://docs.microsoft.com/openspecs/windows_protocols/ms-adfspp/e7b9ea73-1980-4318-96a6-da559486664b.\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.",
                                "displayName": "NRT Modified domain federation trust settings",
                                "enabled": false,
                                "query": "AuditLogs\n| where OperationName =~ \"Set federation settings on domain\" or OperationName =~ \"Set domain authentication\"\n//| where Result =~ \"success\"   // commenting out, as it may be interesting to capture failed attempts\n| mv-expand TargetResources\n| extend modifiedProperties = parse_json(TargetResources).modifiedProperties\n| mv-apply Property = modifiedProperties on \n  (\n      where Property.displayName =~ \"LiveType\"\n      | extend targetDisplayName = tostring(Property.displayName),\n               NewDomainValue = tostring(Property.newValue)\n  )\n| extend Federated = iif(OperationName =~ \"Set domain authentication\", iif(NewDomainValue has \"Federated\", True, False), True)\n| where Federated == True\n| mv-expand AdditionalDetails\n| mv-apply AdditionalDetail = AdditionalDetails on \n  (\n      where AdditionalDetail.key =~ \"User-Agent\"\n      | extend UserAgent = tostring(AdditionalDetail.value)\n  )\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| project-reorder TimeGenerated, OperationName, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingIpAddress, AADOperationType, targetDisplayName, Result, UserAgent, CorrelationId, TenantId, AADTenantId\n| extend Name = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess",
                                  "Persistence",
                                  "PrivilegeEscalation"
                                ],
                                "techniques": [
                                  "T1555",
                                  "T1098"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject37').analyticRuleId37,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 37",
                                "parentId": "[variables('analyticRuleObject37').analyticRuleId37]",
                                "contentId": "[variables('analyticRuleObject37')._analyticRulecontentId37]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject37').analyticRuleVersion37]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject37')._analyticRulecontentId37]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "NRT Modified domain federation trust settings",
                        "contentProductId": "[variables('analyticRuleObject37')._analyticRulecontentProductId37]",
                        "id": "[variables('analyticRuleObject37')._analyticRulecontentProductId37]",
                        "version": "[variables('analyticRuleObject37').analyticRuleVersion37]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject38').analyticRuleTemplateSpecName38]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "NRT_AuthenticationMethodsChangedforVIPUsers_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject38').analyticRuleVersion38]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject38')._analyticRulecontentId38]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "NRT",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies authentication methods being changed for a list of VIP users watchlist. This could be an indication of an attacker adding an auth method to the account so they can have continued access.",
                                "displayName": "NRT Authentication Methods Changed for VIP Users",
                                "enabled": false,
                                "query": "let security_info_actions = dynamic([\"User registered security info\", \"User changed default security info\", \"User deleted security info\", \"Admin updated security info\", \"User reviewed security info\", \"Admin deleted security info\", \"Admin registered security info\"]);\nlet VIPUsers = (_GetWatchlist('VIPUsers') | distinct \"User Principal Name\");\nAuditLogs\n| where Category =~ \"UserManagement\"\n| where ActivityDisplayName in (security_info_actions)\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"User\"\n      | extend Target = trim(@'\"',tolower(tostring(TargetResource.userPrincipalName)))\n  )\n| where Target in~ (VIPUsers)\n| summarize Start=min(TimeGenerated), End=max(TimeGenerated), Actions = make_set(ResultReason) by InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingIpAddress, Result, Target\n| extend TargetName = tostring(split(Target,'@',0)[0]), TargetUPNSuffix = tostring(split(Target,'@',1)[0])\n| extend InitiatedByName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), InitiatedByUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Persistence"
                                ],
                                "techniques": [
                                  "T1098"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Target",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "TargetName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "TargetUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatedByName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatedByUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject38').analyticRuleId38,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 38",
                                "parentId": "[variables('analyticRuleObject38').analyticRuleId38]",
                                "contentId": "[variables('analyticRuleObject38')._analyticRulecontentId38]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject38').analyticRuleVersion38]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject38')._analyticRulecontentId38]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "NRT Authentication Methods Changed for VIP Users",
                        "contentProductId": "[variables('analyticRuleObject38')._analyticRulecontentProductId38]",
                        "id": "[variables('analyticRuleObject38')._analyticRulecontentProductId38]",
                        "version": "[variables('analyticRuleObject38').analyticRuleVersion38]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject39').analyticRuleTemplateSpecName39]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "nrt_FirstAppOrServicePrincipalCredential_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject39').analyticRuleVersion39]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject39')._analyticRulecontentId39]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "NRT",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This will alert when an admin or app owner account adds a new credential to an Application or Service Principal where there was no previous verify KeyCredential associated.\nIf a threat actor obtains access to an account with sufficient privileges and adds the alternate authentication material triggering this event, the threat actor can now authenticate as the Application or Service Principal using this credential.\nAdditional information on OAuth Credential Grants can be found in RFC 6749 Section 4.4 or https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.",
                                "displayName": "NRT First access credential added to Application or Service Principal where no credential was present",
                                "enabled": false,
                                "query": "AuditLogs\n| where OperationName has_any (\"Add service principal\", \"Certificates and secrets management\")\n| where Result =~ \"success\"\n| where tostring(InitiatedBy.user.userPrincipalName) has \"@\" or tostring(InitiatedBy.app.displayName) has \"@\"\n| mv-apply TargetResource = TargetResources on \n  (\n    where TargetResource.type =~ \"Application\"\n    | extend targetDisplayName = tostring(TargetResource.displayName),\n             targetId = tostring(TargetResource.id),\n             targetType = tostring(TargetResource.type),\n             keyEvents = TargetResource.modifiedProperties\n  )\n|  mv-apply Property = keyEvents on \n (\n  where Property.displayName =~ \"KeyDescription\"\n  | extend new_value_set = parse_json(tostring(Property.newValue)),\n           old_value_set = parse_json(tostring(Property.oldValue))\n )\n| where old_value_set == \"[]\"\n| mv-expand new_value_set\n| parse new_value_set with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *\n| where keyUsage == \"Verify\"\n | mv-apply AdditionalDetail = AdditionalDetails on \n  (\n    where AdditionalDetail.key =~ \"User-Agent\"\n    | extend UserAgent = tostring(AdditionalDetail.value)\n  )\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n//| where targetType =~ \"Application\" // or targetType =~ \"ServicePrincipal\"\n| project-away new_value_set, old_value_set\n| project-reorder TimeGenerated, OperationName, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingIpAddress, UserAgent, targetDisplayName, targetId, targetType, keyDisplayName, keyType, keyUsage, keyIdentifier, CorrelationId, TenantId\n| extend InitiatedByName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), InitiatedByUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "DefenseEvasion"
                                ],
                                "subTechniques": [
                                  "T1550.001"
                                ],
                                "techniques": [
                                  "T1550"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatedByName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatedByUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject39').analyticRuleId39,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 39",
                                "parentId": "[variables('analyticRuleObject39').analyticRuleId39]",
                                "contentId": "[variables('analyticRuleObject39')._analyticRulecontentId39]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject39').analyticRuleVersion39]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject39')._analyticRulecontentId39]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "NRT First access credential added to Application or Service Principal where no credential was present",
                        "contentProductId": "[variables('analyticRuleObject39')._analyticRulecontentProductId39]",
                        "id": "[variables('analyticRuleObject39')._analyticRulecontentProductId39]",
                        "version": "[variables('analyticRuleObject39').analyticRuleVersion39]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject40').analyticRuleTemplateSpecName40]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "NRT_NewAppOrServicePrincipalCredential_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject40').analyticRuleVersion40]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject40')._analyticRulecontentId40]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "NRT",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This will alert when an admin or app owner account adds a new credential to an Application or Service Principal where a verify KeyCredential was already present for the app.\nIf a threat actor obtains access to an account with sufficient privileges and adds the alternate authentication material triggering this event, the threat actor can now authenticate as the Application or Service Principal using this credential.\nAdditional information on OAuth Credential Grants can be found in RFC 6749 Section 4.4 or https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.",
                                "displayName": "NRT New access credential added to Application or Service Principal",
                                "enabled": false,
                                "query": "AuditLogs\n| where OperationName has_any (\"Add service principal\", \"Certificates and secrets management\") // captures \"Add service principal\", \"Add service principal credentials\", and \"Update application - Certificates and secrets management\" events\n| where Result =~ \"success\"\n| where tostring(InitiatedBy.user.userPrincipalName) has \"@\" or tostring(InitiatedBy.app.displayName) has \"@\"\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"Application\"\n      | extend targetDisplayName = tostring(TargetResource.displayName),\n               targetId = tostring(TargetResource.id),\n               targetType = tostring(TargetResource.type),\n               keyEvents = TargetResource.modifiedProperties\n  )\n| mv-apply Property = keyEvents on \n  (\n      where Property.displayName =~ \"KeyDescription\"\n      | extend new_value_set = parse_json(tostring(Property.newValue)),\n               old_value_set = parse_json(tostring(Property.oldValue))\n  )\n| where old_value_set != \"[]\"\n| extend diff = set_difference(new_value_set, old_value_set)\n| where diff != \"[]\"\n| parse diff with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *\n| where keyUsage =~ \"Verify\"\n| mv-apply AdditionalDetail = AdditionalDetails on \n  (\n      where AdditionalDetail.key =~ \"User-Agent\"\n      | extend UserAgent = tostring(AdditionalDetail.value)\n  )\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n// The below line is currently commented out but Microsoft Sentinel users can modify this query to show only Application or only Service Principal events in their environment\n//| where targetType =~ \"Application\" // or targetType =~ \"ServicePrincipal\"\n| project-away diff, new_value_set, old_value_set\n| project-reorder TimeGenerated, OperationName, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingIpAddress, UserAgent, targetDisplayName, targetId, targetType, keyDisplayName, keyType, keyUsage, keyIdentifier, CorrelationId, TenantId\n| extend InitiatedByName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), InitiatedByUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "DefenseEvasion"
                                ],
                                "techniques": [
                                  "T1550"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatedByName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatedByUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject40').analyticRuleId40,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 40",
                                "parentId": "[variables('analyticRuleObject40').analyticRuleId40]",
                                "contentId": "[variables('analyticRuleObject40')._analyticRulecontentId40]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject40').analyticRuleVersion40]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject40')._analyticRulecontentId40]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "NRT New access credential added to Application or Service Principal",
                        "contentProductId": "[variables('analyticRuleObject40')._analyticRulecontentProductId40]",
                        "id": "[variables('analyticRuleObject40')._analyticRulecontentProductId40]",
                        "version": "[variables('analyticRuleObject40').analyticRuleVersion40]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject41').analyticRuleTemplateSpecName41]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "NRT_PIMElevationRequestRejected_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject41').analyticRuleVersion41]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject41')._analyticRulecontentId41]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "NRT",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies when a user is rejected for a privileged role elevation via PIM. Monitor rejections for indicators of attacker compromise of the requesting account.\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-identity-management",
                                "displayName": "NRT PIM Elevation Request Rejected",
                                "enabled": false,
                                "query": "AuditLogs\n| where ActivityDisplayName =~ 'Add member to role request denied (PIM activation)'\n| mv-apply ResourceItem = TargetResources on \n  (\n      where ResourceItem.type =~ \"Role\"\n      | extend Role = trim(@'\"',tostring(ResourceItem.displayName))\n  )\n| mv-apply ResourceItem = TargetResources on \n  (\n      where ResourceItem.type =~ \"User\"\n      | extend TargetUserPrincipalName = trim(@'\"',tostring(ResourceItem.userPrincipalName))\n  )\n| where ResultReason != \"RoleAssignmentExists\"\n| where isnotempty(InitiatedBy.user)\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend TargetName = tostring(split(TargetUserPrincipalName,'@',0)[0]), TargetUPNSuffix = tostring(split(TargetUserPrincipalName,'@',1)[0])\n| extend InitiatedByName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), InitiatedByUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n| project-reorder TimeGenerated, TargetUserPrincipalName, Role, OperationName, Result, ResultDescription\n",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Persistence"
                                ],
                                "subTechniques": [
                                  "T1078.004"
                                ],
                                "techniques": [
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "TargetUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "TargetName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "TargetUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatedByName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatedByUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject41').analyticRuleId41,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 41",
                                "parentId": "[variables('analyticRuleObject41').analyticRuleId41]",
                                "contentId": "[variables('analyticRuleObject41')._analyticRulecontentId41]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject41').analyticRuleVersion41]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject41')._analyticRulecontentId41]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "NRT PIM Elevation Request Rejected",
                        "contentProductId": "[variables('analyticRuleObject41')._analyticRulecontentProductId41]",
                        "id": "[variables('analyticRuleObject41')._analyticRulecontentProductId41]",
                        "version": "[variables('analyticRuleObject41').analyticRuleVersion41]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject42').analyticRuleTemplateSpecName42]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "NRT_PrivlegedRoleAssignedOutsidePIM_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject42').analyticRuleVersion42]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject42')._analyticRulecontentId42]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "NRT",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies a privileged role being assigned to a user outside of PIM\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-accounts#things-to-monitor-1",
                                "displayName": "NRT Privileged Role Assigned Outside PIM",
                                "enabled": false,
                                "query": "AuditLogs\n| where Category =~ \"RoleManagement\"\n| where OperationName has \"Add member to role outside of PIM\"\n        or (LoggedByService =~ \"Core Directory\" and OperationName =~ \"Add member to role\" and Identity != \"MS-PIM\" and Identity != \"MS-PIM-Fairfax\")\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"User\"\n      | extend TargetUserPrincipalName = tostring(TargetResource.userPrincipalName)\n  )\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend TargetName = tostring(split(TargetUserPrincipalName,'@',0)[0]), TargetUPNSuffix = tostring(split(TargetUserPrincipalName,'@',1)[0])\n| extend InitiatedByName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), InitiatedByUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "PrivilegeEscalation"
                                ],
                                "subTechniques": [
                                  "T1078.004"
                                ],
                                "techniques": [
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "TargetUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "TargetName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "TargetUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatedByName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatedByUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject42').analyticRuleId42,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 42",
                                "parentId": "[variables('analyticRuleObject42').analyticRuleId42]",
                                "contentId": "[variables('analyticRuleObject42')._analyticRulecontentId42]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject42').analyticRuleVersion42]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject42')._analyticRulecontentId42]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "NRT Privileged Role Assigned Outside PIM",
                        "contentProductId": "[variables('analyticRuleObject42')._analyticRulecontentProductId42]",
                        "id": "[variables('analyticRuleObject42')._analyticRulecontentProductId42]",
                        "version": "[variables('analyticRuleObject42').analyticRuleVersion42]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject43').analyticRuleTemplateSpecName43]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "NRT_UseraddedtoPrivilgedGroups_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject43').analyticRuleVersion43]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject43')._analyticRulecontentId43]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "NRT",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This will alert when a user is added to any of the Privileged Groups.\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.\nFor Administrator role permissions in Microsoft Entra ID please see https://docs.microsoft.com/azure/active-directory/users-groups-roles/directory-assign-admin-roles",
                                "displayName": "NRT User added to Microsoft Entra ID Privileged Groups",
                                "enabled": false,
                                "query": "let OperationList = dynamic([\"Add member to role\",\"Add eligible member to role\"]);\nlet PrivilegedGroups = dynamic([\"UserAccountAdmins\",\"PrivilegedRoleAdmins\",\"TenantAdmins\",\"PrivilegedAuthenticationAdmins\"]);\nAuditLogs\n| where Category =~ \"RoleManagement\"\n| where OperationName in~ (OperationList)\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"User\"\n      | extend TargetUserPrincipalName = tostring(TargetResource.userPrincipalName),\n               modProps = TargetResource.modifiedProperties\n  )\n| mv-apply Property = modProps on \n  (\n      where Property.displayName =~ \"Role.WellKnownObjectName\"\n      | extend DisplayName = trim('\"',tostring(Property.displayName)),\n               GroupName = trim('\"',tostring(Property.newValue))\n  )\n| extend InitiatingAppId = tostring(InitiatedBy.app.appId)\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingAppServicePrincipalName = tostring(InitiatedBy.app.servicePrincipalName)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))        \n| extend InitiatingUserRoles = InitiatedBy.user.roles\n| where GroupName in~ (PrivilegedGroups)\n// If you don't want to alert for operations from PIM, remove below filtering for MS-PIM.\n//| where InitiatingAppName != \"MS-PIM\" and InitiatingAppName != \"MS-PIM-Fairfax\"\n| project TimeGenerated, AADOperationType, Category, OperationName, AADTenantId, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingAppName, InitiatingAppId, InitiatingAppServicePrincipalId, InitiatingIpAddress, InitiatingUserRoles, DisplayName, GroupName, TargetUserPrincipalName\n| extend InitiatedByName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), InitiatedByUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n| extend TargetName = tostring(split(TargetUserPrincipalName,'@',0)[0]), TargetUPNSuffix = tostring(split(TargetUserPrincipalName,'@',1)[0])\n",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Persistence",
                                  "PrivilegeEscalation"
                                ],
                                "techniques": [
                                  "T1098",
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatedByName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatedByUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "TargetUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "TargetName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "TargetUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject43').analyticRuleId43,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 43",
                                "parentId": "[variables('analyticRuleObject43').analyticRuleId43]",
                                "contentId": "[variables('analyticRuleObject43')._analyticRulecontentId43]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject43').analyticRuleVersion43]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject43')._analyticRulecontentId43]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "NRT User added to Microsoft Entra ID Privileged Groups",
                        "contentProductId": "[variables('analyticRuleObject43')._analyticRulecontentProductId43]",
                        "id": "[variables('analyticRuleObject43')._analyticRulecontentProductId43]",
                        "version": "[variables('analyticRuleObject43').analyticRuleVersion43]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject44').analyticRuleTemplateSpecName44]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "PIMElevationRequestRejected_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject44').analyticRuleVersion44]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject44')._analyticRulecontentId44]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies when a user is rejected for a privileged role elevation via PIM. Monitor rejections for indicators of attacker compromise of the requesting account.\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-identity-management",
                                "displayName": "PIM Elevation Request Rejected",
                                "enabled": false,
                                "query": "AuditLogs\n| where ActivityDisplayName =~'Add member to role request denied (PIM activation)'\n| mv-apply ResourceItem = TargetResources on \n  (\n      where ResourceItem.type =~ \"Role\"\n      | extend Role = trim(@'\"',tostring(ResourceItem.displayName))\n  )\n| mv-apply ResourceItem = TargetResources on \n  (\n      where ResourceItem.type =~ \"User\"\n      | extend TargetUserPrincipalName = trim(@'\"',tostring(ResourceItem.userPrincipalName))\n  )\n| where isnotempty(InitiatedBy.user)\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend TargetName = tostring(split(TargetUserPrincipalName,'@',0)[0]), TargetUPNSuffix = tostring(split(TargetUserPrincipalName,'@',1)[0])\n| extend InitiatedByName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), InitiatedByUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n| project-reorder TimeGenerated, TargetUserPrincipalName, Role, OperationName, Result, ResultDescription\n",
                                "queryFrequency": "PT2H",
                                "queryPeriod": "PT2H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Persistence"
                                ],
                                "subTechniques": [
                                  "T1078.004"
                                ],
                                "techniques": [
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatedByName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatedByUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "TargetUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "TargetName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "TargetUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject44').analyticRuleId44,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 44",
                                "parentId": "[variables('analyticRuleObject44').analyticRuleId44]",
                                "contentId": "[variables('analyticRuleObject44')._analyticRulecontentId44]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject44').analyticRuleVersion44]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject44')._analyticRulecontentId44]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "PIM Elevation Request Rejected",
                        "contentProductId": "[variables('analyticRuleObject44')._analyticRulecontentProductId44]",
                        "id": "[variables('analyticRuleObject44')._analyticRulecontentProductId44]",
                        "version": "[variables('analyticRuleObject44').analyticRuleVersion44]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject45').analyticRuleTemplateSpecName45]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "PossibleSignInfromAzureBackdoor_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject45').analyticRuleVersion45]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject45')._analyticRulecontentId45]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies when a user adds an unverified domain as an authentication method, followed by a sign-in from a user the newly added domain. Threat actors may add custom domains to create a backdoor to your tenant. It's important to monitor whenever custom domains are added to the tenant.",
                                "displayName": "Possible SignIn from Azure Backdoor",
                                "enabled": false,
                                "query": "// Microsoft Entra ID  Backdoors: Identity Federation\n//Ref: https://www.inversecos.com/2021/11/how-to-detect-azure-active-directory.html\nAuditLogs\n| where OperationName == \"Add unverified domain\"\n| where Result == \"success\"\n| extend InitiatedBy = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\n| extend DomainName = tostring(TargetResources[0].displayName)\n| summarize DomainAddedTime = min(TimeGenerated), ModifiedProperties = make_set(parse_json(TargetResources[0].modifiedProperties),1048576) by InitiatedBy, DomainName\n| join kind=inner (\nSigninLogs\n| where ResultType == \"0\"\n| extend UserDomain = tostring(parse_json(split(UserPrincipalName,\"@\",1)[0]))\n| summarize SignInTime = min(TimeGenerated)  by UserPrincipalName, IPAddress, tostring(LocationDetails),AppDisplayName,ResourceDisplayName,UserDomain\n) on $left.DomainName == $right.UserDomain\n// Getting UserName and Domain\n| extend Name = split(UserPrincipalName,\"@\",0), Domain = split(UserPrincipalName,\"@\",1)\n| mv-expand Name,Domain\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs",
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Persistence"
                                ],
                                "techniques": [
                                  "T1098"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserDomain",
                                        "identifier": "NTDomain"
                                      },
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ],
                                "customDetails": {
                                  "SignInTime": "SignInTime",
                                  "AppDisplayName": "AppDisplayName",
                                  "DomainAdded": "DomainName",
                                  "DomainAddedTime": "DomainAddedTime",
                                  "InitiatedBy": "InitiatedBy",
                                  "ModifiedProperties": "ModifiedProperties",
                                  "ResourceDisplayName": "ResourceDisplayName"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject45').analyticRuleId45,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 45",
                                "parentId": "[variables('analyticRuleObject45').analyticRuleId45]",
                                "contentId": "[variables('analyticRuleObject45')._analyticRulecontentId45]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject45').analyticRuleVersion45]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject45')._analyticRulecontentId45]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Possible SignIn from Azure Backdoor",
                        "contentProductId": "[variables('analyticRuleObject45')._analyticRulecontentProductId45]",
                        "id": "[variables('analyticRuleObject45')._analyticRulecontentProductId45]",
                        "version": "[variables('analyticRuleObject45').analyticRuleVersion45]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject46').analyticRuleTemplateSpecName46]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "PrivilegedAccountsSigninFailureSpikes_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject46').analyticRuleVersion46]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject46')._analyticRulecontentId46]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": " Identifies spike in failed sign-ins from Privileged accounts. Privileged accounts list can be based on IdentityInfo UEBA table.\nSpike is determined based on Time series anomaly which will look at historical baseline values.\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-accounts#things-to-monitor",
                                "displayName": "Privileged Accounts - Sign in Failure Spikes",
                                "enabled": false,
                                "query": "let starttime = 14d;\nlet timeframe = 1d;\nlet scorethreshold = 3;\nlet baselinethreshold = 5;\nlet aadFunc = (tableName:string){\n    IdentityInfo\n    | where TimeGenerated > ago(starttime)\n    | summarize arg_max(TimeGenerated, *) by AccountUPN\n    | mv-expand AssignedRoles\n    | where AssignedRoles contains 'Admin' or GroupMembership has \"Admin\"\n    | summarize Roles = make_list(AssignedRoles) by AccountUPN = tolower(AccountUPN)\n    | join kind=inner (\n        table(tableName)\n        | where TimeGenerated between (startofday(ago(starttime))..startofday(now()))\n        | where ResultType != 0\n        | extend UserPrincipalName = tolower(UserPrincipalName)\n    ) on $left.AccountUPN == $right.UserPrincipalName\n    | extend timestamp = TimeGenerated, AccountCustomEntity = UserPrincipalName, Roles = tostring(Roles)\n};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nlet allSignins = union isfuzzy=true aadSignin, aadNonInt;\nlet TimeSeriesAlerts = \n    allSignins\n    | make-series HourlyCount=count() on TimeGenerated from startofday(ago(starttime)) to startofday(now()) step 1h by UserPrincipalName, Roles\n    | extend (anomalies, score, baseline) = series_decompose_anomalies(HourlyCount, scorethreshold, -1, 'linefit')\n    | mv-expand HourlyCount to typeof(double), TimeGenerated to typeof(datetime), anomalies to typeof(double), score to typeof(double), baseline to typeof(long)\n    // Filtering low count events per baselinethreshold\n    | where anomalies > 0 and baseline > baselinethreshold\n    | extend AnomalyHour = TimeGenerated\n    | project UserPrincipalName, Roles, AnomalyHour, TimeGenerated, HourlyCount, baseline, anomalies, score;\n// Filter the alerts for specified timeframe\nTimeSeriesAlerts\n| where TimeGenerated > startofday(ago(timeframe))\n| join kind=inner ( \n    allSignins\n    | where TimeGenerated > startofday(ago(timeframe))\n    // create a new column and round to hour\n    | extend DateHour = bin(TimeGenerated, 1h)\n    | summarize PartialFailedSignins = count(), LatestAnomalyTime = arg_max(TimeGenerated, *) by bin(TimeGenerated, 1h), OperationName, Category, ResultType, ResultDescription, UserPrincipalName, Roles, UserDisplayName, AppDisplayName, ClientAppUsed, IPAddress, ResourceDisplayName\n) on UserPrincipalName, $left.AnomalyHour == $right.DateHour\n| project LatestAnomalyTime, OperationName, Category, UserPrincipalName, Roles = todynamic(Roles), UserDisplayName, ResultType, ResultDescription, AppDisplayName, ClientAppUsed, UserAgent, IPAddress, Location, AuthenticationRequirement, ConditionalAccessStatus, ResourceDisplayName, PartialFailedSignins, TotalFailedSignins = HourlyCount, baseline, anomalies, score\n| extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P14D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AADNonInteractiveUserSignInLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "BehaviorAnalytics",
                                    "dataTypes": [
                                      "IdentityInfo"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess"
                                ],
                                "subTechniques": [
                                  "T1078.004"
                                ],
                                "techniques": [
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject46').analyticRuleId46,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 46",
                                "parentId": "[variables('analyticRuleObject46').analyticRuleId46]",
                                "contentId": "[variables('analyticRuleObject46')._analyticRulecontentId46]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject46').analyticRuleVersion46]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject46')._analyticRulecontentId46]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Privileged Accounts - Sign in Failure Spikes",
                        "contentProductId": "[variables('analyticRuleObject46')._analyticRulecontentProductId46]",
                        "id": "[variables('analyticRuleObject46')._analyticRulecontentProductId46]",
                        "version": "[variables('analyticRuleObject46').analyticRuleVersion46]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject47').analyticRuleTemplateSpecName47]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "PrivlegedRoleAssignedOutsidePIM_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject47').analyticRuleVersion47]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject47')._analyticRulecontentId47]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies a privileged role being assigned to a user outside of PIM\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-accounts#things-to-monitor-1",
                                "displayName": "Privileged Role Assigned Outside PIM",
                                "enabled": false,
                                "query": "AuditLogs\n| where Category =~ \"RoleManagement\"\n| where OperationName has \"Add member to role outside of PIM\"\n        or (LoggedByService =~ \"Core Directory\" and OperationName =~ \"Add member to role\" and Identity != \"MS-PIM\" and Identity != \"MS-PIM-Fairfax\")\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"User\"\n      | extend TargetUserPrincipalName = tostring(TargetResource.userPrincipalName)\n  )\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend TargetName = tostring(split(TargetUserPrincipalName,'@',0)[0]), TargetUPNSuffix = tostring(split(TargetUserPrincipalName,'@',1)[0])\n| extend InitiatedByName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), InitiatedByUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "PrivilegeEscalation"
                                ],
                                "subTechniques": [
                                  "T1078.004"
                                ],
                                "techniques": [
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatedByName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatedByUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "TargetUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "TargetName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "TargetUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject47').analyticRuleId47,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 47",
                                "parentId": "[variables('analyticRuleObject47').analyticRuleId47]",
                                "contentId": "[variables('analyticRuleObject47')._analyticRulecontentId47]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject47').analyticRuleVersion47]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject47')._analyticRulecontentId47]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Privileged Role Assigned Outside PIM",
                        "contentProductId": "[variables('analyticRuleObject47')._analyticRulecontentProductId47]",
                        "id": "[variables('analyticRuleObject47')._analyticRulecontentProductId47]",
                        "version": "[variables('analyticRuleObject47').analyticRuleVersion47]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject48').analyticRuleTemplateSpecName48]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "RareApplicationConsent_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject48').analyticRuleVersion48]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject48')._analyticRulecontentId48]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This will alert when the \"Consent to application\" operation occurs by a user that has not done this operation before or rarely does this.\nThis could indicate that permissions to access the listed Azure App were provided to a malicious actor.\nConsent to application, Add service principal and Add OAuth2PermissionGrant should typically be rare events.\nThis may help detect the Oauth2 attack that can be initiated by this publicly available tool - https://github.com/fireeye/PwnAuth\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.",
                                "displayName": "Rare application consent",
                                "enabled": false,
                                "query": "let current = 1d;\nlet auditLookback = 7d;\n// Setting threshold to 3 as a default, change as needed.\n// Any operation that has been initiated by a user or app more than 3 times in the past 7 days will be excluded\nlet threshold = 3;\n// Gather initial data from lookback period, excluding current, adjust current to more than a single day if no results\nlet AuditTrail = AuditLogs | where TimeGenerated >= ago(auditLookback) and TimeGenerated < ago(current)\n// 2 other operations that can be part of malicious activity in this situation are\n// \"Add OAuth2PermissionGrant\" and \"Add service principal\", extend the filter below to capture these too\n| where OperationName has \"Consent to application\"\n| extend InitiatedBy = iff(isnotempty(tostring(InitiatedBy.user.userPrincipalName)),\n          tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"ServicePrincipal\"\n      | extend TargetResourceName = tolower(tostring(TargetResource.displayName))\n  )\n| summarize max(TimeGenerated), OperationCount = count() by OperationName, InitiatedBy, TargetResourceName\n// only including operations initiated by a user or app that is above the threshold so we produce only rare and has not occurred in last 7 days\n| where OperationCount > threshold;\n// Gather current period of audit data\nlet RecentConsent = AuditLogs | where TimeGenerated >= ago(current)\n| where OperationName has \"Consent to application\"\n| extend IpAddress = case(\n              isnotempty(tostring(InitiatedBy.user.ipAddress)) and tostring(InitiatedBy.user.ipAddress) != 'null', tostring(InitiatedBy.user.ipAddress),\n              isnotempty(tostring(InitiatedBy.app.ipAddress)) and tostring(InitiatedBy.app.ipAddress) != 'null', tostring(InitiatedBy.app.ipAddress),\n              'Not Available')\n| extend InitiatedBy = iff(isnotempty(tostring(InitiatedBy.user.userPrincipalName)),\n                          tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"ServicePrincipal\"\n      | extend TargetResourceName = tolower(tostring(TargetResource.displayName)),\n               props = TargetResource.modifiedProperties\n  )\n| parse props with * \"ConsentType: \" ConsentType \"]\" *\n| mv-apply AdditionalDetail = AdditionalDetails on \n  (\n      where AdditionalDetail.key =~ \"User-Agent\"\n      | extend UserAgent = tostring(AdditionalDetail.value)\n  )\n| project TimeGenerated, InitiatedBy, IpAddress, TargetResourceName, Category, OperationName, ConsentType, UserAgent, CorrelationId, Type;\n// Exclude previously seen audit activity for \"Consent to application\" that was seen in the lookback period\n// First for rare InitiatedBy\nlet RareConsentBy = RecentConsent | join kind= leftanti AuditTrail on OperationName, InitiatedBy\n| extend Reason = \"Previously unseen user consenting\";\n// Second for rare TargetResourceName\nlet RareConsentApp = RecentConsent | join kind= leftanti AuditTrail on OperationName, TargetResourceName\n| extend Reason = \"Previously unseen app granted consent\";\nRareConsentBy | union RareConsentApp\n| summarize Reason = make_set(Reason,100) by TimeGenerated, InitiatedBy, IpAddress, TargetResourceName, Category, OperationName, ConsentType, UserAgent, CorrelationId, Type\n| extend timestamp = TimeGenerated, Name = tolower(tostring(split(InitiatedBy,'@',0)[0])), UPNSuffix = tolower(tostring(split(InitiatedBy,'@',1)[0]))\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P7D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 3,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Persistence",
                                  "PrivilegeEscalation"
                                ],
                                "techniques": [
                                  "T1136",
                                  "T1068"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatedBy",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "TargetResourceName",
                                        "identifier": "Name"
                                      }
                                    ],
                                    "entityType": "CloudApplication"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject48').analyticRuleId48,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 48",
                                "parentId": "[variables('analyticRuleObject48').analyticRuleId48]",
                                "contentId": "[variables('analyticRuleObject48')._analyticRulecontentId48]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject48').analyticRuleVersion48]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject48')._analyticRulecontentId48]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Rare application consent",
                        "contentProductId": "[variables('analyticRuleObject48')._analyticRulecontentProductId48]",
                        "id": "[variables('analyticRuleObject48')._analyticRulecontentProductId48]",
                        "version": "[variables('analyticRuleObject48').analyticRuleVersion48]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject49').analyticRuleTemplateSpecName49]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "SeamlessSSOPasswordSpray_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject49').analyticRuleVersion49]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject49')._analyticRulecontentId49]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This query detects when there is a spike in Microsoft Entra ID Seamless SSO errors. They may not be caused by a Password Spray attack, but the cause of the errors might need to be investigated.\nMicrosoft Entra ID only logs the requests that matched existing accounts, thus there might have been unlogged requests for non-existing accounts.",
                                "displayName": "Password spray attack against Microsoft Entra ID Seamless SSO",
                                "enabled": false,
                                "query": "let account_threshold = 5;\nAADNonInteractiveUserSignInLogs\n//| where ResultType == \"81016\"\n| where ResultType startswith \"81\"\n| summarize DistinctAccounts = dcount(UserPrincipalName), DistinctAddresses = make_set(IPAddress,100) by ResultType\n| where DistinctAccounts > account_threshold\n| mv-expand IPAddress = DistinctAddresses\n| extend IPAddress = tostring(IPAddress)\n| join kind=leftouter (union isfuzzy=true SigninLogs, AADNonInteractiveUserSignInLogs) on IPAddress\n| summarize\n    StartTime = min(TimeGenerated),\n    EndTime = max(TimeGenerated),\n    UserPrincipalName = make_set(UserPrincipalName,100),\n    UserAgent = make_set(UserAgent,100),\n    ResultDescription = take_any(ResultDescription),\n    ResultSignature = take_any(ResultSignature)\n    by IPAddress, Type, ResultType\n| project Type, StartTime, EndTime, IPAddress, ResultType, ResultDescription, ResultSignature, UserPrincipalName, UserAgent = iff(array_length(UserAgent) == 1, UserAgent[0], UserAgent)\n| extend Name = tostring(split(UserPrincipalName[0],'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName[0],'@',1)[0])\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AADNonInteractiveUserSignInLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess"
                                ],
                                "techniques": [
                                  "T1110"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject49').analyticRuleId49,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 49",
                                "parentId": "[variables('analyticRuleObject49').analyticRuleId49]",
                                "contentId": "[variables('analyticRuleObject49')._analyticRulecontentId49]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject49').analyticRuleVersion49]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject49')._analyticRulecontentId49]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Password spray attack against Microsoft Entra ID Seamless SSO",
                        "contentProductId": "[variables('analyticRuleObject49')._analyticRulecontentProductId49]",
                        "id": "[variables('analyticRuleObject49')._analyticRulecontentProductId49]",
                        "version": "[variables('analyticRuleObject49').analyticRuleVersion49]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject50').analyticRuleTemplateSpecName50]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Sign-in Burst from Multiple Locations_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject50').analyticRuleVersion50]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject50')._analyticRulecontentId50]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This detection triggers when there is a Signin burst from multiple locations in GitHub (Entra ID SSO).\n This detection is based on configurable threshold which can be prone to false positives. To view the anomaly based equivalent of thie detection, please see here https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Microsoft%20Entra%20ID/Analytic%20Rules/AnomalousUserAppSigninLocationIncrease-detection.yaml. ",
                                "displayName": "GitHub Signin Burst from Multiple Locations",
                                "enabled": false,
                                "query": "let locationThreshold = 1;\nlet aadFunc = (tableName:string){\ntable(tableName)\n| where AppDisplayName =~ \"GitHub.com\"\n| where ResultType == 0\n| summarize CountOfLocations = dcount(Location), Locations = make_set(Location,100), BurstStartTime = min(TimeGenerated), BurstEndTime = max(TimeGenerated) by UserPrincipalName, Type\n| where CountOfLocations > locationThreshold\n| extend timestamp = BurstStartTime\n};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nunion isfuzzy=true aadSignin, aadNonInt\n| extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AADNonInteractiveUserSignInLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess"
                                ],
                                "techniques": [
                                  "T1110"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject50').analyticRuleId50,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 50",
                                "parentId": "[variables('analyticRuleObject50').analyticRuleId50]",
                                "contentId": "[variables('analyticRuleObject50')._analyticRulecontentId50]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject50').analyticRuleVersion50]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject50')._analyticRulecontentId50]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "GitHub Signin Burst from Multiple Locations",
                        "contentProductId": "[variables('analyticRuleObject50')._analyticRulecontentProductId50]",
                        "id": "[variables('analyticRuleObject50')._analyticRulecontentProductId50]",
                        "version": "[variables('analyticRuleObject50').analyticRuleVersion50]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject51').analyticRuleTemplateSpecName51]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "SigninAttemptsByIPviaDisabledAccounts_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject51').analyticRuleVersion51]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject51')._analyticRulecontentId51]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies IPs with failed attempts to sign in to one or more disabled accounts using the IP through which successful signins from other accounts have happened.\nThis could indicate an attacker who obtained credentials for a list of accounts and is attempting to login with those accounts, some of which may have already been disabled.\nReferences: https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-sign-ins-error-codes\n50057 - User account is disabled. The account has been disabled by an administrator.\nThis query has also been updated to include UEBA logs IdentityInfo and BehaviorAnalytics for contextual information around the results.",
                                "displayName": "Sign-ins from IPs that attempt sign-ins to disabled accounts",
                                "enabled": false,
                                "query": "let aadFunc = (tableName: string) {\nlet failed_signins = table(tableName)\n| where ResultType == \"50057\"\n| where ResultDescription == \"User account is disabled. The account has been disabled by an administrator.\";\nlet disabled_users = failed_signins | summarize by UserPrincipalName;\ntable(tableName)\n  | where ResultType == 0\n  | where isnotempty(UserPrincipalName)\n  | where UserPrincipalName !in (disabled_users)\n| summarize\n        successfulAccountsTargettedCount = dcount(UserPrincipalName),\n        successfulAccountSigninSet = make_set(UserPrincipalName, 100),\n        successfulApplicationSet = make_set(AppDisplayName, 100)\n    by IPAddress, Type\n    // Assume IPs associated with sign-ins from 100+ distinct user accounts are safe\n    | where successfulAccountsTargettedCount < 50\n    | where isnotempty(successfulAccountsTargettedCount)\n  | join kind=inner (failed_signins\n| summarize\n    StartTime = min(TimeGenerated),\n    EndTime = max(TimeGenerated),\n    totalDisabledAccountLoginAttempts = count(),\n    disabledAccountsTargettedCount = dcount(UserPrincipalName),\n    applicationsTargeted = dcount(AppDisplayName),\n    disabledAccountSet = make_set(UserPrincipalName, 100),\n    disabledApplicationSet = make_set(AppDisplayName, 100)\nby IPAddress, Type\n| order by totalDisabledAccountLoginAttempts desc) on IPAddress\n| project StartTime, EndTime, IPAddress, totalDisabledAccountLoginAttempts, disabledAccountsTargettedCount, disabledAccountSet, disabledApplicationSet, successfulApplicationSet, successfulAccountsTargettedCount, successfulAccountSigninSet, Type\n| order by totalDisabledAccountLoginAttempts};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nunion isfuzzy=true aadSignin, aadNonInt\n| join kind=leftouter (\n    BehaviorAnalytics\n    | where ActivityType in (\"FailedLogOn\", \"LogOn\")\n    | where EventSource =~ \"Azure AD\"\n    | project UsersInsights, DevicesInsights, ActivityInsights, InvestigationPriority, SourceIPAddress, UserPrincipalName\n    | project-rename IPAddress = SourceIPAddress\n    | summarize\n        Users = make_set(UserPrincipalName, 100),\n        UsersInsights = make_set(UsersInsights, 100),\n        DevicesInsights = make_set(DevicesInsights, 100),\n        IPInvestigationPriority = sum(InvestigationPriority)\n    by IPAddress\n) on IPAddress\n| extend SFRatio = toreal(toreal(disabledAccountsTargettedCount)/toreal(successfulAccountsTargettedCount))\n| where SFRatio >= 0.5\n| sort by IPInvestigationPriority desc\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AADNonInteractiveUserSignInLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "BehaviorAnalytics",
                                    "dataTypes": [
                                      "BehaviorAnalytics"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess",
                                  "Persistence"
                                ],
                                "techniques": [
                                  "T1078",
                                  "T1098"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject51').analyticRuleId51,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 51",
                                "parentId": "[variables('analyticRuleObject51').analyticRuleId51]",
                                "contentId": "[variables('analyticRuleObject51')._analyticRulecontentId51]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject51').analyticRuleVersion51]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject51')._analyticRulecontentId51]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Sign-ins from IPs that attempt sign-ins to disabled accounts",
                        "contentProductId": "[variables('analyticRuleObject51')._analyticRulecontentProductId51]",
                        "id": "[variables('analyticRuleObject51')._analyticRulecontentProductId51]",
                        "version": "[variables('analyticRuleObject51').analyticRuleVersion51]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject52').analyticRuleTemplateSpecName52]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "SigninBruteForce-AzurePortal_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject52').analyticRuleVersion52]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject52')._analyticRulecontentId52]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Detects Azure Portal brute force attacks by monitoring for multiple authentication failures and a successful login within a 20-minute window. Default settings: 10 failures, 25 deviations.\nRef: https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-sign-ins-error-codes.",
                                "displayName": "Brute force attack against Azure Portal",
                                "enabled": false,
                                "query": "// Set threshold value for deviation\nlet threshold = 25;\n// Set the time range for the query\nlet timeRange = 24h;\n// Set the authentication window duration\nlet authenticationWindow = 20m;\n// Define a reusable function 'aadFunc' that takes a table name as input\nlet aadFunc = (tableName: string) {\n  // Query the specified table\n  table(tableName)\n  // Filter data within the last 24 hours\n  | where TimeGenerated > ago(1d)\n  // Filter records related to \"Azure Portal\" applications\n  | where AppDisplayName has \"Azure Portal\"\n  // Extract and transform some fields\n  | extend\n      DeviceDetail = todynamic(DeviceDetail),\n      LocationDetails = todynamic(LocationDetails)\n  | extend\n      OS = tostring(DeviceDetail.operatingSystem),\n      Browser = tostring(DeviceDetail.browser),\n      State = tostring(LocationDetails.state),\n      City = tostring(LocationDetails.city),\n      Region = tostring(LocationDetails.countryOrRegion)\n  // Categorize records as Success or Failure based on ResultType\n  | extend FailureOrSuccess = iff(ResultType in (\"0\", \"50125\", \"50140\", \"70043\", \"70044\"), \"Success\", \"Failure\")\n  // Sort and identify sessions\n  | sort by UserPrincipalName asc, TimeGenerated asc\n  | extend SessionStartedUtc = row_window_session(TimeGenerated, timeRange, authenticationWindow, UserPrincipalName != prev(UserPrincipalName) or prev(FailureOrSuccess) == \"Success\")\n  // Summarize data\n  | summarize FailureOrSuccessCount = count() by  FailureOrSuccess, UserId, UserDisplayName, AppDisplayName, IPAddress, Browser, OS, State, City, Region, Type, CorrelationId, bin(TimeGenerated, authenticationWindow), ResultType, UserPrincipalName, SessionStartedUtc\n  | summarize FailureCountBeforeSuccess = sumif(FailureOrSuccessCount, FailureOrSuccess == \"Failure\"), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), makelist(FailureOrSuccess), IPAddress = make_set(IPAddress, 15), make_set(Browser, 15), make_set(City, 15), make_set(State, 15), make_set(Region, 15), make_set(ResultType, 15) by SessionStartedUtc, UserPrincipalName, CorrelationId, AppDisplayName, UserId, Type\n  // Filter records where \"Success\" occurs in the middle of a session\n  | where array_index_of(list_FailureOrSuccess, \"Success\") != 0\n  | where array_index_of(list_FailureOrSuccess, \"Success\") == array_length(list_FailureOrSuccess) - 1\n  // Remove unnecessary columns from the output\n  | project-away SessionStartedUtc, list_FailureOrSuccess\n  // Join with another table and calculate deviation\n  | join kind=inner (\n      table(tableName)\n      | where TimeGenerated > ago(7d)\n      | where AppDisplayName has \"Azure Portal\"\n      | extend FailureOrSuccess = iff(ResultType in (\"0\", \"50125\", \"50140\", \"70043\", \"70044\"), \"Success\", \"Failure\")\n      | summarize avgFailures = avg(todouble(FailureOrSuccess == \"Failure\")) by UserPrincipalName\n  ) on UserPrincipalName\n  | extend Deviation = abs(FailureCountBeforeSuccess - avgFailures) / avgFailures\n  // Filter records based on deviation and failure count criteria\n  | where Deviation > threshold and FailureCountBeforeSuccess >= 10\n  // Expand the IPAddress array\n  | mv-expand IPAddress\n  | extend IPAddress = tostring(IPAddress)\n  | extend timestamp = StartTime\n};\n// Call 'aadFunc' with different table names and union the results\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nunion isfuzzy=true aadSignin, aadNonInt\n// Additional transformation - Split UserPrincipalName\n| extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P7D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AADNonInteractiveUserSignInLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess"
                                ],
                                "techniques": [
                                  "T1110"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject52').analyticRuleId52,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 52",
                                "parentId": "[variables('analyticRuleObject52').analyticRuleId52]",
                                "contentId": "[variables('analyticRuleObject52')._analyticRulecontentId52]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject52').analyticRuleVersion52]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject52')._analyticRulecontentId52]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Brute force attack against Azure Portal",
                        "contentProductId": "[variables('analyticRuleObject52')._analyticRulecontentProductId52]",
                        "id": "[variables('analyticRuleObject52')._analyticRulecontentProductId52]",
                        "version": "[variables('analyticRuleObject52').analyticRuleVersion52]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject53').analyticRuleTemplateSpecName53]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "SigninPasswordSpray_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject53').analyticRuleVersion53]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject53')._analyticRulecontentId53]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies evidence of password spray activity against Microsoft Entra ID applications by looking for failures from multiple accounts from the same IP address within a time window. If the number of accounts breaches the threshold just once, all failures from the IP address within the time range are bought into the result. Details on whether there were successful authentications by the IP address within the time window are also included.\nThis can be an indicator that an attack was successful.\nThe default failure acccount threshold is 5, Default time window for failures is 20m and default look back window is 1 day\nNote: Due to the number of possible accounts involved in a password spray it is not possible to map identities to a custom entity.\nReferences: https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-sign-ins-error-codes.",
                                "displayName": "Password spray attack against Microsoft Entra ID application",
                                "enabled": false,
                                "query": "let timeRange = 1d;\nlet lookBack = 7d;\nlet authenticationWindow = 20m;\nlet authenticationThreshold = 5;\nlet isGUID = \"[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}\";\nlet failureCodes = dynamic([50053, 50126, 50055]); // invalid password, account is locked - too many sign ins, expired password\nlet successCodes = dynamic([0, 50055, 50057, 50155, 50105, 50133, 50005, 50076, 50079, 50173, 50158, 50072, 50074, 53003, 53000, 53001, 50129]);\n// Lookup up resolved identities from last 7 days\nlet aadFunc = (tableName:string){\nlet identityLookup = table(tableName)\n| where TimeGenerated >= ago(lookBack)\n| where not(Identity matches regex isGUID)\n| where isnotempty(UserId)\n| summarize by UserId, lu_UserDisplayName = UserDisplayName, lu_UserPrincipalName = UserPrincipalName, Type;\n// collect window threshold breaches\ntable(tableName)\n| where TimeGenerated > ago(timeRange)\n| where ResultType in(failureCodes)\n| summarize FailedPrincipalCount = dcount(UserPrincipalName) by bin(TimeGenerated, authenticationWindow), IPAddress, AppDisplayName, Type\n| where FailedPrincipalCount >= authenticationThreshold\n| summarize WindowThresholdBreaches = count() by IPAddress, Type\n| join kind= inner (\n// where we breached a threshold, join the details back on all failure data\ntable(tableName)\n| where TimeGenerated > ago(timeRange)\n| where ResultType in(failureCodes)\n| extend LocationDetails = todynamic(LocationDetails)\n| extend FullLocation = strcat(LocationDetails.countryOrRegion,'|', LocationDetails.state, '|', LocationDetails.city)\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), make_set(ClientAppUsed,20), make_set(FullLocation,20), FailureCount = count() by IPAddress, AppDisplayName, UserPrincipalName, UserDisplayName, Identity, UserId, Type\n// lookup any unresolved identities\n| extend UnresolvedUserId = iff(Identity matches regex isGUID, UserId, \"\")\n| join kind= leftouter (\n identityLookup\n) on $left.UnresolvedUserId==$right.UserId\n| extend UserDisplayName=iff(isempty(lu_UserDisplayName), UserDisplayName, lu_UserDisplayName)\n| extend UserPrincipalName=iff(isempty(lu_UserPrincipalName), UserPrincipalName, lu_UserPrincipalName)\n| summarize StartTime = min(StartTime), EndTime = max(EndTime), make_set(UserPrincipalName,20), make_set(UserDisplayName,20), make_set(set_ClientAppUsed,20), make_set(set_FullLocation,20), make_list(FailureCount,20) by IPAddress, AppDisplayName, Type\n| extend FailedPrincipalCount = array_length(set_UserPrincipalName)\n) on IPAddress\n| project IPAddress, StartTime, EndTime, TargetedApplication=AppDisplayName, FailedPrincipalCount, UserPrincipalNames=set_UserPrincipalName, UserDisplayNames=set_UserDisplayName, ClientAppsUsed=set_set_ClientAppUsed, Locations=set_set_FullLocation, FailureCountByPrincipal=list_FailureCount, WindowThresholdBreaches, Type\n| join kind= inner (\ntable(tableName) // get data on success vs. failure history for each IP\n| where TimeGenerated > ago(timeRange)\n| where ResultType in(successCodes) or ResultType in(failureCodes) // success or failure types\n| summarize GlobalSuccessPrincipalCount = dcountif(UserPrincipalName, (ResultType in (successCodes))), ResultTypeSuccesses = make_set_if(ResultType, (ResultType in (successCodes))), GlobalFailPrincipalCount = dcountif(UserPrincipalName, (ResultType in (failureCodes))), ResultTypeFailures = make_set_if(ResultType, (ResultType in (failureCodes))) by IPAddress, Type\n| where GlobalFailPrincipalCount > GlobalSuccessPrincipalCount // where the number of failed principals is greater than success - eliminates FPs from IPs who authenticate successfully alot and as a side effect have alot of failures\n) on IPAddress\n| project-away IPAddress1\n| extend timestamp=StartTime\n};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nunion isfuzzy=true aadSignin, aadNonInt\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P7D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AADNonInteractiveUserSignInLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess"
                                ],
                                "techniques": [
                                  "T1110"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject53').analyticRuleId53,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 53",
                                "parentId": "[variables('analyticRuleObject53').analyticRuleId53]",
                                "contentId": "[variables('analyticRuleObject53')._analyticRulecontentId53]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject53').analyticRuleVersion53]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject53')._analyticRulecontentId53]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Password spray attack against Microsoft Entra ID application",
                        "contentProductId": "[variables('analyticRuleObject53')._analyticRulecontentProductId53]",
                        "id": "[variables('analyticRuleObject53')._analyticRulecontentProductId53]",
                        "version": "[variables('analyticRuleObject53').analyticRuleVersion53]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject54').analyticRuleTemplateSpecName54]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "SuccessThenFail_DiffIP_SameUserandApp_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject54').analyticRuleVersion54]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject54')._analyticRulecontentId54]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies when a user account successfully logs onto an Azure App from one IP and within 10 mins failed to logon to the same App via a different IP (may indicate a malicious attempt at password guessing with known account). \nUEBA added for context to gather all asoociated information assocaited with IP addressed initiating Faile Logon and affected user. \nPlease note, Failed logons from known IP ranges can be benign depending on the conditional access policies. In case of noisy behavior, consider tuning the source IP ranges after careful consideration",
                                "displayName": "Successful logon from IP and failure from a different IP",
                                "enabled": false,
                                "query": "let riskScoreCutoff = 3; //Adjust this score threshold based on volume of results. Activities identified as the most abnormal receive the highest scores (on a scale of 0-10)\nlet logonDiff = 10m; \nlet aadFunc = (tableName:string)\n{ \ntable(tableName)\n| where ResultType == \"0\"\n| where AppDisplayName !in (\"Office 365 Exchange Online\", \"Skype for Business Online\") // To remove false-positives, add more Apps to this array\n// ---------- Fix for SuccessBlock to also consider IPv6\n| extend SuccessIPv6Block = strcat(split(IPAddress, \":\")[0], \":\", split(IPAddress, \":\")[1], \":\", split(IPAddress, \":\")[2], \":\", split(IPAddress, \":\")[3])\n| extend SuccessIPv4Block = strcat(split(IPAddress, \".\")[0], \".\", split(IPAddress, \".\")[1])\n// ------------------\n| project SuccessLogonTime = TimeGenerated, UserPrincipalName, SuccessIPAddress = IPAddress, SuccessLocation = Location, AppDisplayName, SuccessIPBlock = iff(IPAddress contains \":\", strcat(split(IPAddress, \":\")[0], \":\", split(IPAddress, \":\")[1]), strcat(split(IPAddress, \".\")[0], \".\", split(IPAddress, \".\")[1])), Type\n| join kind= inner (\n    table(tableName)\n    | where ResultType !in (\"0\", \"50140\")\n    | where ResultDescription !~ \"Other\"\n    | where AppDisplayName !in (\"Office 365 Exchange Online\", \"Skype for Business Online\")\n    | project FailedLogonTime = TimeGenerated, UserPrincipalName, FailedIPAddress = IPAddress, FailedLocation = Location, AppDisplayName, ResultType, ResultDescription, Type \n) on UserPrincipalName, AppDisplayName\n| where SuccessLogonTime < FailedLogonTime and FailedLogonTime - SuccessLogonTime <= logonDiff and FailedIPAddress !startswith SuccessIPBlock\n| summarize FailedLogonTime = max(FailedLogonTime), SuccessLogonTime = max(SuccessLogonTime) by UserPrincipalName, SuccessIPAddress, SuccessLocation, AppDisplayName, FailedIPAddress, FailedLocation, ResultType, ResultDescription, Type\n| extend timestamp = SuccessLogonTime\n| extend UserPrincipalName = tolower(UserPrincipalName)};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nunion isfuzzy=true aadSignin, aadNonInt\n| extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\n// UEBA context below - make sure you have these 2 datatypes, otherwise the query will not work. If so, comment all that is below.\n| join kind=leftouter (\n    IdentityInfo\n    | summarize LatestReportTime = arg_max(TimeGenerated, *) by AccountUPN\n    | project AccountUPN, Tags, JobTitle, GroupMembership, AssignedRoles, UserType, IsAccountEnabled\n    | summarize\n        Tags = make_set(Tags, 1000),\n        GroupMembership = make_set(GroupMembership, 1000),\n        AssignedRoles = make_set(AssignedRoles, 1000),\n        UserType = make_set(UserType, 1000),\n        UserAccountControl = make_set(UserType, 1000)\n    by AccountUPN\n    | extend UserPrincipalName=tolower(AccountUPN)\n) on UserPrincipalName\n//Below it will be joined with BehaviorAnalytics table to the Failed IP Addresses\n| join kind=leftouter (\n    BehaviorAnalytics\n    | where ActivityType in (\"FailedLogOn\", \"LogOn\")\n    | where isnotempty(SourceIPAddress)\n    | project UsersInsights, DevicesInsights, ActivityInsights, InvestigationPriority, SourceIPAddress, UserName\n    | project-rename FailedIPAddress = SourceIPAddress, Name = UserName\n    | summarize\n        MaxInvestigationScore = max(InvestigationPriority)  // Only retrieve maximum Investigation Property score for both FailedIP and User\n    by FailedIPAddress, Name)\non FailedIPAddress, Name  // Joining on both IP and User so as to only return context associated with same user\n| extend UEBARiskScore = MaxInvestigationScore\n| project-away *1 // removing duplicate columns post outer join from output\n| where  UEBARiskScore > riskScoreCutoff\n| sort by UEBARiskScore desc\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AADNonInteractiveUserSignInLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "BehaviorAnalytics",
                                    "dataTypes": [
                                      "BehaviorAnalytics"
                                    ]
                                  },
                                  {
                                    "connectorId": "BehaviorAnalytics",
                                    "dataTypes": [
                                      "IdentityInfo"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess",
                                  "InitialAccess"
                                ],
                                "techniques": [
                                  "T1110",
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "SuccessIPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "FailedIPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject54').analyticRuleId54,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 54",
                                "parentId": "[variables('analyticRuleObject54').analyticRuleId54]",
                                "contentId": "[variables('analyticRuleObject54')._analyticRulecontentId54]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject54').analyticRuleVersion54]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject54')._analyticRulecontentId54]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Successful logon from IP and failure from a different IP",
                        "contentProductId": "[variables('analyticRuleObject54')._analyticRulecontentProductId54]",
                        "id": "[variables('analyticRuleObject54')._analyticRulecontentProductId54]",
                        "version": "[variables('analyticRuleObject54').analyticRuleVersion54]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject55').analyticRuleTemplateSpecName55]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "SuspiciousAADJoinedDeviceUpdate_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject55').analyticRuleVersion55]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject55')._analyticRulecontentId55]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This query looks for suspicious updates to an Microsoft Entra ID joined device where the device name is changed and the device falls out of compliance.\nThis could occur when a threat actor updates the details of an Autopilot provisioned device using a stolen device ticket, in order to access certificates and keys.\nRef: https://dirkjanm.io/assets/raw/Insomnihack%20Breaking%20and%20fixing%20Azure%20AD%20device%20identity%20security.pdf",
                                "displayName": "Suspicious Entra ID Joined Device Update",
                                "enabled": false,
                                "query": "AuditLogs\n| where OperationName =~ \"Update device\"\n| mv-apply TargetResource=TargetResources on (\n    where TargetResource.type =~ \"Device\"\n    | extend ModifiedProperties = TargetResource.modifiedProperties\n    | extend DeviceId = TargetResource.id)\n| mv-apply Prop=ModifiedProperties on ( \n    where Prop.displayName =~ \"CloudDisplayName\"\n    | extend OldName = Prop.oldValue \n    | extend NewName = Prop.newValue)\n| mv-apply Prop=ModifiedProperties on ( \n    where Prop.displayName =~ \"IsCompliant\"\n    | extend OldComplianceState = Prop.oldValue  \n    | extend NewComplianceState = Prop.newValue)\n| mv-apply Prop=ModifiedProperties on ( \n    where Prop.displayName =~ \"TargetId.DeviceTrustType\"\n    | extend OldTrustType = Prop.oldValue  \n    | extend NewTrustType = Prop.newValue)\n| mv-apply Prop=ModifiedProperties on ( \n    where Prop.displayName =~ \"Included Updated Properties\" \n    | extend UpdatedProperties = Prop.newValue)\n| extend OldDeviceName = tostring(parse_json(tostring(OldName))[0])\n| extend NewDeviceName = tostring(parse_json(tostring(NewName))[0])\n| extend OldComplianceState = tostring(parse_json(tostring(OldComplianceState))[0])\n| extend NewComplianceState = tostring(parse_json(tostring(NewComplianceState))[0])\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend UpdatedPropertiesCount = array_length(split(UpdatedProperties, ','))\n| where OldDeviceName != NewDeviceName\n| where OldComplianceState =~ 'true' and NewComplianceState =~ 'false'\n// Most common is transferring from AAD Registered to AAD Joined - we just want AAD Joined devices\n| where NewTrustType == '\"AzureAd\"' and OldTrustType != '\"Workplace\"'\n// We can modify this value to tune FPs - more properties changed about the device beyond its name the more suspicious it could be\n| where UpdatedPropertiesCount > 1\n| project-reorder TimeGenerated, DeviceId, NewDeviceName, OldDeviceName, NewComplianceState, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingIpAddress, AADOperationType, OldTrustType, NewTrustType, UpdatedProperties, UpdatedPropertiesCount\n| extend InitiatedByName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), InitiatedByUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess"
                                ],
                                "techniques": [
                                  "T1528"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "NewDeviceName",
                                        "identifier": "HostName"
                                      }
                                    ],
                                    "entityType": "Host"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "OldDeviceName",
                                        "identifier": "HostName"
                                      }
                                    ],
                                    "entityType": "Host"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "DeviceId",
                                        "identifier": "AzureID"
                                      }
                                    ],
                                    "entityType": "Host"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatedByName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatedByUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ],
                                "alertDetailsOverride": {
                                  "alertDisplayNameFormat": "Suspicious Entra ID Joined Device Update {{OldDeviceName}} renamed to {{NewDeviceName}} and {{UpdatedPropertiesCount}} properties changed",
                                  "alertDescriptionFormat": "This query looks for suspicious updates to an Microsoft Entra ID joined device where the device name is changed and the device falls out of compliance.\nIn this case {{OldDeviceName}} was renamed to {{NewDeviceName}} and {{UpdatedPropertiesCount}} properties were changed.\nThis could occur when a threat actor updates the details of an Autopilot provisioned device using a stolen device ticket, in order to access certificates and keys.\nRef: https://dirkjanm.io/assets/raw/Insomnihack%20Breaking%20and%20fixing%20Azure%20AD%20device%20identity%20security.pdf\n"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject55').analyticRuleId55,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 55",
                                "parentId": "[variables('analyticRuleObject55').analyticRuleId55]",
                                "contentId": "[variables('analyticRuleObject55')._analyticRulecontentId55]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject55').analyticRuleVersion55]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject55')._analyticRulecontentId55]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Suspicious Entra ID Joined Device Update",
                        "contentProductId": "[variables('analyticRuleObject55')._analyticRulecontentProductId55]",
                        "id": "[variables('analyticRuleObject55')._analyticRulecontentProductId55]",
                        "version": "[variables('analyticRuleObject55').analyticRuleVersion55]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject56').analyticRuleTemplateSpecName56]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "SuspiciousOAuthApp_OfflineAccess_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject56').analyticRuleVersion56]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject56')._analyticRulecontentId56]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This will alert when a user consents to provide a previously-unknown Azure application with offline access via OAuth.\nOffline access will provide the Azure App with access to the listed resources without requiring two-factor authentication.\nConsent to applications with offline access and read capabilities should be rare, especially as the knownApplications list is expanded. Public contributions to expand this filter are welcome!\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.",
                                "displayName": "Suspicious application consent for offline access",
                                "enabled": false,
                                "query": "let detectionTime = 1d;\nlet joinLookback = 14d;\nAuditLogs\n| where TimeGenerated > ago(detectionTime)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Consent to application\"\n| where TargetResources has \"offline\"\n| mv-apply TargetResource=TargetResources on \n  (\n      where TargetResource.type =~ \"ServicePrincipal\"\n      | extend ModifiedProperties = TargetResource.modifiedProperties,\n               AppDisplayName = tostring(TargetResource.displayName),\n               AppClientId = tolower(tostring(TargetResource.id))\n  )\n| where AppClientId !in ((externaldata(knownAppClientId:string, knownAppDisplayName:string)[@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/Microsoft.OAuth.KnownApplications.csv\"] with (format=\"csv\")))\n| mv-apply Properties=ModifiedProperties on \n  (\n      where Properties.displayName =~ \"ConsentAction.Permissions\"\n      | extend ConsentFull = tostring(Properties.newValue)\n      | extend ConsentFull = trim(@'\"',tostring(ConsentFull))\n  )\n| parse ConsentFull with * \"ConsentType: \" GrantConsentType \", Scope: \" GrantScope1 \"]\" *\n| where ConsentFull has \"offline_access\" and ConsentFull has_any (\"Files.Read\", \"Mail.Read\", \"Notes.Read\", \"ChannelMessage.Read\", \"Chat.Read\", \"TeamsActivity.Read\", \"Group.Read\", \"EWS.AccessAsUser.All\", \"EAS.AccessAsUser.All\")\n| where GrantConsentType != \"AllPrincipals\" // NOTE: we are ignoring if OAuth application was granted to all users via an admin - but admin due diligence should be audited occasionally\n| extend GrantInitiatedByAppName = tostring(InitiatedBy.app.displayName)\n| extend GrantInitiatedByAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend GrantInitiatedByUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend GrantInitiatedByAadUserId = tostring(InitiatedBy.user.id)\n| extend GrantIpAddress = iff(isnotempty(InitiatedBy.user.ipAddress), tostring(InitiatedBy.user.ipAddress), tostring(InitiatedBy.app.ipAddress))\n| extend GrantInitiatedBy = iff(isnotempty(GrantInitiatedByUserPrincipalName), GrantInitiatedByUserPrincipalName, GrantInitiatedByAppName)\n| extend GrantUserAgent = tostring(iff(AdditionalDetails[0].key =~ \"User-Agent\", AdditionalDetails[0].value, \"\"))\n| project TimeGenerated, GrantConsentType, GrantScope1, GrantInitiatedBy, AppDisplayName, GrantInitiatedByUserPrincipalName, GrantInitiatedByAadUserId, GrantInitiatedByAppName, GrantInitiatedByAppServicePrincipalId, GrantIpAddress, GrantUserAgent, AppClientId, OperationName, ConsentFull, CorrelationId\n| join kind = leftouter (AuditLogs\n| where TimeGenerated > ago(joinLookback)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Add service principal\"\n| mv-apply TargetResource=TargetResources on \n  (\n      where TargetResource.type =~ \"ServicePrincipal\"\n      | extend ModifiedProperties = TargetResource.modifiedProperties,\n               AppClientId = tolower(TargetResource.id)\n  )\n| mv-apply ModifiedProperties=TargetResource.modifiedProperties on \n   (\n      where ModifiedProperties.displayName =~ \"AppAddress\" and ModifiedProperties.newValue has \"AddressType\"\n      | extend AppReplyURLs = ModifiedProperties.newValue\n   )\n | distinct AppClientId, tostring(AppReplyURLs)\n)\non AppClientId\n| join kind = innerunique (AuditLogs\n| where TimeGenerated > ago(joinLookback)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Add OAuth2PermissionGrant\" or OperationName =~ \"Add delegated permission grant\"\n | mv-apply TargetResource=TargetResources on \n  (\n      where TargetResource.type =~ \"ServicePrincipal\" and array_length(TargetResource.modifiedProperties) > 0 and isnotnull(TargetResource.displayName)\n      | extend GrantAuthentication = tostring(TargetResource.displayName)\n  )\n| extend GrantOperation = OperationName\n| project GrantAuthentication, GrantOperation, CorrelationId\n) on CorrelationId\n| project TimeGenerated, GrantConsentType, GrantScope1, GrantInitiatedBy, AppDisplayName, AppReplyURLs, GrantInitiatedByUserPrincipalName, GrantInitiatedByAadUserId, GrantInitiatedByAppName, GrantInitiatedByAppServicePrincipalId, GrantIpAddress, GrantUserAgent, AppClientId, GrantAuthentication, OperationName, GrantOperation, CorrelationId, ConsentFull\n| extend Name = tostring(split(GrantInitiatedByUserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(GrantInitiatedByUserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P14D",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess"
                                ],
                                "techniques": [
                                  "T1528"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "GrantInitiatedByUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "GrantInitiatedByAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "GrantInitiatedByAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "GrantIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject56').analyticRuleId56,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 56",
                                "parentId": "[variables('analyticRuleObject56').analyticRuleId56]",
                                "contentId": "[variables('analyticRuleObject56')._analyticRulecontentId56]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject56').analyticRuleVersion56]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject56')._analyticRulecontentId56]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Suspicious application consent for offline access",
                        "contentProductId": "[variables('analyticRuleObject56')._analyticRulecontentProductId56]",
                        "id": "[variables('analyticRuleObject56')._analyticRulecontentProductId56]",
                        "version": "[variables('analyticRuleObject56').analyticRuleVersion56]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject57').analyticRuleTemplateSpecName57]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "SuspiciousServicePrincipalcreationactivity_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject57').analyticRuleVersion57]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject57')._analyticRulecontentId57]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This alert will detect creation of an SPN, permissions granted, credentials created, activity and deletion of the SPN in a time frame (default 10 minutes)",
                                "displayName": "Suspicious Service Principal creation activity",
                                "enabled": false,
                                "query": "let queryfrequency = 1h;\nlet wait_for_deletion = 10m;\nlet account_created =\n  AuditLogs \n  | where ActivityDisplayName == \"Add service principal\"\n  | where Result == \"success\"\n  | extend AppID = tostring(AdditionalDetails[1].value)\n  | extend creationTime = ActivityDateTime\n  | extend CreatorUserPrincipalName = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\n  | extend CreatorIPAddress = tostring(parse_json(tostring(InitiatedBy.user)).ipAddress);\nlet account_activity =\n  AADServicePrincipalSignInLogs\n  | extend Activities = pack(\"ActivityTime\", TimeGenerated ,\"IpAddress\", IPAddress, \"ResourceDisplayName\", ResourceDisplayName)\n  | extend AppID = AppId\n  | summarize make_list(Activities) by AppID;\nlet account_deleted =\n  AuditLogs \n  | where OperationName == \"Remove service principal\"\n  | where Result == \"success\"\n  | extend AppID = tostring(AdditionalDetails[1].value)\n  | extend deletionTime = ActivityDateTime\n  | extend DeleterUserPrincipalName = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\n  | extend DeleterIPAddress = tostring(parse_json(tostring(InitiatedBy.user)).ipAddress);\nlet account_credentials =\n  AuditLogs\n  | where OperationName has_all (\"Update application\", \"Certificates and secrets management\")\n  | where Result == \"success\"\n  | extend AppID = tostring(AdditionalDetails[1].value)\n  | extend credentialCreationTime = ActivityDateTime;\nlet roles_assigned =\n  AuditLogs\n  | where ActivityDisplayName == \"Add app role assignment to service principal\"\n  | extend AppID = tostring(TargetResources[1].displayName)\n  | extend AssignedRole =  iff(tostring(parse_json(tostring(TargetResources[0].modifiedProperties))[1].displayName)==\"AppRole.Value\", tostring(parse_json(tostring(parse_json(tostring(TargetResources[0].modifiedProperties))[1].newValue))),\"\")\n  | extend AssignedRoles = pack(\"Role\", AssignedRole)\n  | summarize make_list(AssignedRoles) by AppID;\naccount_created\n| where TimeGenerated between (ago(wait_for_deletion+queryfrequency)..ago(wait_for_deletion))\n| join kind= inner (account_activity) on AppID\n| join kind= inner (account_deleted) on AppID\n| join kind= inner (account_credentials) on AppID\n| join kind= inner (roles_assigned) on AppID\n| where deletionTime - creationTime between (time(0s)..wait_for_deletion)\n| extend AliveTime = deletionTime - creationTime\n| project AADTenantId, AppID, creationTime, deletionTime, CreatorUserPrincipalName, DeleterUserPrincipalName, CreatorIPAddress, DeleterIPAddress, list_Activities, list_AssignedRoles, AliveTime\n| extend CreatorName = tostring(split(CreatorUserPrincipalName, \"@\")[0]), CreatorUPNSuffix = tostring(split(CreatorUserPrincipalName, \"@\")[1])\n| extend DeleterName = tostring(split(DeleterUserPrincipalName, \"@\")[0]), DeleterSuffix = tostring(split(DeleterUserPrincipalName, \"@\")[1])\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H10M",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs",
                                      "AADServicePrincipalSignInLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CredentialAccess",
                                  "PrivilegeEscalation",
                                  "InitialAccess"
                                ],
                                "techniques": [
                                  "T1078",
                                  "T1528"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "CreatorUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "CreatorName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "CreatorUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "DeleterUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "DeleterName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "DeleterSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "CreatorIPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "DeleterIPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject57').analyticRuleId57,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 57",
                                "parentId": "[variables('analyticRuleObject57').analyticRuleId57]",
                                "contentId": "[variables('analyticRuleObject57')._analyticRulecontentId57]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject57').analyticRuleVersion57]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject57')._analyticRulecontentId57]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Suspicious Service Principal creation activity",
                        "contentProductId": "[variables('analyticRuleObject57')._analyticRulecontentProductId57]",
                        "id": "[variables('analyticRuleObject57')._analyticRulecontentProductId57]",
                        "version": "[variables('analyticRuleObject57').analyticRuleVersion57]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject58').analyticRuleTemplateSpecName58]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "SuspiciousSignInFollowedByMFAModification_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject58').analyticRuleVersion58]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject58')._analyticRulecontentId58]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This query looks uses Microsoft Sentinel's UEBA features to look for suspicious logons followed by modifications to MFA settings by that user.",
                                "displayName": "Suspicious Sign In Followed by MFA Modification",
                                "enabled": false,
                                "query": "let PriorityScore = 9;\nBehaviorAnalytics\n| where ActionType == \"Sign-in\"\n| where InvestigationPriority > PriorityScore\n| extend UserPrincipalName = tolower(UserPrincipalName)\n| extend LogOnTime = TimeGenerated\n| join kind=inner (AuditLogs\n| where Category =~ \"UserManagement\" \n| where OperationName in~ (\"Admin registered security info\", \"Admin updated security info\", \"Admin deleted security info\", \"User registered security info\", \"User changed default security info\", \"User deleted security info\",\"User registered all required security info\",\"User started security info registration\") \n| extend InitiatorUPN = tolower(tostring(InitiatedBy.user.userPrincipalName))\n| extend InitiatorID = tostring(InitiatedBy.user.id)\n| extend FromIP = tostring(InitiatedBy.user.ipAddress) \n| extend TargetUPN = tolower(tostring(TargetResources[0].userPrincipalName))\n| extend TargetId = tostring(TargetResources[0].id)\n| extend MFAModTime = TimeGenerated\n| where isnotempty(InitiatorUPN)) on $left.UserPrincipalName == $right.InitiatorUPN\n| where MFAModTime between((LogOnTime-30m)..(LogOnTime+1h))\n| extend InitiatorName = tostring(split(InitiatorUPN, \"@\")[0]), InitiatorUPNSuffix = tostring(split(InitiatorUPN, \"@\")[1]), TargetName = tostring(split(TargetUPN, \"@\")[0]), TargetUPNSuffix = tostring(split(TargetUPN, \"@\")[1])\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "BehaviorAnalytics",
                                    "dataTypes": [
                                      "BehaviorAnalytics"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess",
                                  "DefenseEvasion"
                                ],
                                "subTechniques": [
                                  "T1078.004",
                                  "T1556.006"
                                ],
                                "techniques": [
                                  "T1078",
                                  "T1556"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatorUPN",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatorName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatorUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatorID",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "TargetUPN",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "TargetName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "TargetUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "TargetId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "FromIP",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "SourceIPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ],
                                "eventGroupingSettings": {
                                  "aggregationKind": "AlertPerResult"
                                },
                                "alertDetailsOverride": {
                                  "alertDisplayNameFormat": "Suspicious Sign In by {{InitiatorUPN}} Followed by MFA Modification to {{TargetUPN}}",
                                  "alertDescriptionFormat": "This query looks uses Microsoft Sentinel's UEBA features to look for suspicious logons followed by modifications to MFA settings by that user.\nIn this case {{InitiatorUPN}} logged in followed by a modification to MFA settings for {{TargetUPN}}.\nThe sign in was from {{SourceIPAddress}}.\n"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject58').analyticRuleId58,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 58",
                                "parentId": "[variables('analyticRuleObject58').analyticRuleId58]",
                                "contentId": "[variables('analyticRuleObject58')._analyticRulecontentId58]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject58').analyticRuleVersion58]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject58')._analyticRulecontentId58]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Suspicious Sign In Followed by MFA Modification",
                        "contentProductId": "[variables('analyticRuleObject58')._analyticRulecontentProductId58]",
                        "id": "[variables('analyticRuleObject58')._analyticRulecontentProductId58]",
                        "version": "[variables('analyticRuleObject58').analyticRuleVersion58]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject59').analyticRuleTemplateSpecName59]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "UnusualGuestActivity_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject59').analyticRuleVersion59]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject59')._analyticRulecontentId59]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "By default guests have capability to invite more external guest users, guests also can do suspicious Microsoft Entra ID enumeration. This detection look at guest users, who have been invited or have invited recently, who also are logging via various PowerShell CLI.\nRef : 'https://danielchronlund.com/2021/11/18/scary-azure-ad-tenant-enumeration-using-regular-b2b-guest-accounts/",
                                "displayName": "External guest invitation followed by Microsoft Entra ID PowerShell signin",
                                "enabled": false,
                                "query": "let queryfrequency = 1h;\nlet queryperiod = 1d;\nAuditLogs\n| where TimeGenerated > ago(queryperiod)\n| where OperationName in (\"Invite external user\", \"Bulk invite users - started (bulk)\", \"Invite external user with reset invitation status\")\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend InitiatedBy = iff(isnotempty(InitiatingUserPrincipalName), InitiatingUserPrincipalName, InitiatingAppName)\n// Uncomment the following line to filter events where the inviting user was a guest user\n//| where InitiatedBy has_any (\"live.com#\", \"#EXT#\")\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"User\"\n      | extend InvitedUser = tostring(TargetResource.userPrincipalName)\n  )\n| mv-expand UserToCompare = pack_array(InitiatedBy, InvitedUser) to typeof(string)\n| where UserToCompare has_any (\"live.com#\", \"#EXT#\")\n| extend\n    parsedUser = replace_string(tolower(iff(UserToCompare startswith \"live.com#\", tostring(split(UserToCompare, \"#\")[1]), tostring(split(UserToCompare, \"#EXT#\")[0]))), \"@\", \"_\"),\n    InvitationTime = TimeGenerated\n| join (\n    (union isfuzzy=true SigninLogs, AADNonInteractiveUserSignInLogs)\n    | where TimeGenerated > ago(queryfrequency)\n    | where UserType != \"Member\"\n    | where AppId has_any                       // This web may contain a list of these apps: https://msshells.net/\n        (\"1b730954-1685-4b74-9bfd-dac224a7b894\",// Azure Active Directory PowerShell\n         \"04b07795-8ddb-461a-bbee-02f9e1bf7b46\",// Microsoft Azure CLI\n         \"1950a258-227b-4e31-a9cf-717495945fc2\",// Microsoft Azure PowerShell\n         \"a0c73c16-a7e3-4564-9a95-2bdf47383716\",// Microsoft Exchange Online Remote PowerShell\n         \"fb78d390-0c51-40cd-8e17-fdbfab77341b\",// Microsoft Exchange REST API Based Powershell\n         \"d1ddf0e4-d672-4dae-b554-9d5bdfd93547\",// Microsoft Intune PowerShell\n         \"9bc3ab49-b65d-410a-85ad-de819febfddc\",// Microsoft SharePoint Online Management Shell\n         \"12128f48-ec9e-42f0-b203-ea49fb6af367\",// MS Teams Powershell Cmdlets\n         \"23d8f6bd-1eb0-4cc2-a08c-7bf525c67bcd\",// Power BI PowerShell\n         \"31359c7f-bd7e-475c-86db-fdb8c937548e\",// PnP Management Shell\n         \"90f610bf-206d-4950-b61d-37fa6fd1b224\",// Aadrm Admin Powershell\n         \"14d82eec-204b-4c2f-b7e8-296a70dab67e\",// Microsoft Graph PowerShell\n         \"9cee029c-6210-4654-90bb-17e6e9d36617\" // Power Platform CLI - pac\"\n        )\n    | summarize arg_min(TimeGenerated, *) by UserPrincipalName\n    | extend\n        parsedUser = replace_string(UserPrincipalName, \"@\", \"_\"),\n        SigninTime = TimeGenerated\n    )\n    on parsedUser\n| project InvitationTime, InitiatedBy, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingIpAddress, OperationName, InvitedUser, SigninTime, SigninCategory = Category1, SigninUserPrincipalName = UserPrincipalName, AppDisplayName, ResourceDisplayName, UserAgent, InvitationAdditionalDetails = AdditionalDetails, InvitationTargetResources = TargetResources\n| extend InvitedUserName = tostring(split(InvitedUser,'@',0)[0]), InvitedUserUPNSuffix = tostring(split(InvitedUser,'@',1)[0]), \n         InitiatedByName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), InitiatedByUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P1D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess",
                                  "Persistence",
                                  "Discovery"
                                ],
                                "subTechniques": [
                                  "T1078.004",
                                  "T1136.003",
                                  "T1087.004"
                                ],
                                "techniques": [
                                  "T1078",
                                  "T1136",
                                  "T1087"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InvitedUser",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InvitedUserName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InvitedUserUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatedByName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatedByUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject59').analyticRuleId59,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 59",
                                "parentId": "[variables('analyticRuleObject59').analyticRuleId59]",
                                "contentId": "[variables('analyticRuleObject59')._analyticRulecontentId59]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject59').analyticRuleVersion59]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject59')._analyticRulecontentId59]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "External guest invitation followed by Microsoft Entra ID PowerShell signin",
                        "contentProductId": "[variables('analyticRuleObject59')._analyticRulecontentProductId59]",
                        "id": "[variables('analyticRuleObject59')._analyticRulecontentProductId59]",
                        "version": "[variables('analyticRuleObject59').analyticRuleVersion59]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject60').analyticRuleTemplateSpecName60]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "UserAccounts-CABlockedSigninSpikes_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject60').analyticRuleVersion60]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject60')._analyticRulecontentId60]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": " Identifies spike in failed sign-ins from user accounts due to conditional access policied.\nSpike is determined based on Time series anomaly which will look at historical baseline values.\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-user-accounts#monitoring-for-failed-unusual-sign-ins\nThis query has also been updated to include UEBA logs IdentityInfo and BehaviorAnalytics for contextual information around the results.",
                                "displayName": "User Accounts - Sign in Failure due to CA Spikes",
                                "enabled": false,
                                "query": "let riskScoreCutoff = 20; //Adjust this based on volume of results\nlet starttime = 14d;\nlet timeframe = 1d;\nlet scorethreshold = 3;\nlet baselinethreshold = 50;\nlet aadFunc = (tableName:string){\n  // Failed Signins attempts with reasoning related to conditional access policies.\n  table(tableName)\n  | where TimeGenerated between (startofday(ago(starttime))..startofday(now()))\n  | where ResultDescription has_any (\"conditional access\", \"CA\") or ResultType in (50005, 50131, 53000, 53001, 53002, 52003, 70044)\n  | extend UserPrincipalName = tolower(UserPrincipalName)\n  | extend timestamp = TimeGenerated, AccountCustomEntity = UserPrincipalName\n};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nlet allSignins = union isfuzzy=true aadSignin, aadNonInt;\nlet TimeSeriesAlerts = \nallSignins\n| make-series DailyCount=count() on TimeGenerated from startofday(ago(starttime)) to startofday(now()) step 1d by UserPrincipalName\n| extend (anomalies, score, baseline) = series_decompose_anomalies(DailyCount, scorethreshold, -1, 'linefit')\n| mv-expand DailyCount to typeof(double), TimeGenerated to typeof(datetime), anomalies to typeof(double), score to typeof(double), baseline to typeof(long)\n// Filtering low count events per baselinethreshold\n| where anomalies > 0 and baseline > baselinethreshold\n| extend AnomalyHour = TimeGenerated\n| project UserPrincipalName, AnomalyHour, TimeGenerated, DailyCount, baseline, anomalies, score;\n// Filter the alerts for specified timeframe\nTimeSeriesAlerts\n| where TimeGenerated > startofday(ago(timeframe))\n| join kind=inner ( \n  allSignins\n  | where TimeGenerated > startofday(ago(timeframe))\n  // create a new column and round to hour\n  | extend DateHour = bin(TimeGenerated, 1h)\n  | summarize PartialFailedSignins = count(), LatestAnomalyTime = arg_max(TimeGenerated, *) by bin(TimeGenerated, 1h), OperationName, Category, ResultType, ResultDescription, UserPrincipalName, UserDisplayName, AppDisplayName, ClientAppUsed, IPAddress, ResourceDisplayName\n) on UserPrincipalName, $left.AnomalyHour == $right.DateHour\n| project LatestAnomalyTime, OperationName, Category, UserPrincipalName, UserDisplayName, ResultType, ResultDescription, AppDisplayName, ClientAppUsed, UserAgent, IPAddress, Location, AuthenticationRequirement, ConditionalAccessStatus, ResourceDisplayName, PartialFailedSignins, TotalFailedSignins = DailyCount, baseline, anomalies, score\n| extend timestamp = LatestAnomalyTime, Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\n| extend UserPrincipalName = tolower(UserPrincipalName)\n| join kind=leftouter (\n    IdentityInfo\n    | summarize LatestReportTime = arg_max(TimeGenerated, *) by AccountUPN\n    | project AccountUPN, Tags, JobTitle, GroupMembership, AssignedRoles, UserType, IsAccountEnabled\n    | summarize\n        Tags = make_set(Tags, 1000),\n        GroupMembership = make_set(GroupMembership, 1000),\n        AssignedRoles = make_set(AssignedRoles, 1000),\n        UserType = make_set(UserType, 1000),\n        UserAccountControl = make_set(UserType, 1000)\n    by AccountUPN\n    | extend UserPrincipalName=tolower(AccountUPN)\n) on UserPrincipalName\n| join kind=leftouter (\n    BehaviorAnalytics\n    | where ActivityType in (\"FailedLogOn\", \"LogOn\")\n    | where isnotempty(SourceIPAddress)\n    | project UsersInsights, DevicesInsights, ActivityInsights, InvestigationPriority, SourceIPAddress\n    | project-rename IPAddress = SourceIPAddress\n    | summarize\n        UsersInsights = make_set(UsersInsights, 1000),\n        DevicesInsights = make_set(DevicesInsights, 1000),\n        IPInvestigationPriority = sum(InvestigationPriority)\n    by IPAddress)\non IPAddress\n| extend UEBARiskScore = IPInvestigationPriority\n| where UEBARiskScore > riskScoreCutoff\n| sort by UEBARiskScore desc \n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P14D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "SigninLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AADNonInteractiveUserSignInLogs"
                                    ]
                                  },
                                  {
                                    "connectorId": "BehaviorAnalytics",
                                    "dataTypes": [
                                      "BehaviorAnalytics"
                                    ]
                                  },
                                  {
                                    "connectorId": "BehaviorAnalytics",
                                    "dataTypes": [
                                      "IdentityInfo"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "InitialAccess"
                                ],
                                "subTechniques": [
                                  "T1078.004"
                                ],
                                "techniques": [
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "UserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "Name",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "UPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject60').analyticRuleId60,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 60",
                                "parentId": "[variables('analyticRuleObject60').analyticRuleId60]",
                                "contentId": "[variables('analyticRuleObject60')._analyticRulecontentId60]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject60').analyticRuleVersion60]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject60')._analyticRulecontentId60]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "User Accounts - Sign in Failure due to CA Spikes",
                        "contentProductId": "[variables('analyticRuleObject60')._analyticRulecontentProductId60]",
                        "id": "[variables('analyticRuleObject60')._analyticRulecontentProductId60]",
                        "version": "[variables('analyticRuleObject60').analyticRuleVersion60]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject61').analyticRuleTemplateSpecName61]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "UseraddedtoPrivilgedGroups_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject61').analyticRuleVersion61]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject61')._analyticRulecontentId61]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "This will alert when a user is added to any of the Privileged Groups.\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.\nFor Administrator role permissions in Microsoft Entra ID please see https://docs.microsoft.com/azure/active-directory/users-groups-roles/directory-assign-admin-roles",
                                "displayName": "User added to Microsoft Entra ID Privileged Groups",
                                "enabled": false,
                                "query": "let OperationList = dynamic([\"Add member to role\",\"Add eligible member to role\"]);\nlet PrivilegedGroups = dynamic([\"UserAccountAdmins\",\"PrivilegedRoleAdmins\",\"TenantAdmins\",\"PrivilegedAuthenticationAdmins\"]);\nAuditLogs\n| where Category =~ \"RoleManagement\"\n| where OperationName in~ (OperationList)\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"User\"\n      | extend TargetUserPrincipalName = tostring(TargetResource.userPrincipalName),\n               modProps = TargetResource.modifiedProperties\n  )\n| mv-apply Property = modProps on \n  (\n      where Property.displayName =~ \"Role.WellKnownObjectName\"\n      | extend DisplayName = trim('\"',tostring(Property.displayName)),\n               GroupName = trim('\"',tostring(Property.newValue))\n  )\n| extend InitiatingAppId = InitiatedBy.app.appId\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingAppServicePrincipalName = tostring(InitiatedBy.app.servicePrincipalName)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend InitiatingUserRoles = InitiatedBy.user.roles\n| where GroupName in~ (PrivilegedGroups)\n// If you don't want to alert for operations from PIM, remove below filtering for MS-PIM.\n//| where InitiatingAppName != \"MS-PIM\" and InitiatingAppName != \"MS-PIM-Fairfax\"\n| project TimeGenerated, AADOperationType, Category, OperationName, AADTenantId, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingAppId, InitiatingAppName, InitiatingAppServicePrincipalName, InitiatingAppServicePrincipalId, InitiatingIpAddress, DisplayName, GroupName, InitiatingUserRoles, TargetUserPrincipalName\n| extend AccountName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), AccountUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n| extend TargetName = tostring(split(TargetUserPrincipalName,'@',0)[0]), TargetUPNSuffix = tostring(split(TargetUserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Persistence",
                                  "PrivilegeEscalation"
                                ],
                                "techniques": [
                                  "T1098",
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "AccountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "AccountUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "TargetUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "TargetName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "TargetUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject61').analyticRuleId61,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 61",
                                "parentId": "[variables('analyticRuleObject61').analyticRuleId61]",
                                "contentId": "[variables('analyticRuleObject61')._analyticRulecontentId61]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject61').analyticRuleVersion61]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject61')._analyticRulecontentId61]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "User added to Microsoft Entra ID Privileged Groups",
                        "contentProductId": "[variables('analyticRuleObject61')._analyticRulecontentProductId61]",
                        "id": "[variables('analyticRuleObject61')._analyticRulecontentProductId61]",
                        "version": "[variables('analyticRuleObject61').analyticRuleVersion61]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject62').analyticRuleTemplateSpecName62]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "UserAssignedNewPrivilegedRole_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject62').analyticRuleVersion62]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject62')._analyticRulecontentId62]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies when a new eligible or active privileged role is assigned to a user. Does not alert on PIM activations. Any account eligible for a role is now being given privileged access. If the assignment is unexpected or into a role that isn't the responsibility of the account holder, investigate.\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-accounts#things-to-monitor-1",
                                "displayName": "User Assigned New Privileged Role",
                                "enabled": false,
                                "query": "AuditLogs\n| where Category =~ \"RoleManagement\"\n| where AADOperationType in (\"Assign\", \"AssignEligibleRole\", \"CreateRequestGrantedRole\", \"CreateRequestPermanentEligibleRole\", \"CreateRequestPermanentGrantedRole\")\n| where ActivityDisplayName has_any (\"Add eligible member to role\", \"Add member to role\")\n| mv-apply TargetResourceSubject = TargetResources on \n  (\n      where TargetResourceSubject.type in~ (\"User\", \"ServicePrincipal\")\n      | extend Target = iff(TargetResourceSubject.type =~ \"ServicePrincipal\", tostring(TargetResourceSubject.displayName), tostring(TargetResourceSubject.userPrincipalName)),\n               subjectProps = TargetResourceSubject.modifiedProperties\n  )\n| mv-apply TargetResourceRole = TargetResources on \n  (\n    // mimic modifiedProperties so we can use the same logic to get the role name regardless of where it comes from\n    where TargetResourceRole.type in~ (\"Role\")\n    | extend roleProps = pack_array(bag_pack(\"displayName\",\"Role.DisplayName\", \"newValue\", TargetResourceRole.displayName))\n  )\n| mv-apply Property = iff(array_length(subjectProps) > 0, subjectProps, roleProps) on \n  ( \n    where Property.displayName =~ \"Role.DisplayName\"\n      | extend RoleName = trim('\"',tostring(Property.newValue))\n  )\n| where RoleName contains \"Admin\"\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend Initiator = iif(isnotempty(InitiatingAppName), InitiatingAppName, InitiatingUserPrincipalName)\n// Comment below to alert for PIM activations\n| where Initiator != \"MS-PIM\" and Initiator != \"MS-PIM-Fairfax\"\n| summarize by bin(TimeGenerated, 1h), OperationName, RoleName, Target, Initiator, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingIpAddress, Result\n| extend TargetName = tostring(split(Target,'@',0)[0]), TargetUPNSuffix = tostring(split(Target,'@',1)[0]), InitiatorName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), InitiatorUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "PT2H",
                                "queryPeriod": "PT2H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Persistence"
                                ],
                                "subTechniques": [
                                  "T1078.004"
                                ],
                                "techniques": [
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Target",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "TargetName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "TargetUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatorName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatorUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject62').analyticRuleId62,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 62",
                                "parentId": "[variables('analyticRuleObject62').analyticRuleId62]",
                                "contentId": "[variables('analyticRuleObject62')._analyticRulecontentId62]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject62').analyticRuleVersion62]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject62')._analyticRulecontentId62]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "User Assigned New Privileged Role",
                        "contentProductId": "[variables('analyticRuleObject62')._analyticRulecontentProductId62]",
                        "id": "[variables('analyticRuleObject62')._analyticRulecontentProductId62]",
                        "version": "[variables('analyticRuleObject62').analyticRuleVersion62]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject63').analyticRuleTemplateSpecName63]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "UserAssignedPrivilegedRole_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject63').analyticRuleVersion63]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject63')._analyticRulecontentId63]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Identifies when a privileged role is assigned to a new user. Any account eligible for a role is now being given privileged access. If the assignment is unexpected or into a role that isn't the responsibility of the account holder, investigate.",
                                "displayName": "New User Assigned to Privileged Role",
                                "enabled": false,
                                "query": "// Define the start and end times based on input values\nlet starttime = now()-1h;\nlet endtime = now();\n// Set a lookback period of 14 days\nlet lookback = starttime - 14d;\n// Define a reusable function to query audit logs\nlet awsFunc = (start:datetime, end:datetime) {\n  AuditLogs\n  | where TimeGenerated between (start..end)\n  | where Category =~ \"RoleManagement\"\n  | where AADOperationType in (\"Assign\", \"AssignEligibleRole\")\n  | where ActivityDisplayName has_any (\"Add eligible member to role\", \"Add member to role\")\n  | mv-apply TargetResource = TargetResources on\n    (\n      where TargetResource.type in~ (\"User\", \"ServicePrincipal\")\n      | extend Target = iff(TargetResource.type =~ \"ServicePrincipal\", tostring(TargetResource.displayName), tostring(TargetResource.userPrincipalName)),\n      props = TargetResource.modifiedProperties\n    )\n  | mv-apply Property = props on\n    (\n      where Property.displayName =~ \"Role.DisplayName\"\n      | extend RoleName = trim('\"', tostring(Property.newValue))\n    )\n  | where RoleName contains \"Admin\" and Result == \"success\"\n};\n// Query for audit events in the current day\nlet EventInfo_CurrentDay = awsFunc(starttime, endtime);\n// Query for audit events in the historical period (lookback)\nlet EventInfo_historical = awsFunc(lookback, starttime);\n// Find unseen events by performing a left anti-join\nlet EventInfo_Unseen = (EventInfo_CurrentDay\n  | join kind=leftanti(EventInfo_historical) on Target, RoleName, OperationName\n);\n// Extend and clean up the results\nEventInfo_Unseen\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend Initiator = iif(isnotempty(InitiatingAppName), InitiatingAppName, InitiatingUserPrincipalName)\n// You can uncomment the lines below to filter out PIM activations\n// | where Initiator != \"MS-PIM\" and Initiator != \"MS-PIM-Fairfax\"\n// | summarize StartTime=min(TimeGenerated), EndTime=min(TimeGenerated) by OperationName, RoleName, Target, Initiator, Result\n// Project specific columns and split them for further analysis\n| project TimeGenerated, OperationName, RoleName, Target, Initiator, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingIpAddress, Result\n| extend TargetName = tostring(split(Target,'@',0)[0]), TargetUPNSuffix = tostring(split(Target,'@',1)[0]), InitiatorName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), InitiatorUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P14D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Persistence"
                                ],
                                "subTechniques": [
                                  "T1078.004"
                                ],
                                "techniques": [
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Target",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "TargetName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "TargetUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingUserPrincipalName",
                                        "identifier": "FullName"
                                      },
                                      {
                                        "columnName": "InitiatorName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "InitiatorUPNSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAadUserId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingAppServicePrincipalId",
                                        "identifier": "AadUserId"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "InitiatingIpAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ]
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject63').analyticRuleId63,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 63",
                                "parentId": "[variables('analyticRuleObject63').analyticRuleId63]",
                                "contentId": "[variables('analyticRuleObject63')._analyticRulecontentId63]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject63').analyticRuleVersion63]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject63')._analyticRulecontentId63]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "New User Assigned to Privileged Role",
                        "contentProductId": "[variables('analyticRuleObject63')._analyticRulecontentProductId63]",
                        "id": "[variables('analyticRuleObject63')._analyticRulecontentProductId63]",
                        "version": "[variables('analyticRuleObject63').analyticRuleVersion63]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject64').analyticRuleTemplateSpecName64]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "AzureRBAC_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject64').analyticRuleVersion64]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject64')._analyticRulecontentId64]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "Detects when a Global Administrator elevates access to all subscriptions and management groups in a tenant. When a Global Administrator elevates access they are assigned the User Access Administrator role at root scope. This Microsoft Sentinel Analytic Rule monitors who has elevated access in your tenant so that admins can take appropriate action. [Learn more](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin?tabs=azure-portal)",
                                "displayName": "Azure RBAC (Elevate Access)",
                                "enabled": false,
                                "query": "AuditLogs\n| where Category =~ \"AzureRBACRoleManagementElevateAccess\"\n| where ActivityDisplayName =~ \"User has elevated their access to User Access Administrator for their Azure Resources\"\n| extend Actor = tostring(InitiatedBy.user.userPrincipalName)\n| extend IPAddress = tostring(InitiatedBy.user.ipAddress) \n| project\n    TimeGenerated,\n    Actor,\n    OperationName,\n    IPAddress,\n    Result,\n    LoggedByService\n",
                                "queryFrequency": "PT2H",
                                "queryPeriod": "PT2H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "PrivilegeEscalation"
                                ],
                                "techniques": [
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "Actor",
                                        "identifier": "Name"
                                      }
                                    ],
                                    "entityType": "Account"
                                  },
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "IPAddress",
                                        "identifier": "Address"
                                      }
                                    ],
                                    "entityType": "IP"
                                  }
                                ],
                                "eventGroupingSettings": {
                                  "aggregationKind": "SingleAlert"
                                },
                                "incidentConfiguration": {
                                  "createIncident": true,
                                  "groupingConfiguration": {
                                    "enabled": false,
                                    "matchingMethod": "AllEntities",
                                    "reopenClosedIncident": false,
                                    "lookbackDuration": "PT5H"
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject64').analyticRuleId64,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 64",
                                "parentId": "[variables('analyticRuleObject64').analyticRuleId64]",
                                "contentId": "[variables('analyticRuleObject64')._analyticRulecontentId64]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject64').analyticRuleVersion64]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject64')._analyticRulecontentId64]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Azure RBAC (Elevate Access)",
                        "contentProductId": "[variables('analyticRuleObject64')._analyticRulecontentProductId64]",
                        "id": "[variables('analyticRuleObject64')._analyticRulecontentProductId64]",
                        "version": "[variables('analyticRuleObject64').analyticRuleVersion64]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject65').analyticRuleTemplateSpecName65]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Conditional Access - A Conditional Access Device platforms condition has changed (the Device platforms condition can be spoofed)_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject65').analyticRuleVersion65]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject65')._analyticRulecontentId65]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "A Conditional Access Device platforms condition has changed (the Device platforms condition can be spoofed) in Entra ID.",
                                "displayName": "Conditional Access - A Conditional Access Device platforms condition has changed (the Device platforms condition can be spoofed)",
                                "enabled": false,
                                "query": "// A Conditional Access Device platforms condition has changed (the Device platforms condition can be spoofed).\nAuditLogs\n| where OperationName in (\"Update conditional access policy\")\n| extend excludePlatformsOld = extractjson(\"$.conditions.platforms.excludePlatforms\", tostring(TargetResources[0].modifiedProperties[0].oldValue))\n| extend excludePlatformsNew = extractjson(\"$.conditions.platforms.excludePlatforms\", tostring(TargetResources[0].modifiedProperties[0].newValue))\n| where excludePlatformsOld != excludePlatformsNew\n| extend modifiedBy = tostring(InitiatedBy.user.userPrincipalName)\n| extend accountName = tostring(split(modifiedBy, \"@\")[0])\n| extend upnSuffix = tostring(split(modifiedBy, \"@\")[1])\n| project\n    TimeGenerated,\n    OperationName,\n    policy = TargetResources[0].displayName,\n    modifiedBy,\n    accountName,\n    upnSuffix,\n    result = Result,\n    excludePlatformsOld,\n    excludePlatformsNew\n| order by TimeGenerated desc\n",
                                "queryFrequency": "PT5M",
                                "queryPeriod": "PT5M",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "DefenseEvasion"
                                ],
                                "subTechniques": [
                                  "T1562.007"
                                ],
                                "techniques": [
                                  "T1562"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "accountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "upnSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  }
                                ],
                                "eventGroupingSettings": {
                                  "aggregationKind": "AlertPerResult"
                                },
                                "incidentConfiguration": {
                                  "createIncident": true,
                                  "groupingConfiguration": {
                                    "enabled": false,
                                    "matchingMethod": "AllEntities",
                                    "reopenClosedIncident": false,
                                    "lookbackDuration": "PT1H"
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject65').analyticRuleId65,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 65",
                                "parentId": "[variables('analyticRuleObject65').analyticRuleId65]",
                                "contentId": "[variables('analyticRuleObject65')._analyticRulecontentId65]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject65').analyticRuleVersion65]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject65')._analyticRulecontentId65]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Conditional Access - A Conditional Access Device platforms condition has changed (the Device platforms condition can be spoofed)",
                        "contentProductId": "[variables('analyticRuleObject65')._analyticRulecontentProductId65]",
                        "id": "[variables('analyticRuleObject65')._analyticRulecontentProductId65]",
                        "version": "[variables('analyticRuleObject65').analyticRuleVersion65]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject66').analyticRuleTemplateSpecName66]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Conditional Access - A Conditional Access app exclusion has changed_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject66').analyticRuleVersion66]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject66')._analyticRulecontentId66]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "A Conditional Access app exclusion has changed in Entra ID.",
                                "displayName": "Conditional Access - A Conditional Access app exclusion has changed",
                                "enabled": false,
                                "query": "// A Conditional Access app exclusion has changed.\nAuditLogs\n| where OperationName in (\"Update conditional access policy\")\n| extend excludeApplicationsOld = extractjson(\"$.conditions.applications.excludeApplications\", tostring(TargetResources[0].modifiedProperties[0].oldValue))\n| extend excludeApplicationsNew = extractjson(\"$.conditions.applications.excludeApplications\", tostring(TargetResources[0].modifiedProperties[0].newValue))\n| where excludeApplicationsOld != excludeApplicationsNew\n| extend modifiedBy = tostring(InitiatedBy.user.userPrincipalName)\n| extend accountName = tostring(split(modifiedBy, \"@\")[0])\n| extend upnSuffix = tostring(split(modifiedBy, \"@\")[1])\n| project\n    TimeGenerated,\n    OperationName,\n    policy = TargetResources[0].displayName,\n    modifiedBy,\n    accountName,\n    upnSuffix,\n    result = Result,\n    excludeApplicationsOld,\n    excludeApplicationsNew\n| order by TimeGenerated desc\n\n",
                                "queryFrequency": "PT5M",
                                "queryPeriod": "PT5M",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "CommandAndControl"
                                ],
                                "techniques": [
                                  "T1071"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "accountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "upnSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  }
                                ],
                                "eventGroupingSettings": {
                                  "aggregationKind": "AlertPerResult"
                                },
                                "incidentConfiguration": {
                                  "createIncident": true,
                                  "groupingConfiguration": {
                                    "enabled": false,
                                    "matchingMethod": "AllEntities",
                                    "reopenClosedIncident": false,
                                    "lookbackDuration": "PT1H"
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject66').analyticRuleId66,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 66",
                                "parentId": "[variables('analyticRuleObject66').analyticRuleId66]",
                                "contentId": "[variables('analyticRuleObject66')._analyticRulecontentId66]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject66').analyticRuleVersion66]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject66')._analyticRulecontentId66]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Conditional Access - A Conditional Access app exclusion has changed",
                        "contentProductId": "[variables('analyticRuleObject66')._analyticRulecontentProductId66]",
                        "id": "[variables('analyticRuleObject66')._analyticRulecontentProductId66]",
                        "version": "[variables('analyticRuleObject66').analyticRuleVersion66]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject67').analyticRuleTemplateSpecName67]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Conditional Access - A Conditional Access policy was deleted_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject67').analyticRuleVersion67]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject67')._analyticRulecontentId67]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "A Conditional Access policy was deleted from Entra ID.",
                                "displayName": "Conditional Access - A Conditional Access policy was deleted",
                                "enabled": false,
                                "query": "// A Conditional Access policy was deleted.\nAuditLogs\n| where OperationName in (\"Delete conditional access policy\")\n| extend modifiedBy = tostring(InitiatedBy.user.userPrincipalName)\n| extend accountName = tostring(split(modifiedBy, \"@\")[0])\n| extend upnSuffix = tostring(split(modifiedBy, \"@\")[1])\n| project\n    TimeGenerated,\n    OperationName,\n    policy = TargetResources[0].displayName,\n    modifiedBy,\n    accountName,\n    upnSuffix,\n    result = Result,\n    oldPolicy = TargetResources[0].modifiedProperties[0].oldValue\n| order by TimeGenerated desc\n",
                                "queryFrequency": "PT5M",
                                "queryPeriod": "PT5M",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "DefenseEvasion"
                                ],
                                "subTechniques": [
                                  "T1562.007"
                                ],
                                "techniques": [
                                  "T1562"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "accountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "upnSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  }
                                ],
                                "eventGroupingSettings": {
                                  "aggregationKind": "AlertPerResult"
                                },
                                "incidentConfiguration": {
                                  "createIncident": true,
                                  "groupingConfiguration": {
                                    "enabled": false,
                                    "matchingMethod": "AllEntities",
                                    "reopenClosedIncident": false,
                                    "lookbackDuration": "PT1H"
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject67').analyticRuleId67,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 67",
                                "parentId": "[variables('analyticRuleObject67').analyticRuleId67]",
                                "contentId": "[variables('analyticRuleObject67')._analyticRulecontentId67]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject67').analyticRuleVersion67]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject67')._analyticRulecontentId67]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Conditional Access - A Conditional Access policy was deleted",
                        "contentProductId": "[variables('analyticRuleObject67')._analyticRulecontentProductId67]",
                        "id": "[variables('analyticRuleObject67')._analyticRulecontentProductId67]",
                        "version": "[variables('analyticRuleObject67').analyticRuleVersion67]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject68').analyticRuleTemplateSpecName68]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Conditional Access - A Conditional Access policy was disabled_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject68').analyticRuleVersion68]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject68')._analyticRulecontentId68]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "A Conditional Access policy was disabled in Entra ID.",
                                "displayName": "Conditional Access - A Conditional Access policy was disabled",
                                "enabled": false,
                                "query": "// A Conditional Access policy was disabled.\nAuditLogs\n| where OperationName in (\"Update conditional access policy\")\n| extend stateOld = extractjson(\"$.state\", tostring(TargetResources[0].modifiedProperties[0].oldValue))\n| extend stateNew = extractjson(\"$.state\", tostring(TargetResources[0].modifiedProperties[0].newValue))\n| where stateOld == \"enabled\" and stateNew == \"disabled\"\n| extend modifiedBy = tostring(InitiatedBy.user.userPrincipalName)\n| extend accountName = tostring(split(modifiedBy, \"@\")[0])\n| extend upnSuffix = tostring(split(modifiedBy, \"@\")[1])\n| project\n    TimeGenerated,\n    OperationName,\n    policy = TargetResources[0].displayName,\n    modifiedBy,\n    accountName,\n    upnSuffix,\n    result = Result,\n    stateOld,\n    stateNew\n| order by TimeGenerated desc\n",
                                "queryFrequency": "PT5M",
                                "queryPeriod": "PT5M",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "DefenseEvasion"
                                ],
                                "subTechniques": [
                                  "T1562.007"
                                ],
                                "techniques": [
                                  "T1562"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "accountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "upnSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  }
                                ],
                                "eventGroupingSettings": {
                                  "aggregationKind": "AlertPerResult"
                                },
                                "incidentConfiguration": {
                                  "createIncident": true,
                                  "groupingConfiguration": {
                                    "enabled": false,
                                    "matchingMethod": "AllEntities",
                                    "reopenClosedIncident": false,
                                    "lookbackDuration": "PT1H"
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject68').analyticRuleId68,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 68",
                                "parentId": "[variables('analyticRuleObject68').analyticRuleId68]",
                                "contentId": "[variables('analyticRuleObject68')._analyticRulecontentId68]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject68').analyticRuleVersion68]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject68')._analyticRulecontentId68]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Conditional Access - A Conditional Access policy was disabled",
                        "contentProductId": "[variables('analyticRuleObject68')._analyticRulecontentProductId68]",
                        "id": "[variables('analyticRuleObject68')._analyticRulecontentProductId68]",
                        "version": "[variables('analyticRuleObject68').analyticRuleVersion68]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject69').analyticRuleTemplateSpecName69]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Conditional Access - A Conditional Access policy was put into report-only mode_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject69').analyticRuleVersion69]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject69')._analyticRulecontentId69]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "A Conditional Access policy was put into report-only mode in Entra ID.",
                                "displayName": "Conditional Access - A Conditional Access policy was put into report-only mode",
                                "enabled": false,
                                "query": "// A Conditional Access policy was put into report-only mode.\nAuditLogs\n| where OperationName in (\"Update conditional access policy\")\n| extend stateOld = extractjson(\"$.state\", tostring(TargetResources[0].modifiedProperties[0].oldValue))\n| extend stateNew = extractjson(\"$.state\", tostring(TargetResources[0].modifiedProperties[0].newValue))\n| where stateOld == \"enabled\" and stateNew == \"enabledForReportingButNotEnforced\"\n| extend modifiedBy = tostring(InitiatedBy.user.userPrincipalName)\n| extend accountName = tostring(split(modifiedBy, \"@\")[0])\n| extend upnSuffix = tostring(split(modifiedBy, \"@\")[1])\n| project\n    TimeGenerated,\n    OperationName,\n    policy = TargetResources[0].displayName,\n    modifiedBy,\n    accountName,\n    upnSuffix,\n    result = Result,\n    stateOld,\n    stateNew\n| order by TimeGenerated desc\n",
                                "queryFrequency": "PT5M",
                                "queryPeriod": "PT5M",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "DefenseEvasion"
                                ],
                                "subTechniques": [
                                  "T1562.007"
                                ],
                                "techniques": [
                                  "T1562"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "accountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "upnSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  }
                                ],
                                "eventGroupingSettings": {
                                  "aggregationKind": "AlertPerResult"
                                },
                                "incidentConfiguration": {
                                  "createIncident": true,
                                  "groupingConfiguration": {
                                    "enabled": false,
                                    "matchingMethod": "AllEntities",
                                    "reopenClosedIncident": false,
                                    "lookbackDuration": "PT5M"
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject69').analyticRuleId69,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 69",
                                "parentId": "[variables('analyticRuleObject69').analyticRuleId69]",
                                "contentId": "[variables('analyticRuleObject69')._analyticRulecontentId69]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject69').analyticRuleVersion69]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject69')._analyticRulecontentId69]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Conditional Access - A Conditional Access policy was put into report-only mode",
                        "contentProductId": "[variables('analyticRuleObject69')._analyticRulecontentProductId69]",
                        "id": "[variables('analyticRuleObject69')._analyticRulecontentProductId69]",
                        "version": "[variables('analyticRuleObject69').analyticRuleVersion69]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject70').analyticRuleTemplateSpecName70]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Conditional Access - A Conditional Access policy was updated_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject70').analyticRuleVersion70]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject70')._analyticRulecontentId70]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "A Conditional Access policy was updated in Entra ID.",
                                "displayName": "Conditional Access - A Conditional Access policy was updated",
                                "enabled": false,
                                "query": "// A Conditional Access policy was updated.\nAuditLogs\n| where OperationName == \"Update conditional access policy\"\n| extend\n    policy = tostring(TargetResources[0].displayName),\n    modifiedBy = tostring(InitiatedBy.user.userPrincipalName),\n    oldPolicy = tostring(TargetResources[0].modifiedProperties[0].oldValue),\n    newPolicy = tostring(TargetResources[0].modifiedProperties[0].newValue)\n| extend\n    accountName = tostring(split(modifiedBy, \"@\")[0]),\n    upnSuffix = tostring(split(modifiedBy, \"@\")[1])\n| project\n    TimeGenerated,\n    OperationName,\n    policy,\n    modifiedBy,\n    accountName,\n    upnSuffix,\n    oldPolicy,\n    newPolicy,\n    Result\n\n",
                                "queryFrequency": "PT5M",
                                "queryPeriod": "PT5M",
                                "severity": "Informational",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "DefenseEvasion"
                                ],
                                "techniques": [
                                  "T1562"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "accountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "upnSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  }
                                ],
                                "eventGroupingSettings": {
                                  "aggregationKind": "AlertPerResult"
                                },
                                "incidentConfiguration": {
                                  "createIncident": true,
                                  "groupingConfiguration": {
                                    "enabled": false,
                                    "matchingMethod": "AllEntities",
                                    "reopenClosedIncident": false,
                                    "lookbackDuration": "PT1H"
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject70').analyticRuleId70,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 70",
                                "parentId": "[variables('analyticRuleObject70').analyticRuleId70]",
                                "contentId": "[variables('analyticRuleObject70')._analyticRulecontentId70]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject70').analyticRuleVersion70]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject70')._analyticRulecontentId70]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Conditional Access - A Conditional Access policy was updated",
                        "contentProductId": "[variables('analyticRuleObject70')._analyticRulecontentProductId70]",
                        "id": "[variables('analyticRuleObject70')._analyticRulecontentProductId70]",
                        "version": "[variables('analyticRuleObject70').analyticRuleVersion70]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject71').analyticRuleTemplateSpecName71]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Conditional Access - A Conditional Access usergrouprole exclusion has changed_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject71').analyticRuleVersion71]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject71')._analyticRulecontentId71]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "A Conditional Access user/group/role exclusion has changed in Azure AD.",
                                "displayName": "Conditional Access - A Conditional Access user/group/role exclusion has changed",
                                "enabled": false,
                                "query": "// A Conditional Access user/group/role exclusion has changed.\nAuditLogs\n| where OperationName in (\"Update conditional access policy\")\n| extend excludeUsersOld = extractjson(\"$.conditions.users.excludeUsers\", tostring(TargetResources[0].modifiedProperties[0].oldValue))\n| extend excludeGroupsOld = extractjson(\"$.conditions.users.excludeGroups\", tostring(TargetResources[0].modifiedProperties[0].oldValue))\n| extend excludeRolesOld = extractjson(\"$.conditions.users.excludeRoles\", tostring(TargetResources[0].modifiedProperties[0].oldValue))\n| extend excludeUsersNew = extractjson(\"$.conditions.users.excludeUsers\", tostring(TargetResources[0].modifiedProperties[0].newValue))\n| extend excludeGroupsNew = extractjson(\"$.conditions.users.excludeGroups\", tostring(TargetResources[0].modifiedProperties[0].newValue))\n| extend excludeRolesNew = extractjson(\"$.conditions.users.excludeRoles\", tostring(TargetResources[0].modifiedProperties[0].newValue))\n| where excludeUsersOld != excludeUsersNew or excludeGroupsOld != excludeGroupsNew or excludeRolesOld != excludeRolesNew\n| extend modifiedBy = tostring(InitiatedBy.user.userPrincipalName)\n| extend accountName = tostring(split(modifiedBy, \"@\")[0])\n| extend upnSuffix = tostring(split(modifiedBy, \"@\")[1])\n| project TimeGenerated, OperationName, policy = TargetResources[0].displayName, modifiedBy, accountName, upnSuffix, result = Result,\n          excludeUsersOld, excludeUsersNew, excludeGroupsOld, excludeGroupsNew, excludeRolesOld, excludeRolesNew\n| order by TimeGenerated desc\n",
                                "queryFrequency": "PT5M",
                                "queryPeriod": "PT5M",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "Persistence",
                                  "DefenseEvasion",
                                  "CredentialAccess"
                                ],
                                "techniques": [
                                  "T1098",
                                  "T1078"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "accountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "upnSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  }
                                ],
                                "eventGroupingSettings": {
                                  "aggregationKind": "AlertPerResult"
                                },
                                "incidentConfiguration": {
                                  "createIncident": true,
                                  "groupingConfiguration": {
                                    "enabled": false,
                                    "matchingMethod": "AllEntities",
                                    "reopenClosedIncident": false,
                                    "lookbackDuration": "PT1H"
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject71').analyticRuleId71,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 71",
                                "parentId": "[variables('analyticRuleObject71').analyticRuleId71]",
                                "contentId": "[variables('analyticRuleObject71')._analyticRulecontentId71]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject71').analyticRuleVersion71]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject71')._analyticRulecontentId71]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Conditional Access - A Conditional Access user/group/role exclusion has changed",
                        "contentProductId": "[variables('analyticRuleObject71')._analyticRulecontentProductId71]",
                        "id": "[variables('analyticRuleObject71')._analyticRulecontentProductId71]",
                        "version": "[variables('analyticRuleObject71').analyticRuleVersion71]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject72').analyticRuleTemplateSpecName72]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Conditional Access - A new Conditional Access policy was created_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject72').analyticRuleVersion72]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject72')._analyticRulecontentId72]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "A new Conditional Access policy was created in Entra ID.",
                                "displayName": "Conditional Access - A new Conditional Access policy was created",
                                "enabled": false,
                                "query": "// A new Conditional Access policy was created.\nAuditLogs\n| where OperationName in (\"Add conditional access policy\")\n| extend modifiedBy = tostring(InitiatedBy.user.userPrincipalName)\n| extend accountName = tostring(split(modifiedBy, \"@\")[0])\n| extend upnSuffix = tostring(split(modifiedBy, \"@\")[1])\n| project\n    TimeGenerated,\n    OperationName,\n    policy = TargetResources[0].displayName,\n    modifiedBy,\n    accountName,\n    upnSuffix,\n    result = Result,\n    newPolicy = TargetResources[0].modifiedProperties[0].newValue\n| order by TimeGenerated desc\n",
                                "queryFrequency": "PT5M",
                                "queryPeriod": "PT5M",
                                "severity": "Informational",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "DefenseEvasion"
                                ],
                                "subTechniques": [
                                  "T1562.007"
                                ],
                                "techniques": [
                                  "T1562"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "accountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "upnSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  }
                                ],
                                "eventGroupingSettings": {
                                  "aggregationKind": "AlertPerResult"
                                },
                                "incidentConfiguration": {
                                  "createIncident": true,
                                  "groupingConfiguration": {
                                    "enabled": false,
                                    "matchingMethod": "AllEntities",
                                    "reopenClosedIncident": false,
                                    "lookbackDuration": "PT1H"
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject72').analyticRuleId72,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 72",
                                "parentId": "[variables('analyticRuleObject72').analyticRuleId72]",
                                "contentId": "[variables('analyticRuleObject72')._analyticRulecontentId72]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject72').analyticRuleVersion72]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject72')._analyticRulecontentId72]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Conditional Access - A new Conditional Access policy was created",
                        "contentProductId": "[variables('analyticRuleObject72')._analyticRulecontentProductId72]",
                        "id": "[variables('analyticRuleObject72')._analyticRulecontentProductId72]",
                        "version": "[variables('analyticRuleObject72').analyticRuleVersion72]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('analyticRuleObject73').analyticRuleTemplateSpecName73]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Conditional Access - Dynamic Group Exclusion Changes_AnalyticalRules Analytics Rule with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('analyticRuleObject73').analyticRuleVersion73]",
                          "parameters": {},
                          "variables": {},
                          "resources": [
                            {
                              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                              "name": "[variables('analyticRuleObject73')._analyticRulecontentId73]",
                              "apiVersion": "2023-02-01-preview",
                              "kind": "Scheduled",
                              "location": "[parameters('workspace-location')]",
                              "properties": {
                                "description": "// Detects changes to Dynamic Membership Rules for specified groups (often used in CA exclusions)",
                                "displayName": "Conditional Access - Dynamic Group Exclusion Changes",
                                "enabled": false,
                                "query": "// Detects changes to Dynamic Membership Rules for specified groups (often used in CA exclusions)\nlet monitoredGroups = dynamic([\"Group1\", \"Group2\"]);  // <-- Customize this list\nAuditLogs\n| where OperationName == \"Update group\"\n| where AdditionalDetails[0].value == \"DynamicMembership\"\n| extend DynamicGroupName = tostring(TargetResources[0].displayName)\n| where DynamicGroupName in (monitoredGroups)\n| extend modifiedBy = tostring(InitiatedBy.user.userPrincipalName)\n| extend accountName = tostring(split(modifiedBy, \"@\")[0])\n| extend upnSuffix = tostring(split(modifiedBy, \"@\")[1])\n| extend oldRule = tostring(TargetResources[0].modifiedProperties[0].oldValue)\n| extend newRule = tostring(TargetResources[0].modifiedProperties[0].newValue)\n| where oldRule != newRule\n| project\n    TimeGenerated,\n    OperationName,\n    DynamicGroupName,\n    modifiedBy,\n    accountName,\n    upnSuffix,\n    result = Result,\n    oldRule,\n    newRule\n| order by TimeGenerated desc",
                                "queryFrequency": "PT5M",
                                "queryPeriod": "PT5M",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                  {
                                    "connectorId": "AzureActiveDirectory",
                                    "dataTypes": [
                                      "AuditLogs"
                                    ]
                                  }
                                ],
                                "tactics": [
                                  "PrivilegeEscalation"
                                ],
                                "techniques": [
                                  "T1484"
                                ],
                                "entityMappings": [
                                  {
                                    "fieldMappings": [
                                      {
                                        "columnName": "accountName",
                                        "identifier": "Name"
                                      },
                                      {
                                        "columnName": "upnSuffix",
                                        "identifier": "UPNSuffix"
                                      }
                                    ],
                                    "entityType": "Account"
                                  }
                                ],
                                "eventGroupingSettings": {
                                  "aggregationKind": "AlertPerResult"
                                },
                                "incidentConfiguration": {
                                  "createIncident": true,
                                  "groupingConfiguration": {
                                    "enabled": false,
                                    "matchingMethod": "AllEntities",
                                    "reopenClosedIncident": false,
                                    "lookbackDuration": "PT5H"
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject73').analyticRuleId73,'/'))))]",
                              "properties": {
                                "description": "Microsoft Entra ID Analytics Rule 73",
                                "parentId": "[variables('analyticRuleObject73').analyticRuleId73]",
                                "contentId": "[variables('analyticRuleObject73')._analyticRulecontentId73]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject73').analyticRuleVersion73]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ]
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('analyticRuleObject73')._analyticRulecontentId73]",
                        "contentKind": "AnalyticsRule",
                        "displayName": "Conditional Access - Dynamic Group Exclusion Changes",
                        "contentProductId": "[variables('analyticRuleObject73')._analyticRulecontentProductId73]",
                        "id": "[variables('analyticRuleObject73')._analyticRulecontentProductId73]",
                        "version": "[variables('analyticRuleObject73').analyticRuleVersion73]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('playbookTemplateSpecName1')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Block-EntraIDUser-Alert Playbook with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('playbookVersion1')]",
                          "parameters": {
                            "PlaybookName": {
                              "defaultValue": "Block-EntraIDUser-Alert",
                              "type": "string"
                            }
                          },
                          "variables": {
                            "AzureADConnectionName": "[[concat('azuread-', parameters('PlaybookName'))]",
                            "MicrosoftSentinelConnectionName": "[[concat('microsoftsentinel-', parameters('PlaybookName'))]",
                            "Office365ConnectionName": "[[concat('office365-', parameters('PlaybookName'))]",
                            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuread')]",
                            "_connection-1": "[[variables('connection-1')]",
                            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                            "_connection-2": "[[variables('connection-2')]",
                            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]",
                            "_connection-3": "[[variables('connection-3')]",
                            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                            "workspace-name": "[parameters('workspace')]",
                            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('AzureADConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "properties": {
                                "displayName": "[[variables('AzureADConnectionName')]",
                                "api": {
                                  "id": "[[variables('_connection-1')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('MicrosoftSentinelConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "kind": "V1",
                              "properties": {
                                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                                "parameterValueType": "Alternative",
                                "api": {
                                  "id": "[[variables('_connection-2')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('Office365ConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "properties": {
                                "displayName": "[[variables('Office365ConnectionName')]",
                                "api": {
                                  "id": "[[variables('_connection-3')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Logic/workflows",
                              "apiVersion": "2017-07-01",
                              "name": "[[parameters('PlaybookName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "tags": {
                                "LogicAppsCategory": "security",
                                "hidden-SentinelTemplateName": "Block-AADUser_alert",
                                "hidden-SentinelTemplateVersion": "1.1",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                              },
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('AzureADConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]"
                              ],
                              "properties": {
                                "state": "Enabled",
                                "definition": {
                                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                  "contentVersion": "1.0.0.0",
                                  "parameters": {
                                    "$connections": {
                                      "type": "Object"
                                    }
                                  },
                                  "triggers": {
                                    "Microsoft_Sentinel_alert": {
                                      "type": "ApiConnectionWebhook",
                                      "inputs": {
                                        "body": {
                                          "callback_url": "@{listCallbackUrl()}"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                          }
                                        },
                                        "path": "/subscribe"
                                      }
                                    }
                                  },
                                  "actions": {
                                    "Alert_-_Get_incident": {
                                      "type": "ApiConnection",
                                      "inputs": {
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                          }
                                        },
                                        "method": "get",
                                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                                      }
                                    },
                                    "Entities_-_Get_Accounts": {
                                      "runAfter": {
                                        "Alert_-_Get_incident": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "ApiConnection",
                                      "inputs": {
                                        "body": "@triggerBody()?['Entities']",
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                          }
                                        },
                                        "method": "post",
                                        "path": "/entities/account"
                                      }
                                    },
                                    "For_each": {
                                      "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
                                      "actions": {
                                        "Condition": {
                                          "actions": {
                                            "Condition_-_if_user_have_manager": {
                                              "actions": {
                                                "Add_comment_to_incident_-_with_manager_-_no_admin": {
                                                  "runAfter": {
                                                    "Get_user_-_details": [
                                                      "Succeeded"
                                                    ]
                                                  },
                                                  "type": "ApiConnection",
                                                  "inputs": {
                                                    "body": {
                                                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                                      "message": "<p>User @{items('For_each')?['Name']} (UPN - @{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])}) was disabled in AAD via playbook Block-AADUser. Manager (@{body('Parse_JSON_-_get_user_manager')?['userPrincipalName']}) is notified.</p>"
                                                    },
                                                    "host": {
                                                      "connection": {
                                                        "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                                      }
                                                    },
                                                    "method": "post",
                                                    "path": "/Incidents/Comment"
                                                  }
                                                },
                                                "Get_user_-_details": {
                                                  "type": "ApiConnection",
                                                  "inputs": {
                                                    "host": {
                                                      "connection": {
                                                        "name": "@parameters('$connections')['azuread']['connectionId']"
                                                      }
                                                    },
                                                    "method": "get",
                                                    "path": "/v1.0/users/@{encodeURIComponent(concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix']))}"
                                                  }
                                                },
                                                "Send_an_email_-_to_manager_-_no_admin": {
                                                  "runAfter": {
                                                    "Add_comment_to_incident_-_with_manager_-_no_admin": [
                                                      "Succeeded"
                                                    ]
                                                  },
                                                  "type": "ApiConnection",
                                                  "inputs": {
                                                    "body": {
                                                      "Body": "<p>Security notification! This is automated email sent by Microsoft Sentinel Automation!<br>\n<br>\nYour direct report @{items('For_each')?['Name']} has been disabled in Azure AD due to the security incident. Can you please notify the user and work with him to reach&nbsp;our support.<br>\n<br>\nDirect report details:<br>\nFirst name: @{body('Get_user_-_details')?['displayName']}<br>\nSurname: @{body('Get_user_-_details')?['surname']}<br>\nJob title: @{body('Get_user_-_details')?['jobTitle']}<br>\nOffice location: @{body('Get_user_-_details')?['officeLocation']}<br>\nBusiness phone: @{body('Get_user_-_details')?['businessPhones']}<br>\nMobile phone: @{body('Get_user_-_details')?['mobilePhone']}<br>\nMail: @{body('Get_user_-_details')?['mail']}<br>\n<br>\nThank you!</p>",
                                                      "Importance": "High",
                                                      "Subject": "@{items('For_each')?['Name']} has been disabled in Azure AD due to the security risk!",
                                                      "To": "@body('Parse_JSON_-_get_user_manager')?['userPrincipalName']"
                                                    },
                                                    "host": {
                                                      "connection": {
                                                        "name": "@parameters('$connections')['office365']['connectionId']"
                                                      }
                                                    },
                                                    "method": "post",
                                                    "path": "/v2/Mail"
                                                  }
                                                }
                                              },
                                              "runAfter": {
                                                "Parse_JSON_-_get_user_manager": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "else": {
                                                "actions": {
                                                  "Add_comment_to_incident_-_no_manager_-_no_admin": {
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                      "body": {
                                                        "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                                        "message": "<p>User @{items('For_each')?['Name']} (UPN - @{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])}) was disabled in AAD via playbook Block-AADUser. Manager has not been notified, since it is not found for this user!</p>"
                                                      },
                                                      "host": {
                                                        "connection": {
                                                          "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                                        }
                                                      },
                                                      "method": "post",
                                                      "path": "/Incidents/Comment"
                                                    }
                                                  }
                                                }
                                              },
                                              "expression": {
                                                "and": [
                                                  {
                                                    "not": {
                                                      "equals": [
                                                        "@body('Parse_JSON_-_get_user_manager')?['userPrincipalName']",
                                                        "@null"
                                                      ]
                                                    }
                                                  }
                                                ]
                                              },
                                              "type": "If"
                                            },
                                            "HTTP_-_get_user_manager": {
                                              "type": "Http",
                                              "inputs": {
                                                "authentication": {
                                                  "audience": "https://graph.microsoft.com/",
                                                  "type": "ManagedServiceIdentity"
                                                },
                                                "method": "GET",
                                                "uri": "https://graph.microsoft.com/v1.0/users/@{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])}/manager"
                                              }
                                            },
                                            "Parse_JSON_-_get_user_manager": {
                                              "runAfter": {
                                                "HTTP_-_get_user_manager": [
                                                  "Succeeded",
                                                  "Failed"
                                                ]
                                              },
                                              "type": "ParseJson",
                                              "inputs": {
                                                "content": "@body('HTTP_-_get_user_manager')",
                                                "schema": {
                                                  "properties": {
                                                    "userPrincipalName": {
                                                      "type": "string"
                                                    }
                                                  },
                                                  "type": "object"
                                                }
                                              }
                                            }
                                          },
                                          "runAfter": {
                                            "Update_user_-_disable_user": [
                                              "Succeeded",
                                              "Failed"
                                            ]
                                          },
                                          "else": {
                                            "actions": {
                                              "Add_comment_to_incident_-_error_details": {
                                                "type": "ApiConnection",
                                                "inputs": {
                                                  "body": {
                                                    "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                                    "message": "<p>Block-AADUser playbook could not disable user @{items('For_each')?['Name']}.<br>\nError message: @{body('Update_user_-_disable_user')['error']['message']}<br>\nNote: If user is admin, this playbook don't have privilages to block admin users!</p>"
                                                  },
                                                  "host": {
                                                    "connection": {
                                                      "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                                    }
                                                  },
                                                  "method": "post",
                                                  "path": "/Incidents/Comment"
                                                }
                                              }
                                            }
                                          },
                                          "expression": {
                                            "and": [
                                              {
                                                "equals": [
                                                  "@body('Update_user_-_disable_user')",
                                                  "@null"
                                                ]
                                              }
                                            ]
                                          },
                                          "type": "If"
                                        },
                                        "Update_user_-_disable_user": {
                                          "type": "ApiConnection",
                                          "inputs": {
                                            "body": {
                                              "accountEnabled": false
                                            },
                                            "host": {
                                              "connection": {
                                                "name": "@parameters('$connections')['azuread']['connectionId']"
                                              }
                                            },
                                            "method": "patch",
                                            "path": "/v1.0/users/@{encodeURIComponent(concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix']))}"
                                          }
                                        }
                                      },
                                      "runAfter": {
                                        "Entities_-_Get_Accounts": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "Foreach"
                                    }
                                  }
                                },
                                "parameters": {
                                  "$connections": {
                                    "value": {
                                      "azuread": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureADConnectionName'))]",
                                        "connectionName": "[[variables('AzureADConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuread')]"
                                      },
                                      "microsoftsentinel": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                                        "connectionProperties": {
                                          "authentication": {
                                            "type": "ManagedServiceIdentity"
                                          }
                                        }
                                      },
                                      "office365": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                                        "connectionName": "[[variables('Office365ConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]"
                                      }
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId1'),'/'))))]",
                              "properties": {
                                "parentId": "[variables('playbookId1')]",
                                "contentId": "[variables('_playbookContentId1')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion1')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ],
                          "metadata": {
                            "title": "Block Microsoft Entra ID user - Alert",
                            "description": "For each account entity included in the alert, this playbook will disable the user in Microsoft Entra ID, add a comment to the incident that contains this alert and notify manager if available. Note: This playbook will not disable admin user!",
                            "prerequisites": [
                              "None"
                            ],
                            "postDeployment": [
                              "1. Assign Microsoft Sentinel Responder role to the Playbook's managed identity.",
                              "2. Grant User.Read.All, User.ReadWrite.All, Directory.Read.All, Directory.ReadWrite.All permissions to the managed identity.",
                              "3. Authorize Microsoft Entra ID and Office 365 Outlook Logic App connections.",
                              "4. For more detailed steps [click Here](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Microsoft%20Entra%20ID/Playbooks/Block-AADUser/readme.md)"
                            ],
                            "lastUpdateTime": "2022-07-11T00:00:00Z",
                            "entities": [
                              "Account"
                            ],
                            "tags": [
                              "Remediation"
                            ],
                            "releaseNotes": [
                              {
                                "version": "1.0.0",
                                "title": "Added manager notification action",
                                "notes": [
                                  "Initial version"
                                ]
                              }
                            ]
                          }
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_playbookContentId1')]",
                        "contentKind": "Playbook",
                        "displayName": "Block-EntraIDUser-Alert",
                        "contentProductId": "[variables('_playbookcontentProductId1')]",
                        "id": "[variables('_playbookcontentProductId1')]",
                        "version": "[variables('playbookVersion1')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('playbookTemplateSpecName2')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Block-EntraIDUser-Incident Playbook with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('playbookVersion2')]",
                          "parameters": {
                            "PlaybookName": {
                              "defaultValue": "Block-EntraIDUser-Incident",
                              "type": "string"
                            }
                          },
                          "variables": {
                            "AzureADConnectionName": "[[concat('azuread-', parameters('PlaybookName'))]",
                            "MicrosoftSentinelConnectionName": "[[concat('microsoftsentinel-', parameters('PlaybookName'))]",
                            "Office365ConnectionName": "[[concat('office365-', parameters('PlaybookName'))]",
                            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuread')]",
                            "_connection-1": "[[variables('connection-1')]",
                            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                            "_connection-2": "[[variables('connection-2')]",
                            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]",
                            "_connection-3": "[[variables('connection-3')]",
                            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                            "workspace-name": "[parameters('workspace')]",
                            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('AzureADConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "properties": {
                                "displayName": "[[variables('AzureADConnectionName')]",
                                "api": {
                                  "id": "[[variables('_connection-1')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('MicrosoftSentinelConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "kind": "V1",
                              "properties": {
                                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                                "parameterValueType": "Alternative",
                                "api": {
                                  "id": "[[variables('_connection-2')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('Office365ConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "properties": {
                                "displayName": "[[variables('Office365ConnectionName')]",
                                "api": {
                                  "id": "[[variables('_connection-3')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Logic/workflows",
                              "apiVersion": "2017-07-01",
                              "name": "[[parameters('PlaybookName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "tags": {
                                "LogicAppsCategory": "security",
                                "hidden-SentinelTemplateName": "Block-AADUser",
                                "hidden-SentinelTemplateVersion": "1.1",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                              },
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('AzureADConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]"
                              ],
                              "properties": {
                                "state": "Enabled",
                                "definition": {
                                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                  "contentVersion": "1.0.0.0",
                                  "parameters": {
                                    "$connections": {
                                      "type": "Object"
                                    }
                                  },
                                  "triggers": {
                                    "Microsoft_Sentinel_incident": {
                                      "inputs": {
                                        "body": {
                                          "callback_url": "@{listCallbackUrl()}"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                          }
                                        },
                                        "path": "/incident-creation"
                                      },
                                      "type": "ApiConnectionWebhook"
                                    }
                                  },
                                  "actions": {
                                    "Entities_-_Get_Accounts": {
                                      "type": "ApiConnection",
                                      "inputs": {
                                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                          }
                                        },
                                        "method": "post",
                                        "path": "/entities/account"
                                      }
                                    },
                                    "For_each": {
                                      "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
                                      "actions": {
                                        "Condition": {
                                          "actions": {
                                            "Condition_-_if_user_have_manager": {
                                              "actions": {
                                                "Add_comment_to_incident_-_with_manager_-_no_admin": {
                                                  "runAfter": {
                                                    "Get_user_-_details": [
                                                      "Succeeded"
                                                    ]
                                                  },
                                                  "type": "ApiConnection",
                                                  "inputs": {
                                                    "body": {
                                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                                      "message": "<p>User @{items('For_each')?['Name']} (UPN - @{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])}) was disabled in AAD via playbook Block-AADUser. Manager (@{body('Parse_JSON_-_get_user_manager')?['userPrincipalName']}) is notified.</p>"
                                                    },
                                                    "host": {
                                                      "connection": {
                                                        "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                                      }
                                                    },
                                                    "method": "post",
                                                    "path": "/Incidents/Comment"
                                                  }
                                                },
                                                "Get_user_-_details": {
                                                  "type": "ApiConnection",
                                                  "inputs": {
                                                    "host": {
                                                      "connection": {
                                                        "name": "@parameters('$connections')['azuread']['connectionId']"
                                                      }
                                                    },
                                                    "method": "get",
                                                    "path": "/v1.0/users/@{encodeURIComponent(concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix']))}"
                                                  }
                                                },
                                                "Send_an_email_-_to_manager_-_no_admin": {
                                                  "runAfter": {
                                                    "Add_comment_to_incident_-_with_manager_-_no_admin": [
                                                      "Succeeded"
                                                    ]
                                                  },
                                                  "type": "ApiConnection",
                                                  "inputs": {
                                                    "body": {
                                                      "Body": "<p>Security notification! This is automated email sent by Microsoft Sentinel Automation!<br>\n<br>\nYour direct report @{items('For_each')?['Name']} has been disabled in Azure AD due to the security incident. Can you please notify the user and work with him to reach&nbsp;our support.<br>\n<br>\nDirect report details:<br>\nFirst name: @{body('Get_user_-_details')?['displayName']}<br>\nSurname: @{body('Get_user_-_details')?['surname']}<br>\nJob title: @{body('Get_user_-_details')?['jobTitle']}<br>\nOffice location: @{body('Get_user_-_details')?['officeLocation']}<br>\nBusiness phone: @{body('Get_user_-_details')?['businessPhones']}<br>\nMobile phone: @{body('Get_user_-_details')?['mobilePhone']}<br>\nMail: @{body('Get_user_-_details')?['mail']}<br>\n<br>\nThank you!</p>",
                                                      "Importance": "High",
                                                      "Subject": "@{items('For_each')?['Name']}  has been disabled in Azure AD due to the security risk!",
                                                      "To": "@body('Parse_JSON_-_get_user_manager')?['userPrincipalName']"
                                                    },
                                                    "host": {
                                                      "connection": {
                                                        "name": "@parameters('$connections')['office365']['connectionId']"
                                                      }
                                                    },
                                                    "method": "post",
                                                    "path": "/v2/Mail"
                                                  }
                                                }
                                              },
                                              "runAfter": {
                                                "Parse_JSON_-_get_user_manager": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "else": {
                                                "actions": {
                                                  "Add_comment_to_incident_-_no_manager_-_no_admin": {
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                      "body": {
                                                        "incidentArmId": "@triggerBody()?['object']?['id']",
                                                        "message": "<p>User @{items('For_each')?['Name']} (UPN - @{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])}) was disabled in AAD via playbook Block-AADUser. Manager has not been notified, since it is not found for this user!</p>"
                                                      },
                                                      "host": {
                                                        "connection": {
                                                          "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                                        }
                                                      },
                                                      "method": "post",
                                                      "path": "/Incidents/Comment"
                                                    }
                                                  }
                                                }
                                              },
                                              "expression": {
                                                "and": [
                                                  {
                                                    "not": {
                                                      "equals": [
                                                        "@body('Parse_JSON_-_get_user_manager')?['userPrincipalName']",
                                                        "@null"
                                                      ]
                                                    }
                                                  }
                                                ]
                                              },
                                              "type": "If"
                                            },
                                            "HTTP_-_get_user_manager": {
                                              "type": "Http",
                                              "inputs": {
                                                "authentication": {
                                                  "audience": "https://graph.microsoft.com/",
                                                  "type": "ManagedServiceIdentity"
                                                },
                                                "method": "GET",
                                                "uri": "https://graph.microsoft.com/v1.0/users/@{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])}/manager"
                                              }
                                            },
                                            "Parse_JSON_-_get_user_manager": {
                                              "runAfter": {
                                                "HTTP_-_get_user_manager": [
                                                  "Succeeded",
                                                  "Failed"
                                                ]
                                              },
                                              "type": "ParseJson",
                                              "inputs": {
                                                "content": "@body('HTTP_-_get_user_manager')",
                                                "schema": {
                                                  "properties": {
                                                    "userPrincipalName": {
                                                      "type": "string"
                                                    }
                                                  },
                                                  "type": "object"
                                                }
                                              }
                                            }
                                          },
                                          "runAfter": {
                                            "Update_user_-_disable_user": [
                                              "Succeeded",
                                              "Failed"
                                            ]
                                          },
                                          "else": {
                                            "actions": {
                                              "Add_comment_to_incident_-_error_details": {
                                                "type": "ApiConnection",
                                                "inputs": {
                                                  "body": {
                                                    "incidentArmId": "@triggerBody()?['object']?['id']",
                                                    "message": "<p>Block-AADUser playbook could not disable user @{items('For_each')?['Name']}.<br>\nError message: @{body('Update_user_-_disable_user')['error']['message']}<br>\nNote: If user is admin, this playbook don't have privilages to block admin users!</p>"
                                                  },
                                                  "host": {
                                                    "connection": {
                                                      "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                                    }
                                                  },
                                                  "method": "post",
                                                  "path": "/Incidents/Comment"
                                                }
                                              }
                                            }
                                          },
                                          "expression": {
                                            "and": [
                                              {
                                                "equals": [
                                                  "@body('Update_user_-_disable_user')",
                                                  "@null"
                                                ]
                                              }
                                            ]
                                          },
                                          "type": "If"
                                        },
                                        "Update_user_-_disable_user": {
                                          "type": "ApiConnection",
                                          "inputs": {
                                            "body": {
                                              "accountEnabled": false
                                            },
                                            "host": {
                                              "connection": {
                                                "name": "@parameters('$connections')['azuread']['connectionId']"
                                              }
                                            },
                                            "method": "patch",
                                            "path": "/v1.0/users/@{encodeURIComponent(concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix']))}"
                                          }
                                        }
                                      },
                                      "runAfter": {
                                        "Entities_-_Get_Accounts": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "Foreach"
                                    }
                                  }
                                },
                                "parameters": {
                                  "$connections": {
                                    "value": {
                                      "azuread": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureADConnectionName'))]",
                                        "connectionName": "[[variables('AzureADConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuread')]"
                                      },
                                      "microsoftsentinel": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                                        "connectionProperties": {
                                          "authentication": {
                                            "type": "ManagedServiceIdentity"
                                          }
                                        }
                                      },
                                      "office365": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                                        "connectionName": "[[variables('Office365ConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]"
                                      }
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
                              "properties": {
                                "parentId": "[variables('playbookId2')]",
                                "contentId": "[variables('_playbookContentId2')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion2')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ],
                          "metadata": {
                            "title": "Block Entra ID user - Incident",
                            "description": "For each account entity included in the incident, this playbook will disable the user in Microsoft Entra ID, add a comment to the incident that contains this alert and notify manager if available. Note: This playbook will not disable admin user!",
                            "prerequisites": [
                              "None"
                            ],
                            "postDeployment": [
                              "1. Assign Microsoft Sentinel Responder role to the Playbook's managed identity.",
                              "2. Grant User.Read.All, User.ReadWrite.All, Directory.Read.All, Directory.ReadWrite.All permissions to the managed identity.",
                              "3. Authorize Microsoft Entra ID and Office 365 Outlook Logic App connections.",
                              "4. For more detailed steps [click Here](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Microsoft%20Entra%20ID/Playbooks/Block-AADUser/readme.md)"
                            ],
                            "lastUpdateTime": "2022-07-11T00:00:00Z",
                            "entities": [
                              "Account"
                            ],
                            "tags": [
                              "Remediation"
                            ],
                            "releaseNotes": [
                              {
                                "version": "1.0.0",
                                "title": "Added manager notification action",
                                "notes": [
                                  "Initial version"
                                ]
                              }
                            ]
                          }
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_playbookContentId2')]",
                        "contentKind": "Playbook",
                        "displayName": "Block-EntraIDUser-Incident",
                        "contentProductId": "[variables('_playbookcontentProductId2')]",
                        "id": "[variables('_playbookcontentProductId2')]",
                        "version": "[variables('playbookVersion2')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('playbookTemplateSpecName3')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Prompt-User-Alert Playbook with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('playbookVersion3')]",
                          "parameters": {
                            "PlaybookName": {
                              "defaultValue": "Prompt-User-Alert",
                              "type": "string"
                            },
                            "TeamsId": {
                              "metadata": {
                                "description": "Enter the Teams Group ID"
                              },
                              "type": "string"
                            },
                            "TeamsChannelId": {
                              "metadata": {
                                "description": "Enter the Teams Channel ID"
                              },
                              "type": "string"
                            }
                          },
                          "variables": {
                            "AzureADConnectionName": "[[concat('azuread-', parameters('PlaybookName'))]",
                            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
                            "Office365ConnectionName": "[[concat('office365-', parameters('PlaybookName'))]",
                            "TeamsConnectionName": "[[concat('teams-', parameters('PlaybookName'))]",
                            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuread')]",
                            "_connection-1": "[[variables('connection-1')]",
                            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                            "_connection-2": "[[variables('connection-2')]",
                            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]",
                            "_connection-3": "[[variables('connection-3')]",
                            "connection-4": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/teams')]",
                            "_connection-4": "[[variables('connection-4')]",
                            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                            "workspace-name": "[parameters('workspace')]",
                            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('AzureADConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "properties": {
                                "displayName": "[[variables('AzureADConnectionName')]",
                                "api": {
                                  "id": "[[variables('_connection-1')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('AzureSentinelConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "kind": "V1",
                              "properties": {
                                "displayName": "[[variables('AzureSentinelConnectionName')]",
                                "parameterValueType": "Alternative",
                                "api": {
                                  "id": "[[variables('_connection-2')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('Office365ConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "properties": {
                                "displayName": "[[variables('Office365ConnectionName')]",
                                "api": {
                                  "id": "[[variables('_connection-3')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('TeamsConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "properties": {
                                "displayName": "[[variables('TeamsConnectionName')]",
                                "api": {
                                  "id": "[[variables('_connection-4')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Logic/workflows",
                              "apiVersion": "2017-07-01",
                              "name": "[[parameters('PlaybookName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "tags": {
                                "LogicAppsCategory": "security",
                                "hidden-SentinelTemplateName": "Prompt-User_alert",
                                "hidden-SentinelTemplateVersion": "1.1",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                              },
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('AzureADConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]"
                              ],
                              "properties": {
                                "state": "Enabled",
                                "definition": {
                                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                  "actions": {
                                    "Alert_-_Get_incident": {
                                      "inputs": {
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "get",
                                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                                      },
                                      "type": "ApiConnection"
                                    },
                                    "Entities_-_Get_Accounts": {
                                      "inputs": {
                                        "body": "@triggerBody()?['Entities']",
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "post",
                                        "path": "/entities/account"
                                      },
                                      "runAfter": {
                                        "Alert_-_Get_incident": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "ApiConnection"
                                    },
                                    "For_each": {
                                      "actions": {
                                        "Condition_2": {
                                          "actions": {
                                            "Add_comment_to_incident_(V3)": {
                                              "inputs": {
                                                "body": {
                                                  "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                                  "message": "<p>@{body('Get_user')?['displayName']} confirms they completed the action that triggered the alert. &nbsp;Closing the incident.</p>"
                                                },
                                                "host": {
                                                  "connection": {
                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                  }
                                                },
                                                "method": "post",
                                                "path": "/Incidents/Comment"
                                              },
                                              "type": "ApiConnection"
                                            },
                                            "Update_incident": {
                                              "inputs": {
                                                "body": {
                                                  "classification": {
                                                    "ClassificationAndReason": "BenignPositive - SuspiciousButExpected",
                                                    "ClassificationReasonText": "User Confirmed it was them"
                                                  },
                                                  "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                                  "status": "Closed"
                                                },
                                                "host": {
                                                  "connection": {
                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                  }
                                                },
                                                "method": "put",
                                                "path": "/Incidents"
                                              },
                                              "runAfter": {
                                                "Add_comment_to_incident_(V3)": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "type": "ApiConnection"
                                            }
                                          },
                                          "else": {
                                            "actions": {
                                              "Add_comment_to_incident_(V3)_2": {
                                                "inputs": {
                                                  "body": {
                                                    "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                                    "message": "<p>@{body('Get_user')?['displayName']} confirms they did not complete the action. Further investigation is needed.</p>"
                                                  },
                                                  "host": {
                                                    "connection": {
                                                      "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                    }
                                                  },
                                                  "method": "post",
                                                  "path": "/Incidents/Comment"
                                                },
                                                "type": "ApiConnection"
                                              },
                                              "Post_message_in_a_chat_or_channel": {
                                                "inputs": {
                                                  "body": {
                                                    "messageBody": "<p>New alert from Microsoft Sentinel.<br>\nPlease investigate ASAP.<br>\nSeverity : @{body('Alert_-_Get_incident')?['properties']?['severity']}<br>\nDescription: @{body('Alert_-_Get_incident')?['properties']?['description']}<br>\n<br>\n@{body('Get_user')?['displayName']} user confirmed they did not complete the action.</p>",
                                                    "recipient": {
                                                      "channelId": "[[parameters('TeamsChannelId')]",
                                                      "groupId": "[[parameters('TeamsId')]"
                                                    },
                                                    "subject": "Incident @{body('Alert_-_Get_incident')?['properties']?['incidentNumber']} - @{body('Alert_-_Get_incident')?['properties']?['title']}"
                                                  },
                                                  "host": {
                                                    "connection": {
                                                      "name": "@parameters('$connections')['teams']['connectionId']"
                                                    }
                                                  },
                                                  "method": "post",
                                                  "path": "/beta/teams/conversation/message/poster/@{encodeURIComponent('User')}/location/@{encodeURIComponent('Channel')}"
                                                },
                                                "runAfter": {
                                                  "Add_comment_to_incident_(V3)_2": [
                                                    "Succeeded"
                                                  ]
                                                },
                                                "type": "ApiConnection"
                                              }
                                            }
                                          },
                                          "expression": {
                                            "and": [
                                              {
                                                "equals": [
                                                  "",
                                                  "This was me"
                                                ]
                                              }
                                            ]
                                          },
                                          "runAfter": {
                                            "Send_approval_email": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "If"
                                        },
                                        "Get_user": {
                                          "inputs": {
                                            "host": {
                                              "connection": {
                                                "name": "@parameters('$connections')['azuread']['connectionId']"
                                              }
                                            },
                                            "method": "get",
                                            "path": "/v1.0/users/@{encodeURIComponent(concat(items('For_each')?['Name'], '@' ,items('For_each')?['UPNSuffix']))}"
                                          },
                                          "type": "ApiConnection"
                                        },
                                        "Send_approval_email": {
                                          "inputs": {
                                            "body": {
                                              "Message": {
                                                "Body": "New Alert from Microsoft Sentinel.\nPlease respond ASAP.\nSeverity: @{triggerBody()?['Severity']}\nName: @{triggerBody()?['AlertDisplayName']}\nDescription: @{triggerBody()?['Description']}",
                                                "HideHTMLMessage": false,
                                                "Importance": "High",
                                                "Options": "This was me, This was not me",
                                                "ShowHTMLConfirmationDialog": false,
                                                "Subject": "Security Alert: @{body('Alert_-_Get_incident')?['properties']?['title']}",
                                                "To": "@body('Get_user')?['mail']"
                                              },
                                              "NotificationUrl": "@{listCallbackUrl()}"
                                            },
                                            "host": {
                                              "connection": {
                                                "name": "@parameters('$connections')['office365']['connectionId']"
                                              }
                                            },
                                            "path": "/approvalmail/$subscriptions"
                                          },
                                          "runAfter": {
                                            "Get_user": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "ApiConnectionWebhook"
                                        }
                                      },
                                      "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
                                      "runAfter": {
                                        "Entities_-_Get_Accounts": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "Foreach"
                                    }
                                  },
                                  "contentVersion": "1.0.0.0",
                                  "parameters": {
                                    "$connections": {
                                      "type": "Object"
                                    }
                                  },
                                  "triggers": {
                                    "Microsoft_Sentinel_alert": {
                                      "inputs": {
                                        "body": {
                                          "callback_url": "@{listCallbackUrl()}"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "path": "/subscribe"
                                      },
                                      "type": "ApiConnectionWebhook"
                                    }
                                  }
                                },
                                "parameters": {
                                  "$connections": {
                                    "value": {
                                      "azuread": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureADConnectionName'))]",
                                        "connectionName": "[[variables('AzureADConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuread')]"
                                      },
                                      "azuresentinel": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                                        "connectionProperties": {
                                          "authentication": {
                                            "type": "ManagedServiceIdentity"
                                          }
                                        }
                                      },
                                      "office365": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                                        "connectionName": "[[variables('Office365ConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]"
                                      },
                                      "teams": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]",
                                        "connectionName": "[[variables('TeamsConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/teams')]"
                                      }
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
                              "properties": {
                                "parentId": "[variables('playbookId3')]",
                                "contentId": "[variables('_playbookContentId3')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion3')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ],
                          "metadata": {
                            "title": "Prompt User - Alert",
                            "description": "This playbook will ask the user if they completed the action from the alert in Microsoft Sentinel.  If so, it will close the incident and add a comment.  If not, it will post a message to teams for the SOC to investigate and add a comment to the incident.",
                            "prerequisites": [
                              "1. You will need the Team Id and Channel Id."
                            ],
                            "postDeployment": [
                              "1. Assign Microsoft Sentinel Responder role to the Playbook's managed identity.",
                              "2. Authorize Microsoft Entra ID, Microsoft Teams, and Office 365 Outlook Logic App connections."
                            ],
                            "lastUpdateTime": "2022-07-11T00:00:00Z",
                            "entities": [
                              "Account"
                            ],
                            "tags": [
                              "Remediation"
                            ],
                            "releaseNotes": [
                              {
                                "version": "1.0.0",
                                "title": "Added new Post a Teams message action",
                                "notes": [
                                  "Initial version"
                                ]
                              }
                            ]
                          }
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_playbookContentId3')]",
                        "contentKind": "Playbook",
                        "displayName": "Prompt-User-Alert",
                        "contentProductId": "[variables('_playbookcontentProductId3')]",
                        "id": "[variables('_playbookcontentProductId3')]",
                        "version": "[variables('playbookVersion3')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('playbookTemplateSpecName4')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Prompt-User-Incident Playbook with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('playbookVersion4')]",
                          "parameters": {
                            "PlaybookName": {
                              "defaultValue": "Prompt-User-Incident",
                              "type": "string"
                            },
                            "TeamsId": {
                              "metadata": {
                                "description": "Enter the Teams Group ID"
                              },
                              "type": "string"
                            },
                            "TeamsChannelId": {
                              "metadata": {
                                "description": "Enter the Teams Channel ID"
                              },
                              "type": "string"
                            }
                          },
                          "variables": {
                            "AzureADConnectionName": "[[concat('azuread-', parameters('PlaybookName'))]",
                            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
                            "Office365ConnectionName": "[[concat('office365-', parameters('PlaybookName'))]",
                            "TeamsConnectionName": "[[concat('teams-', parameters('PlaybookName'))]",
                            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuread')]",
                            "_connection-1": "[[variables('connection-1')]",
                            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                            "_connection-2": "[[variables('connection-2')]",
                            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]",
                            "_connection-3": "[[variables('connection-3')]",
                            "connection-4": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/teams')]",
                            "_connection-4": "[[variables('connection-4')]",
                            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                            "workspace-name": "[parameters('workspace')]",
                            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('AzureADConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "properties": {
                                "displayName": "[[variables('AzureADConnectionName')]",
                                "api": {
                                  "id": "[[variables('_connection-1')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('AzureSentinelConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "kind": "V1",
                              "properties": {
                                "displayName": "[[variables('AzureSentinelConnectionName')]",
                                "parameterValueType": "Alternative",
                                "api": {
                                  "id": "[[variables('_connection-2')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('Office365ConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "properties": {
                                "displayName": "[[variables('Office365ConnectionName')]",
                                "api": {
                                  "id": "[[variables('_connection-3')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('TeamsConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "properties": {
                                "displayName": "[[variables('TeamsConnectionName')]",
                                "api": {
                                  "id": "[[variables('_connection-4')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Logic/workflows",
                              "apiVersion": "2017-07-01",
                              "name": "[[parameters('PlaybookName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "tags": {
                                "LogicAppsCategory": "security",
                                "hidden-SentinelTemplateName": "Prompt-User",
                                "hidden-SentinelTemplateVersion": "1.1",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                              },
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('AzureADConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]"
                              ],
                              "properties": {
                                "state": "Enabled",
                                "definition": {
                                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                  "actions": {
                                    "Entities_-_Get_Accounts": {
                                      "inputs": {
                                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "post",
                                        "path": "/entities/account"
                                      },
                                      "type": "ApiConnection"
                                    },
                                    "For_each": {
                                      "actions": {
                                        "Condition_2": {
                                          "actions": {
                                            "Add_comment_to_incident_(V3)": {
                                              "inputs": {
                                                "body": {
                                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                                  "message": "<p>@{body('Get_user')?['displayName']} confirms they completed the action that triggered the alert. &nbsp;Closing the incident.</p>"
                                                },
                                                "host": {
                                                  "connection": {
                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                  }
                                                },
                                                "method": "post",
                                                "path": "/Incidents/Comment"
                                              },
                                              "type": "ApiConnection"
                                            },
                                            "Update_incident": {
                                              "inputs": {
                                                "body": {
                                                  "classification": {
                                                    "ClassificationAndReason": "BenignPositive - SuspiciousButExpected",
                                                    "ClassificationReasonText": "User Confirmed it was them"
                                                  },
                                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                                  "status": "Closed"
                                                },
                                                "host": {
                                                  "connection": {
                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                  }
                                                },
                                                "method": "put",
                                                "path": "/Incidents"
                                              },
                                              "runAfter": {
                                                "Add_comment_to_incident_(V3)": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "type": "ApiConnection"
                                            }
                                          },
                                          "else": {
                                            "actions": {
                                              "Add_comment_to_incident_(V3)_2": {
                                                "inputs": {
                                                  "body": {
                                                    "incidentArmId": "@triggerBody()?['object']?['id']",
                                                    "message": "<p>@{body('Get_user')?['displayName']} confirms they did not complete the action. Further investigation is needed.</p>"
                                                  },
                                                  "host": {
                                                    "connection": {
                                                      "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                    }
                                                  },
                                                  "method": "post",
                                                  "path": "/Incidents/Comment"
                                                },
                                                "type": "ApiConnection"
                                              },
                                              "Post_message_in_a_chat_or_channel": {
                                                "inputs": {
                                                  "body": {
                                                    "messageBody": "<p>New alert from Microsoft Sentinel.<br>\nPlease investigate ASAP.<br>\nSeverity : @{triggerBody()?['object']?['properties']?['severity']}<br>\nDescription: @{triggerBody()?['object']?['properties']?['description']}<br>\n<br>\n@{body('Get_user')?['displayName']} user confirmed they did not complete the action.</p>",
                                                    "recipient": {
                                                      "channelId": "[[parameters('TeamsChannelId')]",
                                                      "groupId": "[[parameters('TeamsId')]"
                                                    },
                                                    "subject": "Incident @{triggerBody()?['object']?['properties']?['incidentNumber']} - @{triggerBody()?['object']?['properties']?['title']}"
                                                  },
                                                  "host": {
                                                    "connection": {
                                                      "name": "@parameters('$connections')['teams']['connectionId']"
                                                    }
                                                  },
                                                  "method": "post",
                                                  "path": "/beta/teams/conversation/message/poster/@{encodeURIComponent('User')}/location/@{encodeURIComponent('Channel')}"
                                                },
                                                "runAfter": {
                                                  "Add_comment_to_incident_(V3)_2": [
                                                    "Succeeded"
                                                  ]
                                                },
                                                "type": "ApiConnection"
                                              }
                                            }
                                          },
                                          "expression": {
                                            "and": [
                                              {
                                                "equals": [
                                                  "@body('Send_approval_email')?['SelectedOption']",
                                                  "This was me"
                                                ]
                                              }
                                            ]
                                          },
                                          "runAfter": {
                                            "Send_approval_email": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "If"
                                        },
                                        "Get_user": {
                                          "inputs": {
                                            "host": {
                                              "connection": {
                                                "name": "@parameters('$connections')['azuread']['connectionId']"
                                              }
                                            },
                                            "method": "get",
                                            "path": "/v1.0/users/@{encodeURIComponent(concat(items('For_each')?['Name'], '@' ,items('For_each')?['UPNSuffix']))}"
                                          },
                                          "type": "ApiConnection"
                                        },
                                        "Send_approval_email": {
                                          "inputs": {
                                            "body": {
                                              "Message": {
                                                "Body": "New Alert from Microsoft Sentinel.\nPlease respond ASAP.\nSeverity: @{triggerBody()?['object']?['properties']?['severity']}\nName: @{triggerBody()?['object']?['properties']?['title']}\nDescription: @{triggerBody()?['object']?['properties']?['description']}",
                                                "HideHTMLMessage": false,
                                                "Importance": "High",
                                                "Options": "This was me, This was not me",
                                                "ShowHTMLConfirmationDialog": false,
                                                "Subject": "Security Alert: @{triggerBody()?['object']?['properties']?['title']}",
                                                "To": "@body('Get_user')?['mail']"
                                              },
                                              "NotificationUrl": "@{listCallbackUrl()}"
                                            },
                                            "host": {
                                              "connection": {
                                                "name": "@parameters('$connections')['office365']['connectionId']"
                                              }
                                            },
                                            "path": "/approvalmail/$subscriptions"
                                          },
                                          "runAfter": {
                                            "Get_user": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "ApiConnectionWebhook"
                                        }
                                      },
                                      "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
                                      "runAfter": {
                                        "Entities_-_Get_Accounts": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "Foreach"
                                    }
                                  },
                                  "contentVersion": "1.0.0.0",
                                  "parameters": {
                                    "$connections": {
                                      "type": "Object"
                                    }
                                  },
                                  "triggers": {
                                    "Microsoft_Sentinel_incident": {
                                      "inputs": {
                                        "body": {
                                          "callback_url": "@{listCallbackUrl()}"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "path": "/incident-creation"
                                      },
                                      "type": "ApiConnectionWebhook"
                                    }
                                  }
                                },
                                "parameters": {
                                  "$connections": {
                                    "value": {
                                      "azuread": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureADConnectionName'))]",
                                        "connectionName": "[[variables('AzureADConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuread')]"
                                      },
                                      "azuresentinel": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                                        "connectionProperties": {
                                          "authentication": {
                                            "type": "ManagedServiceIdentity"
                                          }
                                        }
                                      },
                                      "office365": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                                        "connectionName": "[[variables('Office365ConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]"
                                      },
                                      "teams": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]",
                                        "connectionName": "[[variables('TeamsConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/teams')]"
                                      }
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
                              "properties": {
                                "parentId": "[variables('playbookId4')]",
                                "contentId": "[variables('_playbookContentId4')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion4')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ],
                          "metadata": {
                            "title": "Prompt User - Incident",
                            "description": "This playbook will ask the user if they completed the action from the Incident in Microsoft Sentinel.  If so, it will close the incident and add a comment.  If not, it will post a message to teams for the SOC to investigate and add a comment to the incident.",
                            "prerequisites": [
                              "1. You will need the Team Id and Channel Id."
                            ],
                            "postDeployment": [
                              "1. Assign Microsoft Sentinel Responder role to the Playbook's managed identity.",
                              "2. Authorize Microsoft Entra ID, Microsoft Teams, and Office 365 Outlook Logic App connections."
                            ],
                            "lastUpdateTime": "2022-07-11T00:00:00Z",
                            "entities": [
                              "Account"
                            ],
                            "tags": [
                              "Remediation"
                            ],
                            "releaseNotes": [
                              {
                                "version": "1.0.0",
                                "title": "Added new Post a Teams message action",
                                "notes": [
                                  "Initial version"
                                ]
                              }
                            ]
                          }
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_playbookContentId4')]",
                        "contentKind": "Playbook",
                        "displayName": "Prompt-User-Incident",
                        "contentProductId": "[variables('_playbookcontentProductId4')]",
                        "id": "[variables('_playbookcontentProductId4')]",
                        "version": "[variables('playbookVersion4')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('playbookTemplateSpecName5')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Reset-EntraIDPassword-AlertTrigger Playbook with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('playbookVersion5')]",
                          "parameters": {
                            "PlaybookName": {
                              "defaultValue": "Reset-EntraIDPassword-AlertTrigger",
                              "type": "string"
                            }
                          },
                          "variables": {
                            "MicrosoftSentinelConnectionName": "[[concat('microsoftsentinel-', parameters('PlaybookName'))]",
                            "office365ConnectionName": "[[concat('office365-', parameters('PlaybookName'))]",
                            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                            "_connection-2": "[[variables('connection-2')]",
                            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]",
                            "_connection-3": "[[variables('connection-3')]",
                            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                            "workspace-name": "[parameters('workspace')]",
                            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                          },
                          "resources": [
                            {
                              "properties": {
                                "provisioningState": "Succeeded",
                                "state": "Enabled",
                                "definition": {
                                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                  "contentVersion": "1.0.0.0",
                                  "parameters": {
                                    "$connections": {
                                      "type": "Object"
                                    }
                                  },
                                  "triggers": {
                                    "Microsoft_Sentinel_alert": {
                                      "type": "ApiConnectionWebhook",
                                      "inputs": {
                                        "body": {
                                          "callback_url": "@{listCallbackUrl()}"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                          }
                                        },
                                        "path": "/subscribe"
                                      }
                                    }
                                  },
                                  "actions": {
                                    "Alert_-_Get_incident": {
                                      "runAfter": {
                                        "Set_variable_-_password": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "ApiConnection",
                                      "inputs": {
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                          }
                                        },
                                        "method": "get",
                                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                                      }
                                    },
                                    "Entities_-_Get_Accounts": {
                                      "runAfter": {
                                        "Alert_-_Get_incident": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "ApiConnection",
                                      "inputs": {
                                        "body": "@triggerBody()?['Entities']",
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                          }
                                        },
                                        "method": "post",
                                        "path": "/entities/account"
                                      }
                                    },
                                    "For_each": {
                                      "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
                                      "actions": {
                                        "Condition_-_is_manager_available": {
                                          "actions": {
                                            "Add_comment_to_incident_-_manager_available": {
                                              "runAfter": {
                                                "Send_an_email_-_to_manager_with_password_details": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "type": "ApiConnection",
                                              "inputs": {
                                                "body": {
                                                  "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                                  "message": "<p>User @{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])} password was reset in AAD and their manager @{body('Parse_JSON_-_HTTP_-_get_manager')?['userPrincipalName']} was contacted using playbook.</p>"
                                                },
                                                "host": {
                                                  "connection": {
                                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                                  }
                                                },
                                                "method": "post",
                                                "path": "/Incidents/Comment"
                                              }
                                            },
                                            "Parse_JSON_-_HTTP_-_get_manager": {
                                              "type": "ParseJson",
                                              "inputs": {
                                                "content": "@body('HTTP_-_get_manager')",
                                                "schema": {
                                                  "properties": {
                                                    "userPrincipalName": {
                                                      "type": "string"
                                                    }
                                                  },
                                                  "type": "object"
                                                }
                                              }
                                            },
                                            "Send_an_email_-_to_manager_with_password_details": {
                                              "runAfter": {
                                                "Parse_JSON_-_HTTP_-_get_manager": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "type": "ApiConnection",
                                              "inputs": {
                                                "body": {
                                                  "Body": "<p>User, @{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])}, was involved in part of a security incident. &nbsp;As part of remediation, the user password has been reset.<br>\n<br>\nThe temporary password is: @{variables('Password')}<br>\n<br>\nThe user will be required to reset this password upon login.</p>",
                                                  "Subject": "A user password was reset due to security incident.",
                                                  "To": "@body('Parse_JSON_-_HTTP_-_get_manager')?['userPrincipalName']"
                                                },
                                                "host": {
                                                  "connection": {
                                                    "name": "@parameters('$connections')['office365']['connectionId']"
                                                  }
                                                },
                                                "method": "post",
                                                "path": "/v2/Mail"
                                              }
                                            }
                                          },
                                          "runAfter": {
                                            "HTTP_-_get_manager": [
                                              "Succeeded",
                                              "Failed"
                                            ]
                                          },
                                          "else": {
                                            "actions": {
                                              "Add_comment_to_incident_-_manager_not_available": {
                                                "type": "ApiConnection",
                                                "inputs": {
                                                  "body": {
                                                    "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                                    "message": "<p>User @{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])} password was reset in AAD but the user doesn't have a manager.<br>\n<br>\nThe temporary password is: @{variables('Password')}<br>\n<br>\nThe user will be required to reset this password upon login.</p>"
                                                  },
                                                  "host": {
                                                    "connection": {
                                                      "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                                    }
                                                  },
                                                  "method": "post",
                                                  "path": "/Incidents/Comment"
                                                }
                                              }
                                            }
                                          },
                                          "expression": {
                                            "and": [
                                              {
                                                "equals": [
                                                  "@outputs('HTTP_-_get_manager')['statusCode']",
                                                  200
                                                ]
                                              }
                                            ]
                                          },
                                          "type": "If"
                                        },
                                        "HTTP_-_get_manager": {
                                          "runAfter": {
                                            "HTTP_-_reset_a_password": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "Http",
                                          "inputs": {
                                            "authentication": {
                                              "audience": "https://graph.microsoft.com",
                                              "type": "ManagedServiceIdentity"
                                            },
                                            "method": "GET",
                                            "uri": "https://graph.microsoft.com/v1.0/users/@{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])}/manager"
                                          }
                                        },
                                        "HTTP_-_reset_a_password": {
                                          "type": "Http",
                                          "inputs": {
                                            "authentication": {
                                              "audience": "https://graph.microsoft.com",
                                              "type": "ManagedServiceIdentity"
                                            },
                                            "body": {
                                              "passwordProfile": {
                                                "forceChangePasswordNextSignIn": true,
                                                "forceChangePasswordNextSignInWithMfa": false,
                                                "password": "@{variables('Password')}"
                                              }
                                            },
                                            "method": "PATCH",
                                            "uri": "https://graph.microsoft.com/v1.0/users/@{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])}"
                                          }
                                        }
                                      },
                                      "runAfter": {
                                        "Entities_-_Get_Accounts": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "Foreach"
                                    },
                                    "Initialize_variable": {
                                      "type": "InitializeVariable",
                                      "inputs": {
                                        "variables": [
                                          {
                                            "name": "Password",
                                            "type": "String",
                                            "value": "null"
                                          }
                                        ]
                                      }
                                    },
                                    "Set_variable_-_password": {
                                      "runAfter": {
                                        "Initialize_variable": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "SetVariable",
                                      "inputs": {
                                        "name": "Password",
                                        "value": "@{substring(guid(), 0, 10)}"
                                      }
                                    }
                                  }
                                },
                                "parameters": {
                                  "$connections": {
                                    "value": {
                                      "microsoftsentinel": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                                        "connectionProperties": {
                                          "authentication": {
                                            "type": "ManagedServiceIdentity"
                                          }
                                        }
                                      },
                                      "office365": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('office365ConnectionName'))]",
                                        "connectionName": "[[variables('office365ConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]"
                                      }
                                    }
                                  }
                                }
                              },
                              "name": "[[parameters('PlaybookName')]",
                              "type": "Microsoft.Logic/workflows",
                              "location": "[[variables('workspace-location-inline')]",
                              "tags": {
                                "LogicAppsCategory": "security",
                                "hidden-SentinelTemplateName": "Reset-AADUserPassword_alert",
                                "hidden-SentinelTemplateVersion": "1.1",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                              },
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "apiVersion": "2017-07-01",
                              "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('office365ConnectionName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('MicrosoftSentinelConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "kind": "V1",
                              "properties": {
                                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                                "parameterValueType": "Alternative",
                                "api": {
                                  "id": "[[variables('_connection-2')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('office365ConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "kind": "V1",
                              "properties": {
                                "displayName": "[[variables('office365ConnectionName')]",
                                "api": {
                                  "id": "[[variables('_connection-3')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId5'),'/'))))]",
                              "properties": {
                                "parentId": "[variables('playbookId5')]",
                                "contentId": "[variables('_playbookContentId5')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion5')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ],
                          "metadata": {
                            "title": "Reset Microsoft Entra ID User Password - Alert Trigger",
                            "description": "This playbook will reset the user password using Graph API.  It will send the password (which is a random guid substring) to the user's manager.  The user will have to reset the password upon login.",
                            "prerequisites": [
                              "None"
                            ],
                            "postDeployment": [
                              "1. Assign Password Administrator permission to managed identity.",
                              "2. Assign Microsoft Sentinel Responder permission to managed identity.",
                              "3. Authorize Office 365 Outlook connection",
                              "4. For more detailed steps [click Here](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Microsoft%20Entra%20ID/Playbooks/Reset-AADUserPassword/readme.md)"
                            ],
                            "lastUpdateTime": "2022-07-11T00:00:00Z",
                            "entities": [
                              "Account"
                            ],
                            "tags": [
                              "Remediation"
                            ],
                            "releaseNotes": [
                              {
                                "version": "1.0.0",
                                "title": " Added manager notification action",
                                "notes": [
                                  "Initial version"
                                ]
                              }
                            ]
                          }
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_playbookContentId5')]",
                        "contentKind": "Playbook",
                        "displayName": "Reset-EntraIDPassword-AlertTrigger",
                        "contentProductId": "[variables('_playbookcontentProductId5')]",
                        "id": "[variables('_playbookcontentProductId5')]",
                        "version": "[variables('playbookVersion5')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('playbookTemplateSpecName6')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Reset-EntraIDPassword-IncidentTrigger Playbook with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('playbookVersion6')]",
                          "parameters": {
                            "PlaybookName": {
                              "defaultValue": "Reset-EntraIDPassword-IncidentTrigger",
                              "type": "string"
                            }
                          },
                          "variables": {
                            "MicrosoftSentinelConnectionName": "[[concat('microsoftsentinel-', parameters('PlaybookName'))]",
                            "office365ConnectionName": "[[concat('office365-', parameters('PlaybookName'))]",
                            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                            "_connection-2": "[[variables('connection-2')]",
                            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]",
                            "_connection-3": "[[variables('connection-3')]",
                            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                            "workspace-name": "[parameters('workspace')]",
                            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                          },
                          "resources": [
                            {
                              "properties": {
                                "provisioningState": "Succeeded",
                                "state": "Enabled",
                                "definition": {
                                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                  "contentVersion": "1.0.0.0",
                                  "parameters": {
                                    "$connections": {
                                      "type": "Object"
                                    }
                                  },
                                  "triggers": {
                                    "Microsoft_Sentinel_incident": {
                                      "type": "ApiConnectionWebhook",
                                      "inputs": {
                                        "body": {
                                          "callback_url": "@{listCallbackUrl()}"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                          }
                                        },
                                        "path": "/incident-creation"
                                      }
                                    }
                                  },
                                  "actions": {
                                    "Entities_-_Get_Accounts": {
                                      "runAfter": {
                                        "Set_variable_-_password": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "ApiConnection",
                                      "inputs": {
                                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                          }
                                        },
                                        "method": "post",
                                        "path": "/entities/account"
                                      }
                                    },
                                    "For_each": {
                                      "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
                                      "actions": {
                                        "Condition_-_is_manager_available": {
                                          "actions": {
                                            "Add_comment_to_incident_-_manager_available": {
                                              "runAfter": {
                                                "Send_an_email_-_to_manager_with_password_details": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "type": "ApiConnection",
                                              "inputs": {
                                                "body": {
                                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                                  "message": "<p>User @{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])} password was reset in AAD and their manager @{body('Parse_JSON_-_HTTP_-_get_manager')?['userPrincipalName']} was contacted using playbook.</p>"
                                                },
                                                "host": {
                                                  "connection": {
                                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                                  }
                                                },
                                                "method": "post",
                                                "path": "/Incidents/Comment"
                                              }
                                            },
                                            "Parse_JSON_-_HTTP_-_get_manager": {
                                              "type": "ParseJson",
                                              "inputs": {
                                                "content": "@body('HTTP_-_get_manager')",
                                                "schema": {
                                                  "properties": {
                                                    "userPrincipalName": {
                                                      "type": "string"
                                                    }
                                                  },
                                                  "type": "object"
                                                }
                                              }
                                            },
                                            "Send_an_email_-_to_manager_with_password_details": {
                                              "runAfter": {
                                                "Parse_JSON_-_HTTP_-_get_manager": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "type": "ApiConnection",
                                              "inputs": {
                                                "body": {
                                                  "Body": "<p>User, @{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])}, was involved in part of a security incident. &nbsp;As part of remediation, the user password has been reset.<br>\n<br>\nThe temporary password is: @{variables('Password')}<br>\n<br>\nThe user will be required to reset this password upon login.</p>",
                                                  "Subject": "A user password was reset due to security incident.",
                                                  "To": "@body('Parse_JSON_-_HTTP_-_get_manager')?['userPrincipalName']"
                                                },
                                                "host": {
                                                  "connection": {
                                                    "name": "@parameters('$connections')['office365']['connectionId']"
                                                  }
                                                },
                                                "method": "post",
                                                "path": "/v2/Mail"
                                              }
                                            }
                                          },
                                          "runAfter": {
                                            "HTTP_-_get_manager": [
                                              "Succeeded",
                                              "Failed"
                                            ]
                                          },
                                          "else": {
                                            "actions": {
                                              "Add_comment_to_incident_-_manager_not_available": {
                                                "type": "ApiConnection",
                                                "inputs": {
                                                  "body": {
                                                    "incidentArmId": "@triggerBody()?['object']?['id']",
                                                    "message": "<p>User @{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])} password was reset in AAD but the user doesn't have a manager.<br>\n<br>\nThe temporary password is: @{variables('Password')}<br>\n<br>\nThe user will be required to reset this password upon login.</p>"
                                                  },
                                                  "host": {
                                                    "connection": {
                                                      "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                                    }
                                                  },
                                                  "method": "post",
                                                  "path": "/Incidents/Comment"
                                                }
                                              }
                                            }
                                          },
                                          "expression": {
                                            "and": [
                                              {
                                                "equals": [
                                                  "@outputs('HTTP_-_get_manager')['statusCode']",
                                                  200
                                                ]
                                              }
                                            ]
                                          },
                                          "type": "If"
                                        },
                                        "HTTP_-_get_manager": {
                                          "runAfter": {
                                            "HTTP_-_reset_a_password": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "Http",
                                          "inputs": {
                                            "authentication": {
                                              "audience": "https://graph.microsoft.com",
                                              "type": "ManagedServiceIdentity"
                                            },
                                            "method": "GET",
                                            "uri": "https://graph.microsoft.com/v1.0/users/@{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])}/manager"
                                          }
                                        },
                                        "HTTP_-_reset_a_password": {
                                          "type": "Http",
                                          "inputs": {
                                            "authentication": {
                                              "audience": "https://graph.microsoft.com",
                                              "type": "ManagedServiceIdentity"
                                            },
                                            "body": {
                                              "passwordProfile": {
                                                "forceChangePasswordNextSignIn": true,
                                                "forceChangePasswordNextSignInWithMfa": false,
                                                "password": "@{variables('Password')}"
                                              }
                                            },
                                            "method": "PATCH",
                                            "uri": "https://graph.microsoft.com/v1.0/users/@{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])}"
                                          }
                                        }
                                      },
                                      "runAfter": {
                                        "Entities_-_Get_Accounts": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "Foreach"
                                    },
                                    "Initialize_variable": {
                                      "type": "InitializeVariable",
                                      "inputs": {
                                        "variables": [
                                          {
                                            "name": "Password",
                                            "type": "String",
                                            "value": "null"
                                          }
                                        ]
                                      }
                                    },
                                    "Set_variable_-_password": {
                                      "runAfter": {
                                        "Initialize_variable": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "SetVariable",
                                      "inputs": {
                                        "name": "Password",
                                        "value": "@{substring(guid(), 0, 10)}"
                                      }
                                    }
                                  }
                                },
                                "parameters": {
                                  "$connections": {
                                    "value": {
                                      "microsoftsentinel": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                                        "connectionProperties": {
                                          "authentication": {
                                            "type": "ManagedServiceIdentity"
                                          }
                                        }
                                      },
                                      "office365": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('office365ConnectionName'))]",
                                        "connectionName": "[[variables('office365ConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]"
                                      }
                                    }
                                  }
                                }
                              },
                              "name": "[[parameters('PlaybookName')]",
                              "type": "Microsoft.Logic/workflows",
                              "location": "[[variables('workspace-location-inline')]",
                              "tags": {
                                "LogicAppsCategory": "security",
                                "hidden-SentinelTemplateName": "Reset-AADUserPassword",
                                "hidden-SentinelTemplateVersion": "1.1",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                              },
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "apiVersion": "2017-07-01",
                              "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('office365ConnectionName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('MicrosoftSentinelConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "kind": "V1",
                              "properties": {
                                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                                "parameterValueType": "Alternative",
                                "api": {
                                  "id": "[[variables('_connection-2')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('office365ConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "kind": "V1",
                              "properties": {
                                "displayName": "[[variables('office365ConnectionName')]",
                                "api": {
                                  "id": "[[variables('_connection-3')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId6'),'/'))))]",
                              "properties": {
                                "parentId": "[variables('playbookId6')]",
                                "contentId": "[variables('_playbookContentId6')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion6')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ],
                          "metadata": {
                            "title": "Reset Microsoft Entra ID User Password - Incident Trigger",
                            "description": "This playbook will reset the user password using Graph API.  It will send the password (which is a random guid substring) to the user's manager.  The user will have to reset the password upon login.",
                            "prerequisites": [
                              "None"
                            ],
                            "postDeployment": [
                              "1. Assign Password Administrator permission to managed identity.",
                              "2. Assign Microsoft Sentinel Responder permission to managed identity.",
                              "3. Authorize Office 365 Outlook connection",
                              "4. For more detailed steps [click Here](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Microsoft%20Entra%20ID/Playbooks/Reset-AADUserPassword/readme.md)"
                            ],
                            "lastUpdateTime": "2022-07-11T00:00:00Z",
                            "entities": [
                              "Account"
                            ],
                            "tags": [
                              "Remediation"
                            ],
                            "releaseNotes": [
                              {
                                "version": "1.0.0",
                                "title": " Added manager notification action",
                                "notes": [
                                  "Initial version"
                                ]
                              }
                            ]
                          }
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_playbookContentId6')]",
                        "contentKind": "Playbook",
                        "displayName": "Reset-EntraIDPassword-IncidentTrigger",
                        "contentProductId": "[variables('_playbookcontentProductId6')]",
                        "id": "[variables('_playbookcontentProductId6')]",
                        "version": "[variables('playbookVersion6')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('playbookTemplateSpecName7')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Block-EntraIDUser-EntityTrigger Playbook with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('playbookVersion7')]",
                          "parameters": {
                            "PlaybookName": {
                              "defaultValue": "Block-EntraIDUser-EntityTrigger",
                              "type": "string"
                            }
                          },
                          "variables": {
                            "AzureADConnectionName": "[[concat('azuread-', parameters('PlaybookName'))]",
                            "MicrosoftSentinelConnectionName": "[[concat('microsoftsentinel-', parameters('PlaybookName'))]",
                            "Office365ConnectionName": "[[concat('office365-', parameters('PlaybookName'))]",
                            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuread')]",
                            "_connection-1": "[[variables('connection-1')]",
                            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                            "_connection-2": "[[variables('connection-2')]",
                            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]",
                            "_connection-3": "[[variables('connection-3')]",
                            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                            "workspace-name": "[parameters('workspace')]",
                            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('AzureADConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "properties": {
                                "displayName": "[[variables('AzureADConnectionName')]",
                                "api": {
                                  "id": "[[variables('_connection-1')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('MicrosoftSentinelConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "kind": "V1",
                              "properties": {
                                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                                "parameterValueType": "Alternative",
                                "api": {
                                  "id": "[[variables('_connection-2')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('Office365ConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "properties": {
                                "displayName": "[[variables('Office365ConnectionName')]",
                                "api": {
                                  "id": "[[variables('_connection-3')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Logic/workflows",
                              "apiVersion": "2017-07-01",
                              "name": "[[parameters('PlaybookName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "tags": {
                                "LogicAppsCategory": "security",
                                "hidden-SentinelTemplateName": "Block-AADUser-EntityTrigger",
                                "hidden-SentinelTemplateVersion": "1.1",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                              },
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('AzureADConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]"
                              ],
                              "properties": {
                                "state": "Enabled",
                                "definition": {
                                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                  "contentVersion": "1.0.0.0",
                                  "parameters": {
                                    "$connections": {
                                      "type": "Object"
                                    }
                                  },
                                  "triggers": {
                                    "Microsoft_Sentinel_entity": {
                                      "type": "ApiConnectionWebhook",
                                      "inputs": {
                                        "body": {
                                          "callback_url": "@{listCallbackUrl()}"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                          }
                                        },
                                        "path": "/entity/@{encodeURIComponent('Account')}"
                                      }
                                    }
                                  },
                                  "actions": {
                                    "Condition": {
                                      "actions": {
                                        "Condition_-_if_user_have_manager": {
                                          "actions": {
                                            "Condition_2": {
                                              "actions": {
                                                "Add_comment_to_incident_-_with_manager_-_no_admin": {
                                                  "type": "ApiConnection",
                                                  "inputs": {
                                                    "body": {
                                                      "incidentArmId": "@triggerBody()?['IncidentArmID']",
                                                      "message": "<p>User @{triggerBody()?['Entity']?['properties']?['Name']} &nbsp;(UPN - @{variables('AccountDetails')}) was disabled in AAD via playbook Block-AADUser. Manager (@{body('Parse_JSON_-_get_user_manager')?['userPrincipalName']}) is notified.</p>"
                                                    },
                                                    "host": {
                                                      "connection": {
                                                        "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                                      }
                                                    },
                                                    "method": "post",
                                                    "path": "/Incidents/Comment"
                                                  }
                                                }
                                              },
                                              "runAfter": {
                                                "Get_user_-_details": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "expression": {
                                                "and": [
                                                  {
                                                    "not": {
                                                      "equals": [
                                                        "@triggerBody()?['IncidentArmID']",
                                                        "@null"
                                                      ]
                                                    }
                                                  }
                                                ]
                                              },
                                              "type": "If"
                                            },
                                            "Get_user_-_details": {
                                              "type": "ApiConnection",
                                              "inputs": {
                                                "host": {
                                                  "connection": {
                                                    "name": "@parameters('$connections')['azuread']['connectionId']"
                                                  }
                                                },
                                                "method": "get",
                                                "path": "/v1.0/users/@{encodeURIComponent(variables('AccountDetails'))}"
                                              }
                                            },
                                            "Send_an_email_-_to_manager_-_no_admin": {
                                              "runAfter": {
                                                "Condition_2": [
                                                  "Succeeded"
                                                ]
                                              },
                                              "type": "ApiConnection",
                                              "inputs": {
                                                "body": {
                                                  "Body": "<p>Security notification! This is automated email sent by Microsoft Sentinel Automation!<br>\n<br>\nYour direct report @{triggerBody()?['Entity']?['properties']?['Name']} has been disabled in Azure AD due to the security incident. Can you please notify the user and work with him to reach&nbsp;our support.<br>\n<br>\nDirect report details:<br>\nFirst name: @{body('Get_user_-_details')?['displayName']}<br>\nSurname: @{body('Get_user_-_details')?['surname']}<br>\nJob title: @{body('Get_user_-_details')?['jobTitle']}<br>\nOffice location: @{body('Get_user_-_details')?['officeLocation']}<br>\nBusiness phone: @{body('Get_user_-_details')?['businessPhones']}<br>\nMobile phone: @{body('Get_user_-_details')?['mobilePhone']}<br>\nMail: @{body('Get_user_-_details')?['mail']}<br>\n<br>\nThank you!</p>",
                                                  "Importance": "High",
                                                  "Subject": "@{triggerBody()?['Entity']?['properties']?['Name']}  has been disabled in Azure AD due to the security risk!",
                                                  "To": "@body('Parse_JSON_-_get_user_manager')?['userPrincipalName']"
                                                },
                                                "host": {
                                                  "connection": {
                                                    "name": "@parameters('$connections')['office365']['connectionId']"
                                                  }
                                                },
                                                "method": "post",
                                                "path": "/v2/Mail"
                                              }
                                            }
                                          },
                                          "runAfter": {
                                            "Parse_JSON_-_get_user_manager": [
                                              "Succeeded"
                                            ]
                                          },
                                          "else": {
                                            "actions": {
                                              "Condition_3": {
                                                "actions": {
                                                  "Add_comment_to_incident_-_no_manager_-_no_admin": {
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                      "body": {
                                                        "incidentArmId": "@triggerBody()?['IncidentArmID']",
                                                        "message": "<p>User @{triggerBody()?['Entity']?['properties']?['Name']} (UPN - @{variables('AccountDetails')}) was disabled in AAD via playbook Block-AADUser. Manager has not been notified, since it is not found for this user!</p>"
                                                      },
                                                      "host": {
                                                        "connection": {
                                                          "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                                        }
                                                      },
                                                      "method": "post",
                                                      "path": "/Incidents/Comment"
                                                    }
                                                  }
                                                },
                                                "expression": {
                                                  "and": [
                                                    {
                                                      "not": {
                                                        "equals": [
                                                          "@triggerBody()?['IncidentArmID']",
                                                          "@null"
                                                        ]
                                                      }
                                                    }
                                                  ]
                                                },
                                                "type": "If"
                                              }
                                            }
                                          },
                                          "expression": {
                                            "and": [
                                              {
                                                "not": {
                                                  "equals": [
                                                    "@body('Parse_JSON_-_get_user_manager')?['userPrincipalName']",
                                                    "@null"
                                                  ]
                                                }
                                              }
                                            ]
                                          },
                                          "type": "If"
                                        },
                                        "HTTP_-_get_user_manager": {
                                          "type": "Http",
                                          "inputs": {
                                            "authentication": {
                                              "audience": "https://graph.microsoft.com/",
                                              "type": "ManagedServiceIdentity"
                                            },
                                            "method": "GET",
                                            "uri": "https://graph.microsoft.com/v1.0/users/@{variables('AccountDetails')}/manager"
                                          }
                                        },
                                        "Parse_JSON_-_get_user_manager": {
                                          "runAfter": {
                                            "HTTP_-_get_user_manager": [
                                              "Succeeded",
                                              "Failed"
                                            ]
                                          },
                                          "type": "ParseJson",
                                          "inputs": {
                                            "content": "@body('HTTP_-_get_user_manager')",
                                            "schema": {
                                              "properties": {
                                                "userPrincipalName": {
                                                  "type": "string"
                                                }
                                              },
                                              "type": "object"
                                            }
                                          }
                                        }
                                      },
                                      "runAfter": {
                                        "Update_user_-_disable_user": [
                                          "Succeeded",
                                          "Failed"
                                        ]
                                      },
                                      "else": {
                                        "actions": {
                                          "Add_comment_to_incident_-_error_details": {
                                            "type": "ApiConnection",
                                            "inputs": {
                                              "body": {
                                                "incidentArmId": "@triggerBody()?['IncidentArmID']",
                                                "message": "<p>Block-AADUser playbook could not disable user @{triggerBody()?['Entity']?['properties']?['Name']}.<br>\nError message: @{body('Update_user_-_disable_user')['error']['message']}<br>\nNote: If user is admin, this playbook don't have privilages to block admin users!</p>"
                                              },
                                              "host": {
                                                "connection": {
                                                  "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                                }
                                              },
                                              "method": "post",
                                              "path": "/Incidents/Comment"
                                            }
                                          }
                                        }
                                      },
                                      "expression": {
                                        "and": [
                                          {
                                            "equals": [
                                              "@body('Update_user_-_disable_user')",
                                              "@null"
                                            ]
                                          }
                                        ]
                                      },
                                      "type": "If"
                                    },
                                    "Initialize_variable_Account_Details": {
                                      "type": "InitializeVariable",
                                      "inputs": {
                                        "variables": [
                                          {
                                            "name": "AccountDetails",
                                            "type": "string"
                                          }
                                        ]
                                      }
                                    },
                                    "Set_variable": {
                                      "runAfter": {
                                        "Initialize_variable_Account_Details": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "SetVariable",
                                      "inputs": {
                                        "name": "AccountDetails",
                                        "value": "@{concat(triggerBody()?['Entity']?['properties']?['Name'],'@',triggerBody()?['Entity']?['properties']?['UPNSuffix'])}"
                                      }
                                    },
                                    "Update_user_-_disable_user": {
                                      "runAfter": {
                                        "Set_variable": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "ApiConnection",
                                      "inputs": {
                                        "body": {
                                          "accountEnabled": false
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuread']['connectionId']"
                                          }
                                        },
                                        "method": "patch",
                                        "path": "/v1.0/users/@{encodeURIComponent(variables('AccountDetails'))}"
                                      }
                                    }
                                  }
                                },
                                "parameters": {
                                  "$connections": {
                                    "value": {
                                      "azuread": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureADConnectionName'))]",
                                        "connectionName": "[[variables('AzureADConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuread')]"
                                      },
                                      "microsoftsentinel": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                                        "connectionProperties": {
                                          "authentication": {
                                            "type": "ManagedServiceIdentity"
                                          }
                                        }
                                      },
                                      "office365": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                                        "connectionName": "[[variables('Office365ConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]"
                                      }
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId7'),'/'))))]",
                              "properties": {
                                "parentId": "[variables('playbookId7')]",
                                "contentId": "[variables('_playbookContentId7')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion7')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ],
                          "metadata": {
                            "title": "Block Microsoft Entra ID user - Entity trigger",
                            "description": "This playbook disables the selected user (account entity) in Microsoft Entra ID. If this playbook triggered from an incident context, it will add a comment to the incident. This playbook will notify the disabled user manager if available. Note: This playbook will not disable admin user!",
                            "postDeployment": [
                              "1. Assign Microsoft Sentinel Responder role to the Playbook's managed identity.",
                              "2. Grant User.Read.All, User.ReadWrite.All, Directory.Read.All, Directory.ReadWrite.All permissions to the managed identity.",
                              "3. Authorize Microsoft Entra ID and Office 365 Outlook Logic App connections.",
                              "4. For more detailed steps [click Here](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Microsoft%20Entra%20ID/Playbooks/Block-AADUser/readme.md)"
                            ],
                            "lastUpdateTime": "2022-12-08T00:00:00Z",
                            "entities": [
                              "Account"
                            ],
                            "tags": [
                              "Remediation"
                            ],
                            "releaseNotes": [
                              {
                                "version": "1.0.0",
                                "title": "Added manager notification action",
                                "notes": [
                                  "Initial version"
                                ]
                              }
                            ]
                          }
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_playbookContentId7')]",
                        "contentKind": "Playbook",
                        "displayName": "Block-EntraIDUser-EntityTrigger",
                        "contentProductId": "[variables('_playbookcontentProductId7')]",
                        "id": "[variables('_playbookcontentProductId7')]",
                        "version": "[variables('playbookVersion7')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('playbookTemplateSpecName8')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Reset-EntraIDUserPassword-EntityTrigger Playbook with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('playbookVersion8')]",
                          "parameters": {
                            "PlaybookName": {
                              "defaultValue": "Reset-EntraIDUserPassword-EntityTrigger",
                              "type": "string"
                            }
                          },
                          "variables": {
                            "MicrosoftSentinelConnectionName": "[[concat('microsoftsentinel-', parameters('PlaybookName'))]",
                            "office365ConnectionName": "[[concat('office365-', parameters('PlaybookName'))]",
                            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                            "_connection-2": "[[variables('connection-2')]",
                            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]",
                            "_connection-3": "[[variables('connection-3')]",
                            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                            "workspace-name": "[parameters('workspace')]",
                            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                          },
                          "resources": [
                            {
                              "properties": {
                                "provisioningState": "Succeeded",
                                "state": "Enabled",
                                "definition": {
                                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                  "contentVersion": "1.0.0.0",
                                  "parameters": {
                                    "$connections": {
                                      "type": "Object"
                                    }
                                  },
                                  "triggers": {
                                    "Microsoft_Sentinel_entity": {
                                      "type": "ApiConnectionWebhook",
                                      "inputs": {
                                        "body": {
                                          "callback_url": "@{listCallbackUrl()}"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                          }
                                        },
                                        "path": "/entity/@{encodeURIComponent('Account')}"
                                      }
                                    }
                                  },
                                  "actions": {
                                    "Condition_-_is_manager_available": {
                                      "actions": {
                                        "Condition_2": {
                                          "actions": {
                                            "Add_comment_to_incident_-_manager_available": {
                                              "type": "ApiConnection",
                                              "inputs": {
                                                "body": {
                                                  "incidentArmId": "@triggerBody()?['IncidentArmID']",
                                                  "message": "<p>User @{variables('AccountDetails')} password was reset in AAD and their manager @{body('Parse_JSON_-_HTTP_-_get_manager')?['userPrincipalName']} was contacted using playbook.</p>"
                                                },
                                                "host": {
                                                  "connection": {
                                                    "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                                  }
                                                },
                                                "method": "post",
                                                "path": "/Incidents/Comment"
                                              }
                                            }
                                          },
                                          "runAfter": {
                                            "Send_an_email_-_to_manager_with_password_details": [
                                              "Succeeded"
                                            ]
                                          },
                                          "expression": {
                                            "and": [
                                              {
                                                "not": {
                                                  "equals": [
                                                    "@triggerBody()?['IncidentArmID']",
                                                    "@null"
                                                  ]
                                                }
                                              }
                                            ]
                                          },
                                          "type": "If"
                                        },
                                        "Parse_JSON_-_HTTP_-_get_manager": {
                                          "type": "ParseJson",
                                          "inputs": {
                                            "content": "@body('HTTP_-_get_manager')",
                                            "schema": {
                                              "properties": {
                                                "userPrincipalName": {
                                                  "type": "string"
                                                }
                                              },
                                              "type": "object"
                                            }
                                          }
                                        },
                                        "Send_an_email_-_to_manager_with_password_details": {
                                          "runAfter": {
                                            "Parse_JSON_-_HTTP_-_get_manager": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "ApiConnection",
                                          "inputs": {
                                            "body": {
                                              "Body": "<p>User, @{variables('AccountDetails')}, was involved in part of a security incident. &nbsp;As part of remediation, the user password has been reset.<br>\n<br>\nThe temporary password is: @{variables('Password')}<br>\n<br>\nThe user will be required to reset this password upon login.</p>",
                                              "Subject": "A user password was reset due to security incident.",
                                              "To": "@body('Parse_JSON_-_HTTP_-_get_manager')?['userPrincipalName']"
                                            },
                                            "host": {
                                              "connection": {
                                                "name": "@parameters('$connections')['office365']['connectionId']"
                                              }
                                            },
                                            "method": "post",
                                            "path": "/v2/Mail"
                                          }
                                        }
                                      },
                                      "runAfter": {
                                        "HTTP_-_get_manager": [
                                          "Succeeded",
                                          "Failed"
                                        ]
                                      },
                                      "else": {
                                        "actions": {
                                          "Condition": {
                                            "actions": {
                                              "Add_comment_to_incident_-_manager_not_available": {
                                                "type": "ApiConnection",
                                                "inputs": {
                                                  "body": {
                                                    "incidentArmId": "@triggerBody()?['IncidentArmID']",
                                                    "message": "<p>User @{variables('AccountDetails')} password was reset in AAD but the user doesn't have a manager.<br>\n<br>\nThe temporary password is: @{variables('Password')}<br>\n<br>\nThe user will be required to reset this password upon login.</p>"
                                                  },
                                                  "host": {
                                                    "connection": {
                                                      "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                                    }
                                                  },
                                                  "method": "post",
                                                  "path": "/Incidents/Comment"
                                                }
                                              }
                                            },
                                            "expression": {
                                              "and": [
                                                {
                                                  "not": {
                                                    "equals": [
                                                      "@triggerBody()?['IncidentArmID']",
                                                      "@null"
                                                    ]
                                                  }
                                                }
                                              ]
                                            },
                                            "type": "If"
                                          }
                                        }
                                      },
                                      "expression": {
                                        "and": [
                                          {
                                            "equals": [
                                              "@outputs('HTTP_-_get_manager')['statusCode']",
                                              200
                                            ]
                                          }
                                        ]
                                      },
                                      "type": "If"
                                    },
                                    "HTTP_-_get_manager": {
                                      "runAfter": {
                                        "HTTP_-_reset_a_password": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "Http",
                                      "inputs": {
                                        "authentication": {
                                          "audience": "https://graph.microsoft.com",
                                          "type": "ManagedServiceIdentity"
                                        },
                                        "method": "GET",
                                        "uri": "https://graph.microsoft.com/v1.0/users/@{variables('AccountDetails')}/manager"
                                      }
                                    },
                                    "HTTP_-_reset_a_password": {
                                      "runAfter": {
                                        "Initialize_variable_Account": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "Http",
                                      "inputs": {
                                        "authentication": {
                                          "audience": "https://graph.microsoft.com",
                                          "type": "ManagedServiceIdentity"
                                        },
                                        "body": {
                                          "passwordProfile": {
                                            "forceChangePasswordNextSignIn": true,
                                            "forceChangePasswordNextSignInWithMfa": false,
                                            "password": "@{variables('Password')}"
                                          }
                                        },
                                        "method": "PATCH",
                                        "uri": "https://graph.microsoft.com/v1.0/users/@{variables('AccountDetails')}"
                                      }
                                    },
                                    "Initialize_variable": {
                                      "type": "InitializeVariable",
                                      "inputs": {
                                        "variables": [
                                          {
                                            "name": "Password",
                                            "type": "String",
                                            "value": "null"
                                          }
                                        ]
                                      }
                                    },
                                    "Initialize_variable_Account": {
                                      "runAfter": {
                                        "Set_variable_-_password": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "InitializeVariable",
                                      "inputs": {
                                        "variables": [
                                          {
                                            "name": "AccountDetails",
                                            "type": "string",
                                            "value": "@{concat(triggerBody()?['Entity']?['properties']?['Name'],'@',triggerBody()?['Entity']?['properties']?['UPNSuffix'])}"
                                          }
                                        ]
                                      }
                                    },
                                    "Set_variable_-_password": {
                                      "runAfter": {
                                        "Initialize_variable": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "SetVariable",
                                      "inputs": {
                                        "name": "Password",
                                        "value": "@{substring(guid(), 0, 10)}"
                                      }
                                    }
                                  }
                                },
                                "parameters": {
                                  "$connections": {
                                    "value": {
                                      "microsoftsentinel": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                                        "connectionProperties": {
                                          "authentication": {
                                            "type": "ManagedServiceIdentity"
                                          }
                                        }
                                      },
                                      "office365": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('office365ConnectionName'))]",
                                        "connectionName": "[[variables('office365ConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]"
                                      }
                                    }
                                  }
                                }
                              },
                              "name": "[[parameters('PlaybookName')]",
                              "type": "Microsoft.Logic/workflows",
                              "location": "[[variables('workspace-location-inline')]",
                              "tags": {
                                "LogicAppsCategory": "security",
                                "hidden-SentinelTemplateName": "Reset-AADUserPassword-EntityTrigger",
                                "hidden-SentinelTemplateVersion": "1.1",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                              },
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "apiVersion": "2017-07-01",
                              "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('office365ConnectionName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('MicrosoftSentinelConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "kind": "V1",
                              "properties": {
                                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                                "parameterValueType": "Alternative",
                                "api": {
                                  "id": "[[variables('_connection-2')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('office365ConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "kind": "V1",
                              "properties": {
                                "displayName": "[[variables('office365ConnectionName')]",
                                "api": {
                                  "id": "[[variables('_connection-3')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId8'),'/'))))]",
                              "properties": {
                                "parentId": "[variables('playbookId8')]",
                                "contentId": "[variables('_playbookContentId8')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion8')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ],
                          "metadata": {
                            "title": "Reset Microsoft Entra ID User Password - Entity trigger",
                            "description": "This playbook will reset the user password using Graph API.  It will send the password (which is a random guid substring) to the user's manager.  The user will have to reset the password upon login.",
                            "postDeployment": [
                              "1. Assign Password Administrator permission to managed identity.",
                              "2. Assign Microsoft Sentinel Responder permission to managed identity.",
                              "3. Authorize Office 365 Outlook connection",
                              "4. For more detailed steps [click Here](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Microsoft%20Entra%20ID/Playbooks/Reset-AADUserPassword/readme.md)"
                            ],
                            "lastUpdateTime": "2022-12-06T00:00:00Z",
                            "entities": [
                              "Account"
                            ],
                            "tags": [
                              "Remediation"
                            ],
                            "releaseNotes": {
                              "version": "1.1",
                              "title": "[variables('blanks')]",
                              "notes": [
                                "Initial version"
                              ]
                            }
                          }
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_playbookContentId8')]",
                        "contentKind": "Playbook",
                        "displayName": "Reset-EntraIDUserPassword-EntityTrigger",
                        "contentProductId": "[variables('_playbookcontentProductId8')]",
                        "id": "[variables('_playbookcontentProductId8')]",
                        "version": "[variables('playbookVersion8')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('playbookTemplateSpecName9')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Revoke-EntraIDSignInSessions-alert Playbook with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('playbookVersion9')]",
                          "parameters": {
                            "PlaybookName": {
                              "defaultValue": "Revoke-EntraIDSignInSessions-alert",
                              "type": "string"
                            },
                            "UserName": {
                              "defaultValue": "<username>@<domain>",
                              "type": "string"
                            }
                          },
                          "variables": {
                            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
                            "Office365ConnectionName": "[[concat('office365-', parameters('PlaybookName'))]",
                            "Office365UsersConnectionName": "[[concat('office365users-', parameters('PlaybookName'))]",
                            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                            "_connection-1": "[[variables('connection-1')]",
                            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]",
                            "_connection-2": "[[variables('connection-2')]",
                            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365users')]",
                            "_connection-3": "[[variables('connection-3')]",
                            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                            "workspace-name": "[parameters('workspace')]",
                            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('AzureSentinelConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "kind": "V1",
                              "properties": {
                                "displayName": "[[parameters('PlaybookName')]",
                                "parameterValueType": "Alternative",
                                "api": {
                                  "id": "[[variables('_connection-1')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('Office365ConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "properties": {
                                "displayName": "[[parameters('UserName')]",
                                "api": {
                                  "id": "[[variables('_connection-2')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('Office365UsersConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "properties": {
                                "displayName": "[[parameters('UserName')]",
                                "api": {
                                  "id": "[[variables('_connection-3')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Logic/workflows",
                              "apiVersion": "2017-07-01",
                              "name": "[[parameters('PlaybookName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "tags": {
                                "LogicAppsCategory": "security",
                                "hidden-SentinelTemplateName": "Revoke-AADSigninSessions_alert",
                                "hidden-SentinelTemplateVersion": "1.0",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                              },
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('Office365UsersConnectionName'))]"
                              ],
                              "properties": {
                                "state": "Enabled",
                                "definition": {
                                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                  "actions": {
                                    "Alert_-_Get_incident": {
                                      "inputs": {
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "get",
                                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                                      },
                                      "type": "ApiConnection"
                                    },
                                    "Entities_-_Get_Accounts": {
                                      "inputs": {
                                        "body": "@triggerBody()?['Entities']",
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "post",
                                        "path": "/entities/account"
                                      },
                                      "runAfter": {
                                        "Alert_-_Get_incident": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "ApiConnection"
                                    },
                                    "For_each": {
                                      "actions": {
                                        "Add_comment_to_incident_(V3)": {
                                          "inputs": {
                                            "body": {
                                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                              "message": "<p>User @{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])} singin sessions were revoked in AAD and their manager @{body('Get_manager_(V2)')?['displayName']} was contacted using playbook.</p>"
                                            },
                                            "host": {
                                              "connection": {
                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                              }
                                            },
                                            "method": "post",
                                            "path": "/Incidents/Comment"
                                          },
                                          "runAfter": {
                                            "Send_an_email_(V2)": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "ApiConnection"
                                        },
                                        "Get_manager_(V2)": {
                                          "inputs": {
                                            "host": {
                                              "connection": {
                                                "name": "@parameters('$connections')['office365users']['connectionId']"
                                              }
                                            },
                                            "method": "get",
                                            "path": "/codeless/v1.0/users/@{encodeURIComponent(concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix']))}/manager"
                                          },
                                          "runAfter": {
                                            "HTTP": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "ApiConnection"
                                        },
                                        "HTTP": {
                                          "inputs": {
                                            "authentication": {
                                              "audience": "https://graph.microsoft.com",
                                              "type": "ManagedServiceIdentity"
                                            },
                                            "method": "POST",
                                            "uri": "https://graph.microsoft.com/v1.0/users/@{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])}/revokeSignInSessions"
                                          },
                                          "type": "Http"
                                        },
                                        "Send_an_email_(V2)": {
                                          "inputs": {
                                            "body": {
                                              "Body": "<p>User, @{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])}, was involved in part of a security incident. &nbsp;As part of remediation, the user signin sessions have been revoked. &nbsp;The user will need to reauthenticate in all applications.</p>",
                                              "Subject": "User signin sessions were reset due to security incident.",
                                              "To": "@body('Get_manager_(V2)')?['mail']"
                                            },
                                            "host": {
                                              "connection": {
                                                "name": "@parameters('$connections')['office365']['connectionId']"
                                              }
                                            },
                                            "method": "post",
                                            "path": "/v2/Mail"
                                          },
                                          "runAfter": {
                                            "Get_manager_(V2)": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "ApiConnection"
                                        }
                                      },
                                      "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
                                      "runAfter": {
                                        "Entities_-_Get_Accounts": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "Foreach"
                                    }
                                  },
                                  "contentVersion": "1.0.0.0",
                                  "parameters": {
                                    "$connections": {
                                      "type": "Object"
                                    }
                                  },
                                  "triggers": {
                                    "Microsoft_Sentinel_alert": {
                                      "inputs": {
                                        "body": {
                                          "callback_url": "@{listCallbackUrl()}"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "path": "/subscribe"
                                      },
                                      "type": "ApiConnectionWebhook"
                                    }
                                  }
                                },
                                "parameters": {
                                  "$connections": {
                                    "value": {
                                      "azuresentinel": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                                        "connectionProperties": {
                                          "authentication": {
                                            "type": "ManagedServiceIdentity"
                                          }
                                        }
                                      },
                                      "office365": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                                        "connectionName": "[[variables('Office365ConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]"
                                      },
                                      "office365users": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Office365UsersConnectionName'))]",
                                        "connectionName": "[[variables('Office365UsersConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365users')]"
                                      }
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId9'),'/'))))]",
                              "properties": {
                                "parentId": "[variables('playbookId9')]",
                                "contentId": "[variables('_playbookContentId9')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion9')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ],
                          "metadata": {
                            "title": "Revoke-Entra ID SignInSessions alert trigger",
                            "description": "This playbook will revoke all signin sessions for the user using Graph API.  It will send an email to the user's manager.",
                            "prerequisites": [
                              "1. You must create an app registration for graph api with appropriate permissions.",
                              "2.  You will need to add the managed identity that is created by the logic app to the Password Administrator role in Microsoft Entra ID."
                            ],
                            "postDeployment": [
                              "1. Add Microsoft Sentinel Responder role to the managed identity.",
                              "2. Assign User.ReadWrite.All and Directory.ReadWrite.All API permissions to the managed identity.",
                              "3. For more detailed steps [click Here](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Microsoft%20Entra%20ID/Playbooks/Revoke-AADSignInSessions/readme.md)"
                            ],
                            "comments": "This playbook will revoke all signin sessions for the user using Graph API using a Beta API.  It will send and email to the user's manager.",
                            "lastUpdateTime": "2021-07-14T00:00:00Z",
                            "entities": [
                              "Account"
                            ],
                            "tags": [
                              "Remediation"
                            ],
                            "releaseNotes": {
                              "version": "1.0",
                              "title": "[variables('blanks')]",
                              "notes": [
                                "Initial version"
                              ]
                            }
                          }
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_playbookContentId9')]",
                        "contentKind": "Playbook",
                        "displayName": "Revoke-EntraIDSignInSessions-alert",
                        "contentProductId": "[variables('_playbookcontentProductId9')]",
                        "id": "[variables('_playbookcontentProductId9')]",
                        "version": "[variables('playbookVersion9')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('playbookTemplateSpecName10')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Revoke-EntraIDSignInSessions-incident Playbook with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('playbookVersion10')]",
                          "parameters": {
                            "PlaybookName": {
                              "defaultValue": "Revoke-EntraIDSignInSessions-incident",
                              "type": "string"
                            },
                            "UserName": {
                              "defaultValue": "<username>@<domain>",
                              "type": "string"
                            }
                          },
                          "variables": {
                            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
                            "Office365ConnectionName": "[[concat('office365-', parameters('PlaybookName'))]",
                            "Office365UsersConnectionName": "[[concat('office365users-', parameters('PlaybookName'))]",
                            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                            "_connection-1": "[[variables('connection-1')]",
                            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]",
                            "_connection-2": "[[variables('connection-2')]",
                            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365users')]",
                            "_connection-3": "[[variables('connection-3')]",
                            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                            "workspace-name": "[parameters('workspace')]",
                            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('AzureSentinelConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "kind": "V1",
                              "properties": {
                                "displayName": "[[parameters('PlaybookName')]",
                                "parameterValueType": "Alternative",
                                "api": {
                                  "id": "[[variables('_connection-1')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('Office365ConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "properties": {
                                "displayName": "[[parameters('UserName')]",
                                "api": {
                                  "id": "[[variables('_connection-2')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('Office365UsersConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "properties": {
                                "displayName": "[[parameters('UserName')]",
                                "api": {
                                  "id": "[[variables('_connection-3')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Logic/workflows",
                              "apiVersion": "2017-07-01",
                              "name": "[[parameters('PlaybookName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "tags": {
                                "LogicAppsCategory": "security",
                                "hidden-SentinelTemplateName": "Revoke-AADSigninSessions",
                                "hidden-SentinelTemplateVersion": "1.0",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                              },
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('Office365UsersConnectionName'))]"
                              ],
                              "properties": {
                                "state": "Enabled",
                                "definition": {
                                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                  "actions": {
                                    "Entities_-_Get_Accounts": {
                                      "inputs": {
                                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "method": "post",
                                        "path": "/entities/account"
                                      },
                                      "type": "ApiConnection"
                                    },
                                    "For_each": {
                                      "actions": {
                                        "Add_comment_to_incident_(V3)": {
                                          "inputs": {
                                            "body": {
                                              "incidentArmId": "@triggerBody()?['object']?['id']",
                                              "message": "<p>User @{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])} singin sessions were revoked in AAD and their manager @{body('Get_manager_(V2)')?['displayName']} was contacted using playbook.</p>"
                                            },
                                            "host": {
                                              "connection": {
                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                              }
                                            },
                                            "method": "post",
                                            "path": "/Incidents/Comment"
                                          },
                                          "runAfter": {
                                            "Send_an_email_(V2)": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "ApiConnection"
                                        },
                                        "Get_manager_(V2)": {
                                          "inputs": {
                                            "host": {
                                              "connection": {
                                                "name": "@parameters('$connections')['office365users']['connectionId']"
                                              }
                                            },
                                            "method": "get",
                                            "path": "/codeless/v1.0/users/@{encodeURIComponent(concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix']))}/manager"
                                          },
                                          "runAfter": {
                                            "HTTP": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "ApiConnection"
                                        },
                                        "HTTP": {
                                          "inputs": {
                                            "authentication": {
                                              "audience": "https://graph.microsoft.com",
                                              "type": "ManagedServiceIdentity"
                                            },
                                            "method": "POST",
                                            "uri": "https://graph.microsoft.com/v1.0/users/@{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])}/revokeSignInSessions"
                                          },
                                          "type": "Http"
                                        },
                                        "Send_an_email_(V2)": {
                                          "inputs": {
                                            "body": {
                                              "Body": "<p>User, @{concat(items('For_each')?['Name'], '@', items('for_each')?['UPNSuffix'])}, was involved in part of a security incident. &nbsp;As part of remediation, the user signin sessions have been revoked. &nbsp;The user will need to reauthenticate in all applications.</p>",
                                              "Subject": "User signin sessions were reset due to security incident.",
                                              "To": "@body('Get_manager_(V2)')?['mail']"
                                            },
                                            "host": {
                                              "connection": {
                                                "name": "@parameters('$connections')['office365']['connectionId']"
                                              }
                                            },
                                            "method": "post",
                                            "path": "/v2/Mail"
                                          },
                                          "runAfter": {
                                            "Get_manager_(V2)": [
                                              "Succeeded"
                                            ]
                                          },
                                          "type": "ApiConnection"
                                        }
                                      },
                                      "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
                                      "runAfter": {
                                        "Entities_-_Get_Accounts": [
                                          "Succeeded"
                                        ]
                                      },
                                      "type": "Foreach"
                                    }
                                  },
                                  "contentVersion": "1.0.0.0",
                                  "parameters": {
                                    "$connections": {
                                      "type": "Object"
                                    }
                                  },
                                  "triggers": {
                                    "Microsoft_Sentinel_incident": {
                                      "inputs": {
                                        "body": {
                                          "callback_url": "@{listCallbackUrl()}"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                          }
                                        },
                                        "path": "/incident-creation"
                                      },
                                      "type": "ApiConnectionWebhook"
                                    }
                                  }
                                },
                                "parameters": {
                                  "$connections": {
                                    "value": {
                                      "azuresentinel": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                                        "connectionProperties": {
                                          "authentication": {
                                            "type": "ManagedServiceIdentity"
                                          }
                                        }
                                      },
                                      "office365": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                                        "connectionName": "[[variables('Office365ConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]"
                                      },
                                      "office365users": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Office365UsersConnectionName'))]",
                                        "connectionName": "[[variables('Office365UsersConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365users')]"
                                      }
                                    }
                                  }
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId10'),'/'))))]",
                              "properties": {
                                "parentId": "[variables('playbookId10')]",
                                "contentId": "[variables('_playbookContentId10')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion10')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ],
                          "metadata": {
                            "title": "Revoke Entra ID SignIn Sessions - incident trigger",
                            "description": "This playbook will revoke all signin sessions for the user using Graph API.  It will send an email to the user's manager.",
                            "postDeployment": [
                              "1. Add Microsoft Sentinel Responder role to the managed identity.",
                              "2. Assign User.ReadWrite.All and Directory.ReadWrite.All API permissions to the managed identity.",
                              "3. For more detailed steps [click Here](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Microsoft%20Entra%20ID/Playbooks/Revoke-AADSignInSessions/readme.md)"
                            ],
                            "lastUpdateTime": "2024-01-08T00:00:00Z",
                            "entities": [
                              "Account"
                            ],
                            "tags": [
                              "Remediation"
                            ],
                            "releaseNotes": {
                              "version": "1.0",
                              "title": "[variables('blanks')]",
                              "notes": [
                                "Initial version"
                              ]
                            }
                          }
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_playbookContentId10')]",
                        "contentKind": "Playbook",
                        "displayName": "Revoke-EntraIDSignInSessions-incident",
                        "contentProductId": "[variables('_playbookcontentProductId10')]",
                        "id": "[variables('_playbookcontentProductId10')]",
                        "version": "[variables('playbookVersion10')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
                      "apiVersion": "2023-04-01-preview",
                      "name": "[variables('playbookTemplateSpecName11')]",
                      "location": "[parameters('workspace-location')]",
                      "dependsOn": [
                        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
                      ],
                      "properties": {
                        "description": "Revoke-EntraIDSignIn-Session-entityTrigger Playbook with template version 3.3.6",
                        "mainTemplate": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "[variables('playbookVersion11')]",
                          "parameters": {
                            "PlaybookName": {
                              "defaultValue": "Revoke-EntraIDSignIn-Session-entityTrigger",
                              "type": "string"
                            }
                          },
                          "variables": {
                            "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
                            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                            "_connection-2": "[[variables('connection-2')]",
                            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                            "workspace-name": "[parameters('workspace')]",
                            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                          },
                          "resources": [
                            {
                              "properties": {
                                "provisioningState": "Succeeded",
                                "state": "Enabled",
                                "definition": {
                                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                  "contentVersion": "1.0.0.0",
                                  "parameters": {
                                    "$connections": {
                                      "type": "Object"
                                    }
                                  },
                                  "triggers": {
                                    "Microsoft_Sentinel_entity": {
                                      "type": "ApiConnectionWebhook",
                                      "inputs": {
                                        "body": {
                                          "callback_url": "@{listCallbackUrl()}"
                                        },
                                        "host": {
                                          "connection": {
                                            "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                          }
                                        },
                                        "path": "/entity/@{encodeURIComponent('Account')}"
                                      }
                                    }
                                  },
                                  "actions": {
                                    "Condition": {
                                      "actions": {
                                        "Add_comment_to_incident_(V3)_-_session_revoked": {
                                          "type": "ApiConnection",
                                          "inputs": {
                                            "body": {
                                              "incidentArmId": "@triggerBody()?['IncidentArmID']",
                                              "message": "<p>Sign-in session revoked for the user - @{concat(triggerBody()?['Entity']?['properties']?['Name'], '@', triggerBody()?['Entity']?['properties']?['upnSuffix'])}</p>"
                                            },
                                            "host": {
                                              "connection": {
                                                "name": "@parameters('$connections')['microsoftsentinel']['connectionId']"
                                              }
                                            },
                                            "method": "post",
                                            "path": "/Incidents/Comment"
                                          }
                                        }
                                      },
                                      "runAfter": {
                                        "HTTP_-_revoke_sign-in_session": [
                                          "Succeeded"
                                        ]
                                      },
                                      "expression": {
                                        "and": [
                                          {
                                            "not": {
                                              "equals": [
                                                "@triggerBody()?['IncidentArmID']",
                                                "@null"
                                              ]
                                            }
                                          }
                                        ]
                                      },
                                      "type": "If"
                                    },
                                    "HTTP_-_revoke_sign-in_session": {
                                      "type": "Http",
                                      "inputs": {
                                        "authentication": {
                                          "audience": "https://graph.microsoft.com",
                                          "type": "ManagedServiceIdentity"
                                        },
                                        "method": "POST",
                                        "uri": "https://graph.microsoft.com/v1.0/users/@{concat(triggerBody()?['Entity']?['properties']?['Name'], '@', triggerBody()?['Entity']?['properties']?['upnSuffix'])}/revokeSignInSessions"
                                      }
                                    }
                                  }
                                },
                                "parameters": {
                                  "$connections": {
                                    "value": {
                                      "microsoftsentinel": {
                                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                                        "connectionProperties": {
                                          "authentication": {
                                            "type": "ManagedServiceIdentity"
                                          }
                                        }
                                      }
                                    }
                                  }
                                }
                              },
                              "name": "[[parameters('PlaybookName')]",
                              "type": "Microsoft.Logic/workflows",
                              "location": "[[variables('workspace-location-inline')]",
                              "tags": {
                                "hidden-SentinelTemplateName": "Revoke-AADSignIn-Session-entityTrigger",
                                "hidden-SentinelTemplateVersion": "1.0",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                              },
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "apiVersion": "2017-07-01",
                              "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Web/connections",
                              "apiVersion": "2016-06-01",
                              "name": "[[variables('MicrosoftSentinelConnectionName')]",
                              "location": "[[variables('workspace-location-inline')]",
                              "kind": "V1",
                              "properties": {
                                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                                "parameterValueType": "Alternative",
                                "api": {
                                  "id": "[[variables('_connection-2')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                              "apiVersion": "2022-01-01-preview",
                              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId11'),'/'))))]",
                              "properties": {
                                "parentId": "[variables('playbookId11')]",
                                "contentId": "[variables('_playbookContentId11')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion11')]",
                                "source": {
                                  "kind": "Solution",
                                  "name": "Microsoft Entra ID",
                                  "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                  "name": "Microsoft",
                                  "email": "[variables('_email')]"
                                },
                                "support": {
                                  "tier": "Microsoft",
                                  "name": "Microsoft Corporation",
                                  "email": "support@microsoft.com",
                                  "link": "https://support.microsoft.com/"
                                }
                              }
                            }
                          ],
                          "metadata": {
                            "title": "Revoke Entra ID  Sign-in session using entity trigger",
                            "description": "This playbook will revoke user's sign-in sessions and user will have to perform authentication again. It invalidates all the refresh tokens issued to applications for a user (as well as session cookies in a user's browser), by resetting the signInSessionsValidFromDateTime user property to the current date-time.",
                            "postDeployment": [
                              "1. Add Microsoft Sentinel Responder role to the managed identity.",
                              "2. Assign User.ReadWrite.All and Directory.ReadWrite.All API permissions to the managed identity.",
                              "3. For more detailed steps [click Here](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Microsoft%20Entra%20ID/Playbooks/Revoke-AADSignInSessions/readme.md)"
                            ],
                            "lastUpdateTime": "2022-12-22T00:00:00Z",
                            "entities": [
                              "Account"
                            ],
                            "releaseNotes": {
                              "version": "1.0",
                              "title": "[variables('blanks')]",
                              "notes": [
                                "Initial version"
                              ]
                            }
                          }
                        },
                        "packageKind": "Solution",
                        "packageVersion": "[variables('_solutionVersion')]",
                        "packageName": "[variables('_solutionName')]",
                        "packageId": "[variables('_solutionId')]",
                        "contentSchemaVersion": "3.0.0",
                        "contentId": "[variables('_playbookContentId11')]",
                        "contentKind": "Playbook",
                        "displayName": "Revoke-EntraIDSignIn-Session-entityTrigger",
                        "contentProductId": "[variables('_playbookcontentProductId11')]",
                        "id": "[variables('_playbookcontentProductId11')]",
                        "version": "[variables('playbookVersion11')]"
                      }
                    },
                    {
                      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
                      "apiVersion": "2023-04-01-preview",
                      "location": "[parameters('workspace-location')]",
                      "properties": {
                        "version": "3.3.6",
                        "kind": "Solution",
                        "contentSchemaVersion": "3.0.0",
                        "displayName": "Microsoft Entra ID",
                        "publisherDisplayName": "Microsoft Sentinel, Microsoft Corporation",
                        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p> Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Microsoft%20Entra%20ID/ReleaseNotes.md\">Release Notes</a></p>\n<p> There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The <a href=\"https://docs.microsoft.com/azure/active-directory/fundamentals/active-directory-whatis\">Microsoft Entra ID</a>  solution for Microsoft Sentinel enables you to ingest Microsoft Entra ID <a href=\"https://docs.microsoft.com/azure/active-directory/reports-monitoring/concept-audit-logs\">Audit</a>, <a href=\"https://docs.microsoft.com/azure/active-directory/reports-monitoring/concept-sign-ins\">Sign-in</a>, <a href=\"https://docs.microsoft.com/azure/active-directory/reports-monitoring/concept-provisioning-logs\">Provisioning</a>, <a href=\"https://docs.microsoft.com/azure/active-directory/identity-protection/howto-identity-protection-investigate-risk#risky-users\">Risk Events and Risky User/Service Principal</a> logs using Diagnostic Settings into Microsoft Sentinel.</p>\n<p><strong>Data Connectors:</strong> 1, <strong>Workbooks:</strong> 2, <strong>Analytic Rules:</strong> 73, <strong>Playbooks:</strong> 11</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
                        "contentKind": "Solution",
                        "contentProductId": "[variables('_solutioncontentProductId')]",
                        "id": "[variables('_solutioncontentProductId')]",
                        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Workbooks/Images/Logos/MicrosoftEntraID_logo.svg\"width=\"75px\" height=\"75px\">",
                        "contentId": "[variables('_solutionId')]",
                        "parentId": "[variables('_solutionId')]",
                        "source": {
                          "kind": "Solution",
                          "name": "Microsoft Entra ID",
                          "sourceId": "[variables('_solutionId')]"
                        },
                        "author": {
                          "name": "Microsoft",
                          "email": "[variables('_email')]"
                        },
                        "support": {
                          "name": "Microsoft Corporation",
                          "email": "support@microsoft.com",
                          "tier": "Microsoft",
                          "link": "https://support.microsoft.com/"
                        },
                        "dependencies": {
                          "operator": "AND",
                          "criteria": [
                            {
                              "kind": "DataConnector",
                              "contentId": "[variables('_dataConnectorContentId1')]",
                              "version": "[variables('dataConnectorVersion1')]"
                            },
                            {
                              "kind": "Workbook",
                              "contentId": "[variables('_workbookContentId1')]",
                              "version": "[variables('workbookVersion1')]"
                            },
                            {
                              "kind": "Workbook",
                              "contentId": "[variables('_workbookContentId2')]",
                              "version": "[variables('workbookVersion2')]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                              "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                              "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                              "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                              "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                              "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                              "version": "[variables('analyticRuleObject6').analyticRuleVersion6]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
                              "version": "[variables('analyticRuleObject7').analyticRuleVersion7]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
                              "version": "[variables('analyticRuleObject8').analyticRuleVersion8]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
                              "version": "[variables('analyticRuleObject9').analyticRuleVersion9]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
                              "version": "[variables('analyticRuleObject10').analyticRuleVersion10]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
                              "version": "[variables('analyticRuleObject11').analyticRuleVersion11]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
                              "version": "[variables('analyticRuleObject12').analyticRuleVersion12]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
                              "version": "[variables('analyticRuleObject13').analyticRuleVersion13]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
                              "version": "[variables('analyticRuleObject14').analyticRuleVersion14]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject15')._analyticRulecontentId15]",
                              "version": "[variables('analyticRuleObject15').analyticRuleVersion15]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject16')._analyticRulecontentId16]",
                              "version": "[variables('analyticRuleObject16').analyticRuleVersion16]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject17')._analyticRulecontentId17]",
                              "version": "[variables('analyticRuleObject17').analyticRuleVersion17]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject18')._analyticRulecontentId18]",
                              "version": "[variables('analyticRuleObject18').analyticRuleVersion18]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject19')._analyticRulecontentId19]",
                              "version": "[variables('analyticRuleObject19').analyticRuleVersion19]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject20')._analyticRulecontentId20]",
                              "version": "[variables('analyticRuleObject20').analyticRuleVersion20]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject21')._analyticRulecontentId21]",
                              "version": "[variables('analyticRuleObject21').analyticRuleVersion21]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject22')._analyticRulecontentId22]",
                              "version": "[variables('analyticRuleObject22').analyticRuleVersion22]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject23')._analyticRulecontentId23]",
                              "version": "[variables('analyticRuleObject23').analyticRuleVersion23]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject24')._analyticRulecontentId24]",
                              "version": "[variables('analyticRuleObject24').analyticRuleVersion24]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject25')._analyticRulecontentId25]",
                              "version": "[variables('analyticRuleObject25').analyticRuleVersion25]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject26')._analyticRulecontentId26]",
                              "version": "[variables('analyticRuleObject26').analyticRuleVersion26]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject27')._analyticRulecontentId27]",
                              "version": "[variables('analyticRuleObject27').analyticRuleVersion27]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject28')._analyticRulecontentId28]",
                              "version": "[variables('analyticRuleObject28').analyticRuleVersion28]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject29')._analyticRulecontentId29]",
                              "version": "[variables('analyticRuleObject29').analyticRuleVersion29]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject30')._analyticRulecontentId30]",
                              "version": "[variables('analyticRuleObject30').analyticRuleVersion30]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject31')._analyticRulecontentId31]",
                              "version": "[variables('analyticRuleObject31').analyticRuleVersion31]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject32')._analyticRulecontentId32]",
                              "version": "[variables('analyticRuleObject32').analyticRuleVersion32]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject33')._analyticRulecontentId33]",
                              "version": "[variables('analyticRuleObject33').analyticRuleVersion33]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject34')._analyticRulecontentId34]",
                              "version": "[variables('analyticRuleObject34').analyticRuleVersion34]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject35')._analyticRulecontentId35]",
                              "version": "[variables('analyticRuleObject35').analyticRuleVersion35]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject36')._analyticRulecontentId36]",
                              "version": "[variables('analyticRuleObject36').analyticRuleVersion36]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject37')._analyticRulecontentId37]",
                              "version": "[variables('analyticRuleObject37').analyticRuleVersion37]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject38')._analyticRulecontentId38]",
                              "version": "[variables('analyticRuleObject38').analyticRuleVersion38]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject39')._analyticRulecontentId39]",
                              "version": "[variables('analyticRuleObject39').analyticRuleVersion39]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject40')._analyticRulecontentId40]",
                              "version": "[variables('analyticRuleObject40').analyticRuleVersion40]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject41')._analyticRulecontentId41]",
                              "version": "[variables('analyticRuleObject41').analyticRuleVersion41]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject42')._analyticRulecontentId42]",
                              "version": "[variables('analyticRuleObject42').analyticRuleVersion42]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject43')._analyticRulecontentId43]",
                              "version": "[variables('analyticRuleObject43').analyticRuleVersion43]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject44')._analyticRulecontentId44]",
                              "version": "[variables('analyticRuleObject44').analyticRuleVersion44]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject45')._analyticRulecontentId45]",
                              "version": "[variables('analyticRuleObject45').analyticRuleVersion45]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject46')._analyticRulecontentId46]",
                              "version": "[variables('analyticRuleObject46').analyticRuleVersion46]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject47')._analyticRulecontentId47]",
                              "version": "[variables('analyticRuleObject47').analyticRuleVersion47]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject48')._analyticRulecontentId48]",
                              "version": "[variables('analyticRuleObject48').analyticRuleVersion48]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject49')._analyticRulecontentId49]",
                              "version": "[variables('analyticRuleObject49').analyticRuleVersion49]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject50')._analyticRulecontentId50]",
                              "version": "[variables('analyticRuleObject50').analyticRuleVersion50]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject51')._analyticRulecontentId51]",
                              "version": "[variables('analyticRuleObject51').analyticRuleVersion51]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject52')._analyticRulecontentId52]",
                              "version": "[variables('analyticRuleObject52').analyticRuleVersion52]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject53')._analyticRulecontentId53]",
                              "version": "[variables('analyticRuleObject53').analyticRuleVersion53]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject54')._analyticRulecontentId54]",
                              "version": "[variables('analyticRuleObject54').analyticRuleVersion54]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject55')._analyticRulecontentId55]",
                              "version": "[variables('analyticRuleObject55').analyticRuleVersion55]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject56')._analyticRulecontentId56]",
                              "version": "[variables('analyticRuleObject56').analyticRuleVersion56]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject57')._analyticRulecontentId57]",
                              "version": "[variables('analyticRuleObject57').analyticRuleVersion57]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject58')._analyticRulecontentId58]",
                              "version": "[variables('analyticRuleObject58').analyticRuleVersion58]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject59')._analyticRulecontentId59]",
                              "version": "[variables('analyticRuleObject59').analyticRuleVersion59]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject60')._analyticRulecontentId60]",
                              "version": "[variables('analyticRuleObject60').analyticRuleVersion60]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject61')._analyticRulecontentId61]",
                              "version": "[variables('analyticRuleObject61').analyticRuleVersion61]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject62')._analyticRulecontentId62]",
                              "version": "[variables('analyticRuleObject62').analyticRuleVersion62]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject63')._analyticRulecontentId63]",
                              "version": "[variables('analyticRuleObject63').analyticRuleVersion63]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject64')._analyticRulecontentId64]",
                              "version": "[variables('analyticRuleObject64').analyticRuleVersion64]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject65')._analyticRulecontentId65]",
                              "version": "[variables('analyticRuleObject65').analyticRuleVersion65]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject66')._analyticRulecontentId66]",
                              "version": "[variables('analyticRuleObject66').analyticRuleVersion66]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject67')._analyticRulecontentId67]",
                              "version": "[variables('analyticRuleObject67').analyticRuleVersion67]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject68')._analyticRulecontentId68]",
                              "version": "[variables('analyticRuleObject68').analyticRuleVersion68]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject69')._analyticRulecontentId69]",
                              "version": "[variables('analyticRuleObject69').analyticRuleVersion69]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject70')._analyticRulecontentId70]",
                              "version": "[variables('analyticRuleObject70').analyticRuleVersion70]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject71')._analyticRulecontentId71]",
                              "version": "[variables('analyticRuleObject71').analyticRuleVersion71]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject72')._analyticRulecontentId72]",
                              "version": "[variables('analyticRuleObject72').analyticRuleVersion72]"
                            },
                            {
                              "kind": "AnalyticsRule",
                              "contentId": "[variables('analyticRuleObject73')._analyticRulecontentId73]",
                              "version": "[variables('analyticRuleObject73').analyticRuleVersion73]"
                            },
                            {
                              "kind": "Playbook",
                              "contentId": "[variables('_Block-AADUser-alert-trigger')]",
                              "version": "[variables('playbookVersion1')]"
                            },
                            {
                              "kind": "Playbook",
                              "contentId": "[variables('_Block-AADUser-incident-trigger')]",
                              "version": "[variables('playbookVersion2')]"
                            },
                            {
                              "kind": "Playbook",
                              "contentId": "[variables('_Prompt-User-alert-trigger')]",
                              "version": "[variables('playbookVersion3')]"
                            },
                            {
                              "kind": "Playbook",
                              "contentId": "[variables('_Prompt-User-incident-trigger')]",
                              "version": "[variables('playbookVersion4')]"
                            },
                            {
                              "kind": "Playbook",
                              "contentId": "[variables('_Reset-AADUserPassword-alert-trigger')]",
                              "version": "[variables('playbookVersion5')]"
                            },
                            {
                              "kind": "Playbook",
                              "contentId": "[variables('_Reset-AADUserPassword-incident-trigger')]",
                              "version": "[variables('playbookVersion6')]"
                            },
                            {
                              "kind": "Playbook",
                              "contentId": "[variables('_Block-AADUser-entity-trigger')]",
                              "version": "[variables('playbookVersion7')]"
                            },
                            {
                              "kind": "Playbook",
                              "contentId": "[variables('_Reset-AADUserPassword-entity-trigger')]",
                              "version": "[variables('playbookVersion8')]"
                            },
                            {
                              "kind": "Playbook",
                              "contentId": "[variables('_Revoke-AADSignInSessions-alert-trigger')]",
                              "version": "[variables('playbookVersion9')]"
                            },
                            {
                              "kind": "Playbook",
                              "contentId": "[variables('_Revoke-AADSignInSessions-incident-trigger')]",
                              "version": "[variables('playbookVersion10')]"
                            },
                            {
                              "kind": "Playbook",
                              "contentId": "[variables('_Revoke-AADSignInSessions-entity-trigger')]",
                              "version": "[variables('playbookVersion11')]"
                            }
                          ]
                        },
                        "firstPublishDate": "2022-05-16",
                        "providers": [
                          "Microsoft"
                        ],
                        "categories": {
                          "domains": [
                            "Identity",
                            "Security - Automation (SOAR)"
                          ]
                        }
                      },
                      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
                    }
                  ],
                  "outputs": {}
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[and(parameters('deployActiveDirectoryDomainServices'), parameters('deployIdentity'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-adds-{0}', parameters('deploymentNameSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adminPassword": {
            "value": "[parameters('addsVmAdminPassword')]"
          },
          "adminUsername": {
            "value": "[parameters('addsVmAdminUsername')]"
          },
          "delimiter": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
          },
          "deploymentNameSuffix": {
            "value": "[parameters('deploymentNameSuffix')]"
          },
          "domainName": {
            "value": "[parameters('addsDomainName')]"
          },
          "environmentAbbreviation": {
            "value": "[parameters('environmentAbbreviation')]"
          },
          "hybridUseBenefit": {
            "value": "[parameters('hybridUseBenefit')]"
          },
          "imageOffer": {
            "value": "WindowsServer"
          },
          "imagePublisher": {
            "value": "MicrosoftWindowsServer"
          },
          "imageSku": {
            "value": "[parameters('addsVmImageSku')]"
          },
          "imageVersion": {
            "value": "[parameters('windowsVmImageVersion')]"
          },
          "keyVaultPrivateDnsZoneResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value.keyVault]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "mlzTags": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
          },
          "resourceAbbreviations": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceAbbreviations.value]"
          },
          "safeModeAdminPassword": {
            "value": "[parameters('addsSafeModeAdminPassword')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "tier": {
            "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value, lambda('tier', equals(lambdaVariables('tier').name, 'identity')))[0]]"
          },
          "vmSize": {
            "value": "[parameters('addsVmSize')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7161972628795091820"
            }
          },
          "parameters": {
            "adminPassword": {
              "type": "securestring"
            },
            "adminUsername": {
              "type": "string"
            },
            "delimiter": {
              "type": "string"
            },
            "deploymentNameSuffix": {
              "type": "string"
            },
            "dnsForwarder": {
              "type": "string",
              "defaultValue": "168.63.129.16"
            },
            "domainName": {
              "type": "string"
            },
            "environmentAbbreviation": {
              "type": "string"
            },
            "hybridUseBenefit": {
              "type": "bool"
            },
            "imageOffer": {
              "type": "string"
            },
            "imagePublisher": {
              "type": "string"
            },
            "imageSku": {
              "type": "string"
            },
            "imageVersion": {
              "type": "string"
            },
            "keyVaultPrivateDnsZoneResourceId": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[deployment().location]"
            },
            "mlzTags": {
              "type": "object"
            },
            "resourceAbbreviations": {
              "type": "object"
            },
            "safeModeAdminPassword": {
              "type": "securestring"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "tier": {
              "type": "object"
            },
            "vmCount": {
              "type": "int",
              "defaultValue": 2
            },
            "vmSize": {
              "type": "string"
            }
          },
          "variables": {
            "hubSubscriptionId": "[subscription().subscriptionId]",
            "identitySubscriptionId": "[parameters('tier').subscriptionId]",
            "resourceGroupName": "[format('{0}{1}domainControllers', parameters('tier').namingConvention.resourceGroup, parameters('delimiter'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-adds-rg-{0}-{1}', parameters('tier').name, parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tier').subscriptionId]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "mlzTags": {
                    "value": "[parameters('mlzTags')]"
                  },
                  "name": {
                    "value": "[variables('resourceGroupName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "6902469917586543260"
                    }
                  },
                  "parameters": {
                    "mlzTags": {
                      "type": "object"
                    },
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/resourceGroups",
                      "apiVersion": "2019-05-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Resources/resourceGroups'), createObject()), parameters('mlzTags'))]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "location": {
                      "type": "string",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').location]"
                    },
                    "tags": {
                      "type": "object",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').tags]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-adds-cmk-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tier').subscriptionId]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "delimiter": {
                    "value": "[parameters('delimiter')]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "environmentAbbreviation": {
                    "value": "[parameters('environmentAbbreviation')]"
                  },
                  "keyName": {
                    "value": "[parameters('tier').namingConvention.diskEncryptionSet]"
                  },
                  "keyVaultPrivateDnsZoneResourceId": {
                    "value": "[parameters('keyVaultPrivateDnsZoneResourceId')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[parameters('mlzTags')]"
                  },
                  "resourceAbbreviations": {
                    "value": "[parameters('resourceAbbreviations')]"
                  },
                  "resourceGroupName": {
                    "value": "[variables('resourceGroupName')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "tier": {
                    "value": "[parameters('tier')]"
                  },
                  "type": {
                    "value": "virtualMachine"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "15020316016009677208"
                    }
                  },
                  "parameters": {
                    "delimiter": {
                      "type": "string"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "environmentAbbreviation": {
                      "type": "string"
                    },
                    "keyName": {
                      "type": "string"
                    },
                    "keyVaultPrivateDnsZoneResourceId": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "resourceAbbreviations": {
                      "type": "object"
                    },
                    "resourceGroupName": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "tier": {
                      "type": "object"
                    },
                    "type": {
                      "type": "string",
                      "allowedValues": [
                        "storageAccount",
                        "virtualMachine"
                      ]
                    }
                  },
                  "variables": {
                    "workload": "cmk"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-cmk-id-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tier').subscriptionId]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "userAssignedIdentityName": {
                            "value": "[format('{0}{1}{2}', parameters('tier').namingConvention.userAssignedIdentity, parameters('delimiter'), variables('workload'))]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "15031139150215494995"
                            }
                          },
                          "parameters": {
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "userAssignedIdentityName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                              "apiVersion": "2018-11-30",
                              "name": "[parameters('userAssignedIdentityName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.ManagedIdentity/userAssignedIdentities'), createObject()), parameters('mlzTags'))]"
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[guid(parameters('userAssignedIdentityName'), 'e147488a-f6f5-4113-8e2d-b22465e65bf6', resourceGroup().id)]",
                              "properties": {
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal",
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "resourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName'))]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tier').subscriptionId]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "environmentAbbreviation": {
                            "value": "[parameters('environmentAbbreviation')]"
                          },
                          "keyName": {
                            "value": "[parameters('keyName')]"
                          },
                          "keyVaultName": {
                            "value": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, parameters('resourceGroupName'), parameters('tier').namingConvention.keyVault, variables('workload')))]"
                          },
                          "keyVaultNetworkInterfaceName": {
                            "value": "[format('{0}{1}{2}', parameters('tier').namingConvention.keyVaultNetworkInterface, parameters('delimiter'), variables('workload'))]"
                          },
                          "keyVaultPrivateDnsZoneResourceId": {
                            "value": "[parameters('keyVaultPrivateDnsZoneResourceId')]"
                          },
                          "keyVaultPrivateEndpointName": {
                            "value": "[format('{0}{1}{2}', parameters('tier').namingConvention.keyVaultPrivateEndpoint, parameters('delimiter'), variables('workload'))]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "subnetResourceId": {
                            "value": "[parameters('tier').subnetResourceId]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "10403495100213539569"
                            }
                          },
                          "parameters": {
                            "environmentAbbreviation": {
                              "type": "string"
                            },
                            "keyExpirationInDays": {
                              "type": "int",
                              "defaultValue": 30
                            },
                            "keyName": {
                              "type": "string"
                            },
                            "keyVaultName": {
                              "type": "string"
                            },
                            "keyVaultNetworkInterfaceName": {
                              "type": "string"
                            },
                            "keyVaultPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "keyVaultPrivateEndpointName": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.KeyVault/vaults",
                              "apiVersion": "2022-07-01",
                              "name": "[parameters('keyVaultName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.KeyVault/vaults'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "enabledForDeployment": false,
                                "enabledForDiskEncryption": false,
                                "enabledForTemplateDeployment": false,
                                "enablePurgeProtection": true,
                                "enableRbacAuthorization": true,
                                "enableSoftDelete": true,
                                "networkAcls": {
                                  "bypass": "AzureServices",
                                  "defaultAction": "Deny",
                                  "ipRules": [],
                                  "virtualNetworkRules": []
                                },
                                "publicNetworkAccess": "Disabled",
                                "sku": {
                                  "family": "A",
                                  "name": "premium"
                                },
                                "softDeleteRetentionInDays": "[if(or(equals(parameters('environmentAbbreviation'), 'dev'), equals(parameters('environmentAbbreviation'), 'test')), 7, 90)]",
                                "tenantId": "[subscription().tenantId]"
                              }
                            },
                            {
                              "type": "Microsoft.KeyVault/vaults/keys",
                              "apiVersion": "2022-07-01",
                              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('keyName'))]",
                              "properties": {
                                "attributes": {
                                  "enabled": true
                                },
                                "keySize": 4096,
                                "kty": "RSA-HSM",
                                "rotationPolicy": {
                                  "attributes": {
                                    "expiryTime": "[format('P{0}D', string(parameters('keyExpirationInDays')))]"
                                  },
                                  "lifetimeActions": [
                                    {
                                      "action": {
                                        "type": "Notify"
                                      },
                                      "trigger": {
                                        "timeBeforeExpiry": "P10D"
                                      }
                                    },
                                    {
                                      "action": {
                                        "type": "Rotate"
                                      },
                                      "trigger": {
                                        "timeAfterCreate": "[format('P{0}D', string(sub(parameters('keyExpirationInDays'), 7)))]"
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints",
                              "apiVersion": "2023-04-01",
                              "name": "[parameters('keyVaultPrivateEndpointName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "customNetworkInterfaceName": "[parameters('keyVaultNetworkInterfaceName')]",
                                "privateLinkServiceConnections": [
                                  {
                                    "name": "[parameters('keyVaultPrivateEndpointName')]",
                                    "properties": {
                                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                                      "groupIds": [
                                        "vault"
                                      ]
                                    }
                                  }
                                ],
                                "subnet": {
                                  "id": "[parameters('subnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                              "apiVersion": "2021-08-01",
                              "name": "[format('{0}/{1}', parameters('keyVaultPrivateEndpointName'), parameters('keyVaultName'))]",
                              "properties": {
                                "privateDnsZoneConfigs": [
                                  {
                                    "name": "ipconfig1",
                                    "properties": {
                                      "privateDnsZoneId": "[parameters('keyVaultPrivateDnsZoneResourceId')]"
                                    }
                                  }
                                ]
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints', parameters('keyVaultPrivateEndpointName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "keyName": {
                              "type": "string",
                              "value": "[parameters('keyName')]"
                            },
                            "keyUriWithVersion": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), '2022-07-01').keyUriWithVersion]"
                            },
                            "keyVaultName": {
                              "type": "string",
                              "value": "[parameters('keyVaultName')]"
                            },
                            "keyVaultResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                            },
                            "keyVaultUri": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2022-07-01').vaultUri]"
                            },
                            "networkInterfaceResourceId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', parameters('keyVaultPrivateEndpointName')), '2023-04-01').networkInterfaces[0].id]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-id-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "condition": "[equals(parameters('type'), 'virtualMachine')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-cmk-des-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tier').subscriptionId]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "diskEncryptionSetName": {
                            "value": "[format('{0}{1}{2}', parameters('tier').namingConvention.diskEncryptionSet, parameters('delimiter'), variables('workload'))]"
                          },
                          "keyUrl": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyUriWithVersion.value]"
                          },
                          "keyVaultResourceId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultResourceId.value]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "2637012458681427447"
                            }
                          },
                          "parameters": {
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "diskEncryptionSetName": {
                              "type": "string"
                            },
                            "keyUrl": {
                              "type": "string"
                            },
                            "keyVaultResourceId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Compute/diskEncryptionSets",
                              "apiVersion": "2023-04-02",
                              "name": "[parameters('diskEncryptionSetName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/diskEncryptionSets'), createObject()), parameters('mlzTags'))]",
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "properties": {
                                "activeKey": {
                                  "sourceVault": {
                                    "id": "[parameters('keyVaultResourceId')]"
                                  },
                                  "keyUrl": "[parameters('keyUrl')]"
                                },
                                "encryptionType": "EncryptionAtRestWithPlatformAndCustomerKeys",
                                "rotationToLatestKeyVersionEnabled": true
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('assign-role-des-{0}', parameters('deploymentNameSuffix'))]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "principalId": {
                                    "value": "[reference(resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName')), '2023-04-02', 'full').identity.principalId]"
                                  },
                                  "principalType": {
                                    "value": "ServicePrincipal"
                                  },
                                  "roleDefinitionId": {
                                    "value": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                                  },
                                  "targetResourceId": {
                                    "value": "[resourceGroup().id]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.39.26.7824",
                                      "templateHash": "18061649913040420672"
                                    }
                                  },
                                  "parameters": {
                                    "targetResourceId": {
                                      "type": "string"
                                    },
                                    "roleDefinitionId": {
                                      "type": "string"
                                    },
                                    "principalId": {
                                      "type": "string"
                                    },
                                    "principalType": {
                                      "type": "string",
                                      "defaultValue": "ServicePrincipal",
                                      "allowedValues": [
                                        "ForeignGroup",
                                        "Group",
                                        "ServicePrincipal",
                                        "User"
                                      ]
                                    },
                                    "description": {
                                      "type": "string",
                                      "defaultValue": ""
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "name": "[guid(parameters('targetResourceId'), parameters('roleDefinitionId'), parameters('principalId'))]",
                                      "properties": {
                                        "principalId": "[parameters('principalId')]",
                                        "principalType": "[parameters('principalType')]",
                                        "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                        "description": "[parameters('description')]"
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "resourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "diskEncryptionSetResourceId": {
                      "type": "string",
                      "value": "[if(equals(parameters('type'), 'virtualMachine'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-des-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value, '')]"
                    },
                    "keyVaultProperties": {
                      "type": "object",
                      "value": {
                        "diagnosticSettingName": "[format('{0}{1}{2}', parameters('tier').namingConvention.keyVaultDiagnosticSetting, parameters('delimiter'), variables('workload'))]",
                        "name": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultName.value]",
                        "resourceGroupName": "[parameters('resourceGroupName')]",
                        "subscriptionId": "[parameters('tier').subscriptionId]",
                        "tierName": "[parameters('tier').name]"
                      }
                    },
                    "keyName": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyName.value]"
                    },
                    "keyUriWithVersion": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyUriWithVersion.value]"
                    },
                    "keyVaultName": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultName.value]"
                    },
                    "keyVaultUri": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultUri.value]"
                    },
                    "keyVaultResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultResourceId.value]"
                    },
                    "keyVaultNetworkInterfaceResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceId.value]"
                    },
                    "userAssignedIdentityResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-id-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('deploy-adds-rg-{0}-{1}', parameters('tier').name, parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-adds-availability-set-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tier').subscriptionId]",
              "resourceGroup": "[variables('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "availabilitySetName": {
                    "value": "[parameters('tier').namingConvention.availabilitySet]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[parameters('mlzTags')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "15805203170776258498"
                    }
                  },
                  "parameters": {
                    "availabilitySetName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Compute/availabilitySets",
                      "apiVersion": "2019-07-01",
                      "name": "[parameters('availabilitySetName')]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/availabilitySets'), createObject()), parameters('mlzTags'))]",
                      "sku": {
                        "name": "Aligned"
                      },
                      "properties": {
                        "platformUpdateDomainCount": 5,
                        "platformFaultDomainCount": 2
                      }
                    }
                  ],
                  "outputs": {
                    "resourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Compute/availabilitySets', parameters('availabilitySetName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('deploy-adds-rg-{0}-{1}', parameters('tier').name, parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "copy": {
                "name": "domainControllers",
                "count": "[length(range(0, parameters('vmCount')))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-adds-dc-{0}-{1}', range(0, parameters('vmCount'))[copyIndex()], parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tier').subscriptionId]",
              "resourceGroup": "[variables('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "adminPassword": {
                    "value": "[parameters('adminPassword')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('adminUsername')]"
                  },
                  "availabilitySetResourceId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-adds-availability-set-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                  },
                  "delimiter": {
                    "value": "[parameters('delimiter')]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "diskEncryptionSetResourceId": {
                    "value": "[reference(subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('deploy-adds-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.diskEncryptionSetResourceId.value]"
                  },
                  "dnsForwarder": {
                    "value": "[parameters('dnsForwarder')]"
                  },
                  "domainName": {
                    "value": "[parameters('domainName')]"
                  },
                  "hybridUseBenefit": {
                    "value": "[parameters('hybridUseBenefit')]"
                  },
                  "imageOffer": {
                    "value": "[parameters('imageOffer')]"
                  },
                  "imagePublisher": {
                    "value": "[parameters('imagePublisher')]"
                  },
                  "imageSku": {
                    "value": "[parameters('imageSku')]"
                  },
                  "imageVersion": {
                    "value": "[parameters('imageVersion')]"
                  },
                  "index": {
                    "value": "[range(0, parameters('vmCount'))[copyIndex()]]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[parameters('mlzTags')]"
                  },
                  "privateIPAddressOffset": "[if(equals(variables('hubSubscriptionId'), variables('identitySubscriptionId')), createObject('value', 3), createObject('value', 4))]",
                  "safeModeAdminPassword": {
                    "value": "[parameters('safeModeAdminPassword')]"
                  },
                  "subnetResourceId": {
                    "value": "[parameters('tier').subnetResourceId]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "tier": {
                    "value": "[parameters('tier')]"
                  },
                  "vmSize": {
                    "value": "[parameters('vmSize')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "14232264393575878793"
                    }
                  },
                  "parameters": {
                    "adminPassword": {
                      "type": "securestring"
                    },
                    "adminUsername": {
                      "type": "string"
                    },
                    "availabilitySetResourceId": {
                      "type": "string"
                    },
                    "delimiter": {
                      "type": "string"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "diskEncryptionSetResourceId": {
                      "type": "string"
                    },
                    "dnsForwarder": {
                      "type": "string",
                      "defaultValue": "168.63.129.16"
                    },
                    "domainName": {
                      "type": "string"
                    },
                    "hybridUseBenefit": {
                      "type": "bool"
                    },
                    "imageOffer": {
                      "type": "string"
                    },
                    "imagePublisher": {
                      "type": "string"
                    },
                    "imageSku": {
                      "type": "string"
                    },
                    "imageVersion": {
                      "type": "string"
                    },
                    "index": {
                      "type": "int"
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "privateIPAddressOffset": {
                      "type": "int",
                      "defaultValue": 3
                    },
                    "safeModeAdminPassword": {
                      "type": "securestring"
                    },
                    "subnetResourceId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "tier": {
                      "type": "object"
                    },
                    "vmSize": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "$fxv#0": "param(\r\n    [Parameter(Mandatory = $true)]\r\n    [string]$AdminPassword,\r\n\r\n    [Parameter(Mandatory = $true)]\r\n    [string]$AdminUsername,\r\n\r\n    [Parameter(Mandatory = $true)]\r\n    [int]$DomainControllerNumber,\r\n\r\n    [Parameter(Mandatory = $true)]\r\n    [string]$DomainName,\r\n\r\n    [Parameter(Mandatory = $true)]\r\n    [string]$DNSForwarder,\r\n\r\n    [Parameter(Mandatory = $true)]\r\n    [string]$SafeModeAdminPassword\r\n)\r\n\r\n$ErrorActionPreference = 'Stop'\r\n$WarningPreference = 'SilentlyContinue'\r\n\r\n$SecureAdminPassword = ConvertTo-SecureString -String $AdminPassword -AsPlainText -Force\r\n$DomainCredential = New-Object System.Management.Automation.PSCredential (\"$($DomainName.Split('.')[0])\\$($AdminUsername)\", $SecureAdminPassword)\r\n$SecureSafeModePassword = ConvertTo-SecureString -String $SafeModeAdminPassword -AsPlainText -Force\r\n\r\n# Initialize, partition, and format data disk\r\n$DiskNumber = (Get-Disk | Where-Object { $_.PartitionStyle -eq 'Raw' }).Number\r\nif ($DiskNumber) {\r\n    Initialize-Disk -Number $DiskNumber -PartitionStyle 'GPT' | Out-Null\r\n    New-Partition -DiskNumber $DiskNumber -DriveLetter 'F' -UseMaximumSize | Out-Null\r\n    Format-Volume -DriveLetter 'F' -FileSystem 'NTFS' -NewFileSystemLabel 'ADDS' -Confirm:$false | Out-Null\r\n}\r\n\r\n# Install AD DS role\r\n$FeatureInstalled = (Get-WindowsFeature -Name 'AD-Domain-Services').Installed\r\nif ( -not $FeatureInstalled ) {\r\n    Install-WindowsFeature -Name 'AD-Domain-Services' -IncludeManagementTools | Out-Null\r\n}\r\n\r\n# Import ADDSDeployment module\r\nImport-Module -Name 'ADDSDeployment'\r\n\r\n# Create new forest\r\nif ( $DomainControllerNumber -eq 1 ) {\r\n    try {\r\n        Get-ADForest | Out-Null\r\n    }\r\n    catch [Microsoft.ActiveDirectory.Management.ADIdentityNotFoundException] {\r\n        Install-ADDSForest `\r\n            -DatabasePath 'F:\\NTDS' `\r\n            -DomainMode 'WinThreshold' `\r\n            -DomainName $DomainName `\r\n            -DomainNetbiosName $DomainName.Split('.')[0] `\r\n            -Force `\r\n            -ForestMode 'WinThreshold' `\r\n            -InstallDNS `\r\n            -LogPath 'F:\\Logs' `\r\n            -NoRebootOnCompletion `\r\n            -SafeModeAdministratorPassword $SecureSafeModePassword `\r\n            -SysvolPath 'F:\\SYSVOL' | Out-Null\r\n    }\r\n}\r\n\r\n# Add domain controller to the forest\r\nif ( $DomainControllerNumber -eq 2 ) {\r\n    [array]$ExistingDomainControllers = (Get-ADDomainController).Name\r\n    if ( $ExistingDomainControllers -notcontains $env:COMPUTERNAME ) {\r\n        Install-ADDSDomainController `\r\n            -Credential $DomainCredential `\r\n            -DatabasePath 'F:\\NTDS' `\r\n            -DomainName $DomainName `\r\n            -Force `\r\n            -InstallDNS `\r\n            -LogPath 'F:\\Logs' `\r\n            -NoRebootOnCompletion `\r\n            -SafeModeAdministratorPassword $SecureSafeModePassword `\r\n            -SysvolPath 'F:\\SYSVOL' | Out-Null\r\n    }\r\n}\r\n\r\n# Set DNS server Listening Address to IPv4 address\r\n$DNSServerSettings = Get-DnsServerSetting -All\r\n$IPv4Address = $DNSServerSettings.ListeningIpAddress | Where-Object { $_ -match '^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$' }\r\n$DNSServerSettings.ListeningIpAddress = $IPv4Address\r\n$DNSServerSettings | Set-DnsServerSetting | Out-Null\r\n\r\n\r\n# Set DNS forwarder on the DNS server\r\n$ExistingDNSForwarder = (Get-DnsServerForwarder -ErrorAction 'SilentlyContinue').IPAddress\r\nif ( $ExistingDNSForwarder -ne $DNSForwarder ) {\r\n    Set-DnsServerForwarder `\r\n        -IPAddress $DNSForwarder `\r\n        -UseRootHint:$true | Out-Null\r\n}\r\n\r\nRestart-Computer -Force"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-adds-vm-{0}-{1}', parameters('index'), parameters('deploymentNameSuffix'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "adminPasswordOrKey": {
                            "value": "[parameters('adminPassword')]"
                          },
                          "adminUsername": {
                            "value": "[parameters('adminUsername')]"
                          },
                          "authenticationType": {
                            "value": "password"
                          },
                          "availabilitySetResourceId": {
                            "value": "[parameters('availabilitySetResourceId')]"
                          },
                          "dataDisks": {
                            "value": [
                              {
                                "caching": "None",
                                "createOption": "Empty",
                                "diskSizeGB": 128,
                                "lun": 0,
                                "managedDisk": {
                                  "diskEncryptionSet": {
                                    "id": "[parameters('diskEncryptionSetResourceId')]"
                                  },
                                  "storageAccountType": "Premium_LRS"
                                },
                                "name": "[format('{0}{1}dc{2}{3}{4}1', parameters('tier').namingConvention.virtualMachineDisk, parameters('delimiter'), parameters('delimiter'), parameters('index'), parameters('delimiter'))]"
                              }
                            ]
                          },
                          "diskCaching": {
                            "value": "None"
                          },
                          "diskEncryptionSetResourceId": {
                            "value": "[parameters('diskEncryptionSetResourceId')]"
                          },
                          "diskName": {
                            "value": "[format('{0}{1}dc{2}{3}{4}0', parameters('tier').namingConvention.virtualMachineDisk, parameters('delimiter'), parameters('delimiter'), parameters('index'), parameters('delimiter'))]"
                          },
                          "domainJoin": "[if(equals(parameters('index'), 0), createObject('value', false()), createObject('value', true()))]",
                          "domainName": {
                            "value": "[parameters('domainName')]"
                          },
                          "hybridUseBenefit": {
                            "value": "[parameters('hybridUseBenefit')]"
                          },
                          "imageOffer": {
                            "value": "[parameters('imageOffer')]"
                          },
                          "imagePublisher": {
                            "value": "[parameters('imagePublisher')]"
                          },
                          "imageSku": {
                            "value": "[parameters('imageSku')]"
                          },
                          "imageVersion": {
                            "value": "[parameters('imageVersion')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "networkInterfaceName": {
                            "value": "[format('{0}{1}dc{2}{3}', parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('delimiter'), parameters('delimiter'), parameters('index'))]"
                          },
                          "networkSecurityGroupResourceId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('subnetResourceId'), '/')[2], split(parameters('subnetResourceId'), '/')[4]), 'Microsoft.Network/virtualNetworks', split(parameters('subnetResourceId'), '/')[8]), '2024-07-01').subnets[0].properties.networkSecurityGroup.id]"
                          },
                          "privateIPAddress": {
                            "value": "[cidrHost(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('subnetResourceId'), '/')[2], split(parameters('subnetResourceId'), '/')[4]), 'Microsoft.Network/virtualNetworks', split(parameters('subnetResourceId'), '/')[8]), '2024-07-01').subnets[0].properties.addressPrefix, add(parameters('index'), parameters('privateIPAddressOffset')))]"
                          },
                          "storageAccountType": {
                            "value": "Premium_LRS"
                          },
                          "subnetResourceId": {
                            "value": "[parameters('subnetResourceId')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "virtualMachineName": {
                            "value": "[format('{0}dc{1}', parameters('tier').namingConvention.virtualMachine, parameters('index'))]"
                          },
                          "virtualMachineSize": {
                            "value": "[parameters('vmSize')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "4411186165651791052"
                            }
                          },
                          "parameters": {
                            "adminPasswordOrKey": {
                              "type": "securestring",
                              "minLength": 12
                            },
                            "adminUsername": {
                              "type": "string"
                            },
                            "authenticationType": {
                              "type": "string",
                              "allowedValues": [
                                "sshPublicKey",
                                "password"
                              ]
                            },
                            "availabilitySetResourceId": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "dataDisks": {
                              "type": "array",
                              "defaultValue": []
                            },
                            "diskCaching": {
                              "type": "string",
                              "defaultValue": "ReadWrite"
                            },
                            "diskEncryptionSetResourceId": {
                              "type": "string"
                            },
                            "diskName": {
                              "type": "string"
                            },
                            "domainJoin": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "domainName": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "hybridUseBenefit": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "imageOffer": {
                              "type": "string"
                            },
                            "imagePublisher": {
                              "type": "string"
                            },
                            "imageSku": {
                              "type": "string"
                            },
                            "imageVersion": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "networkInterfaceName": {
                              "type": "string"
                            },
                            "networkSecurityGroupResourceId": {
                              "type": "string"
                            },
                            "privateIPAddress": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "storageAccountType": {
                              "type": "string"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "timestamp": {
                              "type": "string",
                              "defaultValue": "[utcNow('yyyyMMddhhmmss')]"
                            },
                            "virtualMachineName": {
                              "type": "string"
                            },
                            "virtualMachineSize": {
                              "type": "string"
                            }
                          },
                          "variables": {
                            "osType": "[if(contains(parameters('imagePublisher'), 'Windows'), 'Windows', 'Linux')]",
                            "linuxConfiguration": {
                              "disablePasswordAuthentication": true,
                              "ssh": {
                                "publicKeys": [
                                  {
                                    "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                                    "keyData": "[parameters('adminPasswordOrKey')]"
                                  }
                                ]
                              }
                            },
                            "dependencyAgentSupport": [
                              "74-gen2",
                              "75-gen2",
                              "76-gen2",
                              "77-gen2",
                              "78-gen2",
                              "79-gen2",
                              "8-gen2",
                              "8-lvm-gen2",
                              "81-ci-gen2",
                              "81gen2",
                              "82-gen2",
                              "83-gen2",
                              "84-gen2",
                              "85-gen2",
                              "86-gen2",
                              "16_04-daily-lts-gen2",
                              "16_04-lts-gen2",
                              "16_04_0-lts-gen2",
                              "18_04-daily-lts-gen2",
                              "18_04-lts-gen2",
                              "20_04-lts-gen2",
                              "2016-Datacenter",
                              "2016-datacenter-gensecond",
                              "2016-datacenter-gs",
                              "2016-Datacenter-smalldisk",
                              "2016-datacenter-smalldisk-g2",
                              "2016-Datacenter-with-Containers",
                              "2016-datacenter-with-containers-g2",
                              "2016-Datacenter-zhcn",
                              "2016-datacenter-zhcn-g2",
                              "2019-Datacenter",
                              "2019-datacenter-gensecond",
                              "2019-datacenter-gs",
                              "2019-datacenter-gs-g2",
                              "2019-Datacenter-smalldisk",
                              "2019-datacenter-smalldisk-g2",
                              "2019-Datacenter-with-Containers",
                              "2019-datacenter-with-containers-g2",
                              "2019-datacenter-with-containers-gs",
                              "2019-Datacenter-with-Containers-smalldisk",
                              "2019-datacenter-with-containers-smalldisk-g2",
                              "2019-Datacenter-zhcn",
                              "2019-datacenter-zhcn-g2",
                              "2022-datacenter",
                              "2022-datacenter-azure-edition",
                              "2022-datacenter-azure-edition-core",
                              "2022-datacenter-azure-edition-core-smalldisk",
                              "2022-datacenter-azure-edition-hotpatch",
                              "2022-datacenter-azure-edition-hotpatch-smalldisk",
                              "2022-datacenter-azure-edition-smalldisk",
                              "2022-datacenter-core",
                              "2022-datacenter-core-g2",
                              "2022-datacenter-core-smalldisk",
                              "2022-datacenter-core-smalldisk-g2",
                              "2022-datacenter-g2",
                              "2022-datacenter-smalldisk",
                              "2022-datacenter-smalldisk-g2"
                            ]
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/networkInterfaces",
                              "apiVersion": "2021-02-01",
                              "name": "[parameters('networkInterfaceName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkInterfaces'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "enableAcceleratedNetworking": true,
                                "ipConfigurations": [
                                  {
                                    "name": "ipconfig",
                                    "properties": {
                                      "privateIPAddress": "[if(empty(parameters('privateIPAddress')), null(), parameters('privateIPAddress'))]",
                                      "privateIPAllocationMethod": "[if(empty(parameters('privateIPAddress')), 'Dynamic', 'Static')]",
                                      "subnet": {
                                        "id": "[parameters('subnetResourceId')]"
                                      }
                                    }
                                  }
                                ],
                                "networkSecurityGroup": {
                                  "id": "[parameters('networkSecurityGroupResourceId')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines",
                              "apiVersion": "2024-11-01",
                              "name": "[parameters('virtualMachineName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "properties": {
                                "availabilitySet": "[if(empty(parameters('availabilitySetResourceId')), null(), createObject('id', parameters('availabilitySetResourceId')))]",
                                "diagnosticsProfile": {
                                  "bootDiagnostics": {
                                    "enabled": false
                                  }
                                },
                                "hardwareProfile": {
                                  "vmSize": "[parameters('virtualMachineSize')]"
                                },
                                "networkProfile": {
                                  "networkInterfaces": [
                                    {
                                      "id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]",
                                      "properties": {
                                        "deleteOption": "Delete"
                                      }
                                    }
                                  ]
                                },
                                "osProfile": {
                                  "computerName": "[take(parameters('virtualMachineName'), 15)]",
                                  "adminUsername": "[parameters('adminUsername')]",
                                  "adminPassword": "[parameters('adminPasswordOrKey')]",
                                  "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), null(), variables('linuxConfiguration'))]"
                                },
                                "securityProfile": {
                                  "uefiSettings": {
                                    "secureBootEnabled": true,
                                    "vTpmEnabled": true
                                  },
                                  "securityType": "trustedLaunch",
                                  "encryptionAtHost": true
                                },
                                "storageProfile": {
                                  "dataDisks": "[parameters('dataDisks')]",
                                  "imageReference": {
                                    "publisher": "[parameters('imagePublisher')]",
                                    "offer": "[parameters('imageOffer')]",
                                    "sku": "[parameters('imageSku')]",
                                    "version": "[parameters('imageVersion')]"
                                  },
                                  "osDisk": {
                                    "caching": "[parameters('diskCaching')]",
                                    "createOption": "FromImage",
                                    "deleteOption": "Delete",
                                    "managedDisk": {
                                      "diskEncryptionSet": {
                                        "id": "[parameters('diskEncryptionSetResourceId')]"
                                      },
                                      "storageAccountType": "[parameters('storageAccountType')]"
                                    },
                                    "name": "[parameters('diskName')]",
                                    "osType": "[variables('osType')]"
                                  }
                                },
                                "licenseType": "[if(parameters('hybridUseBenefit'), 'Windows_Server', null())]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2024-11-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'GuestAttestation')]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "autoUpgradeMinorVersion": true,
                                "enableAutomaticUpgrade": true,
                                "publisher": "[format('Microsoft.Azure.Security.{0}Attestation', variables('osType'))]",
                                "settings": {
                                  "AttestationConfig": {
                                    "AscSettings": {
                                      "ascReportingEndpoint": "",
                                      "ascReportingFrequency": ""
                                    },
                                    "disableAlerts": "false",
                                    "MaaSettings": {
                                      "maaEndpoint": "",
                                      "maaTenantName": "GuestAttestation"
                                    },
                                    "useCustomToken": "false"
                                  }
                                },
                                "type": "GuestAttestation",
                                "typeHandlerVersion": "1.0"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2024-11-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "autoUpgradeMinorVersion": true,
                                "enableAutomaticUpgrade": true,
                                "publisher": "Microsoft.GuestConfiguration",
                                "type": "[format('Configurationfor{0}', variables('osType'))]",
                                "typeHandlerVersion": "1.0"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2024-11-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "autoUpgradeMinorVersion": true,
                                "enableAutomaticUpgrade": true,
                                "publisher": "Microsoft.Azure.NetworkWatcher",
                                "type": "[format('NetworkWatcherAgent{0}', variables('osType'))]",
                                "typeHandlerVersion": "1.4"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2024-11-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('AzureMonitor{0}Agent', variables('osType')))]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "autoUpgradeMinorVersion": true,
                                "enableAutomaticUpgrade": true,
                                "publisher": "Microsoft.Azure.Monitor",
                                "settings": "[if(equals(variables('osType'), 'Windows'), createObject(), createObject('stopOnMultipleConnections', true()))]",
                                "type": "[format('AzureMonitor{0}Agent', variables('osType'))]",
                                "typeHandlerVersion": "1.0"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            },
                            {
                              "condition": "[contains(variables('dependencyAgentSupport'), parameters('imageSku'))]",
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2024-11-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('DependencyAgent{0}', variables('osType')))]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "publisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                                "type": "[format('DependencyAgent{0}', variables('osType'))]",
                                "typeHandlerVersion": "9.5",
                                "autoUpgradeMinorVersion": true
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            },
                            {
                              "condition": "[parameters('domainJoin')]",
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2021-03-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'JsonADDomainExtension')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "forceUpdateTag": "[parameters('timestamp')]",
                                "publisher": "Microsoft.Compute",
                                "type": "JsonADDomainExtension",
                                "typeHandlerVersion": "1.3",
                                "autoUpgradeMinorVersion": true,
                                "settings": {
                                  "Name": "[parameters('domainName')]",
                                  "Options": "3",
                                  "Restart": "true",
                                  "User": "[format('{0}@{1}', parameters('adminUsername'), parameters('domainName'))]"
                                },
                                "protectedSettings": {
                                  "Password": "[parameters('adminPasswordOrKey')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('AzureMonitor{0}Agent', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('DependencyAgent{0}', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), 'GuestAttestation')]",
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "networkInterfaceResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                            },
                            "virtualMachineName": {
                              "type": "string",
                              "value": "[parameters('virtualMachineName')]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-adds-run-command-{0}-{1}', parameters('index'), parameters('deploymentNameSuffix'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "asyncExecution": {
                            "value": true
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "name": {
                            "value": "[format('New-ADDSForest-{0}', parameters('index'))]"
                          },
                          "parameters": {
                            "value": [
                              {
                                "name": "AdminUsername",
                                "value": "[parameters('adminUsername')]"
                              },
                              {
                                "name": "DomainControllerNumber",
                                "value": "[string(add(parameters('index'), 1))]"
                              },
                              {
                                "name": "DomainName",
                                "value": "[parameters('domainName')]"
                              },
                              {
                                "name": "DNSForwarder",
                                "value": "[parameters('dnsForwarder')]"
                              }
                            ]
                          },
                          "protectedParameters": {
                            "value": "[format('[{{''name'':''AdminPassword'',''value'':''{0}''}},{{''name'':''SafeModeAdminPassword'',''value'':''{1}''}}]', parameters('adminPassword'), parameters('safeModeAdminPassword'))]"
                          },
                          "script": {
                            "value": "[variables('$fxv#0')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "treatFailureAsDeploymentFailure": {
                            "value": true
                          },
                          "virtualMachineName": {
                            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-adds-vm-{0}-{1}', parameters('index'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.virtualMachineName.value]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "9067735578119594066"
                            }
                          },
                          "parameters": {
                            "asyncExecution": {
                              "type": "bool",
                              "defaultValue": false
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "name": {
                              "type": "string"
                            },
                            "parameters": {
                              "type": "array",
                              "defaultValue": []
                            },
                            "protectedParameters": {
                              "type": "securestring",
                              "defaultValue": ""
                            },
                            "script": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "treatFailureAsDeploymentFailure": {
                              "type": "bool",
                              "defaultValue": true
                            },
                            "virtualMachineName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Compute/virtualMachines/runCommands",
                              "apiVersion": "2023-09-01",
                              "name": "[format('{0}/{1}', parameters('virtualMachineName'), parameters('name'))]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "asyncExecution": "[parameters('asyncExecution')]",
                                "parameters": "[parameters('parameters')]",
                                "protectedParameters": "[json(parameters('protectedParameters'))]",
                                "source": {
                                  "script": "[parameters('script')]"
                                },
                                "treatFailureAsDeploymentFailure": "[parameters('treatFailureAsDeploymentFailure')]"
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Resources/deployments', format('deploy-adds-vm-{0}-{1}', parameters('index'), parameters('deploymentNameSuffix')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "networkInterfaceResourceId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('deploy-adds-vm-{0}-{1}', parameters('index'), parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceId.value]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-adds-availability-set-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('deploy-adds-cmk-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('deploy-adds-rg-{0}-{1}', parameters('tier').name, parameters('deploymentNameSuffix')))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultProperties": {
              "type": "object",
              "value": "[reference(subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('deploy-adds-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultProperties.value]"
            },
            "networkInterfaceResourceIds": {
              "type": "array",
              "value": [
                "[reference(subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('deploy-adds-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultNetworkInterfaceResourceId.value]",
                "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-adds-dc-{0}-{1}', range(0, parameters('vmCount'))[0], parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceId.value]",
                "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-adds-dc-{0}-{1}', range(0, parameters('vmCount'))[1], parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceId.value]"
              ]
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-security-rg-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[or(or(parameters('deployBastion'), parameters('deployLinuxVirtualMachine')), parameters('deployWindowsVirtualMachine'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-remote-access-{0}', parameters('deploymentNameSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "bastionHostPublicIPAddressAllocationMethod": {
            "value": "Static"
          },
          "bastionHostPublicIPAddressAvailabilityZones": {
            "value": "[parameters('bastionHostPublicIPAddressAvailabilityZones')]"
          },
          "bastionHostPublicIPAddressSkuName": {
            "value": "Standard"
          },
          "bastionHostSubnetResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.bastionHostSubnetResourceId.value]"
          },
          "delimiter": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
          },
          "deployBastion": {
            "value": "[parameters('deployBastion')]"
          },
          "deployLinuxVirtualMachine": {
            "value": "[parameters('deployLinuxVirtualMachine')]"
          },
          "deploymentNameSuffix": {
            "value": "[parameters('deploymentNameSuffix')]"
          },
          "deployWindowsVirtualMachine": {
            "value": "[parameters('deployWindowsVirtualMachine')]"
          },
          "environmentAbbreviation": {
            "value": "[parameters('environmentAbbreviation')]"
          },
          "hybridUseBenefit": {
            "value": "[parameters('hybridUseBenefit')]"
          },
          "keyVaultPrivateDnsZoneResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value.keyVault]"
          },
          "linuxVmAdminPasswordOrKey": {
            "value": "[parameters('linuxVmAdminPasswordOrKey')]"
          },
          "linuxVmAdminUsername": {
            "value": "[parameters('linuxVmAdminUsername')]"
          },
          "linuxVmAuthenticationType": {
            "value": "[parameters('linuxVmAuthenticationType')]"
          },
          "linuxVmImageOffer": {
            "value": "[parameters('linuxVmImageOffer')]"
          },
          "linuxVmImagePublisher": {
            "value": "[parameters('linuxVmImagePublisher')]"
          },
          "linuxVmImageSku": {
            "value": "[parameters('linuxVmImageSku')]"
          },
          "linuxVmImageVersion": {
            "value": "[parameters('linuxVmImageVersion')]"
          },
          "linuxVmOsDiskType": {
            "value": "[parameters('linuxVmOsDiskType')]"
          },
          "linuxVmSize": {
            "value": "[parameters('linuxVmSize')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "mlzTags": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
          },
          "resourceAbbreviations": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceAbbreviations.value]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "tier": {
            "value": "[filter(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value, lambda('tier', equals(lambdaVariables('tier').name, 'hub')))[0]]"
          },
          "windowsVmAdminPassword": {
            "value": "[parameters('windowsVmAdminPassword')]"
          },
          "windowsVmAdminUsername": {
            "value": "[parameters('windowsVmAdminUsername')]"
          },
          "windowsVmImageOffer": {
            "value": "[parameters('windowsVmImageOffer')]"
          },
          "windowsVmImagePublisher": {
            "value": "[parameters('windowsVmImagePublisher')]"
          },
          "windowsVmImageSku": {
            "value": "[parameters('windowsVmImageSku')]"
          },
          "windowsVmSize": {
            "value": "[parameters('windowsVmSize')]"
          },
          "windowsVmStorageAccountType": {
            "value": "[parameters('windowsVmStorageAccountType')]"
          },
          "windowsVmVersion": {
            "value": "[parameters('windowsVmImageVersion')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11661208773492248656"
            }
          },
          "parameters": {
            "bastionHostPublicIPAddressAllocationMethod": {
              "type": "string"
            },
            "bastionHostPublicIPAddressAvailabilityZones": {
              "type": "array"
            },
            "bastionHostPublicIPAddressSkuName": {
              "type": "string"
            },
            "bastionHostSubnetResourceId": {
              "type": "string"
            },
            "delimiter": {
              "type": "string"
            },
            "deployBastion": {
              "type": "bool"
            },
            "deployLinuxVirtualMachine": {
              "type": "bool"
            },
            "deploymentNameSuffix": {
              "type": "string"
            },
            "deployWindowsVirtualMachine": {
              "type": "bool"
            },
            "environmentAbbreviation": {
              "type": "string"
            },
            "hybridUseBenefit": {
              "type": "bool"
            },
            "keyVaultPrivateDnsZoneResourceId": {
              "type": "string"
            },
            "linuxVmAdminPasswordOrKey": {
              "type": "securestring",
              "minLength": 12
            },
            "linuxVmAdminUsername": {
              "type": "string"
            },
            "linuxVmAuthenticationType": {
              "type": "string",
              "allowedValues": [
                "sshPublicKey",
                "password"
              ]
            },
            "linuxVmImagePublisher": {
              "type": "string"
            },
            "linuxVmImageOffer": {
              "type": "string"
            },
            "linuxVmImageSku": {
              "type": "string"
            },
            "linuxVmImageVersion": {
              "type": "string"
            },
            "linuxVmSize": {
              "type": "string"
            },
            "linuxVmOsDiskType": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "mlzTags": {
              "type": "object"
            },
            "resourceAbbreviations": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            },
            "tier": {
              "type": "object"
            },
            "windowsVmAdminPassword": {
              "type": "securestring",
              "minLength": 12
            },
            "windowsVmAdminUsername": {
              "type": "string"
            },
            "windowsVmImageOffer": {
              "type": "string"
            },
            "windowsVmImagePublisher": {
              "type": "string"
            },
            "windowsVmImageSku": {
              "type": "string"
            },
            "windowsVmSize": {
              "type": "string"
            },
            "windowsVmStorageAccountType": {
              "type": "string"
            },
            "windowsVmVersion": {
              "type": "string"
            }
          },
          "variables": {
            "jbResourceGroupName": "[format('{0}{1}jumpBoxes', parameters('tier').namingConvention.resourceGroup, parameters('delimiter'))]"
          },
          "resources": [
            {
              "condition": "[or(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-ra-rg-{0}-{1}', parameters('tier').name, parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tier').subscriptionId]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "mlzTags": {
                    "value": "[parameters('mlzTags')]"
                  },
                  "name": {
                    "value": "[variables('jbResourceGroupName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "6902469917586543260"
                    }
                  },
                  "parameters": {
                    "mlzTags": {
                      "type": "object"
                    },
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/resourceGroups",
                      "apiVersion": "2019-05-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Resources/resourceGroups'), createObject()), parameters('mlzTags'))]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "location": {
                      "type": "string",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').location]"
                    },
                    "tags": {
                      "type": "object",
                      "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name')), '2019-05-01', 'full').tags]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[or(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-ra-cmk-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tier').subscriptionId]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "delimiter": {
                    "value": "[parameters('delimiter')]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "environmentAbbreviation": {
                    "value": "[parameters('environmentAbbreviation')]"
                  },
                  "keyName": {
                    "value": "[parameters('tier').namingConvention.diskEncryptionSet]"
                  },
                  "keyVaultPrivateDnsZoneResourceId": {
                    "value": "[parameters('keyVaultPrivateDnsZoneResourceId')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[parameters('mlzTags')]"
                  },
                  "resourceAbbreviations": {
                    "value": "[parameters('resourceAbbreviations')]"
                  },
                  "resourceGroupName": {
                    "value": "[variables('jbResourceGroupName')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "tier": {
                    "value": "[parameters('tier')]"
                  },
                  "type": {
                    "value": "virtualMachine"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "15020316016009677208"
                    }
                  },
                  "parameters": {
                    "delimiter": {
                      "type": "string"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "environmentAbbreviation": {
                      "type": "string"
                    },
                    "keyName": {
                      "type": "string"
                    },
                    "keyVaultPrivateDnsZoneResourceId": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "resourceAbbreviations": {
                      "type": "object"
                    },
                    "resourceGroupName": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "tier": {
                      "type": "object"
                    },
                    "type": {
                      "type": "string",
                      "allowedValues": [
                        "storageAccount",
                        "virtualMachine"
                      ]
                    }
                  },
                  "variables": {
                    "workload": "cmk"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-cmk-id-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tier').subscriptionId]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "userAssignedIdentityName": {
                            "value": "[format('{0}{1}{2}', parameters('tier').namingConvention.userAssignedIdentity, parameters('delimiter'), variables('workload'))]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "15031139150215494995"
                            }
                          },
                          "parameters": {
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "userAssignedIdentityName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                              "apiVersion": "2018-11-30",
                              "name": "[parameters('userAssignedIdentityName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.ManagedIdentity/userAssignedIdentities'), createObject()), parameters('mlzTags'))]"
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[guid(parameters('userAssignedIdentityName'), 'e147488a-f6f5-4113-8e2d-b22465e65bf6', resourceGroup().id)]",
                              "properties": {
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal",
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "resourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName'))]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tier').subscriptionId]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "environmentAbbreviation": {
                            "value": "[parameters('environmentAbbreviation')]"
                          },
                          "keyName": {
                            "value": "[parameters('keyName')]"
                          },
                          "keyVaultName": {
                            "value": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, parameters('resourceGroupName'), parameters('tier').namingConvention.keyVault, variables('workload')))]"
                          },
                          "keyVaultNetworkInterfaceName": {
                            "value": "[format('{0}{1}{2}', parameters('tier').namingConvention.keyVaultNetworkInterface, parameters('delimiter'), variables('workload'))]"
                          },
                          "keyVaultPrivateDnsZoneResourceId": {
                            "value": "[parameters('keyVaultPrivateDnsZoneResourceId')]"
                          },
                          "keyVaultPrivateEndpointName": {
                            "value": "[format('{0}{1}{2}', parameters('tier').namingConvention.keyVaultPrivateEndpoint, parameters('delimiter'), variables('workload'))]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "subnetResourceId": {
                            "value": "[parameters('tier').subnetResourceId]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "10403495100213539569"
                            }
                          },
                          "parameters": {
                            "environmentAbbreviation": {
                              "type": "string"
                            },
                            "keyExpirationInDays": {
                              "type": "int",
                              "defaultValue": 30
                            },
                            "keyName": {
                              "type": "string"
                            },
                            "keyVaultName": {
                              "type": "string"
                            },
                            "keyVaultNetworkInterfaceName": {
                              "type": "string"
                            },
                            "keyVaultPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "keyVaultPrivateEndpointName": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.KeyVault/vaults",
                              "apiVersion": "2022-07-01",
                              "name": "[parameters('keyVaultName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.KeyVault/vaults'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "enabledForDeployment": false,
                                "enabledForDiskEncryption": false,
                                "enabledForTemplateDeployment": false,
                                "enablePurgeProtection": true,
                                "enableRbacAuthorization": true,
                                "enableSoftDelete": true,
                                "networkAcls": {
                                  "bypass": "AzureServices",
                                  "defaultAction": "Deny",
                                  "ipRules": [],
                                  "virtualNetworkRules": []
                                },
                                "publicNetworkAccess": "Disabled",
                                "sku": {
                                  "family": "A",
                                  "name": "premium"
                                },
                                "softDeleteRetentionInDays": "[if(or(equals(parameters('environmentAbbreviation'), 'dev'), equals(parameters('environmentAbbreviation'), 'test')), 7, 90)]",
                                "tenantId": "[subscription().tenantId]"
                              }
                            },
                            {
                              "type": "Microsoft.KeyVault/vaults/keys",
                              "apiVersion": "2022-07-01",
                              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('keyName'))]",
                              "properties": {
                                "attributes": {
                                  "enabled": true
                                },
                                "keySize": 4096,
                                "kty": "RSA-HSM",
                                "rotationPolicy": {
                                  "attributes": {
                                    "expiryTime": "[format('P{0}D', string(parameters('keyExpirationInDays')))]"
                                  },
                                  "lifetimeActions": [
                                    {
                                      "action": {
                                        "type": "Notify"
                                      },
                                      "trigger": {
                                        "timeBeforeExpiry": "P10D"
                                      }
                                    },
                                    {
                                      "action": {
                                        "type": "Rotate"
                                      },
                                      "trigger": {
                                        "timeAfterCreate": "[format('P{0}D', string(sub(parameters('keyExpirationInDays'), 7)))]"
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints",
                              "apiVersion": "2023-04-01",
                              "name": "[parameters('keyVaultPrivateEndpointName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "customNetworkInterfaceName": "[parameters('keyVaultNetworkInterfaceName')]",
                                "privateLinkServiceConnections": [
                                  {
                                    "name": "[parameters('keyVaultPrivateEndpointName')]",
                                    "properties": {
                                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                                      "groupIds": [
                                        "vault"
                                      ]
                                    }
                                  }
                                ],
                                "subnet": {
                                  "id": "[parameters('subnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                              "apiVersion": "2021-08-01",
                              "name": "[format('{0}/{1}', parameters('keyVaultPrivateEndpointName'), parameters('keyVaultName'))]",
                              "properties": {
                                "privateDnsZoneConfigs": [
                                  {
                                    "name": "ipconfig1",
                                    "properties": {
                                      "privateDnsZoneId": "[parameters('keyVaultPrivateDnsZoneResourceId')]"
                                    }
                                  }
                                ]
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints', parameters('keyVaultPrivateEndpointName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "keyName": {
                              "type": "string",
                              "value": "[parameters('keyName')]"
                            },
                            "keyUriWithVersion": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), '2022-07-01').keyUriWithVersion]"
                            },
                            "keyVaultName": {
                              "type": "string",
                              "value": "[parameters('keyVaultName')]"
                            },
                            "keyVaultResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                            },
                            "keyVaultUri": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2022-07-01').vaultUri]"
                            },
                            "networkInterfaceResourceId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', parameters('keyVaultPrivateEndpointName')), '2023-04-01').networkInterfaces[0].id]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-id-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "condition": "[equals(parameters('type'), 'virtualMachine')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-cmk-des-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tier').subscriptionId]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "diskEncryptionSetName": {
                            "value": "[format('{0}{1}{2}', parameters('tier').namingConvention.diskEncryptionSet, parameters('delimiter'), variables('workload'))]"
                          },
                          "keyUrl": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyUriWithVersion.value]"
                          },
                          "keyVaultResourceId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultResourceId.value]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "2637012458681427447"
                            }
                          },
                          "parameters": {
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "diskEncryptionSetName": {
                              "type": "string"
                            },
                            "keyUrl": {
                              "type": "string"
                            },
                            "keyVaultResourceId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Compute/diskEncryptionSets",
                              "apiVersion": "2023-04-02",
                              "name": "[parameters('diskEncryptionSetName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/diskEncryptionSets'), createObject()), parameters('mlzTags'))]",
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "properties": {
                                "activeKey": {
                                  "sourceVault": {
                                    "id": "[parameters('keyVaultResourceId')]"
                                  },
                                  "keyUrl": "[parameters('keyUrl')]"
                                },
                                "encryptionType": "EncryptionAtRestWithPlatformAndCustomerKeys",
                                "rotationToLatestKeyVersionEnabled": true
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('assign-role-des-{0}', parameters('deploymentNameSuffix'))]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "principalId": {
                                    "value": "[reference(resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName')), '2023-04-02', 'full').identity.principalId]"
                                  },
                                  "principalType": {
                                    "value": "ServicePrincipal"
                                  },
                                  "roleDefinitionId": {
                                    "value": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                                  },
                                  "targetResourceId": {
                                    "value": "[resourceGroup().id]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.39.26.7824",
                                      "templateHash": "18061649913040420672"
                                    }
                                  },
                                  "parameters": {
                                    "targetResourceId": {
                                      "type": "string"
                                    },
                                    "roleDefinitionId": {
                                      "type": "string"
                                    },
                                    "principalId": {
                                      "type": "string"
                                    },
                                    "principalType": {
                                      "type": "string",
                                      "defaultValue": "ServicePrincipal",
                                      "allowedValues": [
                                        "ForeignGroup",
                                        "Group",
                                        "ServicePrincipal",
                                        "User"
                                      ]
                                    },
                                    "description": {
                                      "type": "string",
                                      "defaultValue": ""
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "name": "[guid(parameters('targetResourceId'), parameters('roleDefinitionId'), parameters('principalId'))]",
                                      "properties": {
                                        "principalId": "[parameters('principalId')]",
                                        "principalType": "[parameters('principalType')]",
                                        "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                        "description": "[parameters('description')]"
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "resourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "diskEncryptionSetResourceId": {
                      "type": "string",
                      "value": "[if(equals(parameters('type'), 'virtualMachine'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-des-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value, '')]"
                    },
                    "keyVaultProperties": {
                      "type": "object",
                      "value": {
                        "diagnosticSettingName": "[format('{0}{1}{2}', parameters('tier').namingConvention.keyVaultDiagnosticSetting, parameters('delimiter'), variables('workload'))]",
                        "name": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultName.value]",
                        "resourceGroupName": "[parameters('resourceGroupName')]",
                        "subscriptionId": "[parameters('tier').subscriptionId]",
                        "tierName": "[parameters('tier').name]"
                      }
                    },
                    "keyName": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyName.value]"
                    },
                    "keyUriWithVersion": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyUriWithVersion.value]"
                    },
                    "keyVaultName": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultName.value]"
                    },
                    "keyVaultUri": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultUri.value]"
                    },
                    "keyVaultResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultResourceId.value]"
                    },
                    "keyVaultNetworkInterfaceResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceId.value]"
                    },
                    "userAssignedIdentityResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-id-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('deploy-ra-rg-{0}-{1}', parameters('tier').name, parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "condition": "[parameters('deployLinuxVirtualMachine')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-ra-linux-vm-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tier').subscriptionId]",
              "resourceGroup": "[variables('jbResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "adminPasswordOrKey": {
                    "value": "[parameters('linuxVmAdminPasswordOrKey')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('linuxVmAdminUsername')]"
                  },
                  "authenticationType": {
                    "value": "[parameters('linuxVmAuthenticationType')]"
                  },
                  "diskEncryptionSetResourceId": {
                    "value": "[reference(subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('deploy-ra-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.diskEncryptionSetResourceId.value]"
                  },
                  "diskName": {
                    "value": "[format('{0}{1}lra', parameters('tier').namingConvention.virtualMachineDisk, parameters('delimiter'))]"
                  },
                  "imageOffer": {
                    "value": "[parameters('linuxVmImageOffer')]"
                  },
                  "imagePublisher": {
                    "value": "[parameters('linuxVmImagePublisher')]"
                  },
                  "imageSku": {
                    "value": "[parameters('linuxVmImageSku')]"
                  },
                  "imageVersion": {
                    "value": "[parameters('linuxVmImageVersion')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[parameters('mlzTags')]"
                  },
                  "networkInterfaceName": {
                    "value": "[format('{0}{1}lra', parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('delimiter'))]"
                  },
                  "networkSecurityGroupResourceId": {
                    "value": "[parameters('tier').networkSecurityGroupResourceId]"
                  },
                  "storageAccountType": {
                    "value": "[parameters('linuxVmOsDiskType')]"
                  },
                  "subnetResourceId": {
                    "value": "[parameters('tier').subnetResourceId]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "virtualMachineName": {
                    "value": "[format('{0}lra', parameters('tier').namingConvention.virtualMachine)]"
                  },
                  "virtualMachineSize": {
                    "value": "[parameters('linuxVmSize')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "4411186165651791052"
                    }
                  },
                  "parameters": {
                    "adminPasswordOrKey": {
                      "type": "securestring",
                      "minLength": 12
                    },
                    "adminUsername": {
                      "type": "string"
                    },
                    "authenticationType": {
                      "type": "string",
                      "allowedValues": [
                        "sshPublicKey",
                        "password"
                      ]
                    },
                    "availabilitySetResourceId": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "dataDisks": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "diskCaching": {
                      "type": "string",
                      "defaultValue": "ReadWrite"
                    },
                    "diskEncryptionSetResourceId": {
                      "type": "string"
                    },
                    "diskName": {
                      "type": "string"
                    },
                    "domainJoin": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "domainName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "hybridUseBenefit": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "imageOffer": {
                      "type": "string"
                    },
                    "imagePublisher": {
                      "type": "string"
                    },
                    "imageSku": {
                      "type": "string"
                    },
                    "imageVersion": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "networkInterfaceName": {
                      "type": "string"
                    },
                    "networkSecurityGroupResourceId": {
                      "type": "string"
                    },
                    "privateIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "storageAccountType": {
                      "type": "string"
                    },
                    "subnetResourceId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "timestamp": {
                      "type": "string",
                      "defaultValue": "[utcNow('yyyyMMddhhmmss')]"
                    },
                    "virtualMachineName": {
                      "type": "string"
                    },
                    "virtualMachineSize": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "osType": "[if(contains(parameters('imagePublisher'), 'Windows'), 'Windows', 'Linux')]",
                    "linuxConfiguration": {
                      "disablePasswordAuthentication": true,
                      "ssh": {
                        "publicKeys": [
                          {
                            "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                            "keyData": "[parameters('adminPasswordOrKey')]"
                          }
                        ]
                      }
                    },
                    "dependencyAgentSupport": [
                      "74-gen2",
                      "75-gen2",
                      "76-gen2",
                      "77-gen2",
                      "78-gen2",
                      "79-gen2",
                      "8-gen2",
                      "8-lvm-gen2",
                      "81-ci-gen2",
                      "81gen2",
                      "82-gen2",
                      "83-gen2",
                      "84-gen2",
                      "85-gen2",
                      "86-gen2",
                      "16_04-daily-lts-gen2",
                      "16_04-lts-gen2",
                      "16_04_0-lts-gen2",
                      "18_04-daily-lts-gen2",
                      "18_04-lts-gen2",
                      "20_04-lts-gen2",
                      "2016-Datacenter",
                      "2016-datacenter-gensecond",
                      "2016-datacenter-gs",
                      "2016-Datacenter-smalldisk",
                      "2016-datacenter-smalldisk-g2",
                      "2016-Datacenter-with-Containers",
                      "2016-datacenter-with-containers-g2",
                      "2016-Datacenter-zhcn",
                      "2016-datacenter-zhcn-g2",
                      "2019-Datacenter",
                      "2019-datacenter-gensecond",
                      "2019-datacenter-gs",
                      "2019-datacenter-gs-g2",
                      "2019-Datacenter-smalldisk",
                      "2019-datacenter-smalldisk-g2",
                      "2019-Datacenter-with-Containers",
                      "2019-datacenter-with-containers-g2",
                      "2019-datacenter-with-containers-gs",
                      "2019-Datacenter-with-Containers-smalldisk",
                      "2019-datacenter-with-containers-smalldisk-g2",
                      "2019-Datacenter-zhcn",
                      "2019-datacenter-zhcn-g2",
                      "2022-datacenter",
                      "2022-datacenter-azure-edition",
                      "2022-datacenter-azure-edition-core",
                      "2022-datacenter-azure-edition-core-smalldisk",
                      "2022-datacenter-azure-edition-hotpatch",
                      "2022-datacenter-azure-edition-hotpatch-smalldisk",
                      "2022-datacenter-azure-edition-smalldisk",
                      "2022-datacenter-core",
                      "2022-datacenter-core-g2",
                      "2022-datacenter-core-smalldisk",
                      "2022-datacenter-core-smalldisk-g2",
                      "2022-datacenter-g2",
                      "2022-datacenter-smalldisk",
                      "2022-datacenter-smalldisk-g2"
                    ]
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('networkInterfaceName')]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkInterfaces'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "enableAcceleratedNetworking": true,
                        "ipConfigurations": [
                          {
                            "name": "ipconfig",
                            "properties": {
                              "privateIPAddress": "[if(empty(parameters('privateIPAddress')), null(), parameters('privateIPAddress'))]",
                              "privateIPAllocationMethod": "[if(empty(parameters('privateIPAddress')), 'Dynamic', 'Static')]",
                              "subnet": {
                                "id": "[parameters('subnetResourceId')]"
                              }
                            }
                          }
                        ],
                        "networkSecurityGroup": {
                          "id": "[parameters('networkSecurityGroupResourceId')]"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2024-11-01",
                      "name": "[parameters('virtualMachineName')]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "availabilitySet": "[if(empty(parameters('availabilitySetResourceId')), null(), createObject('id', parameters('availabilitySetResourceId')))]",
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": false
                          }
                        },
                        "hardwareProfile": {
                          "vmSize": "[parameters('virtualMachineSize')]"
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]",
                              "properties": {
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "osProfile": {
                          "computerName": "[take(parameters('virtualMachineName'), 15)]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "adminPassword": "[parameters('adminPasswordOrKey')]",
                          "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), null(), variables('linuxConfiguration'))]"
                        },
                        "securityProfile": {
                          "uefiSettings": {
                            "secureBootEnabled": true,
                            "vTpmEnabled": true
                          },
                          "securityType": "trustedLaunch",
                          "encryptionAtHost": true
                        },
                        "storageProfile": {
                          "dataDisks": "[parameters('dataDisks')]",
                          "imageReference": {
                            "publisher": "[parameters('imagePublisher')]",
                            "offer": "[parameters('imageOffer')]",
                            "sku": "[parameters('imageSku')]",
                            "version": "[parameters('imageVersion')]"
                          },
                          "osDisk": {
                            "caching": "[parameters('diskCaching')]",
                            "createOption": "FromImage",
                            "deleteOption": "Delete",
                            "managedDisk": {
                              "diskEncryptionSet": {
                                "id": "[parameters('diskEncryptionSetResourceId')]"
                              },
                              "storageAccountType": "[parameters('storageAccountType')]"
                            },
                            "name": "[parameters('diskName')]",
                            "osType": "[variables('osType')]"
                          }
                        },
                        "licenseType": "[if(parameters('hybridUseBenefit'), 'Windows_Server', null())]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2024-11-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'GuestAttestation')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "autoUpgradeMinorVersion": true,
                        "enableAutomaticUpgrade": true,
                        "publisher": "[format('Microsoft.Azure.Security.{0}Attestation', variables('osType'))]",
                        "settings": {
                          "AttestationConfig": {
                            "AscSettings": {
                              "ascReportingEndpoint": "",
                              "ascReportingFrequency": ""
                            },
                            "disableAlerts": "false",
                            "MaaSettings": {
                              "maaEndpoint": "",
                              "maaTenantName": "GuestAttestation"
                            },
                            "useCustomToken": "false"
                          }
                        },
                        "type": "GuestAttestation",
                        "typeHandlerVersion": "1.0"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2024-11-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "autoUpgradeMinorVersion": true,
                        "enableAutomaticUpgrade": true,
                        "publisher": "Microsoft.GuestConfiguration",
                        "type": "[format('Configurationfor{0}', variables('osType'))]",
                        "typeHandlerVersion": "1.0"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2024-11-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "autoUpgradeMinorVersion": true,
                        "enableAutomaticUpgrade": true,
                        "publisher": "Microsoft.Azure.NetworkWatcher",
                        "type": "[format('NetworkWatcherAgent{0}', variables('osType'))]",
                        "typeHandlerVersion": "1.4"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2024-11-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('AzureMonitor{0}Agent', variables('osType')))]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "autoUpgradeMinorVersion": true,
                        "enableAutomaticUpgrade": true,
                        "publisher": "Microsoft.Azure.Monitor",
                        "settings": "[if(equals(variables('osType'), 'Windows'), createObject(), createObject('stopOnMultipleConnections', true()))]",
                        "type": "[format('AzureMonitor{0}Agent', variables('osType'))]",
                        "typeHandlerVersion": "1.0"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                      ]
                    },
                    {
                      "condition": "[contains(variables('dependencyAgentSupport'), parameters('imageSku'))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2024-11-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('DependencyAgent{0}', variables('osType')))]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                        "type": "[format('DependencyAgent{0}', variables('osType'))]",
                        "typeHandlerVersion": "9.5",
                        "autoUpgradeMinorVersion": true
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                      ]
                    },
                    {
                      "condition": "[parameters('domainJoin')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'JsonADDomainExtension')]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "forceUpdateTag": "[parameters('timestamp')]",
                        "publisher": "Microsoft.Compute",
                        "type": "JsonADDomainExtension",
                        "typeHandlerVersion": "1.3",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "Name": "[parameters('domainName')]",
                          "Options": "3",
                          "Restart": "true",
                          "User": "[format('{0}@{1}', parameters('adminUsername'), parameters('domainName'))]"
                        },
                        "protectedSettings": {
                          "Password": "[parameters('adminPasswordOrKey')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('AzureMonitor{0}Agent', variables('osType')))]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('DependencyAgent{0}', variables('osType')))]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), 'GuestAttestation')]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "networkInterfaceResourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                    },
                    "virtualMachineName": {
                      "type": "string",
                      "value": "[parameters('virtualMachineName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('deploy-ra-cmk-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('deploy-ra-rg-{0}-{1}', parameters('tier').name, parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "condition": "[parameters('deployWindowsVirtualMachine')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-ra-windows-vm-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tier').subscriptionId]",
              "resourceGroup": "[variables('jbResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "adminPasswordOrKey": {
                    "value": "[parameters('windowsVmAdminPassword')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('windowsVmAdminUsername')]"
                  },
                  "authenticationType": {
                    "value": "password"
                  },
                  "diskEncryptionSetResourceId": {
                    "value": "[reference(subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('deploy-ra-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.diskEncryptionSetResourceId.value]"
                  },
                  "diskName": {
                    "value": "[format('{0}{1}wra', parameters('tier').namingConvention.virtualMachineDisk, parameters('delimiter'))]"
                  },
                  "hybridUseBenefit": {
                    "value": "[parameters('hybridUseBenefit')]"
                  },
                  "imageOffer": {
                    "value": "[parameters('windowsVmImageOffer')]"
                  },
                  "imagePublisher": {
                    "value": "[parameters('windowsVmImagePublisher')]"
                  },
                  "imageSku": {
                    "value": "[parameters('windowsVmImageSku')]"
                  },
                  "imageVersion": {
                    "value": "[parameters('windowsVmVersion')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[parameters('mlzTags')]"
                  },
                  "networkInterfaceName": {
                    "value": "[format('{0}{1}wra', parameters('tier').namingConvention.virtualMachineNetworkInterface, parameters('delimiter'))]"
                  },
                  "networkSecurityGroupResourceId": {
                    "value": "[parameters('tier').networkSecurityGroupResourceId]"
                  },
                  "storageAccountType": {
                    "value": "[parameters('windowsVmStorageAccountType')]"
                  },
                  "subnetResourceId": {
                    "value": "[parameters('tier').subnetResourceId]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "virtualMachineName": {
                    "value": "[format('{0}wra', parameters('tier').namingConvention.virtualMachine)]"
                  },
                  "virtualMachineSize": {
                    "value": "[parameters('windowsVmSize')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "4411186165651791052"
                    }
                  },
                  "parameters": {
                    "adminPasswordOrKey": {
                      "type": "securestring",
                      "minLength": 12
                    },
                    "adminUsername": {
                      "type": "string"
                    },
                    "authenticationType": {
                      "type": "string",
                      "allowedValues": [
                        "sshPublicKey",
                        "password"
                      ]
                    },
                    "availabilitySetResourceId": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "dataDisks": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "diskCaching": {
                      "type": "string",
                      "defaultValue": "ReadWrite"
                    },
                    "diskEncryptionSetResourceId": {
                      "type": "string"
                    },
                    "diskName": {
                      "type": "string"
                    },
                    "domainJoin": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "domainName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "hybridUseBenefit": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "imageOffer": {
                      "type": "string"
                    },
                    "imagePublisher": {
                      "type": "string"
                    },
                    "imageSku": {
                      "type": "string"
                    },
                    "imageVersion": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "networkInterfaceName": {
                      "type": "string"
                    },
                    "networkSecurityGroupResourceId": {
                      "type": "string"
                    },
                    "privateIPAddress": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "storageAccountType": {
                      "type": "string"
                    },
                    "subnetResourceId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "timestamp": {
                      "type": "string",
                      "defaultValue": "[utcNow('yyyyMMddhhmmss')]"
                    },
                    "virtualMachineName": {
                      "type": "string"
                    },
                    "virtualMachineSize": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "osType": "[if(contains(parameters('imagePublisher'), 'Windows'), 'Windows', 'Linux')]",
                    "linuxConfiguration": {
                      "disablePasswordAuthentication": true,
                      "ssh": {
                        "publicKeys": [
                          {
                            "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                            "keyData": "[parameters('adminPasswordOrKey')]"
                          }
                        ]
                      }
                    },
                    "dependencyAgentSupport": [
                      "74-gen2",
                      "75-gen2",
                      "76-gen2",
                      "77-gen2",
                      "78-gen2",
                      "79-gen2",
                      "8-gen2",
                      "8-lvm-gen2",
                      "81-ci-gen2",
                      "81gen2",
                      "82-gen2",
                      "83-gen2",
                      "84-gen2",
                      "85-gen2",
                      "86-gen2",
                      "16_04-daily-lts-gen2",
                      "16_04-lts-gen2",
                      "16_04_0-lts-gen2",
                      "18_04-daily-lts-gen2",
                      "18_04-lts-gen2",
                      "20_04-lts-gen2",
                      "2016-Datacenter",
                      "2016-datacenter-gensecond",
                      "2016-datacenter-gs",
                      "2016-Datacenter-smalldisk",
                      "2016-datacenter-smalldisk-g2",
                      "2016-Datacenter-with-Containers",
                      "2016-datacenter-with-containers-g2",
                      "2016-Datacenter-zhcn",
                      "2016-datacenter-zhcn-g2",
                      "2019-Datacenter",
                      "2019-datacenter-gensecond",
                      "2019-datacenter-gs",
                      "2019-datacenter-gs-g2",
                      "2019-Datacenter-smalldisk",
                      "2019-datacenter-smalldisk-g2",
                      "2019-Datacenter-with-Containers",
                      "2019-datacenter-with-containers-g2",
                      "2019-datacenter-with-containers-gs",
                      "2019-Datacenter-with-Containers-smalldisk",
                      "2019-datacenter-with-containers-smalldisk-g2",
                      "2019-Datacenter-zhcn",
                      "2019-datacenter-zhcn-g2",
                      "2022-datacenter",
                      "2022-datacenter-azure-edition",
                      "2022-datacenter-azure-edition-core",
                      "2022-datacenter-azure-edition-core-smalldisk",
                      "2022-datacenter-azure-edition-hotpatch",
                      "2022-datacenter-azure-edition-hotpatch-smalldisk",
                      "2022-datacenter-azure-edition-smalldisk",
                      "2022-datacenter-core",
                      "2022-datacenter-core-g2",
                      "2022-datacenter-core-smalldisk",
                      "2022-datacenter-core-smalldisk-g2",
                      "2022-datacenter-g2",
                      "2022-datacenter-smalldisk",
                      "2022-datacenter-smalldisk-g2"
                    ]
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('networkInterfaceName')]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/networkInterfaces'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "enableAcceleratedNetworking": true,
                        "ipConfigurations": [
                          {
                            "name": "ipconfig",
                            "properties": {
                              "privateIPAddress": "[if(empty(parameters('privateIPAddress')), null(), parameters('privateIPAddress'))]",
                              "privateIPAllocationMethod": "[if(empty(parameters('privateIPAddress')), 'Dynamic', 'Static')]",
                              "subnet": {
                                "id": "[parameters('subnetResourceId')]"
                              }
                            }
                          }
                        ],
                        "networkSecurityGroup": {
                          "id": "[parameters('networkSecurityGroupResourceId')]"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2024-11-01",
                      "name": "[parameters('virtualMachineName')]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "availabilitySet": "[if(empty(parameters('availabilitySetResourceId')), null(), createObject('id', parameters('availabilitySetResourceId')))]",
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": false
                          }
                        },
                        "hardwareProfile": {
                          "vmSize": "[parameters('virtualMachineSize')]"
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]",
                              "properties": {
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "osProfile": {
                          "computerName": "[take(parameters('virtualMachineName'), 15)]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "adminPassword": "[parameters('adminPasswordOrKey')]",
                          "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), null(), variables('linuxConfiguration'))]"
                        },
                        "securityProfile": {
                          "uefiSettings": {
                            "secureBootEnabled": true,
                            "vTpmEnabled": true
                          },
                          "securityType": "trustedLaunch",
                          "encryptionAtHost": true
                        },
                        "storageProfile": {
                          "dataDisks": "[parameters('dataDisks')]",
                          "imageReference": {
                            "publisher": "[parameters('imagePublisher')]",
                            "offer": "[parameters('imageOffer')]",
                            "sku": "[parameters('imageSku')]",
                            "version": "[parameters('imageVersion')]"
                          },
                          "osDisk": {
                            "caching": "[parameters('diskCaching')]",
                            "createOption": "FromImage",
                            "deleteOption": "Delete",
                            "managedDisk": {
                              "diskEncryptionSet": {
                                "id": "[parameters('diskEncryptionSetResourceId')]"
                              },
                              "storageAccountType": "[parameters('storageAccountType')]"
                            },
                            "name": "[parameters('diskName')]",
                            "osType": "[variables('osType')]"
                          }
                        },
                        "licenseType": "[if(parameters('hybridUseBenefit'), 'Windows_Server', null())]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2024-11-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'GuestAttestation')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "autoUpgradeMinorVersion": true,
                        "enableAutomaticUpgrade": true,
                        "publisher": "[format('Microsoft.Azure.Security.{0}Attestation', variables('osType'))]",
                        "settings": {
                          "AttestationConfig": {
                            "AscSettings": {
                              "ascReportingEndpoint": "",
                              "ascReportingFrequency": ""
                            },
                            "disableAlerts": "false",
                            "MaaSettings": {
                              "maaEndpoint": "",
                              "maaTenantName": "GuestAttestation"
                            },
                            "useCustomToken": "false"
                          }
                        },
                        "type": "GuestAttestation",
                        "typeHandlerVersion": "1.0"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2024-11-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "autoUpgradeMinorVersion": true,
                        "enableAutomaticUpgrade": true,
                        "publisher": "Microsoft.GuestConfiguration",
                        "type": "[format('Configurationfor{0}', variables('osType'))]",
                        "typeHandlerVersion": "1.0"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2024-11-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "autoUpgradeMinorVersion": true,
                        "enableAutomaticUpgrade": true,
                        "publisher": "Microsoft.Azure.NetworkWatcher",
                        "type": "[format('NetworkWatcherAgent{0}', variables('osType'))]",
                        "typeHandlerVersion": "1.4"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2024-11-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('AzureMonitor{0}Agent', variables('osType')))]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "autoUpgradeMinorVersion": true,
                        "enableAutomaticUpgrade": true,
                        "publisher": "Microsoft.Azure.Monitor",
                        "settings": "[if(equals(variables('osType'), 'Windows'), createObject(), createObject('stopOnMultipleConnections', true()))]",
                        "type": "[format('AzureMonitor{0}Agent', variables('osType'))]",
                        "typeHandlerVersion": "1.0"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                      ]
                    },
                    {
                      "condition": "[contains(variables('dependencyAgentSupport'), parameters('imageSku'))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2024-11-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), format('DependencyAgent{0}', variables('osType')))]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                        "type": "[format('DependencyAgent{0}', variables('osType'))]",
                        "typeHandlerVersion": "9.5",
                        "autoUpgradeMinorVersion": true
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                      ]
                    },
                    {
                      "condition": "[parameters('domainJoin')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}/{1}', parameters('virtualMachineName'), 'JsonADDomainExtension')]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/virtualMachines'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "forceUpdateTag": "[parameters('timestamp')]",
                        "publisher": "Microsoft.Compute",
                        "type": "JsonADDomainExtension",
                        "typeHandlerVersion": "1.3",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "Name": "[parameters('domainName')]",
                          "Options": "3",
                          "Restart": "true",
                          "User": "[format('{0}@{1}', parameters('adminUsername'), parameters('domainName'))]"
                        },
                        "protectedSettings": {
                          "Password": "[parameters('adminPasswordOrKey')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('AzureMonitor{0}Agent', variables('osType')))]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('DependencyAgent{0}', variables('osType')))]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), 'GuestAttestation')]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('Configurationfor{0}', variables('osType')))]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('virtualMachineName'), format('NetworkWatcherAgent{0}', variables('osType')))]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "networkInterfaceResourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                    },
                    "virtualMachineName": {
                      "type": "string",
                      "value": "[parameters('virtualMachineName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('deploy-ra-cmk-{0}', parameters('deploymentNameSuffix')))]",
                "[subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('deploy-ra-rg-{0}-{1}', parameters('tier').name, parameters('deploymentNameSuffix')))]"
              ]
            },
            {
              "condition": "[parameters('deployBastion')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-ra-bastion-host-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tier').subscriptionId]",
              "resourceGroup": "[parameters('tier').resourceGroupName]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "bastionHostSubnetResourceId": {
                    "value": "[parameters('bastionHostSubnetResourceId')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[parameters('mlzTags')]"
                  },
                  "name": {
                    "value": "[parameters('tier').namingConvention.bastionHost]"
                  },
                  "publicIPAddressAllocationMethod": {
                    "value": "[parameters('bastionHostPublicIPAddressAllocationMethod')]"
                  },
                  "publicIPAddressAvailabilityZones": {
                    "value": "[parameters('bastionHostPublicIPAddressAvailabilityZones')]"
                  },
                  "publicIPAddressName": {
                    "value": "[parameters('tier').namingConvention.bastionHostPublicIPAddress]"
                  },
                  "publicIPAddressSkuName": {
                    "value": "[parameters('bastionHostPublicIPAddressSkuName')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "11146668257502889611"
                    }
                  },
                  "parameters": {
                    "bastionHostSubnetResourceId": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "name": {
                      "type": "string"
                    },
                    "publicIPAddressAllocationMethod": {
                      "type": "string"
                    },
                    "publicIPAddressAvailabilityZones": {
                      "type": "array"
                    },
                    "publicIPAddressName": {
                      "type": "string"
                    },
                    "publicIPAddressSkuName": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('publicIPAddressName')]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/publicIPAddresses'), createObject()), parameters('mlzTags'))]",
                      "sku": {
                        "name": "[parameters('publicIPAddressSkuName')]"
                      },
                      "properties": {
                        "publicIPAllocationMethod": "[parameters('publicIPAddressAllocationMethod')]"
                      },
                      "zones": "[parameters('publicIPAddressAvailabilityZones')]"
                    },
                    {
                      "type": "Microsoft.Network/bastionHosts",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/bastionHosts'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('bastionHostSubnetResourceId')]"
                              },
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIPAddressName'))]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIPAddressName'))]"
                      ]
                    }
                  ]
                }
              }
            }
          ],
          "outputs": {
            "keyVaultProperties": {
              "type": "object",
              "value": "[if(or(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine')), reference(subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('deploy-ra-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultProperties.value, createObject())]"
            },
            "networkInterfaceResourceIds": {
              "type": "array",
              "value": "[union(if(or(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine')), createArray(reference(subscriptionResourceId(parameters('tier').subscriptionId, 'Microsoft.Resources/deployments', format('deploy-ra-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultNetworkInterfaceResourceId.value), createArray()), if(parameters('deployLinuxVirtualMachine'), createArray(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('jbResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-ra-linux-vm-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceId.value), createArray()), if(parameters('deployWindowsVirtualMachine'), createArray(reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, variables('jbResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-ra-windows-vm-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceId.value), createArray()))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-log-storage-{0}', parameters('deploymentNameSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "delimiter": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
          },
          "deploymentNameSuffix": {
            "value": "[parameters('deploymentNameSuffix')]"
          },
          "environmentAbbreviation": {
            "value": "[parameters('environmentAbbreviation')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logStorageSkuName": {
            "value": "[parameters('logStorageSkuName')]"
          },
          "mlzTags": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.mlzTags.value]"
          },
          "privateDnsZoneResourceIds": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateDnsZoneResourceIds.value]"
          },
          "resourceAbbreviations": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceAbbreviations.value]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "tiers": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "5711182430155451214"
            }
          },
          "parameters": {
            "delimiter": {
              "type": "string"
            },
            "deploymentNameSuffix": {
              "type": "string"
            },
            "environmentAbbreviation": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "logStorageSkuName": {
              "type": "string"
            },
            "mlzTags": {
              "type": "object"
            },
            "privateDnsZoneResourceIds": {
              "type": "object"
            },
            "resourceAbbreviations": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            },
            "tiers": {
              "type": "array"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-st-cmk-{0}', parameters('deploymentNameSuffix'))]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "delimiter": {
                    "value": "[parameters('delimiter')]"
                  },
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "environmentAbbreviation": {
                    "value": "[parameters('environmentAbbreviation')]"
                  },
                  "keyName": {
                    "value": "StorageEncryptionKey"
                  },
                  "keyVaultPrivateDnsZoneResourceId": {
                    "value": "[parameters('privateDnsZoneResourceIds').keyVault]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[parameters('mlzTags')]"
                  },
                  "resourceAbbreviations": {
                    "value": "[parameters('resourceAbbreviations')]"
                  },
                  "resourceGroupName": {
                    "value": "[filter(parameters('tiers'), lambda('tier', equals(lambdaVariables('tier').name, 'hub')))[0].resourceGroupName]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "tier": {
                    "value": "[filter(parameters('tiers'), lambda('tier', equals(lambdaVariables('tier').name, 'hub')))[0]]"
                  },
                  "type": {
                    "value": "storageAccount"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "15020316016009677208"
                    }
                  },
                  "parameters": {
                    "delimiter": {
                      "type": "string"
                    },
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "environmentAbbreviation": {
                      "type": "string"
                    },
                    "keyName": {
                      "type": "string"
                    },
                    "keyVaultPrivateDnsZoneResourceId": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "resourceAbbreviations": {
                      "type": "object"
                    },
                    "resourceGroupName": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "tier": {
                      "type": "object"
                    },
                    "type": {
                      "type": "string",
                      "allowedValues": [
                        "storageAccount",
                        "virtualMachine"
                      ]
                    }
                  },
                  "variables": {
                    "workload": "cmk"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-cmk-id-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tier').subscriptionId]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          },
                          "userAssignedIdentityName": {
                            "value": "[format('{0}{1}{2}', parameters('tier').namingConvention.userAssignedIdentity, parameters('delimiter'), variables('workload'))]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "15031139150215494995"
                            }
                          },
                          "parameters": {
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "tags": {
                              "type": "object"
                            },
                            "userAssignedIdentityName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                              "apiVersion": "2018-11-30",
                              "name": "[parameters('userAssignedIdentityName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.ManagedIdentity/userAssignedIdentities'), createObject()), parameters('mlzTags'))]"
                            },
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[guid(parameters('userAssignedIdentityName'), 'e147488a-f6f5-4113-8e2d-b22465e65bf6', resourceGroup().id)]",
                              "properties": {
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName')), '2018-11-30').principalId]",
                                "principalType": "ServicePrincipal",
                                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "resourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName'))]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tier').subscriptionId]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "environmentAbbreviation": {
                            "value": "[parameters('environmentAbbreviation')]"
                          },
                          "keyName": {
                            "value": "[parameters('keyName')]"
                          },
                          "keyVaultName": {
                            "value": "[format('{0}{1}', parameters('resourceAbbreviations').keyVaults, uniqueString(parameters('tier').subscriptionId, parameters('resourceGroupName'), parameters('tier').namingConvention.keyVault, variables('workload')))]"
                          },
                          "keyVaultNetworkInterfaceName": {
                            "value": "[format('{0}{1}{2}', parameters('tier').namingConvention.keyVaultNetworkInterface, parameters('delimiter'), variables('workload'))]"
                          },
                          "keyVaultPrivateDnsZoneResourceId": {
                            "value": "[parameters('keyVaultPrivateDnsZoneResourceId')]"
                          },
                          "keyVaultPrivateEndpointName": {
                            "value": "[format('{0}{1}{2}', parameters('tier').namingConvention.keyVaultPrivateEndpoint, parameters('delimiter'), variables('workload'))]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "subnetResourceId": {
                            "value": "[parameters('tier').subnetResourceId]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "10403495100213539569"
                            }
                          },
                          "parameters": {
                            "environmentAbbreviation": {
                              "type": "string"
                            },
                            "keyExpirationInDays": {
                              "type": "int",
                              "defaultValue": 30
                            },
                            "keyName": {
                              "type": "string"
                            },
                            "keyVaultName": {
                              "type": "string"
                            },
                            "keyVaultNetworkInterfaceName": {
                              "type": "string"
                            },
                            "keyVaultPrivateDnsZoneResourceId": {
                              "type": "string"
                            },
                            "keyVaultPrivateEndpointName": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "subnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.KeyVault/vaults",
                              "apiVersion": "2022-07-01",
                              "name": "[parameters('keyVaultName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.KeyVault/vaults'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "enabledForDeployment": false,
                                "enabledForDiskEncryption": false,
                                "enabledForTemplateDeployment": false,
                                "enablePurgeProtection": true,
                                "enableRbacAuthorization": true,
                                "enableSoftDelete": true,
                                "networkAcls": {
                                  "bypass": "AzureServices",
                                  "defaultAction": "Deny",
                                  "ipRules": [],
                                  "virtualNetworkRules": []
                                },
                                "publicNetworkAccess": "Disabled",
                                "sku": {
                                  "family": "A",
                                  "name": "premium"
                                },
                                "softDeleteRetentionInDays": "[if(or(equals(parameters('environmentAbbreviation'), 'dev'), equals(parameters('environmentAbbreviation'), 'test')), 7, 90)]",
                                "tenantId": "[subscription().tenantId]"
                              }
                            },
                            {
                              "type": "Microsoft.KeyVault/vaults/keys",
                              "apiVersion": "2022-07-01",
                              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('keyName'))]",
                              "properties": {
                                "attributes": {
                                  "enabled": true
                                },
                                "keySize": 4096,
                                "kty": "RSA-HSM",
                                "rotationPolicy": {
                                  "attributes": {
                                    "expiryTime": "[format('P{0}D', string(parameters('keyExpirationInDays')))]"
                                  },
                                  "lifetimeActions": [
                                    {
                                      "action": {
                                        "type": "Notify"
                                      },
                                      "trigger": {
                                        "timeBeforeExpiry": "P10D"
                                      }
                                    },
                                    {
                                      "action": {
                                        "type": "Rotate"
                                      },
                                      "trigger": {
                                        "timeAfterCreate": "[format('P{0}D', string(sub(parameters('keyExpirationInDays'), 7)))]"
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints",
                              "apiVersion": "2023-04-01",
                              "name": "[parameters('keyVaultPrivateEndpointName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject()), parameters('mlzTags'))]",
                              "properties": {
                                "customNetworkInterfaceName": "[parameters('keyVaultNetworkInterfaceName')]",
                                "privateLinkServiceConnections": [
                                  {
                                    "name": "[parameters('keyVaultPrivateEndpointName')]",
                                    "properties": {
                                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                                      "groupIds": [
                                        "vault"
                                      ]
                                    }
                                  }
                                ],
                                "subnet": {
                                  "id": "[parameters('subnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                              ]
                            },
                            {
                              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                              "apiVersion": "2021-08-01",
                              "name": "[format('{0}/{1}', parameters('keyVaultPrivateEndpointName'), parameters('keyVaultName'))]",
                              "properties": {
                                "privateDnsZoneConfigs": [
                                  {
                                    "name": "ipconfig1",
                                    "properties": {
                                      "privateDnsZoneId": "[parameters('keyVaultPrivateDnsZoneResourceId')]"
                                    }
                                  }
                                ]
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints', parameters('keyVaultPrivateEndpointName'))]",
                                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "keyName": {
                              "type": "string",
                              "value": "[parameters('keyName')]"
                            },
                            "keyUriWithVersion": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), parameters('keyName')), '2022-07-01').keyUriWithVersion]"
                            },
                            "keyVaultName": {
                              "type": "string",
                              "value": "[parameters('keyVaultName')]"
                            },
                            "keyVaultResourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                            },
                            "keyVaultUri": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2022-07-01').vaultUri]"
                            },
                            "networkInterfaceResourceId": {
                              "type": "string",
                              "value": "[reference(resourceId('Microsoft.Network/privateEndpoints', parameters('keyVaultPrivateEndpointName')), '2023-04-01').networkInterfaces[0].id]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-id-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    },
                    {
                      "condition": "[equals(parameters('type'), 'virtualMachine')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-cmk-des-{0}', parameters('deploymentNameSuffix'))]",
                      "subscriptionId": "[parameters('tier').subscriptionId]",
                      "resourceGroup": "[parameters('resourceGroupName')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deploymentNameSuffix": {
                            "value": "[parameters('deploymentNameSuffix')]"
                          },
                          "diskEncryptionSetName": {
                            "value": "[format('{0}{1}{2}', parameters('tier').namingConvention.diskEncryptionSet, parameters('delimiter'), variables('workload'))]"
                          },
                          "keyUrl": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyUriWithVersion.value]"
                          },
                          "keyVaultResourceId": {
                            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultResourceId.value]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "mlzTags": {
                            "value": "[parameters('mlzTags')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "2637012458681427447"
                            }
                          },
                          "parameters": {
                            "deploymentNameSuffix": {
                              "type": "string"
                            },
                            "diskEncryptionSetName": {
                              "type": "string"
                            },
                            "keyUrl": {
                              "type": "string"
                            },
                            "keyVaultResourceId": {
                              "type": "string"
                            },
                            "location": {
                              "type": "string"
                            },
                            "mlzTags": {
                              "type": "object"
                            },
                            "tags": {
                              "type": "object"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Compute/diskEncryptionSets",
                              "apiVersion": "2023-04-02",
                              "name": "[parameters('diskEncryptionSetName')]",
                              "location": "[parameters('location')]",
                              "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Compute/diskEncryptionSets'), createObject()), parameters('mlzTags'))]",
                              "identity": {
                                "type": "SystemAssigned"
                              },
                              "properties": {
                                "activeKey": {
                                  "sourceVault": {
                                    "id": "[parameters('keyVaultResourceId')]"
                                  },
                                  "keyUrl": "[parameters('keyUrl')]"
                                },
                                "encryptionType": "EncryptionAtRestWithPlatformAndCustomerKeys",
                                "rotationToLatestKeyVersionEnabled": true
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2025-04-01",
                              "name": "[format('assign-role-des-{0}', parameters('deploymentNameSuffix'))]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "principalId": {
                                    "value": "[reference(resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName')), '2023-04-02', 'full').identity.principalId]"
                                  },
                                  "principalType": {
                                    "value": "ServicePrincipal"
                                  },
                                  "roleDefinitionId": {
                                    "value": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                                  },
                                  "targetResourceId": {
                                    "value": "[resourceGroup().id]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.39.26.7824",
                                      "templateHash": "18061649913040420672"
                                    }
                                  },
                                  "parameters": {
                                    "targetResourceId": {
                                      "type": "string"
                                    },
                                    "roleDefinitionId": {
                                      "type": "string"
                                    },
                                    "principalId": {
                                      "type": "string"
                                    },
                                    "principalType": {
                                      "type": "string",
                                      "defaultValue": "ServicePrincipal",
                                      "allowedValues": [
                                        "ForeignGroup",
                                        "Group",
                                        "ServicePrincipal",
                                        "User"
                                      ]
                                    },
                                    "description": {
                                      "type": "string",
                                      "defaultValue": ""
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Authorization/roleAssignments",
                                      "apiVersion": "2020-04-01-preview",
                                      "name": "[guid(parameters('targetResourceId'), parameters('roleDefinitionId'), parameters('principalId'))]",
                                      "properties": {
                                        "principalId": "[parameters('principalId')]",
                                        "principalType": "[parameters('principalType')]",
                                        "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                        "description": "[parameters('description')]"
                                      }
                                    }
                                  ]
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "resourceId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Compute/diskEncryptionSets', parameters('diskEncryptionSetName'))]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "diskEncryptionSetResourceId": {
                      "type": "string",
                      "value": "[if(equals(parameters('type'), 'virtualMachine'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-des-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value, '')]"
                    },
                    "keyVaultProperties": {
                      "type": "object",
                      "value": {
                        "diagnosticSettingName": "[format('{0}{1}{2}', parameters('tier').namingConvention.keyVaultDiagnosticSetting, parameters('delimiter'), variables('workload'))]",
                        "name": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultName.value]",
                        "resourceGroupName": "[parameters('resourceGroupName')]",
                        "subscriptionId": "[parameters('tier').subscriptionId]",
                        "tierName": "[parameters('tier').name]"
                      }
                    },
                    "keyName": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyName.value]"
                    },
                    "keyUriWithVersion": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyUriWithVersion.value]"
                    },
                    "keyVaultName": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultName.value]"
                    },
                    "keyVaultUri": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultUri.value]"
                    },
                    "keyVaultResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultResourceId.value]"
                    },
                    "keyVaultNetworkInterfaceResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-kv-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceId.value]"
                    },
                    "userAssignedIdentityResourceId": {
                      "type": "string",
                      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tier').subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-cmk-id-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.resourceId.value]"
                    }
                  }
                }
              }
            },
            {
              "copy": {
                "name": "storageAccounts",
                "count": "[length(parameters('tiers'))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-storage-account-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tiers')[copyIndex()].subscriptionId]",
              "resourceGroup": "[parameters('tiers')[copyIndex()].resourceGroupName]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "blobsPrivateDnsZoneResourceId": {
                    "value": "[parameters('privateDnsZoneResourceIds').blob]"
                  },
                  "filesPrivateDnsZoneResourceId": {
                    "value": "[parameters('privateDnsZoneResourceIds').file]"
                  },
                  "keyVaultUri": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-st-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultUri.value]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "mlzTags": {
                    "value": "[parameters('mlzTags')]"
                  },
                  "queuesPrivateDnsZoneResourceId": {
                    "value": "[parameters('privateDnsZoneResourceIds').queue]"
                  },
                  "skuName": {
                    "value": "[parameters('logStorageSkuName')]"
                  },
                  "storageEncryptionKeyName": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-st-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyName.value]"
                  },
                  "subnetResourceId": {
                    "value": "[resourceId(parameters('tiers')[copyIndex()].subscriptionId, parameters('tiers')[copyIndex()].resourceGroupName, 'Microsoft.Network/virtualNetworks/subnets', parameters('tiers')[copyIndex()].namingConvention.virtualNetwork, parameters('tiers')[copyIndex()].namingConvention.subnet)]"
                  },
                  "tablesPrivateDnsZoneResourceId": {
                    "value": "[parameters('privateDnsZoneResourceIds').table]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "tier": {
                    "value": "[parameters('tiers')[copyIndex()]]"
                  },
                  "userAssignedIdentityResourceId": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-st-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.userAssignedIdentityResourceId.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "601228445217000460"
                    }
                  },
                  "parameters": {
                    "blobsPrivateDnsZoneResourceId": {
                      "type": "string"
                    },
                    "filesPrivateDnsZoneResourceId": {
                      "type": "string"
                    },
                    "keyVaultUri": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "mlzTags": {
                      "type": "object"
                    },
                    "queuesPrivateDnsZoneResourceId": {
                      "type": "string"
                    },
                    "skuName": {
                      "type": "string"
                    },
                    "storageEncryptionKeyName": {
                      "type": "string"
                    },
                    "subnetResourceId": {
                      "type": "string"
                    },
                    "tablesPrivateDnsZoneResourceId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "tier": {
                      "type": "object"
                    },
                    "userAssignedIdentityResourceId": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "subResources": [
                      {
                        "id": "[parameters('blobsPrivateDnsZoneResourceId')]",
                        "nic": "[format('{0}', parameters('tier').namingConvention.storageAccountBlobNetworkInterface)]",
                        "pe": "[format('{0}', parameters('tier').namingConvention.storageAccountBlobPrivateEndpoint)]"
                      },
                      {
                        "id": "[parameters('filesPrivateDnsZoneResourceId')]",
                        "nic": "[format('{0}', parameters('tier').namingConvention.storageAccountFileNetworkInterface)]",
                        "pe": "[format('{0}', parameters('tier').namingConvention.storageAccountFilePrivateEndpoint)]"
                      },
                      {
                        "id": "[parameters('queuesPrivateDnsZoneResourceId')]",
                        "nic": "[format('{0}', parameters('tier').namingConvention.storageAccountQueueNetworkInterface)]",
                        "pe": "[format('{0}', parameters('tier').namingConvention.storageAccountQueuePrivateEndpoint)]"
                      },
                      {
                        "id": "[parameters('tablesPrivateDnsZoneResourceId')]",
                        "nic": "[format('{0}', parameters('tier').namingConvention.storageAccountTableNetworkInterface)]",
                        "pe": "[format('{0}', parameters('tier').namingConvention.storageAccountTablePrivateEndpoint)]"
                      }
                    ]
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2023-01-01",
                      "name": "[uniqueString(parameters('tier').namingConvention.storageAccount, resourceGroup().id)]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Storage/storageAccounts'), createObject()), parameters('mlzTags'))]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('userAssignedIdentityResourceId'))]": {}
                        }
                      },
                      "kind": "StorageV2",
                      "sku": {
                        "name": "[parameters('skuName')]"
                      },
                      "properties": {
                        "accessTier": "Hot",
                        "allowBlobPublicAccess": false,
                        "allowCrossTenantReplication": false,
                        "allowedCopyScope": "PrivateLink",
                        "allowSharedKeyAccess": false,
                        "defaultToOAuthAuthentication": false,
                        "dnsEndpointType": "Standard",
                        "encryption": {
                          "identity": {
                            "userAssignedIdentity": "[parameters('userAssignedIdentityResourceId')]"
                          },
                          "keySource": "Microsoft.KeyVault",
                          "keyvaultproperties": {
                            "keyvaulturi": "[parameters('keyVaultUri')]",
                            "keyname": "[parameters('storageEncryptionKeyName')]"
                          },
                          "requireInfrastructureEncryption": true,
                          "services": {
                            "blob": {
                              "keyType": "Account",
                              "enabled": true
                            },
                            "file": {
                              "keyType": "Account",
                              "enabled": true
                            },
                            "queue": {
                              "keyType": "Account",
                              "enabled": true
                            },
                            "table": {
                              "keyType": "Account",
                              "enabled": true
                            }
                          }
                        },
                        "minimumTlsVersion": "TLS1_2",
                        "networkAcls": {
                          "bypass": "AzureServices",
                          "virtualNetworkRules": [],
                          "ipRules": [],
                          "defaultAction": "Deny"
                        },
                        "publicNetworkAccess": "Disabled",
                        "supportsHttpsTrafficOnly": true
                      }
                    },
                    {
                      "copy": {
                        "name": "privateEndpoints",
                        "count": "[length(variables('subResources'))]"
                      },
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-04-01",
                      "name": "[variables('subResources')[copyIndex()].pe]",
                      "location": "[parameters('location')]",
                      "tags": "[union(coalesce(tryGet(parameters('tags'), 'Microsoft.Network/privateEndpoints'), createObject()), parameters('mlzTags'))]",
                      "properties": {
                        "customNetworkInterfaceName": "[variables('subResources')[copyIndex()].nic]",
                        "privateLinkServiceConnections": [
                          {
                            "name": "[variables('subResources')[copyIndex()].pe]",
                            "properties": {
                              "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', uniqueString(parameters('tier').namingConvention.storageAccount, resourceGroup().id))]",
                              "groupIds": [
                                "[split(split(variables('subResources')[copyIndex()].id, '/')[8], '.')[1]]"
                              ]
                            }
                          }
                        ],
                        "subnet": {
                          "id": "[parameters('subnetResourceId')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', uniqueString(parameters('tier').namingConvention.storageAccount, resourceGroup().id))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "privateDnsZoneGroups",
                        "count": "[length(variables('subResources'))]"
                      },
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2021-08-01",
                      "name": "[format('{0}/{1}', variables('subResources')[copyIndex()].pe, uniqueString(parameters('tier').namingConvention.storageAccount, resourceGroup().id))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "privateDnsZoneId": "[variables('subResources')[copyIndex()].id]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', variables('subResources')[copyIndex()].pe)]",
                        "[resourceId('Microsoft.Storage/storageAccounts', uniqueString(parameters('tier').namingConvention.storageAccount, resourceGroup().id))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts', uniqueString(parameters('tier').namingConvention.storageAccount, resourceGroup().id))]"
                    },
                    "networkInterfaceResourceIds": {
                      "type": "array",
                      "copy": {
                        "count": "[length(variables('subResources'))]",
                        "input": "[reference(resourceId('Microsoft.Network/privateEndpoints', variables('subResources')[copyIndex()].pe), '2023-04-01').networkInterfaces[0].id]"
                      }
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-st-cmk-{0}', parameters('deploymentNameSuffix')))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultProperties": {
              "type": "object",
              "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-st-cmk-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultProperties.value]"
            },
            "networkInterfaceResourceIds": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('tiers'))]",
                "input": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tiers')[copyIndex()].subscriptionId, parameters('tiers')[copyIndex()].resourceGroupName), 'Microsoft.Resources/deployments', format('deploy-storage-account-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceIds.value]"
              }
            },
            "storageAccountResourceIds": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('tiers'))]",
                "input": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('tiers')[copyIndex()].subscriptionId, parameters('tiers')[copyIndex()].resourceGroupName), 'Microsoft.Resources/deployments', format('deploy-storage-account-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))), '2025-04-01').outputs.id.value]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-adds-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-remote-access-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-diagnostic-settings-{0}', parameters('deploymentNameSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deploySentinel": {
            "value": "[parameters('deploySentinel')]"
          },
          "enableAzureActivityConnector": {
            "value": "[parameters('enableAzureActivityDataConnector')]"
          },
          "bastionDiagnosticsLogs": {
            "value": "[parameters('bastionDiagnosticsLogs')]"
          },
          "bastionDiagnosticsMetrics": {
            "value": "[parameters('bastionDiagnosticsMetrics')]"
          },
          "delimiter": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.delimiter.value]"
          },
          "deployBastion": {
            "value": "[parameters('deployBastion')]"
          },
          "deployNetworkWatcherTrafficAnalytics": {
            "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
          },
          "deploymentNameSuffix": {
            "value": "[parameters('deploymentNameSuffix')]"
          },
          "firewallDiagnosticsLogs": {
            "value": "[parameters('firewallDiagnosticsLogs')]"
          },
          "firewallDiagnosticsMetrics": {
            "value": "[parameters('firewallDiagnosticsMetrics')]"
          },
          "keyVaults": {
            "value": "[union(createArray(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-log-storage-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultProperties.value), if(parameters('deployActiveDirectoryDomainServices'), createArray(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-adds-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultProperties.value), createArray()), if(or(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine')), createArray(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-remote-access-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.keyVaultProperties.value), createArray()))]"
          },
          "keyVaultDiagnosticLogs": {
            "value": "[parameters('keyVaultDiagnosticsLogs')]"
          },
          "keyVaultDiagnosticMetrics": {
            "value": "[parameters('keyVaultDiagnosticsMetrics')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.logAnalyticsWorkspaceResourceId.value]"
          },
          "networkInterfaceDiagnosticsMetrics": {
            "value": "[parameters('networkInterfaceDiagnosticsMetrics')]"
          },
          "networkInterfaceResourceIds": {
            "value": "[union(if(and(parameters('deployActiveDirectoryDomainServices'), parameters('deployIdentity')), reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-adds-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceIds.value, createArray()), reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceIds.value, if(or(parameters('deployLinuxVirtualMachine'), parameters('deployWindowsVirtualMachine')), reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-remote-access-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceIds.value, createArray()), flatten(reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-log-storage-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.networkInterfaceResourceIds.value))]"
          },
          "networkWatcherFlowLogsRetentionDays": {
            "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
          },
          "networkWatcherFlowLogsType": {
            "value": "[parameters('networkWatcherFlowLogsType')]"
          },
          "publicIPAddressDiagnosticsLogs": {
            "value": "[parameters('publicIPAddressDiagnosticsLogs')]"
          },
          "publicIPAddressDiagnosticsMetrics": {
            "value": "[parameters('publicIPAddressDiagnosticsMetrics')]"
          },
          "storageAccountResourceIds": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-log-storage-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.storageAccountResourceIds.value]"
          },
          "supportedClouds": {
            "value": "[parameters('supportedClouds')]"
          },
          "tiers": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11563643005545658839"
            }
          },
          "parameters": {
            "deploySentinel": {
              "type": "bool"
            },
            "enableAzureActivityConnector": {
              "type": "bool"
            },
            "bastionDiagnosticsLogs": {
              "type": "array"
            },
            "bastionDiagnosticsMetrics": {
              "type": "array"
            },
            "delimiter": {
              "type": "string"
            },
            "deployBastion": {
              "type": "bool"
            },
            "deploymentNameSuffix": {
              "type": "string"
            },
            "deployNetworkWatcherTrafficAnalytics": {
              "type": "bool"
            },
            "firewallDiagnosticsLogs": {
              "type": "array"
            },
            "firewallDiagnosticsMetrics": {
              "type": "array"
            },
            "keyVaultDiagnosticLogs": {
              "type": "array"
            },
            "keyVaultDiagnosticMetrics": {
              "type": "array"
            },
            "keyVaults": {
              "type": "array"
            },
            "location": {
              "type": "string"
            },
            "logAnalyticsWorkspaceResourceId": {
              "type": "string"
            },
            "networkInterfaceDiagnosticsMetrics": {
              "type": "array"
            },
            "networkInterfaceResourceIds": {
              "type": "array"
            },
            "networkWatcherFlowLogsRetentionDays": {
              "type": "int"
            },
            "networkWatcherFlowLogsType": {
              "type": "string"
            },
            "publicIPAddressDiagnosticsLogs": {
              "type": "array"
            },
            "publicIPAddressDiagnosticsMetrics": {
              "type": "array"
            },
            "storageAccountResourceIds": {
              "type": "array"
            },
            "supportedClouds": {
              "type": "array"
            },
            "tiers": {
              "type": "array"
            }
          },
          "variables": {
            "copy": [
              {
                "name": "networkSecurityGroups_Tiers",
                "count": "[length(parameters('tiers'))]",
                "input": {
                  "diagnosticLogs": "[parameters('tiers')[copyIndex('networkSecurityGroups_Tiers')].nsgDiagLogs]",
                  "diagnosticSettingName": "[parameters('tiers')[copyIndex('networkSecurityGroups_Tiers')].namingConvention.networkSecurityGroupDiagnosticSetting]",
                  "flowLogsName": "[parameters('tiers')[copyIndex('networkSecurityGroups_Tiers')].namingConvention.networkWatcherFlowLogsNetworkSecurityGroup]",
                  "name": "[parameters('tiers')[copyIndex('networkSecurityGroups_Tiers')].namingConvention.networkSecurityGroup]",
                  "resourceGroupName": "[parameters('tiers')[copyIndex('networkSecurityGroups_Tiers')].resourceGroupName]",
                  "storageAccountResourceId": "[parameters('storageAccountResourceIds')[copyIndex('networkSecurityGroups_Tiers')]]",
                  "subscriptionId": "[parameters('tiers')[copyIndex('networkSecurityGroups_Tiers')].subscriptionId]",
                  "tierName": "[parameters('tiers')[copyIndex('networkSecurityGroups_Tiers')].name]"
                }
              },
              {
                "name": "subscriptionIds",
                "count": "[length(parameters('tiers'))]",
                "input": "[parameters('tiers')[copyIndex('subscriptionIds')].subscriptionId]"
              }
            ],
            "dedupedSubscriptionIds": "[union(variables('subscriptionIds'), createArray())]",
            "hub": "[filter(parameters('tiers'), lambda('tier', equals(lambdaVariables('tier').name, 'hub')))[0]]",
            "networkSecurityGroups": "[union(variables('networkSecurityGroups_Tiers'), variables('networkSecurityGroup_Bastion'))]",
            "networkSecurityGroup_Bastion": "[if(parameters('deployBastion'), createArray(createObject('diagnosticLogs', variables('hub').nsgDiagLogs, 'diagnosticSettingName', variables('hub').namingConvention.bastionHostNetworkSecurityGroupDiagnosticSetting, 'flowLogsName', format('{0}{1}bastion', variables('hub').namingConvention.networkWatcherFlowLogsNetworkSecurityGroup, parameters('delimiter')), 'name', variables('hub').namingConvention.bastionHostNetworkSecurityGroup, 'resourceGroupName', variables('hub').resourceGroupName, 'storageAccountResourceId', parameters('storageAccountResourceIds')[0], 'subscriptionId', variables('hub').subscriptionId, 'tierName', format('hub{0}bas', parameters('delimiter')))), createArray())]",
            "operations": "[filter(parameters('tiers'), lambda('tier', equals(lambdaVariables('tier').name, 'operations')))[0]]",
            "publicIPAddresses": "[union(createArray(createObject('name', format('{0}{1}client', variables('hub').namingConvention.azureFirewallPublicIPAddress, parameters('delimiter')), 'diagName', format('{0}{1}client', variables('hub').namingConvention.azureFirewallPublicIPAddressDiagnosticSetting, parameters('delimiter'))), createObject('name', format('{0}{1}management', variables('hub').namingConvention.azureFirewallPublicIPAddress, parameters('delimiter')), 'diagName', format('{0}{1}management', variables('hub').namingConvention.azureFirewallPublicIPAddressDiagnosticSetting, parameters('delimiter')))), if(parameters('deployBastion'), createArray(createObject('name', variables('hub').namingConvention.bastionHostPublicIPAddress, 'diagName', variables('hub').namingConvention.bastionHostPublicIPAddressDiagnosticSetting)), createArray()))]"
          },
          "resources": [
            {
              "condition": "[not(and(parameters('deploySentinel'), parameters('enableAzureActivityConnector')))]",
              "copy": {
                "name": "activityLogDiagnosticSettings",
                "count": "[length(variables('dedupedSubscriptionIds'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-activity-diags-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[variables('dedupedSubscriptionIds')[copyIndex()]]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "logAnalyticsWorkspaceId": {
                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "4263556345704686596"
                    }
                  },
                  "parameters": {
                    "logAnalyticsWorkspaceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "microsoft.insights/diagnosticSettings",
                      "apiVersion": "2017-05-01-preview",
                      "name": "[format('diag-activity-log-{0}', subscription().subscriptionId)]",
                      "properties": {
                        "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                        "logs": [
                          {
                            "category": "Administrative",
                            "enabled": true
                          },
                          {
                            "category": "Security",
                            "enabled": true
                          },
                          {
                            "category": "ServiceHealth",
                            "enabled": true
                          },
                          {
                            "category": "Alert",
                            "enabled": true
                          },
                          {
                            "category": "Recommendation",
                            "enabled": true
                          },
                          {
                            "category": "Policy",
                            "enabled": true
                          },
                          {
                            "category": "Autoscale",
                            "enabled": true
                          },
                          {
                            "category": "ResourceHealth",
                            "enabled": true
                          }
                        ]
                      }
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-law-diag-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2]]",
              "resourceGroup": "[split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "diagnosticStorageAccountResourceId": {
                    "value": "[parameters('storageAccountResourceIds')[1]]"
                  },
                  "logAnalyticsWorkspaceDiagnosticSettingName": {
                    "value": "[variables('operations').namingConvention.logAnalyticsWorkspaceDiagnosticSetting]"
                  },
                  "logAnalyticsWorkspaceName": {
                    "value": "[split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]]"
                  },
                  "supportedClouds": {
                    "value": "[parameters('supportedClouds')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "7890300608061972713"
                    }
                  },
                  "parameters": {
                    "diagnosticStorageAccountResourceId": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceDiagnosticSettingName": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceName": {
                      "type": "string"
                    },
                    "supportedClouds": {
                      "type": "array"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[contains(parameters('supportedClouds'), environment().name)]",
                      "type": "microsoft.insights/diagnosticSettings",
                      "apiVersion": "2017-05-01-preview",
                      "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', parameters('logAnalyticsWorkspaceName'))]",
                      "name": "[parameters('logAnalyticsWorkspaceDiagnosticSettingName')]",
                      "properties": {
                        "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]",
                        "storageAccountId": "[parameters('diagnosticStorageAccountResourceId')]",
                        "logs": [
                          {
                            "category": "Audit",
                            "enabled": true
                          }
                        ],
                        "metrics": [
                          {
                            "category": "AllMetrics",
                            "enabled": true
                          }
                        ]
                      }
                    }
                  ]
                }
              }
            },
            {
              "copy": {
                "name": "networkSecurityGroupDiagnostics",
                "count": "[length(variables('networkSecurityGroups'))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-nsg-diags-{0}-{1}', variables('networkSecurityGroups')[copyIndex()].tierName, parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[variables('networkSecurityGroups')[copyIndex()].subscriptionId]",
              "resourceGroup": "[variables('networkSecurityGroups')[copyIndex()].resourceGroupName]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "deployNetworkWatcherTrafficAnalytics": {
                    "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                  },
                  "flowLogsName": {
                    "value": "[variables('networkSecurityGroups')[copyIndex()].flowLogsName]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  },
                  "logs": {
                    "value": "[variables('networkSecurityGroups')[copyIndex()].diagnosticLogs]"
                  },
                  "networkSecurityGroupDiagnosticSettingName": {
                    "value": "[variables('networkSecurityGroups')[copyIndex()].diagnosticSettingName]"
                  },
                  "networkSecurityGroupName": {
                    "value": "[variables('networkSecurityGroups')[copyIndex()].name]"
                  },
                  "networkWatcherFlowLogsRetentionDays": {
                    "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                  },
                  "networkWatcherFlowLogsType": {
                    "value": "[parameters('networkWatcherFlowLogsType')]"
                  },
                  "storageAccountResourceId": {
                    "value": "[variables('networkSecurityGroups')[copyIndex()].storageAccountResourceId]"
                  },
                  "tiername": {
                    "value": "[variables('networkSecurityGroups')[copyIndex()].tierName]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "5779601753711728121"
                    }
                  },
                  "parameters": {
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "deployNetworkWatcherTrafficAnalytics": {
                      "type": "bool"
                    },
                    "flowLogsName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "logs": {
                      "type": "array"
                    },
                    "networkSecurityGroupDiagnosticSettingName": {
                      "type": "string"
                    },
                    "networkSecurityGroupName": {
                      "type": "string"
                    },
                    "networkWatcherFlowLogsRetentionDays": {
                      "type": "int"
                    },
                    "networkWatcherFlowLogsType": {
                      "type": "string"
                    },
                    "storageAccountResourceId": {
                      "type": "string"
                    },
                    "tiername": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "microsoft.insights/diagnosticSettings",
                      "apiVersion": "2017-05-01-preview",
                      "scope": "[format('Microsoft.Network/networkSecurityGroups/{0}', parameters('networkSecurityGroupName'))]",
                      "name": "[parameters('networkSecurityGroupDiagnosticSettingName')]",
                      "properties": {
                        "logs": "[parameters('logs')]",
                        "metrics": [],
                        "storageAccountId": "[parameters('storageAccountResourceId')]",
                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                      }
                    },
                    {
                      "condition": "[equals(parameters('networkWatcherFlowLogsType'), 'NetworkSecurityGroup')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-{0}-flowLogs-{1}', parameters('tiername'), parameters('deploymentNameSuffix'))]",
                      "resourceGroup": "NetworkWatcherRG",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deployNetworkWatcherTrafficAnalytics": {
                            "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                          },
                          "flowLogsName": {
                            "value": "[parameters('flowLogsName')]"
                          },
                          "flowLogsRetentionDays": {
                            "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "networkWatcherName": {
                            "value": "[format('NetworkWatcher_{0}', parameters('location'))]"
                          },
                          "storageAccountResourceId": {
                            "value": "[parameters('storageAccountResourceId')]"
                          },
                          "targetResourceId": {
                            "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "8258229738636282635"
                            }
                          },
                          "parameters": {
                            "deployNetworkWatcherTrafficAnalytics": {
                              "type": "bool"
                            },
                            "flowLogsName": {
                              "type": "string"
                            },
                            "flowLogsRetentionDays": {
                              "type": "int"
                            },
                            "location": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "networkWatcherName": {
                              "type": "string"
                            },
                            "storageAccountResourceId": {
                              "type": "string"
                            },
                            "targetResourceId": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/networkWatchers/flowLogs",
                              "apiVersion": "2023-05-01",
                              "name": "[format('{0}/{1}', parameters('networkWatcherName'), parameters('flowLogsName'))]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "targetResourceId": "[parameters('targetResourceId')]",
                                "enabled": true,
                                "storageId": "[parameters('storageAccountResourceId')]",
                                "flowAnalyticsConfiguration": {
                                  "networkWatcherFlowAnalyticsConfiguration": {
                                    "enabled": "[if(parameters('deployNetworkWatcherTrafficAnalytics'), parameters('deployNetworkWatcherTrafficAnalytics'), null())]",
                                    "workspaceResourceId": "[if(parameters('deployNetworkWatcherTrafficAnalytics'), parameters('logAnalyticsWorkspaceResourceId'), null())]"
                                  }
                                },
                                "format": {
                                  "type": "JSON",
                                  "version": 2
                                },
                                "retentionPolicy": {
                                  "days": "[parameters('flowLogsRetentionDays')]",
                                  "enabled": true
                                }
                              }
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              }
            },
            {
              "copy": {
                "name": "virtualNetworkDiagnostics",
                "count": "[length(parameters('tiers'))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-vnet-diags-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tiers')[copyIndex()].subscriptionId]",
              "resourceGroup": "[parameters('tiers')[copyIndex()].resourceGroupName]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "deploymentNameSuffix": {
                    "value": "[parameters('deploymentNameSuffix')]"
                  },
                  "deployNetworkWatcherTrafficAnalytics": {
                    "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                  },
                  "flowLogsName": {
                    "value": "[parameters('tiers')[copyIndex()].namingConvention.networkWatcherFlowLogsVirtualNetwork]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  },
                  "logs": {
                    "value": "[parameters('tiers')[copyIndex()].vnetDiagLogs]"
                  },
                  "logStorageAccountResourceId": {
                    "value": "[parameters('storageAccountResourceIds')[copyIndex()]]"
                  },
                  "metrics": {
                    "value": "[parameters('tiers')[copyIndex()].vnetDiagMetrics]"
                  },
                  "networkWatcherFlowLogsRetentionDays": {
                    "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                  },
                  "networkWatcherFlowLogsType": {
                    "value": "[parameters('networkWatcherFlowLogsType')]"
                  },
                  "tiername": {
                    "value": "[parameters('tiers')[copyIndex()].name]"
                  },
                  "virtualNetworkDiagnosticSettingName": {
                    "value": "[parameters('tiers')[copyIndex()].namingConvention.virtualNetworkDiagnosticSetting]"
                  },
                  "virtualNetworkName": {
                    "value": "[parameters('tiers')[copyIndex()].namingConvention.virtualNetwork]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "9057905153020554236"
                    }
                  },
                  "parameters": {
                    "deploymentNameSuffix": {
                      "type": "string"
                    },
                    "deployNetworkWatcherTrafficAnalytics": {
                      "type": "bool"
                    },
                    "flowLogsName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "logs": {
                      "type": "array"
                    },
                    "logStorageAccountResourceId": {
                      "type": "string"
                    },
                    "metrics": {
                      "type": "array"
                    },
                    "networkWatcherFlowLogsRetentionDays": {
                      "type": "int"
                    },
                    "networkWatcherFlowLogsType": {
                      "type": "string"
                    },
                    "supportedClouds": {
                      "type": "array",
                      "defaultValue": [
                        "AzureCloud"
                      ]
                    },
                    "tiername": {
                      "type": "string"
                    },
                    "virtualNetworkDiagnosticSettingName": {
                      "type": "string"
                    },
                    "virtualNetworkName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "microsoft.insights/diagnosticSettings",
                      "apiVersion": "2017-05-01-preview",
                      "scope": "[format('Microsoft.Network/virtualNetworks/{0}', parameters('virtualNetworkName'))]",
                      "name": "[parameters('virtualNetworkDiagnosticSettingName')]",
                      "properties": {
                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]",
                        "logs": "[if(contains(parameters('supportedClouds'), environment().name), parameters('logs'), createArray())]",
                        "metrics": "[parameters('metrics')]"
                      }
                    },
                    {
                      "condition": "[equals(parameters('networkWatcherFlowLogsType'), 'VirtualNetwork')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('deploy-{0}-flowLogs-{1}', parameters('tiername'), parameters('deploymentNameSuffix'))]",
                      "resourceGroup": "NetworkWatcherRG",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "deployNetworkWatcherTrafficAnalytics": {
                            "value": "[parameters('deployNetworkWatcherTrafficAnalytics')]"
                          },
                          "flowLogsName": {
                            "value": "[parameters('flowLogsName')]"
                          },
                          "flowLogsRetentionDays": {
                            "value": "[parameters('networkWatcherFlowLogsRetentionDays')]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "logAnalyticsWorkspaceResourceId": {
                            "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                          },
                          "networkWatcherName": {
                            "value": "[format('NetworkWatcher_{0}', parameters('location'))]"
                          },
                          "storageAccountResourceId": {
                            "value": "[parameters('logStorageAccountResourceId')]"
                          },
                          "targetResourceId": {
                            "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "8258229738636282635"
                            }
                          },
                          "parameters": {
                            "deployNetworkWatcherTrafficAnalytics": {
                              "type": "bool"
                            },
                            "flowLogsName": {
                              "type": "string"
                            },
                            "flowLogsRetentionDays": {
                              "type": "int"
                            },
                            "location": {
                              "type": "string"
                            },
                            "logAnalyticsWorkspaceResourceId": {
                              "type": "string"
                            },
                            "networkWatcherName": {
                              "type": "string"
                            },
                            "storageAccountResourceId": {
                              "type": "string"
                            },
                            "targetResourceId": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/networkWatchers/flowLogs",
                              "apiVersion": "2023-05-01",
                              "name": "[format('{0}/{1}', parameters('networkWatcherName'), parameters('flowLogsName'))]",
                              "location": "[parameters('location')]",
                              "properties": {
                                "targetResourceId": "[parameters('targetResourceId')]",
                                "enabled": true,
                                "storageId": "[parameters('storageAccountResourceId')]",
                                "flowAnalyticsConfiguration": {
                                  "networkWatcherFlowAnalyticsConfiguration": {
                                    "enabled": "[if(parameters('deployNetworkWatcherTrafficAnalytics'), parameters('deployNetworkWatcherTrafficAnalytics'), null())]",
                                    "workspaceResourceId": "[if(parameters('deployNetworkWatcherTrafficAnalytics'), parameters('logAnalyticsWorkspaceResourceId'), null())]"
                                  }
                                },
                                "format": {
                                  "type": "JSON",
                                  "version": 2
                                },
                                "retentionPolicy": {
                                  "days": "[parameters('flowLogsRetentionDays')]",
                                  "enabled": true
                                }
                              }
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              }
            },
            {
              "copy": {
                "name": "publicIpAddressDiagnosticSettings",
                "count": "[length(variables('publicIPAddresses'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-pip-diags-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[variables('hub').subscriptionId]",
              "resourceGroup": "[variables('hub').resourceGroupName]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "hubStorageAccountResourceId": {
                    "value": "[parameters('storageAccountResourceIds')[0]]"
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  },
                  "publicIPAddressDiagnosticSettingName": {
                    "value": "[variables('publicIPAddresses')[copyIndex()].diagName]"
                  },
                  "publicIPAddressDiagnosticsLogs": {
                    "value": "[parameters('publicIPAddressDiagnosticsLogs')]"
                  },
                  "publicIPAddressDiagnosticsMetrics": {
                    "value": "[parameters('publicIPAddressDiagnosticsMetrics')]"
                  },
                  "publicIPAddressName": {
                    "value": "[variables('publicIPAddresses')[copyIndex()].name]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "15720868279718191148"
                    }
                  },
                  "parameters": {
                    "hubStorageAccountResourceId": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "publicIPAddressDiagnosticSettingName": {
                      "type": "string"
                    },
                    "publicIPAddressDiagnosticsLogs": {
                      "type": "array"
                    },
                    "publicIPAddressDiagnosticsMetrics": {
                      "type": "array"
                    },
                    "publicIPAddressName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "microsoft.insights/diagnosticSettings",
                      "apiVersion": "2017-05-01-preview",
                      "scope": "[format('Microsoft.Network/publicIPAddresses/{0}', parameters('publicIPAddressName'))]",
                      "name": "[parameters('publicIPAddressDiagnosticSettingName')]",
                      "properties": {
                        "storageAccountId": "[parameters('hubStorageAccountResourceId')]",
                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]",
                        "logs": "[parameters('publicIPAddressDiagnosticsLogs')]",
                        "metrics": "[parameters('publicIPAddressDiagnosticsMetrics')]"
                      }
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-afw-diags-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[variables('hub').subscriptionId]",
              "resourceGroup": "[variables('hub').resourceGroupName]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "firewallDiagnosticSettingsName": {
                    "value": "[variables('hub').namingConvention.azureFirewallDiagnosticSetting]"
                  },
                  "firewallName": {
                    "value": "[variables('hub').namingConvention.azureFirewall]"
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  },
                  "logs": {
                    "value": "[parameters('firewallDiagnosticsLogs')]"
                  },
                  "logStorageAccountResourceId": {
                    "value": "[parameters('storageAccountResourceIds')[0]]"
                  },
                  "metrics": {
                    "value": "[parameters('firewallDiagnosticsMetrics')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "624299096120892849"
                    }
                  },
                  "parameters": {
                    "firewallDiagnosticSettingsName": {
                      "type": "string"
                    },
                    "firewallName": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "logs": {
                      "type": "array"
                    },
                    "logStorageAccountResourceId": {
                      "type": "string"
                    },
                    "metrics": {
                      "type": "array"
                    }
                  },
                  "resources": [
                    {
                      "type": "microsoft.insights/diagnosticSettings",
                      "apiVersion": "2017-05-01-preview",
                      "scope": "[format('Microsoft.Network/azureFirewalls/{0}', parameters('firewallName'))]",
                      "name": "[parameters('firewallDiagnosticSettingsName')]",
                      "properties": {
                        "logs": "[parameters('logs')]",
                        "metrics": "[parameters('metrics')]",
                        "storageAccountId": "[parameters('logStorageAccountResourceId')]",
                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                      }
                    }
                  ],
                  "outputs": {
                    "privateIPAddress": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Network/azureFirewalls', parameters('firewallName')), '2021-02-01').ipConfigurations[0].properties.privateIPAddress]"
                    }
                  }
                }
              }
            },
            {
              "copy": {
                "name": "keyVaultDiagnosticSettings",
                "count": "[length(parameters('keyVaults'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-kv-diags-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('keyVaults')[copyIndex()].subscriptionId]",
              "resourceGroup": "[parameters('keyVaults')[copyIndex()].resourceGroupName]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultDiagnosticSettingName": {
                    "value": "[parameters('keyVaults')[copyIndex()].diagnosticSettingName]"
                  },
                  "keyVaultName": {
                    "value": "[parameters('keyVaults')[copyIndex()].name]"
                  },
                  "keyVaultStorageAccountId": {
                    "value": "[filter(parameters('storageAccountResourceIds'), lambda('id', contains(lambdaVariables('id'), parameters('keyVaults')[copyIndex()].tierName)))[0]]"
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  },
                  "logs": {
                    "value": "[parameters('keyVaultDiagnosticLogs')]"
                  },
                  "metrics": {
                    "value": "[parameters('keyVaultDiagnosticMetrics')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "4481454083899344173"
                    }
                  },
                  "parameters": {
                    "keyVaultDiagnosticSettingName": {
                      "type": "string"
                    },
                    "keyVaultName": {
                      "type": "string"
                    },
                    "keyVaultStorageAccountId": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "logs": {
                      "type": "array"
                    },
                    "metrics": {
                      "type": "array"
                    }
                  },
                  "resources": [
                    {
                      "type": "microsoft.insights/diagnosticSettings",
                      "apiVersion": "2017-05-01-preview",
                      "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
                      "name": "[parameters('keyVaultDiagnosticSettingName')]",
                      "properties": {
                        "logs": "[parameters('logs')]",
                        "metrics": "[parameters('metrics')]",
                        "storageAccountId": "[parameters('keyVaultStorageAccountId')]",
                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                      }
                    }
                  ]
                }
              }
            },
            {
              "condition": "[parameters('deployBastion')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-bastion-diags-{0}', parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[variables('hub').subscriptionId]",
              "resourceGroup": "[variables('hub').resourceGroupName]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "diagnosticSettingName": {
                    "value": "[variables('hub').namingConvention.bastionHostDiagnosticSetting]"
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  },
                  "logs": {
                    "value": "[parameters('bastionDiagnosticsLogs')]"
                  },
                  "metrics": {
                    "value": "[parameters('bastionDiagnosticsMetrics')]"
                  },
                  "name": {
                    "value": "[variables('hub').namingConvention.bastionHost]"
                  },
                  "storageAccountResourceId": {
                    "value": "[parameters('storageAccountResourceIds')[0]]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "14891478741298329435"
                    }
                  },
                  "parameters": {
                    "diagnosticSettingName": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "logs": {
                      "type": "array"
                    },
                    "metrics": {
                      "type": "array"
                    },
                    "name": {
                      "type": "string"
                    },
                    "storageAccountResourceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "microsoft.insights/diagnosticSettings",
                      "apiVersion": "2017-05-01-preview",
                      "scope": "[format('Microsoft.Network/bastionHosts/{0}', parameters('name'))]",
                      "name": "[parameters('diagnosticSettingName')]",
                      "properties": {
                        "logs": "[parameters('logs')]",
                        "metrics": "[parameters('metrics')]",
                        "storageAccountId": "[parameters('storageAccountResourceId')]",
                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                      }
                    }
                  ]
                }
              }
            },
            {
              "copy": {
                "name": "networkInterfaceDiagnostics",
                "count": "[length(parameters('networkInterfaceResourceIds'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('deploy-nic-diags-{0}-{1}', copyIndex(), parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[split(parameters('networkInterfaceResourceIds')[copyIndex()], '/')[2]]",
              "resourceGroup": "[split(parameters('networkInterfaceResourceIds')[copyIndex()], '/')[4]]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  },
                  "logs": {
                    "value": []
                  },
                  "metrics": {
                    "value": "[parameters('networkInterfaceDiagnosticsMetrics')]"
                  },
                  "networkInterfaceResourceId": {
                    "value": "[parameters('networkInterfaceResourceIds')[copyIndex()]]"
                  },
                  "storageAccountResourceIds": {
                    "value": "[parameters('storageAccountResourceIds')]"
                  },
                  "tiers": {
                    "value": "[parameters('tiers')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "764797442845561893"
                    }
                  },
                  "parameters": {
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "logs": {
                      "type": "array"
                    },
                    "metrics": {
                      "type": "array"
                    },
                    "networkInterfaceResourceId": {
                      "type": "string"
                    },
                    "storageAccountResourceIds": {
                      "type": "array"
                    },
                    "tiers": {
                      "type": "array"
                    }
                  },
                  "variables": {
                    "networkInterfaceDiagnosticSettingName": "[parameters('tiers')[variables('tierIndex')].namingConvention.virtualMachineNetworkInterfaceDiagnosticSetting]",
                    "storageAccountResourceId": "[parameters('storageAccountResourceIds')[variables('tierIndex')]]",
                    "tierIndex": "[if(contains(parameters('networkInterfaceResourceId'), '-ops-'), 1, if(contains(parameters('networkInterfaceResourceId'), '-svcs-'), 2, if(contains(parameters('networkInterfaceResourceId'), '-id-'), 3, 0)))]"
                  },
                  "resources": [
                    {
                      "type": "microsoft.insights/diagnosticSettings",
                      "apiVersion": "2017-05-01-preview",
                      "scope": "[format('Microsoft.Network/networkInterfaces/{0}', split(parameters('networkInterfaceResourceId'), '/')[8])]",
                      "name": "[variables('networkInterfaceDiagnosticSettingName')]",
                      "properties": {
                        "logs": "[parameters('logs')]",
                        "metrics": "[parameters('metrics')]",
                        "storageAccountId": "[variables('storageAccountResourceId')]",
                        "workspaceId": "[parameters('logAnalyticsWorkspaceResourceId')]"
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-adds-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-remote-access-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-log-storage-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-workbook-azureactivity-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/custom-workbooks/deploy/AzureActivity.workbook.template.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceResourceId": {
            "value": "[variables('logAnalyticsWorkspaceResourceId')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-workbook-entra-audit-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/custom-workbooks/deploy/AzureActiveDirectoryAuditLogs.workbook.template.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceResourceId": {
            "value": "[variables('logAnalyticsWorkspaceResourceId')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-workbook-entra-signins-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/custom-workbooks/deploy/AzureActiveDirectorySignins.workbook.template.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceResourceId": {
            "value": "[variables('logAnalyticsWorkspaceResourceId')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-workbook-servicehealth-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/custom-workbooks/deploy/AzureServiceHealthWorkbook.workbook.template.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceResourceId": {
            "value": "[variables('logAnalyticsWorkspaceResourceId')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-custom-analytics-01-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/analytic-rules/deploy/AzureAutomationRunbookOrWebhookCreatedOrUpdated.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "enableRule": {
            "value": true
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-custom-analytics-02-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/analytic-rules/deploy/DefaultRouteToInternetOrNVAAdded.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "enableRule": {
            "value": true
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-custom-analytics-03-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/analytic-rules/deploy/DiagnosticSettingsDeletedOrDisabled.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "enableRule": {
            "value": true
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-custom-analytics-04-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/analytic-rules/deploy/KeyVaultPublicAccessEnabled.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "enableRule": {
            "value": true
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-custom-analytics-05-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/analytic-rules/deploy/LocalAdminGroupMembershipChanged.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "enableRule": {
            "value": true
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-custom-analytics-06-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/analytic-rules/deploy/NSGFlowLogsDisabledOrDeleted.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "enableRule": {
            "value": true
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-custom-analytics-07-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/analytic-rules/deploy/NSGInboundAnyAnyRuleCreatedOrUpdated.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "enableRule": {
            "value": true
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-custom-analytics-08-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/analytic-rules/deploy/NSGInboundInternetToManagementPorts.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "enableRule": {
            "value": true
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-custom-analytics-09-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/analytic-rules/deploy/NSGOutboundAllowToInternet.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "enableRule": {
            "value": true
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-custom-analytics-10-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/analytic-rules/deploy/O365InboxRuleForwardingToExternalDomain.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "enableRule": {
            "value": true
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-custom-analytics-11-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/analytic-rules/deploy/PolicyAssignmentDeletedOrDisabled.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "enableRule": {
            "value": true
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-custom-analytics-12-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/analytic-rules/deploy/ResourceLockDeleted.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "enableRule": {
            "value": true
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-custom-analytics-13-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/analytic-rules/deploy/StorageAccountPublicAccessEnabled.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "enableRule": {
            "value": true
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-custom-analytics-14-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/analytic-rules/deploy/SubnetWithoutNSGAssociation.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "enableRule": {
            "value": true
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-custom-analytics-15-{0}', parameters('deploymentNameSuffix'))]",
      "subscriptionId": "[split(variables('logAnalyticsWorkspaceResourceId'), '/')[2]]",
      "resourceGroup": "[variables('monitoringResourceGroupName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/sedmonds22/sedmonds-azsecurity-templates/main/analytic-rules/deploy/SuccessfulLegacyAuthenticationSignin.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "enableRule": {
            "value": true
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sentinel-content-{0}', parameters('deploymentNameSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-security-{0}', parameters('deploymentNameSuffix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "defenderPlans": {
            "value": "[parameters('deployDefenderPlans')]"
          },
          "defenderSkuTier": {
            "value": "[parameters('defenderSkuTier')]"
          },
          "deployDefender": {
            "value": "[parameters('deployDefender')]"
          },
          "deployPolicy": {
            "value": "[parameters('deployPolicy')]"
          },
          "deploymentNameSuffix": {
            "value": "[parameters('deploymentNameSuffix')]"
          },
          "emailSecurityContact": {
            "value": "[parameters('emailSecurityContact')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.logAnalyticsWorkspaceResourceId.value]"
          },
          "policy": {
            "value": "[parameters('policy')]"
          },
          "tiers": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value]"
          },
          "windowsAdministratorsGroupMembership": {
            "value": "[parameters('windowsVmAdminUsername')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7096217308619950446"
            }
          },
          "parameters": {
            "defenderPlans": {
              "type": "array",
              "defaultValue": [
                "VirtualMachines"
              ]
            },
            "defenderSkuTier": {
              "type": "string"
            },
            "deployDefender": {
              "type": "bool"
            },
            "deployPolicy": {
              "type": "bool"
            },
            "deploymentNameSuffix": {
              "type": "string"
            },
            "emailSecurityContact": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "logAnalyticsWorkspaceResourceId": {
              "type": "string"
            },
            "policy": {
              "type": "string"
            },
            "tiers": {
              "type": "array"
            },
            "windowsAdministratorsGroupMembership": {
              "type": "string"
            }
          },
          "resources": [
            {
              "copy": {
                "name": "policyAssignment",
                "count": "[length(parameters('tiers'))]"
              },
              "condition": "[parameters('deployPolicy')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('assign-policy-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tiers')[copyIndex()].subscriptionId]",
              "resourceGroup": "[parameters('tiers')[copyIndex()].resourceGroupName]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "builtInAssignment": {
                    "value": "[parameters('policy')]"
                  },
                  "logAnalyticsWorkspaceResourceId": {
                    "value": "[parameters('logAnalyticsWorkspaceResourceId')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "deployRemediation": {
                    "value": false
                  },
                  "windowsAdministratorsGroupMembership": {
                    "value": "[parameters('windowsAdministratorsGroupMembership')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "13304535195176582507"
                    }
                  },
                  "parameters": {
                    "builtInAssignment": {
                      "type": "string"
                    },
                    "deployRemediation": {
                      "type": "bool"
                    },
                    "location": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceResourceId": {
                      "type": "string"
                    },
                    "windowsAdministratorsGroupMembership": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "$fxv#0": "{\r\n  \"listOfMembersToExcludeFromWindowsVMAdministratorsGroup\": {\r\n    \"value\": \"admin\"\r\n  },\r\n  \"IncludeArcMachines\": {\r\n    \"value\": \"true\"\r\n  },\r\n  \"MinimumTLSVersion-5752e6d6-1206-46d8-8ab1-ecc2f71a8112\": {\r\n    \"value\": \"1.2\"\r\n  },\r\n  \"NotAvailableMachineState-bed48b13-6647-468e-aa2f-1af1d3f4dd40\": {\r\n    \"value\": \"Compliant\"\r\n  },\r\n  \"requiredRetentionDays\": {\r\n    \"value\": \"365\"\r\n  },\r\n  \"resourceGroupName-b6e2945c-0b7b-40f5-9233-7a5323b5cdc6\": {\r\n    \"value\": \"NetworkWatcherRG\"\r\n  }\r\n}",
                    "$fxv#1": "{\r\n  \"IncludeArcMachines\": {\r\n    \"value\": \"true\"\r\n  },\r\n  \"MinimumTLSVersion-5752e6d6-1206-46d8-8ab1-ecc2f71a8112\": {\r\n    \"value\": \"1.2\"\r\n  },\r\n  \"NotAvailableMachineState-bed48b13-6647-468e-aa2f-1af1d3f4dd40\": {\r\n    \"value\": \"Compliant\"\r\n  },\r\n  \"requiredRetentionDays\": {\r\n    \"value\": \"365\"\r\n  },\r\n  \"resourceGroupName-b6e2945c-0b7b-40f5-9233-7a5323b5cdc6\": {\r\n    \"value\": \"NetworkWatcherRG\"\r\n  }\r\n}",
                    "$fxv#2": "{\r\n  \"IncludeArcMachines\": {\r\n    \"value\": \"false\"\r\n  },\r\n  \"NotAvailableMachineState-bed48b13-6647-468e-aa2f-1af1d3f4dd40\": {\r\n    \"value\": \"Compliant\"\r\n  },\r\n  \"MinimumTLSVersionForWindowsServers\": {\r\n    \"value\": \"1.2\"\r\n  },\r\n  \"requiredRetentionDays\": {\r\n    \"value\": \"365\"\r\n  },\r\n  \"effect-febd0533-8e55-448f-b837-bd0e06f16469\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"allowedContainerImagesRegex-febd0533-8e55-448f-b837-bd0e06f16469\": {\r\n    \"value\": \"^(.+){0}$\"\r\n  },\r\n  \"effect-95edb821-ddaf-4404-9732-666045e056b4\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-440b515e-a580-421e-abeb-b159a61ddcbc\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-233a2a17-77ca-4fb1-9b6b-69223d272a44\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-e345eecc-fa47-480f-9e88-67dcc122b164\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"cpuLimit-e345eecc-fa47-480f-9e88-67dcc122b164\": {\r\n    \"value\": \"0\"\r\n  },\r\n  \"memoryLimit-e345eecc-fa47-480f-9e88-67dcc122b164\": {\r\n    \"value\": \"0\"\r\n  },\r\n  \"effect-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"runAsUserRule-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"MustRunAsNonRoot\"\r\n  },\r\n  \"runAsGroupRule-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"RunAsAny\"\r\n  },\r\n  \"supplementalGroupsRule-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"RunAsAny\"\r\n  },\r\n  \"fsGroupRule-f06ddb64-5fa3-4b77-b166-acb36f7f6042\": {\r\n    \"value\": \"RunAsAny\"\r\n  },\r\n  \"effect-1c6e92c9-99f0-4e55-9cf2-0c234dc48f99\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-47a1ee2f-2a2a-4576-bf2a-e0e36709c2b8\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-df49d893-a74c-421d-bc95-c663042e5b80\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-1a5b4dca-0b6f-4cf5-907c-56316bc1bf3d\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-c26596ff-4d70-4e6a-9a30-c2506bd2f80c\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-511f5417-5d12-434d-ab2e-816901e72a5e\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-82985f06-dc18-4a48-bc1c-b9f4f0098cfe\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-098fc59e-46c7-4d99-9b16-64990e543d75\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"setting-a6fb4358-5bf4-4ad7-ba82-2cd2f41ce5e9\": {\r\n    \"value\": \"enabled\"\r\n  },\r\n  \"aadAuthenticationInServiceFabricMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-71ef260a-8f18-47b7-abcb-62d0673d94dc\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-055aa869-bc98-4af8-bafc-23f1ab6ffe2c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-564feb30-bf6a-4854-b4bb-0d2d2d1e6c66\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-862e97cf-49fc-4a5c-9de4-40d4e2e7c8eb\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-d9da03a1-f3c3-412a-9709-947156872263\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-617c02be-7f02-4efd-8836-3180d47b6c68\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0b60c0b2-2dc2-4e1c-b5c9-abbed971de53\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1e66c121-a66a-4b1f-9b83-0fd99bf0fc2d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ec068d99-e9c7-401f-8cef-5bdde4e6ccf1\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c349d81b-9985-44ae-a8da-ff98d108ede8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-3657f5a0-770e-44a3-b44e-9431ba1e9735\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-b4ac1030-89c5-4697-8e00-28b5ba6a8811\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-ea0dfaed-95fb-448c-934e-d6e713ce393d\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-4733ea7b-a883-42fe-8cac-97454c2a9e4a\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-f4b53539-8df9-40e4-86c6-6b607703bd4e\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-41425d9f-d1a5-499a-9932-f8ed8453932c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-fc4d8e41-e223-45ea-9bf5-eada37891d87\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-86efb160-8de7-451d-bc08-5d475b0aadae\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-4ec52d6d-beb7-40c4-9a9e-fe753254690e\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-64d314f6-6062-4780-a861-c23e8951bee5\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1fd32ebd-e4c3-4e13-a54a-d7422d4d95f6\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-fa298e57-9444-42ba-bf04-86e8470e32c7\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-67121cc7-ff39-4ab8-b7e3-95b84dab487d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1f905d99-2ab7-462c-a6b0-f709acca6c8f\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-5b9159ae-1701-4a6f-9a7a-aa9c8ddd0580\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ba769a63-b8cc-4b2d-abf6-ac33c7204be8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-81e74cea-30fd-40d5-802f-d72103c2aaaa\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0aa61e00-0a01-4a3c-9945-e93cffedf0e6\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-47031206-ce96-41f8-861b-6a915f3de284\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-87ba29ef-1ab3-4d82-b763-87fcd4f531f7\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-51522a96-0869-4791-82f3-981000c2c67f\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-b5ec538c-daa0-4006-8596-35468b9148e8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-56a5ee18-2ae6-4810-86f7-18e39ce5629b\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-2e94d99a-8a36-4563-bc77-810d8893b671\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1fafeaf6-7927-4059-a50a-8eb2a7a6f2b5\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-99e9ccd8-3db9-4592-b0d1-14b1715a4d8a\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1f68a601-6e6d-4e42-babf-3f643a047ea2\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-f7d52b2d-e161-4dfa-a82b-55e564167385\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-7d7be79c-23ba-4033-84dd-45e2a5ccdd67\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ca91455f-eace-4f96-be59-e6e2c35b4816\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-702dd420-7fcc-42c5-afe8-4026edd20fe0\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"diagnosticsLogsInRedisCacheMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"secureTransferToStorageAccountMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-d0793b48-0edc-4296-a390-4c75d1bdfd71\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-7d092e0a-7acd-40d2-a975-dca21cae48c4\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-2a1a9cdf-e04d-429a-8416-3bfb72a1b26f\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"disableUnrestrictedNetworkToStorageAccountMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-55615ac9-af46-4a59-874e-391cc3dfb490\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1b8ca024-1d5c-4dec-8995-b1a932b41780\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-037eea7a-bd0a-46c5-9a66-03aea78705d3\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-53503636-bcc9-4748-9663-5348217f160f\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-40cec1dd-a100-4920-b15b-3024fe8901ab\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0725b4dd-7e76-479c-a735-68e7ee23d5ca\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-a049bf77-880b-470f-ba6d-9f21c530cf83\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ee980b6d-0eca-4501-8d54-f6290fd512c3\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1d84d5fb-01f6-4d12-ba4f-4a26081d403d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-37e0d2fe-28a5-43d6-a273-67d37d1f5606\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"identityDesignateMoreThanOneOwnerMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"diskEncryptionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"emailNotificationToSubscriptionOwnerHighSeverityAlertsEnabledEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"functionAppDisableRemoteDebuggingMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"sqlDbEncryptionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vulnerabilityAssessmentOnManagedInstanceMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensurePHPVersionLatestForAPIAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"aadAuthenticationInSqlServerMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vmssEndpointProtectionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vmssOsVulnerabilitiesMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"adaptiveApplicationControlsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"geoRedundantBackupShouldBeEnabledForAzureDatabaseForPostgreSQLEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"ensureJavaVersionLatestForWebAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityDesignateLessThanOwnersMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"securityContactEmailAddressForSubscriptionEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"webAppRestrictCORSAccessMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveExternalAccountWithWritePermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveExternalAccountWithReadPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveDeprecatedAccountMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"functionAppEnforceHttpsMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"ensurePythonVersionLatestForWebAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensurePythonVersionLatestForFunctionAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensurePHPVersionLatestForWebAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensurePythonVersionLatestForAPIAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"geoRedundantBackupShouldBeEnabledForAzureDatabaseForMySQLEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"systemUpdatesMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureJavaVersionLatestForAPIAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureHTTPVersionLatestForWebAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"apiAppRequireLatestTlsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityEnableMFAForWritePermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureHTTPVersionLatestForAPIAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureJavaVersionLatestForFunctionAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"nextGenerationFirewallMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"useRbacRulesMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"webAppEnforceHttpsMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"sqlServerAuditingMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vnetEnableDDoSProtectionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityEnableMFAForOwnerPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"sqlServerAdvancedDataSecurityMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"sqlManagedInstanceAdvancedDataSecurityMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"endpointProtectionMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"jitNetworkAccessMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"apiAppEnforceHttpsMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"geoRedundantStorageShouldBeEnabledForStorageAccountsEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"vmssSystemUpdatesMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"webAppDisableRemoteDebuggingMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"longtermGeoRedundantBackupEnabledAzureSQLDatabasesEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"systemConfigurationsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"ensureHTTPVersionLatestForFunctionAppEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityEnableMFAForReadPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"containerBenchmarkMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"apiAppDisableRemoteDebuggingMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveDeprecatedAccountWithOwnerPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"vulnerabilityAssessmentOnServerMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"webAppRequireLatestTlsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"identityRemoveExternalAccountWithOwnerPermissionsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"functionAppRequireLatestTlsMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"kubernetesServiceVersionUpToDateMonitoringEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"sqlDbVulnerabilityAssesmentMonitoringEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"membersToExcludeInLocalAdministratorsGroup\": {\r\n    \"value\": \"admin\"\r\n  },\r\n  \"PHPLatestVersionForAppServices\": {\r\n    \"value\": \"7.4\"\r\n  },\r\n  \"JavaLatestVersionForAppServices\": {\r\n    \"value\": \"11\"\r\n  },\r\n  \"WindowsPythonLatestVersionForAppServices\": {\r\n    \"value\": \"3.6\"\r\n  },\r\n  \"LinuxPythonLatestVersionForAppServices\": {\r\n    \"value\": \"3.9\"\r\n  },\r\n  \"ensureDotNetFrameworkLatestForFunctionAppEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"sqlManagedInstanceAdvancedDataSecurityEmailsMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"vulnerabilityAssessmentMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"ensureDotNetFrameworkLatestForWebAppEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"sqlServerAdvancedDataSecurityEmailsMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"microsoftIaaSAntimalwareExtensionShouldBeDeployedOnWindowsServersEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"securityCenterStandardPricingTierShouldBeSelectedEffect\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"theLogAnalyticsAgentShouldBeInstalledOnVirtualMachinesEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"ensurePHPVersionLatestForFunctionAppEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"sqlManagedInstanceAdvancedDataSecurityEmailAdminsMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"securityContactPhoneNumberShouldBeProvidedForSubscriptionEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"threatDetectionTypesOnManagedInstanceMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"ensureDotNetFrameworkLatestForAPIAppEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"sqlServerAdvancedDataSecurityEmailAdminsMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"threatDetectionTypesOnServerMonitoringEffect\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"theLogAnalyticsAgentShouldBeInstalledOnVirtualMachineScaleSetsEffect\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"NetworkWatcherResourceGroupName\": {\r\n    \"value\": \"NetworkWatcherRG\"\r\n  }\r\n}",
                    "$fxv#3": "{\r\n  \"effect-09024ccc-0c5f-475e-9457-b7c0d9ed487b\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0961003e-5a0a-4549-abde-af6a37f2724d\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0b15565f-aa9e-48ba-8619-45960f2c314d\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0e60b895-3786-45da-8377-9c6b4b6ac5f9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-17k78e20-9358-41c9-923c-fb736d382a12\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-1bc1795e-d44a-4d48-9b3b-6fff0fd5f9ba\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"PHPLatestVersion\": {\r\n    \"value\": \"7.3\"\r\n  },\r\n  \"effect-22bee202-a82f-4305-9a2a-6d7f44d4dedb\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-26a828e1-e88f-464e-bbb3-c134a282b9de\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-34c877ad-507e-4c82-993e-3452a6e0ad3c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-3c735d8a-a4ba-4a3a-b7cf-db7754cf57f4\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-404c3081-a854-4457-ae30-26a93ef643f9\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-47a6b606-51aa-4496-8bb7-64b11cf66adc\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-496223c3-ad65-4ecd-878a-bae78737e9ed\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"JavaLatestVersion\": {\r\n    \"value\": \"11\"\r\n  },\r\n  \"effect-4f11b553-d42e-4e3a-89be-32ca364cad4c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-4f4f78b8-e367-4b10-a341-d9a4ad5cf1c7\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-5c607a2e-c700-4744-8254-d77e7c9eb5e4\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-5f76cf89-fbf2-47fd-a3f4-b891fa780b60\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-6b1cbf55-e8b6-442f-ba4c-7246b6381474\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-6d555dd1-86f2-4f1c-8ed7-5abae7c6cbab\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-7008174a-fd10-4ef0-817e-fc820a951d73\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"LinuxPythonLatestVersion\": {\r\n    \"value\": \"3.8\"\r\n  },\r\n  \"effect-7238174a-fd10-4ef0-817e-fc820a951d73\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-7261b898-8a84-4db8-9e04-18527132abb3\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-74c3584d-afae-46f7-a20a-6f8adba71a16\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-86b3d65f-7626-441e-b690-81a8b71cff60\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-88999f4c-376a-45c8-bcb3-4058f713cf39\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-8c122334-9d20-4eb8-89ea-ac9a705b74ae\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-8cb6aa8b-9e41-4f4e-aa25-089a7ac2581e\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-9297c21d-2ed6-4474-b48f-163f75654ce3\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-991310cd-e9f3-47bc-b7b6-f57b557d07db\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-9b597639-28e4-48eb-b506-56b05d366257\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-9d0b6ea4-93e2-4578-bf2f-6bb17d22b4bc\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-9daedab3-fb2d-461e-b861-71790eead4f6\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-a4af4a39-4135-47fb-b175-47fbdf85311d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-a6fb4358-5bf4-4ad7-ba82-2cd2f41ce5e9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"setting-a6fb4358-5bf4-4ad7-ba82-2cd2f41ce5e9\": {\r\n    \"value\": \"enabled\"\r\n  },\r\n  \"effect-a70ca396-0a34-413a-88e1-b956c1e683be\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-aa633080-8b72-40c4-a2d7-d00c03e80bed\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-abfb4388-5bf4-4ad7-ba82-2cd2f41ceae9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-abfb7388-5bf4-4ad7-ba99-2cd2f41cebb9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-af6cd1bd-1635-48cb-bde7-5b15693900b9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b7ddfbdc-1260-477d-91fd-98bd9be789a6\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c3f317a7-a95c-4547-b7e7-11017ebdf2fe\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-cb510bfd-1cba-4d9f-a230-cb0976f4bb71\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e1e5fd5d-3e4c-4ce1-8661-7d1873ae6b15\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e2c1c086-2d84-4019-bff3-c44ccd95113c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e3576e28-8b17-4677-84c3-db2990658d64\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e8cbc669-f12d-49eb-93e7-9273119e9933\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e9c8d085-d9cc-4b17-9cdc-059f1f01f19e\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-ebb62a0c-3560-49e1-89ed-27e074e9f8ad\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-efbde977-ba53-4479-b8e9-10b957924fbf\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-f0e6e85b-9b9f-4a4b-b67b-f730d42f1b0b\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-f6de0be7-9a8a-4b8a-b349-43cf02d22f7c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-f8456c1c-aa66-4dfb-861a-25d127b775c9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-f9d614c5-c173-4d56-95a7-b4437057d193\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-fb893a29-21bb-418c-a157-e99480ec364c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-feedbf84-6b99-488c-acc2-71c829aa5ffc\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-3b980d31-7904-4bb7-8575-5665739a8052\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-6e2593d9-add6-4083-9c9b-4b7d2188c899\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b607c5de-e7d9-4eee-9e5c-83f1bcee4fa0\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-12430be1-6cc8-4527-a9a8-e3d38f250096\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"modeRequirement-12430be1-6cc8-4527-a9a8-e3d38f250096\": {\r\n    \"value\": \"Detection\"\r\n  },\r\n  \"effect-425bea59-a659-4cbb-8d31-34499bd030b8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"modeRequirement-425bea59-a659-4cbb-8d31-34499bd030b8\": {\r\n    \"value\": \"Detection\"\r\n  },\r\n  \"effect-564feb30-bf6a-4854-b4bb-0d2d2d1e6c66\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-055aa869-bc98-4af8-bafc-23f1ab6ffe2c\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-013e242c-8828-4970-87b3-ab247555486d\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-d38fc420-0735-4ef3-ac11-c806f651a570\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-a1181c5f-672a-477a-979a-7d58aa086233\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-308fbb08-4ab8-4e67-9b29-592e93fb94fa\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-4da35fc9-c9e7-4960-aec9-797fe7d9051d\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-523b5cd1-3e23-492f-a539-13118b6d1e3a\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-7fe3b40f-802b-4cdd-8bd4-fd799c948cc2\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-c25d9a16-bc35-4e15-a7e5-9db606bf9ed4\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b0f33259-77d7-4c9e-aac6-3aabcfae693c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-037eea7a-bd0a-46c5-9a66-03aea78705d3\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0725b4dd-7e76-479c-a735-68e7ee23d5ca\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-0820b7b9-23aa-4725-a1ce-ae4558f718e5\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-2c89a2e5-7285-40fe-afe0-ae8654b92fab\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-358c20a6-3f9e-4f0e-97ff-c6ce485e2aac\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-5744710e-cc2f-4ee8-8809-3b11e89f4bc9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-ac4a19c2-fa67-49b4-8ae5-0b2e78c49457\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c9d007d0-c057-4772-b18c-01e546713bcd\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-d0793b48-0edc-4296-a390-4c75d1bdfd71\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-e372f825-a257-4fb8-9175-797a8a8627d6\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-d158790f-bfb0-486c-8631-2dc6b4e8e6af\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-e802a67a-daf5-4436-9ea6-f6d821dd0c5d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-a451c1ef-c6ca-483d-87ed-f49761e3ffb5\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftSql-servers-firewallRules-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftNetwork-networkSecurityGroups-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftClassicNetwork-networkSecurityGroups-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftNetwork-networkSecurityGroups-securityRules-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b954148f-4c11-4c38-8221-be76711e194a-MicrosoftClassicNetwork-networkSecurityGroups-securityRules-delete\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-ae89ebca-1c92-4898-ac2c-9f63decb045c\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-d26f7642-7545-4e18-9b75-8c9bbdee3a9a\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-1a4e592a-6a6e-44a5-9814-e36264ca96e7\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-7796937f-307b-4598-941c-67d3a05ebfe7\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-c5447c04-a4d7-4ba8-a263-c9ee321a6858\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-41388f1c-2db0-4c25-95b2-35d7f5ccbfa9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-b02aacc0-b073-424e-8298-42b22829ee0a\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-057d6cfe-9c4f-4a6d-bc60-14420ea1f1a9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0ec47710-77ff-4a3d-9181-6aa50af424d0\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-48af4db5-9b8b-401c-8e74-076be876a430\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-82339799-d096-41ae-8538-b108becf0970\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1b7aa243-30e4-4c9e-bca8-d0d3022b634a\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-ef2a8f2a-b3d9-49cd-a8a8-9a3aaaf647d9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-bb91dfba-c30d-4263-9add-9c2384e659a6\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-e71308d3-144b-4262-b144-efdc3cc90517\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-2bdd0062-9d75-436e-89df-487dd8e4b3c7\": {\r\n    \"value\": \"Disabled\"\r\n  },\r\n  \"effect-4733ea7b-a883-42fe-8cac-97454c2a9e4a\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-67121cc7-ff39-4ab8-b7e3-95b84dab487d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-6fac406b-40ca-413b-bf8e-0bf964659c25\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-81e74cea-30fd-40d5-802f-d72103c2aaaa\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c349d81b-9985-44ae-a8da-ff98d108ede8\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-f4b53539-8df9-40e4-86c6-6b607703bd4e\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-ec068d99-e9c7-401f-8cef-5bdde4e6ccf1\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-048248b0-55cd-46da-b1ff-39efd52db260\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0d134df8-db83-46fb-ad72-fe0c9428c8dd\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-2c89a2e5-7285-40fe-afe0-ae8654b92fb2\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-3657f5a0-770e-44a3-b44e-9431ba1e9735\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-5b9159ae-1701-4a6f-9a7a-aa9c8ddd0580\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-617c02be-7f02-4efd-8836-3180d47b6c68\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-7d7be79c-23ba-4033-84dd-45e2a5ccdd67\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-87ba29ef-1ab3-4d82-b763-87fcd4f531f7\": {\r\n    \"value\": \"audit\"\r\n  },\r\n  \"effect-f7d52b2d-e161-4dfa-a82b-55e564167385\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-c43e4a30-77cb-48ab-a4dd-93f175c63b57\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-0b60c0b2-2dc2-4e1c-b5c9-abbed971de53\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1e66c121-a66a-4b1f-9b83-0fd99bf0fc2d\": {\r\n    \"value\": \"Audit\"\r\n  },\r\n  \"effect-1f314764-cb73-4fc9-b863-8eca98ac36e9\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"effect-123a3936-f020-408a-ba0c-47873faf1534\": {\r\n    \"value\": \"AuditIfNotExists\"\r\n  },\r\n  \"resourceGroupName-b6e2945c-0b7b-40f5-9233-7a5323b5cdc6\": {\r\n    \"value\": \"NetworkWatcherRG\"\r\n  }\r\n}",
                    "modifiedAssignment": "[if(and(equals(toLower(environment().name), toLower('AzureCloud')), equals(toLower(parameters('builtInAssignment')), toLower('IL5'))), 'NISTRev4', parameters('builtInAssignment'))]",
                    "assignmentName": "[format('{0} {1}', variables('modifiedAssignment'), resourceGroup().name)]",
                    "agentVmssAssignmentName": "[format('Deploy VMSS Agents {0}', resourceGroup().name)]",
                    "agentVmAssignmentName": "[format('Deploy VM Agents {0}', resourceGroup().name)]",
                    "contributorRoleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                    "lawsReaderRoleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '92aaf0da-9dab-42b6-94a3-d43ce8d16293')]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/policyAssignments",
                      "apiVersion": "2020-09-01",
                      "name": "[variables('assignmentName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "policyDefinitionId": "[createObject('NISTRev4', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/cf25b9c1-bd23-4eb6-bd2c-f4f3ac644a5f', 'parameters', union(json(variables('$fxv#0')), createObject('listOfMembersToIncludeInWindowsVMAdministratorsGroup', createObject('value', parameters('windowsAdministratorsGroupMembership')), 'logAnalyticsWorkspaceIdforVMReporting', createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]))))), 'NISTRev5', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/179d1daa-458f-4e47-8086-2a68d0d6c38f', 'parameters', json(variables('$fxv#1'))), 'IL5', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/f9a961fa-3241-4b20-adc4-bbf8ad9d7197', 'parameters', union(json(variables('$fxv#2')), createObject('logAnalyticsWorkspaceIDForVMAgents', createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])), 'membersToIncludeInLocalAdministratorsGroup', createObject('value', parameters('windowsAdministratorsGroupMembership'))))), 'CMMC', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/b5629c75-5c77-4422-87b9-2509e680f8de', 'parameters', union(json(variables('$fxv#3')), createObject('logAnalyticsWorkspaceId-f47b5582-33ec-4c5c-87c0-b010a6b2e917', createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]), '2021-06-01').customerId)), if(equals('AzureCloud', environment().name), createObject('MembersToExclude-69bf4abd-ca1e-4cf6-8b5a-762d42e61d4f', createObject('value', 'admin'), 'MembersToInclude-30f71ea1-ac77-4f26-9fc5-2d926bbd4ba7', createObject('value', parameters('windowsAdministratorsGroupMembership'))), createObject()))))[variables('modifiedAssignment')].id]",
                        "parameters": "[createObject('NISTRev4', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/cf25b9c1-bd23-4eb6-bd2c-f4f3ac644a5f', 'parameters', union(json(variables('$fxv#0')), createObject('listOfMembersToIncludeInWindowsVMAdministratorsGroup', createObject('value', parameters('windowsAdministratorsGroupMembership')), 'logAnalyticsWorkspaceIdforVMReporting', createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]))))), 'NISTRev5', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/179d1daa-458f-4e47-8086-2a68d0d6c38f', 'parameters', json(variables('$fxv#1'))), 'IL5', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/f9a961fa-3241-4b20-adc4-bbf8ad9d7197', 'parameters', union(json(variables('$fxv#2')), createObject('logAnalyticsWorkspaceIDForVMAgents', createObject('value', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])), 'membersToIncludeInLocalAdministratorsGroup', createObject('value', parameters('windowsAdministratorsGroupMembership'))))), 'CMMC', createObject('id', '/providers/Microsoft.Authorization/policySetDefinitions/b5629c75-5c77-4422-87b9-2509e680f8de', 'parameters', union(json(variables('$fxv#3')), createObject('logAnalyticsWorkspaceId-f47b5582-33ec-4c5c-87c0-b010a6b2e917', createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8]), '2021-06-01').customerId)), if(equals('AzureCloud', environment().name), createObject('MembersToExclude-69bf4abd-ca1e-4cf6-8b5a-762d42e61d4f', createObject('value', 'admin'), 'MembersToInclude-30f71ea1-ac77-4f26-9fc5-2d926bbd4ba7', createObject('value', parameters('windowsAdministratorsGroupMembership'))), createObject()))))[variables('modifiedAssignment')].parameters]"
                      },
                      "identity": {
                        "type": "SystemAssigned"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/policyAssignments",
                      "apiVersion": "2020-09-01",
                      "name": "[variables('agentVmssAssignmentName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "policyDefinitionId": "[tenantResourceId('Microsoft.Authorization/policySetDefinitions', '75714362-cae7-409e-9b99-a8e5075b7fad')]",
                        "parameters": {
                          "logAnalytics_1": {
                            "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])]"
                          }
                        }
                      },
                      "identity": {
                        "type": "SystemAssigned"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/policyAssignments",
                      "apiVersion": "2020-09-01",
                      "name": "[variables('agentVmAssignmentName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "policyDefinitionId": "[tenantResourceId('Microsoft.Authorization/policySetDefinitions', '55f3eceb-5573-4f18-9695-226972c6d74a')]",
                        "parameters": {
                          "logAnalytics_1": {
                            "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])]"
                          }
                        }
                      },
                      "identity": {
                        "type": "SystemAssigned"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2020-04-01-preview",
                      "name": "[guid(variables('contributorRoleDefinitionId'), variables('assignmentName'))]",
                      "properties": {
                        "roleDefinitionId": "[variables('contributorRoleDefinitionId')]",
                        "principalId": "[if(empty(variables('modifiedAssignment')), '', reference(resourceId('Microsoft.Authorization/policyAssignments', variables('assignmentName')), '2020-09-01', 'full').identity.principalId)]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Authorization/policyAssignments', variables('assignmentName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2020-04-01-preview",
                      "name": "[guid(variables('contributorRoleDefinitionId'), variables('agentVmssAssignmentName'))]",
                      "properties": {
                        "roleDefinitionId": "[variables('contributorRoleDefinitionId')]",
                        "principalId": "[reference(resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmssAssignmentName')), '2020-09-01', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmssAssignmentName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2020-04-01-preview",
                      "name": "[guid(variables('contributorRoleDefinitionId'), variables('agentVmAssignmentName'))]",
                      "properties": {
                        "roleDefinitionId": "[variables('contributorRoleDefinitionId')]",
                        "principalId": "[reference(resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName')), '2020-09-01', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName'))]"
                      ]
                    },
                    {
                      "condition": "[parameters('deployRemediation')]",
                      "type": "Microsoft.PolicyInsights/remediations",
                      "apiVersion": "2019-07-01",
                      "name": "VM-Agent-Policy-Remediation",
                      "properties": {
                        "policyAssignmentId": "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName'))]",
                        "resourceDiscoveryMode": "ReEvaluateCompliance"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('Assign-Laws-Role-Policy-{0}', resourceGroup().name)]",
                      "subscriptionId": "[split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2]]",
                      "resourceGroup": "[split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "targetResourceId": {
                            "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[2], split(parameters('logAnalyticsWorkspaceResourceId'), '/')[4]), 'Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceResourceId'), '/')[8])]"
                          },
                          "roleDefinitionId": {
                            "value": "[variables('lawsReaderRoleDefinitionId')]"
                          },
                          "principalId": {
                            "value": "[reference(resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName')), '2020-09-01', 'full').identity.principalId]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.39.26.7824",
                              "templateHash": "18061649913040420672"
                            }
                          },
                          "parameters": {
                            "targetResourceId": {
                              "type": "string"
                            },
                            "roleDefinitionId": {
                              "type": "string"
                            },
                            "principalId": {
                              "type": "string"
                            },
                            "principalType": {
                              "type": "string",
                              "defaultValue": "ServicePrincipal",
                              "allowedValues": [
                                "ForeignGroup",
                                "Group",
                                "ServicePrincipal",
                                "User"
                              ]
                            },
                            "description": {
                              "type": "string",
                              "defaultValue": ""
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Authorization/roleAssignments",
                              "apiVersion": "2020-04-01-preview",
                              "name": "[guid(parameters('targetResourceId'), parameters('roleDefinitionId'), parameters('principalId'))]",
                              "properties": {
                                "principalId": "[parameters('principalId')]",
                                "principalType": "[parameters('principalType')]",
                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                "description": "[parameters('description')]"
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Authorization/policyAssignments', variables('agentVmAssignmentName'))]"
                      ]
                    }
                  ]
                }
              }
            },
            {
              "copy": {
                "name": "defenderForCloud",
                "count": "[length(parameters('tiers'))]",
                "mode": "serial",
                "batchSize": 1
              },
              "condition": "[parameters('deployDefender')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('set-defender-{0}-{1}', parameters('tiers')[copyIndex()].name, parameters('deploymentNameSuffix'))]",
              "subscriptionId": "[parameters('tiers')[copyIndex()].subscriptionId]",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "defenderPlans": {
                    "value": "[parameters('defenderPlans')]"
                  },
                  "defenderSkuTier": {
                    "value": "[parameters('defenderSkuTier')]"
                  },
                  "emailSecurityContact": {
                    "value": "[parameters('emailSecurityContact')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "17569425286732074213"
                    }
                  },
                  "parameters": {
                    "defenderPlans": {
                      "type": "array",
                      "defaultValue": [
                        "VirtualMachines"
                      ],
                      "metadata": {
                        "description": "Defender Paid protection Plans. Even if a customer selects the free sku, at least 1 paid protection plan must be specified."
                      }
                    },
                    "emailSecurityContact": {
                      "type": "string",
                      "metadata": {
                        "description": "Email address of the contact, in the form of john@doe.com"
                      }
                    },
                    "policySetDescription": {
                      "type": "string",
                      "defaultValue": "The Microsoft Cloud Security Benchmark initiative represents the policies and controls implementing security recommendations defined in Microsoft Cloud Security Benchmark v2, see https://aka.ms/azsecbm. This also serves as the Microsoft Defender for Cloud default policy initiative. You can directly assign this initiative, or manage its policies and compliance results within Microsoft Defender.",
                      "metadata": {
                        "description": "Policy Initiative description field"
                      }
                    },
                    "defenderSkuTier": {
                      "type": "string",
                      "defaultValue": "Free",
                      "metadata": {
                        "description": "[Standard/Free] The SKU for Defender. It defaults to \"Free\"."
                      }
                    }
                  },
                  "variables": {
                    "defenderPaidPlanConfig": {
                      "AzureCloud": {
                        "Api": {
                          "subPlan": "P1"
                        },
                        "appServices": {},
                        "KeyVaults": {
                          "subPlan": "PerKeyVault"
                        },
                        "Arm": {
                          "subPlan": "PerSubscription"
                        },
                        "CloudPosture": {
                          "extensions": [
                            {
                              "name": "SensitiveDataDiscovery",
                              "isEnabled": "True"
                            },
                            {
                              "name": "ContainerRegistriesVulnerabilityAssessments",
                              "isEnabled": "True"
                            },
                            {
                              "name": "AgentlessDiscoveryForKubernetes",
                              "isEnabled": "True"
                            },
                            {
                              "name": "AgentlessVmScanning",
                              "isEnabled": "True"
                            },
                            {
                              "name": "EntraPermissionsManagement",
                              "isEnabled": "True"
                            }
                          ]
                        },
                        "Containers": {
                          "extensions": [
                            {
                              "name": "ContainerRegistriesVulnerabilityAssessments",
                              "isEnabled": "True"
                            },
                            {
                              "name": "AgentlessDiscoveryForKubernetes",
                              "isEnabled": "True"
                            }
                          ]
                        },
                        "CosmosDbs": {},
                        "StorageAccounts": {
                          "subPlan": "DefenderForStorageV2",
                          "extensions": [
                            {
                              "name": "OnUploadMalwareScanning",
                              "isEnabled": "True",
                              "additionalExtensionProperties": {
                                "CapGBPerMonthPerStorageAccount": "5000"
                              }
                            },
                            {
                              "name": "SensitiveDataDiscovery",
                              "isEnabled": "True"
                            }
                          ]
                        },
                        "VirtualMachines": {
                          "subPlan": "P1"
                        },
                        "SqlServerVirtualMachines": {},
                        "SqlServers": {},
                        "OpenSourceRelationalDatabases": {}
                      }
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "defenderFreeAllClouds",
                        "count": "[length(parameters('defenderPlans'))]",
                        "mode": "serial",
                        "batchSize": 1
                      },
                      "condition": "[equals(parameters('defenderSkuTier'), 'Free')]",
                      "type": "Microsoft.Security/pricings",
                      "apiVersion": "2023-01-01",
                      "name": "[parameters('defenderPlans')[copyIndex()]]",
                      "properties": {
                        "pricingTier": "[parameters('defenderSkuTier')]"
                      }
                    },
                    {
                      "copy": {
                        "name": "defenderStandardNoSubplanNoExtensions",
                        "count": "[length(parameters('defenderPlans'))]",
                        "mode": "serial",
                        "batchSize": 1
                      },
                      "condition": "[and(equals(parameters('defenderSkuTier'), 'Standard'), not(equals(environment().name, 'AzureCloud')))]",
                      "type": "Microsoft.Security/pricings",
                      "apiVersion": "2023-01-01",
                      "name": "[parameters('defenderPlans')[copyIndex()]]",
                      "properties": {
                        "pricingTier": "[parameters('defenderSkuTier')]"
                      }
                    },
                    {
                      "copy": {
                        "name": "defenderStandardSubplanExtensionsAzureCloud",
                        "count": "[length(parameters('defenderPlans'))]",
                        "mode": "serial",
                        "batchSize": 1
                      },
                      "condition": "[and(equals(parameters('defenderSkuTier'), 'Standard'), equals(environment().name, 'AzureCloud'))]",
                      "type": "Microsoft.Security/pricings",
                      "apiVersion": "2023-01-01",
                      "name": "[parameters('defenderPlans')[copyIndex()]]",
                      "properties": {
                        "pricingTier": "[parameters('defenderSkuTier')]",
                        "subPlan": "[coalesce(tryGet(variables('defenderPaidPlanConfig')[environment().name][parameters('defenderPlans')[copyIndex()]], 'subPlan'), null())]",
                        "extensions": "[coalesce(tryGet(variables('defenderPaidPlanConfig')[environment().name][parameters('defenderPlans')[copyIndex()]], 'extensions'), null())]"
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('emailSecurityContact')))]",
                      "type": "Microsoft.Security/securityContacts",
                      "apiVersion": "2020-01-01-preview",
                      "name": "default",
                      "properties": {
                        "notificationsByRole": {
                          "roles": [
                            "AccountAdmin",
                            "Contributor",
                            "Owner",
                            "ServiceAdmin"
                          ],
                          "state": "On"
                        },
                        "alertNotifications": {
                          "state": "On"
                        },
                        "emails": "[parameters('emailSecurityContact')]"
                      }
                    },
                    {
                      "type": "Microsoft.Authorization/policyAssignments",
                      "apiVersion": "2022-06-01",
                      "name": "Microsoft Cloud Security Benchmark",
                      "properties": {
                        "displayName": "Defender Default",
                        "description": "[parameters('policySetDescription')]",
                        "enforcementMode": "DoNotEnforce",
                        "parameters": {},
                        "policyDefinitionId": "[tenantResourceId('Microsoft.Authorization/policySetDefinitions', '1f3afdf9-d0c9-4c3d-847f-89da613e70a8')]"
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix')))]"
      ]
    }
  ],
  "outputs": {
    "azureFirewallResourceId": {
      "type": "string",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.azureFirewallResourceId.value]"
    },
    "hubVirtualNetworkResourceId": {
      "type": "string",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.hubVirtualNetworkResourceId.value]"
    },
    "logAnalyticsWorkspaceResourceId": {
      "type": "string",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.logAnalyticsWorkspaceResourceId.value]"
    },
    "privateLinkScopeResourceId": {
      "type": "string",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-monitoring-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.privateLinkScopeResourceId.value]"
    },
    "sharedServicesSubnetResourceId": {
      "type": "string",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.sharedServicesSubnetResourceId.value]"
    },
    "tiers": {
      "type": "array",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-networking-{0}', parameters('deploymentNameSuffix'))), '2025-04-01').outputs.tiers.value]"
    }
  }
}