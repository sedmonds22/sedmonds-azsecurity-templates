id: 1e0a7d9c-8b44-4b7c-9bfa-8e1d4ed7e98a
name: Subnet created or updated without an NSG
kind: Scheduled
description: |
  'Detects creation or update of a virtual network subnet where no Network Security Group (NSG) is associated. Subnets without an NSG can unintentionally expose workloads by removing a key enforcement layer for inbound and outbound traffic controls.'
severity: Medium
status: Available
requiredDataConnectors:
  - connectorId: AzureActivity
    dataTypes:
      - AzureActivity
queryFrequency: 15m
queryPeriod: 15m
triggerOperator: gt
triggerThreshold: 0
tactics:
  - DefenseEvasion
relevantTechniques:
  - T1562
query: |
  let queryFrequency = 15m;
  AzureActivity
  | where ingestion_time() > ago(queryFrequency)
  | where ActivityStatusValue =~ "Success"
  | where tolower(OperationNameValue) =~ "microsoft.network/virtualnetworks/subnets/write"
  | extend requestBody = tostring(parse_json(Properties).requestbody)
  | extend request = parse_json(requestBody)
  | extend subnetProps = coalesce(request.properties, request.Properties)
  | extend NSGId = tostring(coalesce(subnetProps.networkSecurityGroup.id, subnetProps.networkSecurityGroup.Id))
  | where isempty(NSGId)
  | extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])
  | project
      TimeGenerated,
      Caller,
      Name,
      UPNSuffix,
      CallerIpAddress,
      OperationNameValue,
      ResourceGroup,
      _ResourceId,
      Resource,
      CorrelationId,
      NSGId
entityMappings:
  - entityType: AzureResource
    fieldMappings:
      - identifier: ResourceId
        columnName: _ResourceId
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: Caller
      - identifier: Name
        columnName: Name
      - identifier: UPNSuffix
        columnName: UPNSuffix
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: CallerIpAddress
customDetails:
  SubnetResourceId: _ResourceId
  SubnetName: Resource
  AssociatedNSG: NSGId
alertDetailsOverride:
  alertDisplayNameFormat: |
    Subnet has no NSG associated
  alertDescriptionFormat: |
    A subnet was created or updated without a Network Security Group (NSG) association.

    Actor: {{Caller}}
    Source IP: {{CallerIpAddress}}
    Subnet: {{SubnetResourceId}}
    Subnet Name: {{SubnetName}}
version: 1.0.0
