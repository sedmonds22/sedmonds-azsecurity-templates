id: 05b6e0f7-d408-4e0e-9658-831ce52b3fb1
name: Azure Automation runbook or webhook created or updated
kind: Scheduled
description: |
  'Detects creation or update operations on Azure Automation runbooks and webhooks. These can be abused for persistence and remote execution in Azure environments.'
severity: Medium
status: Available
requiredDataConnectors:
  - connectorId: AzureActivity
    dataTypes:
      - AzureActivity
queryFrequency: 15m
queryPeriod: 15m
triggerOperator: gt
triggerThreshold: 0
tactics:
  - Persistence
  - Execution
relevantTechniques:
  - T1059
query: |
  let queryFrequency = 15m;
  AzureActivity
  | where ingestion_time() > ago(queryFrequency)
  | where ActivityStatusValue =~ "Success"
  | where tolower(OperationNameValue) has "microsoft.automation/automationaccounts"
  | where tolower(OperationNameValue) endswith "/write"
  | where tolower(OperationNameValue) has_any ("/runbooks/", "/webhooks/", "/schedules/", "/jobschedules/")
  | extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])
  | project TimeGenerated, Caller, Name, UPNSuffix, CallerIpAddress, OperationNameValue, ResourceGroup, _ResourceId, Resource, CorrelationId
entityMappings:
  - entityType: AzureResource
    fieldMappings:
      - identifier: ResourceId
        columnName: _ResourceId
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: Caller
      - identifier: Name
        columnName: Name
      - identifier: UPNSuffix
        columnName: UPNSuffix
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: CallerIpAddress
customDetails:
  OperationName: OperationNameValue
  ResourceId: _ResourceId
alertDetailsOverride:
  alertDisplayNameFormat: |
    Azure Automation runbook/webhook modified
  alertDescriptionFormat: |
    An Azure Automation runbook/webhook (or related schedule/jobSchedule) was created or updated.

    Actor: {{Caller}}
    Source IP: {{CallerIpAddress}}
    Operation: {{OperationNameValue}}
    Resource: {{_ResourceId}}
version: 1.0.0
