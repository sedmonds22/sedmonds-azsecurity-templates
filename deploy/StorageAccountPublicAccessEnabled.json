{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspaceName": {
      "type": "string",
      "metadata": {
        "description": "Name of the existing Log Analytics workspace that has Microsoft Sentinel enabled."
      }
    },
    "enableRule": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether the analytic rule should be enabled after deployment."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "apiVersion": "2025-06-01",
      "name": "[concat(parameters('workspaceName'), '/Microsoft.SecurityInsights/', '9f84f9de-2c3a-4c2f-83bf-9b0ddf0d0c54')]",
      "kind": "Scheduled",
      "properties": {
        "displayName": "Storage account public access enabled",
        "description": "Detects Storage account configuration changes that enable public network access, set network rules defaultAction to Allow, or enable anonymous blob access (allowBlobPublicAccess). These settings can increase the risk of data exposure and exfiltration.",
        "enabled": "[parameters('enableRule')]",
        "severity": "High",
        "query": "let queryFrequency = 15m;\nAzureActivity\n| where ingestion_time() > ago(queryFrequency)\n| where ActivityStatusValue in~ (\"Succeeded\",\"Success\",\"Accepted\")\n| where tolower(OperationNameValue) =~ \"microsoft.storage/storageaccounts/write\"\n| extend requestBody = tostring(parse_json(Properties).requestbody)\n| extend request = parse_json(requestBody)\n| extend saProps = coalesce(request.properties, request.Properties)\n| extend publicNetworkAccess = tostring(coalesce(saProps.publicNetworkAccess, saProps.PublicNetworkAccess))\n| extend allowBlobPublicAccess = tobool(coalesce(saProps.allowBlobPublicAccess, saProps.AllowBlobPublicAccess))\n| extend defaultAction = tostring(coalesce(saProps.networkAcls.defaultAction, saProps.networkAcls.DefaultAction, saProps.networkRuleSet.defaultAction, saProps.networkRuleSet.DefaultAction))\n| extend IsPublicNetworkEnabled = tolower(publicNetworkAccess) == \"enabled\"\n| extend IsFirewallAllow = tolower(defaultAction) == \"allow\"\n| where allowBlobPublicAccess == true or IsPublicNetworkEnabled or IsFirewallAllow\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| project\n    TimeGenerated,\n    Caller,\n    Name,\n    UPNSuffix,\n    CallerIpAddress,\n    OperationNameValue,\n    ResourceGroup,\n    _ResourceId,\n    Resource,\n    CorrelationId,\n    SubscriptionId,\n    publicNetworkAccess,\n    defaultAction,\n    allowBlobPublicAccess",
        "queryFrequency": "PT15M",
        "queryPeriod": "PT15M",
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Exfiltration"
        ],
        "techniques": [
          "T1530",
          "T1567"
        ],
        "entityMappings": [
          {
            "entityType": "AzureResource",
            "fieldMappings": [
              {
                "columnName": "_ResourceId",
                "identifier": "ResourceId"
              }
            ]
          },
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "columnName": "Caller",
                "identifier": "FullName"
              },
              {
                "columnName": "Name",
                "identifier": "Name"
              },
              {
                "columnName": "UPNSuffix",
                "identifier": "UPNSuffix"
              }
            ]
          },
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "columnName": "CallerIpAddress",
                "identifier": "Address"
              }
            ]
          }
        ],
        "suppressionEnabled": false,
        "suppressionDuration": "PT5H"
      }
    }
  ]
}

